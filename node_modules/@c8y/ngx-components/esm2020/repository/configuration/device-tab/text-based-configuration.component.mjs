import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryService, OperationStatus } from '@c8y/client';
import { AlertService, gettext } from '@c8y/ngx-components';
import { DeviceConfigurationOperation, RepositoryService } from '@c8y/ngx-components/repository/shared';
import { DeviceConfigurationService } from './device-configuration.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "@c8y/ngx-components/repository/shared";
import * as i4 from "./device-configuration.service";
import * as i5 from "@c8y/client";
import * as i6 from "@angular/common";
import * as i7 from "@angular/forms";
import * as i8 from "@c8y/ngx-components/operations/operation-details";
export class TextBasedConfigurationComponent {
    constructor(route, alertService, repositoryService, deviceConfigurationService, inventoryService) {
        this.route = route;
        this.alertService = alertService;
        this.repositoryService = repositoryService;
        this.deviceConfigurationService = deviceConfigurationService;
        this.inventoryService = inventoryService;
        this.reloadingConfig = false;
    }
    async ngOnInit() {
        await this.load();
    }
    async load() {
        this.device = this.route.snapshot.parent.data.contextData;
        await this.loadDevice();
        await this.loadOperation();
        this.showTextBasedConfigReload = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.SEND_CONFIG]);
        this.showTextBasedConfigSave = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG]);
        if (this.device.c8y_Configuration && this.device.c8y_Configuration.config) {
            this.config = this.device.c8y_Configuration.config;
        }
    }
    async loadOperation() {
        const operation = await this.repositoryService.getLastConfigUpdateOperation(this.device.id);
        if (operation !== null) {
            this.reloadingConfig =
                !!operation.c8y_SendConfiguration &&
                    (operation.status === OperationStatus.PENDING ||
                        operation.status === OperationStatus.EXECUTING);
            this.repositoryService.observeOperation(operation).subscribe(operationUpdate => {
                this.latestOperation = operationUpdate;
            });
        }
    }
    get savingConfig() {
        return this.latestOperation
            ? !!this.latestOperation.c8y_Configuration &&
                (this.latestOperation.status === OperationStatus.PENDING ||
                    this.latestOperation.status === OperationStatus.EXECUTING)
            : false;
    }
    async reloadConfiguration() {
        this.reloadingConfig = true;
        const operationCfg = await this.repositoryService.createTextBasedConfigurationReloadOperation(this.device);
        try {
            this.repositoryService.createObservedOperation(operationCfg).subscribe(operationUpdate => this.onOperationReloadSuccess(operationUpdate), operationUpdate => this.onOperationReloadError(operationUpdate), () => this.onOperationReloadComplete());
        }
        catch (ex) {
            this.alertService.addServerFailure(ex);
        }
    }
    async updateConfiguration(config) {
        const operationCfg = await this.repositoryService.createTextBasedConfigurationUpdateOperation(this.device, config);
        try {
            this.repositoryService.createObservedOperation(operationCfg).subscribe(operationUpdate => this.onOperationUpdateSuccess(operationUpdate), operationUpdate => this.onOperationUpdateError(operationUpdate), () => this.onOperationUpdateComplete());
        }
        catch (ex) {
            this.alertService.addServerFailure(ex);
        }
    }
    onOperationReloadSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be reloaded.'));
        }
    }
    onOperationReloadError(operationUpdate) {
        this.latestOperation = operationUpdate;
        this.reloadingConfig = false;
    }
    async onOperationReloadComplete() {
        await this.loadDevice();
        this.config = this.device.c8y_Configuration.config;
        this.reloadingConfig = false;
    }
    onOperationUpdateSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be updated.'));
        }
    }
    onOperationUpdateError(operationUpdate) {
        this.latestOperation = operationUpdate;
    }
    onOperationUpdateComplete() {
        this.device.c8y_Configuration.config = this.config;
    }
    async loadDevice() {
        this.device = (await this.inventoryService.detail(this.device.id, {
            withChildren: false
        })).data;
    }
}
TextBasedConfigurationComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: TextBasedConfigurationComponent, deps: [{ token: i1.ActivatedRoute }, { token: i2.AlertService }, { token: i3.RepositoryService }, { token: i4.DeviceConfigurationService }, { token: i5.InventoryService }], target: i0.ɵɵFactoryTarget.Component });
TextBasedConfigurationComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: TextBasedConfigurationComponent, selector: "c8y-text-based-configuration", ngImport: i0, template: "<div class=\"d-flex d-col fit-h\">\n  <fieldset class=\"card-block bg-level-1 fit-w\">\n    <div class=\"content-flex-50\">\n      <div class=\"m-l-auto d-flex\">\n        <button\n          title=\"{{ 'Get configuration from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm a-s-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'icon-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get configuration from device' | translate }}\n        </button>\n      </div>\n      <c8y-operation-details\n        *ngIf=\"latestOperation !== undefined\"\n        [operation]=\"latestOperation\"\n        class=\"flex-grow\"\n      ></c8y-operation-details>\n    </div>\n  </fieldset>\n  <div class=\"flex-grow\">\n    <textarea\n      [attr.aria-label]=\"'Operations' | translate\"\n      [(ngModel)]=\"config\"\n      class=\"form-control fit-h p-r-16 p-l-16\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-w separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      id=\"send-config-btn\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig || !config\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending\u2026' | translate }}\" *ngIf=\"savingConfig\">\n        {{ 'Sending\u2026' | translate }}\n      </span>\n    </button>\n  </div>\n</div>\n", dependencies: [{ kind: "directive", type: i6.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i6.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i2.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i7.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i7.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i7.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "component", type: i8.OperationDetailsComponent, selector: "c8y-operation-details", inputs: ["operation"] }, { kind: "pipe", type: i2.C8yTranslatePipe, name: "translate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: TextBasedConfigurationComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-text-based-configuration', template: "<div class=\"d-flex d-col fit-h\">\n  <fieldset class=\"card-block bg-level-1 fit-w\">\n    <div class=\"content-flex-50\">\n      <div class=\"m-l-auto d-flex\">\n        <button\n          title=\"{{ 'Get configuration from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm a-s-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'icon-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get configuration from device' | translate }}\n        </button>\n      </div>\n      <c8y-operation-details\n        *ngIf=\"latestOperation !== undefined\"\n        [operation]=\"latestOperation\"\n        class=\"flex-grow\"\n      ></c8y-operation-details>\n    </div>\n  </fieldset>\n  <div class=\"flex-grow\">\n    <textarea\n      [attr.aria-label]=\"'Operations' | translate\"\n      [(ngModel)]=\"config\"\n      class=\"form-control fit-h p-r-16 p-l-16\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-w separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      id=\"send-config-btn\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig || !config\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending\u2026' | translate }}\" *ngIf=\"savingConfig\">\n        {{ 'Sending\u2026' | translate }}\n      </span>\n    </button>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.ActivatedRoute }, { type: i2.AlertService }, { type: i3.RepositoryService }, { type: i4.DeviceConfigurationService }, { type: i5.InventoryService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvY29uZmlndXJhdGlvbi9kZXZpY2UtdGFiL3RleHQtYmFzZWQtY29uZmlndXJhdGlvbi5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi9yZXBvc2l0b3J5L2NvbmZpZ3VyYXRpb24vZGV2aWNlLXRhYi90ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFrQixnQkFBZ0IsRUFBYyxlQUFlLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUYsT0FBTyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1RCxPQUFPLEVBQ0wsNEJBQTRCLEVBQzVCLGlCQUFpQixFQUNsQixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDOzs7Ozs7Ozs7O0FBTTVFLE1BQU0sT0FBTywrQkFBK0I7SUFRMUMsWUFDVSxLQUFxQixFQUNyQixZQUEwQixFQUMxQixpQkFBb0MsRUFDcEMsMEJBQXNELEVBQ3RELGdCQUFrQztRQUpsQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7UUFDdEQscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVI1QyxvQkFBZSxHQUFHLEtBQUssQ0FBQztJQVNyQixDQUFDO0lBRUosS0FBSyxDQUFDLFFBQVE7UUFD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LGVBQWUsR0FBRyxLQUFLLENBQUM7SUFDL0IsQ0FBQztJQUVPLHdCQUF3QixDQUFDLGVBQWU7UUFDOUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxlQUFlLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxPQUFPLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQztTQUN0RTtJQUNILENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxlQUFlO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0lBQ3pDLENBQUM7SUFFTyx5QkFBeUI7UUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxDQUFDO0lBRU8sS0FBSyxDQUFDLFVBQVU7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUNaLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUNqRCxZQUFZLEVBQUUsS0FBSztTQUNwQixDQUFDLENBQ0gsQ0FBQyxJQUFJLENBQUM7SUFDVCxDQUFDOzs0SEFqSVUsK0JBQStCO2dIQUEvQiwrQkFBK0Isb0VDZDVDLG1nRUF5REE7MkZEM0NhLCtCQUErQjtrQkFKM0MsU0FBUzsrQkFDRSw4QkFBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UsIElPcGVyYXRpb24sIE9wZXJhdGlvblN0YXR1cyB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbixcbiAgUmVwb3NpdG9yeVNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5L3NoYXJlZCc7XG5pbXBvcnQgeyBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS10ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vdGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBUZXh0QmFzZWRDb25maWd1cmF0aW9uQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdDtcbiAgbGF0ZXN0T3BlcmF0aW9uOiBJT3BlcmF0aW9uO1xuICBzaG93VGV4dEJhc2VkQ29uZmlnUmVsb2FkOiBib29sZWFuO1xuICBzaG93VGV4dEJhc2VkQ29uZmlnU2F2ZTogYm9vbGVhbjtcbiAgcmVsb2FkaW5nQ29uZmlnID0gZmFsc2U7XG4gIGNvbmZpZzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBkZXZpY2VDb25maWd1cmF0aW9uU2VydmljZTogRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWQoKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5kZXZpY2UgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhO1xuICAgIGF3YWl0IHRoaXMubG9hZERldmljZSgpO1xuICAgIGF3YWl0IHRoaXMubG9hZE9wZXJhdGlvbigpO1xuICAgIHRoaXMuc2hvd1RleHRCYXNlZENvbmZpZ1JlbG9hZCA9IHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuaGFzQW55U3VwcG9ydGVkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UsXG4gICAgICBbRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbi5TRU5EX0NPTkZJR11cbiAgICApO1xuICAgIHRoaXMuc2hvd1RleHRCYXNlZENvbmZpZ1NhdmUgPSB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0FueVN1cHBvcnRlZE9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgW0RldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uQ09ORklHXVxuICAgICk7XG4gICAgaWYgKHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uICYmIHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZykge1xuICAgICAgdGhpcy5jb25maWcgPSB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWc7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZE9wZXJhdGlvbigpIHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmdldExhc3RDb25maWdVcGRhdGVPcGVyYXRpb24odGhpcy5kZXZpY2UuaWQpO1xuICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIHtcbiAgICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID1cbiAgICAgICAgISFvcGVyYXRpb24uYzh5X1NlbmRDb25maWd1cmF0aW9uICYmXG4gICAgICAgIChvcGVyYXRpb24uc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuUEVORElORyB8fFxuICAgICAgICAgIG9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkcpO1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5vYnNlcnZlT3BlcmF0aW9uKG9wZXJhdGlvbikuc3Vic2NyaWJlKG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHNhdmluZ0NvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5sYXRlc3RPcGVyYXRpb25cbiAgICAgID8gISF0aGlzLmxhdGVzdE9wZXJhdGlvbi5jOHlfQ29uZmlndXJhdGlvbiAmJlxuICAgICAgICAgICh0aGlzLmxhdGVzdE9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5QRU5ESU5HIHx8XG4gICAgICAgICAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkcpXG4gICAgICA6IGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgcmVsb2FkQ29uZmlndXJhdGlvbigpIHtcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IHRydWU7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5jcmVhdGVUZXh0QmFzZWRDb25maWd1cmF0aW9uUmVsb2FkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2VcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbkNmZykuc3Vic2NyaWJlKFxuICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZFN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSxcbiAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRFcnJvcihvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAoKSA9PiB0aGlzLm9uT3BlcmF0aW9uUmVsb2FkQ29tcGxldGUoKVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlQ29uZmlndXJhdGlvbihjb25maWcpIHtcbiAgICBjb25zdCBvcGVyYXRpb25DZmcgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmNyZWF0ZVRleHRCYXNlZENvbmZpZ3VyYXRpb25VcGRhdGVPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIGNvbmZpZ1xuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuY3JlYXRlT2JzZXJ2ZWRPcGVyYXRpb24ob3BlcmF0aW9uQ2ZnKS5zdWJzY3JpYmUoXG4gICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB0aGlzLm9uT3BlcmF0aW9uVXBkYXRlU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblVwZGF0ZUVycm9yKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICgpID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVDb21wbGV0ZSgpXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uUmVsb2FkU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICBpZiAob3BlcmF0aW9uVXBkYXRlLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQ29uZmlndXJhdGlvbiB3aWxsIGJlIHJlbG9hZGVkLicpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uUmVsb2FkRXJyb3Iob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgdGhpcy5yZWxvYWRpbmdDb25maWcgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgb25PcGVyYXRpb25SZWxvYWRDb21wbGV0ZSgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICB0aGlzLmNvbmZpZyA9IHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZztcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblVwZGF0ZVN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5QRU5ESU5HKSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gd2lsbCBiZSB1cGRhdGVkLicpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uVXBkYXRlRXJyb3Iob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uVXBkYXRlQ29tcGxldGUoKSB7XG4gICAgdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnID0gdGhpcy5jb25maWc7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWREZXZpY2UoKSB7XG4gICAgdGhpcy5kZXZpY2UgPSAoXG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKHRoaXMuZGV2aWNlLmlkLCB7XG4gICAgICAgIHdpdGhDaGlsZHJlbjogZmFsc2VcbiAgICAgIH0pXG4gICAgKS5kYXRhO1xuICB9XG59XG4iLCI8ZGl2IGNsYXNzPVwiZC1mbGV4IGQtY29sIGZpdC1oXCI+XG4gIDxmaWVsZHNldCBjbGFzcz1cImNhcmQtYmxvY2sgYmctbGV2ZWwtMSBmaXQtd1wiPlxuICAgIDxkaXYgY2xhc3M9XCJjb250ZW50LWZsZXgtNTBcIj5cbiAgICAgIDxkaXYgY2xhc3M9XCJtLWwtYXV0byBkLWZsZXhcIj5cbiAgICAgICAgPGJ1dHRvblxuICAgICAgICAgIHRpdGxlPVwie3sgJ0dldCBjb25maWd1cmF0aW9uIGZyb20gZGV2aWNlJyB8IHRyYW5zbGF0ZSB9fVwiXG4gICAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgICAgY2xhc3M9XCJidG4gYnRuLWRlZmF1bHQgYnRuLXNtIGEtcy1jZW50ZXIgbS10LTggbS1iLThcIlxuICAgICAgICAgICpuZ0lmPVwic2hvd1RleHRCYXNlZENvbmZpZ1JlbG9hZFwiXG4gICAgICAgICAgKGNsaWNrKT1cInJlbG9hZENvbmZpZ3VyYXRpb24oKVwiXG4gICAgICAgICAgW2Rpc2FibGVkXT1cInJlbG9hZGluZ0NvbmZpZyB8fCBzYXZpbmdDb25maWdcIlxuICAgICAgICA+XG4gICAgICAgICAgPGlcbiAgICAgICAgICAgIGM4eUljb249XCJyZWZyZXNoXCJcbiAgICAgICAgICAgICpuZ0lmPVwicmVsb2FkaW5nQ29uZmlnXCJcbiAgICAgICAgICAgIGNsYXNzPVwibS1yLTRcIlxuICAgICAgICAgICAgW25nQ2xhc3NdPVwieyAnaWNvbi1zcGluJzogcmVsb2FkaW5nQ29uZmlnIH1cIlxuICAgICAgICAgID48L2k+XG4gICAgICAgICAgPGkgYzh5SWNvbj1cImRvd25sb2FkXCIgKm5nSWY9XCIhcmVsb2FkaW5nQ29uZmlnXCIgY2xhc3M9XCJtLXItNFwiPjwvaT5cblxuICAgICAgICAgIHt7ICdHZXQgY29uZmlndXJhdGlvbiBmcm9tIGRldmljZScgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgPC9idXR0b24+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxjOHktb3BlcmF0aW9uLWRldGFpbHNcbiAgICAgICAgKm5nSWY9XCJsYXRlc3RPcGVyYXRpb24gIT09IHVuZGVmaW5lZFwiXG4gICAgICAgIFtvcGVyYXRpb25dPVwibGF0ZXN0T3BlcmF0aW9uXCJcbiAgICAgICAgY2xhc3M9XCJmbGV4LWdyb3dcIlxuICAgICAgPjwvYzh5LW9wZXJhdGlvbi1kZXRhaWxzPlxuICAgIDwvZGl2PlxuICA8L2ZpZWxkc2V0PlxuICA8ZGl2IGNsYXNzPVwiZmxleC1ncm93XCI+XG4gICAgPHRleHRhcmVhXG4gICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cIidPcGVyYXRpb25zJyB8IHRyYW5zbGF0ZVwiXG4gICAgICBbKG5nTW9kZWwpXT1cImNvbmZpZ1wiXG4gICAgICBjbGFzcz1cImZvcm0tY29udHJvbCBmaXQtaCBwLXItMTYgcC1sLTE2XCJcbiAgICAgIFtkaXNhYmxlZF09XCJyZWxvYWRpbmdDb25maWcgfHwgc2F2aW5nQ29uZmlnXCJcbiAgICAgIGM4eS1zcGVsbGNoZWNrPVwiZmFsc2VcIlxuICAgID48L3RleHRhcmVhPlxuICA8L2Rpdj5cbiAgPGRpdiBjbGFzcz1cImNhcmQtZm9vdGVyIGZpdC13IHNlcGFyYXRvclwiICpuZ0lmPVwic2hvd1RleHRCYXNlZENvbmZpZ1NhdmVcIj5cbiAgICA8YnV0dG9uXG4gICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgIGlkPVwic2VuZC1jb25maWctYnRuXCJcbiAgICAgIChjbGljayk9XCJ1cGRhdGVDb25maWd1cmF0aW9uKGNvbmZpZylcIlxuICAgICAgW2Rpc2FibGVkXT1cInJlbG9hZGluZ0NvbmZpZyB8fCBzYXZpbmdDb25maWcgfHwgIWNvbmZpZ1wiXG4gICAgICBjbGFzcz1cImJ0biBidG4tcHJpbWFyeVwiXG4gICAgICBbbmdDbGFzc109XCJ7ICdidG4tcGVuZGluZyc6IHNhdmluZ0NvbmZpZyB9XCJcbiAgICA+XG4gICAgICA8c3BhbiB0aXRsZT1cInt7ICdTZW5kJyB8IHRyYW5zbGF0ZSB9fVwiICpuZ0lmPVwiIXNhdmluZ0NvbmZpZ1wiPlxuICAgICAgICB7eyAnU2VuZCBjb25maWd1cmF0aW9uIHRvIGRldmljZScgfCB0cmFuc2xhdGUgfX1cbiAgICAgIDwvc3Bhbj5cbiAgICAgIDxzcGFuIHRpdGxlPVwie3sgJ1NlbmRpbmfigKYnIHwgdHJhbnNsYXRlIH19XCIgKm5nSWY9XCJzYXZpbmdDb25maWdcIj5cbiAgICAgICAge3sgJ1NlbmRpbmfigKYnIHwgdHJhbnNsYXRlIH19XG4gICAgICA8L3NwYW4+XG4gICAgPC9idXR0b24+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=