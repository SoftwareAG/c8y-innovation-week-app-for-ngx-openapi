import { Component, EventEmitter, forwardRef } from '@angular/core';
import { QueriesUtil } from '@c8y/client';
import { gettext, ModalSelectionMode, PRODUCT_EXPERIENCE_EVENT_SOURCE } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { get, has, isEmpty, isEqual, omitBy } from 'lodash-es';
import { BehaviorSubject, merge, of, Subject } from 'rxjs';
import { map, mergeMap, switchMap, tap } from 'rxjs/operators';
import { PRODUCT_EXPERIENCE } from '../repository.model';
import { RepositoryService } from '../repository.service';
import * as i0 from "@angular/core";
import * as i1 from "../repository.service";
import * as i2 from "@ngx-translate/core";
import * as i3 from "@c8y/ngx-components";
import * as i4 from "@angular/common";
// MODAL STRUCTURE
// - selectModalObject (repository entry (repositoryCategory) -> type c8y_Firmware/c8y_Software)
//   -- ISelectModalOption (repository binary entry (repositoryBinary) => type c8y_FirmwareBinary/c8y_SoftwareBinary)
//   -- ISelectModalOption...
// - selectModalObject...
/**
 * RepositorySelectModalComponent displays repository entries options and allows to select them.
 *
 * @example
 * ```
 * import { take } from 'rxjs/operators';
 * import { RepositorySelectModalComponent, ModalSelectionMode, RepositoryType } from '@c8y/ngx-components/repository/shared';
 *
 * const initialState = {
 *   repositoryType: RepositoryType.FIRMWARE,
 *   title: gettext('Install firmware'),
 *   subTitle: gettext('Available firmwares matching the device type'),
 *   icon: 'c8y-firmware',
 *   mode: ModalSelectionMode.SINGLE,
 *   labels: { ok: gettext('Install') },
 *   disableSelected: false
 * };
 *
 * const modal = this.bsModal.show(RepositorySelectModalComponent, {
 *   ignoreBackdropClick: true,
 *   initialState
 * });
 *
 * modal.content.load.next();
 * modal.content.resultEmitter.pipe(take(1)).subscribe((firmware) => {
 *   ...
 * })
 * ```
 */
export class RepositorySelectModalComponent {
    constructor(repositoryService, translateService) {
        this.repositoryService = repositoryService;
        this.translateService = translateService;
        this.PRODUCT_EXPERIENCE = PRODUCT_EXPERIENCE;
        /**
         * Optional
         * Allows to provide custom data.
         * @example
         * ```
         * import { from } from 'rxjs';
         *
         * const repositoryEntry = { name: 'ExampleEntry', type: 'c8y_Firmware' };
         * const versions = [{ c8y_Firmware: { version: '1.0.0', url: 'http://example.com' } }];
         *
         * const initialState = {repositoryEntriesWithVersions$: from({ ...repositoryEntry, versions })};
         * ```
         */
        this.repositoryEntriesWithVersions$ = undefined;
        /**
         * Optional
         * Allows to use custom badges templates.
         * @example
         * ```
         * import { gettext } from '@c8y/ngx-components';
         *
         * const badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
         * const initialState = { badgeTemplates };
         * ```
         */
        this.badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
        /**
         * Optional
         * Allows to provide custom modal title.
         */
        this.title = gettext('Select repository entry');
        /**
         * Loads the content of the modal.
         * Must be invoked by the modal's caller.
         */
        this.load = new Subject();
        /**
         * Triggers an update of the item list emitted.
         */
        this.updateInstallableList$ = new Subject();
        /**
         * Optional
         * Emits a filter criteria object currently entered in the filter input.
         * Use it to filter the items if you use custom repositoryEntriesWithVersions$.
         */
        this.searchTerm = new BehaviorSubject({});
        /**
         * Optional
         * Allows to provide device type query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.deviceTypeQuery = {};
        /**
         * Optional
         * Allows to provide query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.searchQuery = {};
        /**
         * Optional
         * Allows to provide custom labels for the buttons responsible for confirm/dismiss modal actions.
         */
        this.labels = { ok: gettext('Save') };
        /**
         * Optional
         * Allows to hide the name filter input field.
         * By default, the filter input field is displayed.
         */
        this.showFilter = true;
        /**
         * Optional
         * Allows to show a warning that the search criteria should be narrowed down.
         * By default, this warning is hidden.
         */
        this.areMoreEntries = false;
        /**
         * Emits whenever a new repository binary have been selected in the modal.
         */
        this.onChoiceUpdated = new EventEmitter();
        /**
         * Emits the list of selected options.
         */
        this.resultEmitter = new EventEmitter();
        /**
         * Optional
         * Allows to change selection mode.
         * Supported options:
         *   * single: only single option can be selected.
         *   * multiple: multiple options can be selected.
         */
        this.mode = ModalSelectionMode.SINGLE;
        /**
         * Allows to block selection of the other versions from the same repository entry.
         */
        this.disableSelected = true;
        this.filterCriteria = {};
        this.repositoryEntries$ = this.load.pipe(switchMap(() => this.repositoryEntriesWithVersions$), mergeMap(mos => this.aggregate(mos)), tap(items => {
            this.areMoreEntries = items.length >= this.PAGE_SIZE ? true : false;
        }), tap(items => (this.repositoryEntries = items)));
        this.modalEntries = merge(this.repositoryEntries$, this.updateInstallableList$.pipe(map((updateItemEvent) => {
            const itemToUpdate = (this.repositoryEntries || []).find(item => item.groupId === updateItemEvent.object.groupId);
            if (itemToUpdate) {
                const optionToUpdate = (itemToUpdate.options || []).find(option => option.obj.id === updateItemEvent.object.selectedId);
                if (optionToUpdate) {
                    optionToUpdate.template = updateItemEvent.template;
                    if (updateItemEvent.mapper) {
                        optionToUpdate.obj = updateItemEvent.mapper(optionToUpdate.obj);
                    }
                }
            }
            return this.repositoryEntries;
        })));
        this.PAGE_SIZE = 100;
        this.queriesUtil = new QueriesUtil();
    }
    ngOnInit() {
        if (!this.repositoryType) {
            throw new Error('Repository type must be defined');
        }
        if (!this.repositoryEntriesWithVersions$) {
            this.repositoryEntriesWithVersions$ = of(1).pipe(mergeMap(() => this.repositoryService.listRepositoryEntries(this.repositoryType, {
                query: this.queriesUtil.addAndFilter(this.deviceTypeQuery, has(this.searchQuery, 'name')
                    ? { ...this.searchQuery, name: `*${this.searchQuery.name}*` }
                    : this.searchQuery),
                params: { pageSize: this.PAGE_SIZE }
            })), map(({ data }) => data), map(mos => this.getAndAssignRepositoryBinaries(mos)));
        }
    }
    getAndAssignRepositoryBinaries(mos) {
        mos.forEach(mo => {
            mo.versions = this.repositoryService.listAllVersions(mo);
        });
        return mos;
    }
    search(filterCriteria) {
        this.filterCriteria = omitBy({
            ...this.filterCriteria,
            ...filterCriteria
        }, isEmpty);
        if (!isEqual(this.filterCriteria, this.searchQuery)) {
            this.searchTerm.next(this.filterCriteria);
            this.searchQuery = this.filterCriteria;
            this.load.next();
        }
    }
    result(selectedItems) {
        this.resultEmitter.emit(selectedItems);
    }
    async aggregate(mos) {
        const repositoryType = this.repositoryType;
        const selectedItems = this.selected;
        return Promise.all(mos.map(async (repositoryEntry) => {
            const options = this.getSelectModalOptions(await this.repositoryService.fetchAllItemsFromList(repositoryEntry.versions), selectedItems, repositoryEntry, repositoryType);
            const selectModalObject = this.getSelectModalObject(repositoryEntry, options);
            return selectModalObject;
        }));
    }
    getSelectModalOptions(versions, selectedItems, repositoryEntry, repositoryType) {
        const selectModalOptions = [];
        versions.forEach(repositoryBinary => {
            const isSelected = this.isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType);
            const { version } = repositoryBinary[`${repositoryType}`];
            const bodyValue = version || `(${this.translateService.instant(gettext('not specified`version`'))})`;
            const bodyClass = version ? '' : 'text-muted';
            selectModalOptions.push({
                body: [
                    {
                        value: bodyValue,
                        class: bodyClass
                    }
                ],
                obj: {
                    id: repositoryBinary.id,
                    name: repositoryEntry.name,
                    version,
                    ...(get(repositoryBinary, 'c8y_Patch.dependency') && {
                        dependency: get(repositoryBinary, 'c8y_Patch.dependency')
                    }),
                    ...(get(repositoryBinary, 'c8y_Patch') && { isPatch: true }),
                    url: repositoryBinary[`${repositoryType}`].url,
                    softwareType: repositoryEntry.softwareType
                },
                selected: isSelected
            });
        });
        return selectModalOptions;
    }
    isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType) {
        const isSelected = selectedItems
            ? selectedItems.filter(repositoryFragment => repositoryFragment.name === repositoryEntry.name &&
                repositoryFragment.version === repositoryBinary[`${repositoryType}`].version).length > 0
            : false;
        return isSelected;
    }
    getSelectModalObject(repositoryEntry, options) {
        const label = options.length === 1
            ? this.translateService.instant(this.badgeTemplates['=1'], { count: options.length })
            : this.translateService.instant(this.badgeTemplates.other, { count: options.length });
        const selectModalObject = {
            groupId: repositoryEntry.id,
            body: [
                { value: repositoryEntry.name, class: 'text-truncate' },
                { value: repositoryEntry.description, class: 'text-truncate text-muted' }
            ],
            additionalInformation: { value: label, class: 'label label-info' },
            options
        };
        return selectModalObject;
    }
}
RepositorySelectModalComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: RepositorySelectModalComponent, deps: [{ token: i1.RepositoryService }, { token: i2.TranslateService }], target: i0.ɵɵFactoryTarget.Component });
RepositorySelectModalComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: RepositorySelectModalComponent, selector: "c8y-repository-select-modal", providers: [
        {
            provide: PRODUCT_EXPERIENCE_EVENT_SOURCE,
            useExisting: forwardRef(() => RepositorySelectModalComponent)
        }
    ], ngImport: i0, template: "<c8y-select-modal\n  [icon]=\"icon\"\n  [title]=\"title\"\n  [subTitle]=\"subTitle\"\n  [items]=\"modalEntries | async\"\n  [mode]=\"mode\"\n  [disableSelected]=\"disableSelected\"\n  [labels]=\"labels\"\n  [showFilter]=\"showFilter\"\n  [additionalFilterTemplate]=\"additionalFilterTemplate\"\n  [areMoreEntries]=\"areMoreEntries\"\n  [noItemsMessage]=\"noItemsMessage\"\n  (search)=\"search({ name: $event })\"\n  (onChoiceUpdated)=\"onChoiceUpdated.emit($event)\"\n  (result)=\"result($event)\"\n  c8yProductExperience\n  inherit\n  suppressDataOverriding\n  [actionData]=\"{ component: PRODUCT_EXPERIENCE.SHARED.COMPONENTS.REPOSITORY_SELECT_MODAL }\"\n></c8y-select-modal>\n", dependencies: [{ kind: "component", type: i3.SelectModalComponent, selector: "c8y-select-modal", inputs: ["icon", "title", "subTitle", "items", "mode", "disableSelected", "showFilter", "additionalFilterTemplate", "areMoreEntries", "labels", "noItemsMessage"], outputs: ["result", "search", "onChoiceUpdated"] }, { kind: "directive", type: i3.ProductExperienceDirective, selector: "[c8yProductExperience]", inputs: ["actionName", "actionData", "inherit", "suppressDataOverriding"] }, { kind: "pipe", type: i4.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: RepositorySelectModalComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-repository-select-modal', providers: [
                        {
                            provide: PRODUCT_EXPERIENCE_EVENT_SOURCE,
                            useExisting: forwardRef(() => RepositorySelectModalComponent)
                        }
                    ], template: "<c8y-select-modal\n  [icon]=\"icon\"\n  [title]=\"title\"\n  [subTitle]=\"subTitle\"\n  [items]=\"modalEntries | async\"\n  [mode]=\"mode\"\n  [disableSelected]=\"disableSelected\"\n  [labels]=\"labels\"\n  [showFilter]=\"showFilter\"\n  [additionalFilterTemplate]=\"additionalFilterTemplate\"\n  [areMoreEntries]=\"areMoreEntries\"\n  [noItemsMessage]=\"noItemsMessage\"\n  (search)=\"search({ name: $event })\"\n  (onChoiceUpdated)=\"onChoiceUpdated.emit($event)\"\n  (result)=\"result($event)\"\n  c8yProductExperience\n  inherit\n  suppressDataOverriding\n  [actionData]=\"{ component: PRODUCT_EXPERIENCE.SHARED.COMPONENTS.REPOSITORY_SELECT_MODAL }\"\n></c8y-select-modal>\n" }]
        }], ctorParameters: function () { return [{ type: i1.RepositoryService }, { type: i2.TranslateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcmVwb3NpdG9yeS9zaGFyZWQvc2VsZWN0LW1vZGFsL3JlcG9zaXRvcnktc2VsZWN0LW1vZGFsLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvc2hhcmVkL3NlbGVjdC1tb2RhbC9yZXBvc2l0b3J5LXNlbGVjdC1tb2RhbC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFDakYsT0FBTyxFQUFrQixXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUQsT0FBTyxFQUNMLE9BQU8sRUFLUCxrQkFBa0IsRUFHbEIsK0JBQStCLEVBQ2hDLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUVMLGtCQUFrQixFQUtuQixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7Ozs7QUFFMUQsa0JBQWtCO0FBQ2xCLGdHQUFnRztBQUNoRyxxSEFBcUg7QUFDckgsNkJBQTZCO0FBQzdCLHlCQUF5QjtBQUV6Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQTRCRztBQVlILE1BQU0sT0FBTyw4QkFBOEI7SUE2S3pDLFlBQ1UsaUJBQW9DLEVBQ3BDLGdCQUFrQztRQURsQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUE5SzVDLHVCQUFrQixHQUFHLGtCQUFrQixDQUFDO1FBQ3hDOzs7Ozs7Ozs7Ozs7V0FZRztRQUNILG1DQUE4QixHQUFpQyxTQUFTLENBQUM7UUFLekU7Ozs7Ozs7Ozs7V0FVRztRQUNILG1CQUFjLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUM7UUFDOUY7OztXQUdHO1FBQ0gsVUFBSyxHQUFXLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBTW5EOzs7V0FHRztRQUNILFNBQUksR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNwQzs7V0FFRztRQUNILDJCQUFzQixHQUFtQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3ZFOzs7O1dBSUc7UUFDSCxlQUFVLEdBQW9DLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFOzs7OztXQUtHO1FBQ0gsb0JBQWUsR0FBUSxFQUFFLENBQUM7UUFDMUI7Ozs7O1dBS0c7UUFDSCxnQkFBVyxHQUFRLEVBQUUsQ0FBQztRQUN0Qjs7O1dBR0c7UUFDSCxXQUFNLEdBQWdCLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQzlDOzs7O1dBSUc7UUFDSCxlQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ2xCOzs7O1dBSUc7UUFDSCxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQVd2Qjs7V0FFRztRQUNILG9CQUFlLEdBQXFDLElBQUksWUFBWSxFQUFzQixDQUFDO1FBQzNGOztXQUVHO1FBQ0gsa0JBQWEsR0FBNkMsSUFBSSxZQUFZLEVBRXZFLENBQUM7UUFDSjs7Ozs7O1dBTUc7UUFDSCxTQUFJLEdBQXVCLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztRQU1yRDs7V0FFRztRQUNILG9CQUFlLEdBQUcsSUFBSSxDQUFDO1FBRXZCLG1CQUFjLEdBQW1CLEVBQUUsQ0FBQztRQUVwQyx1QkFBa0IsR0FBcUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ25FLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUMsRUFDcEQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUNwQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDVixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDdEUsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FDL0MsQ0FBQztRQUVGLGlCQUFZLEdBQXFDLEtBQUssQ0FDcEQsSUFBSSxDQUFDLGtCQUFrQixFQUN2QixJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUM5QixHQUFHLENBQUMsQ0FBQyxlQUFzQyxFQUFFLEVBQUU7WUFDN0MsTUFBTSxZQUFZLEdBQXVCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDMUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLGVBQWUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUN4RCxDQUFDO1lBQ0YsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLE1BQU0sY0FBYyxHQUF1QixDQUFDLFlBQVksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUMxRSxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFNLGVBQWUsQ0FBQyxNQUFjLENBQUMsVUFBVSxDQUN2RSxDQUFDO2dCQUNGLElBQUksY0FBYyxFQUFFO29CQUNsQixjQUFjLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUM7b0JBQ25ELElBQUksZUFBZSxDQUFDLE1BQU0sRUFBRTt3QkFDMUIsY0FBYyxDQUFDLEdBQUcsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztxQkFDakU7aUJBQ0Y7YUFDRjtZQUNELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUNILENBQ0YsQ0FBQztRQVdNLGNBQVMsR0FBRyxHQUFHLENBQUM7UUFRdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRTtZQUN4QyxJQUFJLENBQUMsOEJBQThCLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDOUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUNaLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUNoRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQ2xDLElBQUksQ0FBQyxlQUFlLEVBQ3BCLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQztvQkFDM0IsQ0FBQyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLEVBQUU7b0JBQzdELENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUNyQjtnQkFDRCxNQUFNLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRTthQUNyQyxDQUFDLENBQ0gsRUFDRCxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFDdkIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ3JELENBQUM7U0FDSDtJQUNILENBQUM7SUFFRCw4QkFBOEIsQ0FBQyxHQUFxQjtRQUNsRCxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2YsRUFBRSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNELENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsTUFBTSxDQUFDLGNBQThCO1FBQ25DLElBQUksQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUMxQjtZQUNFLEdBQUcsSUFBSSxDQUFDLGNBQWM7WUFDdEIsR0FBRyxjQUFjO1NBQ2xCLEVBQ0QsT0FBTyxDQUNSLENBQUM7UUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ25ELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsYUFBeUM7UUFDOUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBcUI7UUFDbkMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztRQUMzQyxNQUFNLGFBQWEsR0FBK0IsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUVoRSxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQ2hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLGVBQWUsRUFBQyxFQUFFO1lBQzlCLE1BQU0sT0FBTyxHQUF5QixJQUFJLENBQUMscUJBQXFCLENBQzlELE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsRUFDNUUsYUFBYSxFQUNiLGVBQXFDLEVBQ3JDLGNBQWMsQ0FDZixDQUFDO1lBQ0YsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQ2pELGVBQXFDLEVBQ3JDLE9BQU8sQ0FDUixDQUFDO1lBRUYsT0FBTyxpQkFBaUIsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELHFCQUFxQixDQUNuQixRQUE0QixFQUM1QixhQUF5QyxFQUN6QyxlQUFtQyxFQUNuQyxjQUE4QjtRQUU5QixNQUFNLGtCQUFrQixHQUF5QixFQUFFLENBQUM7UUFDcEQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sVUFBVSxHQUFZLElBQUksQ0FBQywwQkFBMEIsQ0FDekQsYUFBYSxFQUNiLGVBQWUsRUFDZixnQkFBZ0IsRUFDaEIsY0FBYyxDQUNmLENBQUM7WUFFRixNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQzFELE1BQU0sU0FBUyxHQUNiLE9BQU8sSUFBSSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ3JGLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUM7WUFDOUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDO2dCQUN0QixJQUFJLEVBQUU7b0JBQ0o7d0JBQ0UsS0FBSyxFQUFFLFNBQVM7d0JBQ2hCLEtBQUssRUFBRSxTQUFTO3FCQUNqQjtpQkFDRjtnQkFDRCxHQUFHLEVBQUU7b0JBQ0gsRUFBRSxFQUFFLGdCQUFnQixDQUFDLEVBQUU7b0JBQ3ZCLElBQUksRUFBRSxlQUFlLENBQUMsSUFBSTtvQkFDMUIsT0FBTztvQkFDUCxHQUFHLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLHNCQUFzQixDQUFDLElBQUk7d0JBQ25ELFVBQVUsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsc0JBQXNCLENBQUM7cUJBQzFELENBQUM7b0JBQ0YsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztvQkFDNUQsR0FBRyxFQUFFLGdCQUFnQixDQUFDLEdBQUcsY0FBYyxFQUFFLENBQUMsQ0FBQyxHQUFHO29CQUM5QyxZQUFZLEVBQUUsZUFBZSxDQUFDLFlBQVk7aUJBQzNDO2dCQUNELFFBQVEsRUFBRSxVQUFVO2FBQ3JCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBRUQsMEJBQTBCLENBQ3hCLGFBQXlDLEVBQ3pDLGVBQW1DLEVBQ25DLGdCQUFrQyxFQUNsQyxjQUE4QjtRQUU5QixNQUFNLFVBQVUsR0FBRyxhQUFhO1lBQzlCLENBQUMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUNsQixrQkFBa0IsQ0FBQyxFQUFFLENBQ25CLGtCQUFrQixDQUFDLElBQUksS0FBSyxlQUFlLENBQUMsSUFBSTtnQkFDaEQsa0JBQWtCLENBQUMsT0FBTyxLQUFLLGdCQUFnQixDQUFDLEdBQUcsY0FBYyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQy9FLENBQUMsTUFBTSxHQUFHLENBQUM7WUFDZCxDQUFDLENBQUMsS0FBSyxDQUFDO1FBRVYsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVELG9CQUFvQixDQUNsQixlQUFtQyxFQUNuQyxPQUE2QjtRQUU3QixNQUFNLEtBQUssR0FDVCxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDckYsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFFMUYsTUFBTSxpQkFBaUIsR0FBdUI7WUFDNUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxFQUFFO1lBQzNCLElBQUksRUFBRTtnQkFDSixFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUU7Z0JBQ3ZELEVBQUUsS0FBSyxFQUFFLGVBQWUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLDBCQUEwQixFQUFFO2FBQzFFO1lBQ0QscUJBQXFCLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRTtZQUNsRSxPQUFPO1NBQ1IsQ0FBQztRQUVGLE9BQU8saUJBQWlCLENBQUM7SUFDM0IsQ0FBQzs7MkhBN1VVLDhCQUE4QjsrR0FBOUIsOEJBQThCLHNEQVA5QjtRQUNUO1lBQ0UsT0FBTyxFQUFFLCtCQUErQjtZQUN4QyxXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLDhCQUE4QixDQUFDO1NBQzlEO0tBQ0YsMEJDdkVILHdxQkFvQkE7MkZEcURhLDhCQUE4QjtrQkFWMUMsU0FBUzsrQkFDRSw2QkFBNkIsYUFFNUI7d0JBQ1Q7NEJBQ0UsT0FBTyxFQUFFLCtCQUErQjs0QkFDeEMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsK0JBQStCLENBQUM7eUJBQzlEO3FCQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIFRlbXBsYXRlUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgUXVlcmllc1V0aWwgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBnZXR0ZXh0LFxuICBJU2VsZWN0TW9kYWxPYmplY3QsXG4gIElTZWxlY3RNb2RhbE9wdGlvbixcbiAgSVVwZGF0ZUl0ZW1FdmVudCxcbiAgTW9kYWxMYWJlbHMsXG4gIE1vZGFsU2VsZWN0aW9uTW9kZSxcbiAgUHJvZHVjdEV4cGVyaWVuY2VFdmVudCxcbiAgUHJvZHVjdEV4cGVyaWVuY2VFdmVudFNvdXJjZSxcbiAgUFJPRFVDVF9FWFBFUklFTkNFX0VWRU5UX1NPVVJDRVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IGdldCwgaGFzLCBpc0VtcHR5LCBpc0VxdWFsLCBvbWl0QnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgRmlsdGVyQ3JpdGVyaWEsXG4gIFBST0RVQ1RfRVhQRVJJRU5DRSxcbiAgUmVwb3NpdG9yeUJpbmFyeSxcbiAgUmVwb3NpdG9yeUNhdGVnb3J5LFxuICBSZXBvc2l0b3J5VHlwZSxcbiAgU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5XG59IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuXG4vLyBNT0RBTCBTVFJVQ1RVUkVcbi8vIC0gc2VsZWN0TW9kYWxPYmplY3QgKHJlcG9zaXRvcnkgZW50cnkgKHJlcG9zaXRvcnlDYXRlZ29yeSkgLT4gdHlwZSBjOHlfRmlybXdhcmUvYzh5X1NvZnR3YXJlKVxuLy8gICAtLSBJU2VsZWN0TW9kYWxPcHRpb24gKHJlcG9zaXRvcnkgYmluYXJ5IGVudHJ5IChyZXBvc2l0b3J5QmluYXJ5KSA9PiB0eXBlIGM4eV9GaXJtd2FyZUJpbmFyeS9jOHlfU29mdHdhcmVCaW5hcnkpXG4vLyAgIC0tIElTZWxlY3RNb2RhbE9wdGlvbi4uLlxuLy8gLSBzZWxlY3RNb2RhbE9iamVjdC4uLlxuXG4vKipcbiAqIFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCBkaXNwbGF5cyByZXBvc2l0b3J5IGVudHJpZXMgb3B0aW9ucyBhbmQgYWxsb3dzIHRvIHNlbGVjdCB0aGVtLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBcbiAqIGltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG4gKiBpbXBvcnQgeyBSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQsIE1vZGFsU2VsZWN0aW9uTW9kZSwgUmVwb3NpdG9yeVR5cGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnkvc2hhcmVkJztcbiAqXG4gKiBjb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gKiAgIHJlcG9zaXRvcnlUeXBlOiBSZXBvc2l0b3J5VHlwZS5GSVJNV0FSRSxcbiAqICAgdGl0bGU6IGdldHRleHQoJ0luc3RhbGwgZmlybXdhcmUnKSxcbiAqICAgc3ViVGl0bGU6IGdldHRleHQoJ0F2YWlsYWJsZSBmaXJtd2FyZXMgbWF0Y2hpbmcgdGhlIGRldmljZSB0eXBlJyksXG4gKiAgIGljb246ICdjOHktZmlybXdhcmUnLFxuICogICBtb2RlOiBNb2RhbFNlbGVjdGlvbk1vZGUuU0lOR0xFLFxuICogICBsYWJlbHM6IHsgb2s6IGdldHRleHQoJ0luc3RhbGwnKSB9LFxuICogICBkaXNhYmxlU2VsZWN0ZWQ6IGZhbHNlXG4gKiB9O1xuICpcbiAqIGNvbnN0IG1vZGFsID0gdGhpcy5ic01vZGFsLnNob3coUmVwb3NpdG9yeVNlbGVjdE1vZGFsQ29tcG9uZW50LCB7XG4gKiAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWUsXG4gKiAgIGluaXRpYWxTdGF0ZVxuICogfSk7XG4gKlxuICogbW9kYWwuY29udGVudC5sb2FkLm5leHQoKTtcbiAqIG1vZGFsLmNvbnRlbnQucmVzdWx0RW1pdHRlci5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgoZmlybXdhcmUpID0+IHtcbiAqICAgLi4uXG4gKiB9KVxuICogYGBgXG4gKi9cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXJlcG9zaXRvcnktc2VsZWN0LW1vZGFsJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3JlcG9zaXRvcnktc2VsZWN0LW1vZGFsLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogUFJPRFVDVF9FWFBFUklFTkNFX0VWRU5UX1NPVVJDRSxcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudClcbiAgICB9XG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgUmVwb3NpdG9yeVNlbGVjdE1vZGFsQ29tcG9uZW50IGltcGxlbWVudHMgUHJvZHVjdEV4cGVyaWVuY2VFdmVudFNvdXJjZSB7XG4gIFBST0RVQ1RfRVhQRVJJRU5DRSA9IFBST0RVQ1RfRVhQRVJJRU5DRTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBwcm92aWRlIGN1c3RvbSBkYXRhLlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBcbiAgICogaW1wb3J0IHsgZnJvbSB9IGZyb20gJ3J4anMnO1xuICAgKlxuICAgKiBjb25zdCByZXBvc2l0b3J5RW50cnkgPSB7IG5hbWU6ICdFeGFtcGxlRW50cnknLCB0eXBlOiAnYzh5X0Zpcm13YXJlJyB9O1xuICAgKiBjb25zdCB2ZXJzaW9ucyA9IFt7IGM4eV9GaXJtd2FyZTogeyB2ZXJzaW9uOiAnMS4wLjAnLCB1cmw6ICdodHRwOi8vZXhhbXBsZS5jb20nIH0gfV07XG4gICAqXG4gICAqIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHtyZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IGZyb20oeyAuLi5yZXBvc2l0b3J5RW50cnksIHZlcnNpb25zIH0pfTtcbiAgICogYGBgXG4gICAqL1xuICByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQ6IE9ic2VydmFibGU8SU1hbmFnZWRPYmplY3RbXT4gPSB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBSZXBvc2l0b3J5IGVudHJ5IHR5cGUuXG4gICAqL1xuICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGUuRklSTVdBUkUgfCBSZXBvc2l0b3J5VHlwZS5TT0ZUV0FSRTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byB1c2UgY3VzdG9tIGJhZGdlcyB0ZW1wbGF0ZXMuXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYFxuICAgKiBpbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG4gICAqXG4gICAqIGNvbnN0IGJhZGdlVGVtcGxhdGVzID0geyAnPTEnOiBnZXR0ZXh0KCd7e2NvdW50fX0gdmVyc2lvbicpLCBvdGhlcjogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb25zJykgfTtcbiAgICogY29uc3QgaW5pdGlhbFN0YXRlID0geyBiYWRnZVRlbXBsYXRlcyB9O1xuICAgKiBgYGBcbiAgICovXG4gIGJhZGdlVGVtcGxhdGVzID0geyAnPTEnOiBnZXR0ZXh0KCd7e2NvdW50fX0gdmVyc2lvbicpLCBvdGhlcjogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb25zJykgfTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBwcm92aWRlIGN1c3RvbSBtb2RhbCB0aXRsZS5cbiAgICovXG4gIHRpdGxlOiBzdHJpbmcgPSBnZXR0ZXh0KCdTZWxlY3QgcmVwb3NpdG9yeSBlbnRyeScpO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgY3VzdG9tIG1vZGFsIHN1YnRpdGxlLlxuICAgKi9cbiAgc3ViVGl0bGU6IHN0cmluZztcbiAgLyoqXG4gICAqIExvYWRzIHRoZSBjb250ZW50IG9mIHRoZSBtb2RhbC5cbiAgICogTXVzdCBiZSBpbnZva2VkIGJ5IHRoZSBtb2RhbCdzIGNhbGxlci5cbiAgICovXG4gIGxvYWQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuICAvKipcbiAgICogVHJpZ2dlcnMgYW4gdXBkYXRlIG9mIHRoZSBpdGVtIGxpc3QgZW1pdHRlZC5cbiAgICovXG4gIHVwZGF0ZUluc3RhbGxhYmxlTGlzdCQ6IFN1YmplY3Q8SVVwZGF0ZUl0ZW1FdmVudDxhbnk+PiA9IG5ldyBTdWJqZWN0KCk7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBFbWl0cyBhIGZpbHRlciBjcml0ZXJpYSBvYmplY3QgY3VycmVudGx5IGVudGVyZWQgaW4gdGhlIGZpbHRlciBpbnB1dC5cbiAgICogVXNlIGl0IHRvIGZpbHRlciB0aGUgaXRlbXMgaWYgeW91IHVzZSBjdXN0b20gcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkLlxuICAgKi9cbiAgc2VhcmNoVGVybTogQmVoYXZpb3JTdWJqZWN0PEZpbHRlckNyaXRlcmlhPiA9IG5ldyBCZWhhdmlvclN1YmplY3Qoe30pO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgZGV2aWNlIHR5cGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBkZXZpY2VUeXBlUXVlcnk6IGFueSA9IHt9O1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBzZWFyY2hRdWVyeTogYW55ID0ge307XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBjdXN0b20gbGFiZWxzIGZvciB0aGUgYnV0dG9ucyByZXNwb25zaWJsZSBmb3IgY29uZmlybS9kaXNtaXNzIG1vZGFsIGFjdGlvbnMuXG4gICAqL1xuICBsYWJlbHM6IE1vZGFsTGFiZWxzID0geyBvazogZ2V0dGV4dCgnU2F2ZScpIH07XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gaGlkZSB0aGUgbmFtZSBmaWx0ZXIgaW5wdXQgZmllbGQuXG4gICAqIEJ5IGRlZmF1bHQsIHRoZSBmaWx0ZXIgaW5wdXQgZmllbGQgaXMgZGlzcGxheWVkLlxuICAgKi9cbiAgc2hvd0ZpbHRlciA9IHRydWU7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gc2hvdyBhIHdhcm5pbmcgdGhhdCB0aGUgc2VhcmNoIGNyaXRlcmlhIHNob3VsZCBiZSBuYXJyb3dlZCBkb3duLlxuICAgKiBCeSBkZWZhdWx0LCB0aGlzIHdhcm5pbmcgaXMgaGlkZGVuLlxuICAgKi9cbiAgYXJlTW9yZUVudHJpZXMgPSBmYWxzZTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBkaXNwbGF5IGEgbW9yZSBzcGVjaWZpYyB0aGFuIHRoZSBkZWZhdWx0IG1lc3NhZ2UgaW4gY2FzZSB0aGVyZSBhcmUgbm8gaXRlbXMgdG8gZGlzcGxheS5cbiAgICovXG4gIG5vSXRlbXNNZXNzYWdlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcGFzcyB0aGUgYXJyYXkgb2YgaXRlbXMuIEVhY2ggaXRlbSBmcm9tIHRoaXMgYXJyYXkgd2lsbCBiZSBtYXJrZWQgYXMgc2VsZWN0ZWQgaW4gdGhlIG1vZGFsLlxuICAgKi9cbiAgc2VsZWN0ZWQ6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdO1xuICAvKipcbiAgICogRW1pdHMgd2hlbmV2ZXIgYSBuZXcgcmVwb3NpdG9yeSBiaW5hcnkgaGF2ZSBiZWVuIHNlbGVjdGVkIGluIHRoZSBtb2RhbC5cbiAgICovXG4gIG9uQ2hvaWNlVXBkYXRlZDogRXZlbnRFbWl0dGVyPElTZWxlY3RNb2RhbE9iamVjdD4gPSBuZXcgRXZlbnRFbWl0dGVyPElTZWxlY3RNb2RhbE9iamVjdD4oKTtcbiAgLyoqXG4gICAqIEVtaXRzIHRoZSBsaXN0IG9mIHNlbGVjdGVkIG9wdGlvbnMuXG4gICAqL1xuICByZXN1bHRFbWl0dGVyOiBFdmVudEVtaXR0ZXI8U2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10+ID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXVxuICA+KCk7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gY2hhbmdlIHNlbGVjdGlvbiBtb2RlLlxuICAgKiBTdXBwb3J0ZWQgb3B0aW9uczpcbiAgICogICAqIHNpbmdsZTogb25seSBzaW5nbGUgb3B0aW9uIGNhbiBiZSBzZWxlY3RlZC5cbiAgICogICAqIG11bHRpcGxlOiBtdWx0aXBsZSBvcHRpb25zIGNhbiBiZSBzZWxlY3RlZC5cbiAgICovXG4gIG1vZGU6IE1vZGFsU2VsZWN0aW9uTW9kZSA9IE1vZGFsU2VsZWN0aW9uTW9kZS5TSU5HTEU7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gdXNlIGN1c3RvbSBpY29uIGluIHRoZSBtb2RhbCBoZWFkZXIuXG4gICAqL1xuICBpY29uOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gYmxvY2sgc2VsZWN0aW9uIG9mIHRoZSBvdGhlciB2ZXJzaW9ucyBmcm9tIHRoZSBzYW1lIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqL1xuICBkaXNhYmxlU2VsZWN0ZWQgPSB0cnVlO1xuXG4gIGZpbHRlckNyaXRlcmlhOiBGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuXG4gIHJlcG9zaXRvcnlFbnRyaWVzJDogT2JzZXJ2YWJsZTxJU2VsZWN0TW9kYWxPYmplY3RbXT4gPSB0aGlzLmxvYWQucGlwZShcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQpLFxuICAgIG1lcmdlTWFwKG1vcyA9PiB0aGlzLmFnZ3JlZ2F0ZShtb3MpKSxcbiAgICB0YXAoaXRlbXMgPT4ge1xuICAgICAgdGhpcy5hcmVNb3JlRW50cmllcyA9IGl0ZW1zLmxlbmd0aCA+PSB0aGlzLlBBR0VfU0laRSA/IHRydWUgOiBmYWxzZTtcbiAgICB9KSxcbiAgICB0YXAoaXRlbXMgPT4gKHRoaXMucmVwb3NpdG9yeUVudHJpZXMgPSBpdGVtcykpXG4gICk7XG5cbiAgbW9kYWxFbnRyaWVzOiBPYnNlcnZhYmxlPElTZWxlY3RNb2RhbE9iamVjdFtdPiA9IG1lcmdlKFxuICAgIHRoaXMucmVwb3NpdG9yeUVudHJpZXMkLFxuICAgIHRoaXMudXBkYXRlSW5zdGFsbGFibGVMaXN0JC5waXBlKFxuICAgICAgbWFwKCh1cGRhdGVJdGVtRXZlbnQ6IElVcGRhdGVJdGVtRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBpdGVtVG9VcGRhdGU6IElTZWxlY3RNb2RhbE9iamVjdCA9ICh0aGlzLnJlcG9zaXRvcnlFbnRyaWVzIHx8IFtdKS5maW5kKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbS5ncm91cElkID09PSB1cGRhdGVJdGVtRXZlbnQub2JqZWN0Lmdyb3VwSWRcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGl0ZW1Ub1VwZGF0ZSkge1xuICAgICAgICAgIGNvbnN0IG9wdGlvblRvVXBkYXRlOiBJU2VsZWN0TW9kYWxPcHRpb24gPSAoaXRlbVRvVXBkYXRlLm9wdGlvbnMgfHwgW10pLmZpbmQoXG4gICAgICAgICAgICBvcHRpb24gPT4gb3B0aW9uLm9iai5pZCA9PT0gKHVwZGF0ZUl0ZW1FdmVudC5vYmplY3QgYXMgYW55KS5zZWxlY3RlZElkXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAob3B0aW9uVG9VcGRhdGUpIHtcbiAgICAgICAgICAgIG9wdGlvblRvVXBkYXRlLnRlbXBsYXRlID0gdXBkYXRlSXRlbUV2ZW50LnRlbXBsYXRlO1xuICAgICAgICAgICAgaWYgKHVwZGF0ZUl0ZW1FdmVudC5tYXBwZXIpIHtcbiAgICAgICAgICAgICAgb3B0aW9uVG9VcGRhdGUub2JqID0gdXBkYXRlSXRlbUV2ZW50Lm1hcHBlcihvcHRpb25Ub1VwZGF0ZS5vYmopO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5RW50cmllcztcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBhZGRpdGlvbmFsIHRlbXBsYXRlIHRoYXQgd2lsbCBiZSByZW5kZXJlZCBpbiB0aGVcbiAgICogZmlsdGVycyBibG9jayBvbiB0b3Agb2YgdGhlIHJlc3VsdHMgbGlzdCBpbiB0aGUgc2VsZWN0IG1vZGFsLlxuICAgKi9cbiAgYWRkaXRpb25hbEZpbHRlclRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIHByb2R1Y3RFeHBlcmllbmNlRXZlbnQ6IFByb2R1Y3RFeHBlcmllbmNlRXZlbnQ7XG5cbiAgcHJpdmF0ZSBQQUdFX1NJWkUgPSAxMDA7XG4gIHByaXZhdGUgcXVlcmllc1V0aWw6IFF1ZXJpZXNVdGlsO1xuICBwcml2YXRlIHJlcG9zaXRvcnlFbnRyaWVzOiBJU2VsZWN0TW9kYWxPYmplY3RbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKCF0aGlzLnJlcG9zaXRvcnlUeXBlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcG9zaXRvcnkgdHlwZSBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkKSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCA9IG9mKDEpLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKCgpID0+XG4gICAgICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0UmVwb3NpdG9yeUVudHJpZXModGhpcy5yZXBvc2l0b3J5VHlwZSwge1xuICAgICAgICAgICAgcXVlcnk6IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKFxuICAgICAgICAgICAgICB0aGlzLmRldmljZVR5cGVRdWVyeSxcbiAgICAgICAgICAgICAgaGFzKHRoaXMuc2VhcmNoUXVlcnksICduYW1lJylcbiAgICAgICAgICAgICAgICA/IHsgLi4udGhpcy5zZWFyY2hRdWVyeSwgbmFtZTogYCoke3RoaXMuc2VhcmNoUXVlcnkubmFtZX0qYCB9XG4gICAgICAgICAgICAgICAgOiB0aGlzLnNlYXJjaFF1ZXJ5XG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgcGFyYW1zOiB7IHBhZ2VTaXplOiB0aGlzLlBBR0VfU0laRSB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKSxcbiAgICAgICAgbWFwKCh7IGRhdGEgfSkgPT4gZGF0YSksXG4gICAgICAgIG1hcChtb3MgPT4gdGhpcy5nZXRBbmRBc3NpZ25SZXBvc2l0b3J5QmluYXJpZXMobW9zKSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QW5kQXNzaWduUmVwb3NpdG9yeUJpbmFyaWVzKG1vczogSU1hbmFnZWRPYmplY3RbXSkge1xuICAgIG1vcy5mb3JFYWNoKG1vID0+IHtcbiAgICAgIG1vLnZlcnNpb25zID0gdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0QWxsVmVyc2lvbnMobW8pO1xuICAgIH0pO1xuICAgIHJldHVybiBtb3M7XG4gIH1cblxuICBzZWFyY2goZmlsdGVyQ3JpdGVyaWE6IEZpbHRlckNyaXRlcmlhKSB7XG4gICAgdGhpcy5maWx0ZXJDcml0ZXJpYSA9IG9taXRCeShcbiAgICAgIHtcbiAgICAgICAgLi4udGhpcy5maWx0ZXJDcml0ZXJpYSxcbiAgICAgICAgLi4uZmlsdGVyQ3JpdGVyaWFcbiAgICAgIH0sXG4gICAgICBpc0VtcHR5XG4gICAgKTtcblxuICAgIGlmICghaXNFcXVhbCh0aGlzLmZpbHRlckNyaXRlcmlhLCB0aGlzLnNlYXJjaFF1ZXJ5KSkge1xuICAgICAgdGhpcy5zZWFyY2hUZXJtLm5leHQodGhpcy5maWx0ZXJDcml0ZXJpYSk7XG4gICAgICB0aGlzLnNlYXJjaFF1ZXJ5ID0gdGhpcy5maWx0ZXJDcml0ZXJpYTtcbiAgICAgIHRoaXMubG9hZC5uZXh0KCk7XG4gICAgfVxuICB9XG5cbiAgcmVzdWx0KHNlbGVjdGVkSXRlbXM6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdKSB7XG4gICAgdGhpcy5yZXN1bHRFbWl0dGVyLmVtaXQoc2VsZWN0ZWRJdGVtcyk7XG4gIH1cblxuICBhc3luYyBhZ2dyZWdhdGUobW9zOiBJTWFuYWdlZE9iamVjdFtdKTogUHJvbWlzZTxJU2VsZWN0TW9kYWxPYmplY3RbXT4ge1xuICAgIGNvbnN0IHJlcG9zaXRvcnlUeXBlID0gdGhpcy5yZXBvc2l0b3J5VHlwZTtcbiAgICBjb25zdCBzZWxlY3RlZEl0ZW1zOiBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXSA9IHRoaXMuc2VsZWN0ZWQ7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICBtb3MubWFwKGFzeW5jIHJlcG9zaXRvcnlFbnRyeSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IElTZWxlY3RNb2RhbE9wdGlvbltdID0gdGhpcy5nZXRTZWxlY3RNb2RhbE9wdGlvbnMoXG4gICAgICAgICAgYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5mZXRjaEFsbEl0ZW1zRnJvbUxpc3QocmVwb3NpdG9yeUVudHJ5LnZlcnNpb25zKSxcbiAgICAgICAgICBzZWxlY3RlZEl0ZW1zLFxuICAgICAgICAgIHJlcG9zaXRvcnlFbnRyeSBhcyBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgICAgICAgcmVwb3NpdG9yeVR5cGVcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3Qgc2VsZWN0TW9kYWxPYmplY3QgPSB0aGlzLmdldFNlbGVjdE1vZGFsT2JqZWN0KFxuICAgICAgICAgIHJlcG9zaXRvcnlFbnRyeSBhcyBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgICAgICAgb3B0aW9uc1xuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBzZWxlY3RNb2RhbE9iamVjdDtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGdldFNlbGVjdE1vZGFsT3B0aW9ucyhcbiAgICB2ZXJzaW9uczogUmVwb3NpdG9yeUJpbmFyeVtdLFxuICAgIHNlbGVjdGVkSXRlbXM6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdLFxuICAgIHJlcG9zaXRvcnlFbnRyeTogUmVwb3NpdG9yeUNhdGVnb3J5LFxuICAgIHJlcG9zaXRvcnlUeXBlOiBSZXBvc2l0b3J5VHlwZVxuICApOiBJU2VsZWN0TW9kYWxPcHRpb25bXSB7XG4gICAgY29uc3Qgc2VsZWN0TW9kYWxPcHRpb25zOiBJU2VsZWN0TW9kYWxPcHRpb25bXSA9IFtdO1xuICAgIHZlcnNpb25zLmZvckVhY2gocmVwb3NpdG9yeUJpbmFyeSA9PiB7XG4gICAgICBjb25zdCBpc1NlbGVjdGVkOiBib29sZWFuID0gdGhpcy5pc0JpbmFyeVJlcG9zaXRvcnlTZWxlY3RlZChcbiAgICAgICAgc2VsZWN0ZWRJdGVtcyxcbiAgICAgICAgcmVwb3NpdG9yeUVudHJ5LFxuICAgICAgICByZXBvc2l0b3J5QmluYXJ5LFxuICAgICAgICByZXBvc2l0b3J5VHlwZVxuICAgICAgKTtcblxuICAgICAgY29uc3QgeyB2ZXJzaW9uIH0gPSByZXBvc2l0b3J5QmluYXJ5W2Ake3JlcG9zaXRvcnlUeXBlfWBdO1xuICAgICAgY29uc3QgYm9keVZhbHVlID1cbiAgICAgICAgdmVyc2lvbiB8fCBgKCR7dGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoZ2V0dGV4dCgnbm90IHNwZWNpZmllZGB2ZXJzaW9uYCcpKX0pYDtcbiAgICAgIGNvbnN0IGJvZHlDbGFzcyA9IHZlcnNpb24gPyAnJyA6ICd0ZXh0LW11dGVkJztcbiAgICAgIHNlbGVjdE1vZGFsT3B0aW9ucy5wdXNoKHtcbiAgICAgICAgYm9keTogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHZhbHVlOiBib2R5VmFsdWUsXG4gICAgICAgICAgICBjbGFzczogYm9keUNsYXNzXG4gICAgICAgICAgfVxuICAgICAgICBdLFxuICAgICAgICBvYmo6IHtcbiAgICAgICAgICBpZDogcmVwb3NpdG9yeUJpbmFyeS5pZCxcbiAgICAgICAgICBuYW1lOiByZXBvc2l0b3J5RW50cnkubmFtZSxcbiAgICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAgIC4uLihnZXQocmVwb3NpdG9yeUJpbmFyeSwgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JykgJiYge1xuICAgICAgICAgICAgZGVwZW5kZW5jeTogZ2V0KHJlcG9zaXRvcnlCaW5hcnksICdjOHlfUGF0Y2guZGVwZW5kZW5jeScpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgLi4uKGdldChyZXBvc2l0b3J5QmluYXJ5LCAnYzh5X1BhdGNoJykgJiYgeyBpc1BhdGNoOiB0cnVlIH0pLFxuICAgICAgICAgIHVybDogcmVwb3NpdG9yeUJpbmFyeVtgJHtyZXBvc2l0b3J5VHlwZX1gXS51cmwsXG4gICAgICAgICAgc29mdHdhcmVUeXBlOiByZXBvc2l0b3J5RW50cnkuc29mdHdhcmVUeXBlXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdGVkOiBpc1NlbGVjdGVkXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gc2VsZWN0TW9kYWxPcHRpb25zO1xuICB9XG5cbiAgaXNCaW5hcnlSZXBvc2l0b3J5U2VsZWN0ZWQoXG4gICAgc2VsZWN0ZWRJdGVtczogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10sXG4gICAgcmVwb3NpdG9yeUVudHJ5OiBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgcmVwb3NpdG9yeUJpbmFyeTogUmVwb3NpdG9yeUJpbmFyeSxcbiAgICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGVcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaXNTZWxlY3RlZCA9IHNlbGVjdGVkSXRlbXNcbiAgICAgID8gc2VsZWN0ZWRJdGVtcy5maWx0ZXIoXG4gICAgICAgICAgcmVwb3NpdG9yeUZyYWdtZW50ID0+XG4gICAgICAgICAgICByZXBvc2l0b3J5RnJhZ21lbnQubmFtZSA9PT0gcmVwb3NpdG9yeUVudHJ5Lm5hbWUgJiZcbiAgICAgICAgICAgIHJlcG9zaXRvcnlGcmFnbWVudC52ZXJzaW9uID09PSByZXBvc2l0b3J5QmluYXJ5W2Ake3JlcG9zaXRvcnlUeXBlfWBdLnZlcnNpb25cbiAgICAgICAgKS5sZW5ndGggPiAwXG4gICAgICA6IGZhbHNlO1xuXG4gICAgcmV0dXJuIGlzU2VsZWN0ZWQ7XG4gIH1cblxuICBnZXRTZWxlY3RNb2RhbE9iamVjdChcbiAgICByZXBvc2l0b3J5RW50cnk6IFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgICBvcHRpb25zOiBJU2VsZWN0TW9kYWxPcHRpb25bXVxuICApOiBJU2VsZWN0TW9kYWxPYmplY3Qge1xuICAgIGNvbnN0IGxhYmVsID1cbiAgICAgIG9wdGlvbnMubGVuZ3RoID09PSAxXG4gICAgICAgID8gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQodGhpcy5iYWRnZVRlbXBsYXRlc1snPTEnXSwgeyBjb3VudDogb3B0aW9ucy5sZW5ndGggfSlcbiAgICAgICAgOiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudCh0aGlzLmJhZGdlVGVtcGxhdGVzLm90aGVyLCB7IGNvdW50OiBvcHRpb25zLmxlbmd0aCB9KTtcblxuICAgIGNvbnN0IHNlbGVjdE1vZGFsT2JqZWN0OiBJU2VsZWN0TW9kYWxPYmplY3QgPSB7XG4gICAgICBncm91cElkOiByZXBvc2l0b3J5RW50cnkuaWQsXG4gICAgICBib2R5OiBbXG4gICAgICAgIHsgdmFsdWU6IHJlcG9zaXRvcnlFbnRyeS5uYW1lLCBjbGFzczogJ3RleHQtdHJ1bmNhdGUnIH0sXG4gICAgICAgIHsgdmFsdWU6IHJlcG9zaXRvcnlFbnRyeS5kZXNjcmlwdGlvbiwgY2xhc3M6ICd0ZXh0LXRydW5jYXRlIHRleHQtbXV0ZWQnIH1cbiAgICAgIF0sXG4gICAgICBhZGRpdGlvbmFsSW5mb3JtYXRpb246IHsgdmFsdWU6IGxhYmVsLCBjbGFzczogJ2xhYmVsIGxhYmVsLWluZm8nIH0sXG4gICAgICBvcHRpb25zXG4gICAgfTtcblxuICAgIHJldHVybiBzZWxlY3RNb2RhbE9iamVjdDtcbiAgfVxufVxuIiwiPGM4eS1zZWxlY3QtbW9kYWxcbiAgW2ljb25dPVwiaWNvblwiXG4gIFt0aXRsZV09XCJ0aXRsZVwiXG4gIFtzdWJUaXRsZV09XCJzdWJUaXRsZVwiXG4gIFtpdGVtc109XCJtb2RhbEVudHJpZXMgfCBhc3luY1wiXG4gIFttb2RlXT1cIm1vZGVcIlxuICBbZGlzYWJsZVNlbGVjdGVkXT1cImRpc2FibGVTZWxlY3RlZFwiXG4gIFtsYWJlbHNdPVwibGFiZWxzXCJcbiAgW3Nob3dGaWx0ZXJdPVwic2hvd0ZpbHRlclwiXG4gIFthZGRpdGlvbmFsRmlsdGVyVGVtcGxhdGVdPVwiYWRkaXRpb25hbEZpbHRlclRlbXBsYXRlXCJcbiAgW2FyZU1vcmVFbnRyaWVzXT1cImFyZU1vcmVFbnRyaWVzXCJcbiAgW25vSXRlbXNNZXNzYWdlXT1cIm5vSXRlbXNNZXNzYWdlXCJcbiAgKHNlYXJjaCk9XCJzZWFyY2goeyBuYW1lOiAkZXZlbnQgfSlcIlxuICAob25DaG9pY2VVcGRhdGVkKT1cIm9uQ2hvaWNlVXBkYXRlZC5lbWl0KCRldmVudClcIlxuICAocmVzdWx0KT1cInJlc3VsdCgkZXZlbnQpXCJcbiAgYzh5UHJvZHVjdEV4cGVyaWVuY2VcbiAgaW5oZXJpdFxuICBzdXBwcmVzc0RhdGFPdmVycmlkaW5nXG4gIFthY3Rpb25EYXRhXT1cInsgY29tcG9uZW50OiBQUk9EVUNUX0VYUEVSSUVOQ0UuU0hBUkVELkNPTVBPTkVOVFMuUkVQT1NJVE9SWV9TRUxFQ1RfTU9EQUwgfVwiXG4+PC9jOHktc2VsZWN0LW1vZGFsPlxuIl19