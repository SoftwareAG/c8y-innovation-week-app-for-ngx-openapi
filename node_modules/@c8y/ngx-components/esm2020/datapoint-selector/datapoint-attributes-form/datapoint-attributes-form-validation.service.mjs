import { Injectable } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { C8yValidators } from '@c8y/ngx-components';
import { AXIS_TYPES, CHART_LINE_TYPES, CHART_RENDER_TYPES } from './datapoint-attributes.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
export class DatapointAttributesFormValidationService {
    constructor(formBuilder) {
        this.formBuilder = formBuilder;
    }
    getDefaultFormGroup(fieldsToRemove = []) {
        const formFields = {
            __active: [true, []],
            __target: this.getTargetFormGroup(),
            __template: [undefined, []],
            color: ['', this.getColorValidators()],
            label: ['', this.getLabelValidators()],
            description: ['', this.getDescriptionValidators()],
            fragment: ['', this.getFragmentValidators()],
            series: ['', this.getSeriesValidators()],
            range: this.getMinMaxFormGroup(),
            unit: [undefined, this.getUnitValidators()],
            target: [undefined, this.getTargetValidators()],
            redRange: this.getMinMaxFormGroup(),
            yellowRange: this.getMinMaxFormGroup(),
            chart: this.getChartFormGroup()
        };
        if (fieldsToRemove.length) {
            for (const field of fieldsToRemove) {
                delete formFields[field];
            }
        }
        return this.formBuilder.group(formFields, {
            validators: this.getOverallValidators()
        });
    }
    convertToBackendFormat(formDataStructure) {
        if (!formDataStructure) {
            return {};
        }
        const { __active, __target, __template, color, label, description, fragment, series, range, unit, target, redRange, yellowRange, chart } = formDataStructure;
        const obj = {
            __active,
            __target,
            __template,
            color,
            label,
            description,
            fragment,
            series,
            min: range?.min,
            max: range?.max,
            unit,
            target,
            redRangeMin: redRange?.min,
            redRangeMax: redRange?.max,
            yellowRangeMin: yellowRange?.min,
            yellowRangeMax: yellowRange?.max,
            renderType: chart?.renderType,
            lineType: chart?.lineType,
            yAxisType: chart?.yAxisType
        };
        return obj;
    }
    convertToFormGroupFormat(backendDataStructure) {
        if (!backendDataStructure) {
            return {};
        }
        const { __active, __target, __template, color, label, description, fragment, series, min, max, unit, target, redRangeMin, redRangeMax, yellowRangeMin, yellowRangeMax, renderType, lineType, yAxisType } = backendDataStructure;
        const obj = {
            __active,
            __target,
            __template,
            color,
            label,
            description,
            fragment,
            series,
            range: {
                min: this.convertStringToNumber(min),
                max: this.convertStringToNumber(max)
            },
            unit,
            target: this.convertStringToNumber(target),
            redRange: {
                min: this.convertStringToNumber(redRangeMin),
                max: this.convertStringToNumber(redRangeMax)
            },
            yellowRange: {
                min: this.convertStringToNumber(yellowRangeMin),
                max: this.convertStringToNumber(yellowRangeMax)
            },
            chart: renderType || lineType || yAxisType ? { renderType, lineType, yAxisType } : undefined
        };
        return obj;
    }
    getColorValidators() {
        return [Validators.required, Validators.minLength(4)];
    }
    getLabelValidators() {
        return [Validators.required, Validators.minLength(1), Validators.maxLength(120)];
    }
    getDescriptionValidators() {
        return [];
    }
    getFragmentValidators() {
        return [
            Validators.required,
            Validators.minLength(1),
            Validators.maxLength(120),
            Validators.pattern(/^[^.]*$/)
        ];
    }
    getSeriesValidators() {
        return [
            Validators.required,
            Validators.minLength(1),
            Validators.maxLength(120),
            Validators.pattern(/^[^.]*$/)
        ];
    }
    getMinMaxValidators() {
        return [C8yValidators.minMaxValidator(), C8yValidators.requireBothMinAndMax()];
    }
    getUnitValidators() {
        return [];
    }
    getTargetValidators() {
        return [];
    }
    getOverallValidators() {
        return [
            C8yValidators.withinScale('redRange.min'),
            C8yValidators.withinScale('redRange.max'),
            C8yValidators.withinScale('yellowRange.min'),
            C8yValidators.withinScale('yellowRange.max'),
            C8yValidators.withinScale('target')
        ];
    }
    getMinMaxFormGroup() {
        return this.formBuilder.group({ min: [undefined, []], max: [undefined, []] }, { validators: this.getMinMaxValidators() });
    }
    getChartFormGroup() {
        return this.formBuilder.group({
            renderType: [CHART_RENDER_TYPES[0].val, []],
            lineType: [CHART_LINE_TYPES[0].val, []],
            yAxisType: [AXIS_TYPES[0].val, []]
        });
    }
    getTargetFormGroup() {
        return this.formBuilder.group({
            id: [undefined, []],
            name: [undefined, []]
        });
    }
    convertStringToNumber(possibleString) {
        if (typeof possibleString === 'string') {
            try {
                return Number.parseFloat(possibleString);
            }
            catch {
                return undefined;
            }
        }
        else {
            return possibleString;
        }
    }
}
DatapointAttributesFormValidationService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DatapointAttributesFormValidationService, deps: [{ token: i1.FormBuilder }], target: i0.ɵɵFactoryTarget.Injectable });
DatapointAttributesFormValidationService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DatapointAttributesFormValidationService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DatapointAttributesFormValidationService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.FormBuilder }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXBvaW50LWF0dHJpYnV0ZXMtZm9ybS12YWxpZGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9kYXRhcG9pbnQtc2VsZWN0b3IvZGF0YXBvaW50LWF0dHJpYnV0ZXMtZm9ybS9kYXRhcG9pbnQtYXR0cmlidXRlcy1mb3JtLXZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQTBCLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sOEJBQThCLENBQUM7OztBQUdoRyxNQUFNLE9BQU8sd0NBQXdDO0lBQ25ELFlBQW9CLFdBQXdCO1FBQXhCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO0lBQUcsQ0FBQztJQUVoRCxtQkFBbUIsQ0FBQyxpQkFBMkIsRUFBRTtRQUMvQyxNQUFNLFVBQVUsR0FBRztZQUNqQixRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3BCLFFBQVEsRUFBRSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDbkMsVUFBVSxFQUFFLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQztZQUMzQixLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDdEMsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQ3RDLFdBQVcsRUFBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztZQUNsRCxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLHFC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QUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQztZQUN2QyxTQUFTLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQztTQUNuQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7WUFDNUIsRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQztZQUNuQixJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDO1NBQ3RCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxjQUErQjtRQUMzRCxJQUFJLE9BQU8sY0FBYyxLQUFLLFFBQVEsRUFBRTtZQUN0QyxJQUFJO2dCQUNGLE9BQU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUMxQztZQUFDLE1BQU07Z0JBQ04sT0FBTyxTQUFTLENBQUM7YUFDbEI7U0FDRjthQUFNO1lBQ0wsT0FBTyxjQUFjLENBQUM7U0FDdkI7SUFDSCxDQUFDOztxSUF0TlUsd0NBQXdDO3lJQUF4Qyx3Q0FBd0MsY0FEM0IsTUFBTTsyRkFDbkIsd0NBQXdDO2tCQURwRCxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1CdWlsZGVyLCBGb3JtR3JvdXAsIFZhbGlkYXRvckZuLCBWYWxpZGF0b3JzIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgQzh5VmFsaWRhdG9ycyB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgQVhJU19UWVBFUywgQ0hBUlRfTElORV9UWVBFUywgQ0hBUlRfUkVOREVSX1RZUEVTIH0gZnJvbSAnLi9kYXRhcG9pbnQtYXR0cmlidXRlcy5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRGF0YXBvaW50QXR0cmlidXRlc0Zvcm1WYWxpZGF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZm9ybUJ1aWxkZXI6IEZvcm1CdWlsZGVyKSB7fVxuXG4gIGdldERlZmF1bHRGb3JtR3JvdXAoZmllbGRzVG9SZW1vdmU6IHN0cmluZ1tdID0gW10pOiBGb3JtR3JvdXAge1xuICAgIGNvbnN0IGZvcm1GaWVsZHMgPSB7XG4gICAgICBfX2FjdGl2ZTogW3RydWUsIFtdXSxcbiAgICAgIF9fdGFyZ2V0OiB0aGlzLmdldFRhcmdldEZvcm1Hcm91cCgpLFxuICAgICAgX190ZW1wbGF0ZTogW3VuZGVmaW5lZCwgW11dLFxuICAgICAgY29sb3I6IFsnJywgdGhpcy5nZXRDb2xvclZhbGlkYXRvcnMoKV0sXG4gICAgICBsYWJlbDogWycnLCB0aGlzLmdldExhYmVsVmFsaWRhdG9ycygpXSxcbiAgICAgIGRlc2NyaXB0aW9uOiBbJycsIHRoaXMuZ2V0RGVzY3JpcHRpb25WYWxpZGF0b3JzKCldLFxuICAgICAgZnJhZ21lbnQ6IFsnJywgdGhpcy5nZXRGcmFnbWVudFZhbGlkYXRvcnMoKV0sXG4gICAgICBzZXJpZXM6IFsnJywgdGhpcy5nZXRTZXJpZXNWYWxpZGF0b3JzKCldLFxuICAgICAgcmFuZ2U6IHRoaXMuZ2V0TWluTWF4Rm9ybUdyb3VwKCksXG4gICAgICB1bml0OiBbdW5kZWZpbmVkLCB0aGlzLmdldFVuaXRWYWxpZGF0b3JzKCldLFxuICAgICAgdGFyZ2V0OiBbdW5kZWZpbmVkLCB0aGlzLmdldFRhcmdldFZhbGlkYXRvcnMoKV0sXG4gICAgICByZWRSYW5nZTogdGhpcy5nZXRNaW5NYXhGb3JtR3JvdXAoKSxcbiAgICAgIHllbGxvd1JhbmdlOiB0aGlzLmdldE1pbk1heEZvcm1Hcm91cCgpLFxuICAgICAgY2hhcnQ6IHRoaXMuZ2V0Q2hhcnRGb3JtR3JvdXAoKVxuICAgIH07XG4gICAgaWYgKGZpZWxkc1RvUmVtb3ZlLmxlbmd0aCkge1xuICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHNUb1JlbW92ZSkge1xuICAgICAgICBkZWxldGUgZm9ybUZpZWxkc1tmaWVsZF07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKGZvcm1GaWVsZHMsIHtcbiAgICAgIHZhbGlkYXRvcnM6IHRoaXMuZ2V0T3ZlcmFsbFZhbGlkYXRvcnMoKVxuICAgIH0pO1xuICB9XG5cbiAgY29udmVydFRvQmFja2VuZEZvcm1hdChmb3JtRGF0YVN0cnVjdHVyZTogYW55KSB7XG4gICAgaWYgKCFmb3JtRGF0YVN0cnVjdHVyZSkge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIF9fYWN0aXZlLFxuICAgICAgX190YXJnZXQsXG4gICAgICBfX3RlbXBsYXRlLFxuICAgICAgY29sb3IsXG4gICAgICBsYWJlbCxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgZnJhZ21lbnQsXG4gICAgICBzZXJpZXMsXG4gICAgICByYW5nZSxcbiAgICAgIHVuaXQsXG4gICAgICB0YXJnZXQsXG4gICAgICByZWRSYW5nZSxcbiAgICAgIHllbGxvd1JhbmdlLFxuICAgICAgY2hhcnRcbiAgICB9ID0gZm9ybURhdGFTdHJ1Y3R1cmU7XG4gICAgY29uc3Qgb2JqID0ge1xuICAgICAgX19hY3RpdmUsXG4gICAgICBfX3RhcmdldCxcbiAgICAgIF9fdGVtcGxhdGUsXG4gICAgICBjb2xvcixcbiAgICAgIGxhYmVsLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBmcmFnbWVudCxcbiAgICAgIHNlcmllcyxcbiAgICAgIG1pbjogcmFuZ2U/Lm1pbixcbiAgICAgIG1heDogcmFuZ2U/Lm1heCxcbiAgICAgIHVuaXQsXG4gICAgICB0YXJnZXQsXG4gICAgICByZWRSYW5nZU1pbjogcmVkUmFuZ2U/Lm1pbixcbiAgICAgIHJlZFJhbmdlTWF4OiByZWRSYW5nZT8ubWF4LFxuICAgICAgeWVsbG93UmFuZ2VNaW46IHllbGxvd1JhbmdlPy5taW4sXG4gICAgICB5ZWxsb3dSYW5nZU1heDogeWVsbG93UmFuZ2U/Lm1heCxcbiAgICAgIHJlbmRlclR5cGU6IGNoYXJ0Py5yZW5kZXJUeXBlLFxuICAgICAgbGluZVR5cGU6IGNoYXJ0Py5saW5lVHlwZSxcbiAgICAgIHlBeGlzVHlwZTogY2hhcnQ/LnlBeGlzVHlwZVxuICAgIH07XG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIGNvbnZlcnRUb0Zvcm1Hcm91cEZvcm1hdChiYWNrZW5kRGF0YVN0cnVjdHVyZTogYW55KSB7XG4gICAgaWYgKCFiYWNrZW5kRGF0YVN0cnVjdHVyZSkge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIF9fYWN0aXZlLFxuICAgICAgX190YXJnZXQsXG4gICAgICBfX3RlbXBsYXRlLFxuICAgICAgY29sb3IsXG4gICAgICBsYWJlbCxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgZnJhZ21lbnQsXG4gICAgICBzZXJpZXMsXG4gICAgICBtaW4sXG4gICAgICBtYXgsXG4gICAgICB1bml0LFxuICAgICAgdGFyZ2V0LFxuICAgICAgcmVkUmFuZ2VNaW4sXG4gICAgICByZWRSYW5nZU1heCxcbiAgICAgIHllbGxvd1JhbmdlTWluLFxuICAgICAgeWVsbG93UmFuZ2VNYXgsXG4gICAgICByZW5kZXJUeXBlLFxuICAgICAgbGluZVR5cGUsXG4gICAgICB5QXhpc1R5cGVcbiAgICB9ID0gYmFja2VuZERhdGFTdHJ1Y3R1cmU7XG5cbiAgICBjb25zdCBvYmogPSB7XG4gICAgICBfX2FjdGl2ZSxcbiAgICAgIF9fdGFyZ2V0LFxuICAgICAgX190ZW1wbGF0ZSxcbiAgICAgIGNvbG9yLFxuICAgICAgbGFiZWwsXG4gICAgICBkZXNjcmlwdGlvbixcbiAgICAgIGZyYWdtZW50LFxuICAgICAgc2VyaWVzLFxuICAgICAgcmFuZ2U6IHtcbiAgICAgICAgbWluOiB0aGlzLmNvbnZlcnRTdHJpbmdUb051bWJlcihtaW4pLFxuICAgICAgICBtYXg6IHRoaXMuY29udmVydFN0cmluZ1RvTnVtYmVyKG1heClcbiAgICAgIH0sXG4gICAgICB1bml0LFxuICAgICAgdGFyZ2V0OiB0aGlzLmNvbnZlcnRTdHJpbmdUb051bWJlcih0YXJnZXQpLFxuICAgICAgcmVkUmFuZ2U6IHtcbiAgICAgICAgbWluOiB0aGlzLmNvbnZlcnRTdHJpbmdUb051bWJlcihyZWRSYW5nZU1pbiksXG4gICAgICAgIG1heDogdGhpcy5jb252ZXJ0U3RyaW5nVG9OdW1iZXIocmVkUmFuZ2VNYXgpXG4gICAgICB9LFxuICAgICAgeWVsbG93UmFuZ2U6IHtcbiAgICAgICAgbWluOiB0aGlzLmNvbnZlcnRTdHJpbmdUb051bWJlcih5ZWxsb3dSYW5nZU1pbiksXG4gICAgICAgIG1heDogdGhpcy5jb252ZXJ0U3RyaW5nVG9OdW1iZXIoeWVsbG93UmFuZ2VNYXgpXG4gICAgICB9LFxuICAgICAgY2hhcnQ6IHJlbmRlclR5cGUgfHwgbGluZVR5cGUgfHwgeUF4aXNUeXBlID8geyByZW5kZXJUeXBlLCBsaW5lVHlwZSwgeUF4aXNUeXBlIH0gOiB1bmRlZmluZWRcbiAgICB9O1xuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICBnZXRDb2xvclZhbGlkYXRvcnMoKTogVmFsaWRhdG9yRm5bXSB7XG4gICAgcmV0dXJuIFtWYWxpZGF0b3JzLnJlcXVpcmVkLCBWYWxpZGF0b3JzLm1pbkxlbmd0aCg0KV07XG4gIH1cblxuICBnZXRMYWJlbFZhbGlkYXRvcnMoKTogVmFsaWRhdG9yRm5bXSB7XG4gICAgcmV0dXJuIFtWYWxpZGF0b3JzLnJlcXVpcmVkLCBWYWxpZGF0b3JzLm1pbkxlbmd0aCgxKSwgVmFsaWRhdG9ycy5tYXhMZW5ndGgoMTIwKV07XG4gIH1cblxuICBnZXREZXNjcmlwdGlvblZhbGlkYXRvcnMoKTogVmFsaWRhdG9yRm5bXSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0RnJhZ21lbnRWYWxpZGF0b3JzKCk6IFZhbGlkYXRvckZuW10ge1xuICAgIHJldHVybiBbXG4gICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgVmFsaWRhdG9ycy5taW5MZW5ndGgoMSksXG4gICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCgxMjApLFxuICAgICAgVmFsaWRhdG9ycy5wYXR0ZXJuKC9eW14uXSokLylcbiAgICBdO1xuICB9XG5cbiAgZ2V0U2VyaWVzVmFsaWRhdG9ycygpOiBWYWxpZGF0b3JGbltdIHtcbiAgICByZXR1cm4gW1xuICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgIFZhbGlkYXRvcnMubWluTGVuZ3RoKDEpLFxuICAgICAgVmFsaWRhdG9ycy5tYXhMZW5ndGgoMTIwKSxcbiAgICAgIFZhbGlkYXRvcnMucGF0dGVybigvXlteLl0qJC8pXG4gICAgXTtcbiAgfVxuXG4gIGdldE1pbk1heFZhbGlkYXRvcnMoKTogVmFsaWRhdG9yRm5bXSB7XG4gICAgcmV0dXJuIFtDOHlWYWxpZGF0b3JzLm1pbk1heFZhbGlkYXRvcigpLCBDOHlWYWxpZGF0b3JzLnJlcXVpcmVCb3RoTWluQW5kTWF4KCldO1xuICB9XG5cbiAgZ2V0VW5pdFZhbGlkYXRvcnMoKTogVmFsaWRhdG9yRm5bXSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0VGFyZ2V0VmFsaWRhdG9ycygpOiBWYWxpZGF0b3JGbltdIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBnZXRPdmVyYWxsVmFsaWRhdG9ycygpOiBWYWxpZGF0b3JGbltdIHtcbiAgICByZXR1cm4gW1xuICAgICAgQzh5VmFsaWRhdG9ycy53aXRoaW5TY2FsZSgncmVkUmFuZ2UubWluJyksXG4gICAgICBDOHlWYWxpZGF0b3JzLndpdGhpblNjYWxlKCdyZWRSYW5nZS5tYXgnKSxcbiAgICAgIEM4eVZhbGlkYXRvcnMud2l0aGluU2NhbGUoJ3llbGxvd1JhbmdlLm1pbicpLFxuICAgICAgQzh5VmFsaWRhdG9ycy53aXRoaW5TY2FsZSgneWVsbG93UmFuZ2UubWF4JyksXG4gICAgICBDOHlWYWxpZGF0b3JzLndpdGhpblNjYWxlKCd0YXJnZXQnKVxuICAgIF07XG4gIH1cblxuICBnZXRNaW5NYXhGb3JtR3JvdXAoKTogRm9ybUdyb3VwIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtQnVpbGRlci5ncm91cChcbiAgICAgIHsgbWluOiBbdW5kZWZpbmVkLCBbXV0sIG1heDogW3VuZGVmaW5lZCwgW11dIH0sXG4gICAgICB7IHZhbGlkYXRvcnM6IHRoaXMuZ2V0TWluTWF4VmFsaWRhdG9ycygpIH1cbiAgICApO1xuICB9XG5cbiAgZ2V0Q2hhcnRGb3JtR3JvdXAoKTogRm9ybUdyb3VwIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtQnVpbGRlci5ncm91cCh7XG4gICAgICByZW5kZXJUeXBlOiBbQ0hBUlRfUkVOREVSX1RZUEVTWzBdLnZhbCwgW11dLFxuICAgICAgbGluZVR5cGU6IFtDSEFSVF9MSU5FX1RZUEVTWzBdLnZhbCwgW11dLFxuICAgICAgeUF4aXNUeXBlOiBbQVhJU19UWVBFU1swXS52YWwsIFtdXVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0VGFyZ2V0Rm9ybUdyb3VwKCk6IEZvcm1Hcm91cCB7XG4gICAgcmV0dXJuIHRoaXMuZm9ybUJ1aWxkZXIuZ3JvdXAoe1xuICAgICAgaWQ6IFt1bmRlZmluZWQsIFtdXSxcbiAgICAgIG5hbWU6IFt1bmRlZmluZWQsIFtdXVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0U3RyaW5nVG9OdW1iZXIocG9zc2libGVTdHJpbmc6IHN0cmluZyB8IG51bWJlcik6IG51bWJlciB7XG4gICAgaWYgKHR5cGVvZiBwb3NzaWJsZVN0cmluZyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBOdW1iZXIucGFyc2VGbG9hdChwb3NzaWJsZVN0cmluZyk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHBvc3NpYmxlU3RyaW5nO1xuICAgIH1cbiAgfVxufVxuIl19