import { Component, Output, EventEmitter } from '@angular/core';
import { AddressSpaceService } from './address-space.service';
import { gettext } from '@c8y/ngx-components';
import { OpcuaService } from './opcuaService';
import * as i0 from "@angular/core";
import * as i1 from "./address-space.service";
import * as i2 from "./opcuaService";
import * as i3 from "@c8y/ngx-components";
import * as i4 from "@angular/common";
import * as i5 from "@angular/forms";
import * as i6 from "./opcua-address-space-tree.component";
import * as i7 from "./opcua-address-space-detail.component";
export class OpcuaAddressSpaceComponent {
    constructor(addressSpaceService, opcuaService) {
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.selectednode = false;
        this.loading = false;
        this.searchInProgress = false;
        this.focusStatus = new EventEmitter();
        this.moId = '';
    }
    async ngOnInit() {
        this.filterLabel = gettext('Filter…');
        this.moId = this.opcuaService.getMoId();
    }
    ngOnDestroy() {
        // The BehaviourSubject will store the last array of ancestorNodes from the previous search
        // this would cause the component while subscribing in the init-phase to the subject to travers
        // to the last searched node again. From user perspective it does not make sense, because the user
        // left the Address space (tab) and should loose the context and just request a new search or
        // browse the tree manually.
        this.addressSpaceService.resetTreeToRootNode();
    }
    async searchNodes() {
        this.searchInProgress = true;
        this.clearNodeListAndCheckSearchString();
        if (this.isSearch) {
            this.currentNode = undefined;
            this.nodeList = await this.addressSpaceService.getSearchedNodes(this.searchKey, this.moId);
            this.searchInProgress = false;
            this.nodeList.resultLabel = gettext('Results found');
        }
    }
    clearNodeListAndCheckSearchString() {
        this.isSearch = this.searchKey !== undefined && this.searchKey !== '' ? true : false;
        if (!this.isSearch) {
            this.searchInProgress = false;
        }
    }
    clearSearch() {
        this.isSearch = false;
        this.searchKey = '';
        this.currentNode = undefined;
    }
    getIcon(nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    }
    async selectNode(node) {
        if (node && node.nodeId && node.nodeId.length > 0) {
            const res = await this.addressSpaceService.getNodeById(this.moId, node.nodeId);
            this.toggleCurrentNode((await res.json()));
        }
    }
    toggleCurrentNode(node) {
        this.currentNode = this.isNodeSet(node) ? undefined : node;
    }
    backHandler(node) {
        this.isSearch = false;
        this.focusStatus.emit(node);
        this.toggleCurrentNode(node);
    }
    isNodeSet(node) {
        if (this.currentNode !== undefined && this.currentNode.nodeId === node.nodeId) {
            return true;
        }
        return false;
    }
}
OpcuaAddressSpaceComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: OpcuaAddressSpaceComponent, deps: [{ token: i1.AddressSpaceService }, { token: i2.OpcuaService }], target: i0.ɵɵFactoryTarget.Component });
OpcuaAddressSpaceComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: OpcuaAddressSpaceComponent, selector: "opcua-address-space", outputs: { focusStatus: "focusStatus" }, ngImport: i0, template: "<div class=\"row split-scroll\">\n  <div class=\"col-md-5 col-xs-12 scroll-column no-gutter-r\">\n    <div class=\"card bg-level-2 split-scroll flex-scroll\">\n      <div class=\"card-block separator-bottom\">\n        <div class=\"input-group input-group-search\" style=\"margin: -8px 0\">\n          <input\n            class=\"form-control\"\n            type=\"search\"\n            placeholder=\"{{ filterLabel | translate }}\"\n            (keydown.enter)=\"searchNodes()\"\n            [(ngModel)]=\"searchKey\"\n          />\n          <span class=\"input-group-btn\">\n            <button\n              *ngIf=\"!isSearch\"\n              title=\"{{ 'Search' | translate }}\"\n              type=\"submit\"\n              class=\"btn btn-dot\"\n              (click)=\"searchNodes()\"\n            >\n              <i c8yIcon=\"search\"></i>\n            </button>\n            <button\n              *ngIf=\"isSearch\"\n              class=\"btn btn-dot\"\n              title=\"{{ 'Clear`input`' | translate }}\"\n              type=\"button\"\n              (click)=\"clearSearch()\"\n            >\n              <i c8yIcon=\"times\"></i>\n            </button>\n          </span>\n        </div>\n        <div *ngIf=\"isSearch && !loading\" class=\"p-t-16\">\n          <p *ngIf=\"!searchInProgress\">\n            <em>{{ nodeList.resultLabel | translate }}</em>\n            &nbsp;\n            <span class=\"badge badge-info\">{{ nodeList?.length }}</span>\n          </p>\n        </div>\n      </div>\n\n      <div class=\"p-t-8\" *ngIf=\"(isSearch && loading) || searchInProgress\">\n        <c8y-loading></c8y-loading>\n      </div>\n\n      <div class=\"flex-content-scroll\" *ngIf=\"isSearch && !loading && !searchInProgress\">\n        <div class=\"list-group list-group-links\" *ngIf=\"isSearch && !loading\">\n          <button\n            *ngFor=\"let nodeItem of nodeList\"\n            (click)=\"selectNode(nodeItem)\"\n            [ngClass]=\"{ 'list-group-item d-flex': true }\"\n          >\n            <div class=\"list-group-icon m-r-4\">\n              <i class=\"m-r-4\" [c8yIcon]=\"getIcon(nodeItem.nodeClassName)\"></i>\n            </div>\n            <div class=\"list-item-body text-truncate\">\n              <span tile=\"nodeId\">{{ nodeItem.nodeId }}</span>\n              {{ nodeItem.displayName }}\n            </div>\n          </button>\n        </div>\n      </div>\n      <div class=\"flex-content-scroll\" *ngIf=\"!isSearch\">\n        <opcua-address-space-tree\n          (selectedNode)=\"toggleCurrentNode($event)\"\n          [focusEmitter]=\"focusStatus\"\n        ></opcua-address-space-tree>\n      </div>\n    </div>\n  </div>\n  <opcua-address-space-detail\n    [node]=\"currentNode\"\n    class=\"col-md-7 col-xs-12 scroll-column no-gutter-l\"\n    style=\"pointer-events: none\"\n    (toggleAttrDetail)=\"backHandler($event)\"\n  ></opcua-address-space-detail>\n</div>\n", dependencies: [{ kind: "directive", type: i3.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i4.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i3.LoadingComponent, selector: "c8y-loading" }, { kind: "directive", type: i5.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i5.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i5.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "component", type: i6.OpcuaAddressSpaceTreeComponent, selector: "opcua-address-space-tree", inputs: ["moId", "node", "focusEmitter"], outputs: ["selectedNode"] }, { kind: "component", type: i7.OpcuaAddressSpaceDetailComponent, selector: "opcua-address-space-detail", inputs: ["node"], outputs: ["toggleAttrDetail"] }, { kind: "pipe", type: i3.C8yTranslatePipe, name: "translate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: OpcuaAddressSpaceComponent, decorators: [{
            type: Component,
            args: [{ selector: 'opcua-address-space', template: "<div class=\"row split-scroll\">\n  <div class=\"col-md-5 col-xs-12 scroll-column no-gutter-r\">\n    <div class=\"card bg-level-2 split-scroll flex-scroll\">\n      <div class=\"card-block separator-bottom\">\n        <div class=\"input-group input-group-search\" style=\"margin: -8px 0\">\n          <input\n            class=\"form-control\"\n            type=\"search\"\n            placeholder=\"{{ filterLabel | translate }}\"\n            (keydown.enter)=\"searchNodes()\"\n            [(ngModel)]=\"searchKey\"\n          />\n          <span class=\"input-group-btn\">\n            <button\n              *ngIf=\"!isSearch\"\n              title=\"{{ 'Search' | translate }}\"\n              type=\"submit\"\n              class=\"btn btn-dot\"\n              (click)=\"searchNodes()\"\n            >\n              <i c8yIcon=\"search\"></i>\n            </button>\n            <button\n              *ngIf=\"isSearch\"\n              class=\"btn btn-dot\"\n              title=\"{{ 'Clear`input`' | translate }}\"\n              type=\"button\"\n              (click)=\"clearSearch()\"\n            >\n              <i c8yIcon=\"times\"></i>\n            </button>\n          </span>\n        </div>\n        <div *ngIf=\"isSearch && !loading\" class=\"p-t-16\">\n          <p *ngIf=\"!searchInProgress\">\n            <em>{{ nodeList.resultLabel | translate }}</em>\n            &nbsp;\n            <span class=\"badge badge-info\">{{ nodeList?.length }}</span>\n          </p>\n        </div>\n      </div>\n\n      <div class=\"p-t-8\" *ngIf=\"(isSearch && loading) || searchInProgress\">\n        <c8y-loading></c8y-loading>\n      </div>\n\n      <div class=\"flex-content-scroll\" *ngIf=\"isSearch && !loading && !searchInProgress\">\n        <div class=\"list-group list-group-links\" *ngIf=\"isSearch && !loading\">\n          <button\n            *ngFor=\"let nodeItem of nodeList\"\n            (click)=\"selectNode(nodeItem)\"\n            [ngClass]=\"{ 'list-group-item d-flex': true }\"\n          >\n            <div class=\"list-group-icon m-r-4\">\n              <i class=\"m-r-4\" [c8yIcon]=\"getIcon(nodeItem.nodeClassName)\"></i>\n            </div>\n            <div class=\"list-item-body text-truncate\">\n              <span tile=\"nodeId\">{{ nodeItem.nodeId }}</span>\n              {{ nodeItem.displayName }}\n            </div>\n          </button>\n        </div>\n      </div>\n      <div class=\"flex-content-scroll\" *ngIf=\"!isSearch\">\n        <opcua-address-space-tree\n          (selectedNode)=\"toggleCurrentNode($event)\"\n          [focusEmitter]=\"focusStatus\"\n        ></opcua-address-space-tree>\n      </div>\n    </div>\n  </div>\n  <opcua-address-space-detail\n    [node]=\"currentNode\"\n    class=\"col-md-7 col-xs-12 scroll-column no-gutter-l\"\n    style=\"pointer-events: none\"\n    (toggleAttrDetail)=\"backHandler($event)\"\n  ></opcua-address-space-detail>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.AddressSpaceService }, { type: i2.OpcuaService }]; }, propDecorators: { focusStatus: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm90b2NvbC1vcGN1YS9vcGN1YS1hZGRyZXNzLXNwYWNlLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uL3Byb3RvY29sLW9wY3VhL29wY3VhLWFkZHJlc3Mtc3BhY2UuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLEVBQUUsWUFBWSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxtQkFBbUIsRUFBb0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7QUFNOUMsTUFBTSxPQUFPLDBCQUEwQjtJQWFyQyxZQUNVLG1CQUF3QyxFQUN4QyxZQUEwQjtRQUQxQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBYnBDLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBR3JCLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBS2YsZ0JBQVcsR0FBbUMsSUFBSSxZQUFZLEVBQW9CLENBQUM7UUFDckYsU0FBSSxHQUFHLEVBQUUsQ0FBQztJQUlmLENBQUM7SUFFSixLQUFLLENBQUMsUUFBUTtRQUNaLElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBRUQsV0FBVztRQUNULDJGQUEyRjtRQUMzRiwrRkFBK0Y7UUFDL0Ysa0dBQWtHO1FBQ2xHLDZGQUE2RjtRQUM3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b25lbnQsIE9uSW5pdCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWRkcmVzc1NwYWNlU2VydmljZSwgQWRkcmVzc1NwYWNlTm9kZSB9IGZyb20gJy4vYWRkcmVzcy1zcGFjZS5zZXJ2aWNlJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IER5bmFtaWNEYXRhU291cmNlIH0gZnJvbSAnLi9keW5hbWljLWRhdGEtc291cmNlJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnb3BjdWEtYWRkcmVzcy1zcGFjZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1hZGRyZXNzLXNwYWNlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YUFkZHJlc3NTcGFjZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgY3VycmVudE5vZGU6IEFkZHJlc3NTcGFjZU5vZGU7XG4gIHNlbGVjdGVkbm9kZSA9IGZhbHNlO1xuICBzZWFyY2hLZXk6IHN0cmluZztcbiAgaXNTZWFyY2g6IGJvb2xlYW47XG4gIGxvYWRpbmcgPSBmYWxzZTtcbiAgc2VhcmNoSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICBmaWx0ZXJMYWJlbDogc3RyaW5nO1xuICBkYXRhU291cmNlOiBEeW5hbWljRGF0YVNvdXJjZTtcbiAgbm9kZUxpc3Q7XG5cbiAgQE91dHB1dCgpIGZvY3VzU3RhdHVzOiBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+KCk7XG4gIHByaXZhdGUgbW9JZCA9ICcnO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFkZHJlc3NTcGFjZVNlcnZpY2U6IEFkZHJlc3NTcGFjZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGN1YVNlcnZpY2U6IE9wY3VhU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5maWx0ZXJMYWJlbCA9IGdldHRleHQoJ0ZpbHRlcuKApicpO1xuICAgIHRoaXMubW9JZCA9IHRoaXMub3BjdWFTZXJ2aWNlLmdldE1vSWQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIC8vIFRoZSBCZWhhdmlvdXJTdWJqZWN0IHdpbGwgc3RvcmUgdGhlIGxhc3QgYXJyYXkgb2YgYW5jZXN0b3JOb2RlcyBmcm9tIHRoZSBwcmV2aW91cyBzZWFyY2hcbiAgICAvLyB0aGlzIHdvdWxkIGNhdXNlIHRoZSBjb21wb25lbnQgd2hpbGUgc3Vic2NyaWJpbmcgaW4gdGhlIGluaXQtcGhhc2UgdG8gdGhlIHN1YmplY3QgdG8gdHJhdmVyc1xuICAgIC8vIHRvIHRoZSBsYXN0IHNlYXJjaGVkIG5vZGUgYWdhaW4uIEZyb20gdXNlciBwZXJzcGVjdGl2ZSBpdCBkb2VzIG5vdCBtYWtlIHNlbnNlLCBiZWNhdXNlIHRoZSB1c2VyXG4gICAgLy8gbGVmdCB0aGUgQWRkcmVzcyBzcGFjZSAodGFiKSBhbmQgc2hvdWxkIGxvb3NlIHRoZSBjb250ZXh0IGFuZCBqdXN0IHJlcXVlc3QgYSBuZXcgc2VhcmNoIG9yXG4gICAgLy8gYnJvd3NlIHRoZSB0cmVlIG1hbnVhbGx5LlxuICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5yZXNldFRyZWVUb1Jvb3ROb2RlKCk7XG4gIH1cblxuICBhc3luYyBzZWFyY2hOb2RlcygpIHtcbiAgICB0aGlzLnNlYXJjaEluUHJvZ3Jlc3MgPSB0cnVlO1xuICAgIHRoaXMuY2xlYXJOb2RlTGlzdEFuZENoZWNrU2VhcmNoU3RyaW5nKCk7XG4gICAgaWYgKHRoaXMuaXNTZWFyY2gpIHtcbiAgICAgIHRoaXMuY3VycmVudE5vZGUgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLm5vZGVMaXN0ID0gYXdhaXQgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmdldFNlYXJjaGVkTm9kZXModGhpcy5zZWFyY2hLZXksIHRoaXMubW9JZCk7XG4gICAgICB0aGlzLnNlYXJjaEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgIHRoaXMubm9kZUxpc3QucmVzdWx0TGFiZWwgPSBnZXR0ZXh0KCdSZXN1bHRzIGZvdW5kJyk7XG4gICAgfVxuICB9XG5cbiAgY2xlYXJOb2RlTGlzdEFuZENoZWNrU2VhcmNoU3RyaW5nKCkge1xuICAgIHRoaXMuaXNTZWFyY2ggPSB0aGlzLnNlYXJjaEtleSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuc2VhcmNoS2V5ICE9PSAnJyA/IHRydWUgOiBmYWxzZTtcbiAgICBpZiAoIXRoaXMuaXNTZWFyY2gpIHtcbiAgICAgIHRoaXMuc2VhcmNoSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFyU2VhcmNoKCkge1xuICAgIHRoaXMuaXNTZWFyY2ggPSBmYWxzZTtcbiAgICB0aGlzLnNlYXJjaEtleSA9ICcnO1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBnZXRJY29uKG5vZGVDbGFzc05hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0SWNvbihub2RlQ2xhc3NOYW1lKTtcbiAgfVxuXG4gIGFzeW5jIHNlbGVjdE5vZGUobm9kZSkge1xuICAgIGlmIChub2RlICYmIG5vZGUubm9kZUlkICYmIG5vZGUubm9kZUlkLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5nZXROb2RlQnlJZCh0aGlzLm1vSWQsIG5vZGUubm9kZUlkKTtcbiAgICAgIHRoaXMudG9nZ2xlQ3VycmVudE5vZGUoKGF3YWl0IHJlcy5qc29uKCkpIGFzIEFkZHJlc3NTcGFjZU5vZGUpO1xuICAgIH1cbiAgfVxuXG4gIHRvZ2dsZUN1cnJlbnROb2RlKG5vZGU6IEFkZHJlc3NTcGFjZU5vZGUpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gdGhpcy5pc05vZGVTZXQobm9kZSkgPyB1bmRlZmluZWQgOiBub2RlO1xuICB9XG5cbiAgYmFja0hhbmRsZXIobm9kZSkge1xuICAgIHRoaXMuaXNTZWFyY2ggPSBmYWxzZTtcbiAgICB0aGlzLmZvY3VzU3RhdHVzLmVtaXQobm9kZSk7XG4gICAgdGhpcy50b2dnbGVDdXJyZW50Tm9kZShub2RlKTtcbiAgfVxuXG4gIGlzTm9kZVNldChub2RlOiBBZGRyZXNzU3BhY2VOb2RlKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudE5vZGUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmN1cnJlbnROb2RlLm5vZGVJZCA9PT0gbm9kZS5ub2RlSWQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJyb3cgc3BsaXQtc2Nyb2xsXCI+XG4gIDxkaXYgY2xhc3M9XCJjb2wtbWQtNSBjb2wteHMtMTIgc2Nyb2xsLWNvbHVtbiBuby1ndXR0ZXItclwiPlxuICAgIDxkaXYgY2xhc3M9XCJjYXJkIGJnLWxldmVsLTIgc3BsaXQtc2Nyb2xsIGZsZXgtc2Nyb2xsXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiY2FyZC1ibG9jayBzZXBhcmF0b3ItYm90dG9tXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJpbnB1dC1ncm91cCBpbnB1dC1ncm91cC1zZWFyY2hcIiBzdHlsZT1cIm1hcmdpbjogLThweCAwXCI+XG4gICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICBjbGFzcz1cImZvcm0tY29udHJvbFwiXG4gICAgICAgICAgICB0eXBlPVwic2VhcmNoXCJcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwie3sgZmlsdGVyTGFiZWwgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgKGtleWRvd24uZW50ZXIpPVwic2VhcmNoTm9kZXMoKVwiXG4gICAgICAgICAgICBbKG5nTW9kZWwpXT1cInNlYXJjaEtleVwiXG4gICAgICAgICAgLz5cbiAgICAgICAgICA8c3BhbiBjbGFzcz1cImlucHV0LWdyb3VwLWJ0blwiPlxuICAgICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgICAqbmdJZj1cIiFpc1NlYXJjaFwiXG4gICAgICAgICAgICAgIHRpdGxlPVwie3sgJ1NlYXJjaCcgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgICB0eXBlPVwic3VibWl0XCJcbiAgICAgICAgICAgICAgY2xhc3M9XCJidG4gYnRuLWRvdFwiXG4gICAgICAgICAgICAgIChjbGljayk9XCJzZWFyY2hOb2RlcygpXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgPGkgYzh5SWNvbj1cInNlYXJjaFwiPjwvaT5cbiAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgICAqbmdJZj1cImlzU2VhcmNoXCJcbiAgICAgICAgICAgICAgY2xhc3M9XCJidG4gYnRuLWRvdFwiXG4gICAgICAgICAgICAgIHRpdGxlPVwie3sgJ0NsZWFyYGlucHV0YCcgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgICAgKGNsaWNrKT1cImNsZWFyU2VhcmNoKClcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8aSBjOHlJY29uPVwidGltZXNcIj48L2k+XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2ICpuZ0lmPVwiaXNTZWFyY2ggJiYgIWxvYWRpbmdcIiBjbGFzcz1cInAtdC0xNlwiPlxuICAgICAgICAgIDxwICpuZ0lmPVwiIXNlYXJjaEluUHJvZ3Jlc3NcIj5cbiAgICAgICAgICAgIDxlbT57eyBub2RlTGlzdC5yZXN1bHRMYWJlbCB8IHRyYW5zbGF0ZSB9fTwvZW0+XG4gICAgICAgICAgICAmbmJzcDtcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwiYmFkZ2UgYmFkZ2UtaW5mb1wiPnt7IG5vZGVMaXN0Py5sZW5ndGggfX08L3NwYW4+XG4gICAgICAgICAgPC9wPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2IGNsYXNzPVwicC10LThcIiAqbmdJZj1cIihpc1NlYXJjaCAmJiBsb2FkaW5nKSB8fCBzZWFyY2hJblByb2dyZXNzXCI+XG4gICAgICAgIDxjOHktbG9hZGluZz48L2M4eS1sb2FkaW5nPlxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxkaXYgY2xhc3M9XCJmbGV4LWNvbnRlbnQtc2Nyb2xsXCIgKm5nSWY9XCJpc1NlYXJjaCAmJiAhbG9hZGluZyAmJiAhc2VhcmNoSW5Qcm9ncmVzc1wiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwibGlzdC1ncm91cCBsaXN0LWdyb3VwLWxpbmtzXCIgKm5nSWY9XCJpc1NlYXJjaCAmJiAhbG9hZGluZ1wiPlxuICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgICpuZ0Zvcj1cImxldCBub2RlSXRlbSBvZiBub2RlTGlzdFwiXG4gICAgICAgICAgICAoY2xpY2spPVwic2VsZWN0Tm9kZShub2RlSXRlbSlcIlxuICAgICAgICAgICAgW25nQ2xhc3NdPVwieyAnbGlzdC1ncm91cC1pdGVtIGQtZmxleCc6IHRydWUgfVwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cImxpc3QtZ3JvdXAtaWNvbiBtLXItNFwiPlxuICAgICAgICAgICAgICA8aSBjbGFzcz1cIm0tci00XCIgW2M4eUljb25dPVwiZ2V0SWNvbihub2RlSXRlbS5ub2RlQ2xhc3NOYW1lKVwiPjwvaT5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cImxpc3QtaXRlbS1ib2R5IHRleHQtdHJ1bmNhdGVcIj5cbiAgICAgICAgICAgICAgPHNwYW4gdGlsZT1cIm5vZGVJZFwiPnt7IG5vZGVJdGVtLm5vZGVJZCB9fTwvc3Bhbj5cbiAgICAgICAgICAgICAge3sgbm9kZUl0ZW0uZGlzcGxheU5hbWUgfX1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdiBjbGFzcz1cImZsZXgtY29udGVudC1zY3JvbGxcIiAqbmdJZj1cIiFpc1NlYXJjaFwiPlxuICAgICAgICA8b3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlXG4gICAgICAgICAgKHNlbGVjdGVkTm9kZSk9XCJ0b2dnbGVDdXJyZW50Tm9kZSgkZXZlbnQpXCJcbiAgICAgICAgICBbZm9jdXNFbWl0dGVyXT1cImZvY3VzU3RhdHVzXCJcbiAgICAgICAgPjwvb3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlPlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuICA8b3BjdWEtYWRkcmVzcy1zcGFjZS1kZXRhaWxcbiAgICBbbm9kZV09XCJjdXJyZW50Tm9kZVwiXG4gICAgY2xhc3M9XCJjb2wtbWQtNyBjb2wteHMtMTIgc2Nyb2xsLWNvbHVtbiBuby1ndXR0ZXItbFwiXG4gICAgc3R5bGU9XCJwb2ludGVyLWV2ZW50czogbm9uZVwiXG4gICAgKHRvZ2dsZUF0dHJEZXRhaWwpPVwiYmFja0hhbmRsZXIoJGV2ZW50KVwiXG4gID48L29wY3VhLWFkZHJlc3Mtc3BhY2UtZGV0YWlsPlxuPC9kaXY+XG4iXX0=