import { Component, ViewChildren, QueryList, ChangeDetectorRef } from '@angular/core';
import { Router } from '@angular/router';
import { OpcuaService } from './opcuaService';
import { AlertService, gettext } from '@c8y/ngx-components';
import { find, assign, omit, findIndex, pick, get, isNil } from 'lodash-es';
import { OpcuaDeviceProtocolMapping } from './opcua-device-protocol-mapping.component';
import * as i0 from "@angular/core";
import * as i1 from "./opcuaService";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "@angular/router";
import * as i4 from "@angular/common";
import * as i5 from "@angular/forms";
import * as i6 from "./opcua-device-protocol-description.component";
import * as i7 from "./opcua-device-protocol-data-reporting.component";
import * as i8 from "./opcua-device-protocol-mapping.component";
import * as i9 from "./opcua-auto-apply-settings.component";
export class OpcuaDeviceProtocolDetailComponent {
    constructor(changeDetectorRef, opcuaService, alertService, router) {
        this.changeDetectorRef = changeDetectorRef;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.router = router;
        this.initialModel = {
            id: '',
            fieldbusType: 'opcuaV2',
            description: '',
            unit: '',
            fieldbusVersion: 4,
            name: '',
            referencedServerId: '',
            referencedRootNodeId: '',
            subscriptionType: {
                type: 'None'
            },
            mappings: [],
            overriddenSubscriptions: [],
            applyConstraints: {
                browsePathMatchesRegex: '',
                matchesNodeIds: [],
                serverObjectHasFragment: '',
                matchesServerIds: []
            },
            enabled: ''
        };
        this.isLoaded = true;
        this.getParentAttr = key => get(this.model, key);
    }
    ngAfterContentChecked() {
        this.changeDetectorRef.detectChanges();
    }
    getMapping() {
        return this.model.mappings;
    }
    getEmptyMappingObject() {
        return {
            id: 'new',
            browsePath: []
        };
    }
    getOverriddenSubscriptionsByPath(browsePath) {
        if (isNil(browsePath) || browsePath.length === 0) {
            return undefined;
        }
        return find(this.model.overriddenSubscriptions, { browsePath });
    }
    getStructuredResource(resource) {
        const overriddenSubscriptions = this.getOverriddenSubscriptionsByPath(resource.browsePath);
        let result = assign({}, resource);
        if (overriddenSubscriptions) {
            result = assign({}, resource, { subscriptionType: overriddenSubscriptions.subscriptionType });
        }
        return result;
    }
    async ngOnInit() {
        const id = this.opcuaService.getId();
        if (id) {
            const res = await this.opcuaService.getDeviceProtocol(id);
            if (res && res.status !== 200) {
                const data = res.json ? await res.json() : undefined;
                this.alertService.addServerFailure({ data, res });
                this.isLoaded = false;
            }
            else {
                const data = await res.json();
                if (data && data.applyConstraints === null) {
                    delete data.applyConstraints;
                }
                if (data && data.subscriptionType === null) {
                    delete data.subscriptionType;
                }
                this.model = assign(this.initialModel, data);
                if (!this.model.mappings) {
                    this.model.mappings = [];
                }
                this.model = assign(this.initialModel, this.updateViableMapping(data));
                this.isLoaded = false;
            }
        }
    }
    updateViableMapping(model) {
        const { mappings } = model;
        let result = [];
        if (mappings) {
            result = mappings.map((item, i) => {
                return assign(this.getStructuredResource(item), { id: i });
            });
        }
        return assign(model, { mappings: result });
    }
    trackById(index, el) {
        return get(el, 'id', 'new');
    }
    addVariable() {
        this.model.mappings.push(this.getEmptyMappingObject());
    }
    updateVariable(mappingObject) {
        const { mappings } = this.model;
        const { id } = mappingObject;
        const index = findIndex(mappings, { id });
        if (index > -1) {
            mappings.splice(index, 1);
        }
        if (mappingObject.id === 'new') {
            mappingObject.id = mappings.length > 0 ? Math.max(...mappings.map(m => m.id)) + 1 : 0;
        }
        mappings.push(mappingObject);
    }
    removeVariable(mappingObject) {
        const { mappings } = this.model;
        const { id } = mappingObject;
        let index = -1;
        // id typeof string || number
        if (!isNil(id) && (id.length > 0 || id > -1)) {
            index = findIndex(mappings, { id });
        }
        if (index > -1) {
            mappings.splice(index, 1);
        }
    }
    actionHandler(actionObject) {
        switch (actionObject.action) {
            case 'save':
                this.updateVariable(actionObject.data);
                break;
            case 'delete':
                this.removeVariable(actionObject.data);
                break;
        }
    }
    extractOverridSubscriptionType(_mapping) {
        const overriddenSubscriptions = [];
        const variableMapping = [];
        _mapping.forEach(element => {
            if (element.id !== 'new') {
                if (element.subscriptionType) {
                    overriddenSubscriptions.push(assign({ browsePath: element.browsePath }, { subscriptionType: element.subscriptionType }));
                }
                variableMapping.push(omit(element, ['subscriptionType']));
            }
        });
        return [variableMapping, overriddenSubscriptions];
    }
    prepareRequestJson(_model) {
        let requestJson = {};
        const [mappings, overriddenSubscriptions] = this.extractOverridSubscriptionType(_model.mappings);
        requestJson = assign(requestJson, pick(_model, Object.keys(this.initialModel)), {
            mappings,
            overriddenSubscriptions
        });
        return requestJson;
    }
    async save() {
        try {
            const res = await this.opcuaService.updateDeviceProtocol(this.prepareRequestJson(this.model));
            const data = await res.json();
            if (res && res.status === 200) {
                this.router.navigate(['deviceprotocols']);
                this.alertService.success(gettext('Device protocol saved.'));
            }
            else {
                const { details } = data;
                this.alertService.addServerFailure({ res, data: details });
            }
        }
        catch (ex) {
            this.alertService.danger(gettext('Failed to save. Try again.'));
        }
    }
    canSave(deviceTypeForm) {
        if (this.instanceList) {
            const activeInstances = this.instanceList.filter(item => item.isActive());
            if (activeInstances.length > 0) {
                return true;
            }
        }
        return !deviceTypeForm.form.valid;
    }
}
OpcuaDeviceProtocolDetailComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: OpcuaDeviceProtocolDetailComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i1.OpcuaService }, { token: i2.AlertService }, { token: i3.Router }], target: i0.ɵɵFactoryTarget.Component });
OpcuaDeviceProtocolDetailComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: OpcuaDeviceProtocolDetailComponent, selector: "opcua-device-protocol-detail", viewQueries: [{ propertyName: "instanceList", predicate: OpcuaDeviceProtocolMapping, descendants: true }], ngImport: i0, template: "<c8y-title *ngIf=\"!isLoaded\">{{ model.name }}</c8y-title>\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-device-protocols'\"\n    [label]=\"'Device types' | translate\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-device-protocols'\"\n    [label]=\"'Device protocols' | translate\"\n    [path]=\"'deviceprotocols'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [icon]=\"'c8y-device-protocols'\" [label]=\"model?.name\"></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n<div class=\"row\">\n  <div class=\"col-lg-12 col-lg-max\">\n    <form #deviceTypeForm=\"ngForm\" name=\"detailForm\" *ngIf=\"!isLoaded\" class=\"card card--fullpage\">\n      <opcua-device-protocol-description [model]=\"model\"></opcua-device-protocol-description>\n      <div class=\"inner-scroll\">\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom bg-component sticky-top\">\n            <div class=\"h4\" translate>Variables</div>\n          </div>\n          <div class=\"p-l-16 p-r-16\">\n            <div class=\"c8y-list__group\" *ngIf=\"model.mappings.length > 0\" ngModelGroup=\"variable\">\n              <opcua-device-protocol-mapping\n                *ngFor=\"let resource of getMapping(); index as i; trackBy: trackById\"\n                [index]=\"i\"\n                [referencedServerId]=\"model.referencedServerId\"\n                [referencedRootNodeId]=\"model.referencedRootNodeId\"\n                [resource]=\"getStructuredResource(resource)\"\n                [getParentAttr]=\"getParentAttr\"\n                (onAction)=\"actionHandler($event)\"\n              ></opcua-device-protocol-mapping>\n            </div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16\">\n            <c8y-ui-empty-state\n              *ngIf=\"model.mappings.length === 0\"\n              [icon]=\"'sliders'\"\n              [title]=\"'No variables to display.' | translate\"\n              [subtitle]=\"'Click below to add your first variable.' | translate\"\n            ></c8y-ui-empty-state>\n\n            <div class=\"card-footer\">\n              <button\n                type=\"button\"\n                title=\"{{ 'Add variable' | translate }}\"\n                class=\"btn btn-default addVariableBtn\"\n                (click)=\"addVariable()\"\n              >\n                <i c8yIcon=\"plus-circle\"></i>\n                {{ 'Add variable' | translate }}\n              </button>\n            </div>\n          </div>\n        </div>\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom bg-component sticky-top\">\n            <div class=\"h4\" translate>Data reporting</div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16\" ngModelGroup=\"subscription\">\n            <opcua-device-protocol-data-reporting\n              [groupName]=\"'subscription'\"\n              [model]=\"model\"\n            ></opcua-device-protocol-data-reporting>\n          </div>\n        </div>\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom sticky-top\">\n            <div class=\"h4\" translate>Auto apply constraints</div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16 overflow-visible\" ngModelGroup=\"autoApply\">\n            <opcua-auto-apply [model]=\"model\"></opcua-auto-apply>\n          </div>\n        </div>\n\n        <div class=\"card-footer sticky-bottom separator\" style=\"z-index: 101\">\n          <button\n            title=\"{{ 'Save' | translate }}\"\n            id=\"deviceTypeSave\"\n            class=\"btn btn-primary\"\n            (click)=\"save()\"\n            [disabled]=\"canSave(deviceTypeForm)\"\n            type=\"button\"\n          >\n            {{ 'Save' | translate }}\n          </button>\n        </div>\n      </div>\n    </form>\n  </div>\n</div>\n", dependencies: [{ kind: "component", type: i2.BreadcrumbComponent, selector: "c8y-breadcrumb" }, { kind: "component", type: i2.BreadcrumbItemComponent, selector: "c8y-breadcrumb-item", inputs: ["icon", "translate", "label", "path", "injector"] }, { kind: "component", type: i2.EmptyStateComponent, selector: "c8y-ui-empty-state", inputs: ["icon", "title", "subtitle", "horizontal"] }, { kind: "directive", type: i2.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i2.C8yTranslateDirective, selector: "[translate],[ngx-translate]" }, { kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i2.TitleComponent, selector: "c8y-title", inputs: ["pageTitleUpdate"] }, { kind: "directive", type: i5.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i5.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i5.NgModelGroup, selector: "[ngModelGroup]", inputs: ["ngModelGroup"], exportAs: ["ngModelGroup"] }, { kind: "directive", type: i5.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "component", type: i6.OpcuaDeviceProtocolDescription, selector: "opcua-device-protocol-description", inputs: ["model"] }, { kind: "component", type: i7.OpcuaDeviceProtocolDataReportingComponent, selector: "opcua-device-protocol-data-reporting", inputs: ["model", "groupName"], outputs: ["onSubscriptionChange"] }, { kind: "component", type: i8.OpcuaDeviceProtocolMapping, selector: "opcua-device-protocol-mapping", inputs: ["resource", "index", "getParentAttr", "referencedServerId", "referencedRootNodeId"], outputs: ["onAction"] }, { kind: "component", type: i9.OpcuaAutoApplySettingsComponent, selector: "opcua-auto-apply", inputs: ["model"] }, { kind: "pipe", type: i2.C8yTranslatePipe, name: "translate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: OpcuaDeviceProtocolDetailComponent, decorators: [{
            type: Component,
            args: [{ selector: 'opcua-device-protocol-detail', template: "<c8y-title *ngIf=\"!isLoaded\">{{ model.name }}</c8y-title>\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-device-protocols'\"\n    [label]=\"'Device types' | translate\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-device-protocols'\"\n    [label]=\"'Device protocols' | translate\"\n    [path]=\"'deviceprotocols'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [icon]=\"'c8y-device-protocols'\" [label]=\"model?.name\"></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n<div class=\"row\">\n  <div class=\"col-lg-12 col-lg-max\">\n    <form #deviceTypeForm=\"ngForm\" name=\"detailForm\" *ngIf=\"!isLoaded\" class=\"card card--fullpage\">\n      <opcua-device-protocol-description [model]=\"model\"></opcua-device-protocol-description>\n      <div class=\"inner-scroll\">\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom bg-component sticky-top\">\n            <div class=\"h4\" translate>Variables</div>\n          </div>\n          <div class=\"p-l-16 p-r-16\">\n            <div class=\"c8y-list__group\" *ngIf=\"model.mappings.length > 0\" ngModelGroup=\"variable\">\n              <opcua-device-protocol-mapping\n                *ngFor=\"let resource of getMapping(); index as i; trackBy: trackById\"\n                [index]=\"i\"\n                [referencedServerId]=\"model.referencedServerId\"\n                [referencedRootNodeId]=\"model.referencedRootNodeId\"\n                [resource]=\"getStructuredResource(resource)\"\n                [getParentAttr]=\"getParentAttr\"\n                (onAction)=\"actionHandler($event)\"\n              ></opcua-device-protocol-mapping>\n            </div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16\">\n            <c8y-ui-empty-state\n              *ngIf=\"model.mappings.length === 0\"\n              [icon]=\"'sliders'\"\n              [title]=\"'No variables to display.' | translate\"\n              [subtitle]=\"'Click below to add your first variable.' | translate\"\n            ></c8y-ui-empty-state>\n\n            <div class=\"card-footer\">\n              <button\n                type=\"button\"\n                title=\"{{ 'Add variable' | translate }}\"\n                class=\"btn btn-default addVariableBtn\"\n                (click)=\"addVariable()\"\n              >\n                <i c8yIcon=\"plus-circle\"></i>\n                {{ 'Add variable' | translate }}\n              </button>\n            </div>\n          </div>\n        </div>\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom bg-component sticky-top\">\n            <div class=\"h4\" translate>Data reporting</div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16\" ngModelGroup=\"subscription\">\n            <opcua-device-protocol-data-reporting\n              [groupName]=\"'subscription'\"\n              [model]=\"model\"\n            ></opcua-device-protocol-data-reporting>\n          </div>\n        </div>\n        <div class=\"d-contents\">\n          <div class=\"card-header separator-top-bottom sticky-top\">\n            <div class=\"h4\" translate>Auto apply constraints</div>\n          </div>\n          <div class=\"p-l-16 p-r-16 p-t-16 overflow-visible\" ngModelGroup=\"autoApply\">\n            <opcua-auto-apply [model]=\"model\"></opcua-auto-apply>\n          </div>\n        </div>\n\n        <div class=\"card-footer sticky-bottom separator\" style=\"z-index: 101\">\n          <button\n            title=\"{{ 'Save' | translate }}\"\n            id=\"deviceTypeSave\"\n            class=\"btn btn-primary\"\n            (click)=\"save()\"\n            [disabled]=\"canSave(deviceTypeForm)\"\n            type=\"button\"\n          >\n            {{ 'Save' | translate }}\n          </button>\n        </div>\n      </div>\n    </form>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i1.OpcuaService }, { type: i2.AlertService }, { type: i3.Router }]; }, propDecorators: { instanceList: [{
                type: ViewChildren,
                args: [OpcuaDeviceProtocolMapping]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm90b2NvbC1vcGN1YS9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtZGV0YWlsLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uL3Byb3RvY29sLW9wY3VhL29wY3VhLWRldmljZS1wcm90b2NvbC1kZXRhaWwuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFlBQVksRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUYsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDNUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7Ozs7Ozs7Ozs7O0FBTXZGLE1BQU0sT0FBTyxrQ0FBa0M7SUErQjdDLFlBQ1UsaUJBQW9DLEVBQ3BDLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLE1BQWM7UUFIZCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFoQ3hCLGlCQUFZLEdBQW9CO1lBQzlCLEVBQUUsRUFBRSxFQUFFO1lBQ04sWUFBWSxFQUFFLFNBQVM7WUFDdkIsV0FBVyxFQUFFLEVBQUU7WUFDZixJQUFJLEVBQUUsRUFBRTtZ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O0lBRUQsT0FBTyxDQUFDLGNBQWM7UUFDcEIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFFMUUsSUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxJQUFJLENBQUM7YUFDYjtTQUNGO1FBQ0QsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3BDLENBQUM7OytIQXROVSxrQ0FBa0M7bUhBQWxDLGtDQUFrQyxxR0FDL0IsMEJBQTBCLGdEQ2IxQywreUhBNEZBOzJGRGhGYSxrQ0FBa0M7a0JBSjlDLFNBQVM7K0JBQ0UsOEJBQThCO21MQUlFLFlBQVk7c0JBQXJELFlBQVk7dUJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFZpZXdDaGlsZHJlbiwgUXVlcnlMaXN0LCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgT3BjdWFEZXZpY2VUeXBlIH0gZnJvbSAnLi9vcGN1YS1wcm90b2NvbC1kZXZpY2UtdHlwZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZmluZCwgYXNzaWduLCBvbWl0LCBmaW5kSW5kZXgsIHBpY2ssIGdldCwgaXNOaWwgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgT3BjdWFEZXZpY2VQcm90b2NvbE1hcHBpbmcgfSBmcm9tICcuL29wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWRldmljZS1wcm90b2NvbC1kZXRhaWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vb3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YURldmljZVByb3RvY29sRGV0YWlsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQFZpZXdDaGlsZHJlbihPcGN1YURldmljZVByb3RvY29sTWFwcGluZykgaW5zdGFuY2VMaXN0OiBRdWVyeUxpc3Q8T3BjdWFEZXZpY2VQcm90b2NvbE1hcHBpbmc+O1xuXG4gIGluaXRpYWxNb2RlbDogT3BjdWFEZXZpY2VUeXBlID0ge1xuICAgIGlkOiAnJyxcbiAgICBmaWVsZGJ1c1R5cGU6ICdvcGN1YVYyJyxcbiAgICBkZXNjcmlwdGlvbjogJycsXG4gICAgdW5pdDogJycsXG4gICAgZmllbGRidXNWZXJzaW9uOiA0LFxuICAgIG5hbWU6ICcnLFxuICAgIHJlZmVyZW5jZWRTZXJ2ZXJJZDogJycsXG4gICAgcmVmZXJlbmNlZFJvb3ROb2RlSWQ6ICcnLFxuICAgIHN1YnNjcmlwdGlvblR5cGU6IHtcbiAgICAgIHR5cGU6ICdOb25lJ1xuICAgIH0sXG4gICAgbWFwcGluZ3M6IFtdLFxuICAgIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zOiBbXSxcbiAgICBhcHBseUNvbnN0cmFpbnRzOiB7XG4gICAgICBicm93c2VQYXRoTWF0Y2hlc1JlZ2V4OiAnJyxcbiAgICAgIG1hdGNoZXNOb2RlSWRzOiBbXSxcbiAgICAgIHNlcnZlck9iamVjdEhhc0ZyYWdtZW50OiAnJyxcbiAgICAgIG1hdGNoZXNTZXJ2ZXJJZHM6IFtdXG4gICAgfSxcbiAgICBlbmFibGVkOiAnJ1xuICB9O1xuXG4gIG1vZGVsOiBhbnk7XG4gIHNlcnZlcjogYW55O1xuICBzZWxlY3RlZE5vZGU6IGFueTtcbiAgaXNMb2FkZWQgPSB0cnVlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyXG4gICkge31cblxuICBuZ0FmdGVyQ29udGVudENoZWNrZWQoKSB7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBnZXRQYXJlbnRBdHRyID0ga2V5ID0+IGdldCh0aGlzLm1vZGVsLCBrZXkpO1xuXG4gIGdldE1hcHBpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kZWwubWFwcGluZ3M7XG4gIH1cblxuICBnZXRFbXB0eU1hcHBpbmdPYmplY3QoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiAnbmV3JyxcbiAgICAgIGJyb3dzZVBhdGg6IFtdXG4gICAgfTtcbiAgfVxuXG4gIGdldE92ZXJyaWRkZW5TdWJzY3JpcHRpb25zQnlQYXRoKGJyb3dzZVBhdGg6IHN0cmluZ1tdKTogYW55IHtcbiAgICBpZiAoaXNOaWwoYnJvd3NlUGF0aCkgfHwgYnJvd3NlUGF0aC5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHJldHVybiBmaW5kKHRoaXMubW9kZWwub3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMsIHsgYnJvd3NlUGF0aCB9KTtcbiAgfVxuXG4gIGdldFN0cnVjdHVyZWRSZXNvdXJjZShyZXNvdXJjZSkge1xuICAgIGNvbnN0IG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zOiBhbnkgPSB0aGlzLmdldE92ZXJyaWRkZW5TdWJzY3JpcHRpb25zQnlQYXRoKHJlc291cmNlLmJyb3dzZVBhdGgpO1xuICAgIGxldCByZXN1bHQgPSBhc3NpZ24oe30sIHJlc291cmNlKTtcbiAgICBpZiAob3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHJlc3VsdCA9IGFzc2lnbih7fSwgcmVzb3VyY2UsIHsgc3Vic2NyaXB0aW9uVHlwZTogb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMuc3Vic2NyaXB0aW9uVHlwZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0SWQoKTtcbiAgICBpZiAoaWQpIHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMub3BjdWFTZXJ2aWNlLmdldERldmljZVByb3RvY29sKGlkKTtcbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgICAgIHRoaXMuaXNMb2FkZWQgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmFwcGx5Q29uc3RyYWludHMgPT09IG51bGwpIHtcbiAgICAgICAgICBkZWxldGUgZGF0YS5hcHBseUNvbnN0cmFpbnRzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEuc3Vic2NyaXB0aW9uVHlwZSA9PT0gbnVsbCkge1xuICAgICAgICAgIGRlbGV0ZSBkYXRhLnN1YnNjcmlwdGlvblR5cGU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb2RlbCA9IGFzc2lnbih0aGlzLmluaXRpYWxNb2RlbCwgZGF0YSk7XG4gICAgICAgIGlmICghdGhpcy5tb2RlbC5tYXBwaW5ncykge1xuICAgICAgICAgIHRoaXMubW9kZWwubWFwcGluZ3MgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vZGVsID0gYXNzaWduKHRoaXMuaW5pdGlhbE1vZGVsLCB0aGlzLnVwZGF0ZVZpYWJsZU1hcHBpbmcoZGF0YSkpO1xuICAgICAgICB0aGlzLmlzTG9hZGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlVmlhYmxlTWFwcGluZyhtb2RlbCkge1xuICAgIGNvbnN0IHsgbWFwcGluZ3MgfSA9IG1vZGVsO1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBpZiAobWFwcGluZ3MpIHtcbiAgICAgIHJlc3VsdCA9IG1hcHBpbmdzLm1hcCgoaXRlbSwgaSkgPT4ge1xuICAgICAgICByZXR1cm4gYXNzaWduKHRoaXMuZ2V0U3RydWN0dXJlZFJlc291cmNlKGl0ZW0pLCB7IGlkOiBpIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBhc3NpZ24obW9kZWwsIHsgbWFwcGluZ3M6IHJlc3VsdCB9KTtcbiAgfVxuXG4gIHRyYWNrQnlJZChpbmRleDogbnVtYmVyLCBlbDogYW55KTogbnVtYmVyIHwgJ25ldycge1xuICAgIHJldHVybiBnZXQoZWwsICdpZCcsICduZXcnKTtcbiAgfVxuXG4gIGFkZFZhcmlhYmxlKCkge1xuICAgIHRoaXMubW9kZWwubWFwcGluZ3MucHVzaCh0aGlzLmdldEVtcHR5TWFwcGluZ09iamVjdCgpKTtcbiAgfVxuXG4gIHVwZGF0ZVZhcmlhYmxlKG1hcHBpbmdPYmplY3QpIHtcbiAgICBjb25zdCB7IG1hcHBpbmdzIH0gPSB0aGlzLm1vZGVsO1xuICAgIGNvbnN0IHsgaWQgfSA9IG1hcHBpbmdPYmplY3Q7XG5cbiAgICBjb25zdCBpbmRleCA9IGZpbmRJbmRleChtYXBwaW5ncywgeyBpZCB9KTtcbiAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgbWFwcGluZ3Muc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG5cbiAgICBpZiAobWFwcGluZ09iamVjdC5pZCA9PT0gJ25ldycpIHtcbiAgICAgIG1hcHBpbmdPYmplY3QuaWQgPSBtYXBwaW5ncy5sZW5ndGggPiAwID8gTWF0aC5tYXgoLi4ubWFwcGluZ3MubWFwKG0gPT4gbS5pZCkpICsgMSA6IDA7XG4gICAgfVxuICAgIG1hcHBpbmdzLnB1c2gobWFwcGluZ09iamVjdCk7XG4gIH1cblxuICByZW1vdmVWYXJpYWJsZShtYXBwaW5nT2JqZWN0KSB7XG4gICAgY29uc3QgeyBtYXBwaW5ncyB9ID0gdGhpcy5tb2RlbDtcbiAgICBjb25zdCB7IGlkIH0gPSBtYXBwaW5nT2JqZWN0O1xuICAgIGxldCBpbmRleCA9IC0xO1xuXG4gICAgLy8gaWQgdHlwZW9mIHN0cmluZyB8fCBudW1iZXJcbiAgICBpZiAoIWlzTmlsKGlkKSAmJiAoaWQubGVuZ3RoID4gMCB8fCBpZCA+IC0xKSkge1xuICAgICAgaW5kZXggPSBmaW5kSW5kZXgobWFwcGluZ3MsIHsgaWQgfSk7XG4gICAgfVxuXG4gICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgIG1hcHBpbmdzLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICB9XG5cbiAgYWN0aW9uSGFuZGxlcihhY3Rpb25PYmplY3QpIHtcbiAgICBzd2l0Y2ggKGFjdGlvbk9iamVjdC5hY3Rpb24pIHtcbiAgICAgIGNhc2UgJ3NhdmUnOlxuICAgICAgICB0aGlzLnVwZGF0ZVZhcmlhYmxlKGFjdGlvbk9iamVjdC5kYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkZWxldGUnOlxuICAgICAgICB0aGlzLnJlbW92ZVZhcmlhYmxlKGFjdGlvbk9iamVjdC5kYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgZXh0cmFjdE92ZXJyaWRTdWJzY3JpcHRpb25UeXBlKF9tYXBwaW5nKSB7XG4gICAgY29uc3Qgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICBjb25zdCB2YXJpYWJsZU1hcHBpbmcgPSBbXTtcbiAgICBfbWFwcGluZy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgaWYgKGVsZW1lbnQuaWQgIT09ICduZXcnKSB7XG4gICAgICAgIGlmIChlbGVtZW50LnN1YnNjcmlwdGlvblR5cGUpIHtcbiAgICAgICAgICBvdmVycmlkZGVuU3Vic2NyaXB0aW9ucy5wdXNoKFxuICAgICAgICAgICAgYXNzaWduKFxuICAgICAgICAgICAgICB7IGJyb3dzZVBhdGg6IGVsZW1lbnQuYnJvd3NlUGF0aCB9LFxuICAgICAgICAgICAgICB7IHN1YnNjcmlwdGlvblR5cGU6IGVsZW1lbnQuc3Vic2NyaXB0aW9uVHlwZSB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB2YXJpYWJsZU1hcHBpbmcucHVzaChvbWl0KGVsZW1lbnQsIFsnc3Vic2NyaXB0aW9uVHlwZSddKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIFt2YXJpYWJsZU1hcHBpbmcsIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zXTtcbiAgfVxuXG4gIHByZXBhcmVSZXF1ZXN0SnNvbihfbW9kZWwpIHtcbiAgICBsZXQgcmVxdWVzdEpzb24gPSB7fTtcbiAgICBjb25zdCBbbWFwcGluZ3MsIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zXSA9IHRoaXMuZXh0cmFjdE92ZXJyaWRTdWJzY3JpcHRpb25UeXBlKFxuICAgICAgX21vZGVsLm1hcHBpbmdzXG4gICAgKTtcbiAgICByZXF1ZXN0SnNvbiA9IGFzc2lnbihyZXF1ZXN0SnNvbiwgcGljayhfbW9kZWwsIE9iamVjdC5rZXlzKHRoaXMuaW5pdGlhbE1vZGVsKSksIHtcbiAgICAgIG1hcHBpbmdzLFxuICAgICAgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnNcbiAgICB9KTtcbiAgICByZXR1cm4gcmVxdWVzdEpzb247XG4gIH1cblxuICBhc3luYyBzYXZlKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLm9wY3VhU2VydmljZS51cGRhdGVEZXZpY2VQcm90b2NvbCh0aGlzLnByZXBhcmVSZXF1ZXN0SnNvbih0aGlzLm1vZGVsKSk7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgICAgaWYgKHJlcyAmJiByZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydkZXZpY2Vwcm90b2NvbHMnXSk7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnRGV2aWNlIHByb3RvY29sIHNhdmVkLicpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHsgZGV0YWlscyB9ID0gZGF0YTtcbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IHJlcywgZGF0YTogZGV0YWlscyB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuZGFuZ2VyKGdldHRleHQoJ0ZhaWxlZCB0byBzYXZlLiBUcnkgYWdhaW4uJykpO1xuICAgIH1cbiAgfVxuXG4gIGNhblNhdmUoZGV2aWNlVHlwZUZvcm0pIHtcbiAgICBpZiAodGhpcy5pbnN0YW5jZUxpc3QpIHtcbiAgICAgIGNvbnN0IGFjdGl2ZUluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VMaXN0LmZpbHRlcihpdGVtID0+IGl0ZW0uaXNBY3RpdmUoKSk7XG5cbiAgICAgIGlmIChhY3RpdmVJbnN0YW5jZXMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuICFkZXZpY2VUeXBlRm9ybS5mb3JtLnZhbGlkO1xuICB9XG59XG4iLCI8Yzh5LXRpdGxlICpuZ0lmPVwiIWlzTG9hZGVkXCI+e3sgbW9kZWwubmFtZSB9fTwvYzh5LXRpdGxlPlxuPGM4eS1icmVhZGNydW1iPlxuICA8Yzh5LWJyZWFkY3J1bWItaXRlbVxuICAgIFtpY29uXT1cIidjOHktZGV2aWNlLXByb3RvY29scydcIlxuICAgIFtsYWJlbF09XCInRGV2aWNlIHR5cGVzJyB8IHRyYW5zbGF0ZVwiXG4gID48L2M4eS1icmVhZGNydW1iLWl0ZW0+XG4gIDxjOHktYnJlYWRjcnVtYi1pdGVtXG4gICAgW2ljb25dPVwiJ2M4eS1kZXZpY2UtcHJvdG9jb2xzJ1wiXG4gICAgW2xhYmVsXT1cIidEZXZpY2UgcHJvdG9jb2xzJyB8IHRyYW5zbGF0ZVwiXG4gICAgW3BhdGhdPVwiJ2RldmljZXByb3RvY29scydcIlxuICA+PC9jOHktYnJlYWRjcnVtYi1pdGVtPlxuICA8Yzh5LWJyZWFkY3J1bWItaXRlbSBbaWNvbl09XCInYzh5LWRldmljZS1wcm90b2NvbHMnXCIgW2xhYmVsXT1cIm1vZGVsPy5uYW1lXCI+PC9jOHktYnJlYWRjcnVtYi1pdGVtPlxuPC9jOHktYnJlYWRjcnVtYj5cbjxkaXYgY2xhc3M9XCJyb3dcIj5cbiAgPGRpdiBjbGFzcz1cImNvbC1sZy0xMiBjb2wtbGctbWF4XCI+XG4gICAgPGZvcm0gI2RldmljZVR5cGVGb3JtPVwibmdGb3JtXCIgbmFtZT1cImRldGFpbEZvcm1cIiAqbmdJZj1cIiFpc0xvYWRlZFwiIGNsYXNzPVwiY2FyZCBjYXJkLS1mdWxscGFnZVwiPlxuICAgICAgPG9wY3VhLWRldmljZS1wcm90b2NvbC1kZXNjcmlwdGlvbiBbbW9kZWxdPVwibW9kZWxcIj48L29wY3VhLWRldmljZS1wcm90b2NvbC1kZXNjcmlwdGlvbj5cbiAgICAgIDxkaXYgY2xhc3M9XCJpbm5lci1zY3JvbGxcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImQtY29udGVudHNcIj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwiY2FyZC1oZWFkZXIgc2VwYXJhdG9yLXRvcC1ib3R0b20gYmctY29tcG9uZW50IHN0aWNreS10b3BcIj5cbiAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJoNFwiIHRyYW5zbGF0ZT5WYXJpYWJsZXM8L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwicC1sLTE2IHAtci0xNlwiPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cImM4eS1saXN0X19ncm91cFwiICpuZ0lmPVwibW9kZWwubWFwcGluZ3MubGVuZ3RoID4gMFwiIG5nTW9kZWxHcm91cD1cInZhcmlhYmxlXCI+XG4gICAgICAgICAgICAgIDxvcGN1YS1kZXZpY2UtcHJvdG9jb2wtbWFwcGluZ1xuICAgICAgICAgICAgICAgICpuZ0Zvcj1cImxldCByZXNvdXJjZSBvZiBnZXRNYXBwaW5nKCk7IGluZGV4IGFzIGk7IHRyYWNrQnk6IHRyYWNrQnlJZFwiXG4gICAgICAgICAgICAgICAgW2luZGV4XT1cImlcIlxuICAgICAgICAgICAgICAgIFtyZWZlcmVuY2VkU2VydmVySWRdPVwibW9kZWwucmVmZXJlbmNlZFNlcnZlcklkXCJcbiAgICAgICAgICAgICAgICBbcmVmZXJlbmNlZFJvb3ROb2RlSWRdPVwibW9kZWwucmVmZXJlbmNlZFJvb3ROb2RlSWRcIlxuICAgICAgICAgICAgICAgIFtyZXNvdXJjZV09XCJnZXRTdHJ1Y3R1cmVkUmVzb3VyY2UocmVzb3VyY2UpXCJcbiAgICAgICAgICAgICAgICBbZ2V0UGFyZW50QXR0cl09XCJnZXRQYXJlbnRBdHRyXCJcbiAgICAgICAgICAgICAgICAob25BY3Rpb24pPVwiYWN0aW9uSGFuZGxlcigkZXZlbnQpXCJcbiAgICAgICAgICAgICAgPjwvb3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmc+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwicC1sLTE2IHAtci0xNiBwLXQtMTZcIj5cbiAgICAgICAgICAgIDxjOHktdWktZW1wdHktc3RhdGVcbiAgICAgICAgICAgICAgKm5nSWY9XCJtb2RlbC5tYXBwaW5ncy5sZW5ndGggPT09IDBcIlxuICAgICAgICAgICAgICBbaWNvbl09XCInc2xpZGVycydcIlxuICAgICAgICAgICAgICBbdGl0bGVdPVwiJ05vIHZhcmlhYmxlcyB0byBkaXNwbGF5LicgfCB0cmFuc2xhdGVcIlxuICAgICAgICAgICAgICBbc3VidGl0bGVdPVwiJ0NsaWNrIGJlbG93IHRvIGFkZCB5b3VyIGZpcnN0IHZhcmlhYmxlLicgfCB0cmFuc2xhdGVcIlxuICAgICAgICAgICAgPjwvYzh5LXVpLWVtcHR5LXN0YXRlPlxuXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwiY2FyZC1mb290ZXJcIj5cbiAgICAgICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgICAgICAgIHRpdGxlPVwie3sgJ0FkZCB2YXJpYWJsZScgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1kZWZhdWx0IGFkZFZhcmlhYmxlQnRuXCJcbiAgICAgICAgICAgICAgICAoY2xpY2spPVwiYWRkVmFyaWFibGUoKVwiXG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8aSBjOHlJY29uPVwicGx1cy1jaXJjbGVcIj48L2k+XG4gICAgICAgICAgICAgICAge3sgJ0FkZCB2YXJpYWJsZScgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJkLWNvbnRlbnRzXCI+XG4gICAgICAgICAgPGRpdiBjbGFzcz1cImNhcmQtaGVhZGVyIHNlcGFyYXRvci10b3AtYm90dG9tIGJnLWNvbXBvbmVudCBzdGlja3ktdG9wXCI+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwiaDRcIiB0cmFuc2xhdGU+RGF0YSByZXBvcnRpbmc8L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwicC1sLTE2IHAtci0xNiBwLXQtMTZcIiBuZ01vZGVsR3JvdXA9XCJzdWJzY3JpcHRpb25cIj5cbiAgICAgICAgICAgIDxvcGN1YS1kZXZpY2UtcHJvdG9jb2wtZGF0YS1yZXBvcnRpbmdcbiAgICAgICAgICAgICAgW2dyb3VwTmFtZV09XCInc3Vic2NyaXB0aW9uJ1wiXG4gICAgICAgICAgICAgIFttb2RlbF09XCJtb2RlbFwiXG4gICAgICAgICAgICA+PC9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtZGF0YS1yZXBvcnRpbmc+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwiZC1jb250ZW50c1wiPlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJjYXJkLWhlYWRlciBzZXBhcmF0b3ItdG9wLWJvdHRvbSBzdGlja3ktdG9wXCI+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwiaDRcIiB0cmFuc2xhdGU+QXV0byBhcHBseSBjb25zdHJhaW50czwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJwLWwtMTYgcC1yLTE2IHAtdC0xNiBvdmVyZmxvdy12aXNpYmxlXCIgbmdNb2RlbEdyb3VwPVwiYXV0b0FwcGx5XCI+XG4gICAgICAgICAgICA8b3BjdWEtYXV0by1hcHBseSBbbW9kZWxdPVwibW9kZWxcIj48L29wY3VhLWF1dG8tYXBwbHk+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuXG4gICAgICAgIDxkaXYgY2xhc3M9XCJjYXJkLWZvb3RlciBzdGlja3ktYm90dG9tIHNlcGFyYXRvclwiIHN0eWxlPVwiei1pbmRleDogMTAxXCI+XG4gICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgdGl0bGU9XCJ7eyAnU2F2ZScgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICAgICAgaWQ9XCJkZXZpY2VUeXBlU2F2ZVwiXG4gICAgICAgICAgICBjbGFzcz1cImJ0biBidG4tcHJpbWFyeVwiXG4gICAgICAgICAgICAoY2xpY2spPVwic2F2ZSgpXCJcbiAgICAgICAgICAgIFtkaXNhYmxlZF09XCJjYW5TYXZlKGRldmljZVR5cGVGb3JtKVwiXG4gICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICB7eyAnU2F2ZScgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Zvcm0+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=