import { Injectable } from '@angular/core';
import { InventoryService } from '@c8y/client';
import { ClusterSize } from './map.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
export class MapService {
    constructor(inventory) {
        this.inventory = inventory;
        /**
         * The devices that are maximal displayed in one cluster.
         */
        this.MAX_DEVICE_PER_CLUSTER = 200;
        /**
         * The count until the cluster is sized. There are a maximum of
         * three clusters: 1, 4 or 16.
         */
        this.CLUSTER_LEVEL_THRESHOLD = 500;
    }
    /**
     * Returns the leaflet instance used by the cumulocity core.
     */
    async getLeaflet() {
        const c8yLeafletInstance = (await import('leaflet')).default;
        return c8yLeafletInstance;
    }
    /**
     * Verifies if a given managed object is a device with a position fragment.
     * @param mo The given managed object.
     */
    isPositionedDevice(mo) {
        return !!(mo?.c8y_IsDevice && this.hasPosition(mo));
    }
    /**
     * Verifies if a given managed object has a position fragment.
     * @param mo The given managed object.
     */
    hasPosition(mo) {
        return mo?.c8y_Position;
    }
    async getPositionMOs(bound, byGroupIdMO) {
        return this.getPositionMOsFromBound(bound, byGroupIdMO, false);
    }
    async getPositionMOsFromBoundCount(bound, byGroupIdMO) {
        return this.getPositionMOsFromBound(bound, byGroupIdMO, true);
    }
    async getPositionDevices(pageSize = this.MAX_DEVICE_PER_CLUSTER, count) {
        const { paging, data } = await this.inventory.list({
            pageSize: count ? 1 : pageSize,
            withTotalPages: count,
            query: '$filter=has(c8y_Position) and has(c8y_IsDevice)'
        });
        if (count) {
            return paging.totalPages;
        }
        return data;
    }
    async getPositionMOsFromBound(bound, byGroupIdMO, count = false) {
        const { lat: latMin, lng: lngMin } = bound.getSouthWest();
        const { lat: latMax, lng: lngMax } = bound.getNorthEast();
        const byGroupIdFilter = byGroupIdMO
            ? `(bygroupid(${byGroupIdMO.id}) or id eq '${byGroupIdMO.id}') and `
            : '';
        const boundFilter = `$filter=${byGroupIdFilter}has(c8y_Position) and c8y_Position.lng gt ${lngMin}d and c8y_Position.lat gt ${latMin}d and c8y_Position.lng lt ${lngMax}d and c8y_Position.lat lt ${latMax}d`;
        const { paging, data } = await this.inventory.list({
            pageSize: count ? 1 : this.MAX_DEVICE_PER_CLUSTER,
            withTotalPages: count,
            query: boundFilter
        });
        if (count) {
            return paging.totalPages;
        }
        return data;
    }
    async getAllPositionsMOs(byGroupIdMO, pageSize = 500) {
        const filter = {
            pageSize,
            withTotalPages: true,
            query: 'has(c8y_Position)'
        };
        if (byGroupIdMO) {
            filter.query = `$filter=(bygroupid(${byGroupIdMO.id}) or id eq '${byGroupIdMO.id}') and has(c8y_Position)`;
        }
        const { paging, data, res } = await this.inventory.list(filter);
        return {
            res,
            paging: paging,
            data: data
        };
    }
    async getClusterSize(bound) {
        const count = await this.getPositionMOsFromBoundCount(bound);
        let clusterSize = ClusterSize.NONE;
        if (count > this.CLUSTER_LEVEL_THRESHOLD) {
            clusterSize = ClusterSize.SIXTEEN;
        }
        else if (count > this.MAX_DEVICE_PER_CLUSTER) {
            clusterSize = ClusterSize.FOUR;
        }
        return clusterSize;
    }
}
MapService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: MapService, deps: [{ token: i1.InventoryService }], target: i0.ɵɵFactoryTarget.Injectable });
MapService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: MapService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: MapService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.InventoryService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9tYXAvbWFwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWtCLGdCQUFnQixFQUF1QixNQUFNLGFBQWEsQ0FBQztBQUVwRixPQUFPLEVBQUUsV0FBVyxFQUF5QixNQUFNLGFBQWEsQ0FBQzs7O0FBS2pFLE1BQU0sT0FBTyxVQUFVO0lBVXJCLFlBQW9CLFNBQTJCO1FBQTNCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBVC9DOztXQUVHO1FBQ0gsMkJBQXNCLEdBQUcsR0FBRyxDQUFDO1FBQzdCOzs7V0FHRztRQUNILDRCQUF1QixHQUFHLEdBQUcsQ0FBQztJQUNvQixDQUFDO0lBRW5EOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFVBQVU7UUFDZCxNQUFNLGtCQUFrQixHQUFHLENBQUMsTUFBTSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDN0QsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsa0JBQWtCLENBQUMsRUFBa0I7UUFDbkMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsWUFBWSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsV0FBVyxDQUFDLEVBQWtCO1FBQzVCLE9BQU8sRUFBRSxFQUFFLFlBQVksQ0FBQztJQUMxQixDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FDbEIsS0FBcUIsRUFDckIsV0FBNEI7UUFFNUIsT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxLQUFLLENBRTVELENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLDRCQUE0QixDQUNoQyxLQUFxQixFQUNyQixXQUE0QjtRQUU1QixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBb0IsQ0FBQztJQUNuRixDQUFDO0lBTUQsS0FBSyxDQUFDLGtCQUFrQixDQUN0QixRQUFRLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixFQUN0QyxLQUFlO1FBRWYsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQ2pELFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUTtZQUM5QixjQUFjLEVBQUUsS0FBSztZQUNyQixLQUFLLEVBQUUsaURBQWlEO1NBQ3pELENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDO1NBQzFCO1FBQ0QsT0FBTyxJQUErQixDQUFDO0lBQ3pDLENBQUM7SUFpQkQsS0FBSyxDQUFDLHVCQUF1QixDQUMzQixLQUFxQixFQUNyQixXQUE0QixFQUM1QixLQUFLLEdBQUcsS0FBSztRQUViLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUQsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxRCxNQUFNLGVBQWUsR0FBRyxXQUFXO1lBQ2pDLENBQUMsQ0FBQyxjQUFjLFdBQVcsQ0FBQyxFQUFFLGVBQWUsV0FBVyxDQUFDLEVBQUUsU0FBUztZQUNwRSxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ1AsTUFBTSxXQUFXLEdBQUcsV0FBVyxlQUFlLDZDQUE2QyxNQUFNLDZCQUE2QixNQUFNLDZCQUE2QixNQUFNLDZCQUE2QixNQUFNLEdBQUcsQ0FBQztRQUM5TSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7WUFDakQsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCO1lBQ2pELGNBQWMsRUFBRSxLQUFLO1lBQ3JCLEtBQUssRUFBRSxXQUFXO1NBQ25CLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDO1NBQzFCO1FBQ0QsT0FBTyxJQUErQixDQUFDO0lBQ3pDLENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQ3RCLFdBQTRCLEVBQzVCLFFBQVEsR0FBRyxHQUFHO1FBRWQsTUFBTSxNQUFNLEdBQWlFO1lBQzNFLFFBQVE7WUFDUixjQUFjLEVBQUUsSUFBSTtZQUNwQixLQUFLLEVBQUUsbUJBQW1CO1NBQzNCLENBQUM7UUFFRixJQUFJLFdBQVcsRUFBRTtZQUNmLE1BQU0sQ0FBQyxLQUFLLEdBQUcsc0JBQXNCLFdBQVcsQ0FBQyxFQUFFLGVBQWUsV0FBVyxDQUFDLEVBQUUsMEJBQTBCLENBQUM7U0FDNUc7UUFFRCxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWhFLE9BQU87WUFDTCxHQUFHO1lBQ0gsTUFBTSxFQUFFLE1BQXVDO1lBQy9DLElBQUksRUFBRSxJQUErQjtTQUN0QyxDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBcUI7UUFDeEMsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0QsSUFBSSxXQUFXLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztRQUNuQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsdUJBQXVCLEVBQUU7WUFDeEMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7U0FDbkM7YUFBTSxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsc0JBQXNCLEVBQUU7WUFDOUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUM7U0FDaEM7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOzt1R0E1SVUsVUFBVTsyR0FBVixVQUFVLGNBRlQsTUFBTTsyRkFFUCxVQUFVO2tCQUh0QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlLCBJUmVzdWx0TGlzdCwgUGFnaW5nIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHR5cGUgKiBhcyBMIGZyb20gJ2xlYWZsZXQnO1xuaW1wb3J0IHsgQ2x1c3RlclNpemUsIFBvc2l0aW9uTWFuYWdlZE9iamVjdCB9IGZyb20gJy4vbWFwLm1vZGVsJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTWFwU2VydmljZSB7XG4gIC8qKlxuICAgKiBUaGUgZGV2aWNlcyB0aGF0IGFyZSBtYXhpbWFsIGRpc3BsYXllZCBpbiBvbmUgY2x1c3Rlci5cbiAgICovXG4gIE1BWF9ERVZJQ0VfUEVSX0NMVVNURVIgPSAyMDA7XG4gIC8qKlxuICAgKiBUaGUgY291bnQgdW50aWwgdGhlIGNsdXN0ZXIgaXMgc2l6ZWQuIFRoZXJlIGFyZSBhIG1heGltdW0gb2ZcbiAgICogdGhyZWUgY2x1c3RlcnM6IDEsIDQgb3IgMTYuXG4gICAqL1xuICBDTFVTVEVSX0xFVkVMX1RIUkVTSE9MRCA9IDUwMDtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGxlYWZsZXQgaW5zdGFuY2UgdXNlZCBieSB0aGUgY3VtdWxvY2l0eSBjb3JlLlxuICAgKi9cbiAgYXN5bmMgZ2V0TGVhZmxldCgpIHtcbiAgICBjb25zdCBjOHlMZWFmbGV0SW5zdGFuY2UgPSAoYXdhaXQgaW1wb3J0KCdsZWFmbGV0JykpLmRlZmF1bHQ7XG4gICAgcmV0dXJuIGM4eUxlYWZsZXRJbnN0YW5jZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmllcyBpZiBhIGdpdmVuIG1hbmFnZWQgb2JqZWN0IGlzIGEgZGV2aWNlIHdpdGggYSBwb3NpdGlvbiBmcmFnbWVudC5cbiAgICogQHBhcmFtIG1vIFRoZSBnaXZlbiBtYW5hZ2VkIG9iamVjdC5cbiAgICovXG4gIGlzUG9zaXRpb25lZERldmljZShtbzogSU1hbmFnZWRPYmplY3QpIHtcbiAgICByZXR1cm4gISEobW8/LmM4eV9Jc0RldmljZSAmJiB0aGlzLmhhc1Bvc2l0aW9uKG1vKSk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpZXMgaWYgYSBnaXZlbiBtYW5hZ2VkIG9iamVjdCBoYXMgYSBwb3NpdGlvbiBmcmFnbWVudC5cbiAgICogQHBhcmFtIG1vIFRoZSBnaXZlbiBtYW5hZ2VkIG9iamVjdC5cbiAgICovXG4gIGhhc1Bvc2l0aW9uKG1vOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIHJldHVybiBtbz8uYzh5X1Bvc2l0aW9uO1xuICB9XG5cbiAgYXN5bmMgZ2V0UG9zaXRpb25NT3MoXG4gICAgYm91bmQ6IEwuTGF0TG5nQm91bmRzLFxuICAgIGJ5R3JvdXBJZE1PPzogSU1hbmFnZWRPYmplY3RcbiAgKTogUHJvbWlzZTxQb3NpdGlvbk1hbmFnZWRPYmplY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFBvc2l0aW9uTU9zRnJvbUJvdW5kKGJvdW5kLCBieUdyb3VwSWRNTywgZmFsc2UpIGFzIFByb21pc2U8XG4gICAgICBQb3NpdGlvbk1hbmFnZWRPYmplY3RbXVxuICAgID47XG4gIH1cblxuICBhc3luYyBnZXRQb3NpdGlvbk1Pc0Zyb21Cb3VuZENvdW50KFxuICAgIGJvdW5kOiBMLkxhdExuZ0JvdW5kcyxcbiAgICBieUdyb3VwSWRNTz86IElNYW5hZ2VkT2JqZWN0XG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UG9zaXRpb25NT3NGcm9tQm91bmQoYm91bmQsIGJ5R3JvdXBJZE1PLCB0cnVlKSBhcyBQcm9taXNlPG51bWJlcj47XG4gIH1cblxuICBhc3luYyBnZXRQb3NpdGlvbkRldmljZXMoKTogUHJvbWlzZTxQb3NpdGlvbk1hbmFnZWRPYmplY3RbXT47XG4gIGFzeW5jIGdldFBvc2l0aW9uRGV2aWNlcyhwYWdlU2l6ZTogbnVtYmVyKTogUHJvbWlzZTxQb3NpdGlvbk1hbmFnZWRPYmplY3RbXT47XG4gIGFzeW5jIGdldFBvc2l0aW9uRGV2aWNlcyhwYWdlU2l6ZTogbnVtYmVyLCBjb3VudDogZmFsc2UpOiBQcm9taXNlPFBvc2l0aW9uTWFuYWdlZE9iamVjdFtdPjtcbiAgYXN5bmMgZ2V0UG9zaXRpb25EZXZpY2VzKHBhZ2VTaXplOiBudW1iZXIsIGNvdW50OiB0cnVlKTogUHJvbWlzZTxudW1iZXI+O1xuICBhc3luYyBnZXRQb3NpdGlvbkRldmljZXMoXG4gICAgcGFnZVNpemUgPSB0aGlzLk1BWF9ERVZJQ0VfUEVSX0NMVVNURVIsXG4gICAgY291bnQ/OiBib29sZWFuXG4gICk6IFByb21pc2U8bnVtYmVyIHwgUG9zaXRpb25NYW5hZ2VkT2JqZWN0W10+IHtcbiAgICBjb25zdCB7IHBhZ2luZywgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdCh7XG4gICAgICBwYWdlU2l6ZTogY291bnQgPyAxIDogcGFnZVNpemUsXG4gICAgICB3aXRoVG90YWxQYWdlczogY291bnQsXG4gICAgICBxdWVyeTogJyRmaWx0ZXI9aGFzKGM4eV9Qb3NpdGlvbikgYW5kIGhhcyhjOHlfSXNEZXZpY2UpJ1xuICAgIH0pO1xuICAgIGlmIChjb3VudCkge1xuICAgICAgcmV0dXJuIHBhZ2luZy50b3RhbFBhZ2VzO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YSBhcyBQb3NpdGlvbk1hbmFnZWRPYmplY3RbXTtcbiAgfVxuXG4gIGFzeW5jIGdldFBvc2l0aW9uTU9zRnJvbUJvdW5kKGJvdW5kOiBMLkxhdExuZ0JvdW5kcyk6IFByb21pc2U8UG9zaXRpb25NYW5hZ2VkT2JqZWN0W10+O1xuICBhc3luYyBnZXRQb3NpdGlvbk1Pc0Zyb21Cb3VuZChcbiAgICBib3VuZDogTC5MYXRMbmdCb3VuZHMsXG4gICAgYnlHcm91cElkTU8/OiBJTWFuYWdlZE9iamVjdFxuICApOiBQcm9taXNlPFBvc2l0aW9uTWFuYWdlZE9iamVjdFtdPjtcbiAgYXN5bmMgZ2V0UG9zaXRpb25NT3NGcm9tQm91bmQoXG4gICAgYm91bmQ6IEwuTGF0TG5nQm91bmRzLFxuICAgIGJ5R3JvdXBJZE1POiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb3VudDogZmFsc2VcbiAgKTogUHJvbWlzZTxQb3NpdGlvbk1hbmFnZWRPYmplY3RbXT47XG4gIGFzeW5jIGdldFBvc2l0aW9uTU9zRnJvbUJvdW5kKFxuICAgIGJvdW5kOiBMLkxhdExuZ0JvdW5kcyxcbiAgICBieUdyb3VwSWRNTzogSU1hbmFnZWRPYmplY3QsXG4gICAgY291bnQ6IHRydWVcbiAgKTogUHJvbWlzZTxudW1iZXI+O1xuICBhc3luYyBnZXRQb3NpdGlvbk1Pc0Zyb21Cb3VuZChcbiAgICBib3VuZDogTC5MYXRMbmdCb3VuZHMsXG4gICAgYnlHcm91cElkTU8/OiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb3VudCA9IGZhbHNlXG4gICk6IFByb21pc2U8UG9zaXRpb25NYW5hZ2VkT2JqZWN0W10gfCBudW1iZXI+IHtcbiAgICBjb25zdCB7IGxhdDogbGF0TWluLCBsbmc6IGxuZ01pbiB9ID0gYm91bmQuZ2V0U291dGhXZXN0KCk7XG4gICAgY29uc3QgeyBsYXQ6IGxhdE1heCwgbG5nOiBsbmdNYXggfSA9IGJvdW5kLmdldE5vcnRoRWFzdCgpO1xuICAgIGNvbnN0IGJ5R3JvdXBJZEZpbHRlciA9IGJ5R3JvdXBJZE1PXG4gICAgICA/IGAoYnlncm91cGlkKCR7YnlHcm91cElkTU8uaWR9KSBvciBpZCBlcSAnJHtieUdyb3VwSWRNTy5pZH0nKSBhbmQgYFxuICAgICAgOiAnJztcbiAgICBjb25zdCBib3VuZEZpbHRlciA9IGAkZmlsdGVyPSR7YnlHcm91cElkRmlsdGVyfWhhcyhjOHlfUG9zaXRpb24pIGFuZCBjOHlfUG9zaXRpb24ubG5nIGd0ICR7bG5nTWlufWQgYW5kIGM4eV9Qb3NpdGlvbi5sYXQgZ3QgJHtsYXRNaW59ZCBhbmQgYzh5X1Bvc2l0aW9uLmxuZyBsdCAke2xuZ01heH1kIGFuZCBjOHlfUG9zaXRpb24ubGF0IGx0ICR7bGF0TWF4fWRgO1xuICAgIGNvbnN0IHsgcGFnaW5nLCBkYXRhIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeS5saXN0KHtcbiAgICAgIHBhZ2VTaXplOiBjb3VudCA/IDEgOiB0aGlzLk1BWF9ERVZJQ0VfUEVSX0NMVVNURVIsXG4gICAgICB3aXRoVG90YWxQYWdlczogY291bnQsXG4gICAgICBxdWVyeTogYm91bmRGaWx0ZXJcbiAgICB9KTtcbiAgICBpZiAoY291bnQpIHtcbiAgICAgIHJldHVybiBwYWdpbmcudG90YWxQYWdlcztcbiAgICB9XG4gICAgcmV0dXJuIGRhdGEgYXMgUG9zaXRpb25NYW5hZ2VkT2JqZWN0W107XG4gIH1cblxuICBhc3luYyBnZXRBbGxQb3NpdGlvbnNNT3MoXG4gICAgYnlHcm91cElkTU8/OiBJTWFuYWdlZE9iamVjdCxcbiAgICBwYWdlU2l6ZSA9IDUwMFxuICApOiBQcm9taXNlPElSZXN1bHRMaXN0PFBvc2l0aW9uTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBmaWx0ZXI6IHsgcGFnZVNpemU6IG51bWJlcjsgd2l0aFRvdGFsUGFnZXM6IGJvb2xlYW47IHF1ZXJ5OiBzdHJpbmcgfSA9IHtcbiAgICAgIHBhZ2VTaXplLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICBxdWVyeTogJ2hhcyhjOHlfUG9zaXRpb24pJ1xuICAgIH07XG5cbiAgICBpZiAoYnlHcm91cElkTU8pIHtcbiAgICAgIGZpbHRlci5xdWVyeSA9IGAkZmlsdGVyPShieWdyb3VwaWQoJHtieUdyb3VwSWRNTy5pZH0pIG9yIGlkIGVxICcke2J5R3JvdXBJZE1PLmlkfScpIGFuZCBoYXMoYzh5X1Bvc2l0aW9uKWA7XG4gICAgfVxuXG4gICAgY29uc3QgeyBwYWdpbmcsIGRhdGEsIHJlcyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdChmaWx0ZXIpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlcyxcbiAgICAgIHBhZ2luZzogcGFnaW5nIGFzIFBhZ2luZzxQb3NpdGlvbk1hbmFnZWRPYmplY3Q+LFxuICAgICAgZGF0YTogZGF0YSBhcyBQb3NpdGlvbk1hbmFnZWRPYmplY3RbXVxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRDbHVzdGVyU2l6ZShib3VuZDogTC5MYXRMbmdCb3VuZHMpIHtcbiAgICBjb25zdCBjb3VudCA9IGF3YWl0IHRoaXMuZ2V0UG9zaXRpb25NT3NGcm9tQm91bmRDb3VudChib3VuZCk7XG4gICAgbGV0IGNsdXN0ZXJTaXplID0gQ2x1c3RlclNpemUuTk9ORTtcbiAgICBpZiAoY291bnQgPiB0aGlzLkNMVVNURVJfTEVWRUxfVEhSRVNIT0xEKSB7XG4gICAgICBjbHVzdGVyU2l6ZSA9IENsdXN0ZXJTaXplLlNJWFRFRU47XG4gICAgfSBlbHNlIGlmIChjb3VudCA+IHRoaXMuTUFYX0RFVklDRV9QRVJfQ0xVU1RFUikge1xuICAgICAgY2x1c3RlclNpemUgPSBDbHVzdGVyU2l6ZS5GT1VSO1xuICAgIH1cbiAgICByZXR1cm4gY2x1c3RlclNpemU7XG4gIH1cbn1cbiJdfQ==