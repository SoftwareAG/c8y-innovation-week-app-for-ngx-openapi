import { Injectable } from '@angular/core';
import { InventoryService } from '@c8y/client';
import { flatten, pick } from 'lodash';
import { DynamicBulkIIdentifiedResolver } from './abstract-id-resolver';
import { DynamicResolverService } from './dynamic-resolver.service';
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-resolver.service";
import * as i2 from "@c8y/client";
/**
 * A DynamicDetailsResolver responsible to resolve managedObjects for dynamic components.
 * This service implements bulk resolving. This reduces the number of requests made to
 * the backend by querying multiple managedObjectIds in a single request.
 */
export class DynamicManagedObjectResolver extends DynamicBulkIIdentifiedResolver {
    constructor(dynamicResolver, inventory) {
        super(dynamicResolver);
        this.dynamicResolver = dynamicResolver;
        this.inventory = inventory;
        this.typeForErrorMessage = 'managedObject';
        this.maxNumberOfManagedObjectsPerRequest = 50;
        this.queryFilter = {};
    }
    performBulkRequest(uniqIds, bulkRequestId) {
        return this.loadManagedObjectsInChunks(uniqIds, bulkRequestId);
    }
    async loadManagedObjectsInChunks(uniqIds, bulkRequestId) {
        if (!uniqIds.length) {
            return { result: [], bulkRequestId, errors: [] };
        }
        const promiseArray = new Array();
        while (uniqIds.length) {
            const idsToProcess = uniqIds.splice(0, this.maxNumberOfManagedObjectsPerRequest);
            promiseArray.push(this.loadAChunkOfManagedObjects(idsToProcess));
        }
        const result = await Promise.all(promiseArray);
        const managedObjects = flatten(result.map(tmp => tmp.managedObjects));
        const errors = flatten(result.map(tmp => tmp.errors));
        return { result: managedObjects, bulkRequestId, errors };
    }
    async loadAChunkOfManagedObjects(uniqIds) {
        const { data: managedObjects } = await this.inventory.list(Object.assign({}, this.queryFilter || {}, {
            ids: uniqIds.join(),
            pageSize: this.maxNumberOfManagedObjectsPerRequest
        }));
        const notFoundMOs = uniqIds.filter(id => !managedObjects.find(tmp => tmp.id === id));
        if (notFoundMOs.length) {
            const promArray = notFoundMOs.map(id => this.getStatusDetails(id));
            const res = await Promise.all(promArray);
            return { managedObjects, errors: res };
        }
        return { managedObjects, errors: [] };
    }
    async getStatusDetails(moId) {
        try {
            const res = await this.inventory.detail(moId);
            return { id: moId, ...pick(res.res, ['status', 'statusText']) };
        }
        catch (e) {
            return { id: moId, ...pick(e.res, ['status', 'statusText']) };
        }
    }
}
DynamicManagedObjectResolver.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicManagedObjectResolver, deps: [{ token: i1.DynamicResolverService }, { token: i2.InventoryService }], target: i0.ɵɵFactoryTarget.Injectable });
DynamicManagedObjectResolver.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicManagedObjectResolver, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicManagedObjectResolver, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.DynamicResolverService }, { type: i2.InventoryService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlZE9iamVjdC1yZXNvbHZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvZHluYW1pYy1jb21wb25lbnQvbWFuYWdlZE9iamVjdC1yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBa0IsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFHdkMsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7QUFFcEU7Ozs7R0FJRztBQUVILE1BQU0sT0FBTyw0QkFBNkIsU0FBUSw4QkFBOEM7SUFLOUYsWUFDWSxlQUF1QyxFQUN2QyxTQUEyQjtRQUVyQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7UUFIYixvQkFBZSxHQUFmLGVBQWUsQ0FBd0I7UUFDdkMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFON0Isd0JBQW1CLEdBQUcsZUFBZSxDQUFDO1FBQzdCLHdDQUFtQyxHQUFHLEVBQUUsQ0FBQztRQUNsRCxnQkFBVyxHQUFRLEVBQUUsQ0FBQztJQU9oQyxDQUFDO0lBRVMsa0JBQWtCLENBQzFCLE9BQWlCLEVBQ2pCLGFBQXFCO1FBWXJCLE9BQU8sSUFBSSxDQUFDLDBCQUEwQixDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRVMsS0FBSyxDQUFDLDBCQUEwQixDQUN4QyxPQUFpQixFQUNqQixhQUFxQjtRQU1yQixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNuQixPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDO1NBQ2xEO1FBQ0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxLQUFLLEVBRTNCLENBQUM7UUFDSixPQUFPLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFDckIsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLENBQUM7WUFDakYsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztTQUNsRTtRQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMvQyxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFFdEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBQzNELENBQUM7SUFFUyxLQUFLLENBQUMsMEJBQTBCLENBQ3hDLE9BQWlCO1FBRWpCLE1BQU0sRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDeEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLFdBQVcsSUFBSSxFQUFFLEVBQUU7WUFDeEMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDbkIsUUFBUSxFQUFFLElBQUksQ0FBQyxtQ0FBbUM7U0FDbkQsQ0FBQyxDQUNILENBQUM7UUFFRixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUN0QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkUsTUFBTSxHQUFHLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDO1NBQ3hDO1FBRUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVTLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFZO1FBQzNDLElBQUk7WUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLE9BQU8sRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDO1NBQ2pFO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDLEVBQUUsQ0FBQztTQUMvRDtJQUNILENBQUM7O3lIQWxGVSw0QkFBNEI7NkhBQTVCLDRCQUE0QixjQURmLE1BQU07MkZBQ25CLDRCQUE0QjtrQkFEeEMsVUFBVTttQkFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGZsYXR0ZW4sIHBpY2sgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRHluYW1pY0J1bGtSZXRyaWV2YWxFcnJvciB9IGZyb20gJy4vZHluYW1pYy1idWxrLXJldHJpZXZhbC1lcnJvci5tb2RlbCc7XG5pbXBvcnQgeyBEeW5hbWljQnVsa0lJZGVudGlmaWVkUmVzb2x2ZXIgfSBmcm9tICcuL2Fic3RyYWN0LWlkLXJlc29sdmVyJztcbmltcG9ydCB7IER5bmFtaWNSZXNvbHZlclNlcnZpY2UgfSBmcm9tICcuL2R5bmFtaWMtcmVzb2x2ZXIuc2VydmljZSc7XG5cbi8qKlxuICogQSBEeW5hbWljRGV0YWlsc1Jlc29sdmVyIHJlc3BvbnNpYmxlIHRvIHJlc29sdmUgbWFuYWdlZE9iamVjdHMgZm9yIGR5bmFtaWMgY29tcG9uZW50cy5cbiAqIFRoaXMgc2VydmljZSBpbXBsZW1lbnRzIGJ1bGsgcmVzb2x2aW5nLiBUaGlzIHJlZHVjZXMgdGhlIG51bWJlciBvZiByZXF1ZXN0cyBtYWRlIHRvXG4gKiB0aGUgYmFja2VuZCBieSBxdWVyeWluZyBtdWx0aXBsZSBtYW5hZ2VkT2JqZWN0SWRzIGluIGEgc2luZ2xlIHJlcXVlc3QuXG4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRHluYW1pY01hbmFnZWRPYmplY3RSZXNvbHZlciBleHRlbmRzIER5bmFtaWNCdWxrSUlkZW50aWZpZWRSZXNvbHZlcjxJTWFuYWdlZE9iamVjdD4ge1xuICBwcm90ZWN0ZWQgdHlwZUZvckVycm9yTWVzc2FnZSA9ICdtYW5hZ2VkT2JqZWN0JztcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IG1heE51bWJlck9mTWFuYWdlZE9iamVjdHNQZXJSZXF1ZXN0ID0gNTA7XG4gIHByb3RlY3RlZCBxdWVyeUZpbHRlcjogYW55ID0ge307XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGR5bmFtaWNSZXNvbHZlcjogRHluYW1pY1Jlc29sdmVyU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaW52ZW50b3J5OiBJbnZlbnRvcnlTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKGR5bmFtaWNSZXNvbHZlcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGVyZm9ybUJ1bGtSZXF1ZXN0KFxuICAgIHVuaXFJZHM6IHN0cmluZ1tdLFxuICAgIGJ1bGtSZXF1ZXN0SWQ6IG51bWJlclxuICApOlxuICAgIHwgUHJvbWlzZTx7XG4gICAgICAgIHJlc3VsdDogSU1hbmFnZWRPYmplY3RbXTtcbiAgICAgICAgYnVsa1JlcXVlc3RJZDogbnVtYmVyO1xuICAgICAgICBlcnJvcnM6IER5bmFtaWNCdWxrUmV0cmlldmFsRXJyb3JbXTtcbiAgICAgIH0+XG4gICAgfCBPYnNlcnZhYmxlPHtcbiAgICAgICAgcmVzdWx0OiBJTWFuYWdlZE9iamVjdFtdO1xuICAgICAgICBidWxrUmVxdWVzdElkOiBudW1iZXI7XG4gICAgICAgIGVycm9yczogRHluYW1pY0J1bGtSZXRyaWV2YWxFcnJvcltdO1xuICAgICAgfT4ge1xuICAgIHJldHVybiB0aGlzLmxvYWRNYW5hZ2VkT2JqZWN0c0luQ2h1bmtzKHVuaXFJZHMsIGJ1bGtSZXF1ZXN0SWQpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIGxvYWRNYW5hZ2VkT2JqZWN0c0luQ2h1bmtzKFxuICAgIHVuaXFJZHM6IHN0cmluZ1tdLFxuICAgIGJ1bGtSZXF1ZXN0SWQ6IG51bWJlclxuICApOiBQcm9taXNlPHtcbiAgICByZXN1bHQ6IElNYW5hZ2VkT2JqZWN0W107XG4gICAgYnVsa1JlcXVlc3RJZDogbnVtYmVyO1xuICAgIGVycm9yczogRHluYW1pY0J1bGtSZXRyaWV2YWxFcnJvcltdO1xuICB9PiB7XG4gICAgaWYgKCF1bmlxSWRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHsgcmVzdWx0OiBbXSwgYnVsa1JlcXVlc3RJZCwgZXJyb3JzOiBbXSB9O1xuICAgIH1cbiAgICBjb25zdCBwcm9taXNlQXJyYXkgPSBuZXcgQXJyYXk8XG4gICAgICBQcm9taXNlPHsgbWFuYWdlZE9iamVjdHM6IElNYW5hZ2VkT2JqZWN0W107IGVycm9yczogRHluYW1pY0J1bGtSZXRyaWV2YWxFcnJvcltdIH0+XG4gICAgPigpO1xuICAgIHdoaWxlICh1bmlxSWRzLmxlbmd0aCkge1xuICAgICAgY29uc3QgaWRzVG9Qcm9jZXNzID0gdW5pcUlkcy5zcGxpY2UoMCwgdGhpcy5tYXhOdW1iZXJPZk1hbmFnZWRPYmplY3RzUGVyUmVxdWVzdCk7XG4gICAgICBwcm9taXNlQXJyYXkucHVzaCh0aGlzLmxvYWRBQ2h1bmtPZk1hbmFnZWRPYmplY3RzKGlkc1RvUHJvY2VzcykpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VBcnJheSk7XG4gICAgY29uc3QgbWFuYWdlZE9iamVjdHMgPSBmbGF0dGVuKHJlc3VsdC5tYXAodG1wID0+IHRtcC5tYW5hZ2VkT2JqZWN0cykpO1xuICAgIGNvbnN0IGVycm9ycyA9IGZsYXR0ZW4ocmVzdWx0Lm1hcCh0bXAgPT4gdG1wLmVycm9ycykpO1xuXG4gICAgcmV0dXJuIHsgcmVzdWx0OiBtYW5hZ2VkT2JqZWN0cywgYnVsa1JlcXVlc3RJZCwgZXJyb3JzIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgbG9hZEFDaHVua09mTWFuYWdlZE9iamVjdHMoXG4gICAgdW5pcUlkczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTx7IG1hbmFnZWRPYmplY3RzOiBJTWFuYWdlZE9iamVjdFtdOyBlcnJvcnM6IER5bmFtaWNCdWxrUmV0cmlldmFsRXJyb3JbXSB9PiB7XG4gICAgY29uc3QgeyBkYXRhOiBtYW5hZ2VkT2JqZWN0cyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnkubGlzdChcbiAgICAgIE9iamVjdC5hc3NpZ24oe30sIHRoaXMucXVlcnlGaWx0ZXIgfHwge30sIHtcbiAgICAgICAgaWRzOiB1bmlxSWRzLmpvaW4oKSxcbiAgICAgICAgcGFnZVNpemU6IHRoaXMubWF4TnVtYmVyT2ZNYW5hZ2VkT2JqZWN0c1BlclJlcXVlc3RcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IG5vdEZvdW5kTU9zID0gdW5pcUlkcy5maWx0ZXIoaWQgPT4gIW1hbmFnZWRPYmplY3RzLmZpbmQodG1wID0+IHRtcC5pZCA9PT0gaWQpKTtcbiAgICBpZiAobm90Rm91bmRNT3MubGVuZ3RoKSB7XG4gICAgICBjb25zdCBwcm9tQXJyYXkgPSBub3RGb3VuZE1Pcy5tYXAoaWQgPT4gdGhpcy5nZXRTdGF0dXNEZXRhaWxzKGlkKSk7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9tQXJyYXkpO1xuICAgICAgcmV0dXJuIHsgbWFuYWdlZE9iamVjdHMsIGVycm9yczogcmVzIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgbWFuYWdlZE9iamVjdHMsIGVycm9yczogW10gfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBnZXRTdGF0dXNEZXRhaWxzKG1vSWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwobW9JZCk7XG4gICAgICByZXR1cm4geyBpZDogbW9JZCwgLi4ucGljayhyZXMucmVzLCBbJ3N0YXR1cycsICdzdGF0dXNUZXh0J10pIH07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIHsgaWQ6IG1vSWQsIC4uLnBpY2soZS5yZXMsIFsnc3RhdHVzJywgJ3N0YXR1c1RleHQnXSkgfTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==