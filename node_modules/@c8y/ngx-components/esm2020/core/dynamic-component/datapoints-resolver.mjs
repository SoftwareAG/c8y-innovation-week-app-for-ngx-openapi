import { Injectable } from '@angular/core';
import { pick } from 'lodash-es';
import { map } from 'rxjs/operators';
import { DynamicManagedObjectResolver } from './managedObject-resolver';
import * as i0 from "@angular/core";
import * as i1 from "./managedObject-resolver";
/**
 * A DynamicDetailsResolver responsible to resolve configured datapoints for dynamic components.
 * This service implements bulk resolving and uses the DynamicManagedObjectResolver in the background.
 * It will update the datapoint details with the current values from the datapoint library and
 * also updates the target of the datapoint in case e.g. the name changed.
 */
export class DynamicDatapointsResolver {
    constructor(moResolver) {
        this.moResolver = moResolver;
    }
    resolve(config, attribute, bulkRequestId) {
        const datapoints = config[attribute];
        if (!datapoints || !Array.isArray(datapoints) || !datapoints.length) {
            return [];
        }
        const templateIds = datapoints.filter(dp => !!dp.__template).map(dp => `${dp.__template}`);
        const targetIds = datapoints.filter(dp => !!dp.__target?.id).map(dp => `${dp.__target?.id}`);
        const moIds = [...templateIds, ...targetIds];
        this.moResolver.addIdsToBeLoaded(bulkRequestId, ...moIds);
        return this.moResolver
            .getResult$(bulkRequestId)
            .pipe(map(({ result: updatedMos, errors: _errors }) => this.assignUpdatedValues(datapoints, updatedMos)));
    }
    serialize(config, attribute) {
        const valueBehindAttribute = config[attribute];
        if (!Array.isArray(valueBehindAttribute)) {
            return config[attribute];
        }
        valueBehindAttribute.forEach(value => {
            if (value.__target) {
                value.__target = pick(value.__target, ['id', 'name']);
            }
        });
        return valueBehindAttribute;
    }
    assignUpdatedValues(oldDatapoints, currentManagedObjects) {
        return oldDatapoints.map(dp => this.assignUpdatedValuesToSingleDatapoint(dp, currentManagedObjects));
    }
    assignUpdatedValuesToSingleDatapoint(datapoint, currentManagedObjects) {
        if (datapoint.__template) {
            const foundUpdatedDp = currentManagedObjects.find(mo => mo.id === datapoint.__template || mo.id === `${datapoint.__template}`);
            if (!foundUpdatedDp) {
                return datapoint;
            }
            const updatedDatapoint = Object.assign({}, foundUpdatedDp.c8y_Kpi, {
                __template: foundUpdatedDp.id
            });
            Object.assign(datapoint, updatedDatapoint);
        }
        if (datapoint.__target?.id) {
            const foundUpdatedTarget = currentManagedObjects.find(mo => mo.id === datapoint.__target?.id || mo.id === `${datapoint.__target?.id}`);
            if (foundUpdatedTarget) {
                Object.assign(datapoint.__target, foundUpdatedTarget);
            }
        }
        return datapoint;
    }
}
DynamicDatapointsResolver.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicDatapointsResolver, deps: [{ token: i1.DynamicManagedObjectResolver }], target: i0.ɵɵFactoryTarget.Injectable });
DynamicDatapointsResolver.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicDatapointsResolver, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicDatapointsResolver, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.DynamicManagedObjectResolver }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXBvaW50cy1yZXNvbHZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvZHluYW1pYy1jb21wb25lbnQvZGF0YXBvaW50cy1yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFakMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7QUFFeEU7Ozs7O0dBS0c7QUFFSCxNQUFNLE9BQU8seUJBQXlCO0lBQ3BDLFlBQXNCLFVBQXdDO1FBQXhDLGVBQVUsR0FBVixVQUFVLENBQThCO0lBQUcsQ0FBQztJQUVsRSxPQUFPLENBQ0wsTUFBVyxFQUNYLFNBQWlCLEVBQ2pCLGFBQXFCO1FBRXJCLE1BQU0sVUFBVSxHQUFVLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUU7WUFDbkUsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDM0YsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FB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LE1BQU07MkZBQ25CLHlCQUF5QjtrQkFEckMsVUFBVTttQkFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IHBpY2sgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRHluYW1pY0RldGFpbHNSZXNvbHZlciB9IGZyb20gJy4vZHluYW1pYy1kZXRhaWxzLXJlc29sdmVyJztcbmltcG9ydCB7IER5bmFtaWNNYW5hZ2VkT2JqZWN0UmVzb2x2ZXIgfSBmcm9tICcuL21hbmFnZWRPYmplY3QtcmVzb2x2ZXInO1xuXG4vKipcbiAqIEEgRHluYW1pY0RldGFpbHNSZXNvbHZlciByZXNwb25zaWJsZSB0byByZXNvbHZlIGNvbmZpZ3VyZWQgZGF0YXBvaW50cyBmb3IgZHluYW1pYyBjb21wb25lbnRzLlxuICogVGhpcyBzZXJ2aWNlIGltcGxlbWVudHMgYnVsayByZXNvbHZpbmcgYW5kIHVzZXMgdGhlIER5bmFtaWNNYW5hZ2VkT2JqZWN0UmVzb2x2ZXIgaW4gdGhlIGJhY2tncm91bmQuXG4gKiBJdCB3aWxsIHVwZGF0ZSB0aGUgZGF0YXBvaW50IGRldGFpbHMgd2l0aCB0aGUgY3VycmVudCB2YWx1ZXMgZnJvbSB0aGUgZGF0YXBvaW50IGxpYnJhcnkgYW5kXG4gKiBhbHNvIHVwZGF0ZXMgdGhlIHRhcmdldCBvZiB0aGUgZGF0YXBvaW50IGluIGNhc2UgZS5nLiB0aGUgbmFtZSBjaGFuZ2VkLlxuICovXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIER5bmFtaWNEYXRhcG9pbnRzUmVzb2x2ZXIgaW1wbGVtZW50cyBEeW5hbWljRGV0YWlsc1Jlc29sdmVyIHtcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIG1vUmVzb2x2ZXI6IER5bmFtaWNNYW5hZ2VkT2JqZWN0UmVzb2x2ZXIpIHt9XG5cbiAgcmVzb2x2ZShcbiAgICBjb25maWc6IGFueSxcbiAgICBhdHRyaWJ1dGU6IHN0cmluZyxcbiAgICBidWxrUmVxdWVzdElkOiBudW1iZXJcbiAgKTogYW55W10gfCBQcm9taXNlPGFueVtdPiB8IE9ic2VydmFibGU8YW55W10+IHtcbiAgICBjb25zdCBkYXRhcG9pbnRzOiBhbnlbXSA9IGNvbmZpZ1thdHRyaWJ1dGVdO1xuICAgIGlmICghZGF0YXBvaW50cyB8fCAhQXJyYXkuaXNBcnJheShkYXRhcG9pbnRzKSB8fCAhZGF0YXBvaW50cy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZUlkcyA9IGRhdGFwb2ludHMuZmlsdGVyKGRwID0+ICEhZHAuX190ZW1wbGF0ZSkubWFwKGRwID0+IGAke2RwLl9fdGVtcGxhdGV9YCk7XG4gICAgY29uc3QgdGFyZ2V0SWRzID0gZGF0YXBvaW50cy5maWx0ZXIoZHAgPT4gISFkcC5fX3RhcmdldD8uaWQpLm1hcChkcCA9PiBgJHtkcC5fX3RhcmdldD8uaWR9YCk7XG4gICAgY29uc3QgbW9JZHMgPSBbLi4udGVtcGxhdGVJZHMsIC4uLnRhcmdldElkc107XG5cbiAgICB0aGlzLm1vUmVzb2x2ZXIuYWRkSWRzVG9CZUxvYWRlZChidWxrUmVxdWVzdElkLCAuLi5tb0lkcyk7XG5cbiAgICByZXR1cm4gdGhpcy5tb1Jlc29sdmVyXG4gICAgICAuZ2V0UmVzdWx0JChidWxrUmVxdWVzdElkKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoeyByZXN1bHQ6IHVwZGF0ZWRNb3MsIGVycm9yczogX2Vycm9ycyB9KSA9PlxuICAgICAgICAgIHRoaXMuYXNzaWduVXBkYXRlZFZhbHVlcyhkYXRhcG9pbnRzLCB1cGRhdGVkTW9zKVxuICAgICAgICApXG4gICAgICApO1xuICB9XG5cbiAgc2VyaWFsaXplKGNvbmZpZzogYW55LCBhdHRyaWJ1dGU6IHN0cmluZykge1xuICAgIGNvbnN0IHZhbHVlQmVoaW5kQXR0cmlidXRlOiBhbnlbXSA9IGNvbmZpZ1thdHRyaWJ1dGVdO1xuICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZUJlaGluZEF0dHJpYnV0ZSkpIHtcbiAgICAgIHJldHVybiBjb25maWdbYXR0cmlidXRlXTtcbiAgICB9XG4gICAgdmFsdWVCZWhpbmRBdHRyaWJ1dGUuZm9yRWFjaCh2YWx1ZSA9PiB7XG4gICAgICBpZiAodmFsdWUuX190YXJnZXQpIHtcbiAgICAgICAgdmFsdWUuX190YXJnZXQgPSBwaWNrKHZhbHVlLl9fdGFyZ2V0LCBbJ2lkJywgJ25hbWUnXSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHZhbHVlQmVoaW5kQXR0cmlidXRlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzc2lnblVwZGF0ZWRWYWx1ZXMoXG4gICAgb2xkRGF0YXBvaW50czogYW55W10sXG4gICAgY3VycmVudE1hbmFnZWRPYmplY3RzOiBJTWFuYWdlZE9iamVjdFtdXG4gICk6IGFueVtdIHtcbiAgICByZXR1cm4gb2xkRGF0YXBvaW50cy5tYXAoZHAgPT5cbiAgICAgIHRoaXMuYXNzaWduVXBkYXRlZFZhbHVlc1RvU2luZ2xlRGF0YXBvaW50KGRwLCBjdXJyZW50TWFuYWdlZE9iamVjdHMpXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3NpZ25VcGRhdGVkVmFsdWVzVG9TaW5nbGVEYXRhcG9pbnQoXG4gICAgZGF0YXBvaW50OiBhbnksXG4gICAgY3VycmVudE1hbmFnZWRPYmplY3RzOiBJTWFuYWdlZE9iamVjdFtdXG4gICk6IGFueSB7XG4gICAgaWYgKGRhdGFwb2ludC5fX3RlbXBsYXRlKSB7XG4gICAgICBjb25zdCBmb3VuZFVwZGF0ZWREcCA9IGN1cnJlbnRNYW5hZ2VkT2JqZWN0cy5maW5kKFxuICAgICAgICBtbyA9PiBtby5pZCA9PT0gZGF0YXBvaW50Ll9fdGVtcGxhdGUgfHwgbW8uaWQgPT09IGAke2RhdGFwb2ludC5fX3RlbXBsYXRlfWBcbiAgICAgICk7XG4gICAgICBpZiAoIWZvdW5kVXBkYXRlZERwKSB7XG4gICAgICAgIHJldHVybiBkYXRhcG9pbnQ7XG4gICAgICB9XG4gICAgICBjb25zdCB1cGRhdGVkRGF0YXBvaW50ID0gT2JqZWN0LmFzc2lnbih7fSwgZm91bmRVcGRhdGVkRHAuYzh5X0twaSwge1xuICAgICAgICBfX3RlbXBsYXRlOiBmb3VuZFVwZGF0ZWREcC5pZFxuICAgICAgfSk7XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oZGF0YXBvaW50LCB1cGRhdGVkRGF0YXBvaW50KTtcbiAgICB9XG5cbiAgICBpZiAoZGF0YXBvaW50Ll9fdGFyZ2V0Py5pZCkge1xuICAgICAgY29uc3QgZm91bmRVcGRhdGVkVGFyZ2V0ID0gY3VycmVudE1hbmFnZWRPYmplY3RzLmZpbmQoXG4gICAgICAgIG1vID0+IG1vLmlkID09PSBkYXRhcG9pbnQuX190YXJnZXQ/LmlkIHx8IG1vLmlkID09PSBgJHtkYXRhcG9pbnQuX190YXJnZXQ/LmlkfWBcbiAgICAgICk7XG4gICAgICBpZiAoZm91bmRVcGRhdGVkVGFyZ2V0KSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZGF0YXBvaW50Ll9fdGFyZ2V0LCBmb3VuZFVwZGF0ZWRUYXJnZXQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGF0YXBvaW50O1xuICB9XG59XG4iXX0=