import { Injectable, Injector } from '@angular/core';
import { set } from 'lodash';
import { Observable, Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class DynamicResolverService {
    constructor(injector) {
        this.injector = injector;
        this._triggerBulkResolving = new Subject();
        this.requestId = 0;
        this.bulkResolvingTrigger$ = this._triggerBulkResolving.asObservable();
    }
    async executeResolvers(details, dynamicDef) {
        const requestId = this.getRequestId();
        const res = dynamicDef.map((def, index) => this.executeResolversForSingleComponent(def, details[index].config, requestId));
        const promise = this.waitForResults(res);
        this.triggerResolving(requestId);
        return await promise;
    }
    serialize(details, dynamicDef) {
        return dynamicDef.map((def, index) => {
            return this.serializeSingleComponent(def, details[index].config);
        });
    }
    serializeSingleComponent(dynamicDef, config) {
        const res = {};
        if (!dynamicDef?.resolve) {
            return res;
        }
        Object.entries(dynamicDef.resolve).forEach(([key, value]) => {
            try {
                const resolver = this.injector.get(value, null);
                if (resolver && resolver.serialize) {
                    res[key] = resolver.serialize(config, key);
                }
                else {
                    console.warn(`DynamicDetailsResolver: "${value}" not found or does not implement serialize method.`);
                }
            }
            catch {
                console.warn(`Failed to serialize key: "${key}" for dynamic component: "${dynamicDef.id}"`);
            }
        });
        return res;
    }
    triggerResolving(requestId) {
        this._triggerBulkResolving.next(requestId);
    }
    executeResolversForSingleComponent(dynamicDef, config, requestId) {
        const res = {};
        if (!dynamicDef?.resolve) {
            return res;
        }
        Object.entries(dynamicDef.resolve).forEach(([key, value]) => {
            try {
                const resolver = this.injector.get(value, null);
                if (resolver && resolver.resolve) {
                    res[key] = resolver.resolve(config, key, requestId);
                }
                else {
                    console.warn(`DynamicDetailsResolver: "${value}" not found or does not implement resolve method.`);
                }
            }
            catch {
                console.warn(`Failed to resolve key: "${key}" for dynamic component: "${dynamicDef.id}"`);
            }
        });
        return res;
    }
    async waitForResults(data) {
        return Promise.all(data.map(tmp => this.waitForResultsOfSingleEntry(tmp)));
    }
    async waitForResultsOfSingleEntry(data) {
        const res = {};
        try {
            const arr = await Promise.all(Object.values(data).map(tmp => this.awaitResult(tmp)));
            Object.keys(data).forEach((key, index) => set(res, key, arr[index]));
        }
        catch {
            console.warn(`Failed to to resolve data using dynamic component resolver.`);
        }
        return res;
    }
    async awaitResult(data) {
        try {
            if (data instanceof Promise) {
                return await data;
            }
            if (data instanceof Observable) {
                return await data.toPromise();
            }
            return data;
        }
        catch {
            console.warn(`Failed to to resolve data using dynamic component resolver.`);
            return;
        }
    }
    getRequestId() {
        return this.requestId++;
    }
}
DynamicResolverService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicResolverService, deps: [{ token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable });
DynamicResolverService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicResolverService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DynamicResolverService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i0.Injector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1yZXNvbHZlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9keW5hbWljLWNvbXBvbmVudC9keW5hbWljLXJlc29sdmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUM3QixPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFLM0MsTUFBTSxPQUFPLHNCQUFzQjtJQUtqQyxZQUFvQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBSDlCLDBCQUFxQixHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDOUMsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUdwQixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3pFLENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQ3BCLE9BQW9ELEVBQ3BELFVBQXdDO1FBRXhDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QyxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQ3hDLElBQUksQ0FBQyxrQ0FBa0MsQ0FBTSxHQUFHLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FDcEYsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWpDLE9BQU8sTUFBTSxPQUFPLENBQUM7SUFD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TUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHNldCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEeW5hbWljQ29tcG9uZW50RGVmaW5pdGlvbiB9IGZyb20gJy4vZHluYW1pYy1jb21wb25lbnQubW9kZWwnO1xuaW1wb3J0IHsgRHluYW1pY0RldGFpbHNSZXNvbHZlciB9IGZyb20gJy4vZHluYW1pYy1kZXRhaWxzLXJlc29sdmVyJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljUmVzb2x2ZXJTZXJ2aWNlIHtcbiAgYnVsa1Jlc29sdmluZ1RyaWdnZXIkOiBPYnNlcnZhYmxlPG51bWJlcj47XG4gIHByaXZhdGUgX3RyaWdnZXJCdWxrUmVzb2x2aW5nID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuICBwcml2YXRlIHJlcXVlc3RJZCA9IDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICB0aGlzLmJ1bGtSZXNvbHZpbmdUcmlnZ2VyJCA9IHRoaXMuX3RyaWdnZXJCdWxrUmVzb2x2aW5nLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZVJlc29sdmVycyhcbiAgICBkZXRhaWxzOiBBcnJheTx7IGNvbXBvbmVudElkOiBzdHJpbmc7IGNvbmZpZzogYW55IH0+LFxuICAgIGR5bmFtaWNEZWY6IER5bmFtaWNDb21wb25lbnREZWZpbml0aW9uW11cbiAgKTogUHJvbWlzZTx1bmtub3duW10+IHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSB0aGlzLmdldFJlcXVlc3RJZCgpO1xuICAgIGNvbnN0IHJlcyA9IGR5bmFtaWNEZWYubWFwKChkZWYsIGluZGV4KSA9PlxuICAgICAgdGhpcy5leGVjdXRlUmVzb2x2ZXJzRm9yU2luZ2xlQ29tcG9uZW50PGFueT4oZGVmLCBkZXRhaWxzW2luZGV4XS5jb25maWcsIHJlcXVlc3RJZClcbiAgICApO1xuXG4gICAgY29uc3QgcHJvbWlzZSA9IHRoaXMud2FpdEZvclJlc3VsdHMocmVzKTtcbiAgICB0aGlzLnRyaWdnZXJSZXNvbHZpbmcocmVxdWVzdElkKTtcblxuICAgIHJldHVybiBhd2FpdCBwcm9taXNlO1xuICB9XG5cbiAgc2VyaWFsaXplKFxuICAgIGRldGFpbHM6IEFycmF5PHsgY29tcG9uZW50SWQ6IHN0cmluZzsgY29uZmlnOiBhbnkgfT4sXG4gICAgZHluYW1pY0RlZjogRHluYW1pY0NvbXBvbmVudERlZmluaXRpb25bXVxuICApIHtcbiAgICByZXR1cm4gZHluYW1pY0RlZi5tYXAoKGRlZiwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZVNpbmdsZUNvbXBvbmVudDxhbnk+KGRlZiwgZGV0YWlsc1tpbmRleF0uY29uZmlnKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2VyaWFsaXplU2luZ2xlQ29tcG9uZW50PFQ+KGR5bmFtaWNEZWY6IER5bmFtaWNDb21wb25lbnREZWZpbml0aW9uLCBjb25maWc6IGFueSkge1xuICAgIGNvbnN0IHJlczogeyBba2V5OiBzdHJpbmddOiBQYXJ0aWFsPFQ+IHwgQXJyYXk8UGFydGlhbDxUPj4gfSA9IHt9O1xuICAgIGlmICghZHluYW1pY0RlZj8ucmVzb2x2ZSkge1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gICAgT2JqZWN0LmVudHJpZXMoZHluYW1pY0RlZi5yZXNvbHZlKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpcy5pbmplY3Rvci5nZXQ8RHluYW1pY0RldGFpbHNSZXNvbHZlcjxUPj4odmFsdWUsIG51bGwpO1xuICAgICAgICBpZiAocmVzb2x2ZXIgJiYgcmVzb2x2ZXIuc2VyaWFsaXplKSB7XG4gICAgICAgICAgcmVzW2tleV0gPSByZXNvbHZlci5zZXJpYWxpemUoY29uZmlnLCBrZXkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgIGBEeW5hbWljRGV0YWlsc1Jlc29sdmVyOiBcIiR7dmFsdWV9XCIgbm90IGZvdW5kIG9yIGRvZXMgbm90IGltcGxlbWVudCBzZXJpYWxpemUgbWV0aG9kLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gc2VyaWFsaXplIGtleTogXCIke2tleX1cIiBmb3IgZHluYW1pYyBjb21wb25lbnQ6IFwiJHtkeW5hbWljRGVmLmlkfVwiYCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHByaXZhdGUgdHJpZ2dlclJlc29sdmluZyhyZXF1ZXN0SWQ6IG51bWJlcikge1xuICAgIHRoaXMuX3RyaWdnZXJCdWxrUmVzb2x2aW5nLm5leHQocmVxdWVzdElkKTtcbiAgfVxuXG4gIHByaXZhdGUgZXhlY3V0ZVJlc29sdmVyc0ZvclNpbmdsZUNvbXBvbmVudDxUPihcbiAgICBkeW5hbWljRGVmOiBEeW5hbWljQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgICBjb25maWc6IGFueSxcbiAgICByZXF1ZXN0SWQ6IG51bWJlclxuICApIHtcbiAgICBjb25zdCByZXM6IHsgW2tleTogc3RyaW5nXTogVCB8IFByb21pc2U8VD4gfCBPYnNlcnZhYmxlPFQ+IH0gPSB7fTtcbiAgICBpZiAoIWR5bmFtaWNEZWY/LnJlc29sdmUpIHtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfVxuICAgIE9iamVjdC5lbnRyaWVzKGR5bmFtaWNEZWYucmVzb2x2ZSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNvbHZlciA9IHRoaXMuaW5qZWN0b3IuZ2V0PER5bmFtaWNEZXRhaWxzUmVzb2x2ZXI8YW55Pj4odmFsdWUsIG51bGwpO1xuICAgICAgICBpZiAocmVzb2x2ZXIgJiYgcmVzb2x2ZXIucmVzb2x2ZSkge1xuICAgICAgICAgIHJlc1trZXldID0gcmVzb2x2ZXIucmVzb2x2ZShjb25maWcsIGtleSwgcmVxdWVzdElkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICBgRHluYW1pY0RldGFpbHNSZXNvbHZlcjogXCIke3ZhbHVlfVwiIG5vdCBmb3VuZCBvciBkb2VzIG5vdCBpbXBsZW1lbnQgcmVzb2x2ZSBtZXRob2QuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byByZXNvbHZlIGtleTogXCIke2tleX1cIiBmb3IgZHluYW1pYyBjb21wb25lbnQ6IFwiJHtkeW5hbWljRGVmLmlkfVwiYCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgd2FpdEZvclJlc3VsdHMoXG4gICAgZGF0YTogQXJyYXk8eyBba2V5OiBzdHJpbmddOiB1bmtub3duIHwgUHJvbWlzZTx1bmtub3duPiB8IE9ic2VydmFibGU8dW5rbm93bj4gfT5cbiAgKTogUHJvbWlzZTxhbnlbXT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChkYXRhLm1hcCh0bXAgPT4gdGhpcy53YWl0Rm9yUmVzdWx0c09mU2luZ2xlRW50cnkodG1wKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB3YWl0Rm9yUmVzdWx0c09mU2luZ2xlRW50cnkoZGF0YToge1xuICAgIFtrZXk6IHN0cmluZ106IHVua25vd24gfCBQcm9taXNlPHVua25vd24+IHwgT2JzZXJ2YWJsZTx1bmtub3duPjtcbiAgfSk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcmVzID0ge307XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFyciA9IGF3YWl0IFByb21pc2UuYWxsKE9iamVjdC52YWx1ZXMoZGF0YSkubWFwKHRtcCA9PiB0aGlzLmF3YWl0UmVzdWx0KHRtcCkpKTtcbiAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goKGtleSwgaW5kZXgpID0+IHNldChyZXMsIGtleSwgYXJyW2luZGV4XSkpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gdG8gcmVzb2x2ZSBkYXRhIHVzaW5nIGR5bmFtaWMgY29tcG9uZW50IHJlc29sdmVyLmApO1xuICAgIH1cblxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGF3YWl0UmVzdWx0KFxuICAgIGRhdGE6IHVua25vd24gfCBQcm9taXNlPHVua25vd24+IHwgT2JzZXJ2YWJsZTx1bmtub3duPlxuICApOiBQcm9taXNlPHVua25vd24+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBkYXRhO1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBkYXRhLnRvUHJvbWlzZSgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIGNvbnNvbGUud2FybihgRmFpbGVkIHRvIHRvIHJlc29sdmUgZGF0YSB1c2luZyBkeW5hbWljIGNvbXBvbmVudCByZXNvbHZlci5gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJlcXVlc3RJZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnJlcXVlc3RJZCsrO1xuICB9XG59XG4iXX0=