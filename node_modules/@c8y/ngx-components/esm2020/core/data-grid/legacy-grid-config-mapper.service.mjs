import { Injectable } from '@angular/core';
import { isEmpty, isNil, omitBy } from 'lodash-es';
import { combineLatest, of } from 'rxjs';
import { concatMap, map } from 'rxjs/operators';
import { UserPreferencesService } from '../common/user-preferences/user-preferences.service';
import { DataGridService } from './data-grid.service';
import * as i0 from "@angular/core";
import * as i1 from "../common/user-preferences/user-preferences.service";
import * as i2 from "./data-grid.service";
export class LegacyGridConfigMapperService {
    constructor(userPreferencesService, dataGridService) {
        this.userPreferencesService = userPreferencesService;
        this.dataGridService = dataGridService;
    }
    getMappedGridConfig(context) {
        const legacyAllDevicesGridKey = context.legacyConfigKey;
        const legacyAllDevicesGridFilterKey = context.legacyFilterKey;
        return combineLatest([
            this.userPreferencesService.get(legacyAllDevicesGridKey),
            this.userPreferencesService.get(legacyAllDevicesGridFilterKey)
        ]).pipe(map(([legacyConfig, legacyFilterConfig]) => this.mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig, context.defaultColumns)), concatMap(mappedLegacyConfig => {
            if (mappedLegacyConfig) {
                return Promise.all([
                    this.userPreferencesService.set(legacyAllDevicesGridKey, null),
                    this.userPreferencesService.set(legacyAllDevicesGridFilterKey, null)
                ]).then(() => mappedLegacyConfig);
            }
            else {
                return of(null);
            }
        }), concatMap(mappedLegacyConfig => mappedLegacyConfig
            ? this.userPreferencesService
                .set(context?.key, mappedLegacyConfig)
                .then(() => mappedLegacyConfig)
            : this.userPreferencesService.get(context?.key)), map(config => config || {
            columns: [],
            pagination: {
                pageSize: this.dataGridService.DEFAULT_PAGE_SIZE,
                currentPage: 1
            }
        }));
    }
    mapLegacyToDeviceGridConfig(legacyConfig, legacyFilterConfig, defaultColumns = []) {
        if (Array.isArray(legacyConfig) || !isEmpty(legacyFilterConfig)) {
            return {
                columns: this.getConfigColumns(legacyConfig, legacyFilterConfig, defaultColumns),
                pagination: {
                    pageSize: this.dataGridService.DEFAULT_PAGE_SIZE,
                    currentPage: 1
                }
            };
        }
    }
    getConfigColumns(legacyConfig, legacyFilterConfig, defaultColumns) {
        const legacyFilterConfigArray = legacyFilterConfig
            ? Object.keys(legacyFilterConfig).map(key => ({
                key,
                filter: {
                    externalFilterQuery: legacyFilterConfig[key].filtering
                },
                sorting: legacyFilterConfig[key].sorting
            }))
            : [];
        const config = this.mergeLegacyConfigs(legacyConfig || defaultColumns.map(column => ({ key: column.name })), legacyFilterConfigArray);
        return config
            .filter(column => column.key !== 'removalColumn')
            .map(this.mapLegacyColumnConfig.bind(this));
    }
    mergeLegacyConfigs(columnConfig, filterConfig) {
        return columnConfig.map(column => ({
            ...filterConfig.find(item => item.key === column.key),
            ...column
        }));
    }
    mapLegacyColumnConfig(legacy) {
        const { active, key, custom, headerName, fragmentPath, filter, sorting } = legacy;
        const sortOrder = sorting ? this.migrateSortOrder(sorting) : '';
        return omitBy({
            visible: active ?? true,
            name: LegacyGridConfigMapperService.deviceGridLegacyKeyToName[key] || key,
            sortOrder,
            custom,
            header: custom ? headerName : null,
            path: fragmentPath,
            filter
        }, isNil);
    }
    migrateSortOrder(sorting) {
        switch (sorting.order) {
            case 0:
                return '';
            case -1:
                return 'desc';
            case 1:
                return 'asc';
        }
    }
}
LegacyGridConfigMapperService.deviceGridLegacyKeyToName = {
    status: 'status',
    name: 'name',
    model: 'model',
    serialNumber: 'serialNumber',
    group: 'group',
    registrationDate: 'registrationDate',
    systemId: 'systemId',
    imei: 'imei',
    alarms: 'alarms'
};
LegacyGridConfigMapperService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: LegacyGridConfigMapperService, deps: [{ token: i1.UserPreferencesService }, { token: i2.DataGridService }], target: i0.ɵɵFactoryTarget.Injectable });
LegacyGridConfigMapperService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: LegacyGridConfigMapperService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: LegacyGridConfigMapperService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.UserPreferencesService }, { type: i2.DataGridService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVnYWN5LWdyaWQtY29uZmlnLW1hcHBlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9kYXRhLWdyaWQvbGVnYWN5LWdyaWQtY29uZmlnLW1hcHBlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0scURBQXFELENBQUM7QUFHN0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBc0J0RCxNQUFNLE9BQU8sNkJBQTZCO0lBYXhDLFlBQ1Usc0JBQThDLEVBQzlDLGVBQWdDO1FBRGhDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQ3ZDLENBQUM7SUFFSixtQkFBbUIsQ0FBQyxPQUEwQjtRQUM1QyxNQUFNLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7UUFDeEQsTUFBTSw2QkFBNkIsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDO1FBQzlELE9BQU8sYUFBYSxDQUFDO1lBQ25CLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUM7WUFDeEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQztTQUMvRCxDQUFDLENBQUMsSUFBSSxDQUNMLEdBQUcsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLGtCQUFrQixDQUFDLEVBQUUs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LEtBQUssQ0FBQztTQUNoQjtJQUNILENBQUM7O0FBcElNLHVEQUF5QixHQUFHO0lBQ2pDLE1BQU0sRUFBRSxRQUFRO0lBQ2hCLElBQUksRUFBRSxNQUFNO0lBQ1osS0FBSyxFQUFFLE9BQU87SUFDZCxZQUFZLEVBQUUsY0FBYztJQUM1QixLQUFLLEVBQUUsT0FBTztJQUNkLGdCQUFnQixFQUFFLGtCQUFrQjtJQUNwQyxRQUFRLEVBQUUsVUFBVTtJQUNwQixJQUFJLEVBQUUsTUFBTTtJQUNaLE1BQU0sRUFBRSxRQUFRO0NBQ2pCLENBQUM7MEhBWFMsNkJBQTZCOzhIQUE3Qiw2QkFBNkIsY0FGNUIsTUFBTTsyRkFFUCw2QkFBNkI7a0JBSHpDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaXNFbXB0eSwgaXNOaWwsIG9taXRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VzZXItcHJlZmVyZW5jZXMvdXNlci1wcmVmZXJlbmNlcy5zZXJ2aWNlJztcbmltcG9ydCB7IEdyaWRDb25maWdDb250ZXh0IH0gZnJvbSAnLi9kYXRhLWdyaWQtY29uZmlndXJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBDb2x1bW4sIEN1c3RvbUNvbHVtbkNvbmZpZywgR3JpZENvbmZpZyB9IGZyb20gJy4vZGF0YS1ncmlkLm1vZGVsJztcbmltcG9ydCB7IERhdGFHcmlkU2VydmljZSB9IGZyb20gJy4vZGF0YS1ncmlkLnNlcnZpY2UnO1xuXG5pbnRlcmZhY2UgTGVnYWN5Q29sdW1uQ29uZmlnIHtcbiAga2V5OiBzdHJpbmc7XG4gIGhlYWRlck5hbWU6IHN0cmluZztcbiAgYWN0aXZlOiBib29sZWFuO1xuICBjdXN0b206IGJvb2xlYW47XG4gIGZyYWdtZW50UGF0aDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgTGVnYWN5Q29sdW1uRmlsdGVyQ29uZmlnIHtcbiAgW2tleTogc3RyaW5nXToge1xuICAgIGZpbHRlcmluZzogb2JqZWN0O1xuICAgIHNvcnRpbmc6IHtcbiAgICAgIG9yZGVyOiBudW1iZXI7XG4gICAgfTtcbiAgfTtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTGVnYWN5R3JpZENvbmZpZ01hcHBlclNlcnZpY2Uge1xuICBzdGF0aWMgZGV2aWNlR3JpZExlZ2FjeUtleVRvTmFtZSA9IHtcbiAgICBzdGF0dXM6ICdzdGF0dXMnLFxuICAgIG5hbWU6ICduYW1lJyxcbiAgICBtb2RlbDogJ21vZGVsJyxcbiAgICBzZXJpYWxOdW1iZXI6ICdzZXJpYWxOdW1iZXInLFxuICAgIGdyb3VwOiAnZ3JvdXAnLFxuICAgIHJlZ2lzdHJhdGlvbkRhdGU6ICdyZWdpc3RyYXRpb25EYXRlJyxcbiAgICBzeXN0ZW1JZDogJ3N5c3RlbUlkJyxcbiAgICBpbWVpOiAnaW1laScsXG4gICAgYWxhcm1zOiAnYWxhcm1zJ1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdXNlclByZWZlcmVuY2VzU2VydmljZTogVXNlclByZWZlcmVuY2VzU2VydmljZSxcbiAgICBwcml2YXRlIGRhdGFHcmlkU2VydmljZTogRGF0YUdyaWRTZXJ2aWNlXG4gICkge31cblxuICBnZXRNYXBwZWRHcmlkQ29uZmlnKGNvbnRleHQ6IEdyaWRDb25maWdDb250ZXh0KTogT2JzZXJ2YWJsZTxHcmlkQ29uZmlnPiB7XG4gICAgY29uc3QgbGVnYWN5QWxsRGV2aWNlc0dyaWRLZXkgPSBjb250ZXh0LmxlZ2FjeUNvbmZpZ0tleTtcbiAgICBjb25zdCBsZWdhY3lBbGxEZXZpY2VzR3JpZEZpbHRlcktleSA9IGNvbnRleHQubGVnYWN5RmlsdGVyS2V5O1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5nZXQobGVnYWN5QWxsRGV2aWNlc0dyaWRLZXkpLFxuICAgICAgdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlLmdldChsZWdhY3lBbGxEZXZpY2VzR3JpZEZpbHRlcktleSlcbiAgICBdKS5waXBlKFxuICAgICAgbWFwKChbbGVnYWN5Q29uZmlnLCBsZWdhY3lGaWx0ZXJDb25maWddKSA9PlxuICAgICAgICB0aGlzLm1hcExlZ2FjeVRvRGV2aWNlR3JpZENvbmZpZyhsZWdhY3lDb25maWcsIGxlZ2FjeUZpbHRlckNvbmZpZywgY29udGV4dC5kZWZhdWx0Q29sdW1ucylcbiAgICAgICksXG4gICAgICBjb25jYXRNYXAobWFwcGVkTGVnYWN5Q29uZmlnID0+IHtcbiAgICAgICAgaWYgKG1hcHBlZExlZ2FjeUNvbmZpZykge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnVzZXJQcmVmZXJlbmNlc1NlcnZpY2Uuc2V0KGxlZ2FjeUFsbERldmljZXNHcmlkS2V5LCBudWxsKSxcbiAgICAgICAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5zZXQobGVnYWN5QWxsRGV2aWNlc0dyaWRGaWx0ZXJLZXksIG51bGwpXG4gICAgICAgICAgXSkudGhlbigoKSA9PiBtYXBwZWRMZWdhY3lDb25maWcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBjb25jYXRNYXAobWFwcGVkTGVnYWN5Q29uZmlnID0+XG4gICAgICAgIG1hcHBlZExlZ2FjeUNvbmZpZ1xuICAgICAgICAgID8gdGhpcy51c2VyUHJlZmVyZW5jZXNTZXJ2aWNlXG4gICAgICAgICAgICAgIC5zZXQoY29udGV4dD8ua2V5LCBtYXBwZWRMZWdhY3lDb25maWcpXG4gICAgICAgICAgICAgIC50aGVuKCgpID0+IG1hcHBlZExlZ2FjeUNvbmZpZylcbiAgICAgICAgICA6IHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5nZXQoY29udGV4dD8ua2V5KVxuICAgICAgKSxcbiAgICAgIG1hcChcbiAgICAgICAgY29uZmlnID0+XG4gICAgICAgICAgY29uZmlnIHx8IHtcbiAgICAgICAgICAgIGNvbHVtbnM6IFtdLFxuICAgICAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgICAgICBwYWdlU2l6ZTogKHRoaXMuZGF0YUdyaWRTZXJ2aWNlIGFzIGFueSkuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBtYXBMZWdhY3lUb0RldmljZUdyaWRDb25maWcoXG4gICAgbGVnYWN5Q29uZmlnOiBMZWdhY3lDb2x1bW5Db25maWdbXSxcbiAgICBsZWdhY3lGaWx0ZXJDb25maWc6IExlZ2FjeUNvbHVtbkZpbHRlckNvbmZpZyxcbiAgICBkZWZhdWx0Q29sdW1uczogQ29sdW1uW10gPSBbXVxuICApOiBHcmlkQ29uZmlnIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShsZWdhY3lDb25maWcpIHx8ICFpc0VtcHR5KGxlZ2FjeUZpbHRlckNvbmZpZykpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbHVtbnM6IHRoaXMuZ2V0Q29uZmlnQ29sdW1ucyhsZWdhY3lDb25maWcsIGxlZ2FjeUZpbHRlckNvbmZpZywgZGVmYXVsdENvbHVtbnMpLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgcGFnZVNpemU6ICh0aGlzLmRhdGFHcmlkU2VydmljZSBhcyBhbnkpLkRFRkFVTFRfUEFHRV9TSVpFLFxuICAgICAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29uZmlnQ29sdW1ucyhcbiAgICBsZWdhY3lDb25maWc6IExlZ2FjeUNvbHVtbkNvbmZpZ1tdLFxuICAgIGxlZ2FjeUZpbHRlckNvbmZpZzogTGVnYWN5Q29sdW1uRmlsdGVyQ29uZmlnLFxuICAgIGRlZmF1bHRDb2x1bW5zOiBDb2x1bW5bXVxuICApIHtcbiAgICBjb25zdCBsZWdhY3lGaWx0ZXJDb25maWdBcnJheSA9IGxlZ2FjeUZpbHRlckNvbmZpZ1xuICAgICAgPyBPYmplY3Qua2V5cyhsZWdhY3lGaWx0ZXJDb25maWcpLm1hcChrZXkgPT4gKHtcbiAgICAgICAgICBrZXksXG4gICAgICAgICAgZmlsdGVyOiB7XG4gICAgICAgICAgICBleHRlcm5hbEZpbHRlclF1ZXJ5OiBsZWdhY3lGaWx0ZXJDb25maWdba2V5XS5maWx0ZXJpbmdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNvcnRpbmc6IGxlZ2FjeUZpbHRlckNvbmZpZ1trZXldLnNvcnRpbmdcbiAgICAgICAgfSkpXG4gICAgICA6IFtdO1xuXG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5tZXJnZUxlZ2FjeUNvbmZpZ3MoXG4gICAgICBsZWdhY3lDb25maWcgfHwgZGVmYXVsdENvbHVtbnMubWFwKGNvbHVtbiA9PiAoeyBrZXk6IGNvbHVtbi5uYW1lIH0pKSxcbiAgICAgIGxlZ2FjeUZpbHRlckNvbmZpZ0FycmF5XG4gICAgKTtcblxuICAgIHJldHVybiBjb25maWdcbiAgICAgIC5maWx0ZXIoY29sdW1uID0+IGNvbHVtbi5rZXkgIT09ICdyZW1vdmFsQ29sdW1uJylcbiAgICAgIC5tYXAodGhpcy5tYXBMZWdhY3lDb2x1bW5Db25maWcuYmluZCh0aGlzKSk7XG4gIH1cblxuICBtZXJnZUxlZ2FjeUNvbmZpZ3MoY29sdW1uQ29uZmlnLCBmaWx0ZXJDb25maWcpIHtcbiAgICByZXR1cm4gY29sdW1uQ29uZmlnLm1hcChjb2x1bW4gPT4gKHtcbiAgICAgIC4uLmZpbHRlckNvbmZpZy5maW5kKGl0ZW0gPT4gaXRlbS5rZXkgPT09IGNvbHVtbi5rZXkpLFxuICAgICAgLi4uY29sdW1uXG4gICAgfSkpO1xuICB9XG5cbiAgbWFwTGVnYWN5Q29sdW1uQ29uZmlnKGxlZ2FjeSk6IEN1c3RvbUNvbHVtbkNvbmZpZyB7XG4gICAgY29uc3QgeyBhY3RpdmUsIGtleSwgY3VzdG9tLCBoZWFkZXJOYW1lLCBmcmFnbWVudFBhdGgsIGZpbHRlciwgc29ydGluZyB9ID0gbGVnYWN5O1xuICAgIGNvbnN0IHNvcnRPcmRlciA9IHNvcnRpbmcgPyB0aGlzLm1pZ3JhdGVTb3J0T3JkZXIoc29ydGluZykgOiAnJztcblxuICAgIHJldHVybiBvbWl0QnkoXG4gICAgICB7XG4gICAgICAgIHZpc2libGU6IGFjdGl2ZSA/PyB0cnVlLFxuICAgICAgICBuYW1lOiBMZWdhY3lHcmlkQ29uZmlnTWFwcGVyU2VydmljZS5kZXZpY2VHcmlkTGVnYWN5S2V5VG9OYW1lW2tleV0gfHwga2V5LFxuICAgICAgICBzb3J0T3JkZXIsXG4gICAgICAgIGN1c3RvbSxcbiAgICAgICAgaGVhZGVyOiBjdXN0b20gPyBoZWFkZXJOYW1lIDogbnVsbCxcbiAgICAgICAgcGF0aDogZnJhZ21lbnRQYXRoLFxuICAgICAgICBmaWx0ZXJcbiAgICAgIH0sXG4gICAgICBpc05pbFxuICAgICk7XG4gIH1cblxuICBtaWdyYXRlU29ydE9yZGVyKHNvcnRpbmcpIHtcbiAgICBzd2l0Y2ggKHNvcnRpbmcub3JkZXIpIHtcbiAgICAgIGNhc2UgMDpcbiAgICAgICAgcmV0dXJuICcnO1xuICAgICAgY2FzZSAtMTpcbiAgICAgICAgcmV0dXJuICdkZXNjJztcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgcmV0dXJuICdhc2MnO1xuICAgIH1cbiAgfVxufVxuIl19