import { Injectable } from '@angular/core';
import { flatten, get } from 'lodash-es';
import { combineLatest, from, of } from 'rxjs';
import { map, reduce, switchMap } from 'rxjs/operators';
import { AlertService } from '../../alert/alert.service';
import { C8yJSONSchema } from '../../dynamic-forms/json-schema/c8y-json-schema.service';
import { FilterMapperFactory } from './filter-mapper.factory';
import * as i0 from "@angular/core";
import * as i1 from "../../alert/alert.service";
import * as i2 from "../../dynamic-forms/json-schema/c8y-json-schema.service";
import * as i3 from "./filter-mapper.factory";
export class FilterMapperService {
    constructor(alert, jsonschema, filterMapperFactory) {
        this.alert = alert;
        this.jsonschema = jsonschema;
        this.filterMapperFactory = filterMapperFactory;
    }
    getMappedFilterValues(filter) {
        return of(filter).pipe(switchMap(filter => {
            const { schema, fields, generateChips } = filter.filteringConfig || {};
            const { externalFilterQuery } = filter;
            if (schema || fields) {
                // Will return the extracted filterChip items from the formly fields definition.
                const mappedFields = schema ? [this.jsonschema.toFieldConfig(schema)] : fields;
                return this.mapFieldsToFilter(filter, mappedFields);
            }
            if (generateChips) {
                // Will return the extracted filterChip items from the custom generatedChips
                // function defined in the columns filteringConfig.
                const generatedChips = generateChips(externalFilterQuery);
                const mappedChips = generatedChips.map(chip => ({ ...filter, ...chip }));
                return of(mappedChips);
            }
            if (externalFilterQuery?.chips) {
                // If no schema or custom chips generation function is provided user can put already generated
                // chips in the externalFilterQuery as it is seen in the server example tutorial grid.
                const chips = externalFilterQuery.chips || [];
                const mappedChips = chips.map(chip => ({ ...filter, ...chip }));
                return of(mappedChips);
            }
            return of([]);
        }));
    }
    mapFieldsToFilter(filterChip, formlyFields, path = [], result = of([])) {
        return result.pipe(switchMap(resultChips => {
            return from(formlyFields).pipe(switchMap(field => this.processField(filterChip, field, path, resultChips)), reduce((resultChips, newChips) => [...new Set([...newChips, ...resultChips])]));
        }));
    }
    processField(filterChip, field, path, resultChips) {
        const currentPath = [...path];
        if (field.key) {
            currentPath.push(field.key);
        }
        if (field.fieldGroup) {
            const chip = field.props?.label ? { ...filterChip, label: field.props.label } : filterChip;
            return this.mapFieldsToFilter(chip, field.fieldGroup, currentPath);
        }
        if (field.fieldArray) {
            const fieldsArray = get(filterChip.externalFilterQuery, currentPath);
            const filters = fieldsArray.map((el, index) => {
                filterChip.path = currentPath;
                return this.mapFieldsToFilter(filterChip, [field.fieldArray], [...currentPath, index]);
            });
            return combineLatest(filters).pipe(map(result => flatten(result)));
        }
        filterChip.path = currentPath;
        if (get(filterChip.externalFilterQuery, currentPath)) {
            return this.getChipFromFactory(resultChips, field, filterChip);
        }
        return of([]);
    }
    getChipFromFactory(resultChips, field, filterChip) {
        try {
            const filterMapper = this.filterMapperFactory.get(field.type);
            return filterMapper
                .map(field, filterChip)
                .pipe(map(mappedChip => (mappedChip.displayValue ? [...resultChips, mappedChip] : resultChips)));
        }
        catch (error) {
            this.alert.danger(error);
            return of([]);
        }
    }
    removeChip(chip) {
        const { path, externalFilterQuery } = chip;
        const lastKey = path[path.length - 1];
        const parentObj = path
            .slice(0, -1)
            .reduce((nestedObj, key) => nestedObj[key], externalFilterQuery);
        if (Array.isArray(parentObj)) {
            parentObj.splice(lastKey, 1);
        }
        else {
            delete parentObj[lastKey];
        }
        return {
            externalFilterQuery,
            columnName: chip.columnName
        };
    }
}
FilterMapperService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilterMapperService, deps: [{ token: i1.AlertService }, { token: i2.C8yJSONSchema }, { token: i3.FilterMapperFactory }], target: i0.ɵɵFactoryTarget.Injectable });
FilterMapperService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilterMapperService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilterMapperService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.AlertService }, { type: i2.C8yJSONSchema }, { type: i3.FilterMapperFactory }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLW1hcHBlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vY29yZS9kYXRhLWdyaWQvZmlsdGVyLWNoaXAvZmlsdGVyLW1hcHBlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekMsT0FBTyxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0seURBQXlELENBQUM7QUFFeEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7Ozs7O0FBSzlELE1BQU0sT0FBTyxtQkFBbUI7SUFDOUIsWUFDVSxLQUFtQixFQUNuQixVQUF5QixFQUN6QixtQkFBd0M7UUFGeEMsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixlQUFVLEdBQVYsVUFBVSxDQUFlO1FBQ3pCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7SUFDL0MsQ0FBQztJQUVKLHFCQUFxQixDQUFDLE1BQWtCO1FBQ3RDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDcEIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2pCLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxHQUFHLE1BQU0sQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDO1lBQ3ZFLE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxHQUFHLE1BQU0sQ0FBQztZQUV2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QUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FDMUYsQ0FBQztTQUNMO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN6QixPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFJO1FBQ2IsTUFBTSxFQUFFLElBQUksRUFBRSxtQkFBbUIsRUFBRSxHQUFHLElBQUksQ0FBQztRQUUzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN0QyxNQUFNLFNBQVMsR0FBRyxJQUFJO2FBQ25CLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDWixNQUFNLENBQUMsQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUVuRSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDNUIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDOUI7YUFBTTtZQUNMLE9BQU8sU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzNCO1FBRUQsT0FBTztZQUNMLG1CQUFtQjtZQUNuQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7U0FDNUIsQ0FBQztJQUNKLENBQUM7O2dIQXRJVSxtQkFBbUI7b0hBQW5CLG1CQUFtQixjQUZsQixNQUFNOzJGQUVQLG1CQUFtQjtrQkFIL0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZyB9IGZyb20gJ0BuZ3gtZm9ybWx5L2NvcmUnO1xuaW1wb3J0IHsgZmxhdHRlbiwgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHJlZHVjZSwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi8uLi9hbGVydC9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IEM4eUpTT05TY2hlbWEgfSBmcm9tICcuLi8uLi9keW5hbWljLWZvcm1zL2pzb24tc2NoZW1hL2M4eS1qc29uLXNjaGVtYS5zZXJ2aWNlJztcbmltcG9ydCB7IEZpbHRlckNoaXAsIFBhcnRpYWxGaWx0ZXJDaGlwUmVtb3ZhbFR5cGUgfSBmcm9tICcuLi9kYXRhLWdyaWQubW9kZWwnO1xuaW1wb3J0IHsgRmlsdGVyTWFwcGVyRmFjdG9yeSB9IGZyb20gJy4vZmlsdGVyLW1hcHBlci5mYWN0b3J5JztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRmlsdGVyTWFwcGVyU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIGpzb25zY2hlbWE6IEM4eUpTT05TY2hlbWEsXG4gICAgcHJpdmF0ZSBmaWx0ZXJNYXBwZXJGYWN0b3J5OiBGaWx0ZXJNYXBwZXJGYWN0b3J5XG4gICkge31cblxuICBnZXRNYXBwZWRGaWx0ZXJWYWx1ZXMoZmlsdGVyOiBGaWx0ZXJDaGlwKTogT2JzZXJ2YWJsZTxGaWx0ZXJDaGlwW10+IHtcbiAgICByZXR1cm4gb2YoZmlsdGVyKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKGZpbHRlciA9PiB7XG4gICAgICAgIGNvbnN0IHsgc2NoZW1hLCBmaWVsZHMsIGdlbmVyYXRlQ2hpcHMgfSA9IGZpbHRlci5maWx0ZXJpbmdDb25maWcgfHwge307XG4gICAgICAgIGNvbnN0IHsgZXh0ZXJuYWxGaWx0ZXJRdWVyeSB9ID0gZmlsdGVyO1xuXG4gICAgICAgIGlmIChzY2hlbWEgfHwgZmllbGRzKSB7XG4gICAgICAgICAgLy8gV2lsbCByZXR1cm4gdGhlIGV4dHJhY3RlZCBmaWx0ZXJDaGlwIGl0ZW1zIGZyb20gdGhlIGZvcm1seSBmaWVsZHMgZGVmaW5pdGlvbi5cbiAgICAgICAgICBjb25zdCBtYXBwZWRGaWVsZHMgPSBzY2hlbWEgPyBbdGhpcy5qc29uc2NoZW1hLnRvRmllbGRDb25maWcoc2NoZW1hKV0gOiBmaWVsZHM7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubWFwRmllbGRzVG9GaWx0ZXIoZmlsdGVyLCBtYXBwZWRGaWVsZHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGdlbmVyYXRlQ2hpcHMpIHtcbiAgICAgICAgICAvLyBXaWxsIHJldHVybiB0aGUgZXh0cmFjdGVkIGZpbHRlckNoaXAgaXRlbXMgZnJvbSB0aGUgY3VzdG9tIGdlbmVyYXRlZENoaXBzXG4gICAgICAgICAgLy8gZnVuY3Rpb24gZGVmaW5lZCBpbiB0aGUgY29sdW1ucyBmaWx0ZXJpbmdDb25maWcuXG4gICAgICAgICAgY29uc3QgZ2VuZXJhdGVkQ2hpcHMgPSBnZW5lcmF0ZUNoaXBzKGV4dGVybmFsRmlsdGVyUXVlcnkpO1xuICAgICAgICAgIGNvbnN0IG1hcHBlZENoaXBzID0gZ2VuZXJhdGVkQ2hpcHMubWFwKGNoaXAgPT4gKHsgLi4uZmlsdGVyLCAuLi5jaGlwIH0pKTtcbiAgICAgICAgICByZXR1cm4gb2YobWFwcGVkQ2hpcHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV4dGVybmFsRmlsdGVyUXVlcnk/LmNoaXBzKSB7XG4gICAgICAgICAgLy8gSWYgbm8gc2NoZW1hIG9yIGN1c3RvbSBjaGlwcyBnZW5lcmF0aW9uIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIHVzZXIgY2FuIHB1dCBhbHJlYWR5IGdlbmVyYXRlZFxuICAgICAgICAgIC8vIGNoaXBzIGluIHRoZSBleHRlcm5hbEZpbHRlclF1ZXJ5IGFzIGl0IGlzIHNlZW4gaW4gdGhlIHNlcnZlciBleGFtcGxlIHR1dG9yaWFsIGdyaWQuXG4gICAgICAgICAgY29uc3QgY2hpcHMgPSBleHRlcm5hbEZpbHRlclF1ZXJ5LmNoaXBzIHx8IFtdO1xuICAgICAgICAgIGNvbnN0IG1hcHBlZENoaXBzID0gY2hpcHMubWFwKGNoaXAgPT4gKHsgLi4uZmlsdGVyLCAuLi5jaGlwIH0pKTtcbiAgICAgICAgICByZXR1cm4gb2YobWFwcGVkQ2hpcHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIG1hcEZpZWxkc1RvRmlsdGVyKFxuICAgIGZpbHRlckNoaXA6IEZpbHRlckNoaXAsXG4gICAgZm9ybWx5RmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdLFxuICAgIHBhdGg6IHN0cmluZ1tdID0gW10sXG4gICAgcmVzdWx0OiBPYnNlcnZhYmxlPEZpbHRlckNoaXBbXT4gPSBvZihbXSlcbiAgKTogT2JzZXJ2YWJsZTxGaWx0ZXJDaGlwW10+IHtcbiAgICByZXR1cm4gcmVzdWx0LnBpcGUoXG4gICAgICBzd2l0Y2hNYXAocmVzdWx0Q2hpcHMgPT4ge1xuICAgICAgICByZXR1cm4gZnJvbShmb3JtbHlGaWVsZHMpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKGZpZWxkID0+IHRoaXMucHJvY2Vzc0ZpZWxkKGZpbHRlckNoaXAsIGZpZWxkLCBwYXRoLCByZXN1bHRDaGlwcykpLFxuICAgICAgICAgIHJlZHVjZShcbiAgICAgICAgICAgIChyZXN1bHRDaGlwcywgbmV3Q2hpcHMpID0+IFsuLi5uZXcgU2V0KFsuLi5uZXdDaGlwcywgLi4ucmVzdWx0Q2hpcHNdKV0gYXMgRmlsdGVyQ2hpcFtdXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJvY2Vzc0ZpZWxkKFxuICAgIGZpbHRlckNoaXA6IEZpbHRlckNoaXAsXG4gICAgZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLFxuICAgIHBhdGg6IHN0cmluZ1tdLFxuICAgIHJlc3VsdENoaXBzOiBGaWx0ZXJDaGlwW11cbiAgKTogT2JzZXJ2YWJsZTxGaWx0ZXJDaGlwW10+IHtcbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IFsuLi5wYXRoXTtcblxuICAgIGlmIChmaWVsZC5rZXkpIHtcbiAgICAgIGN1cnJlbnRQYXRoLnB1c2goZmllbGQua2V5IGFzIHN0cmluZyk7XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLmZpZWxkR3JvdXApIHtcbiAgICAgIGNvbnN0IGNoaXAgPSBmaWVsZC5wcm9wcz8ubGFiZWwgPyB7IC4uLmZpbHRlckNoaXAsIGxhYmVsOiBmaWVsZC5wcm9wcy5sYWJlbCB9IDogZmlsdGVyQ2hpcDtcbiAgICAgIHJldHVybiB0aGlzLm1hcEZpZWxkc1RvRmlsdGVyKGNoaXAsIGZpZWxkLmZpZWxkR3JvdXAsIGN1cnJlbnRQYXRoKTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgY29uc3QgZmllbGRzQXJyYXkgPSBnZXQoZmlsdGVyQ2hpcC5leHRlcm5hbEZpbHRlclF1ZXJ5LCBjdXJyZW50UGF0aCk7XG5cbiAgICAgIGNvbnN0IGZpbHRlcnMgPSBmaWVsZHNBcnJheS5tYXAoKGVsLCBpbmRleCkgPT4ge1xuICAgICAgICBmaWx0ZXJDaGlwLnBhdGggPSBjdXJyZW50UGF0aDtcbiAgICAgICAgcmV0dXJuIHRoaXMubWFwRmllbGRzVG9GaWx0ZXIoXG4gICAgICAgICAgZmlsdGVyQ2hpcCxcbiAgICAgICAgICBbZmllbGQuZmllbGRBcnJheSBhcyBGb3JtbHlGaWVsZENvbmZpZ10sXG4gICAgICAgICAgWy4uLmN1cnJlbnRQYXRoLCBpbmRleF1cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChmaWx0ZXJzKS5waXBlKG1hcChyZXN1bHQgPT4gZmxhdHRlbihyZXN1bHQpKSk7XG4gICAgfVxuXG4gICAgZmlsdGVyQ2hpcC5wYXRoID0gY3VycmVudFBhdGg7XG4gICAgaWYgKGdldChmaWx0ZXJDaGlwLmV4dGVybmFsRmlsdGVyUXVlcnksIGN1cnJlbnRQYXRoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hpcEZyb21GYWN0b3J5KHJlc3VsdENoaXBzLCBmaWVsZCwgZmlsdGVyQ2hpcCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9mKFtdKTtcbiAgfVxuXG4gIGdldENoaXBGcm9tRmFjdG9yeShcbiAgICByZXN1bHRDaGlwczogRmlsdGVyQ2hpcFtdLFxuICAgIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZyxcbiAgICBmaWx0ZXJDaGlwOiBGaWx0ZXJDaGlwXG4gICk6IE9ic2VydmFibGU8RmlsdGVyQ2hpcFtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbHRlck1hcHBlciA9IHRoaXMuZmlsdGVyTWFwcGVyRmFjdG9yeS5nZXQoZmllbGQudHlwZSk7XG4gICAgICByZXR1cm4gZmlsdGVyTWFwcGVyXG4gICAgICAgIC5tYXAoZmllbGQsIGZpbHRlckNoaXApXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIG1hcChtYXBwZWRDaGlwID0+IChtYXBwZWRDaGlwLmRpc3BsYXlWYWx1ZSA/IFsuLi5yZXN1bHRDaGlwcywgbWFwcGVkQ2hpcF0gOiByZXN1bHRDaGlwcykpXG4gICAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKGVycm9yKTtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlQ2hpcChjaGlwKTogUGFydGlhbEZpbHRlckNoaXBSZW1vdmFsVHlwZSB7XG4gICAgY29uc3QgeyBwYXRoLCBleHRlcm5hbEZpbHRlclF1ZXJ5IH0gPSBjaGlwO1xuXG4gICAgY29uc3QgbGFzdEtleSA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcbiAgICBjb25zdCBwYXJlbnRPYmogPSBwYXRoXG4gICAgICAuc2xpY2UoMCwgLTEpXG4gICAgICAucmVkdWNlKChuZXN0ZWRPYmosIGtleSkgPT4gbmVzdGVkT2JqW2tleV0sIGV4dGVybmFsRmlsdGVyUXVlcnkpO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocGFyZW50T2JqKSkge1xuICAgICAgcGFyZW50T2JqLnNwbGljZShsYXN0S2V5LCAxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVsZXRlIHBhcmVudE9ialtsYXN0S2V5XTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZXh0ZXJuYWxGaWx0ZXJRdWVyeSxcbiAgICAgIGNvbHVtbk5hbWU6IGNoaXAuY29sdW1uTmFtZVxuICAgIH07XG4gIH1cbn1cbiJdfQ==