import { FormArray } from '@angular/forms';
import { DatapointLibraryValidationErrors } from './validation-pattern';
import { get } from 'lodash-es';
// @dynamic
export class C8yValidators {
    static minMaxValidator() {
        return (control) => {
            const min = control.get(`min`);
            const max = control.get(`max`);
            const minDefined = min && min.value !== undefined && min.value !== null;
            const maxDefined = max && max.value !== undefined && max.value !== null;
            // remove previous errors
            this.removeErrors(min, [DatapointLibraryValidationErrors.GREATER_THAN_RANGE_MAX]);
            this.removeErrors(max, [DatapointLibraryValidationErrors.LESS_THAN_RANGE_MIN]);
            if (!minDefined || !maxDefined) {
                return null;
            }
            // sets errors
            if (min.value >= max.value) {
                const minError = { [DatapointLibraryValidationErrors.GREATER_THAN_RANGE_MAX]: true };
                const maxError = { [DatapointLibraryValidationErrors.LESS_THAN_RANGE_MIN]: true };
                const errors = Object.assign({}, minError, maxError);
                min.setErrors(Object.assign(minError, min.errors || {}));
                max.setErrors(Object.assign(maxError, max.errors || {}));
                return errors;
            }
            return null;
        };
    }
    static requireBothMinAndMax() {
        const errorAttribute = DatapointLibraryValidationErrors.SHOULD_BE_DEFINED;
        return (control) => {
            const min = control.get(`min`);
            const max = control.get(`max`);
            const minDefined = min && min.value !== undefined && min.value !== null;
            const maxDefined = max && max.value !== undefined && max.value !== null;
            const errors = {};
            if (minDefined && !maxDefined && max) {
                // sets error
                const error = { [errorAttribute]: true };
                max.setErrors(Object.assign({}, max.errors || {}, error));
                Object.assign(errors, error);
            }
            else {
                // remove previous error
                this.removeErrors(max, [errorAttribute]);
            }
            if (maxDefined && !minDefined && min) {
                // sets error
                const error = { [errorAttribute]: true };
                min.setErrors(Object.assign({}, min.errors || {}, error));
                Object.assign(errors, error);
            }
            else {
                // remove previous error
                this.removeErrors(min, [errorAttribute]);
            }
            return Object.keys(errors).length ? errors : null;
        };
    }
    static withinScale(field) {
        return (control) => {
            if (!field) {
                return null;
            }
            const min = control.get(`range.min`);
            const max = control.get(`range.max`);
            const fieldControl = control.get(field);
            const minDefined = min && min.value !== undefined && min.value !== null;
            const maxDefined = max && max.value !== undefined && max.value !== null;
            const fieldDefined = fieldControl && fieldControl.value !== undefined && fieldControl.value !== null;
            // remove previous errors
            this.removeErrors(fieldControl, [
                DatapointLibraryValidationErrors.GREATER_THAN_SCALE_MAX,
                DatapointLibraryValidationErrors.LESS_THAN_SCALE_MIN
            ]);
            if (!minDefined || !maxDefined || !fieldDefined) {
                return null;
            }
            const errors = {};
            // sets errors
            if (fieldControl.value < min.value) {
                const error = { [DatapointLibraryValidationErrors.LESS_THAN_SCALE_MIN]: true };
                fieldControl.setErrors(Object.assign({}, fieldControl.errors || {}, error));
                Object.assign(errors, error);
            }
            if (fieldControl.value > max.value) {
                const error = { [DatapointLibraryValidationErrors.GREATER_THAN_SCALE_MAX]: true };
                fieldControl.setErrors(Object.assign({}, fieldControl.errors || {}, error));
                Object.assign(errors, error);
            }
            return Object.keys(errors).length ? errors : null;
        };
    }
    static maxActiveCount(maxActive, activeAttribute = 'details.__active') {
        return (control) => {
            if (!Number.isInteger(maxActive) || Number.isNaN(maxActive)) {
                return null;
            }
            if (!(control instanceof FormArray)) {
                return null;
            }
            const formArray = control;
            const value = formArray.value;
            if (!Array.isArray(value)) {
                return null;
            }
            const filteredActiveEntries = value.filter(tmp => tmp && !!get(tmp, activeAttribute));
            if (filteredActiveEntries.length <= maxActive) {
                return null;
            }
            return {
                [DatapointLibraryValidationErrors.MAX_ACTIVE_COUNT]: {
                    maxActive,
                    actualLength: filteredActiveEntries.length
                }
            };
        };
    }
    static minActiveCount(minActive, activeAttribute = 'details.__active') {
        return (control) => {
            if (!Number.isInteger(minActive) || Number.isNaN(minActive)) {
                return null;
            }
            if (!(control instanceof FormArray)) {
                return null;
            }
            const formArray = control;
            const value = formArray.value;
            if (!Array.isArray(value)) {
                return null;
            }
            const filteredActiveEntries = value.filter(tmp => tmp && !!get(tmp, activeAttribute));
            if (filteredActiveEntries.length >= minActive) {
                return null;
            }
            return {
                [DatapointLibraryValidationErrors.MIN_ACTIVE_COUNT]: {
                    minActive,
                    actualLength: filteredActiveEntries.length
                }
            };
        };
    }
    static filesValidator(options) {
        return (control) => {
            const files = control.value;
            if (!files) {
                return null;
            }
            for (const fileObj of files) {
                const file = fileObj.file;
                if (options.typePrefix && !file.type.startsWith(options.typePrefix)) {
                    return {
                        wrongFileType: {
                            wrongFileType: file.type
                        }
                    };
                }
                if (options.allowedFileEndings?.length &&
                    !options.allowedFileEndings.some(ending => file.name.endsWith(ending))) {
                    return {
                        wrongFileEnding: {
                            allowedFileEndings: options.allowedFileEndings
                        }
                    };
                }
                if (file.size > options.maximumFileSizeInKb * 1024) {
                    const actualFileSize = file.size / 1024;
                    return {
                        maxFileSizeReached: {
                            maxFileSize: options.maximumFileSizeInKb,
                            actualFileSize: `~${actualFileSize.toFixed(0)}`
                        }
                    };
                }
            }
            return null;
        };
    }
    static removeErrors(control, errors) {
        if (!control || !control.errors) {
            return false;
        }
        let removedError = false;
        for (const error of errors) {
            if (control.errors[error]) {
                removedError = true;
                delete control.errors[error];
            }
        }
        if (removedError) {
            control.setErrors(Object.keys(control.errors).length ? Object.assign({}, control.errors) : null);
        }
        return removedError;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY3RpdmUtdmFsaWRhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvZm9ybXMvcmVhY3RpdmUtdmFsaWRhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW1CLFNBQVMsRUFBaUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRixPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWhDLFdBQVc7QUFDWCxNQUFNLE9BQU8sYUFBYTtJQUN4QixNQUFNLENBQUMsZUFBZTtRQUNwQixPQUFPLENBQUMsT0FBd0IsRUFBMkIsRUFBRTtZQUMzRCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFL0IsTUFBTSxVQUFVLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEtBQUssU0FBUyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDO1lBQ3hFLE1BQU0sVUFBVSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxLQUFLLFNBQVMsSUFBSSxHQUFHLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQztZQUV4RSx5QkFBeUI7WUFDekIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxnQ0FBZ0MsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7WUFDbEYsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxnQ0FBZ0MsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7WUFFL0UsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDOUIsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUVELGNBQWM7WUFDZCxJ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LE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgRm9ybUFycmF5LCBWYWxpZGF0aW9uRXJyb3JzLCBWYWxpZGF0b3JGbiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzIH0gZnJvbSAnLi92YWxpZGF0aW9uLXBhdHRlcm4nO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuLy8gQGR5bmFtaWNcbmV4cG9ydCBjbGFzcyBDOHlWYWxpZGF0b3JzIHtcbiAgc3RhdGljIG1pbk1heFZhbGlkYXRvcigpOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XG4gICAgICBjb25zdCBtaW4gPSBjb250cm9sLmdldChgbWluYCk7XG4gICAgICBjb25zdCBtYXggPSBjb250cm9sLmdldChgbWF4YCk7XG5cbiAgICAgIGNvbnN0IG1pbkRlZmluZWQgPSBtaW4gJiYgbWluLnZhbHVlICE9PSB1bmRlZmluZWQgJiYgbWluLnZhbHVlICE9PSBudWxsO1xuICAgICAgY29uc3QgbWF4RGVmaW5lZCA9IG1heCAmJiBtYXgudmFsdWUgIT09IHVuZGVmaW5lZCAmJiBtYXgudmFsdWUgIT09IG51bGw7XG5cbiAgICAgIC8vIHJlbW92ZSBwcmV2aW91cyBlcnJvcnNcbiAgICAgIHRoaXMucmVtb3ZlRXJyb3JzKG1pbiwgW0RhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzLkdSRUFURVJfVEhBTl9SQU5HRV9NQVhdKTtcbiAgICAgIHRoaXMucmVtb3ZlRXJyb3JzKG1heCwgW0RhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzLkxFU1NfVEhBTl9SQU5HRV9NSU5dKTtcblxuICAgICAgaWYgKCFtaW5EZWZpbmVkIHx8ICFtYXhEZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBzZXRzIGVycm9yc1xuICAgICAgaWYgKG1pbi52YWx1ZSA+PSBtYXgudmFsdWUpIHtcbiAgICAgICAgY29uc3QgbWluRXJyb3IgPSB7IFtEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5HUkVBVEVSX1RIQU5fUkFOR0VfTUFYXTogdHJ1ZSB9O1xuICAgICAgICBjb25zdCBtYXhFcnJvciA9IHsgW0RhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzLkxFU1NfVEhBTl9SQU5HRV9NSU5dOiB0cnVlIH07XG4gICAgICAgIGNvbnN0IGVycm9ycyA9IE9iamVjdC5hc3NpZ24oe30sIG1pbkVycm9yLCBtYXhFcnJvcik7XG4gICAgICAgIG1pbi5zZXRFcnJvcnMoT2JqZWN0LmFzc2lnbihtaW5FcnJvciwgbWluLmVycm9ycyB8fCB7fSkpO1xuICAgICAgICBtYXguc2V0RXJyb3JzKE9iamVjdC5hc3NpZ24obWF4RXJyb3IsIG1heC5lcnJvcnMgfHwge30pKTtcbiAgICAgICAgcmV0dXJuIGVycm9ycztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyByZXF1aXJlQm90aE1pbkFuZE1heCgpOiBWYWxpZGF0b3JGbiB7XG4gICAgY29uc3QgZXJyb3JBdHRyaWJ1dGUgPSBEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5TSE9VTERfQkVfREVGSU5FRDtcbiAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsID0+IHtcbiAgICAgIGNvbnN0IG1pbiA9IGNvbnRyb2wuZ2V0KGBtaW5gKTtcbiAgICAgIGNvbnN0IG1heCA9IGNvbnRyb2wuZ2V0KGBtYXhgKTtcblxuICAgICAgY29uc3QgbWluRGVmaW5lZCA9IG1pbiAmJiBtaW4udmFsdWUgIT09IHVuZGVmaW5lZCAmJiBtaW4udmFsdWUgIT09IG51bGw7XG4gICAgICBjb25zdCBtYXhEZWZpbmVkID0gbWF4ICYmIG1heC52YWx1ZSAhPT0gdW5kZWZpbmVkICYmIG1heC52YWx1ZSAhPT0gbnVsbDtcblxuICAgICAgY29uc3QgZXJyb3JzID0ge307XG4gICAgICBpZiAobWluRGVmaW5lZCAmJiAhbWF4RGVmaW5lZCAmJiBtYXgpIHtcbiAgICAgICAgLy8gc2V0cyBlcnJvclxuICAgICAgICBjb25zdCBlcnJvciA9IHsgW2Vycm9yQXR0cmlidXRlXTogdHJ1ZSB9O1xuICAgICAgICBtYXguc2V0RXJyb3JzKE9iamVjdC5hc3NpZ24oe30sIG1heC5lcnJvcnMgfHwge30sIGVycm9yKSk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZXJyb3JzLCBlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyByZW1vdmUgcHJldmlvdXMgZXJyb3JcbiAgICAgICAgdGhpcy5yZW1vdmVFcnJvcnMobWF4LCBbZXJyb3JBdHRyaWJ1dGVdKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1heERlZmluZWQgJiYgIW1pbkRlZmluZWQgJiYgbWluKSB7XG4gICAgICAgIC8vIHNldHMgZXJyb3JcbiAgICAgICAgY29uc3QgZXJyb3IgPSB7IFtlcnJvckF0dHJpYnV0ZV06IHRydWUgfTtcbiAgICAgICAgbWluLnNldEVycm9ycyhPYmplY3QuYXNzaWduKHt9LCBtaW4uZXJyb3JzIHx8IHt9LCBlcnJvcikpO1xuICAgICAgICBPYmplY3QuYXNzaWduKGVycm9ycywgZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gcmVtb3ZlIHByZXZpb3VzIGVycm9yXG4gICAgICAgIHRoaXMucmVtb3ZlRXJyb3JzKG1pbiwgW2Vycm9yQXR0cmlidXRlXSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCA/IGVycm9ycyA6IG51bGw7XG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyB3aXRoaW5TY2FsZShmaWVsZDogc3RyaW5nKTogVmFsaWRhdG9yRm4ge1xuICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPT4ge1xuICAgICAgaWYgKCFmaWVsZCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1pbiA9IGNvbnRyb2wuZ2V0KGByYW5nZS5taW5gKTtcbiAgICAgIGNvbnN0IG1heCA9IGNvbnRyb2wuZ2V0KGByYW5nZS5tYXhgKTtcbiAgICAgIGNvbnN0IGZpZWxkQ29udHJvbCA9IGNvbnRyb2wuZ2V0KGZpZWxkKTtcblxuICAgICAgY29uc3QgbWluRGVmaW5lZCA9IG1pbiAmJiBtaW4udmFsdWUgIT09IHVuZGVmaW5lZCAmJiBtaW4udmFsdWUgIT09IG51bGw7XG4gICAgICBjb25zdCBtYXhEZWZpbmVkID0gbWF4ICYmIG1heC52YWx1ZSAhPT0gdW5kZWZpbmVkICYmIG1heC52YWx1ZSAhPT0gbnVsbDtcbiAgICAgIGNvbnN0IGZpZWxkRGVmaW5lZCA9XG4gICAgICAgIGZpZWxkQ29udHJvbCAmJiBmaWVsZENvbnRyb2wudmFsdWUgIT09IHVuZGVmaW5lZCAmJiBmaWVsZENvbnRyb2wudmFsdWUgIT09IG51bGw7XG5cbiAgICAgIC8vIHJlbW92ZSBwcmV2aW91cyBlcnJvcnNcbiAgICAgIHRoaXMucmVtb3ZlRXJyb3JzKGZpZWxkQ29udHJvbCwgW1xuICAgICAgICBEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5HUkVBVEVSX1RIQU5fU0NBTEVfTUFYLFxuICAgICAgICBEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5MRVNTX1RIQU5fU0NBTEVfTUlOXG4gICAgICBdKTtcblxuICAgICAgaWYgKCFtaW5EZWZpbmVkIHx8ICFtYXhEZWZpbmVkIHx8ICFmaWVsZERlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGVycm9ycyA9IHt9O1xuXG4gICAgICAvLyBzZXRzIGVycm9yc1xuICAgICAgaWYgKGZpZWxkQ29udHJvbC52YWx1ZSA8IG1pbi52YWx1ZSkge1xuICAgICAgICBjb25zdCBlcnJvciA9IHsgW0RhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzLkxFU1NfVEhBTl9TQ0FMRV9NSU5dOiB0cnVlIH07XG4gICAgICAgIGZpZWxkQ29udHJvbC5zZXRFcnJvcnMoT2JqZWN0LmFzc2lnbih7fSwgZmllbGRDb250cm9sLmVycm9ycyB8fCB7fSwgZXJyb3IpKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihlcnJvcnMsIGVycm9yKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkQ29udHJvbC52YWx1ZSA+IG1heC52YWx1ZSkge1xuICAgICAgICBjb25zdCBlcnJvciA9IHsgW0RhdGFwb2ludExpYnJhcnlWYWxpZGF0aW9uRXJyb3JzLkdSRUFURVJfVEhBTl9TQ0FMRV9NQVhdOiB0cnVlIH07XG4gICAgICAgIGZpZWxkQ29udHJvbC5zZXRFcnJvcnMoT2JqZWN0LmFzc2lnbih7fSwgZmllbGRDb250cm9sLmVycm9ycyB8fCB7fSwgZXJyb3IpKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihlcnJvcnMsIGVycm9yKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoID8gZXJyb3JzIDogbnVsbDtcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIG1heEFjdGl2ZUNvdW50KG1heEFjdGl2ZTogbnVtYmVyLCBhY3RpdmVBdHRyaWJ1dGUgPSAnZGV0YWlscy5fX2FjdGl2ZScpOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XG4gICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIobWF4QWN0aXZlKSB8fCBOdW1iZXIuaXNOYU4obWF4QWN0aXZlKSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKCEoY29udHJvbCBpbnN0YW5jZW9mIEZvcm1BcnJheSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBjb25zdCBmb3JtQXJyYXkgPSBjb250cm9sIGFzIEZvcm1BcnJheTtcbiAgICAgIGNvbnN0IHZhbHVlOiBhbnlbXSA9IGZvcm1BcnJheS52YWx1ZTtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZpbHRlcmVkQWN0aXZlRW50cmllcyA9IHZhbHVlLmZpbHRlcih0bXAgPT4gdG1wICYmICEhZ2V0KHRtcCwgYWN0aXZlQXR0cmlidXRlKSk7XG4gICAgICBpZiAoZmlsdGVyZWRBY3RpdmVFbnRyaWVzLmxlbmd0aCA8PSBtYXhBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIFtEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5NQVhfQUNUSVZFX0NPVU5UXToge1xuICAgICAgICAgIG1heEFjdGl2ZSxcbiAgICAgICAgICBhY3R1YWxMZW5ndGg6IGZpbHRlcmVkQWN0aXZlRW50cmllcy5sZW5ndGhcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIG1pbkFjdGl2ZUNvdW50KG1pbkFjdGl2ZTogbnVtYmVyLCBhY3RpdmVBdHRyaWJ1dGUgPSAnZGV0YWlscy5fX2FjdGl2ZScpOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XG4gICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIobWluQWN0aXZlKSB8fCBOdW1iZXIuaXNOYU4obWluQWN0aXZlKSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKCEoY29udHJvbCBpbnN0YW5jZW9mIEZvcm1BcnJheSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBjb25zdCBmb3JtQXJyYXkgPSBjb250cm9sIGFzIEZvcm1BcnJheTtcbiAgICAgIGNvbnN0IHZhbHVlOiBhbnlbXSA9IGZvcm1BcnJheS52YWx1ZTtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZpbHRlcmVkQWN0aXZlRW50cmllcyA9IHZhbHVlLmZpbHRlcih0bXAgPT4gdG1wICYmICEhZ2V0KHRtcCwgYWN0aXZlQXR0cmlidXRlKSk7XG4gICAgICBpZiAoZmlsdGVyZWRBY3RpdmVFbnRyaWVzLmxlbmd0aCA+PSBtaW5BY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIFtEYXRhcG9pbnRMaWJyYXJ5VmFsaWRhdGlvbkVycm9ycy5NSU5fQUNUSVZFX0NPVU5UXToge1xuICAgICAgICAgIG1pbkFjdGl2ZSxcbiAgICAgICAgICBhY3R1YWxMZW5ndGg6IGZpbHRlcmVkQWN0aXZlRW50cmllcy5sZW5ndGhcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGZpbGVzVmFsaWRhdG9yKG9wdGlvbnM6IHtcbiAgICBtYXhpbXVtRmlsZVNpemVJbktiPzogbnVtYmVyO1xuICAgIHR5cGVQcmVmaXg/OiBzdHJpbmc7XG4gICAgYWxsb3dlZEZpbGVFbmRpbmdzPzogc3RyaW5nW107XG4gIH0pOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XG4gICAgICBjb25zdCBmaWxlczogeyBmaWxlOiBGaWxlIH1bXSB8IG51bGwgPSBjb250cm9sLnZhbHVlO1xuICAgICAgaWYgKCFmaWxlcykge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgZmlsZU9iaiBvZiBmaWxlcykge1xuICAgICAgICBjb25zdCBmaWxlID0gZmlsZU9iai5maWxlO1xuICAgICAgICBpZiAob3B0aW9ucy50eXBlUHJlZml4ICYmICFmaWxlLnR5cGUuc3RhcnRzV2l0aChvcHRpb25zLnR5cGVQcmVmaXgpKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHdyb25nRmlsZVR5cGU6IHtcbiAgICAgICAgICAgICAgd3JvbmdGaWxlVHlwZTogZmlsZS50eXBlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICBvcHRpb25zLmFsbG93ZWRGaWxlRW5kaW5ncz8ubGVuZ3RoICYmXG4gICAgICAgICAgIW9wdGlvbnMuYWxsb3dlZEZpbGVFbmRpbmdzLnNvbWUoZW5kaW5nID0+IGZpbGUubmFtZS5lbmRzV2l0aChlbmRpbmcpKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgd3JvbmdGaWxlRW5kaW5nOiB7XG4gICAgICAgICAgICAgIGFsbG93ZWRGaWxlRW5kaW5nczogb3B0aW9ucy5hbGxvd2VkRmlsZUVuZGluZ3NcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpbGUuc2l6ZSA+IG9wdGlvbnMubWF4aW11bUZpbGVTaXplSW5LYiAqIDEwMjQpIHtcbiAgICAgICAgICBjb25zdCBhY3R1YWxGaWxlU2l6ZSA9IGZpbGUuc2l6ZSAvIDEwMjQ7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1heEZpbGVTaXplUmVhY2hlZDoge1xuICAgICAgICAgICAgICBtYXhGaWxlU2l6ZTogb3B0aW9ucy5tYXhpbXVtRmlsZVNpemVJbktiLFxuICAgICAgICAgICAgICBhY3R1YWxGaWxlU2l6ZTogYH4ke2FjdHVhbEZpbGVTaXplLnRvRml4ZWQoMCl9YFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyByZW1vdmVFcnJvcnMoY29udHJvbDogQWJzdHJhY3RDb250cm9sLCBlcnJvcnM6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgaWYgKCFjb250cm9sIHx8ICFjb250cm9sLmVycm9ycykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBsZXQgcmVtb3ZlZEVycm9yID0gZmFsc2U7XG4gICAgZm9yIChjb25zdCBlcnJvciBvZiBlcnJvcnMpIHtcbiAgICAgIGlmIChjb250cm9sLmVycm9yc1tlcnJvcl0pIHtcbiAgICAgICAgcmVtb3ZlZEVycm9yID0gdHJ1ZTtcbiAgICAgICAgZGVsZXRlIGNvbnRyb2wuZXJyb3JzW2Vycm9yXTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlbW92ZWRFcnJvcikge1xuICAgICAgY29udHJvbC5zZXRFcnJvcnMoXG4gICAgICAgIE9iamVjdC5rZXlzKGNvbnRyb2wuZXJyb3JzKS5sZW5ndGggPyBPYmplY3QuYXNzaWduKHt9LCBjb250cm9sLmVycm9ycykgOiBudWxsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcmVtb3ZlZEVycm9yO1xuICB9XG59XG4iXX0=