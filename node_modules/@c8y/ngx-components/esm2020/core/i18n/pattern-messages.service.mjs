import { Injectable, Inject } from '@angular/core';
import { mapValues, each } from 'lodash-es';
import { HOOK_PATTERN_MESSAGES } from './patterns-message.hook';
import { formatDate } from '@angular/common';
import * as i0 from "@angular/core";
/**
 * A service to translate messages by using regexp patterns.
 */
export class PatternMessagesService {
    constructor(patterns) {
        this.patterns = {};
        this.pipes = {
            absoluteDate: (date) => formatDate(date, 'medium', this.translateService.currentLang),
            translate: key => this.translateService.instant(key)
        };
        each(patterns, pattern => {
            Object.assign(this.patterns, pattern);
        });
    }
    translate(message) {
        const translation = this.translateWithPatterns(message);
        return translation !== message ? translation : '';
    }
    translateWithPatterns(message, patterns = this.patterns) {
        let translatedMessage = message;
        each(patterns, (patternCfg, pattern) => {
            const globalRegExp = new RegExp(pattern, 'g');
            let globalMatch;
            if (!globalRegExp.test(translatedMessage)) {
                return;
            }
            globalRegExp.test(''); // reset the regexp
            globalMatch = globalRegExp.exec(translatedMessage);
            while (globalMatch !== null) {
                const [localMatch] = globalMatch;
                const placeholderValues = mapValues(patternCfg.placeholders, placeholder => {
                    const expr = placeholder.capture || placeholder;
                    let replacement = localMatch.replace(new RegExp(pattern, 'g'), expr);
                    if (placeholder.translate) {
                        replacement = this.translateWithPatterns(replacement, placeholder.translate);
                    }
                    return replacement;
                });
                translatedMessage = translatedMessage.replace(localMatch, this.translateWithParams(patternCfg, placeholderValues));
                globalMatch = globalRegExp.exec(translatedMessage);
            }
        });
        return translatedMessage;
    }
    translateWithParams(patternCfg, params = {}) {
        const { defaultLang, currentLang, compiler } = this.translateService;
        const translations = this.translateService.store.translations[currentLang];
        const defaultTranslations = this.translateService.store.translations[defaultLang];
        const originalKey = patternCfg.gettext;
        let originalValue = originalKey;
        if (translations) {
            if (translations[originalKey]) {
                originalValue = translations[originalKey];
            }
            else if (defaultTranslations) {
                if (defaultTranslations[originalKey]) {
                    originalValue = defaultTranslations[originalKey];
                }
            }
        }
        let key = originalKey;
        let value = originalValue;
        const interpolateParams = {
            ...params,
            noPatternMessages: true
        };
        let match;
        const pipeRegex = RegExp('{{\\s*([^\\s]+)\\s*\\|\\s*([^\\s]+)\\s*}}', 'g');
        // tslint:disable-next-line:no-conditional-assignment
        while ((match = pipeRegex.exec(originalKey)) !== null) {
            const [placeholder, paramName, pipeName] = match;
            if (this.pipes[pipeName]) {
                key = key.replace(placeholder, `{{${paramName}}}`);
                value = value.replace(placeholder, `{{${paramName}}}`);
                interpolateParams[paramName] = this.pipes[pipeName](params[paramName]);
            }
        }
        if (translations) {
            translations[key] = compiler.compile(value, currentLang);
        }
        return this.translateService.instant(key, interpolateParams);
    }
}
PatternMessagesService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PatternMessagesService, deps: [{ token: HOOK_PATTERN_MESSAGES }], target: i0.ɵɵFactoryTarget.Injectable });
PatternMessagesService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PatternMessagesService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PatternMessagesService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [HOOK_PATTERN_MESSAGES]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi1tZXNzYWdlcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9pMThuL3BhdHRlcm4tbWVzc2FnZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRCxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM1QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7O0FBRTdDOztHQUVHO0FBSUgsTUFBTSxPQUFPLHNCQUFzQjtJQVNqQyxZQUEyQyxRQUFRO1FBUG5ELGFBQVEsR0FBUSxFQUFFLENBQUM7UUFDbkIsVUFBSyxHQUFHO1lBQ04sWUFBWSxFQUFFLENBQUMsSUFBNEIsRUFBRSxFQUFFLENBQzdDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7WUFDL0QsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7U0FDckQsQ0FBQztRQUdBLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLEVBQUU7WUFDdkIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUFlO1FBQ3ZCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4RCxPQUFPLFdBQVcsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMs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JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IG1hcFZhbHVlcywgZWFjaCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBIT09LX1BBVFRFUk5fTUVTU0FHRVMgfSBmcm9tICcuL3BhdHRlcm5zLW1lc3NhZ2UuaG9vayc7XG5pbXBvcnQgeyBmb3JtYXREYXRlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuLyoqXG4gKiBBIHNlcnZpY2UgdG8gdHJhbnNsYXRlIG1lc3NhZ2VzIGJ5IHVzaW5nIHJlZ2V4cCBwYXR0ZXJucy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUGF0dGVybk1lc3NhZ2VzU2VydmljZSB7XG4gIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2U7XG4gIHBhdHRlcm5zOiBhbnkgPSB7fTtcbiAgcGlwZXMgPSB7XG4gICAgYWJzb2x1dGVEYXRlOiAoZGF0ZTogc3RyaW5nIHwgbnVtYmVyIHwgRGF0ZSkgPT5cbiAgICAgIGZvcm1hdERhdGUoZGF0ZSwgJ21lZGl1bScsIHRoaXMudHJhbnNsYXRlU2VydmljZS5jdXJyZW50TGFuZyksXG4gICAgdHJhbnNsYXRlOiBrZXkgPT4gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoa2V5KVxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoSE9PS19QQVRURVJOX01FU1NBR0VTKSBwYXR0ZXJucykge1xuICAgIGVhY2gocGF0dGVybnMsIHBhdHRlcm4gPT4ge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnBhdHRlcm5zLCBwYXR0ZXJuKTtcbiAgICB9KTtcbiAgfVxuXG4gIHRyYW5zbGF0ZShtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0cmFuc2xhdGlvbiA9IHRoaXMudHJhbnNsYXRlV2l0aFBhdHRlcm5zKG1lc3NhZ2UpO1xuICAgIHJldHVybiB0cmFuc2xhdGlvbiAhPT0gbWVzc2FnZSA/IHRyYW5zbGF0aW9uIDogJyc7XG4gIH1cblxuICBwcml2YXRlIHRyYW5zbGF0ZVdpdGhQYXR0ZXJucyhtZXNzYWdlLCBwYXR0ZXJucyA9IHRoaXMucGF0dGVybnMpIHtcbiAgICBsZXQgdHJhbnNsYXRlZE1lc3NhZ2UgPSBtZXNzYWdlO1xuXG4gICAgZWFjaChwYXR0ZXJucywgKHBhdHRlcm5DZmcsIHBhdHRlcm4pID0+IHtcbiAgICAgIGNvbnN0IGdsb2JhbFJlZ0V4cCA9IG5ldyBSZWdFeHAocGF0dGVybiwgJ2cnKTtcbiAgICAgIGxldCBnbG9iYWxNYXRjaDtcblxuICAgICAgaWYgKCFnbG9iYWxSZWdFeHAudGVzdCh0cmFuc2xhdGVkTWVzc2FnZSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZ2xvYmFsUmVnRXhwLnRlc3QoJycpOyAvLyByZXNldCB0aGUgcmVnZXhwXG4gICAgICBnbG9iYWxNYXRjaCA9IGdsb2JhbFJlZ0V4cC5leGVjKHRyYW5zbGF0ZWRNZXNzYWdlKTtcbiAgICAgIHdoaWxlIChnbG9iYWxNYXRjaCAhPT0gbnVsbCkge1xuICAgICAgICBjb25zdCBbbG9jYWxNYXRjaF0gPSBnbG9iYWxNYXRjaDtcblxuICAgICAgICBjb25zdCBwbGFjZWhvbGRlclZhbHVlcyA9IG1hcFZhbHVlcyhwYXR0ZXJuQ2ZnLnBsYWNlaG9sZGVycywgcGxhY2Vob2xkZXIgPT4ge1xuICAgICAgICAgIGNvbnN0IGV4cHIgPSBwbGFjZWhvbGRlci5jYXB0dXJlIHx8IHBsYWNlaG9sZGVyO1xuICAgICAgICAgIGxldCByZXBsYWNlbWVudCA9IGxvY2FsTWF0Y2gucmVwbGFjZShuZXcgUmVnRXhwKHBhdHRlcm4sICdnJyksIGV4cHIpO1xuXG4gICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLnRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgcmVwbGFjZW1lbnQgPSB0aGlzLnRyYW5zbGF0ZVdpdGhQYXR0ZXJucyhyZXBsYWNlbWVudCwgcGxhY2Vob2xkZXIudHJhbnNsYXRlKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnQ7XG4gICAgICAgIH0pO1xuICAgICAgICB0cmFuc2xhdGVkTWVzc2FnZSA9IHRyYW5zbGF0ZWRNZXNzYWdlLnJlcGxhY2UoXG4gICAgICAgICAgbG9jYWxNYXRjaCxcbiAgICAgICAgICB0aGlzLnRyYW5zbGF0ZVdpdGhQYXJhbXMocGF0dGVybkNmZywgcGxhY2Vob2xkZXJWYWx1ZXMpXG4gICAgICAgICk7XG5cbiAgICAgICAgZ2xvYmFsTWF0Y2ggPSBnbG9iYWxSZWdFeHAuZXhlYyh0cmFuc2xhdGVkTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRyYW5zbGF0ZWRNZXNzYWdlO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc2xhdGVXaXRoUGFyYW1zKHBhdHRlcm5DZmc6IGFueSwgcGFyYW1zOiBhbnkgPSB7fSkge1xuICAgIGNvbnN0IHsgZGVmYXVsdExhbmcsIGN1cnJlbnRMYW5nLCBjb21waWxlciB9ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuICAgIGNvbnN0IHRyYW5zbGF0aW9ucyA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5zdG9yZS50cmFuc2xhdGlvbnNbY3VycmVudExhbmddO1xuICAgIGNvbnN0IGRlZmF1bHRUcmFuc2xhdGlvbnMgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2Uuc3RvcmUudHJhbnNsYXRpb25zW2RlZmF1bHRMYW5nXTtcbiAgICBjb25zdCBvcmlnaW5hbEtleSA9IHBhdHRlcm5DZmcuZ2V0dGV4dDtcblxuICAgIGxldCBvcmlnaW5hbFZhbHVlID0gb3JpZ2luYWxLZXk7XG4gICAgaWYgKHRyYW5zbGF0aW9ucykge1xuICAgICAgaWYgKHRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV0pIHtcbiAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IHRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV07XG4gICAgICB9IGVsc2UgaWYgKGRlZmF1bHRUcmFuc2xhdGlvbnMpIHtcbiAgICAgICAgaWYgKGRlZmF1bHRUcmFuc2xhdGlvbnNbb3JpZ2luYWxLZXldKSB7XG4gICAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IGRlZmF1bHRUcmFuc2xhdGlvbnNbb3JpZ2luYWxLZXldO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGtleSA9IG9yaWdpbmFsS2V5O1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsVmFsdWU7XG4gICAgY29uc3QgaW50ZXJwb2xhdGVQYXJhbXMgPSB7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBub1BhdHRlcm5NZXNzYWdlczogdHJ1ZVxuICAgIH07XG5cbiAgICBsZXQgbWF0Y2g7XG4gICAgY29uc3QgcGlwZVJlZ2V4ID0gUmVnRXhwKCd7e1xcXFxzKihbXlxcXFxzXSspXFxcXHMqXFxcXHxcXFxccyooW15cXFxcc10rKVxcXFxzKn19JywgJ2cnKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uZGl0aW9uYWwtYXNzaWdubWVudFxuICAgIHdoaWxlICgobWF0Y2ggPSBwaXBlUmVnZXguZXhlYyhvcmlnaW5hbEtleSkpICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBbcGxhY2Vob2xkZXIsIHBhcmFtTmFtZSwgcGlwZU5hbWVdID0gbWF0Y2g7XG4gICAgICBpZiAodGhpcy5waXBlc1twaXBlTmFtZV0pIHtcbiAgICAgICAga2V5ID0ga2V5LnJlcGxhY2UocGxhY2Vob2xkZXIsIGB7eyR7cGFyYW1OYW1lfX19YCk7XG4gICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShwbGFjZWhvbGRlciwgYHt7JHtwYXJhbU5hbWV9fX1gKTtcbiAgICAgICAgaW50ZXJwb2xhdGVQYXJhbXNbcGFyYW1OYW1lXSA9IHRoaXMucGlwZXNbcGlwZU5hbWVdKHBhcmFtc1twYXJhbU5hbWVdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodHJhbnNsYXRpb25zKSB7XG4gICAgICB0cmFuc2xhdGlvbnNba2V5XSA9IGNvbXBpbGVyLmNvbXBpbGUodmFsdWUsIGN1cnJlbnRMYW5nKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGtleSwgaW50ZXJwb2xhdGVQYXJhbXMpO1xuICB9XG59XG4iXX0=