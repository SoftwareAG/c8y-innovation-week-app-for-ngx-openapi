import { Injectable } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { filter, map } from 'rxjs/operators';
import { DateContextQueryParamNames } from './widget-time-context.model';
import { WidgetTimeContextHelperService } from './widget-time-context-helper.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./widget-time-context-helper.service";
export class WidgetTimeContextQueryService {
    constructor(activatedRoute, helperService, router) {
        this.activatedRoute = activatedRoute;
        this.helperService = helperService;
        this.router = router;
    }
    queryParamsChange$() {
        return this.activatedRoute.queryParams.pipe(map((params) => {
            const realtime = this.parseRealtime(params.dateContextRealtime);
            return { ...params, dateContextRealtime: realtime };
        }), filter((params) => {
            if (!params.dateContextInterval && !params.dateContextFrom && !params.dateContextTo) {
                return false;
            }
            const isValidInterval = this.helperService.isSelectableInterval(params.dateContextInterval);
            const isValidDateRange = this.helperService.isValidDateRange(params.dateContextFrom, params.dateContextTo);
            if (!params.dateContextInterval) {
                return isValidDateRange;
            }
            if (!params.dateContextFrom && !params.dateContextTo) {
                return isValidInterval;
            }
            return isValidDateRange && isValidInterval;
        }));
    }
    dateTimeContextFromQueryParams() {
        const realtime = this.parseRealtime(this.activatedRoute.snapshot.queryParams[DateContextQueryParamNames.DATE_CONTEXT_REALTIME]);
        // trying to get date context from query params by interval first
        const dateContextInterval = this.activatedRoute.snapshot.queryParams[DateContextQueryParamNames.DATE_CONTEXT_INTERVAL];
        const isValidInterval = this.helperService.isSelectableInterval(dateContextInterval);
        if (isValidInterval) {
            return {
                date: this.helperService.getDateTimeContextByInterval(dateContextInterval),
                interval: dateContextInterval,
                realtime
            };
        }
        // if date context by interval is not provided, try getting date "from" and date "to" from query params
        const dateTimeContextFromQueryParams = this.getDateContextFromQueryParams();
        if (dateTimeContextFromQueryParams) {
            return { date: dateTimeContextFromQueryParams, interval: 'custom', realtime };
        }
        return null;
    }
    setDateContextQueryParams(interval, dateContext, realtime) {
        let queryParams;
        if (interval && interval !== 'custom') {
            queryParams = {
                dateContextInterval: interval,
                dateContextRealtime: `${realtime}`
            };
        }
        else {
            queryParams = {
                dateContextFrom: dateContext[0].toISOString(),
                dateContextTo: dateContext[1].toISOString(),
                dateContextRealtime: `${realtime}`
            };
        }
        this.router.navigate([], {
            relativeTo: this.activatedRoute,
            queryParams,
            replaceUrl: true
        });
    }
    clearQueryParams() {
        const clearingQueryParams = {
            dateContextFrom: null,
            dateContextTo: null,
            dateContextInterval: null,
            dateContextRealtime: null
        };
        this.router.navigate([], {
            relativeTo: this.activatedRoute,
            queryParams: clearingQueryParams,
            replaceUrl: true
        });
    }
    getDateContextFromQueryParams() {
        const dateContextFrom = this.activatedRoute.snapshot.queryParams[DateContextQueryParamNames.DATE_CONTEXT_FROM];
        const dateContextTo = this.activatedRoute.snapshot.queryParams[DateContextQueryParamNames.DATE_CONTEXT_TO];
        if (this.helperService.isValidDateRange(dateContextFrom, dateContextTo)) {
            return [new Date(dateContextFrom), new Date(dateContextTo)];
        }
        return null;
    }
    parseRealtime(realtime) {
        return realtime === 'false' ? false : realtime === 'true' ? true : null;
    }
}
WidgetTimeContextQueryService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: WidgetTimeContextQueryService, deps: [{ token: i1.ActivatedRoute }, { token: i2.WidgetTimeContextHelperService }, { token: i1.Router }], target: i0.ɵɵFactoryTarget.Injectable });
WidgetTimeContextQueryService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: WidgetTimeContextQueryService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: WidgetTimeContextQueryService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.ActivatedRoute }, { type: i2.WidgetTimeContextHelperService }, { type: i1.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXRpbWUtY29udGV4dC1xdWVyeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vY29yZS9kYXNoYm9hcmQvd2lnZXQtdGltZS1jb250ZXh0L3dpZGdldC10aW1lLWNvbnRleHQtcXVlcnkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQ0wsMEJBQTBCLEVBSTNCLE1BQU0sNkJBQTZCLENBQUM7QUFDckMsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7Ozs7QUFJdEYsTUFBTSxPQUFPLDZCQUE2QjtJQUN4QyxZQUNVLGNBQThCLEVBQzlCLGFBQTZDLEVBQzdDLE1BQWM7UUFGZCxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsa0JBQWEsR0FBYixhQUFhLENBQWdDO1FBQzdDLFdBQU0sR0FBTixNQUFNLENBQVE7SUFDckIsQ0FBQztJQUVKLGtCQUFrQjtRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDekMsR0FBRyxDQUFDLENBQUMsTUFBOEIsRUFBRSxFQUFFO1lBQ3JDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDaEUsT0FBTyxFQUFFLEdBQUcsTUFBTSxFQUFFLG1CQUFtQixFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQ3RELENBQUMsQ0FBQyxFQUNGLE1BQU0sQ0FBQyxDQUFDLE1BQThCLEVBQUUsRUFBRTtZQUN4QyxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixJ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QyxFQUFFLEVBQUU7WUFDdkIsVUFBVSxFQUFFLElBQUksQ0FBQyxjQUFjO1lBQy9CLFdBQVcsRUFBRSxtQkFBbUI7WUFDaEMsVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDZCQUE2QjtRQUNuQyxNQUFNLGVBQWUsR0FDbkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLDBCQUEwQixDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDekYsTUFBTSxhQUFhLEdBQ2pCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQywwQkFBMEIsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUV2RixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxFQUFFO1lBQ3ZFLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sYUFBYSxDQUFDLFFBQWdCO1FBQ3BDLE9BQU8sUUFBUSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUMxRSxDQUFDOzswSEEvR1UsNkJBQTZCOzhIQUE3Qiw2QkFBNkIsY0FEaEIsTUFBTTsyRkFDbkIsNkJBQTZCO2tCQUR6QyxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBEYXRlQ29udGV4dFF1ZXJ5UGFyYW1OYW1lcyxcbiAgRGF0ZUNvbnRleHRRdWVyeVBhcmFtcyxcbiAgV2lkZ2V0VGltZUNvbnRleHRTdGF0ZSxcbiAgSW50ZXJ2YWxcbn0gZnJvbSAnLi93aWRnZXQtdGltZS1jb250ZXh0Lm1vZGVsJztcbmltcG9ydCB7IFdpZGdldFRpbWVDb250ZXh0SGVscGVyU2VydmljZSB9IGZyb20gJy4vd2lkZ2V0LXRpbWUtY29udGV4dC1oZWxwZXIuc2VydmljZSc7XG5pbXBvcnQgeyBEYXRlVGltZUNvbnRleHQgfSBmcm9tICcuLi93aWRnZXQtY2hhbmdlLWV2ZW50Lm1vZGVsJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBXaWRnZXRUaW1lQ29udGV4dFF1ZXJ5U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgaGVscGVyU2VydmljZTogV2lkZ2V0VGltZUNvbnRleHRIZWxwZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXJcbiAgKSB7fVxuXG4gIHF1ZXJ5UGFyYW1zQ2hhbmdlJCgpOiBPYnNlcnZhYmxlPERhdGVDb250ZXh0UXVlcnlQYXJhbXM+IHtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmF0ZWRSb3V0ZS5xdWVyeVBhcmFtcy5waXBlKFxuICAgICAgbWFwKChwYXJhbXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pID0+IHtcbiAgICAgICAgY29uc3QgcmVhbHRpbWUgPSB0aGlzLnBhcnNlUmVhbHRpbWUocGFyYW1zLmRhdGVDb250ZXh0UmVhbHRpbWUpO1xuICAgICAgICByZXR1cm4geyAuLi5wYXJhbXMsIGRhdGVDb250ZXh0UmVhbHRpbWU6IHJlYWx0aW1lIH07XG4gICAgICB9KSxcbiAgICAgIGZpbHRlcigocGFyYW1zOiBEYXRlQ29udGV4dFF1ZXJ5UGFyYW1zKSA9PiB7XG4gICAgICAgIGlmICghcGFyYW1zLmRhdGVDb250ZXh0SW50ZXJ2YWwgJiYgIXBhcmFtcy5kYXRlQ29udGV4dEZyb20gJiYgIXBhcmFtcy5kYXRlQ29udGV4dFRvKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlzVmFsaWRJbnRlcnZhbCA9IHRoaXMuaGVscGVyU2VydmljZS5pc1NlbGVjdGFibGVJbnRlcnZhbChwYXJhbXMuZGF0ZUNvbnRleHRJbnRlcnZhbCk7XG4gICAgICAgIGNvbnN0IGlzVmFsaWREYXRlUmFuZ2UgPSB0aGlzLmhlbHBlclNlcnZpY2UuaXNWYWxpZERhdGVSYW5nZShcbiAgICAgICAgICBwYXJhbXMuZGF0ZUNvbnRleHRGcm9tLFxuICAgICAgICAgIHBhcmFtcy5kYXRlQ29udGV4dFRvXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKCFwYXJhbXMuZGF0ZUNvbnRleHRJbnRlcnZhbCkge1xuICAgICAgICAgIHJldHVybiBpc1ZhbGlkRGF0ZVJhbmdlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghcGFyYW1zLmRhdGVDb250ZXh0RnJvbSAmJiAhcGFyYW1zLmRhdGVDb250ZXh0VG8pIHtcbiAgICAgICAgICByZXR1cm4gaXNWYWxpZEludGVydmFsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpc1ZhbGlkRGF0ZVJhbmdlICYmIGlzVmFsaWRJbnRlcnZhbDtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRhdGVUaW1lQ29udGV4dEZyb21RdWVyeVBhcmFtcygpOiBXaWRnZXRUaW1lQ29udGV4dFN0YXRlIHwgbnVsbCB7XG4gICAgY29uc3QgcmVhbHRpbWUgPSB0aGlzLnBhcnNlUmVhbHRpbWUoXG4gICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zW0RhdGVDb250ZXh0UXVlcnlQYXJhbU5hbWVzLkRBVEVfQ09OVEVYVF9SRUFMVElNRV1cbiAgICApO1xuICAgIC8vIHRyeWluZyB0byBnZXQgZGF0ZSBjb250ZXh0IGZyb20gcXVlcnkgcGFyYW1zIGJ5IGludGVydmFsIGZpcnN0XG4gICAgY29uc3QgZGF0ZUNvbnRleHRJbnRlcnZhbCA9XG4gICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zW0RhdGVDb250ZXh0UXVlcnlQYXJhbU5hbWVzLkRBVEVfQ09OVEVYVF9JTlRFUlZBTF07XG4gICAgY29uc3QgaXNWYWxpZEludGVydmFsID0gdGhpcy5oZWxwZXJTZXJ2aWNlLmlzU2VsZWN0YWJsZUludGVydmFsKGRhdGVDb250ZXh0SW50ZXJ2YWwpO1xuICAgIGlmIChpc1ZhbGlkSW50ZXJ2YWwpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGRhdGU6IHRoaXMuaGVscGVyU2VydmljZS5nZXREYXRlVGltZUNvbnRleHRCeUludGVydmFsKGRhdGVDb250ZXh0SW50ZXJ2YWwpLFxuICAgICAgICBpbnRlcnZhbDogZGF0ZUNvbnRleHRJbnRlcnZhbCxcbiAgICAgICAgcmVhbHRpbWVcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gaWYgZGF0ZSBjb250ZXh0IGJ5IGludGVydmFsIGlzIG5vdCBwcm92aWRlZCwgdHJ5IGdldHRpbmcgZGF0ZSBcImZyb21cIiBhbmQgZGF0ZSBcInRvXCIgZnJvbSBxdWVyeSBwYXJhbXNcbiAgICBjb25zdCBkYXRlVGltZUNvbnRleHRGcm9tUXVlcnlQYXJhbXMgPSB0aGlzLmdldERhdGVDb250ZXh0RnJvbVF1ZXJ5UGFyYW1zKCk7XG4gICAgaWYgKGRhdGVUaW1lQ29udGV4dEZyb21RdWVyeVBhcmFtcykge1xuICAgICAgcmV0dXJuIHsgZGF0ZTogZGF0ZVRpbWVDb250ZXh0RnJvbVF1ZXJ5UGFyYW1zLCBpbnRlcnZhbDogJ2N1c3RvbScsIHJlYWx0aW1lIH07XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgc2V0RGF0ZUNvbnRleHRRdWVyeVBhcmFtcyhcbiAgICBpbnRlcnZhbDogSW50ZXJ2YWxbJ2lkJ10sXG4gICAgZGF0ZUNvbnRleHQ6IERhdGVUaW1lQ29udGV4dCxcbiAgICByZWFsdGltZTogYm9vbGVhblxuICApOiB2b2lkIHtcbiAgICBsZXQgcXVlcnlQYXJhbXM6IFBhcnRpYWw8UmVjb3JkPERhdGVDb250ZXh0UXVlcnlQYXJhbU5hbWVzLCBzdHJpbmc+PjtcbiAgICBpZiAoaW50ZXJ2YWwgJiYgaW50ZXJ2YWwgIT09ICdjdXN0b20nKSB7XG4gICAgICBxdWVyeVBhcmFtcyA9IHtcbiAgICAgICAgZGF0ZUNvbnRleHRJbnRlcnZhbDogaW50ZXJ2YWwsXG4gICAgICAgIGRhdGVDb250ZXh0UmVhbHRpbWU6IGAke3JlYWx0aW1lfWBcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHF1ZXJ5UGFyYW1zID0ge1xuICAgICAgICBkYXRlQ29udGV4dEZyb206IGRhdGVDb250ZXh0WzBdLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGRhdGVDb250ZXh0VG86IGRhdGVDb250ZXh0WzFdLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGRhdGVDb250ZXh0UmVhbHRpbWU6IGAke3JlYWx0aW1lfWBcbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtdLCB7XG4gICAgICByZWxhdGl2ZVRvOiB0aGlzLmFjdGl2YXRlZFJvdXRlLFxuICAgICAgcXVlcnlQYXJhbXMsXG4gICAgICByZXBsYWNlVXJsOiB0cnVlXG4gICAgfSk7XG4gIH1cblxuICBjbGVhclF1ZXJ5UGFyYW1zKCk6IHZvaWQge1xuICAgIGNvbnN0IGNsZWFyaW5nUXVlcnlQYXJhbXM6IFJlY29yZDxEYXRlQ29udGV4dFF1ZXJ5UGFyYW1OYW1lcywgbnVsbD4gPSB7XG4gICAgICBkYXRlQ29udGV4dEZyb206IG51bGwsXG4gICAgICBkYXRlQ29udGV4dFRvOiBudWxsLFxuICAgICAgZGF0ZUNvbnRleHRJbnRlcnZhbDogbnVsbCxcbiAgICAgIGRhdGVDb250ZXh0UmVhbHRpbWU6IG51bGxcbiAgICB9O1xuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtdLCB7XG4gICAgICByZWxhdGl2ZVRvOiB0aGlzLmFjdGl2YXRlZFJvdXRlLFxuICAgICAgcXVlcnlQYXJhbXM6IGNsZWFyaW5nUXVlcnlQYXJhbXMsXG4gICAgICByZXBsYWNlVXJsOiB0cnVlXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldERhdGVDb250ZXh0RnJvbVF1ZXJ5UGFyYW1zKCk6IERhdGVUaW1lQ29udGV4dCB8IG51bGwge1xuICAgIGNvbnN0IGRhdGVDb250ZXh0RnJvbSA9XG4gICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zW0RhdGVDb250ZXh0UXVlcnlQYXJhbU5hbWVzLkRBVEVfQ09OVEVYVF9GUk9NXTtcbiAgICBjb25zdCBkYXRlQ29udGV4dFRvID1cbiAgICAgIHRoaXMuYWN0aXZhdGVkUm91dGUuc25hcHNob3QucXVlcnlQYXJhbXNbRGF0ZUNvbnRleHRRdWVyeVBhcmFtTmFtZXMuREFURV9DT05URVhUX1RPXTtcblxuICAgIGlmICh0aGlzLmhlbHBlclNlcnZpY2UuaXNWYWxpZERhdGVSYW5nZShkYXRlQ29udGV4dEZyb20sIGRhdGVDb250ZXh0VG8pKSB7XG4gICAgICByZXR1cm4gW25ldyBEYXRlKGRhdGVDb250ZXh0RnJvbSksIG5ldyBEYXRlKGRhdGVDb250ZXh0VG8pXTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUmVhbHRpbWUocmVhbHRpbWU6IHN0cmluZyk6IGJvb2xlYW4gfCBudWxsIHtcbiAgICByZXR1cm4gcmVhbHRpbWUgPT09ICdmYWxzZScgPyBmYWxzZSA6IHJlYWx0aW1lID09PSAndHJ1ZScgPyB0cnVlIDogbnVsbDtcbiAgfVxufVxuIl19