import { Injectable } from '@angular/core';
import { InventoryService } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
import { NEVER, of } from 'rxjs';
import { distinctUntilChanged, filter, map, mergeMap, switchMap, tap } from 'rxjs/operators';
import { AppStateService } from '../common/ui-state.service';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@c8y/ngx-components/api";
import * as i3 from "../common/ui-state.service";
/**
 * AssetTypesService is being used to manage a cache of all existing asset types.
 * This service is injected in the AssetOverviewNavigationFactory class, which will trigger
 * the initialization of the cache as the constructor is called.
 */
export class AssetTypesService {
    constructor(inventory, apiService, appStateService) {
        this.inventory = inventory;
        this.apiService = apiService;
        this.appStateService = appStateService;
        this.ASSET_TYPE_GROUP_QUERY = {
            __filter: {
                __and: [{ __has: 'c8y_IsAssetType' }, { name: 'group' }]
            }
        };
        this.DEFAULT_ASSET_ICON = 'c8y-enterprise';
        this.assetTypesCache = {};
        this.allowedMethods = ['POST', 'PUT', 'DELETE'];
        this.isCacheSet = false;
        this.appStateService.currentUser
            .pipe(map(user => user?.id), distinctUntilChanged(), switchMap(userId => {
            if (userId) {
                this.initAssetTypesCache();
                return this.subscribeForAssetTypeUpdates();
            }
            else {
                this.assetTypesCache = {};
                return NEVER;
            }
        }))
            .subscribe();
    }
    /**
     * Queries available asset types and adds every asset type to the local cache.
     * @returns IManagedObject table of asset types.
     */
    async initAssetTypesCache() {
        const { data } = await this.inventory.list({
            fragmentType: 'c8y_IsAssetType',
            withChildren: false,
            pageSize: 2000
        });
        data.forEach(assetType => this.addAssetType(assetType));
        this.isCacheSet = true;
        return data;
    }
    /**
     * Returns an asset type from the cache based on the unique name property.
     * @param name Name of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeByName(name) {
        if (!this.assetTypesCache.hasOwnProperty(name)) {
            return undefined;
        }
        return this.assetTypesCache[name];
    }
    /**
     * Returns an asset type from the cache based on the id.
     * @param assetTypeId Id of the asset type.
     * @returns IManagedObject which represents the asset type.
     */
    getAssetTypeById(assetTypeId) {
        if (!assetTypeId) {
            return;
        }
        return Object.values(this.assetTypesCache).find((assetType) => assetType.id === assetTypeId);
    }
    /**
     * Extracts an icon from an asset type.
     * @param type Type of the asset type.
     * @returns Returns an icon for a given asset type.
     */
    async getIcon(type) {
        if (!this.isCacheSet) {
            try {
                await this.initAssetTypesCache();
            }
            catch (error) {
                // do nothing
            }
        }
        const assetType = this.getAssetTypeByName(type);
        return assetType?.c8y_IsAssetType?.icon?.name || this.DEFAULT_ASSET_ICON;
    }
    /**
     * Add an asset type to the local cache.
     * @param assetType Asset type which should be added to the cache.
     * @returns void.
     */
    addAssetType(assetType) {
        this.assetTypesCache[assetType.name] = assetType;
    }
    /**
     * Delete an asset type from the local cache based on the given asset type id.
     * @param assetTypeId Id of the asset type which should be deleted.
     * @returns void.
     */
    deleteAssetType(assetTypeId) {
        const assetType = this.getAssetTypeById(assetTypeId);
        if (assetType) {
            delete this.assetTypesCache[assetType.name];
        }
    }
    /**
     * Update an asset type in the local cache.
     * @param assetType Asset type which should be updated in the cache.
     * @returns void.
     */
    updateAssetType(assetType) {
        const cachedAssetType = this.getAssetTypeById(assetType.id);
        if (cachedAssetType) {
            this.assetTypesCache[cachedAssetType.name] = Object.assign(cachedAssetType, assetType);
        }
    }
    /**
     * Subscribes to api PUT, POST and DELETE requests interceptor to update local asset types cache.
     * If a new asset type has been created it will be added to the local cache. If an asset
     * type has been deleted it will be removed from the local cache.
     */
    subscribeForAssetTypeUpdates() {
        return this.apiService
            .hookResponse(c => this.checkIfInventoryMoApiCall(c))
            .pipe(filter((call) => !!call?.method && this.isExpectedMethod(call)), mergeMap((this.apiService.resolveData)), switchMap(({ method, data, url }) => method === 'DELETE' ? this.handleDelete(method, url) : of(data)), filter((mo) => !!mo && this.hasIsAssetTypeFragment(mo)), tap((mo) => this.handlePutOrPost(mo)));
    }
    isExpectedMethod(call) {
        return this.allowedMethods.includes(call?.method);
    }
    handleDelete(method, url) {
        const moId = this.getMoIdFromUrl(url);
        if (method !== 'DELETE' || !moId) {
            return NEVER;
        }
        this.deleteAssetType(moId);
        return NEVER;
    }
    handlePutOrPost(mo) {
        if (this.getAssetTypeById(mo.id)) {
            this.updateAssetType(mo);
        }
        else {
            this.addAssetType(mo);
        }
    }
    hasIsAssetTypeFragment(mo) {
        return mo?.hasOwnProperty('c8y_IsAssetType');
    }
    getMoIdFromUrl(url) {
        const regex = /managedObjects\/(\d+)/;
        const match = url.match(regex);
        if (match) {
            const moId = match[1];
            return moId;
        }
        return;
    }
    /**
     * Managed objects inventory api filter, allowing only PUT, POST and DELETE methods.
     * @param call Api call to filter.
     * @returns Returns true if api call meets the required criteria.
     */
    checkIfInventoryMoApiCall(call) {
        if (!call) {
            return false;
        }
        const hasRequiredMethod = call.method === 'POST' || call.method === 'DELETE' || call.method === 'PUT';
        const hasRequiredUrl = call.url.includes('managedObjects');
        return hasRequiredMethod && hasRequiredUrl;
    }
}
AssetTypesService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AssetTypesService, deps: [{ token: i1.InventoryService }, { token: i2.ApiService }, { token: i3.AppStateService }], target: i0.ɵɵFactoryTarget.Injectable });
AssetTypesService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AssetTypesService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AssetTypesService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.InventoryService }, { type: i2.ApiService }, { type: i3.AppStateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtdHlwZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvYXNzZXQtdHlwZXMvYXNzZXQtdHlwZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBa0IsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7OztBQUU3RDs7OztHQUlHO0FBRUgsTUFBTSxPQUFPLGlCQUFpQjtJQVc1QixZQUNVLFNBQTJCLEVBQzNCLFVBQXNCLEVBQ3RCLGVBQWdDO1FBRmhDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBYnpCLDJCQUFzQixHQUFHO1lBQ3hDLFFBQVEsRUFBRTtnQkFDUixLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDO2FBQ3pEO1NBQ0YsQ0FBQztRQUNlLHVCQUFrQixHQUFHLGdCQUFnQixDQUFDO1FBQy9DLG9CQUFlLEdBQVcsRUFBRSxDQUFDO1FBQzdCLG1CQUFjLEdBQUcsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLGVBQVUsR0FBRyxLQUFLLENBQUM7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QUksQ0FBQyxNQUFNLEtBQUssS0FBSyxDQUFDO1FBQzlFLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0QsT0FBTyxpQkFBaUIsSUFBSSxjQUFjLENBQUM7SUFDN0MsQ0FBQzs7OEdBbk1VLGlCQUFpQjtrSEFBakIsaUJBQWlCLGNBREosTUFBTTsyRkFDbkIsaUJBQWlCO2tCQUQ3QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBpQ2FsbCwgQXBpU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvYXBpJztcbmltcG9ydCB7IE5FVkVSLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5cbi8qKlxuICogQXNzZXRUeXBlc1NlcnZpY2UgaXMgYmVpbmcgdXNlZCB0byBtYW5hZ2UgYSBjYWNoZSBvZiBhbGwgZXhpc3RpbmcgYXNzZXQgdHlwZXMuXG4gKiBUaGlzIHNlcnZpY2UgaXMgaW5qZWN0ZWQgaW4gdGhlIEFzc2V0T3ZlcnZpZXdOYXZpZ2F0aW9uRmFjdG9yeSBjbGFzcywgd2hpY2ggd2lsbCB0cmlnZ2VyXG4gKiB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNhY2hlIGFzIHRoZSBjb25zdHJ1Y3RvciBpcyBjYWxsZWQuXG4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgQXNzZXRUeXBlc1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IEFTU0VUX1RZUEVfR1JPVVBfUVVFUlkgPSB7XG4gICAgX19maWx0ZXI6IHtcbiAgICAgIF9fYW5kOiBbeyBfX2hhczogJ2M4eV9Jc0Fzc2V0VHlwZScgfSwgeyBuYW1lOiAnZ3JvdXAnIH1dXG4gICAgfVxuICB9O1xuICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfQVNTRVRfSUNPTiA9ICdjOHktZW50ZXJwcmlzZSc7XG4gIHByaXZhdGUgYXNzZXRUeXBlc0NhY2hlOiBvYmplY3QgPSB7fTtcbiAgcHJpdmF0ZSBhbGxvd2VkTWV0aG9kcyA9IFsnUE9TVCcsICdQVVQnLCAnREVMRVRFJ107XG4gIHByaXZhdGUgaXNDYWNoZVNldCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW52ZW50b3J5OiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBpU2VydmljZTogQXBpU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFN0YXRlU2VydmljZTogQXBwU3RhdGVTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuYXBwU3RhdGVTZXJ2aWNlLmN1cnJlbnRVc2VyXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHVzZXIgPT4gdXNlcj8uaWQpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBzd2l0Y2hNYXAodXNlcklkID0+IHtcbiAgICAgICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRBc3NldFR5cGVzQ2FjaGUoKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZUZvckFzc2V0VHlwZVVwZGF0ZXMoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hc3NldFR5cGVzQ2FjaGUgPSB7fTtcbiAgICAgICAgICAgIHJldHVybiBORVZFUjtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogUXVlcmllcyBhdmFpbGFibGUgYXNzZXQgdHlwZXMgYW5kIGFkZHMgZXZlcnkgYXNzZXQgdHlwZSB0byB0aGUgbG9jYWwgY2FjaGUuXG4gICAqIEByZXR1cm5zIElNYW5hZ2VkT2JqZWN0IHRhYmxlIG9mIGFzc2V0IHR5cGVzLlxuICAgKi9cbiAgYXN5bmMgaW5pdEFzc2V0VHlwZXNDYWNoZSgpOiBQcm9taXNlPElNYW5hZ2VkT2JqZWN0W10+IHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5Lmxpc3Qoe1xuICAgICAgZnJhZ21lbnRUeXBlOiAnYzh5X0lzQXNzZXRUeXBlJyxcbiAgICAgIHdpdGhDaGlsZHJlbjogZmFsc2UsXG4gICAgICBwYWdlU2l6ZTogMjAwMFxuICAgIH0pO1xuICAgIGRhdGEuZm9yRWFjaChhc3NldFR5cGUgPT4gdGhpcy5hZGRBc3NldFR5cGUoYXNzZXRUeXBlKSk7XG5cbiAgICB0aGlzLmlzQ2FjaGVTZXQgPSB0cnVlO1xuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gYXNzZXQgdHlwZSBmcm9tIHRoZSBjYWNoZSBiYXNlZCBvbiB0aGUgdW5pcXVlIG5hbWUgcHJvcGVydHkuXG4gICAqIEBwYXJhbSBuYW1lIE5hbWUgb2YgdGhlIGFzc2V0IHR5cGUuXG4gICAqIEByZXR1cm5zIElNYW5hZ2VkT2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgdGhlIGFzc2V0IHR5cGUuXG4gICAqL1xuICBnZXRBc3NldFR5cGVCeU5hbWUobmFtZTogc3RyaW5nKTogSU1hbmFnZWRPYmplY3Qge1xuICAgIGlmICghdGhpcy5hc3NldFR5cGVzQ2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYXNzZXRUeXBlc0NhY2hlW25hbWVdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gYXNzZXQgdHlwZSBmcm9tIHRoZSBjYWNoZSBiYXNlZCBvbiB0aGUgaWQuXG4gICAqIEBwYXJhbSBhc3NldFR5cGVJZCBJZCBvZiB0aGUgYXNzZXQgdHlwZS5cbiAgICogQHJldHVybnMgSU1hbmFnZWRPYmplY3Qgd2hpY2ggcmVwcmVzZW50cyB0aGUgYXNzZXQgdHlwZS5cbiAgICovXG4gIGdldEFzc2V0VHlwZUJ5SWQoYXNzZXRUeXBlSWQ6IHN0cmluZyk6IElNYW5hZ2VkT2JqZWN0IHtcbiAgICBpZiAoIWFzc2V0VHlwZUlkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5hc3NldFR5cGVzQ2FjaGUpLmZpbmQoXG4gICAgICAoYXNzZXRUeXBlOiBJTWFuYWdlZE9iamVjdCkgPT4gYXNzZXRUeXBlLmlkID09PSBhc3NldFR5cGVJZFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgYW4gaWNvbiBmcm9tIGFuIGFzc2V0IHR5cGUuXG4gICAqIEBwYXJhbSB0eXBlIFR5cGUgb2YgdGhlIGFzc2V0IHR5cGUuXG4gICAqIEByZXR1cm5zIFJldHVybnMgYW4gaWNvbiBmb3IgYSBnaXZlbiBhc3NldCB0eXBlLlxuICAgKi9cbiAgYXN5bmMgZ2V0SWNvbih0eXBlOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICghdGhpcy5pc0NhY2hlU2V0KSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmluaXRBc3NldFR5cGVzQ2FjaGUoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgYXNzZXRUeXBlID0gdGhpcy5nZXRBc3NldFR5cGVCeU5hbWUodHlwZSk7XG4gICAgcmV0dXJuIGFzc2V0VHlwZT8uYzh5X0lzQXNzZXRUeXBlPy5pY29uPy5uYW1lIHx8IHRoaXMuREVGQVVMVF9BU1NFVF9JQ09OO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhbiBhc3NldCB0eXBlIHRvIHRoZSBsb2NhbCBjYWNoZS5cbiAgICogQHBhcmFtIGFzc2V0VHlwZSBBc3NldCB0eXBlIHdoaWNoIHNob3VsZCBiZSBhZGRlZCB0byB0aGUgY2FjaGUuXG4gICAqIEByZXR1cm5zIHZvaWQuXG4gICAqL1xuICBwcml2YXRlIGFkZEFzc2V0VHlwZShhc3NldFR5cGU6IElNYW5hZ2VkT2JqZWN0KTogdm9pZCB7XG4gICAgdGhpcy5hc3NldFR5cGVzQ2FjaGVbYXNzZXRUeXBlLm5hbWVdID0gYXNzZXRUeXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhbiBhc3NldCB0eXBlIGZyb20gdGhlIGxvY2FsIGNhY2hlIGJhc2VkIG9uIHRoZSBnaXZlbiBhc3NldCB0eXBlIGlkLlxuICAgKiBAcGFyYW0gYXNzZXRUeXBlSWQgSWQgb2YgdGhlIGFzc2V0IHR5cGUgd2hpY2ggc2hvdWxkIGJlIGRlbGV0ZWQuXG4gICAqIEByZXR1cm5zIHZvaWQuXG4gICAqL1xuICBwcml2YXRlIGRlbGV0ZUFzc2V0VHlwZShhc3NldFR5cGVJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgYXNzZXRUeXBlID0gdGhpcy5nZXRBc3NldFR5cGVCeUlkKGFzc2V0VHlwZUlkKTtcbiAgICBpZiAoYXNzZXRUeXBlKSB7XG4gICAgICBkZWxldGUgdGhpcy5hc3NldFR5cGVzQ2FjaGVbYXNzZXRUeXBlLm5hbWVdO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogVXBkYXRlIGFuIGFzc2V0IHR5cGUgaW4gdGhlIGxvY2FsIGNhY2hlLlxuICAgKiBAcGFyYW0gYXNzZXRUeXBlIEFzc2V0IHR5cGUgd2hpY2ggc2hvdWxkIGJlIHVwZGF0ZWQgaW4gdGhlIGNhY2hlLlxuICAgKiBAcmV0dXJucyB2b2lkLlxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVBc3NldFR5cGUoYXNzZXRUeXBlOiBJTWFuYWdlZE9iamVjdCk6IHZvaWQge1xuICAgIGNvbnN0IGNhY2hlZEFzc2V0VHlwZSA9IHRoaXMuZ2V0QXNzZXRUeXBlQnlJZChhc3NldFR5cGUuaWQpO1xuICAgIGlmIChjYWNoZWRBc3NldFR5cGUpIHtcbiAgICAgIHRoaXMuYXNzZXRUeXBlc0NhY2hlW2NhY2hlZEFzc2V0VHlwZS5uYW1lXSA9IE9iamVjdC5hc3NpZ24oY2FjaGVkQXNzZXRUeXBlLCBhc3NldFR5cGUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmVzIHRvIGFwaSBQVVQsIFBPU1QgYW5kIERFTEVURSByZXF1ZXN0cyBpbnRlcmNlcHRvciB0byB1cGRhdGUgbG9jYWwgYXNzZXQgdHlwZXMgY2FjaGUuXG4gICAqIElmIGEgbmV3IGFzc2V0IHR5cGUgaGFzIGJlZW4gY3JlYXRlZCBpdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBsb2NhbCBjYWNoZS4gSWYgYW4gYXNzZXRcbiAgICogdHlwZSBoYXMgYmVlbiBkZWxldGVkIGl0IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBsb2NhbCBjYWNoZS5cbiAgICovXG4gIHByaXZhdGUgc3Vic2NyaWJlRm9yQXNzZXRUeXBlVXBkYXRlcygpIHtcbiAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlXG4gICAgICAuaG9va1Jlc3BvbnNlKGMgPT4gdGhpcy5jaGVja0lmSW52ZW50b3J5TW9BcGlDYWxsKGMpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoY2FsbDogQXBpQ2FsbCkgPT4gISFjYWxsPy5tZXRob2QgJiYgdGhpcy5pc0V4cGVjdGVkTWV0aG9kKGNhbGwpKSxcbiAgICAgICAgbWVyZ2VNYXAodGhpcy5hcGlTZXJ2aWNlLnJlc29sdmVEYXRhPElNYW5hZ2VkT2JqZWN0IHwgbnVsbD4pLFxuICAgICAgICBzd2l0Y2hNYXAoKHsgbWV0aG9kLCBkYXRhLCB1cmwgfSkgPT5cbiAgICAgICAgICBtZXRob2QgPT09ICdERUxFVEUnID8gdGhpcy5oYW5kbGVEZWxldGUobWV0aG9kLCB1cmwpIDogb2YoZGF0YSlcbiAgICAgICAgKSxcbiAgICAgICAgZmlsdGVyKChtbzogSU1hbmFnZWRPYmplY3QpID0+ICEhbW8gJiYgdGhpcy5oYXNJc0Fzc2V0VHlwZUZyYWdtZW50KG1vKSksXG4gICAgICAgIHRhcCgobW86IElNYW5hZ2VkT2JqZWN0KSA9PiB0aGlzLmhhbmRsZVB1dE9yUG9zdChtbykpXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0V4cGVjdGVkTWV0aG9kKGNhbGw6IEFwaUNhbGwpIHtcbiAgICByZXR1cm4gdGhpcy5hbGxvd2VkTWV0aG9kcy5pbmNsdWRlcyhjYWxsPy5tZXRob2QpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVEZWxldGUobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nKSB7XG4gICAgY29uc3QgbW9JZDogc3RyaW5nID0gdGhpcy5nZXRNb0lkRnJvbVVybCh1cmwpO1xuICAgIGlmIChtZXRob2QgIT09ICdERUxFVEUnIHx8ICFtb0lkKSB7XG4gICAgICByZXR1cm4gTkVWRVI7XG4gICAgfVxuICAgIHRoaXMuZGVsZXRlQXNzZXRUeXBlKG1vSWQpO1xuICAgIHJldHVybiBORVZFUjtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlUHV0T3JQb3N0KG1vOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGlmICh0aGlzLmdldEFzc2V0VHlwZUJ5SWQobW8uaWQpKSB7XG4gICAgICB0aGlzLnVwZGF0ZUFzc2V0VHlwZShtbyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWRkQXNzZXRUeXBlKG1vKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhc0lzQXNzZXRUeXBlRnJhZ21lbnQobW86IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgcmV0dXJuIG1vPy5oYXNPd25Qcm9wZXJ0eSgnYzh5X0lzQXNzZXRUeXBlJyk7XG4gIH1cblxuICBwcml2YXRlIGdldE1vSWRGcm9tVXJsKHVybDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVnZXggPSAvbWFuYWdlZE9iamVjdHNcXC8oXFxkKykvO1xuICAgIGNvbnN0IG1hdGNoID0gdXJsLm1hdGNoKHJlZ2V4KTtcblxuICAgIGlmIChtYXRjaCkge1xuICAgICAgY29uc3QgbW9JZCA9IG1hdGNoWzFdO1xuICAgICAgcmV0dXJuIG1vSWQ7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYW5hZ2VkIG9iamVjdHMgaW52ZW50b3J5IGFwaSBmaWx0ZXIsIGFsbG93aW5nIG9ubHkgUFVULCBQT1NUIGFuZCBERUxFVEUgbWV0aG9kcy5cbiAgICogQHBhcmFtIGNhbGwgQXBpIGNhbGwgdG8gZmlsdGVyLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHRydWUgaWYgYXBpIGNhbGwgbWVldHMgdGhlIHJlcXVpcmVkIGNyaXRlcmlhLlxuICAgKi9cbiAgcHJpdmF0ZSBjaGVja0lmSW52ZW50b3J5TW9BcGlDYWxsKGNhbGw6IEFwaUNhbGwpOiBib29sZWFuIHtcbiAgICBpZiAoIWNhbGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNSZXF1aXJlZE1ldGhvZCA9XG4gICAgICBjYWxsLm1ldGhvZCA9PT0gJ1BPU1QnIHx8IGNhbGwubWV0aG9kID09PSAnREVMRVRFJyB8fCBjYWxsLm1ldGhvZCA9PT0gJ1BVVCc7XG4gICAgY29uc3QgaGFzUmVxdWlyZWRVcmwgPSBjYWxsLnVybC5pbmNsdWRlcygnbWFuYWdlZE9iamVjdHMnKTtcbiAgICByZXR1cm4gaGFzUmVxdWlyZWRNZXRob2QgJiYgaGFzUmVxdWlyZWRVcmw7XG4gIH1cbn1cbiJdfQ==