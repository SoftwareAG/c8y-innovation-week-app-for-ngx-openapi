import { Injectable } from '@angular/core';
import { ApplicationAvailability } from '@c8y/client';
import { ApplicationService } from '@c8y/ngx-components/api';
import { cloneDeep, get, uniqBy } from 'lodash-es';
import { coerce, compare } from 'semver';
import { AppStateService } from '../common/ui-state.service';
import { groupBy } from 'lodash-es';
import { PackageType } from './plugins.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components/api";
import * as i2 from "../common/ui-state.service";
export class PluginsService {
    constructor(applicationService, appStateService) {
        this.applicationService = applicationService;
        this.appStateService = appStateService;
    }
    /**
     * Fetches a list of available packages.
     * @param params Additional query parameters.
     * @returns Returns a list of packages.
     */
    async listPackages(params = {}) {
        const apps = await this.listApplicationsByCurrentTenant(params);
        const webApps = apps.filter(app => this.isPackage(app));
        const uniqueWebApps = this.removeDuplicates(webApps, 'contextPath');
        return uniqueWebApps.sort((a, b) => a.name.localeCompare(b.name));
    }
    /**
     * Checks if an application is a package.
     * @param application Application managed object.
     * @returns Returns true if the application is a package.
     */
    isPackage(application) {
        return application.manifest?.isPackage === true;
    }
    /**
     * Updates the remotes field in the application configuration by adding new plugins.
     * Important: if the remotes object is not set on the configuration object,
     * remotes will not be added. Make sure that this object exists in the application configuration.
     * @param application Application managed object.
     * @param plugins List of remotes to be added.
     * @returns Returns updated application remotes.
     */
    async addRemotes(application, plugins) {
        const appConfigRemotes = application?.config?.remotes;
        if (appConfigRemotes) {
            const newRemotes = this.addPluginToRemotes(appConfigRemotes, plugins);
            return await this.updateRemotesInAppConfig(application, newRemotes);
        }
        return;
    }
    /**
     * Updates the remotes field in the application configuration by removing plugins.
     * @param application Application managed object.
     * @param plugins List of remotes to be removed.
     * @returns Returns updated application remotes.
     */
    async removeRemotes(application, plugins) {
        const appConfigRemotes = application?.config?.remotes;
        const newRemotes = this.removePluginsFromRemotes(appConfigRemotes, plugins);
        return await this.updateRemotesInAppConfig(application, newRemotes);
    }
    /**
     * Updates the remotes field in the application configuration.
     * @param application Application managed object.
     * @param plugins List of remotes to be added.
     * @returns Returns updated application remotes.
     */
    async updateRemotesInAppConfig(application, plugins) {
        const updatedAppWithConfig = await this.applicationService.updateApplicationConfig(application, {
            remotes: plugins
        });
        return updatedAppWithConfig?.config?.remotes || {};
    }
    /**
     * Fetches the application manifest.
     * @param application Application managed object.
     * @returns Returns the application manifest.
     */
    async getCumulocityJsonFile(application) {
        const c8yJson = await this.applicationService.getAppManifest(application);
        if (!c8yJson.remotes) {
            c8yJson.remotes = {};
        }
        return c8yJson;
    }
    /**
     * Sets the initial state of remotes in the configuration (when it's missing), based on the list of remotes being in the application manifest.
     * @param application  Application managed object.
     * @returns Returns a list of remotes that has been assigned to the configuration object.
     */
    async setInitialRemotes(application) {
        try {
            const manifestRemotes = (await this.getCumulocityJsonFile(application))?.remotes;
            if (manifestRemotes) {
                // If there is no remotes in the config add remotes from the manifest as an initial value if there are some.
                return await this.updateRemotesInAppConfig(application, manifestRemotes);
            }
        }
        catch (er) {
            return undefined;
        }
    }
    sortVersions(source, order) {
        const sourceCopy = cloneDeep(source);
        if (source.list && source.path) {
            const path = sourceCopy.path.join('.');
            return sourceCopy.list.sort((a, b) => compare(coerce(get(a, path)), coerce(get(b, path))) * (order === 'asc' ? 1 : -1));
        }
        else {
            return sourceCopy.sort((a, b) => compare(coerce(a), coerce(b)) * (order === 'asc' ? 1 : -1));
        }
    }
    /**
     * Extracts a list of exported plugins from the application object.
     * @param application Application managed object.
     * @returns Returns a list of exported plugins.
     */
    getMFExports(application) {
        const manifest = application.manifest;
        if (!manifest || !manifest.exports) {
            return [];
        }
        return this.extendPluginsDetails(application, {
            version: manifest.version,
            binaryId: undefined
        });
    }
    /**
     * Extracts a list of exports from each available package.
     * @returns Returns a list of all exported plugins.
     */
    async getAllMFExports(allVersions = false) {
        const plugins = new Array();
        const packages = await this.listPackages();
        for (const pkg of packages) {
            if (!pkg?.manifest?.exports) {
                continue;
            }
            if (allVersions && Array.isArray(pkg.applicationVersions)) {
                pkg.applicationVersions.forEach(version => {
                    plugins.push(...this.extendPluginsDetails(pkg, version));
                });
            }
            else {
                plugins.push(...this.extendPluginsDetails(pkg, {
                    version: pkg.manifest.version,
                    binaryId: undefined
                }));
            }
        }
        return plugins;
    }
    /**
     * Extracts a list of remotes from the application object.
     * @param application Application managed object.
     * @returns Returns list of remotes.
     */
    getMFRemotes(application) {
        return application?.config?.remotes;
    }
    /**
     * Determines the type of a package.
     * A package is OFFICIAL if it comes from management tenant and has a label attached called OFFICIAL.
     * A package is COMMUNITY if it has a label called COMMUNITY.
     * A package is CUSTOM if it does not have any label attached.
     * A package is UNKNOWN if it has a label attached but it does not match COMMUNITY or OFFICIAL.
     *
     * Labels can be used to identify the status of a package. Community packages always need
     * a license validation. The label will be shown on the application card to tell a user
     * whether they are looking into an official or community package.
     *
     * @param packageApplication The package application object to check.
     * @returns The package type.
     */
    getPackageType(packageApplication) {
        if (!packageApplication.label) {
            return PackageType.CUSTOM;
        }
        if (packageApplication.label === PackageType.OFFICIAL &&
            this.isOwnedByManagement(packageApplication)) {
            return PackageType.OFFICIAL;
        }
        if (packageApplication.label === PackageType.COMMUNITY) {
            return PackageType.COMMUNITY;
        }
        return PackageType.UNKNOWN;
    }
    /**
     * Verifies if an application is owned by management tenant.
     *
     * @param app The application to verify.
     * @returns True if owned by management tenant.
     */
    isOwnedByManagement(app) {
        const appOwner = get(app, 'owner.tenant.id');
        return appOwner === 'management';
    }
    removeDuplicates(apps, key) {
        const uniqueList = [];
        const groupedAppsByKey = groupBy(apps, key);
        const groupedApps = Object.keys(groupedAppsByKey).map(key => groupedAppsByKey[key]);
        for (const appsGroup of groupedApps) {
            if (appsGroup.length < 2) {
                uniqueList.push(...appsGroup);
            }
            else {
                const appFromCurrentTenant = appsGroup.find(app => this.isFromCurrentTenant(app));
                if (appFromCurrentTenant) {
                    uniqueList.push(appFromCurrentTenant);
                    continue;
                }
                const appNotOwnedByManagement = appsGroup.find(app => !this.isOwnedByManagement(app));
                uniqueList.push(appNotOwnedByManagement);
            }
        }
        return uniqueList;
    }
    isFromCurrentTenant(app) {
        return app.owner.tenant.id === this.appStateService.currentTenant.value.name;
    }
    /**
     * Modifies the list of plugins to have additional information such as id.
     * @ignore
     */
    extendPluginsDetails(application, version) {
        const plugins = application.manifest.exports;
        const extendedPlugins = plugins.map(p => ({
            ...p,
            id: this.createPluginId(application.contextPath, p, version.version),
            contextPath: application.contextPath,
            version: version.version,
            versioningMatrix: application.manifest.versioningMatrix,
            tags: version.tags || [],
            license: application.manifest.license,
            type: this.getPackageType(application)
        }));
        return extendedPlugins;
    }
    async listApplicationsByCurrentTenant(params = {}) {
        const filter = Object.assign({
            type: 'HOSTED',
            pageSize: 2000,
            withTotalPages: true
        }, params);
        const sharedFilter = Object.assign({
            availability: ApplicationAvailability.SHARED,
            type: 'HOSTED',
            pageSize: 2000,
            withTotalPages: true
        }, params);
        const tenantName = this.appStateService.currentTenant.value.name;
        const [resultAppsOwnedByTenant, resultSharedApps] = await Promise.all([
            this.applicationService.listByTenant(tenantName, filter),
            this.applicationService.list(sharedFilter)
        ]);
        const { data: appsOwnedByTenant } = resultAppsOwnedByTenant;
        const { data: sharedApps } = resultSharedApps;
        const webApps = [...appsOwnedByTenant, ...sharedApps];
        return uniqBy(webApps, (app) => app.id);
    }
    addPluginToRemotes(remotes, plugins) {
        if (!plugins) {
            return;
        }
        const remotesCopy = cloneDeep(remotes);
        const temp = Array.isArray(plugins) ? plugins : [plugins];
        temp.forEach(plugin => {
            const { contextPath, moduleName } = this.parsePluginId(plugin.id);
            if (!contextPath || !moduleName) {
                return;
            }
            remotesCopy[contextPath]?.length >= 0
                ? remotesCopy[contextPath].push(moduleName)
                : (remotesCopy[contextPath] = []).push(moduleName);
            remotesCopy[contextPath] = [...new Set(remotesCopy[contextPath])];
        });
        return remotesCopy;
    }
    removePluginsFromRemotes(remotes, plugins) {
        const remotesCopy = cloneDeep(remotes);
        const temp = Array.isArray(plugins) ? plugins : [plugins];
        temp.forEach(plugin => {
            const { contextPath, moduleName } = this.parsePluginId(plugin.id);
            if (!contextPath || !moduleName || !remotesCopy[contextPath]) {
                return;
            }
            remotesCopy[contextPath] = remotesCopy[contextPath].filter(p => p !== moduleName);
            remotesCopy[contextPath] = [...new Set(remotesCopy[contextPath])];
            if (remotesCopy[contextPath].length === 0) {
                delete remotesCopy[contextPath];
            }
        });
        return remotesCopy;
    }
    createPluginId(contextPath, plugin, version) {
        return `${contextPath}@${version}/${plugin.module}`;
    }
    parsePluginId(id) {
        const [contextPath, moduleName] = id.split('/');
        return { contextPath, moduleName };
    }
}
PluginsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PluginsService, deps: [{ token: i1.ApplicationService }, { token: i2.AppStateService }], target: i0.ɵɵFactoryTarget.Injectable });
PluginsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PluginsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PluginsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ApplicationService }, { type: i2.AppStateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2lucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9wbHVnaW5zL3BsdWdpbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCx1QkFBdUIsRUFLeEIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sRUFBcUIsV0FBVyxFQUFpQixNQUFNLGlCQUFpQixDQUFDOzs7O0FBR2hGLE1BQU0sT0FBTyxjQUFjO0lBQ3pCLFlBQ1Usa0JBQXNDLEVBQ3RDLGVBQWdDO1FBRGhDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQ3ZDLENBQUM7SUFFSjs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLFlBQVksQ0FBQyxTQUFjLEVBQUU7UUFDakMsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsK0JBQStCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN4RCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ3BFLE9BQU8sYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsU0FBUyxDQUFDLFdBQXlCO1FBQ2pDLE9BQU8sV0FBVyxDQUFDLFFBQVEsRUFBRSxTQUFTLEtBQUssSUFBSSxDQUFDO0lBQ2xELENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsS0FBSyxDQUFDLFVBQVUsQ0FDZCxXQUF5QixFQUN6QixPQUFnRDtRQUVoRCxNQUFNLGdCQUFnQixHQUFJLFdBQVcsRUFBRSxNQUF3QixFQUFFLE9BQU8sQ0FBQztRQUN6RSxJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN0RSxPQUFPLE1BQU0sSUFBSSxDQUFDLHdCQUF3QixDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztTQUNyRTtRQUNELE9BQU87SUFDVCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUNqQixXQUF5QixFQUN6QixPQUFnRDtRQUVoRCxNQUFNLGdCQUFnQixHQUFJLFdBQVcsRUFBRSxNQUF3QixFQUFFLE9BQU8sQ0FBQztRQUN6RSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDNUUsT0FBTyxNQUFNLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdEUsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLHdCQUF3QixDQUM1QixXQUF5QixFQUN6QixPQUFpQztRQUVqQyxNQUFNLG9CQUFvQixHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLHVCQUF1QixDQUNoRixXQUFXLEVBQ1g7WUFDRSxPQUFPLEVBQUUsT0FBTztTQUNBLENBQ25CLENBQUM7UUFDRixPQUFPLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxPQUFPLElBQUksRUFBRSxDQUFDO0lBQ3JELENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFdBQXlCO1FBQ25ELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUNwQixPQUFPLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztTQUN0QjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUFDLFdBQXlCO1FBQy9DLElBQUk7WUFDRixNQUFNLGVBQWUsR0FBNkIsQ0FDaEQsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxDQUFDLENBQzlDLEVBQUUsT0FBTyxDQUFDO1lBRVgsSUFBSSxlQUFlLEVBQUU7Z0JBQ25CLDRHQUE0RztnQkFDNUcsT0FBTyxNQUFNLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUM7YUFDMUU7U0FDRjtRQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1gsT0FBTyxTQUFTLENBQUM7U0FDbEI7SUFDSCxDQUFDO0lBaUNELFlBQVksQ0FBQyxNQUFXLEVBQUUsS0FBcUI7UUFDN0MsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JDLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFO1lBQzlCLE1BQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ3pCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUMzRixDQUFDO1NBQ0g7YUFBTTtZQUNMLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5RjtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsWUFBWSxDQUFDLFdBQXlCO1FBQ3BDLE1BQU0sUUFBUSxHQUF1QixXQUFXLENBQUMsUUFBUSxDQUFDO1FBQzFELElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO1lBQ2xDLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUU7WUFDNUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxPQUFPO1lBQ3pCLFFBQVEsRUFBRSxTQUFTO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQVcsR0FBRyxLQUFLO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxFQUFxQixDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNDLEtBQUssTUFBTSxHQUFHLElBQUksUUFBUSxFQUFFO1lBQzFCLElBQUksQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtnQkFDM0IsU0FBUzthQUNWO1lBQ0QsSUFBSSxXQUFXLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsRUFBRTtnQkFDekQsR0FBRyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtvQkFDeEMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDM0QsQ0FBQyxDQUFDLENBQUM7YUFDSjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsSUFBSSxDQUNWLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRTtvQkFDaEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTztvQkFDN0IsUUFBUSxFQUFFLFNBQVM7aUJBQ3BCLENBQUMsQ0FDSCxDQUFDO2FBQ0g7U0FDRjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsWUFBWSxDQUFDLFdBQXlCO1FBQ3BDLE9BQVEsV0FBVyxFQUFFLE1BQXdCLEVBQUUsT0FBTyxDQUFDO0lBQ3pELENBQUM7SUFFRDs7Ozs7Ozs7Ozs7OztPQWFHO0lBQ0gsY0FBYyxDQUFDLGtCQUFnQztRQUM3QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFO1lBQzdCLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQztTQUMzQjtRQUNELElBQ0Usa0JBQWtCLENBQUMsS0FBSyxLQUFLLFdBQVcsQ0FBQyxRQUFRO1lBQ2pELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxrQkFBa0IsQ0FBQyxFQUM1QztZQUNBLE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQztTQUM3QjtRQUNELElBQUksa0JBQWtCLENBQUMsS0FBSyxLQUFLLFdBQVcsQ0FBQyxTQUFTLEVBQUU7WUFDdEQsT0FBTyxXQUFXLENBQUMsU0FBUyxDQUFDO1NBQzlCO1FBQ0QsT0FBTyxXQUFXLENBQUMsT0FBTyxDQUFDO0lBQzdCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILG1CQUFtQixDQUFDLEdBQWlCO1FBQ25DLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUM3QyxPQUFPLFFBQVEsS0FBSyxZQUFZLENBQUM7SUFDbkMsQ0FBQztJQUVPLGdCQUFnQixDQUFDLElBQW9CLEVBQUUsR0FBVztRQUN4RCxNQUFNLFVBQVUsR0FBbUIsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sZ0JBQWdCLEdBQW1DLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDNUUsTUFBTSxXQUFXLEdBQXFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxHQUFHLENBQ3JFLEdBQUcsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQzdCLENBQUM7UUFDRixLQUFLLE1BQU0sU0FBUyxJQUFJLFdBQVcsRUFBRTtZQUNuQyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN4QixVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUM7YUFDL0I7aUJBQU07Z0JBQ0wsTUFBTSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xGLElBQUksb0JBQW9CLEVBQUU7b0JBQ3hCLFVBQVUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztvQkFDdEMsU0FBUztpQkFDVjtnQkFDRCxNQUFNLHVCQUF1QixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN0RixVQUFVLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7YUFDMUM7U0FDRjtRQUNELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxHQUFpQjtRQUMzQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQy9FLENBQUM7SUFFRDs7O09BR0c7SUFDSyxvQkFBb0IsQ0FDMUIsV0FBeUIsRUFDekIsT0FBNEI7UUFFNUIsTUFBTSxPQUFPLEdBQXdCLFdBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ2xFLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLEdBQUcsQ0FBQztZQUNKLEVBQUUsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUM7WUFDcEUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxXQUFXO1lBQ3BDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTztZQUN4QixnQkFBZ0IsRUFBRSxXQUFXLENBQUMsUUFBUSxDQUFDLGdCQUFnQjtZQUN2RCxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFO1lBQ3hCLE9BQU8sRUFBRSxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU87WUFDckMsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDO1NBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBQ0osT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztJQUVPLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxTQUFjLEVBQUU7UUFDNUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDMUI7WUFDRSxJQUFJLEVBQUUsUUFBUTtZQUNkLFFBQVEsRUFBRSxJQUFJO1lBQ2QsY0FBYyxFQUFFLElBQUk7U0FDckIsRUFDRCxNQUFNLENBQ1AsQ0FBQztRQUNGLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ2hDO1lBQ0UsWUFBWSxFQUFFLHVCQUF1QixDQUFDLE1BQU07WUFDNUMsSUFBSSxFQUFFLFFBQVE7WUFDZCxRQUFRLEVBQUUsSUFBSTtZQUNkLGNBQWMsRUFBRSxJQUFJO1NBQ3JCLEVBQ0QsTUFBTSxDQUNQLENBQUM7UUFFRixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ2pFLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUNwRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUM7WUFDeEQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDM0MsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxHQUFHLHVCQUF1QixDQUFDO1FBQzVELE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEdBQUcsZ0JBQWdCLENBQUM7UUFDOUMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLGlCQUFpQixFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUM7UUFDdEQsT0FBTyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBaUIsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFTyxrQkFBa0IsQ0FDeEIsT0FBaUMsRUFDakMsT0FBZ0Q7UUFFaEQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUNELE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFMUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNwQixNQUFNLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2xFLElBQUksQ0FBQyxXQUFXLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQy9CLE9BQU87YUFDUjtZQUNELFdBQVcsQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLElBQUksQ0FBQztnQkFDbkMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO2dCQUMzQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JELFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRSxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFTyx3QkFBd0IsQ0FDOUIsT0FBaUMsRUFDakMsT0FBZ0Q7UUFFaEQsTUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEUsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsRUFBRTtnQkFDNUQsT0FBTzthQUNSO1lBQ0QsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUM7WUFDbEYsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3pDLE9BQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ2pDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRU8sY0FBYyxDQUFDLFdBQW1CLEVBQUUsTUFBeUIsRUFBRSxPQUFlO1FBQ3BGLE9BQU8sR0FBRyxXQUFXLElBQUksT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBRU8sYUFBYSxDQUFDLEVBQVU7UUFDOUIsTUFBTSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLENBQUM7SUFDckMsQ0FBQzs7MkdBM1hVLGNBQWM7K0dBQWQsY0FBYzsyRkFBZCxjQUFjO2tCQUQxQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQXBwbGljYXRpb25BdmFpbGFiaWxpdHksXG4gIEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucyxcbiAgSUFwcGxpY2F0aW9uLFxuICBJQXBwbGljYXRpb25WZXJzaW9uLFxuICBJTWFuaWZlc3Rcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuaW1wb3J0IHsgY2xvbmVEZWVwLCBnZXQsIHVuaXFCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBjb2VyY2UsIGNvbXBhcmUgfSBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VpLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgZ3JvdXBCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblBsdWdpbiwgUGFja2FnZVR5cGUsIFBsdWdpbnNDb25maWcgfSBmcm9tICcuL3BsdWdpbnMubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGx1Z2luc1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGVTZXJ2aWNlOiBBcHBTdGF0ZVNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBGZXRjaGVzIGEgbGlzdCBvZiBhdmFpbGFibGUgcGFja2FnZXMuXG4gICAqIEBwYXJhbSBwYXJhbXMgQWRkaXRpb25hbCBxdWVyeSBwYXJhbWV0ZXJzLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGEgbGlzdCBvZiBwYWNrYWdlcy5cbiAgICovXG4gIGFzeW5jIGxpc3RQYWNrYWdlcyhwYXJhbXM6IGFueSA9IHt9KTogUHJvbWlzZTxJQXBwbGljYXRpb25bXT4ge1xuICAgIGNvbnN0IGFwcHMgPSBhd2FpdCB0aGlzLmxpc3RBcHBsaWNhdGlvbnNCeUN1cnJlbnRUZW5hbnQocGFyYW1zKTtcbiAgICBjb25zdCB3ZWJBcHBzID0gYXBwcy5maWx0ZXIoYXBwID0+IHRoaXMuaXNQYWNrYWdlKGFwcCkpO1xuICAgIGNvbnN0IHVuaXF1ZVdlYkFwcHMgPSB0aGlzLnJlbW92ZUR1cGxpY2F0ZXMod2ViQXBwcywgJ2NvbnRleHRQYXRoJyk7XG4gICAgcmV0dXJuIHVuaXF1ZVdlYkFwcHMuc29ydCgoYSwgYikgPT4gYS5uYW1lLmxvY2FsZUNvbXBhcmUoYi5uYW1lKSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGFuIGFwcGxpY2F0aW9uIGlzIGEgcGFja2FnZS5cbiAgICogQHBhcmFtIGFwcGxpY2F0aW9uIEFwcGxpY2F0aW9uIG1hbmFnZWQgb2JqZWN0LlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHRydWUgaWYgdGhlIGFwcGxpY2F0aW9uIGlzIGEgcGFja2FnZS5cbiAgICovXG4gIGlzUGFja2FnZShhcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGFwcGxpY2F0aW9uLm1hbmlmZXN0Py5pc1BhY2thZ2UgPT09IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgcmVtb3RlcyBmaWVsZCBpbiB0aGUgYXBwbGljYXRpb24gY29uZmlndXJhdGlvbiBieSBhZGRpbmcgbmV3IHBsdWdpbnMuXG4gICAqIEltcG9ydGFudDogaWYgdGhlIHJlbW90ZXMgb2JqZWN0IGlzIG5vdCBzZXQgb24gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LFxuICAgKiByZW1vdGVzIHdpbGwgbm90IGJlIGFkZGVkLiBNYWtlIHN1cmUgdGhhdCB0aGlzIG9iamVjdCBleGlzdHMgaW4gdGhlIGFwcGxpY2F0aW9uIGNvbmZpZ3VyYXRpb24uXG4gICAqIEBwYXJhbSBhcHBsaWNhdGlvbiBBcHBsaWNhdGlvbiBtYW5hZ2VkIG9iamVjdC5cbiAgICogQHBhcmFtIHBsdWdpbnMgTGlzdCBvZiByZW1vdGVzIHRvIGJlIGFkZGVkLlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHVwZGF0ZWQgYXBwbGljYXRpb24gcmVtb3Rlcy5cbiAgICovXG4gIGFzeW5jIGFkZFJlbW90ZXMoXG4gICAgYXBwbGljYXRpb246IElBcHBsaWNhdGlvbixcbiAgICBwbHVnaW5zOiBBcHBsaWNhdGlvblBsdWdpbiB8IEFwcGxpY2F0aW9uUGx1Z2luW11cbiAgKTogUHJvbWlzZTxBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnM+IHtcbiAgICBjb25zdCBhcHBDb25maWdSZW1vdGVzID0gKGFwcGxpY2F0aW9uPy5jb25maWcgYXMgUGx1Z2luc0NvbmZpZyk/LnJlbW90ZXM7XG4gICAgaWYgKGFwcENvbmZpZ1JlbW90ZXMpIHtcbiAgICAgIGNvbnN0IG5ld1JlbW90ZXMgPSB0aGlzLmFkZFBsdWdpblRvUmVtb3RlcyhhcHBDb25maWdSZW1vdGVzLCBwbHVnaW5zKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVwZGF0ZVJlbW90ZXNJbkFwcENvbmZpZyhhcHBsaWNhdGlvbiwgbmV3UmVtb3Rlcyk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSByZW1vdGVzIGZpZWxkIGluIHRoZSBhcHBsaWNhdGlvbiBjb25maWd1cmF0aW9uIGJ5IHJlbW92aW5nIHBsdWdpbnMuXG4gICAqIEBwYXJhbSBhcHBsaWNhdGlvbiBBcHBsaWNhdGlvbiBtYW5hZ2VkIG9iamVjdC5cbiAgICogQHBhcmFtIHBsdWdpbnMgTGlzdCBvZiByZW1vdGVzIHRvIGJlIHJlbW92ZWQuXG4gICAqIEByZXR1cm5zIFJldHVybnMgdXBkYXRlZCBhcHBsaWNhdGlvbiByZW1vdGVzLlxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlUmVtb3RlcyhcbiAgICBhcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uLFxuICAgIHBsdWdpbnM6IEFwcGxpY2F0aW9uUGx1Z2luIHwgQXBwbGljYXRpb25QbHVnaW5bXVxuICApOiBQcm9taXNlPEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucz4ge1xuICAgIGNvbnN0IGFwcENvbmZpZ1JlbW90ZXMgPSAoYXBwbGljYXRpb24/LmNvbmZpZyBhcyBQbHVnaW5zQ29uZmlnKT8ucmVtb3RlcztcbiAgICBjb25zdCBuZXdSZW1vdGVzID0gdGhpcy5yZW1vdmVQbHVnaW5zRnJvbVJlbW90ZXMoYXBwQ29uZmlnUmVtb3RlcywgcGx1Z2lucyk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlUmVtb3Rlc0luQXBwQ29uZmlnKGFwcGxpY2F0aW9uLCBuZXdSZW1vdGVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSByZW1vdGVzIGZpZWxkIGluIHRoZSBhcHBsaWNhdGlvbiBjb25maWd1cmF0aW9uLlxuICAgKiBAcGFyYW0gYXBwbGljYXRpb24gQXBwbGljYXRpb24gbWFuYWdlZCBvYmplY3QuXG4gICAqIEBwYXJhbSBwbHVnaW5zIExpc3Qgb2YgcmVtb3RlcyB0byBiZSBhZGRlZC5cbiAgICogQHJldHVybnMgUmV0dXJucyB1cGRhdGVkIGFwcGxpY2F0aW9uIHJlbW90ZXMuXG4gICAqL1xuICBhc3luYyB1cGRhdGVSZW1vdGVzSW5BcHBDb25maWcoXG4gICAgYXBwbGljYXRpb246IElBcHBsaWNhdGlvbixcbiAgICBwbHVnaW5zOiBBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnNcbiAgKTogUHJvbWlzZTxBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnM+IHtcbiAgICBjb25zdCB1cGRhdGVkQXBwV2l0aENvbmZpZyA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLnVwZGF0ZUFwcGxpY2F0aW9uQ29uZmlnKFxuICAgICAgYXBwbGljYXRpb24sXG4gICAgICB7XG4gICAgICAgIHJlbW90ZXM6IHBsdWdpbnNcbiAgICAgIH0gYXMgUGx1Z2luc0NvbmZpZ1xuICAgICk7XG4gICAgcmV0dXJuIHVwZGF0ZWRBcHBXaXRoQ29uZmlnPy5jb25maWc/LnJlbW90ZXMgfHwge307XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2hlcyB0aGUgYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gICAqIEBwYXJhbSBhcHBsaWNhdGlvbiBBcHBsaWNhdGlvbiBtYW5hZ2VkIG9iamVjdC5cbiAgICogQHJldHVybnMgUmV0dXJucyB0aGUgYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gICAqL1xuICBhc3luYyBnZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwbGljYXRpb246IElBcHBsaWNhdGlvbikge1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5nZXRBcHBNYW5pZmVzdChhcHBsaWNhdGlvbik7XG4gICAgaWYgKCFjOHlKc29uLnJlbW90ZXMpIHtcbiAgICAgIGM4eUpzb24ucmVtb3RlcyA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gYzh5SnNvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBpbml0aWFsIHN0YXRlIG9mIHJlbW90ZXMgaW4gdGhlIGNvbmZpZ3VyYXRpb24gKHdoZW4gaXQncyBtaXNzaW5nKSwgYmFzZWQgb24gdGhlIGxpc3Qgb2YgcmVtb3RlcyBiZWluZyBpbiB0aGUgYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gICAqIEBwYXJhbSBhcHBsaWNhdGlvbiAgQXBwbGljYXRpb24gbWFuYWdlZCBvYmplY3QuXG4gICAqIEByZXR1cm5zIFJldHVybnMgYSBsaXN0IG9mIHJlbW90ZXMgdGhhdCBoYXMgYmVlbiBhc3NpZ25lZCB0byB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuXG4gICAqL1xuICBhc3luYyBzZXRJbml0aWFsUmVtb3RlcyhhcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1hbmlmZXN0UmVtb3RlczogQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zID0gKFxuICAgICAgICBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHBsaWNhdGlvbilcbiAgICAgICk/LnJlbW90ZXM7XG5cbiAgICAgIGlmIChtYW5pZmVzdFJlbW90ZXMpIHtcbiAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gcmVtb3RlcyBpbiB0aGUgY29uZmlnIGFkZCByZW1vdGVzIGZyb20gdGhlIG1hbmlmZXN0IGFzIGFuIGluaXRpYWwgdmFsdWUgaWYgdGhlcmUgYXJlIHNvbWUuXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVwZGF0ZVJlbW90ZXNJbkFwcENvbmZpZyhhcHBsaWNhdGlvbiwgbWFuaWZlc3RSZW1vdGVzKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcikge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU29ydHMgdmVyc2lvbnMgbGlzdCBvciBsaXN0IG9mIG9iamVjdHMgYnkgdmVyc2lvbiBwcm9wZXJ0eVxuICAgKiBAcmV0dXJucyBsaXN0IG9mIHZlcnNpb25zIGFzIGFycmF5IG9mIHN0cmluZ3Mgb3IgYXJyYXkgb2Ygb2JqZWN0cyBzb3J0ZWQgYnkgdmVyc2lvbiBwcm9wZXJ0eVxuICAgKlxuICAgKiBAcGFyYW0ge3sgbGlzdDogVFtdOyBwYXRoOiBzdHJpbmdbXSB9IHwgc3RyaW5nW119IHNvdXJjZSBkYXRhIHRvIHNvcnRcbiAgICogQHBhcmFtIHsnYXNjJyB8ICdkZXNjJ30gb3JkZXIgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgb3JkZXIgb2Ygc29ydGluZ1xuICAgKlxuICAgKiAqKkV4YW1wbGUqKlxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIGNvbnN0IGRhdGEgPSBbJzEuNS4wJywgJzIuMC4wJ107XG4gICAqIGNvbnN0IHNvcnRlZERhdGEgPSBwbHVnaW5zU2VydmljZS5zb3J0VmVyc2lvbnModmVyc2lvbnMsICdkZXNjJyk7XG4gICAqIC8vIHNvcnRlZERhdGE6XG4gICAqIC8vIFsnMi4wLjAnLCAnMS41LjAnXVxuICAgKiBgYGBcbiAgICpcbiAgICogKipFeGFtcGxlKipcbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiBjb25zdCBkYXRhID0gW1xuICAgKiAge2FwcDoge2FwcFZlcnNpb246ICcxLjUuMCd9fSxcbiAgICogIHthcHA6IHthcHBWZXJzaW9uOiAnMi4wLjAnfX0sXG4gICAqIF07XG4gICAqIGNvbnN0IHNvcnRlZERhdGEgPSBwbHVnaW5zU2VydmljZS5zb3J0VmVyc2lvbnMoe2xpc3Q6IGRhdGEsIHBhdGg6IFsnYXBwJywgJ2FwcFZlcnNpb24nXX0sICdkZXNjJyk7XG4gICAqIC8vIHNvcnRlZERhdGE6XG4gICAqIC8vIFtcbiAgICogLy8gIHthcHA6IHthcHBWZXJzaW9uOiAnMi4wLjAnfX0sXG4gICAqIC8vICB7YXBwOiB7YXBwVmVyc2lvbjogJzEuNS4wJ319XG4gICAqIC8vIF1cbiAgICogYGBgXG4gICAqL1xuICBzb3J0VmVyc2lvbnM8VD4oc291cmNlOiB7IGxpc3Q6IFRbXTsgcGF0aDogc3RyaW5nW10gfSwgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnKTogVFtdO1xuICBzb3J0VmVyc2lvbnMoc291cmNlOiBzdHJpbmdbXSwgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnKTogc3RyaW5nW107XG4gIHNvcnRWZXJzaW9ucyhzb3VyY2U6IGFueSwgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnKTogYW55IHtcbiAgICBjb25zdCBzb3VyY2VDb3B5ID0gY2xvbmVEZWVwKHNvdXJjZSk7XG4gICAgaWYgKHNvdXJjZS5saXN0ICYmIHNvdXJjZS5wYXRoKSB7XG4gICAgICBjb25zdCBwYXRoID0gc291cmNlQ29weS5wYXRoLmpvaW4oJy4nKTtcbiAgICAgIHJldHVybiBzb3VyY2VDb3B5Lmxpc3Quc29ydChcbiAgICAgICAgKGEsIGIpID0+IGNvbXBhcmUoY29lcmNlKGdldChhLCBwYXRoKSksIGNvZXJjZShnZXQoYiwgcGF0aCkpKSAqIChvcmRlciA9PT0gJ2FzYycgPyAxIDogLTEpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gc291cmNlQ29weS5zb3J0KChhLCBiKSA9PiBjb21wYXJlKGNvZXJjZShhKSwgY29lcmNlKGIpKSAqIChvcmRlciA9PT0gJ2FzYycgPyAxIDogLTEpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgYSBsaXN0IG9mIGV4cG9ydGVkIHBsdWdpbnMgZnJvbSB0aGUgYXBwbGljYXRpb24gb2JqZWN0LlxuICAgKiBAcGFyYW0gYXBwbGljYXRpb24gQXBwbGljYXRpb24gbWFuYWdlZCBvYmplY3QuXG4gICAqIEByZXR1cm5zIFJldHVybnMgYSBsaXN0IG9mIGV4cG9ydGVkIHBsdWdpbnMuXG4gICAqL1xuICBnZXRNRkV4cG9ydHMoYXBwbGljYXRpb246IElBcHBsaWNhdGlvbik6IEFwcGxpY2F0aW9uUGx1Z2luW10ge1xuICAgIGNvbnN0IG1hbmlmZXN0OiBQYXJ0aWFsPElNYW5pZmVzdD4gPSBhcHBsaWNhdGlvbi5tYW5pZmVzdDtcbiAgICBpZiAoIW1hbmlmZXN0IHx8ICFtYW5pZmVzdC5leHBvcnRzKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmV4dGVuZFBsdWdpbnNEZXRhaWxzKGFwcGxpY2F0aW9uLCB7XG4gICAgICB2ZXJzaW9uOiBtYW5pZmVzdC52ZXJzaW9uLFxuICAgICAgYmluYXJ5SWQ6IHVuZGVmaW5lZFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGEgbGlzdCBvZiBleHBvcnRzIGZyb20gZWFjaCBhdmFpbGFibGUgcGFja2FnZS5cbiAgICogQHJldHVybnMgUmV0dXJucyBhIGxpc3Qgb2YgYWxsIGV4cG9ydGVkIHBsdWdpbnMuXG4gICAqL1xuICBhc3luYyBnZXRBbGxNRkV4cG9ydHMoYWxsVmVyc2lvbnMgPSBmYWxzZSk6IFByb21pc2U8QXBwbGljYXRpb25QbHVnaW5bXT4ge1xuICAgIGNvbnN0IHBsdWdpbnMgPSBuZXcgQXJyYXk8QXBwbGljYXRpb25QbHVnaW4+KCk7XG4gICAgY29uc3QgcGFja2FnZXMgPSBhd2FpdCB0aGlzLmxpc3RQYWNrYWdlcygpO1xuICAgIGZvciAoY29uc3QgcGtnIG9mIHBhY2thZ2VzKSB7XG4gICAgICBpZiAoIXBrZz8ubWFuaWZlc3Q/LmV4cG9ydHMpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoYWxsVmVyc2lvbnMgJiYgQXJyYXkuaXNBcnJheShwa2cuYXBwbGljYXRpb25WZXJzaW9ucykpIHtcbiAgICAgICAgcGtnLmFwcGxpY2F0aW9uVmVyc2lvbnMuZm9yRWFjaCh2ZXJzaW9uID0+IHtcbiAgICAgICAgICBwbHVnaW5zLnB1c2goLi4udGhpcy5leHRlbmRQbHVnaW5zRGV0YWlscyhwa2csIHZlcnNpb24pKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwbHVnaW5zLnB1c2goXG4gICAgICAgICAgLi4udGhpcy5leHRlbmRQbHVnaW5zRGV0YWlscyhwa2csIHtcbiAgICAgICAgICAgIHZlcnNpb246IHBrZy5tYW5pZmVzdC52ZXJzaW9uLFxuICAgICAgICAgICAgYmluYXJ5SWQ6IHVuZGVmaW5lZFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwbHVnaW5zO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGEgbGlzdCBvZiByZW1vdGVzIGZyb20gdGhlIGFwcGxpY2F0aW9uIG9iamVjdC5cbiAgICogQHBhcmFtIGFwcGxpY2F0aW9uIEFwcGxpY2F0aW9uIG1hbmFnZWQgb2JqZWN0LlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIGxpc3Qgb2YgcmVtb3Rlcy5cbiAgICovXG4gIGdldE1GUmVtb3RlcyhhcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uKTogQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zIHtcbiAgICByZXR1cm4gKGFwcGxpY2F0aW9uPy5jb25maWcgYXMgUGx1Z2luc0NvbmZpZyk/LnJlbW90ZXM7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lcyB0aGUgdHlwZSBvZiBhIHBhY2thZ2UuXG4gICAqIEEgcGFja2FnZSBpcyBPRkZJQ0lBTCBpZiBpdCBjb21lcyBmcm9tIG1hbmFnZW1lbnQgdGVuYW50IGFuZCBoYXMgYSBsYWJlbCBhdHRhY2hlZCBjYWxsZWQgT0ZGSUNJQUwuXG4gICAqIEEgcGFja2FnZSBpcyBDT01NVU5JVFkgaWYgaXQgaGFzIGEgbGFiZWwgY2FsbGVkIENPTU1VTklUWS5cbiAgICogQSBwYWNrYWdlIGlzIENVU1RPTSBpZiBpdCBkb2VzIG5vdCBoYXZlIGFueSBsYWJlbCBhdHRhY2hlZC5cbiAgICogQSBwYWNrYWdlIGlzIFVOS05PV04gaWYgaXQgaGFzIGEgbGFiZWwgYXR0YWNoZWQgYnV0IGl0IGRvZXMgbm90IG1hdGNoIENPTU1VTklUWSBvciBPRkZJQ0lBTC5cbiAgICpcbiAgICogTGFiZWxzIGNhbiBiZSB1c2VkIHRvIGlkZW50aWZ5IHRoZSBzdGF0dXMgb2YgYSBwYWNrYWdlLiBDb21tdW5pdHkgcGFja2FnZXMgYWx3YXlzIG5lZWRcbiAgICogYSBsaWNlbnNlIHZhbGlkYXRpb24uIFRoZSBsYWJlbCB3aWxsIGJlIHNob3duIG9uIHRoZSBhcHBsaWNhdGlvbiBjYXJkIHRvIHRlbGwgYSB1c2VyXG4gICAqIHdoZXRoZXIgdGhleSBhcmUgbG9va2luZyBpbnRvIGFuIG9mZmljaWFsIG9yIGNvbW11bml0eSBwYWNrYWdlLlxuICAgKlxuICAgKiBAcGFyYW0gcGFja2FnZUFwcGxpY2F0aW9uIFRoZSBwYWNrYWdlIGFwcGxpY2F0aW9uIG9iamVjdCB0byBjaGVjay5cbiAgICogQHJldHVybnMgVGhlIHBhY2thZ2UgdHlwZS5cbiAgICovXG4gIGdldFBhY2thZ2VUeXBlKHBhY2thZ2VBcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uKTogUGFja2FnZVR5cGUge1xuICAgIGlmICghcGFja2FnZUFwcGxpY2F0aW9uLmxhYmVsKSB7XG4gICAgICByZXR1cm4gUGFja2FnZVR5cGUuQ1VTVE9NO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBwYWNrYWdlQXBwbGljYXRpb24ubGFiZWwgPT09IFBhY2thZ2VUeXBlLk9GRklDSUFMICYmXG4gICAgICB0aGlzLmlzT3duZWRCeU1hbmFnZW1lbnQocGFja2FnZUFwcGxpY2F0aW9uKVxuICAgICkge1xuICAgICAgcmV0dXJuIFBhY2thZ2VUeXBlLk9GRklDSUFMO1xuICAgIH1cbiAgICBpZiAocGFja2FnZUFwcGxpY2F0aW9uLmxhYmVsID09PSBQYWNrYWdlVHlwZS5DT01NVU5JVFkpIHtcbiAgICAgIHJldHVybiBQYWNrYWdlVHlwZS5DT01NVU5JVFk7XG4gICAgfVxuICAgIHJldHVybiBQYWNrYWdlVHlwZS5VTktOT1dOO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWVzIGlmIGFuIGFwcGxpY2F0aW9uIGlzIG93bmVkIGJ5IG1hbmFnZW1lbnQgdGVuYW50LlxuICAgKlxuICAgKiBAcGFyYW0gYXBwIFRoZSBhcHBsaWNhdGlvbiB0byB2ZXJpZnkuXG4gICAqIEByZXR1cm5zIFRydWUgaWYgb3duZWQgYnkgbWFuYWdlbWVudCB0ZW5hbnQuXG4gICAqL1xuICBpc093bmVkQnlNYW5hZ2VtZW50KGFwcDogSUFwcGxpY2F0aW9uKTogYm9vbGVhbiB7XG4gICAgY29uc3QgYXBwT3duZXIgPSBnZXQoYXBwLCAnb3duZXIudGVuYW50LmlkJyk7XG4gICAgcmV0dXJuIGFwcE93bmVyID09PSAnbWFuYWdlbWVudCc7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUR1cGxpY2F0ZXMoYXBwczogSUFwcGxpY2F0aW9uW10sIGtleTogc3RyaW5nKTogSUFwcGxpY2F0aW9uW10ge1xuICAgIGNvbnN0IHVuaXF1ZUxpc3Q6IElBcHBsaWNhdGlvbltdID0gW107XG4gICAgY29uc3QgZ3JvdXBlZEFwcHNCeUtleTogUmVjb3JkPHN0cmluZywgSUFwcGxpY2F0aW9uW10+ID0gZ3JvdXBCeShhcHBzLCBrZXkpO1xuICAgIGNvbnN0IGdyb3VwZWRBcHBzOiBJQXBwbGljYXRpb25bXVtdID0gT2JqZWN0LmtleXMoZ3JvdXBlZEFwcHNCeUtleSkubWFwKFxuICAgICAga2V5ID0+IGdyb3VwZWRBcHBzQnlLZXlba2V5XVxuICAgICk7XG4gICAgZm9yIChjb25zdCBhcHBzR3JvdXAgb2YgZ3JvdXBlZEFwcHMpIHtcbiAgICAgIGlmIChhcHBzR3JvdXAubGVuZ3RoIDwgMikge1xuICAgICAgICB1bmlxdWVMaXN0LnB1c2goLi4uYXBwc0dyb3VwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGFwcEZyb21DdXJyZW50VGVuYW50ID0gYXBwc0dyb3VwLmZpbmQoYXBwID0+IHRoaXMuaXNGcm9tQ3VycmVudFRlbmFudChhcHApKTtcbiAgICAgICAgaWYgKGFwcEZyb21DdXJyZW50VGVuYW50KSB7XG4gICAgICAgICAgdW5pcXVlTGlzdC5wdXNoKGFwcEZyb21DdXJyZW50VGVuYW50KTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhcHBOb3RPd25lZEJ5TWFuYWdlbWVudCA9IGFwcHNHcm91cC5maW5kKGFwcCA9PiAhdGhpcy5pc093bmVkQnlNYW5hZ2VtZW50KGFwcCkpO1xuICAgICAgICB1bmlxdWVMaXN0LnB1c2goYXBwTm90T3duZWRCeU1hbmFnZW1lbnQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5pcXVlTGlzdDtcbiAgfVxuXG4gIHByaXZhdGUgaXNGcm9tQ3VycmVudFRlbmFudChhcHA6IElBcHBsaWNhdGlvbik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBhcHAub3duZXIudGVuYW50LmlkID09PSB0aGlzLmFwcFN0YXRlU2VydmljZS5jdXJyZW50VGVuYW50LnZhbHVlLm5hbWU7XG4gIH1cblxuICAvKipcbiAgICogTW9kaWZpZXMgdGhlIGxpc3Qgb2YgcGx1Z2lucyB0byBoYXZlIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gc3VjaCBhcyBpZC5cbiAgICogQGlnbm9yZVxuICAgKi9cbiAgcHJpdmF0ZSBleHRlbmRQbHVnaW5zRGV0YWlscyhcbiAgICBhcHBsaWNhdGlvbjogSUFwcGxpY2F0aW9uLFxuICAgIHZlcnNpb246IElBcHBsaWNhdGlvblZlcnNpb25cbiAgKTogQXBwbGljYXRpb25QbHVnaW5bXSB7XG4gICAgY29uc3QgcGx1Z2luczogQXBwbGljYXRpb25QbHVnaW5bXSA9IGFwcGxpY2F0aW9uLm1hbmlmZXN0LmV4cG9ydHM7XG4gICAgY29uc3QgZXh0ZW5kZWRQbHVnaW5zID0gcGx1Z2lucy5tYXAocCA9PiAoe1xuICAgICAgLi4ucCxcbiAgICAgIGlkOiB0aGlzLmNyZWF0ZVBsdWdpbklkKGFwcGxpY2F0aW9uLmNvbnRleHRQYXRoLCBwLCB2ZXJzaW9uLnZlcnNpb24pLFxuICAgICAgY29udGV4dFBhdGg6IGFwcGxpY2F0aW9uLmNvbnRleHRQYXRoLFxuICAgICAgdmVyc2lvbjogdmVyc2lvbi52ZXJzaW9uLFxuICAgICAgdmVyc2lvbmluZ01hdHJpeDogYXBwbGljYXRpb24ubWFuaWZlc3QudmVyc2lvbmluZ01hdHJpeCxcbiAgICAgIHRhZ3M6IHZlcnNpb24udGFncyB8fCBbXSxcbiAgICAgIGxpY2Vuc2U6IGFwcGxpY2F0aW9uLm1hbmlmZXN0LmxpY2Vuc2UsXG4gICAgICB0eXBlOiB0aGlzLmdldFBhY2thZ2VUeXBlKGFwcGxpY2F0aW9uKVxuICAgIH0pKTtcbiAgICByZXR1cm4gZXh0ZW5kZWRQbHVnaW5zO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsaXN0QXBwbGljYXRpb25zQnlDdXJyZW50VGVuYW50KHBhcmFtczogYW55ID0ge30pOiBQcm9taXNlPElBcHBsaWNhdGlvbltdPiB7XG4gICAgY29uc3QgZmlsdGVyID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ0hPU1RFRCcsXG4gICAgICAgIHBhZ2VTaXplOiAyMDAwLFxuICAgICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHBhcmFtc1xuICAgICk7XG4gICAgY29uc3Qgc2hhcmVkRmlsdGVyID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIHtcbiAgICAgICAgYXZhaWxhYmlsaXR5OiBBcHBsaWNhdGlvbkF2YWlsYWJpbGl0eS5TSEFSRUQsXG4gICAgICAgIHR5cGU6ICdIT1NURUQnLFxuICAgICAgICBwYWdlU2l6ZTogMjAwMCxcbiAgICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWVcbiAgICAgIH0sXG4gICAgICBwYXJhbXNcbiAgICApO1xuXG4gICAgY29uc3QgdGVuYW50TmFtZSA9IHRoaXMuYXBwU3RhdGVTZXJ2aWNlLmN1cnJlbnRUZW5hbnQudmFsdWUubmFtZTtcbiAgICBjb25zdCBbcmVzdWx0QXBwc093bmVkQnlUZW5hbnQsIHJlc3VsdFNoYXJlZEFwcHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UubGlzdEJ5VGVuYW50KHRlbmFudE5hbWUsIGZpbHRlciksXG4gICAgICB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0KHNoYXJlZEZpbHRlcilcbiAgICBdKTtcbiAgICBjb25zdCB7IGRhdGE6IGFwcHNPd25lZEJ5VGVuYW50IH0gPSByZXN1bHRBcHBzT3duZWRCeVRlbmFudDtcbiAgICBjb25zdCB7IGRhdGE6IHNoYXJlZEFwcHMgfSA9IHJlc3VsdFNoYXJlZEFwcHM7XG4gICAgY29uc3Qgd2ViQXBwcyA9IFsuLi5hcHBzT3duZWRCeVRlbmFudCwgLi4uc2hhcmVkQXBwc107XG4gICAgcmV0dXJuIHVuaXFCeSh3ZWJBcHBzLCAoYXBwOiBJQXBwbGljYXRpb24pID0+IGFwcC5pZCk7XG4gIH1cblxuICBwcml2YXRlIGFkZFBsdWdpblRvUmVtb3RlcyhcbiAgICByZW1vdGVzOiBBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnMsXG4gICAgcGx1Z2luczogQXBwbGljYXRpb25QbHVnaW4gfCBBcHBsaWNhdGlvblBsdWdpbltdXG4gICk6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucyB7XG4gICAgaWYgKCFwbHVnaW5zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHJlbW90ZXNDb3B5ID0gY2xvbmVEZWVwKHJlbW90ZXMpO1xuICAgIGNvbnN0IHRlbXAgPSBBcnJheS5pc0FycmF5KHBsdWdpbnMpID8gcGx1Z2lucyA6IFtwbHVnaW5zXTtcblxuICAgIHRlbXAuZm9yRWFjaChwbHVnaW4gPT4ge1xuICAgICAgY29uc3QgeyBjb250ZXh0UGF0aCwgbW9kdWxlTmFtZSB9ID0gdGhpcy5wYXJzZVBsdWdpbklkKHBsdWdpbi5pZCk7XG4gICAgICBpZiAoIWNvbnRleHRQYXRoIHx8ICFtb2R1bGVOYW1lKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHJlbW90ZXNDb3B5W2NvbnRleHRQYXRoXT8ubGVuZ3RoID49IDBcbiAgICAgICAgPyByZW1vdGVzQ29weVtjb250ZXh0UGF0aF0ucHVzaChtb2R1bGVOYW1lKVxuICAgICAgICA6IChyZW1vdGVzQ29weVtjb250ZXh0UGF0aF0gPSBbXSkucHVzaChtb2R1bGVOYW1lKTtcbiAgICAgIHJlbW90ZXNDb3B5W2NvbnRleHRQYXRoXSA9IFsuLi5uZXcgU2V0KHJlbW90ZXNDb3B5W2NvbnRleHRQYXRoXSldO1xuICAgIH0pO1xuICAgIHJldHVybiByZW1vdGVzQ29weTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlUGx1Z2luc0Zyb21SZW1vdGVzKFxuICAgIHJlbW90ZXM6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucyxcbiAgICBwbHVnaW5zOiBBcHBsaWNhdGlvblBsdWdpbiB8IEFwcGxpY2F0aW9uUGx1Z2luW11cbiAgKSB7XG4gICAgY29uc3QgcmVtb3Rlc0NvcHkgPSBjbG9uZURlZXAocmVtb3Rlcyk7XG4gICAgY29uc3QgdGVtcCA9IEFycmF5LmlzQXJyYXkocGx1Z2lucykgPyBwbHVnaW5zIDogW3BsdWdpbnNdO1xuXG4gICAgdGVtcC5mb3JFYWNoKHBsdWdpbiA9PiB7XG4gICAgICBjb25zdCB7IGNvbnRleHRQYXRoLCBtb2R1bGVOYW1lIH0gPSB0aGlzLnBhcnNlUGx1Z2luSWQocGx1Z2luLmlkKTtcbiAgICAgIGlmICghY29udGV4dFBhdGggfHwgIW1vZHVsZU5hbWUgfHwgIXJlbW90ZXNDb3B5W2NvbnRleHRQYXRoXSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICByZW1vdGVzQ29weVtjb250ZXh0UGF0aF0gPSByZW1vdGVzQ29weVtjb250ZXh0UGF0aF0uZmlsdGVyKHAgPT4gcCAhPT0gbW9kdWxlTmFtZSk7XG4gICAgICByZW1vdGVzQ29weVtjb250ZXh0UGF0aF0gPSBbLi4ubmV3IFNldChyZW1vdGVzQ29weVtjb250ZXh0UGF0aF0pXTtcbiAgICAgIGlmIChyZW1vdGVzQ29weVtjb250ZXh0UGF0aF0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRlbGV0ZSByZW1vdGVzQ29weVtjb250ZXh0UGF0aF07XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlbW90ZXNDb3B5O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVQbHVnaW5JZChjb250ZXh0UGF0aDogc3RyaW5nLCBwbHVnaW46IEFwcGxpY2F0aW9uUGx1Z2luLCB2ZXJzaW9uOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtjb250ZXh0UGF0aH1AJHt2ZXJzaW9ufS8ke3BsdWdpbi5tb2R1bGV9YDtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VQbHVnaW5JZChpZDogc3RyaW5nKTogeyBjb250ZXh0UGF0aDogc3RyaW5nOyBtb2R1bGVOYW1lOiBzdHJpbmcgfSB7XG4gICAgY29uc3QgW2NvbnRleHRQYXRoLCBtb2R1bGVOYW1lXSA9IGlkLnNwbGl0KCcvJyk7XG4gICAgcmV0dXJuIHsgY29udGV4dFBhdGgsIG1vZHVsZU5hbWUgfTtcbiAgfVxufVxuIl19