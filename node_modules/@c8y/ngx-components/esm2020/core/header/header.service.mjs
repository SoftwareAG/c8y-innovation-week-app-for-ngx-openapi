import { Injectable } from '@angular/core';
import { combineLatest, BehaviorSubject } from 'rxjs';
import { map, debounceTime, distinctUntilChanged, delay } from 'rxjs/operators';
import { OptionsService } from '../common/options.service';
import { StateService } from '../common/state-service.abstract';
import { HumanizeAppNamePipe } from '../common/humanize-app-name.pipe';
import { DrawerService } from '../drawer/drawer.service';
import * as i0 from "@angular/core";
import * as i1 from "../common/options.service";
import * as i2 from "../common/humanize-app-name.pipe";
import * as i3 from "../drawer/drawer.service";
/**
 * A service which defines header functions.
 */
export class HeaderService extends StateService {
    constructor(options, humanizeAppName, drawerService) {
        super();
        this.options = options;
        this.humanizeAppName = humanizeAppName;
        this.drawerService = drawerService;
        this.headerOpen = false;
        this.state$ = new BehaviorSubject({
            title: undefined,
            nav: {
                open: false
            },
            rightDrawer: {
                open: false
            }
        });
        this.title = undefined;
        this.DELAY_TO_AVOID_FLICKERING_ON_ASYNC_NODES = 1000;
        this.header$ = this.map((header) => header);
        this.canToggleNavigator$ = this.drawerService.items$.pipe(map(items => !!items.filter(tmp => tmp.position === 'left' && !tmp.noneRequired)?.length), distinctUntilChanged(), delay(this.DELAY_TO_AVOID_FLICKERING_ON_ASYNC_NODES));
        this.navigatorOpen$ = combineLatest([
            this.map(({ nav }) => nav.open),
            this.canToggleNavigator$
        ]).pipe(map(([open, hasItems]) => open && hasItems));
        this.rightDrawerOpen$ = this.map(({ rightDrawer }) => rightDrawer.open).pipe();
        const titleReference = document.querySelector('title');
        const isGlobalTitleValid = !!options.globalTitle &&
            typeof options.globalTitle === 'string' &&
            options.globalTitle.length > 0;
        this.title = {
            elementRef: titleReference,
            titleSuffix: isGlobalTitleValid ? `${options.globalTitle} - ${options.name}` : options.name
        };
        this.humanizeAppName.transform(options.name).subscribe(nameTranslated => {
            this.title.titleSuffix = isGlobalTitleValid
                ? `${options.globalTitle} - ${nameTranslated}`
                : nameTranslated;
        });
    }
    get state() {
        return this.state$.value;
    }
    get navigatorHiddenOnStartup() {
        return this.options.hideNavigator;
    }
    get largeWidth() {
        return document.documentElement.clientWidth > 1200;
    }
    get shouldToggle() {
        return this.largeWidth && !this.navigatorHiddenOnStartup && !this.state.nav.open;
    }
    /**
     * Toggles the main header menu in mobile view.
     */
    toggle() {
        this.headerOpen = !this.headerOpen;
    }
    /**
     * Toggles the navigator open status.
     */
    toggleNavigator() {
        this.state.nav.open = !this.state.nav.open;
        this.emitNewState();
    }
    /**
     * Force to close the navigator.
     */
    closeNavigator() {
        this.state.nav.open = false;
        this.emitNewState();
    }
    /**
     * Toggles the right drawer open status.
     */
    toggleRightDrawer() {
        this.state.rightDrawer.open = !this.state.rightDrawer.open;
        this.emitNewState();
    }
    /**
     * Force to close the right drawer.
     */
    closeRightDrawer() {
        this.state.rightDrawer.open = false;
        this.emitNewState();
    }
    /**
     * Configures navigation options.
     * @param config Object with the properties:
     * - open: Boolean
     */
    configNavigator(config = {}) {
        this.state.nav = Object.assign(this.state.nav, config);
        this.emitNewState();
    }
    /**
     * Change the application title.
     * @param newTitle The new title of the application.
     */
    changeTitle(newTitle, pageTitleUpdate = true) {
        this.state.title = newTitle;
        this.state.pageTitleUpdate = pageTitleUpdate;
        this.emitNewState();
    }
    /**
     * Change the page title.
     * @param newTitle The new title of the page.
     */
    changePageTitle(newTitle) {
        this.title.elementRef.innerText = newTitle
            ? `${newTitle} / ${this.title.titleSuffix}`
            : `${this.title.titleSuffix}`;
    }
    /**
     * This methods checks if the navigator toggles on startup
     * or if an item is added to the navigator node.
     * Delay of 300ms is intended for animation purpose.
     */
    verifyIfNavOpen() {
        this.canToggleNavigator$
            .pipe(debounceTime(300))
            .subscribe(hasItems => hasItems && this.shouldToggle && this.toggleNavigator());
    }
    shouldShowBreadcrumbs() {
        return this.options.breadcrumbs;
    }
}
HeaderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: HeaderService, deps: [{ token: i1.OptionsService }, { token: i2.HumanizeAppNamePipe }, { token: i3.DrawerService }], target: i0.ɵɵFactoryTarget.Injectable });
HeaderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: HeaderService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: HeaderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.OptionsService }, { type: i2.HumanizeAppNamePipe }, { type: i3.DrawerService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2hlYWRlci9oZWFkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFaEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7OztBQUV6RDs7R0FFRztBQUlILE1BQU0sT0FBTyxhQUFjLFNBQVEsWUFBWTtJQW9CN0MsWUFDVSxPQUF1QixFQUN2QixlQUFvQyxFQUNwQyxhQUE0QjtRQUVwQyxLQUFLLEVBQUUsQ0FBQztRQUpBLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLG9CQUFlLEdBQWYsZUFBZSxDQUFxQjtRQUNwQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQXRCdEMsZUFBVSxHQUFHLEtBQUssQ0FBQztRQU1uQixXQUFNLEdBQTRCLElBQUksZUFBZSxDQUFTO1lBQzVELEtBQUssRUFBRSxTQUFTO1lBQ2hCLEdBQUcsRUFBRTtnQkFDSCxJQUFJLEVBQUUsS0FBSzthQUNaO1lBQ0QsV0FBVyxFQUFFO2dCQUNYLElBQUksRUFBRSxLQUFLO2FBQ1o7U0FDRixDQUFDLENBQUM7UUFFSCxVQUFLLEdBQUcsU0FBUyxDQUFDO1FBQ1QsNkNBQXdDLEdBQUcsSUFBSSxDQUFDO1FBUXZE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QWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFNBQVMsR0FBRyxRQUFRO1lBQ3hDLENBQUMsQ0FBQyxHQUFHLFFBQVEsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUMzQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsZUFBZTtRQUNiLElBQUksQ0FBQyxtQkFBbUI7YUFDckIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QixTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQztJQUNwRixDQUFDO0lBRUQscUJBQXFCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDbEMsQ0FBQzs7MEdBMUpVLGFBQWE7OEdBQWIsYUFBYSxjQUZaLE1BQU07MkZBRVAsYUFBYTtrQkFIekIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgZGVib3VuY2VUaW1lLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3N0YXRlLXNlcnZpY2UuYWJzdHJhY3QnO1xuaW1wb3J0IHsgSGVhZGVyIH0gZnJvbSAnLi9oZWFkZXIubW9kZWwnO1xuaW1wb3J0IHsgSHVtYW5pemVBcHBOYW1lUGlwZSB9IGZyb20gJy4uL2NvbW1vbi9odW1hbml6ZS1hcHAtbmFtZS5waXBlJztcbmltcG9ydCB7IERyYXdlclNlcnZpY2UgfSBmcm9tICcuLi9kcmF3ZXIvZHJhd2VyLnNlcnZpY2UnO1xuXG4vKipcbiAqIEEgc2VydmljZSB3aGljaCBkZWZpbmVzIGhlYWRlciBmdW5jdGlvbnMuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEhlYWRlclNlcnZpY2UgZXh0ZW5kcyBTdGF0ZVNlcnZpY2Uge1xuICBoZWFkZXJPcGVuID0gZmFsc2U7XG4gIGhlYWRlciQ6IE9ic2VydmFibGU8SGVhZGVyPjtcbiAgbmF2aWdhdG9yT3BlbiQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHJpZ2h0RHJhd2VyT3BlbiQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIGNhblRvZ2dsZU5hdmlnYXRvciQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgc3RhdGUkOiBCZWhhdmlvclN1YmplY3Q8SGVhZGVyPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SGVhZGVyPih7XG4gICAgdGl0bGU6IHVuZGVmaW5lZCxcbiAgICBuYXY6IHtcbiAgICAgIG9wZW46IGZhbHNlXG4gICAgfSxcbiAgICByaWdodERyYXdlcjoge1xuICAgICAgb3BlbjogZmFsc2VcbiAgICB9XG4gIH0pO1xuXG4gIHRpdGxlID0gdW5kZWZpbmVkO1xuICByZWFkb25seSBERUxBWV9UT19BVk9JRF9GTElDS0VSSU5HX09OX0FTWU5DX05PREVTID0gMTAwMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgaHVtYW5pemVBcHBOYW1lOiBIdW1hbml6ZUFwcE5hbWVQaXBlLFxuICAgIHByaXZhdGUgZHJhd2VyU2VydmljZTogRHJhd2VyU2VydmljZVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuaGVhZGVyJCA9IHRoaXMubWFwKChoZWFkZXI6IEhlYWRlcikgPT4gaGVhZGVyKTtcbiAgICB0aGlzLmNhblRvZ2dsZU5hdmlnYXRvciQgPSB0aGlzLmRyYXdlclNlcnZpY2UuaXRlbXMkLnBpcGUoXG4gICAgICBtYXAoaXRlbXMgPT4gISFpdGVtcy5maWx0ZXIodG1wID0+IHRtcC5wb3NpdGlvbiA9PT0gJ2xlZnQnICYmICF0bXAubm9uZVJlcXVpcmVkKT8ubGVuZ3RoKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBkZWxheSh0aGlzLkRFTEFZX1RPX0FWT0lEX0ZMSUNLRVJJTkdfT05fQVNZTkNfTk9ERVMpXG4gICAgKTtcbiAgICB0aGlzLm5hdmlnYXRvck9wZW4kID0gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLm1hcCgoeyBuYXYgfSkgPT4gbmF2Lm9wZW4pLFxuICAgICAgdGhpcy5jYW5Ub2dnbGVOYXZpZ2F0b3IkXG4gICAgXSkucGlwZShtYXAoKFtvcGVuLCBoYXNJdGVtc10pID0+IG9wZW4gJiYgaGFzSXRlbXMpKTtcbiAgICB0aGlzLnJpZ2h0RHJhd2VyT3BlbiQgPSB0aGlzLm1hcCgoeyByaWdodERyYXdlciB9KSA9PiByaWdodERyYXdlci5vcGVuKS5waXBlKCk7XG4gICAgY29uc3QgdGl0bGVSZWZlcmVuY2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCd0aXRsZScpO1xuXG4gICAgY29uc3QgaXNHbG9iYWxUaXRsZVZhbGlkID1cbiAgICAgICEhb3B0aW9ucy5nbG9iYWxUaXRsZSAmJlxuICAgICAgdHlwZW9mIG9wdGlvbnMuZ2xvYmFsVGl0bGUgPT09ICdzdHJpbmcnICYmXG4gICAgICBvcHRpb25zLmdsb2JhbFRpdGxlLmxlbmd0aCA+IDA7XG5cbiAgICB0aGlzLnRpdGxlID0ge1xuICAgICAgZWxlbWVudFJlZjogdGl0bGVSZWZlcmVuY2UsXG4gICAgICB0aXRsZVN1ZmZpeDogaXNHbG9iYWxUaXRsZVZhbGlkID8gYCR7b3B0aW9ucy5nbG9iYWxUaXRsZX0gLSAke29wdGlvbnMubmFtZX1gIDogb3B0aW9ucy5uYW1lXG4gICAgfTtcbiAgICB0aGlzLmh1bWFuaXplQXBwTmFtZS50cmFuc2Zvcm0ob3B0aW9ucy5uYW1lKS5zdWJzY3JpYmUobmFtZVRyYW5zbGF0ZWQgPT4ge1xuICAgICAgdGhpcy50aXRsZS50aXRsZVN1ZmZpeCA9IGlzR2xvYmFsVGl0bGVWYWxpZFxuICAgICAgICA/IGAke29wdGlvbnMuZ2xvYmFsVGl0bGV9IC0gJHtuYW1lVHJhbnNsYXRlZH1gXG4gICAgICAgIDogbmFtZVRyYW5zbGF0ZWQ7XG4gICAgfSk7XG4gIH1cblxuICBnZXQgc3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUkLnZhbHVlO1xuICB9XG5cbiAgZ2V0IG5hdmlnYXRvckhpZGRlbk9uU3RhcnR1cCgpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmhpZGVOYXZpZ2F0b3I7XG4gIH1cblxuICBnZXQgbGFyZ2VXaWR0aCgpIHtcbiAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoID4gMTIwMDtcbiAgfVxuXG4gIGdldCBzaG91bGRUb2dnbGUoKSB7XG4gICAgcmV0dXJuIHRoaXMubGFyZ2VXaWR0aCAmJiAhdGhpcy5uYXZpZ2F0b3JIaWRkZW5PblN0YXJ0dXAgJiYgIXRoaXMuc3RhdGUubmF2Lm9wZW47XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlcyB0aGUgbWFpbiBoZWFkZXIgbWVudSBpbiBtb2JpbGUgdmlldy5cbiAgICovXG4gIHRvZ2dsZSgpIHtcbiAgICB0aGlzLmhlYWRlck9wZW4gPSAhdGhpcy5oZWFkZXJPcGVuO1xuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZXMgdGhlIG5hdmlnYXRvciBvcGVuIHN0YXR1cy5cbiAgICovXG4gIHRvZ2dsZU5hdmlnYXRvcigpIHtcbiAgICB0aGlzLnN0YXRlLm5hdi5vcGVuID0gIXRoaXMuc3RhdGUubmF2Lm9wZW47XG4gICAgdGhpcy5lbWl0TmV3U3RhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JjZSB0byBjbG9zZSB0aGUgbmF2aWdhdG9yLlxuICAgKi9cbiAgY2xvc2VOYXZpZ2F0b3IoKSB7XG4gICAgdGhpcy5zdGF0ZS5uYXYub3BlbiA9IGZhbHNlO1xuICAgIHRoaXMuZW1pdE5ld1N0YXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlcyB0aGUgcmlnaHQgZHJhd2VyIG9wZW4gc3RhdHVzLlxuICAgKi9cbiAgdG9nZ2xlUmlnaHREcmF3ZXIoKSB7XG4gICAgdGhpcy5zdGF0ZS5yaWdodERyYXdlci5vcGVuID0gIXRoaXMuc3RhdGUucmlnaHREcmF3ZXIub3BlbjtcbiAgICB0aGlzLmVtaXROZXdTdGF0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvcmNlIHRvIGNsb3NlIHRoZSByaWdodCBkcmF3ZXIuXG4gICAqL1xuICBjbG9zZVJpZ2h0RHJhd2VyKCkge1xuICAgIHRoaXMuc3RhdGUucmlnaHREcmF3ZXIub3BlbiA9IGZhbHNlO1xuICAgIHRoaXMuZW1pdE5ld1N0YXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ29uZmlndXJlcyBuYXZpZ2F0aW9uIG9wdGlvbnMuXG4gICAqIEBwYXJhbSBjb25maWcgT2JqZWN0IHdpdGggdGhlIHByb3BlcnRpZXM6XG4gICAqIC0gb3BlbjogQm9vbGVhblxuICAgKi9cbiAgY29uZmlnTmF2aWdhdG9yKGNvbmZpZzogUGFydGlhbDxIZWFkZXJbJ25hdiddPiA9IHt9KSB7XG4gICAgdGhpcy5zdGF0ZS5uYXYgPSBPYmplY3QuYXNzaWduKHRoaXMuc3RhdGUubmF2LCBjb25maWcpO1xuICAgIHRoaXMuZW1pdE5ld1N0YXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hhbmdlIHRoZSBhcHBsaWNhdGlvbiB0aXRsZS5cbiAgICogQHBhcmFtIG5ld1RpdGxlIFRoZSBuZXcgdGl0bGUgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgY2hhbmdlVGl0bGUobmV3VGl0bGU/OiB1bmtub3duLCBwYWdlVGl0bGVVcGRhdGUgPSB0cnVlKSB7XG4gICAgdGhpcy5zdGF0ZS50aXRsZSA9IG5ld1RpdGxlO1xuICAgIHRoaXMuc3RhdGUucGFnZVRpdGxlVXBkYXRlID0gcGFnZVRpdGxlVXBkYXRlO1xuXG4gICAgdGhpcy5lbWl0TmV3U3RhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGFuZ2UgdGhlIHBhZ2UgdGl0bGUuXG4gICAqIEBwYXJhbSBuZXdUaXRsZSBUaGUgbmV3IHRpdGxlIG9mIHRoZSBwYWdlLlxuICAgKi9cbiAgY2hhbmdlUGFnZVRpdGxlKG5ld1RpdGxlPzogc3RyaW5nKSB7XG4gICAgdGhpcy50aXRsZS5lbGVtZW50UmVmLmlubmVyVGV4dCA9IG5ld1RpdGxlXG4gICAgICA/IGAke25ld1RpdGxlfSAvICR7dGhpcy50aXRsZS50aXRsZVN1ZmZpeH1gXG4gICAgICA6IGAke3RoaXMudGl0bGUudGl0bGVTdWZmaXh9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZHMgY2hlY2tzIGlmIHRoZSBuYXZpZ2F0b3IgdG9nZ2xlcyBvbiBzdGFydHVwXG4gICAqIG9yIGlmIGFuIGl0ZW0gaXMgYWRkZWQgdG8gdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKiBEZWxheSBvZiAzMDBtcyBpcyBpbnRlbmRlZCBmb3IgYW5pbWF0aW9uIHB1cnBvc2UuXG4gICAqL1xuICB2ZXJpZnlJZk5hdk9wZW4oKSB7XG4gICAgdGhpcy5jYW5Ub2dnbGVOYXZpZ2F0b3IkXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoMzAwKSlcbiAgICAgIC5zdWJzY3JpYmUoaGFzSXRlbXMgPT4gaGFzSXRlbXMgJiYgdGhpcy5zaG91bGRUb2dnbGUgJiYgdGhpcy50b2dnbGVOYXZpZ2F0b3IoKSk7XG4gIH1cblxuICBzaG91bGRTaG93QnJlYWRjcnVtYnMoKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5icmVhZGNydW1icztcbiAgfVxufVxuIl19