import { Component } from '@angular/core';
import { AppStateService } from '../common/ui-state.service';
import { TranslateService } from '../i18n/translate.service';
import { ModalService } from '../modal/modal.service';
import { gettext } from '../i18n/gettext';
import { UserPreferencesService } from '../common/user-preferences/user-preferences.service';
import { Status } from '../common/status.model';
import { Subject } from 'rxjs';
import { HeaderService } from '../header/header.service';
import { filter, first, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../i18n/translate.service";
import * as i2 from "../common/ui-state.service";
import * as i3 from "../common/user-preferences/user-preferences.service";
import * as i4 from "../modal/modal.service";
import * as i5 from "../header/header.service";
import * as i6 from "../common/icon.directive";
import * as i7 from "../i18n/c8y-translate.directive";
import * as i8 from "@angular/common";
import * as i9 from "@angular/forms";
import * as i10 from "../i18n/c8y-translate.pipe";
export class UiSettingsComponent {
    constructor(translate, state, ui, userPreferences, c8yModalService, headerService) {
        this.translate = translate;
        this.state = state;
        this.ui = ui;
        this.userPreferences = userPreferences;
        this.c8yModalService = c8yModalService;
        this.headerService = headerService;
        this.destroyed$ = new Subject();
        this.currentLang = this.ui.state.lang;
        this.ui.state$
            .pipe(filter(({ lang }) => lang !== this.currentLang), takeUntil(this.destroyed$), first())
            .subscribe(({ lang }) => (this.currentLang = lang));
        this.open$ = this.headerService.rightDrawerOpen$;
    }
    ngOnInit() {
        this.languages = this.state.state.langs.map(l => ({
            lang: l,
            nativeLanguage: this.translate.getNativeLanguage(l)
        }));
    }
    ngOnDestroy() {
        this.destroyed$.next();
        this.destroyed$.complete();
    }
    async onLanguageChange(changedLang) {
        if (!changedLang) {
            return;
        }
        let reloadRequired = false;
        await this.translate.switchToLanguage(changedLang);
        if (changedLang !== this.currentLang) {
            reloadRequired = await this.persistLanguage(changedLang);
        }
        if (reloadRequired) {
            location.reload();
        }
    }
    async persistLanguage(lang) {
        let shouldReload;
        try {
            await this.c8yModalService.confirm(gettext('Reload recommended'), gettext('To change the language in the entire application, we recommend you to reload the page. If you have any unsaved changes, you can reload later. How would you like to proceed?'), Status.WARNING, {
                ok: gettext('Reload now'),
                cancel: gettext('Reload later')
            });
            this.translate.saveInLocalStorage(lang);
            await this.userPreferences.set('language', lang);
            this.currentLang = lang;
            shouldReload = true;
        }
        catch (ex) {
            this.translate.saveInLocalStorage(lang);
            await this.userPreferences.set('language', lang);
            this.currentLang = lang;
            shouldReload = false;
        }
        return shouldReload;
    }
}
UiSettingsComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: UiSettingsComponent, deps: [{ token: i1.TranslateService }, { token: i2.AppStateService }, { token: i2.AppStateService }, { token: i3.UserPreferencesService }, { token: i4.ModalService }, { token: i5.HeaderService }], target: i0.ɵɵFactoryTarget.Component });
UiSettingsComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: UiSettingsComponent, selector: "c8y-ui-settings", ngImport: i0, template: "<div class=\"separator-top p-t-8 p-b-8\">\n  <div class=\"c8y-right-drawer__item sticky-top\">\n    <i c8yIcon=\"eyedropper\"></i>\n    <span class=\"text-bold\">{{ 'UI settings' | translate }}</span>\n  </div>\n  <!-- TODO: uncomment and finish implementation when there will be agreement on using dark theme -->\n  <!-- <div class=\"p-l-16 p-r-16 p-b-16\">\n    <p>{{'Theme' | translate}}</p>\n    <div class=\"c8y-switch-multistate\">\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op1\" checked=\"checked\" [attr.aria-label]=\"'Light'\">\n      <label for=\"op1\" title=\"{{'Light' | translate}}\">\n        <i c8yIcon=\"sun\"></i>\n      </label>\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op2\" [attr.aria-label]=\"'Dark'\">\n      <label for=\"op2\" title=\"{{'Dark' | translate}}\">\n        <i c8yIcon=\"moon\"></i></label>\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op3\" [attr.aria-label]=\"'System'\">\n      <label for=\"op3\" title=\"{{'System' | translate}}\">\n        <i c8yIcon=\"imac-settings\"></i>\n      </label>\n      <div class=\"c8y-switch-multistate__handle\"></div>\n    </div>\n  </div> -->\n  <div class=\"form-group p-l-16 p-r-16\">\n    <label translate for=\"userLang\">Language</label>\n    <div class=\"c8y-select-wrapper\">\n      <select\n        id=\"userLang\"\n        #selectLang\n        tabindex=\"{{ (open$ | async) ? '0' : '-1' }}\"\n        [ngModel]=\"currentLang\"\n        (change)=\"onLanguageChange(selectLang.value)\"\n      >\n        <option *ngFor=\"let language of languages\" [value]=\"language.lang\">\n          {{ language.nativeLanguage }}\n        </option>\n      </select>\n      <span></span>\n    </div>\n  </div>\n</div>\n", dependencies: [{ kind: "directive", type: i6.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i7.C8yTranslateDirective, selector: "[translate],[ngx-translate]" }, { kind: "directive", type: i8.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i9.NgSelectOption, selector: "option", inputs: ["ngValue", "value"] }, { kind: "directive", type: i9.ɵNgSelectMultipleOption, selector: "option", inputs: ["ngValue", "value"] }, { kind: "directive", type: i9.SelectControlValueAccessor, selector: "select:not([multiple])[formControlName],select:not([multiple])[formControl],select:not([multiple])[ngModel]", inputs: ["compareWith"] }, { kind: "directive", type: i9.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i9.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "pipe", type: i10.C8yTranslatePipe, name: "translate" }, { kind: "pipe", type: i8.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: UiSettingsComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-ui-settings', template: "<div class=\"separator-top p-t-8 p-b-8\">\n  <div class=\"c8y-right-drawer__item sticky-top\">\n    <i c8yIcon=\"eyedropper\"></i>\n    <span class=\"text-bold\">{{ 'UI settings' | translate }}</span>\n  </div>\n  <!-- TODO: uncomment and finish implementation when there will be agreement on using dark theme -->\n  <!-- <div class=\"p-l-16 p-r-16 p-b-16\">\n    <p>{{'Theme' | translate}}</p>\n    <div class=\"c8y-switch-multistate\">\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op1\" checked=\"checked\" [attr.aria-label]=\"'Light'\">\n      <label for=\"op1\" title=\"{{'Light' | translate}}\">\n        <i c8yIcon=\"sun\"></i>\n      </label>\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op2\" [attr.aria-label]=\"'Dark'\">\n      <label for=\"op2\" title=\"{{'Dark' | translate}}\">\n        <i c8yIcon=\"moon\"></i></label>\n      <input tabindex=\"{{ (open$ | async) ? '0' : '-1'}}\" type=\"radio\" name=\"theme-switcher\" id=\"op3\" [attr.aria-label]=\"'System'\">\n      <label for=\"op3\" title=\"{{'System' | translate}}\">\n        <i c8yIcon=\"imac-settings\"></i>\n      </label>\n      <div class=\"c8y-switch-multistate__handle\"></div>\n    </div>\n  </div> -->\n  <div class=\"form-group p-l-16 p-r-16\">\n    <label translate for=\"userLang\">Language</label>\n    <div class=\"c8y-select-wrapper\">\n      <select\n        id=\"userLang\"\n        #selectLang\n        tabindex=\"{{ (open$ | async) ? '0' : '-1' }}\"\n        [ngModel]=\"currentLang\"\n        (change)=\"onLanguageChange(selectLang.value)\"\n      >\n        <option *ngFor=\"let language of languages\" [value]=\"language.lang\">\n          {{ language.nativeLanguage }}\n        </option>\n      </select>\n      <span></span>\n    </div>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.TranslateService }, { type: i2.AppStateService }, { type: i2.AppStateService }, { type: i3.UserPreferencesService }, { type: i4.ModalService }, { type: i5.HeaderService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktc2V0dGluZ3MuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS91aS1zZXR0aW5ncy91aS1zZXR0aW5ncy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9jb3JlL3VpLXNldHRpbmdzL3VpLXNldHRpbmdzLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQzdGLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7O0FBTTFELE1BQU0sT0FBTyxtQkFBbUI7SUFNOUIsWUFDVSxTQUEyQixFQUMzQixLQUFzQixFQUN0QixFQUFtQixFQUNuQixlQUF1QyxFQUN2QyxlQUE2QixFQUM3QixhQUE0QjtRQUw1QixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixVQUFLLEdBQUwsS0FBSyxDQUFpQjtRQUN0QixPQUFFLEdBQUYsRUFBRSxDQUFpQjtRQUNuQixvQkFBZSxHQUFmLGVBQWUsQ0FBd0I7UUFDdkMsb0JBQWUsR0FBZixl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RCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDOztnSEE3RVUsbUJBQW1CO29HQUFuQixtQkFBbUIsdURDZmhDLGkxREF5Q0E7MkZEMUJhLG1CQUFtQjtrQkFKL0IsU0FBUzsrQkFDRSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi90cmFuc2xhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBNb2RhbFNlcnZpY2UgfSBmcm9tICcuLi9tb2RhbC9tb2RhbC5zZXJ2aWNlJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuaW1wb3J0IHsgVXNlclByZWZlcmVuY2VzU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi91c2VyLXByZWZlcmVuY2VzL3VzZXItcHJlZmVyZW5jZXMuc2VydmljZSc7XG5pbXBvcnQgeyBTdGF0dXMgfSBmcm9tICcuLi9jb21tb24vc3RhdHVzLm1vZGVsJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEhlYWRlclNlcnZpY2UgfSBmcm9tICcuLi9oZWFkZXIvaGVhZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgZmlsdGVyLCBmaXJzdCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktdWktc2V0dGluZ3MnLFxuICB0ZW1wbGF0ZVVybDogJy4vdWktc2V0dGluZ3MuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFVpU2V0dGluZ3NDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIG9wZW4kOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBjdXJyZW50TGFuZzogc3RyaW5nO1xuICBsYW5ndWFnZXM6IHsgbGFuZzogc3RyaW5nOyBuYXRpdmVMYW5ndWFnZTogc3RyaW5nIH1bXTtcbiAgcHJpdmF0ZSBkZXN0cm95ZWQkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIHN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1aTogQXBwU3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgdXNlclByZWZlcmVuY2VzOiBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYzh5TW9kYWxTZXJ2aWNlOiBNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBoZWFkZXJTZXJ2aWNlOiBIZWFkZXJTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuY3VycmVudExhbmcgPSB0aGlzLnVpLnN0YXRlLmxhbmc7XG4gICAgdGhpcy51aS5zdGF0ZSRcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoKHsgbGFuZyB9KSA9PiBsYW5nICE9PSB0aGlzLmN1cnJlbnRMYW5nKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICAgICAgIGZpcnN0KClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHsgbGFuZyB9KSA9PiAodGhpcy5jdXJyZW50TGFuZyA9IGxhbmcpKTtcbiAgICB0aGlzLm9wZW4kID0gdGhpcy5oZWFkZXJTZXJ2aWNlLnJpZ2h0RHJhd2VyT3BlbiQ7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmxhbmd1YWdlcyA9ICh0aGlzLnN0YXRlLnN0YXRlLmxhbmdzIGFzIHN0cmluZ1tdKS5tYXAobCA9PiAoe1xuICAgICAgbGFuZzogbCxcbiAgICAgIG5hdGl2ZUxhbmd1YWdlOiB0aGlzLnRyYW5zbGF0ZS5nZXROYXRpdmVMYW5ndWFnZShsKVxuICAgIH0pKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveWVkJC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95ZWQkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBhc3luYyBvbkxhbmd1YWdlQ2hhbmdlKGNoYW5nZWRMYW5nOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWNoYW5nZWRMYW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCByZWxvYWRSZXF1aXJlZCA9IGZhbHNlO1xuICAgIGF3YWl0IHRoaXMudHJhbnNsYXRlLnN3aXRjaFRvTGFuZ3VhZ2UoY2hhbmdlZExhbmcpO1xuICAgIGlmIChjaGFuZ2VkTGFuZyAhPT0gdGhpcy5jdXJyZW50TGFuZykge1xuICAgICAgcmVsb2FkUmVxdWlyZWQgPSBhd2FpdCB0aGlzLnBlcnNpc3RMYW5ndWFnZShjaGFuZ2VkTGFuZyk7XG4gICAgfVxuICAgIGlmIChyZWxvYWRSZXF1aXJlZCkge1xuICAgICAgbG9jYXRpb24ucmVsb2FkKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGVyc2lzdExhbmd1YWdlKGxhbmc6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGxldCBzaG91bGRSZWxvYWQ6IGJvb2xlYW4gfCBQcm9taXNlTGlrZTxib29sZWFuPjtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5jOHlNb2RhbFNlcnZpY2UuY29uZmlybShcbiAgICAgICAgZ2V0dGV4dCgnUmVsb2FkIHJlY29tbWVuZGVkJyksXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgJ1RvIGNoYW5nZSB0aGUgbGFuZ3VhZ2UgaW4gdGhlIGVudGlyZSBhcHBsaWNhdGlvbiwgd2UgcmVjb21tZW5kIHlvdSB0byByZWxvYWQgdGhlIHBhZ2UuIElmIHlvdSBoYXZlIGFueSB1bnNhdmVkIGNoYW5nZXMsIHlvdSBjYW4gcmVsb2FkIGxhdGVyLiBIb3cgd291bGQgeW91IGxpa2UgdG8gcHJvY2VlZD8nXG4gICAgICAgICksXG4gICAgICAgIFN0YXR1cy5XQVJOSU5HLFxuICAgICAgICB7XG4gICAgICAgICAgb2s6IGdldHRleHQoJ1JlbG9hZCBub3cnKSxcbiAgICAgICAgICBjYW5jZWw6IGdldHRleHQoJ1JlbG9hZCBsYXRlcicpXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICB0aGlzLnRyYW5zbGF0ZS5zYXZlSW5Mb2NhbFN0b3JhZ2UobGFuZyk7XG4gICAgICBhd2FpdCB0aGlzLnVzZXJQcmVmZXJlbmNlcy5zZXQoJ2xhbmd1YWdlJywgbGFuZyk7XG4gICAgICB0aGlzLmN1cnJlbnRMYW5nID0gbGFuZztcbiAgICAgIHNob3VsZFJlbG9hZCA9IHRydWU7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMudHJhbnNsYXRlLnNhdmVJbkxvY2FsU3RvcmFnZShsYW5nKTtcbiAgICAgIGF3YWl0IHRoaXMudXNlclByZWZlcmVuY2VzLnNldCgnbGFuZ3VhZ2UnLCBsYW5nKTtcbiAgICAgIHRoaXMuY3VycmVudExhbmcgPSBsYW5nO1xuICAgICAgc2hvdWxkUmVsb2FkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZFJlbG9hZDtcbiAgfVxufVxuIiwiPGRpdiBjbGFzcz1cInNlcGFyYXRvci10b3AgcC10LTggcC1iLThcIj5cbiAgPGRpdiBjbGFzcz1cImM4eS1yaWdodC1kcmF3ZXJfX2l0ZW0gc3RpY2t5LXRvcFwiPlxuICAgIDxpIGM4eUljb249XCJleWVkcm9wcGVyXCI+PC9pPlxuICAgIDxzcGFuIGNsYXNzPVwidGV4dC1ib2xkXCI+e3sgJ1VJIHNldHRpbmdzJyB8IHRyYW5zbGF0ZSB9fTwvc3Bhbj5cbiAgPC9kaXY+XG4gIDwhLS0gVE9ETzogdW5jb21tZW50IGFuZCBmaW5pc2ggaW1wbGVtZW50YXRpb24gd2hlbiB0aGVyZSB3aWxsIGJlIGFncmVlbWVudCBvbiB1c2luZyBkYXJrIHRoZW1lIC0tPlxuICA8IS0tIDxkaXYgY2xhc3M9XCJwLWwtMTYgcC1yLTE2IHAtYi0xNlwiPlxuICAgIDxwPnt7J1RoZW1lJyB8IHRyYW5zbGF0ZX19PC9wPlxuICAgIDxkaXYgY2xhc3M9XCJjOHktc3dpdGNoLW11bHRpc3RhdGVcIj5cbiAgICAgIDxpbnB1dCB0YWJpbmRleD1cInt7IChvcGVuJCB8IGFzeW5jKSA/ICcwJyA6ICctMSd9fVwiIHR5cGU9XCJyYWRpb1wiIG5hbWU9XCJ0aGVtZS1zd2l0Y2hlclwiIGlkPVwib3AxXCIgY2hlY2tlZD1cImNoZWNrZWRcIiBbYXR0ci5hcmlhLWxhYmVsXT1cIidMaWdodCdcIj5cbiAgICAgIDxsYWJlbCBmb3I9XCJvcDFcIiB0aXRsZT1cInt7J0xpZ2h0JyB8IHRyYW5zbGF0ZX19XCI+XG4gICAgICAgIDxpIGM4eUljb249XCJzdW5cIj48L2k+XG4gICAgICA8L2xhYmVsPlxuICAgICAgPGlucHV0IHRhYmluZGV4PVwie3sgKG9wZW4kIHwgYXN5bmMpID8gJzAnIDogJy0xJ319XCIgdHlwZT1cInJhZGlvXCIgbmFtZT1cInRoZW1lLXN3aXRjaGVyXCIgaWQ9XCJvcDJcIiBbYXR0ci5hcmlhLWxhYmVsXT1cIidEYXJrJ1wiPlxuICAgICAgPGxhYmVsIGZvcj1cIm9wMlwiIHRpdGxlPVwie3snRGFyaycgfCB0cmFuc2xhdGV9fVwiPlxuICAgICAgICA8aSBjOHlJY29uPVwibW9vblwiPjwvaT48L2xhYmVsPlxuICAgICAgPGlucHV0IHRhYmluZGV4PVwie3sgKG9wZW4kIHwgYXN5bmMpID8gJzAnIDogJy0xJ319XCIgdHlwZT1cInJhZGlvXCIgbmFtZT1cInRoZW1lLXN3aXRjaGVyXCIgaWQ9XCJvcDNcIiBbYXR0ci5hcmlhLWxhYmVsXT1cIidTeXN0ZW0nXCI+XG4gICAgICA8bGFiZWwgZm9yPVwib3AzXCIgdGl0bGU9XCJ7eydTeXN0ZW0nIHwgdHJhbnNsYXRlfX1cIj5cbiAgICAgICAgPGkgYzh5SWNvbj1cImltYWMtc2V0dGluZ3NcIj48L2k+XG4gICAgICA8L2xhYmVsPlxuICAgICAgPGRpdiBjbGFzcz1cImM4eS1zd2l0Y2gtbXVsdGlzdGF0ZV9faGFuZGxlXCI+PC9kaXY+XG4gICAgPC9kaXY+XG4gIDwvZGl2PiAtLT5cbiAgPGRpdiBjbGFzcz1cImZvcm0tZ3JvdXAgcC1sLTE2IHAtci0xNlwiPlxuICAgIDxsYWJlbCB0cmFuc2xhdGUgZm9yPVwidXNlckxhbmdcIj5MYW5ndWFnZTwvbGFiZWw+XG4gICAgPGRpdiBjbGFzcz1cImM4eS1zZWxlY3Qtd3JhcHBlclwiPlxuICAgICAgPHNlbGVjdFxuICAgICAgICBpZD1cInVzZXJMYW5nXCJcbiAgICAgICAgI3NlbGVjdExhbmdcbiAgICAgICAgdGFiaW5kZXg9XCJ7eyAob3BlbiQgfCBhc3luYykgPyAnMCcgOiAnLTEnIH19XCJcbiAgICAgICAgW25nTW9kZWxdPVwiY3VycmVudExhbmdcIlxuICAgICAgICAoY2hhbmdlKT1cIm9uTGFuZ3VhZ2VDaGFuZ2Uoc2VsZWN0TGFuZy52YWx1ZSlcIlxuICAgICAgPlxuICAgICAgICA8b3B0aW9uICpuZ0Zvcj1cImxldCBsYW5ndWFnZSBvZiBsYW5ndWFnZXNcIiBbdmFsdWVdPVwibGFuZ3VhZ2UubGFuZ1wiPlxuICAgICAgICAgIHt7IGxhbmd1YWdlLm5hdGl2ZUxhbmd1YWdlIH19XG4gICAgICAgIDwvb3B0aW9uPlxuICAgICAgPC9zZWxlY3Q+XG4gICAgICA8c3Bhbj48L3NwYW4+XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=