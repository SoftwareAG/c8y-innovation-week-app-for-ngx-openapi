import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { flatten } from 'lodash-es';
import { forkJoin, of } from 'rxjs';
import { map } from 'rxjs/operators';
import { toObservable } from '../common';
import { HOOK_DYNAMIC_PROVIDER_CONFIG } from './provider-configuration-hook';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
export class ProviderConfigurationTabFactory {
    constructor(config, router, injector) {
        this.router = router;
        this.injector = injector;
        this.config = flatten(config);
    }
    get() {
        if (!this.config || !this.config.length) {
            return;
        }
        const configForRoute = this.config.find(c => c.tab
            ? this.router.url === '/' + this.getNodeTabPath(c.navigation.path, c.tab.path) ||
                this.router.url.startsWith('/' + c.navigation.path.replace(/^\/|\/$/g, ''))
            : false);
        const filteredRoutes = configForRoute
            ? this.config.filter(c => c.navigation.path.replace(/^\/|\/$/g, '') ===
                configForRoute.navigation.path.replace(/^\/|\/$/g, '') && c.tab)
            : [];
        const canActivate = filteredRoutes
            .map(c => c.tab.canActivate && c.tab.canActivate.length
            ? c.tab.canActivate.map(ca => this.injector.get(ca))
            : undefined)
            .map(this.checkCanActivate.bind(this));
        return canActivate.length > 0
            ? forkJoin(canActivate).pipe(map((canActivateResult) => filteredRoutes
                .map((c, index) => {
                const tab = {
                    ...c.tab,
                    path: this.getNodeTabPath(c.navigation.path, c.tab.path)
                };
                return canActivateResult[index] ? tab : undefined;
            })
                .filter(el => !!el)))
            : [];
    }
    checkCanActivate(ca) {
        if (!!ca && ca.length) {
            const canActivateResult = ca
                .map((canActivate) => canActivate.canActivate(undefined, undefined))
                .map(toObservable);
            return forkJoin(canActivateResult).pipe(map((caResult) => caResult.reduce((acc, curr) => acc && curr)));
        }
        return of(true);
    }
    getNodeTabPath(nodePath, tabPath) {
        return `${nodePath.replace(/^\/|\/$/g, '')}/${tabPath.replace(/^\/|\/$/g, '')}`;
    }
}
ProviderConfigurationTabFactory.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ProviderConfigurationTabFactory, deps: [{ token: HOOK_DYNAMIC_PROVIDER_CONFIG, optional: true }, { token: i1.Router }, { token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable });
ProviderConfigurationTabFactory.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ProviderConfigurationTabFactory, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ProviderConfigurationTabFactory, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [HOOK_DYNAMIC_PROVIDER_CONFIG]
                }] }, { type: i1.Router }, { type: i0.Injector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi10YWIuZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvcHJvdmlkZXItY29uZmlndXJhdGlvbi9wcm92aWRlci1jb25maWd1cmF0aW9uLXRhYi5mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFlLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEMsT0FBTyxFQUFFLFFBQVEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHekMsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sK0JBQStCLENBQUM7OztBQUc3RSxNQUFNLE9BQU8sK0JBQStCO0lBRzFDLFlBR0UsTUFBaUMsRUFDMUIsTUFBYyxFQUNiLFFBQWtCO1FBRG5CLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDYixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRTFCLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxHQUFHO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUN2QyxPQUFPO1NBQ1I7UUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUMxQyxDQUFDLENBQUMsR0FBRztZQUNILENBQUMsQ0FBQyxJ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LENBQzFFLENBQUM7U0FDSDtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFTyxjQUFjLENBQUMsUUFBUSxFQUFFLE9BQU87UUFDdEMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7SUFDbEYsQ0FBQzs7NEhBekVVLCtCQUErQixrQkFLaEMsNEJBQTRCO2dJQUwzQiwrQkFBK0IsY0FEbEIsTUFBTTsyRkFDbkIsK0JBQStCO2tCQUQzQyxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7MEJBSzdCLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENhbkFjdGl2YXRlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgZmxhdHRlbiB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHRvT2JzZXJ2YWJsZSB9IGZyb20gJy4uL2NvbW1vbic7XG5pbXBvcnQgeyBUYWIsIFRhYkZhY3RvcnkgfSBmcm9tICcuLi90YWJzJztcbmltcG9ydCB7IER5bmFtaWNQcm92aWRlckNvbmZpZyB9IGZyb20gJy4vbW9kZWwvZHluYW1pYy1wcm92aWRlci1jb25maWcubW9kZWwnO1xuaW1wb3J0IHsgSE9PS19EWU5BTUlDX1BST1ZJREVSX0NPTkZJRyB9IGZyb20gJy4vcHJvdmlkZXItY29uZmlndXJhdGlvbi1ob29rJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBQcm92aWRlckNvbmZpZ3VyYXRpb25UYWJGYWN0b3J5IGltcGxlbWVudHMgVGFiRmFjdG9yeSB7XG4gIHByaXZhdGUgY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWdbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoSE9PS19EWU5BTUlDX1BST1ZJREVSX0NPTkZJRylcbiAgICBjb25maWc6IER5bmFtaWNQcm92aWRlckNvbmZpZ1tdW10sXG4gICAgcHVibGljIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge1xuICAgIHRoaXMuY29uZmlnID0gZmxhdHRlbihjb25maWcpO1xuICB9XG5cbiAgZ2V0KCkge1xuICAgIGlmICghdGhpcy5jb25maWcgfHwgIXRoaXMuY29uZmlnLmxlbmd0aCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbmZpZ0ZvclJvdXRlID0gdGhpcy5jb25maWcuZmluZChjID0+XG4gICAgICBjLnRhYlxuICAgICAgICA/IHRoaXMucm91dGVyLnVybCA9PT0gJy8nICsgdGhpcy5nZXROb2RlVGFiUGF0aChjLm5hdmlnYXRpb24ucGF0aCwgYy50YWIucGF0aCkgfHxcbiAgICAgICAgICB0aGlzLnJvdXRlci51cmwuc3RhcnRzV2l0aCgnLycgKyBjLm5hdmlnYXRpb24ucGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpKVxuICAgICAgICA6IGZhbHNlXG4gICAgKTtcblxuICAgIGNvbnN0IGZpbHRlcmVkUm91dGVzID0gY29uZmlnRm9yUm91dGVcbiAgICAgID8gdGhpcy5jb25maWcuZmlsdGVyKFxuICAgICAgICAgIGMgPT5cbiAgICAgICAgICAgIGMubmF2aWdhdGlvbi5wYXRoLnJlcGxhY2UoL15cXC98XFwvJC9nLCAnJykgPT09XG4gICAgICAgICAgICAgIGNvbmZpZ0ZvclJvdXRlLm5hdmlnYXRpb24ucGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpICYmIGMudGFiXG4gICAgICAgIClcbiAgICAgIDogW107XG5cbiAgICBjb25zdCBjYW5BY3RpdmF0ZTogQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj4gPSBmaWx0ZXJlZFJvdXRlc1xuICAgICAgLm1hcChjID0+XG4gICAgICAgIGMudGFiLmNhbkFjdGl2YXRlICYmIGMudGFiLmNhbkFjdGl2YXRlLmxlbmd0aFxuICAgICAgICAgID8gYy50YWIuY2FuQWN0aXZhdGUubWFwKGNhID0+IHRoaXMuaW5qZWN0b3IuZ2V0KGNhKSlcbiAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgKVxuICAgICAgLm1hcCh0aGlzLmNoZWNrQ2FuQWN0aXZhdGUuYmluZCh0aGlzKSk7XG5cbiAgICByZXR1cm4gY2FuQWN0aXZhdGUubGVuZ3RoID4gMFxuICAgICAgPyBmb3JrSm9pbihjYW5BY3RpdmF0ZSkucGlwZShcbiAgICAgICAgICBtYXAoKGNhbkFjdGl2YXRlUmVzdWx0OiBib29sZWFuW10pID0+XG4gICAgICAgICAgICBmaWx0ZXJlZFJvdXRlc1xuICAgICAgICAgICAgICAubWFwKChjLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhYiA9IHtcbiAgICAgICAgICAgICAgICAgIC4uLmMudGFiLFxuICAgICAgICAgICAgICAgICAgcGF0aDogdGhpcy5nZXROb2RlVGFiUGF0aChjLm5hdmlnYXRpb24ucGF0aCwgYy50YWIucGF0aClcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiBjYW5BY3RpdmF0ZVJlc3VsdFtpbmRleF0gPyAodGFiIGFzIFRhYikgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC5maWx0ZXIoZWwgPT4gISFlbClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIDogW107XG4gIH1cblxuICBwcml2YXRlIGNoZWNrQ2FuQWN0aXZhdGUoY2E6IENhbkFjdGl2YXRlW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoISFjYSAmJiBjYS5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGNhbkFjdGl2YXRlUmVzdWx0OiBBcnJheTxPYnNlcnZhYmxlPGJvb2xlYW4+PiA9IGNhXG4gICAgICAgIC5tYXAoKGNhbkFjdGl2YXRlOiBDYW5BY3RpdmF0ZSkgPT4gY2FuQWN0aXZhdGUuY2FuQWN0aXZhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQpKVxuICAgICAgICAubWFwKHRvT2JzZXJ2YWJsZSkgYXMgQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj47XG5cbiAgICAgIHJldHVybiBmb3JrSm9pbihjYW5BY3RpdmF0ZVJlc3VsdCkucGlwZShcbiAgICAgICAgbWFwKChjYVJlc3VsdDogYm9vbGVhbltdKSA9PiBjYVJlc3VsdC5yZWR1Y2UoKGFjYywgY3VycikgPT4gYWNjICYmIGN1cnIpKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROb2RlVGFiUGF0aChub2RlUGF0aCwgdGFiUGF0aCkge1xuICAgIHJldHVybiBgJHtub2RlUGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpfS8ke3RhYlBhdGgucmVwbGFjZSgvXlxcL3xcXC8kL2csICcnKX1gO1xuICB9XG59XG4iXX0=