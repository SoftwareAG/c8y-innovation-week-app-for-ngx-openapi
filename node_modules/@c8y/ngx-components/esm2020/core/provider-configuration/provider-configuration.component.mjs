import { Component } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { ActivatedRoute } from '@angular/router';
import { ɵdefineHiddenProp } from '@ngx-formly/core';
import { find, forOwn, get, mapValues, pick } from 'lodash-es';
import { BehaviorSubject, combineLatest, from, merge, of, Subject } from 'rxjs';
import { catchError, map, shareReplay, switchMap, tap } from 'rxjs/operators';
import { AlertService } from '../alert/alert.service';
import { Permissions, Status } from '../common/index';
import { C8yJSONSchema } from '../dynamic-forms/json-schema/c8y-json-schema.service';
import { ModalService } from '../modal/modal.service';
import { ProviderConfigurationService } from './service/provider-configuration.service';
import { ProviderDefinitionsService } from './service/provider-definitions.service';
import * as i0 from "@angular/core";
import * as i1 from "../common/index";
import * as i2 from "@angular/router";
import * as i3 from "../modal/modal.service";
import * as i4 from "../alert/alert.service";
import * as i5 from "./service/provider-definitions.service";
import * as i6 from "./service/provider-configuration.service";
import * as i7 from "../dynamic-forms/json-schema/c8y-json-schema.service";
import * as i8 from "../breadcrumb/breadcrumb.component";
import * as i9 from "../breadcrumb/breadcrumb-item.component";
import * as i10 from "@angular/common";
import * as i11 from "../common/if-allowed.directive";
import * as i12 from "../header/title/title.component";
import * as i13 from "../search/highlight.component";
import * as i14 from "../select/typeahead.component";
import * as i15 from "@angular/forms";
import * as i16 from "../forms/form-group.component";
import * as i17 from "../forms/message.directive";
import * as i18 from "../forms/messages.component";
import * as i19 from "../list-group/list-item.component";
import * as i20 from "@ngx-formly/core";
import * as i21 from "../i18n/c8y-translate.pipe";
export class ProviderConfigurationComponent {
    constructor(permissions, activatedRoute, modalService, alertService, providerDefinitionsService, providerConfigurationService, jsonschema) {
        this.permissions = permissions;
        this.activatedRoute = activatedRoute;
        this.modalService = modalService;
        this.alertService = alertService;
        this.providerDefinitionsService = providerDefinitionsService;
        this.providerConfigurationService = providerConfigurationService;
        this.jsonschema = jsonschema;
        this.layout$ = this.activatedRoute.data.pipe(map((config) => config.layout), tap((layout) => (this.layout = layout)), tap((layout) => {
            this.options.formState.disabled = !this.permissions.hasAllRoles(layout.saveRoles || []);
            this.beforeSaveHook = layout.beforeSaveHook;
        }));
        this.allRoles$ = this.layout$.pipe(map((layout) => [
            ...(layout.deleteRoles || []),
            ...(layout.saveRoles || [])
        ]));
        this.changeProvider$ = new BehaviorSubject(null);
        this.providerInput$ = new BehaviorSubject('');
        this.form = new FormGroup({});
        this.fields = [];
        this.options = {
            formState: {
                disabled: false
            }
        };
        this.reload$ = new BehaviorSubject(null);
        this.updatedConfiguration$ = new Subject();
    }
    ngOnInit() {
        const allProviders$ = from(this.providerDefinitionsService.list()).pipe(map(result => result.data), shareReplay(1));
        this.providers$ = combineLatest(allProviders$, this.providerInput$).pipe(map(([providers, input]) => input
            ? providers.filter(el => el.displayName.toLowerCase().indexOf(input.toLowerCase()) >= 0)
            : providers), shareReplay(1));
        this.configuration$ = merge(this.updatedConfiguration$, this.reload$.pipe(switchMap(() => from(this.providerConfigurationService.detail()).pipe(catchError(() => of({})))), map(result => result.data))).pipe(map(this.removeEncryptedValues), shareReplay(1));
        this.selectedProvider$ = combineLatest(allProviders$, this.configuration$, this.changeProvider$).pipe(tap(([_, configuration, newProvider]) => (this.model = newProvider
            ? pick(this.model, 'sms.senderName', 'sms.senderAddress')
            : configuration)), map(([providers, configuration, newProvider]) => newProvider ||
            find(providers, (provider) => get(configuration, 'provider') === provider.id)), tap((provider) => {
            if (provider) {
                const config = this.jsonschema.toFieldConfig(get(provider, 'schema'));
                if (config.fieldGroup) {
                    config.fieldGroup.forEach((fieldConfig) => {
                        ɵdefineHiddenProp(fieldConfig, '_keyPath', {
                            key: fieldConfig.key,
                            path: [fieldConfig.key]
                        });
                        fieldConfig.expressionProperties = {
                            'templateOptions.disabled': 'formState.disabled'
                        };
                    });
                }
                this.fields = [config];
                this.form = new FormGroup({});
            }
        }), shareReplay(1));
    }
    async saveProviderConfiguration() {
        const modelToSave = !!this.beforeSaveHook
            ? await this.beforeSaveHook(this.model, this.fields)
            : this.model;
        forOwn(modelToSave, (value, key) => {
            if (Array.isArray(value)) {
                modelToSave[key] = value.filter(item => !!item || item === 0);
            }
        });
        try {
            const res = await this.providerConfigurationService.update(modelToSave);
            this.changeProvider$.next(null);
            this.updatedConfiguration$.next(res.data);
            this.alertService.success(this.layout.configurationUpdatedSuccessMsg);
            this.form.markAsPristine();
        }
        catch (err) {
            this.alertService.addServerFailure(err);
        }
    }
    async deleteProviderConfiguration() {
        try {
            await this.modalService.confirm(this.layout.deleteConfigurationModalTitle, this.layout.deleteConfigurationModalBody, Status.DANGER, {
                ok: this.layout.deleteConfigurationModalOkBtnLabel,
                cancel: this.layout.deleteConfigurationModalCancelBtnLabel
            });
            await this.providerConfigurationService.delete();
            this.reload$.next();
            this.alertService.success(this.layout.configurationDeletedSuccessMsg);
        }
        catch (err) {
            if (err) {
                this.alertService.addServerFailure(err);
            }
        }
    }
    removeEncryptedValues(configuration) {
        return mapValues(configuration, value => (value === '<<Encrypted>>' ? undefined : value));
    }
}
ProviderConfigurationComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ProviderConfigurationComponent, deps: [{ token: i1.Permissions }, { token: i2.ActivatedRoute }, { token: i3.ModalService }, { token: i4.AlertService }, { token: i5.ProviderDefinitionsService }, { token: i6.ProviderConfigurationService }, { token: i7.C8yJSONSchema }], target: i0.ɵɵFactoryTarget.Component });
ProviderConfigurationComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: ProviderConfigurationComponent, selector: "c8y-sms-gateway", providers: [ProviderConfigurationService, ProviderDefinitionsService], ngImport: i0, template: "<c8y-title>\n  {{ (layout$ | async)?.pageTitle | translate }}\n</c8y-title>\n\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item\n    [label]=\"'Settings' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle !='Connectivity'\"\n    [label]=\"'SMS provider' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle =='Connectivity'\"\n    [label]=\"'Connectivity' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle =='Connectivity'\"\n    [icon]=\"'cog'\"\n    [label]=\"'SIM provider settings' | translate\"\n  ></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n\n<div class=\"row\">\n  <div class=\"col-md-8 col-xs-12\">\n    <form class=\"card card--fullpage\" (ngSubmit)=\"saveProviderConfiguration()\">\n      <div class=\"card-header separator\">\n        <div class=\"card-title\">\n          {{ (layout$ | async)?.cardTitle | translate }}\n        </div>\n      </div>\n      <div class=\"inner-scroll\">\n        <div class=\"card-block\">\n          <p *ngIf=\"!!(layout$ | async)?.description\" class=\"m-b-8\">\n            {{ (layout$ | async)?.description | translate }}\n          </p>\n          <c8y-form-group>\n            <label for=\"providerName\">{{ (layout$ | async)?.providerName | translate }}</label>\n            <c8y-typeahead\n              [disabled]=\"!permissions.hasAllRoles((layout$ | async)?.saveRoles || [])\"\n              [ngModel]=\"selectedProvider$ | async\"\n              [displayProperty]=\"'displayName'\"\n              name=\"providerName\"\n              placeholder=\"{{ (layout$ | async)?.providerNamePlaceholder | translate }}\"\n              (onSearch)=\"providerInput$.next($event)\"\n              [allowFreeEntries]=\"false\"\n              [required]=\"true\"\n              [container]=\"'body'\"\n            >\n              <c8y-li\n                *ngFor=\"let provider of providers$ | async\"\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"changeProvider$.next(provider); providerInput$.next('')\"\n                [active]=\"(selectedProvider$ | async) === provider\"\n                [attr.role]=\"'menuitem'\"\n              >\n                <c8y-highlight\n                  [text]=\"provider.displayName || '--'\"\n                  [pattern]=\"providerInput$ | async\"\n                ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <c8y-messages>\n              <c8y-message\n                name=\"notExisting\"\n                [text]=\"(layout$ | async)?.providerNameNoMatchesHint | translate\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n          <formly-form\n            *ngIf=\"selectedProvider$ | async\"\n            [form]=\"form\"\n            [fields]=\"fields\"\n            [model]=\"model\"\n            [options]=\"options\"\n          ></formly-form>\n        </div>\n      </div>\n      <div class=\"card-footer separator\" *c8yIfAllowed=\"allRoles$ | async; allowAny\">\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.deleteRoles\"\n          class=\"btn btn-default\"\n          type=\"button\"\n          (click)=\"deleteProviderConfiguration()\"\n          [disabled]=\"\n            !(configuration$ | async)?.provider && !(configuration$ | async)?.providerName\n          \"\n          title=\"{{ (layout$ | async)?.deleteBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.deleteBtnLabel | translate }}\n        </button>\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.saveRoles\"\n          class=\"btn btn-primary\"\n          type=\"submit\"\n          [disabled]=\"form.invalid || form.pristine\"\n          title=\"{{ (layout$ | async)?.saveBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.saveBtnLabel | translate }}\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n", dependencies: [{ kind: "component", type: i8.BreadcrumbComponent, selector: "c8y-breadcrumb" }, { kind: "component", type: i9.BreadcrumbItemComponent, selector: "c8y-breadcrumb-item", inputs: ["icon", "translate", "label", "path", "injector"] }, { kind: "directive", type: i10.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i10.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i11.IfAllowedDirective, selector: "[c8yIfAllowed]", inputs: ["c8yIfAllowed", "c8yIfAllowedAllowAny"] }, { kind: "component", type: i12.TitleComponent, selector: "c8y-title", inputs: ["pageTitleUpdate"] }, { kind: "component", type: i13.HighlightComponent, selector: "c8y-highlight", inputs: ["pattern", "text", "elementClass", "shouldTrimPattern"] }, { kind: "component", type: i14.TypeaheadComponent, selector: "c8y-typeahead", inputs: ["required", "maxlength", "disabled", "allowFreeEntries", "placeholder", "displayProperty", "icon", "name", "autoClose", "hideNew", "container", "selected"], outputs: ["onSearch", "onIconClick"] }, { kind: "directive", type: i15.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i15.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i15.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i15.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }, { kind: "directive", type: i15.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "directive", type: i15.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "component", type: i16.FormGroupComponent, selector: "c8y-form-group", inputs: ["hasError", "hasWarning", "hasSuccess", "novalidation", "status"] }, { kind: "directive", type: i17.MessageDirective, selector: "c8y-message", inputs: ["name", "text"] }, { kind: "component", type: i18.MessagesComponent, selector: "c8y-messages", inputs: ["show", "defaults"] }, { kind: "component", type: i19.ListItemComponent, selector: "c8y-list-item, c8y-li", inputs: ["active", "emptyActions", "collapsed", "selectable"], outputs: ["collapsedChange"] }, { kind: "component", type: i20.FormlyForm, selector: "formly-form", inputs: ["form", "model", "fields", "options"], outputs: ["modelChange"] }, { kind: "pipe", type: i21.C8yTranslatePipe, name: "translate" }, { kind: "pipe", type: i10.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ProviderConfigurationComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-sms-gateway', providers: [ProviderConfigurationService, ProviderDefinitionsService], template: "<c8y-title>\n  {{ (layout$ | async)?.pageTitle | translate }}\n</c8y-title>\n\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item\n    [label]=\"'Settings' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle !='Connectivity'\"\n    [label]=\"'SMS provider' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle =='Connectivity'\"\n    [label]=\"'Connectivity' | translate\"\n    [icon]=\"'cog'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item *ngIf=\"(layout$ | async)?.pageTitle =='Connectivity'\"\n    [icon]=\"'cog'\"\n    [label]=\"'SIM provider settings' | translate\"\n  ></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n\n<div class=\"row\">\n  <div class=\"col-md-8 col-xs-12\">\n    <form class=\"card card--fullpage\" (ngSubmit)=\"saveProviderConfiguration()\">\n      <div class=\"card-header separator\">\n        <div class=\"card-title\">\n          {{ (layout$ | async)?.cardTitle | translate }}\n        </div>\n      </div>\n      <div class=\"inner-scroll\">\n        <div class=\"card-block\">\n          <p *ngIf=\"!!(layout$ | async)?.description\" class=\"m-b-8\">\n            {{ (layout$ | async)?.description | translate }}\n          </p>\n          <c8y-form-group>\n            <label for=\"providerName\">{{ (layout$ | async)?.providerName | translate }}</label>\n            <c8y-typeahead\n              [disabled]=\"!permissions.hasAllRoles((layout$ | async)?.saveRoles || [])\"\n              [ngModel]=\"selectedProvider$ | async\"\n              [displayProperty]=\"'displayName'\"\n              name=\"providerName\"\n              placeholder=\"{{ (layout$ | async)?.providerNamePlaceholder | translate }}\"\n              (onSearch)=\"providerInput$.next($event)\"\n              [allowFreeEntries]=\"false\"\n              [required]=\"true\"\n              [container]=\"'body'\"\n            >\n              <c8y-li\n                *ngFor=\"let provider of providers$ | async\"\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"changeProvider$.next(provider); providerInput$.next('')\"\n                [active]=\"(selectedProvider$ | async) === provider\"\n                [attr.role]=\"'menuitem'\"\n              >\n                <c8y-highlight\n                  [text]=\"provider.displayName || '--'\"\n                  [pattern]=\"providerInput$ | async\"\n                ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <c8y-messages>\n              <c8y-message\n                name=\"notExisting\"\n                [text]=\"(layout$ | async)?.providerNameNoMatchesHint | translate\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n          <formly-form\n            *ngIf=\"selectedProvider$ | async\"\n            [form]=\"form\"\n            [fields]=\"fields\"\n            [model]=\"model\"\n            [options]=\"options\"\n          ></formly-form>\n        </div>\n      </div>\n      <div class=\"card-footer separator\" *c8yIfAllowed=\"allRoles$ | async; allowAny\">\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.deleteRoles\"\n          class=\"btn btn-default\"\n          type=\"button\"\n          (click)=\"deleteProviderConfiguration()\"\n          [disabled]=\"\n            !(configuration$ | async)?.provider && !(configuration$ | async)?.providerName\n          \"\n          title=\"{{ (layout$ | async)?.deleteBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.deleteBtnLabel | translate }}\n        </button>\n        <button\n          *c8yIfAllowed=\"(layout$ | async)?.saveRoles\"\n          class=\"btn btn-primary\"\n          type=\"submit\"\n          [disabled]=\"form.invalid || form.pristine\"\n          title=\"{{ (layout$ | async)?.saveBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async)?.saveBtnLabel | translate }}\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.Permissions }, { type: i2.ActivatedRoute }, { type: i3.ModalService }, { type: i4.AlertService }, { type: i5.ProviderDefinitionsService }, { type: i6.ProviderConfigurationService }, { type: i7.C8yJSONSchema }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24vcHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9jb3JlL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24vcHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFakQsT0FBTyxFQUF3QyxpQkFBaUIsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzNGLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzREFBc0QsQ0FBQztBQUNyRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFPdEQsT0FBTyxFQUFFLDRCQUE0QixF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QUMsNEJBQTRCLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLDhCQUE4QixDQUFDLENBQUM7U0FDdkU7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLElBQUksR0FBRyxFQUFFO2dCQUNQLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDekM7U0FDRjtJQUNILENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxhQUFpQztRQUM3RCxPQUFPLFNBQVMsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxlQUFlLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUM1RixDQUFDOzsySEE5S1UsOEJBQThCOytHQUE5Qiw4QkFBOEIsMENBRjlCLENBQUMsNEJBQTRCLEVBQUUsMEJBQTBCLENBQUMsMEJDeEJ2RSwrK0hBd0dBOzJGRDlFYSw4QkFBOEI7a0JBTDFDLFNBQVM7K0JBQ0UsaUJBQWlCLGFBRWhCLENBQUMsNEJBQTRCLEVBQUUsMEJBQTBCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IElSZXN1bHQgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZywgRm9ybWx5Rm9ybU9wdGlvbnMsIMm1ZGVmaW5lSGlkZGVuUHJvcCB9IGZyb20gJ0BuZ3gtZm9ybWx5L2NvcmUnO1xuaW1wb3J0IHsgZmluZCwgZm9yT3duLCBnZXQsIG1hcFZhbHVlcywgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIGZyb20sIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi9hbGVydC9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBTdGF0dXMgfSBmcm9tICcuLi9jb21tb24vaW5kZXgnO1xuaW1wb3J0IHsgQzh5SlNPTlNjaGVtYSB9IGZyb20gJy4uL2R5bmFtaWMtZm9ybXMvanNvbi1zY2hlbWEvYzh5LWpzb24tc2NoZW1hLnNlcnZpY2UnO1xuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kYWwvbW9kYWwuc2VydmljZSc7XG5pbXBvcnQge1xuICBEeW5hbWljUHJvdmlkZXJDb25maWcsXG4gIER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZ1xufSBmcm9tICcuL21vZGVsL2R5bmFtaWMtcHJvdmlkZXItY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IFByb3ZpZGVyRGVmaW5pdGlvbiB9IGZyb20gJy4vbW9kZWwvcHJvdmlkZXItZGVmaW5pdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBQcm92aWRlclByb3BlcnRpZXMgfSBmcm9tICcuL21vZGVsL3Byb3ZpZGVyLXByb3BlcnRpZXMubW9kZWwnO1xuaW1wb3J0IHsgUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vc2VydmljZS9wcm92aWRlci1jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvcHJvdmlkZXItZGVmaW5pdGlvbnMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zbXMtZ2F0ZXdheScsXG4gIHRlbXBsYXRlVXJsOiAnLi9wcm92aWRlci1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSwgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIFByb3ZpZGVyQ29uZmlndXJhdGlvbkNvbXBvbmVudCB7XG4gIGxheW91dCQ6IE9ic2VydmFibGU8RHluYW1pY1Byb3ZpZGVyTGF5b3V0Q29uZmlnPiA9IHRoaXMuYWN0aXZhdGVkUm91dGUuZGF0YS5waXBlKFxuICAgIG1hcCgoY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWcpID0+IGNvbmZpZy5sYXlvdXQpLFxuICAgIHRhcCgobGF5b3V0OiBEeW5hbWljUHJvdmlkZXJMYXlvdXRDb25maWcpID0+ICh0aGlzLmxheW91dCA9IGxheW91dCkpLFxuICAgIHRhcCgobGF5b3V0OiBEeW5hbWljUHJvdmlkZXJMYXlvdXRDb25maWcpID0+IHtcbiAgICAgIHRoaXMub3B0aW9ucy5mb3JtU3RhdGUuZGlzYWJsZWQgPSAhdGhpcy5wZXJtaXNzaW9ucy5oYXNBbGxSb2xlcyhsYXlvdXQuc2F2ZVJvbGVzIHx8IFtdKTtcbiAgICAgIHRoaXMuYmVmb3JlU2F2ZUhvb2sgPSBsYXlvdXQuYmVmb3JlU2F2ZUhvb2s7XG4gICAgfSlcbiAgKTtcblxuICBhbGxSb2xlcyQ6IE9ic2VydmFibGU8c3RyaW5nW10+ID0gdGhpcy5sYXlvdXQkLnBpcGUoXG4gICAgbWFwKChsYXlvdXQ6IER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZykgPT4gW1xuICAgICAgLi4uKGxheW91dC5kZWxldGVSb2xlcyB8fCBbXSksXG4gICAgICAuLi4obGF5b3V0LnNhdmVSb2xlcyB8fCBbXSlcbiAgICBdKVxuICApO1xuXG4gIHByb3ZpZGVycyQ6IE9ic2VydmFibGU8UHJvdmlkZXJEZWZpbml0aW9uW10+O1xuICBzZWxlY3RlZFByb3ZpZGVyJDogT2JzZXJ2YWJsZTxQcm92aWRlckRlZmluaXRpb24+O1xuICBjaGFuZ2VQcm92aWRlciQ6IFN1YmplY3Q8UHJvdmlkZXJEZWZpbml0aW9uPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIGNvbmZpZ3VyYXRpb24kOiBPYnNlcnZhYmxlPFByb3ZpZGVyUHJvcGVydGllcz47XG4gIHByb3ZpZGVySW5wdXQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+KCcnKTtcblxuICBmb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gIG1vZGVsOiBQcm92aWRlclByb3BlcnRpZXM7XG4gIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdO1xuICBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucyA9IHtcbiAgICBmb3JtU3RhdGU6IHtcbiAgICAgIGRpc2FibGVkOiBmYWxzZVxuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIHJlbG9hZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHZvaWQ+KG51bGwpO1xuICBwcml2YXRlIHVwZGF0ZWRDb25maWd1cmF0aW9uJCA9IG5ldyBTdWJqZWN0PFByb3ZpZGVyUHJvcGVydGllcz4oKTtcbiAgcHJpdmF0ZSBsYXlvdXQ6IER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZztcbiAgcHJpdmF0ZSBiZWZvcmVTYXZlSG9vazogKFxuICAgIG1vZGVsOiBQcm92aWRlclByb3BlcnRpZXMsXG4gICAgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdXG4gICkgPT4gUHJvbWlzZTxQcm92aWRlclByb3BlcnRpZXM+IHwgUHJvdmlkZXJQcm9wZXJ0aWVzO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwZXJtaXNzaW9uczogUGVybWlzc2lvbnMsXG4gICAgcHJpdmF0ZSBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2U6IFByb3ZpZGVyRGVmaW5pdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZTogUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGpzb25zY2hlbWE6IEM4eUpTT05TY2hlbWFcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGFsbFByb3ZpZGVycyQ6IE9ic2VydmFibGU8UHJvdmlkZXJEZWZpbml0aW9uW10+ID0gZnJvbShcbiAgICAgIHRoaXMucHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UubGlzdCgpXG4gICAgKS5waXBlKFxuICAgICAgbWFwKHJlc3VsdCA9PiByZXN1bHQuZGF0YSksXG4gICAgICBzaGFyZVJlcGxheSgxKVxuICAgICk7XG5cbiAgICB0aGlzLnByb3ZpZGVycyQgPSBjb21iaW5lTGF0ZXN0KGFsbFByb3ZpZGVycyQsIHRoaXMucHJvdmlkZXJJbnB1dCQpLnBpcGUoXG4gICAgICBtYXAoKFtwcm92aWRlcnMsIGlucHV0XTogW1Byb3ZpZGVyRGVmaW5pdGlvbltdLCBzdHJpbmddKSA9PlxuICAgICAgICBpbnB1dFxuICAgICAgICAgID8gcHJvdmlkZXJzLmZpbHRlcihlbCA9PiBlbC5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoaW5wdXQudG9Mb3dlckNhc2UoKSkgPj0gMClcbiAgICAgICAgICA6IHByb3ZpZGVyc1xuICAgICAgKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcblxuICAgIHRoaXMuY29uZmlndXJhdGlvbiQgPSBtZXJnZShcbiAgICAgIHRoaXMudXBkYXRlZENvbmZpZ3VyYXRpb24kLFxuICAgICAgdGhpcy5yZWxvYWQkLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgIGZyb20odGhpcy5wcm92aWRlckNvbmZpZ3VyYXRpb25TZXJ2aWNlLmRldGFpbCgpKS5waXBlKGNhdGNoRXJyb3IoKCkgPT4gb2Yoe30gYXMgYW55KSkpXG4gICAgICAgICksXG4gICAgICAgIG1hcChyZXN1bHQgPT4gcmVzdWx0LmRhdGEpXG4gICAgICApXG4gICAgKS5waXBlKG1hcCh0aGlzLnJlbW92ZUVuY3J5cHRlZFZhbHVlcyksIHNoYXJlUmVwbGF5KDEpKTtcblxuICAgIHRoaXMuc2VsZWN0ZWRQcm92aWRlciQgPSBjb21iaW5lTGF0ZXN0KFxuICAgICAgYWxsUHJvdmlkZXJzJCxcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbiQsXG4gICAgICB0aGlzLmNoYW5nZVByb3ZpZGVyJFxuICAgICkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKFtfLCBjb25maWd1cmF0aW9uLCBuZXdQcm92aWRlcl06IFtcbiAgICAgICAgICBQcm92aWRlckRlZmluaXRpb25bXSxcbiAgICAgICAgICBQcm92aWRlclByb3BlcnRpZXMsXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uXG4gICAgICAgIF0pID0+XG4gICAgICAgICAgKHRoaXMubW9kZWwgPSBuZXdQcm92aWRlclxuICAgICAgICAgICAgPyBwaWNrKHRoaXMubW9kZWwsICdzbXMuc2VuZGVyTmFtZScsICdzbXMuc2VuZGVyQWRkcmVzcycpXG4gICAgICAgICAgICA6IGNvbmZpZ3VyYXRpb24pXG4gICAgICApLFxuICAgICAgbWFwKFxuICAgICAgICAoW3Byb3ZpZGVycywgY29uZmlndXJhdGlvbiwgbmV3UHJvdmlkZXJdOiBbXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uW10sXG4gICAgICAgICAgUHJvdmlkZXJQcm9wZXJ0aWVzLFxuICAgICAgICAgIFByb3ZpZGVyRGVmaW5pdGlvblxuICAgICAgICBdKSA9PlxuICAgICAgICAgIG5ld1Byb3ZpZGVyIHx8XG4gICAgICAgICAgZmluZChcbiAgICAgICAgICAgIHByb3ZpZGVycyxcbiAgICAgICAgICAgIChwcm92aWRlcjogUHJvdmlkZXJEZWZpbml0aW9uKSA9PiBnZXQoY29uZmlndXJhdGlvbiwgJ3Byb3ZpZGVyJykgPT09IHByb3ZpZGVyLmlkXG4gICAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRhcCgocHJvdmlkZXI6IFByb3ZpZGVyRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICBpZiAocHJvdmlkZXIpIHtcbiAgICAgICAgICBjb25zdCBjb25maWc6IEZvcm1seUZpZWxkQ29uZmlnID0gdGhpcy5qc29uc2NoZW1hLnRvRmllbGRDb25maWcoZ2V0KHByb3ZpZGVyLCAnc2NoZW1hJykpO1xuICAgICAgICAgIGlmIChjb25maWcuZmllbGRHcm91cCkge1xuICAgICAgICAgICAgY29uZmlnLmZpZWxkR3JvdXAuZm9yRWFjaCgoZmllbGRDb25maWc6IEZvcm1seUZpZWxkQ29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgIMm1ZGVmaW5lSGlkZGVuUHJvcChmaWVsZENvbmZpZywgJ19rZXlQYXRoJywge1xuICAgICAgICAgICAgICAgIGtleTogZmllbGRDb25maWcua2V5LFxuICAgICAgICAgICAgICAgIHBhdGg6IFtmaWVsZENvbmZpZy5rZXldXG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIGZpZWxkQ29uZmlnLmV4cHJlc3Npb25Qcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgICAgICd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnOiAnZm9ybVN0YXRlLmRpc2FibGVkJ1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuZmllbGRzID0gW2NvbmZpZ107XG4gICAgICAgICAgdGhpcy5mb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVByb3ZpZGVyQ29uZmlndXJhdGlvbigpIHtcbiAgICBjb25zdCBtb2RlbFRvU2F2ZTogUHJvdmlkZXJQcm9wZXJ0aWVzID0gISF0aGlzLmJlZm9yZVNhdmVIb29rXG4gICAgICA/IGF3YWl0IHRoaXMuYmVmb3JlU2F2ZUhvb2sodGhpcy5tb2RlbCwgdGhpcy5maWVsZHMpXG4gICAgICA6IHRoaXMubW9kZWw7XG5cbiAgICBmb3JPd24obW9kZWxUb1NhdmUsICh2YWx1ZTogYW55LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIG1vZGVsVG9TYXZlW2tleV0gPSB2YWx1ZS5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0gfHwgaXRlbSA9PT0gMCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzOiBJUmVzdWx0PFByb3ZpZGVyUHJvcGVydGllcz4gPSBhd2FpdCB0aGlzLnByb3ZpZGVyQ29uZmlndXJhdGlvblNlcnZpY2UudXBkYXRlKFxuICAgICAgICBtb2RlbFRvU2F2ZVxuICAgICAgKTtcbiAgICAgIHRoaXMuY2hhbmdlUHJvdmlkZXIkLm5leHQobnVsbCk7XG4gICAgICB0aGlzLnVwZGF0ZWRDb25maWd1cmF0aW9uJC5uZXh0KHJlcy5kYXRhKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYXlvdXQuY29uZmlndXJhdGlvblVwZGF0ZWRTdWNjZXNzTXNnKTtcbiAgICAgIHRoaXMuZm9ybS5tYXJrQXNQcmlzdGluZSgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVByb3ZpZGVyQ29uZmlndXJhdGlvbigpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5tb2RhbFNlcnZpY2UuY29uZmlybShcbiAgICAgICAgdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsVGl0bGUsXG4gICAgICAgIHRoaXMubGF5b3V0LmRlbGV0ZUNvbmZpZ3VyYXRpb25Nb2RhbEJvZHksXG4gICAgICAgIFN0YXR1cy5EQU5HRVIsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsT2tCdG5MYWJlbCxcbiAgICAgICAgICBjYW5jZWw6IHRoaXMubGF5b3V0LmRlbGV0ZUNvbmZpZ3VyYXRpb25Nb2RhbENhbmNlbEJ0bkxhYmVsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyQ29uZmlndXJhdGlvblNlcnZpY2UuZGVsZXRlKCk7XG4gICAgICB0aGlzLnJlbG9hZCQubmV4dCgpO1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxheW91dC5jb25maWd1cmF0aW9uRGVsZXRlZFN1Y2Nlc3NNc2cpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFbmNyeXB0ZWRWYWx1ZXMoY29uZmlndXJhdGlvbjogUHJvdmlkZXJQcm9wZXJ0aWVzKTogUHJvdmlkZXJQcm9wZXJ0aWVzIHtcbiAgICByZXR1cm4gbWFwVmFsdWVzKGNvbmZpZ3VyYXRpb24sIHZhbHVlID0+ICh2YWx1ZSA9PT0gJzw8RW5jcnlwdGVkPj4nID8gdW5kZWZpbmVkIDogdmFsdWUpKTtcbiAgfVxufVxuIiwiPGM4eS10aXRsZT5cbiAge3sgKGxheW91dCQgfCBhc3luYyk/LnBhZ2VUaXRsZSB8IHRyYW5zbGF0ZSB9fVxuPC9jOHktdGl0bGU+XG5cbjxjOHktYnJlYWRjcnVtYj5cbiAgPGM4eS1icmVhZGNydW1iLWl0ZW1cbiAgICBbbGFiZWxdPVwiJ1NldHRpbmdzJyB8IHRyYW5zbGF0ZVwiXG4gICAgW2ljb25dPVwiJ2NvZydcIlxuICA+PC9jOHktYnJlYWRjcnVtYi1pdGVtPlxuICA8Yzh5LWJyZWFkY3J1bWItaXRlbSAqbmdJZj1cIihsYXlvdXQkIHwgYXN5bmMpPy5wYWdlVGl0bGUgIT0nQ29ubmVjdGl2aXR5J1wiXG4gICAgW2xhYmVsXT1cIidTTVMgcHJvdmlkZXInIHwgdHJhbnNsYXRlXCJcbiAgICBbaWNvbl09XCInY29nJ1wiXG4gID48L2M4eS1icmVhZGNydW1iLWl0ZW0+XG4gIDxjOHktYnJlYWRjcnVtYi1pdGVtICpuZ0lmPVwiKGxheW91dCQgfCBhc3luYyk/LnBhZ2VUaXRsZSA9PSdDb25uZWN0aXZpdHknXCJcbiAgICBbbGFiZWxdPVwiJ0Nvbm5lY3Rpdml0eScgfCB0cmFuc2xhdGVcIlxuICAgIFtpY29uXT1cIidjb2cnXCJcbiAgPjwvYzh5LWJyZWFkY3J1bWItaXRlbT5cbiAgPGM4eS1icmVhZGNydW1iLWl0ZW0gKm5nSWY9XCIobGF5b3V0JCB8IGFzeW5jKT8ucGFnZVRpdGxlID09J0Nvbm5lY3Rpdml0eSdcIlxuICAgIFtpY29uXT1cIidjb2cnXCJcbiAgICBbbGFiZWxdPVwiJ1NJTSBwcm92aWRlciBzZXR0aW5ncycgfCB0cmFuc2xhdGVcIlxuICA+PC9jOHktYnJlYWRjcnVtYi1pdGVtPlxuPC9jOHktYnJlYWRjcnVtYj5cblxuPGRpdiBjbGFzcz1cInJvd1wiPlxuICA8ZGl2IGNsYXNzPVwiY29sLW1kLTggY29sLXhzLTEyXCI+XG4gICAgPGZvcm0gY2xhc3M9XCJjYXJkIGNhcmQtLWZ1bGxwYWdlXCIgKG5nU3VibWl0KT1cInNhdmVQcm92aWRlckNvbmZpZ3VyYXRpb24oKVwiPlxuICAgICAgPGRpdiBjbGFzcz1cImNhcmQtaGVhZGVyIHNlcGFyYXRvclwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY2FyZC10aXRsZVwiPlxuICAgICAgICAgIHt7IChsYXlvdXQkIHwgYXN5bmMpPy5jYXJkVGl0bGUgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxkaXYgY2xhc3M9XCJpbm5lci1zY3JvbGxcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImNhcmQtYmxvY2tcIj5cbiAgICAgICAgICA8cCAqbmdJZj1cIiEhKGxheW91dCQgfCBhc3luYyk/LmRlc2NyaXB0aW9uXCIgY2xhc3M9XCJtLWItOFwiPlxuICAgICAgICAgICAge3sgKGxheW91dCQgfCBhc3luYyk/LmRlc2NyaXB0aW9uIHwgdHJhbnNsYXRlIH19XG4gICAgICAgICAgPC9wPlxuICAgICAgICAgIDxjOHktZm9ybS1ncm91cD5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJwcm92aWRlck5hbWVcIj57eyAobGF5b3V0JCB8IGFzeW5jKT8ucHJvdmlkZXJOYW1lIHwgdHJhbnNsYXRlIH19PC9sYWJlbD5cbiAgICAgICAgICAgIDxjOHktdHlwZWFoZWFkXG4gICAgICAgICAgICAgIFtkaXNhYmxlZF09XCIhcGVybWlzc2lvbnMuaGFzQWxsUm9sZXMoKGxheW91dCQgfCBhc3luYyk/LnNhdmVSb2xlcyB8fCBbXSlcIlxuICAgICAgICAgICAgICBbbmdNb2RlbF09XCJzZWxlY3RlZFByb3ZpZGVyJCB8IGFzeW5jXCJcbiAgICAgICAgICAgICAgW2Rpc3BsYXlQcm9wZXJ0eV09XCInZGlzcGxheU5hbWUnXCJcbiAgICAgICAgICAgICAgbmFtZT1cInByb3ZpZGVyTmFtZVwiXG4gICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwie3sgKGxheW91dCQgfCBhc3luYyk/LnByb3ZpZGVyTmFtZVBsYWNlaG9sZGVyIHwgdHJhbnNsYXRlIH19XCJcbiAgICAgICAgICAgICAgKG9uU2VhcmNoKT1cInByb3ZpZGVySW5wdXQkLm5leHQoJGV2ZW50KVwiXG4gICAgICAgICAgICAgIFthbGxvd0ZyZWVFbnRyaWVzXT1cImZhbHNlXCJcbiAgICAgICAgICAgICAgW3JlcXVpcmVkXT1cInRydWVcIlxuICAgICAgICAgICAgICBbY29udGFpbmVyXT1cIidib2R5J1wiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxjOHktbGlcbiAgICAgICAgICAgICAgICAqbmdGb3I9XCJsZXQgcHJvdmlkZXIgb2YgcHJvdmlkZXJzJCB8IGFzeW5jXCJcbiAgICAgICAgICAgICAgICBjbGFzcz1cInAtbC04IHAtci04IGM4eS1saXN0X19pdGVtLS1saW5rXCJcbiAgICAgICAgICAgICAgICAoY2xpY2spPVwiY2hhbmdlUHJvdmlkZXIkLm5leHQocHJvdmlkZXIpOyBwcm92aWRlcklucHV0JC5uZXh0KCcnKVwiXG4gICAgICAgICAgICAgICAgW2FjdGl2ZV09XCIoc2VsZWN0ZWRQcm92aWRlciQgfCBhc3luYykgPT09IHByb3ZpZGVyXCJcbiAgICAgICAgICAgICAgICBbYXR0ci5yb2xlXT1cIidtZW51aXRlbSdcIlxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGM4eS1oaWdobGlnaHRcbiAgICAgICAgICAgICAgICAgIFt0ZXh0XT1cInByb3ZpZGVyLmRpc3BsYXlOYW1lIHx8ICctLSdcIlxuICAgICAgICAgICAgICAgICAgW3BhdHRlcm5dPVwicHJvdmlkZXJJbnB1dCQgfCBhc3luY1wiXG4gICAgICAgICAgICAgICAgPjwvYzh5LWhpZ2hsaWdodD5cbiAgICAgICAgICAgICAgPC9jOHktbGk+XG4gICAgICAgICAgICA8L2M4eS10eXBlYWhlYWQ+XG4gICAgICAgICAgICA8Yzh5LW1lc3NhZ2VzPlxuICAgICAgICAgICAgICA8Yzh5LW1lc3NhZ2VcbiAgICAgICAgICAgICAgICBuYW1lPVwibm90RXhpc3RpbmdcIlxuICAgICAgICAgICAgICAgIFt0ZXh0XT1cIihsYXlvdXQkIHwgYXN5bmMpPy5wcm92aWRlck5hbWVOb01hdGNoZXNIaW50IHwgdHJhbnNsYXRlXCJcbiAgICAgICAgICAgICAgPjwvYzh5LW1lc3NhZ2U+XG4gICAgICAgICAgICA8L2M4eS1tZXNzYWdlcz5cbiAgICAgICAgICA8L2M4eS1mb3JtLWdyb3VwPlxuICAgICAgICAgIDxmb3JtbHktZm9ybVxuICAgICAgICAgICAgKm5nSWY9XCJzZWxlY3RlZFByb3ZpZGVyJCB8IGFzeW5jXCJcbiAgICAgICAgICAgIFtmb3JtXT1cImZvcm1cIlxuICAgICAgICAgICAgW2ZpZWxkc109XCJmaWVsZHNcIlxuICAgICAgICAgICAgW21vZGVsXT1cIm1vZGVsXCJcbiAgICAgICAgICAgIFtvcHRpb25zXT1cIm9wdGlvbnNcIlxuICAgICAgICAgID48L2Zvcm1seS1mb3JtPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdiBjbGFzcz1cImNhcmQtZm9vdGVyIHNlcGFyYXRvclwiICpjOHlJZkFsbG93ZWQ9XCJhbGxSb2xlcyQgfCBhc3luYzsgYWxsb3dBbnlcIj5cbiAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICpjOHlJZkFsbG93ZWQ9XCIobGF5b3V0JCB8IGFzeW5jKT8uZGVsZXRlUm9sZXNcIlxuICAgICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1kZWZhdWx0XCJcbiAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAoY2xpY2spPVwiZGVsZXRlUHJvdmlkZXJDb25maWd1cmF0aW9uKClcIlxuICAgICAgICAgIFtkaXNhYmxlZF09XCJcbiAgICAgICAgICAgICEoY29uZmlndXJhdGlvbiQgfCBhc3luYyk/LnByb3ZpZGVyICYmICEoY29uZmlndXJhdGlvbiQgfCBhc3luYyk/LnByb3ZpZGVyTmFtZVxuICAgICAgICAgIFwiXG4gICAgICAgICAgdGl0bGU9XCJ7eyAobGF5b3V0JCB8IGFzeW5jKT8uZGVsZXRlQnRuTGFiZWwgfCB0cmFuc2xhdGUgfX1cIlxuICAgICAgICA+XG4gICAgICAgICAge3sgKGxheW91dCQgfCBhc3luYyk/LmRlbGV0ZUJ0bkxhYmVsIHwgdHJhbnNsYXRlIH19XG4gICAgICAgIDwvYnV0dG9uPlxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgKmM4eUlmQWxsb3dlZD1cIihsYXlvdXQkIHwgYXN5bmMpPy5zYXZlUm9sZXNcIlxuICAgICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1wcmltYXJ5XCJcbiAgICAgICAgICB0eXBlPVwic3VibWl0XCJcbiAgICAgICAgICBbZGlzYWJsZWRdPVwiZm9ybS5pbnZhbGlkIHx8IGZvcm0ucHJpc3RpbmVcIlxuICAgICAgICAgIHRpdGxlPVwie3sgKGxheW91dCQgfCBhc3luYyk/LnNhdmVCdG5MYWJlbCB8IHRyYW5zbGF0ZSB9fVwiXG4gICAgICAgID5cbiAgICAgICAgICB7eyAobGF5b3V0JCB8IGFzeW5jKT8uc2F2ZUJ0bkxhYmVsIHwgdHJhbnNsYXRlIH19XG4gICAgICAgIDwvYnV0dG9uPlxuICAgICAgPC9kaXY+XG4gICAgPC9mb3JtPlxuICA8L2Rpdj5cbjwvZGl2PlxuIl19