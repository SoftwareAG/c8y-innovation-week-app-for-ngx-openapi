import { Injectable } from '@angular/core';
import { map, take } from 'rxjs/operators';
import { groupBy } from 'lodash-es';
import { VersionService } from './version.service';
import { AppStateService } from '../common/ui-state.service';
import { ApplicationService, ApplicationType } from '@c8y/client';
import * as i0 from "@angular/core";
import * as i1 from "./version.service";
import * as i2 from "../common/ui-state.service";
import * as i3 from "@c8y/client";
export class PlatformDetailsService {
    constructor(version, appState, apps) {
        this.version = version;
        this.appState = appState;
        this.apps = apps;
    }
    async getPlatformDetailsObject() {
        const currentUser = this.appState.currentUser.value;
        const userId = currentUser?.id;
        const userPermissions = this.getUserPermissions(currentUser);
        const [hookedVersions, microserviceVersions] = await Promise.all([
            this.getVersions(),
            this.getMicroserviceVersions(userId)
        ]);
        const versions = [...hookedVersions, ...microserviceVersions];
        const groupedVersions = groupBy(versions, 'type');
        const tenantId = this.appState.currentTenant.value?.name;
        const tenantDomainName = this.appState.currentTenant.value?.domainName;
        const applicationKey = this.appState.currentApplication.value?.key;
        const applicationId = this.appState.currentApplication.value?.id;
        const time = new Date().toISOString();
        const url = document.URL;
        const obj = {
            time,
            tenantId,
            tenantDomainName,
            url,
            userId,
            userPermissions,
            applicationId,
            applicationKey,
            versions: groupedVersions
        };
        return obj;
    }
    async getVersions() {
        const versions = await this.version.items$
            .pipe(take(1), map(versions => this.version.cleanUpVersions(versions)))
            .toPromise();
        return versions;
    }
    async getMicroserviceVersions(userId) {
        try {
            const { data: apps } = await this.apps.listByUser(userId, {
                pageSize: 2000,
                dropOverwrittenApps: true,
                noPaging: true
            });
            return apps
                .filter(app => !!app.manifest?.version && app.type === ApplicationType.MICROSERVICE)
                .map(app => {
                return {
                    label: app.name,
                    version: app.manifest.version,
                    type: app.type,
                    custom: {
                        owner: app.owner?.tenant?.id,
                        provider: app.manifest?.provider
                    }
                };
            });
        }
        catch (e) {
            console.warn(e);
            return [];
        }
    }
    getUserPermissions(user) {
        if (!user) {
            return null;
        }
        const userPermissions = this.getDirectPermissionsOfUser(user);
        const groupPermissions = this.getPermissionsOfAssignedGroups(user);
        return { user: userPermissions, groups: groupPermissions };
    }
    getDirectPermissionsOfUser(user) {
        const userChangedType = user;
        const userRoleReferences = userChangedType.roles?.references || [];
        return userRoleReferences.map(ref => ref.role.id);
    }
    getPermissionsOfAssignedGroups(user) {
        const groups = user.groups?.references || [];
        return groups.map(ref => {
            const roleReferences = ref.group?.roles?.references || [];
            const permissions = roleReferences.map(ref => ref.role.id);
            return {
                id: ref.group.id,
                name: ref.group.name,
                permissions
            };
        });
    }
}
PlatformDetailsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PlatformDetailsService, deps: [{ token: i1.VersionService }, { token: i2.AppStateService }, { token: i3.ApplicationService }], target: i0.ɵɵFactoryTarget.Injectable });
PlatformDetailsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PlatformDetailsService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: PlatformDetailsService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.VersionService }, { type: i2.AppStateService }, { type: i3.ApplicationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0tZGV0YWlscy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS92ZXJzaW9uL3BsYXRmb3JtLWRldGFpbHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTdELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxlQUFlLEVBQXVCLE1BQU0sYUFBYSxDQUFDOzs7OztBQUd2RixNQUFNLE9BQU8sc0JBQXNCO0lBQ2pDLFlBQ1UsT0FBdUIsRUFDdkIsUUFBeUIsRUFDekIsSUFBd0I7UUFGeEIsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDdkIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIsU0FBSSxHQUFKLElBQUksQ0FBb0I7SUFDL0IsQ0FBQztJQUVKLEtBQUssQ0FBQyx3QkFBd0I7UUFDNUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBQ3BELE1BQU0sTUFBTSxHQUFHLFdBQVcsRUFBRSxFQUFFLENBQUM7UUFDL0IsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdELE1BQU0sQ0FBQyxjQUFjLEVBQUUsb0JBQW9CLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDL0QsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxD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ZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGdyb3VwQnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgVmVyc2lvblNlcnZpY2UgfSBmcm9tICcuL3ZlcnNpb24uc2VydmljZSc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBDbGVhbmVkVmVyc2lvbiB9IGZyb20gJy4vdmVyc2lvbi5tb2RlbCc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIEFwcGxpY2F0aW9uVHlwZSwgSUN1cnJlbnRVc2VyLCBJVXNlciB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBQbGF0Zm9ybURldGFpbHNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2ZXJzaW9uOiBWZXJzaW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBzOiBBcHBsaWNhdGlvblNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIGdldFBsYXRmb3JtRGV0YWlsc09iamVjdCgpIHtcbiAgICBjb25zdCBjdXJyZW50VXNlciA9IHRoaXMuYXBwU3RhdGUuY3VycmVudFVzZXIudmFsdWU7XG4gICAgY29uc3QgdXNlcklkID0gY3VycmVudFVzZXI/LmlkO1xuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IHRoaXMuZ2V0VXNlclBlcm1pc3Npb25zKGN1cnJlbnRVc2VyKTtcbiAgICBjb25zdCBbaG9va2VkVmVyc2lvbnMsIG1pY3Jvc2VydmljZVZlcnNpb25zXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMuZ2V0VmVyc2lvbnMoKSxcbiAgICAgIHRoaXMuZ2V0TWljcm9zZXJ2aWNlVmVyc2lvbnModXNlcklkKVxuICAgIF0pO1xuICAgIGNvbnN0IHZlcnNpb25zID0gWy4uLmhvb2tlZFZlcnNpb25zLCAuLi5taWNyb3NlcnZpY2VWZXJzaW9uc107XG4gICAgY29uc3QgZ3JvdXBlZFZlcnNpb25zOiB7IFtrZXk6IHN0cmluZ106IENsZWFuZWRWZXJzaW9uW10gfSA9IGdyb3VwQnkodmVyc2lvbnMsICd0eXBlJyk7XG4gICAgY29uc3QgdGVuYW50SWQgPSB0aGlzLmFwcFN0YXRlLmN1cnJlbnRUZW5hbnQudmFsdWU/Lm5hbWU7XG4gICAgY29uc3QgdGVuYW50RG9tYWluTmFtZSA9IHRoaXMuYXBwU3RhdGUuY3VycmVudFRlbmFudC52YWx1ZT8uZG9tYWluTmFtZTtcbiAgICBjb25zdCBhcHBsaWNhdGlvbktleSA9IHRoaXMuYXBwU3RhdGUuY3VycmVudEFwcGxpY2F0aW9uLnZhbHVlPy5rZXk7XG4gICAgY29uc3QgYXBwbGljYXRpb25JZCA9IHRoaXMuYXBwU3RhdGUuY3VycmVudEFwcGxpY2F0aW9uLnZhbHVlPy5pZDtcbiAgICBjb25zdCB0aW1lID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIGNvbnN0IHVybCA9IGRvY3VtZW50LlVSTDtcbiAgICBjb25zdCBvYmogPSB7XG4gICAgICB0aW1lLFxuICAgICAgdGVuYW50SWQsXG4gICAgICB0ZW5hbnREb21haW5OYW1lLFxuICAgICAgdXJsLFxuICAgICAgdXNlcklkLFxuICAgICAgdXNlclBlcm1pc3Npb25zLFxuICAgICAgYXBwbGljYXRpb25JZCxcbiAgICAgIGFwcGxpY2F0aW9uS2V5LFxuICAgICAgdmVyc2lvbnM6IGdyb3VwZWRWZXJzaW9uc1xuICAgIH07XG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBnZXRWZXJzaW9ucygpOiBQcm9taXNlPENsZWFuZWRWZXJzaW9uW10+IHtcbiAgICBjb25zdCB2ZXJzaW9ucyA9IGF3YWl0IHRoaXMudmVyc2lvbi5pdGVtcyRcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlKDEpLFxuICAgICAgICBtYXAodmVyc2lvbnMgPT4gdGhpcy52ZXJzaW9uLmNsZWFuVXBWZXJzaW9ucyh2ZXJzaW9ucykpXG4gICAgICApXG4gICAgICAudG9Qcm9taXNlKCk7XG4gICAgcmV0dXJuIHZlcnNpb25zO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIGdldE1pY3Jvc2VydmljZVZlcnNpb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDbGVhbmVkVmVyc2lvbltdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YTogYXBwcyB9ID0gYXdhaXQgdGhpcy5hcHBzLmxpc3RCeVVzZXIodXNlcklkLCB7XG4gICAgICAgIHBhZ2VTaXplOiAyMDAwLFxuICAgICAgICBkcm9wT3ZlcndyaXR0ZW5BcHBzOiB0cnVlLFxuICAgICAgICBub1BhZ2luZzogdHJ1ZVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gYXBwc1xuICAgICAgICAuZmlsdGVyKGFwcCA9PiAhIWFwcC5tYW5pZmVzdD8udmVyc2lvbiAmJiBhcHAudHlwZSA9PT0gQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRSlcbiAgICAgICAgLm1hcChhcHAgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBsYWJlbDogYXBwLm5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uOiBhcHAubWFuaWZlc3QudmVyc2lvbixcbiAgICAgICAgICAgIHR5cGU6IGFwcC50eXBlLFxuICAgICAgICAgICAgY3VzdG9tOiB7XG4gICAgICAgICAgICAgIG93bmVyOiBhcHAub3duZXI/LnRlbmFudD8uaWQsXG4gICAgICAgICAgICAgIHByb3ZpZGVyOiBhcHAubWFuaWZlc3Q/LnByb3ZpZGVyXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRVc2VyUGVybWlzc2lvbnModXNlcjogSUN1cnJlbnRVc2VyIHwgbnVsbCkge1xuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IHRoaXMuZ2V0RGlyZWN0UGVybWlzc2lvbnNPZlVzZXIodXNlcik7XG4gICAgY29uc3QgZ3JvdXBQZXJtaXNzaW9ucyA9IHRoaXMuZ2V0UGVybWlzc2lvbnNPZkFzc2lnbmVkR3JvdXBzKHVzZXIpO1xuICAgIHJldHVybiB7IHVzZXI6IHVzZXJQZXJtaXNzaW9ucywgZ3JvdXBzOiBncm91cFBlcm1pc3Npb25zIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0RGlyZWN0UGVybWlzc2lvbnNPZlVzZXIodXNlcjogSUN1cnJlbnRVc2VyKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHVzZXJDaGFuZ2VkVHlwZSA9IHVzZXIgYXMgSVVzZXI7XG4gICAgY29uc3QgdXNlclJvbGVSZWZlcmVuY2VzID0gdXNlckNoYW5nZWRUeXBlLnJvbGVzPy5yZWZlcmVuY2VzIHx8IFtdO1xuICAgIHJldHVybiB1c2VyUm9sZVJlZmVyZW5jZXMubWFwKHJlZiA9PiByZWYucm9sZS5pZCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0UGVybWlzc2lvbnNPZkFzc2lnbmVkR3JvdXBzKFxuICAgIHVzZXI6IElDdXJyZW50VXNlclxuICApOiB7IGlkOiBzdHJpbmc7IG5hbWU6IHN0cmluZzsgcGVybWlzc2lvbnM6IHN0cmluZ1tdIH1bXSB7XG4gICAgY29uc3QgZ3JvdXBzOiBBcnJheTxhbnk+ID0gKHVzZXIgYXMgYW55KS5ncm91cHM/LnJlZmVyZW5jZXMgfHwgW107XG5cbiAgICByZXR1cm4gZ3JvdXBzLm1hcChyZWYgPT4ge1xuICAgICAgY29uc3Qgcm9sZVJlZmVyZW5jZXM6IEFycmF5PGFueT4gPSByZWYuZ3JvdXA/LnJvbGVzPy5yZWZlcmVuY2VzIHx8IFtdO1xuICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSByb2xlUmVmZXJlbmNlcy5tYXAocmVmID0+IHJlZi5yb2xlLmlkKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiByZWYuZ3JvdXAuaWQsXG4gICAgICAgIG5hbWU6IHJlZi5ncm91cC5uYW1lLFxuICAgICAgICBwZXJtaXNzaW9uc1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxufVxuIl19