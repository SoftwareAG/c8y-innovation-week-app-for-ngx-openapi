import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { DeviceRegistrationService, DeviceRegistrationStatus } from '@c8y/client';
import { get, pick } from 'lodash-es';
import { BehaviorSubject, forkJoin, from, Subject } from 'rxjs';
import { AlertService, gettext } from '@c8y/ngx-components';
import { finalize, map, mergeMap, takeLast, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@c8y/client";
import * as i3 from "@c8y/ngx-components";
export class RegisterDeviceService {
    constructor(router, deviceRegService, alertService) {
        this.router = router;
        this.deviceRegService = deviceRegService;
        this.alertService = alertService;
        this._loading = new Subject();
        this._limit = new BehaviorSubject({
            isReached: false
        });
        this._deviceRegistrationRequests = new BehaviorSubject({ data: [] });
        this.deviceRegistrationRequests$ = this._deviceRegistrationRequests.asObservable();
        this.loading$ = this._loading.asObservable();
        this.limit$ = this._limit.asObservable();
        this.deviceRegUrl = '/deviceregistration';
        this.endSubscriptions = new Subject();
    }
    isDeviceRegistration() {
        return get(this.router, 'url') === this.deviceRegUrl;
    }
    internalListUpdate(deviceRequests, pagingObject) {
        let { paging, data } = this._deviceRegistrationRequests.getValue();
        if (pagingObject) {
            paging = pagingObject;
        }
        data = [...data, ...deviceRequests];
        this._deviceRegistrationRequests.next({ data, paging });
    }
    onDeviceBootstrap(bsData) {
        const { id, status } = bsData;
        this._deviceRegistrationRequests.next({
            data: this.updateStatusById(id, status)
        });
    }
    list(pageSize = 100) {
        this._loading.next(true);
        this._deviceRegistrationRequests.next({ data: [], paging: undefined });
        from(this.deviceRegService.list({ pageSize, withTotalPages: true }))
            .pipe(takeUntil(this.endSubscriptions), finalize(() => this.limit()))
            .subscribe(res => {
            const { data, paging } = res;
            this.internalListUpdate(data, paging);
            this._loading.next(false);
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    createMultiple(newDeviceRequests) {
        if (newDeviceRequests && newDeviceRequests.length > 0) {
            this._loading.next(true);
            const newRequests$ = newDeviceRequests.map(element => {
                return from(this.deviceRegService.create(element).catch((err) => ({
                    res: err.res,
                    data: { ...err.data, id: element.id }
                })));
            });
            const groupedRequests = {
                success: [],
                failed: []
            };
            return forkJoin(newRequests$).pipe(mergeMap(resp => resp.map(el => {
                el.res.ok
                    ? groupedRequests.success.push(el.data)
                    : groupedRequests.failed.push(el.data);
                return groupedRequests;
            })), takeLast(1), finalize(() => {
                this.internalListUpdate(groupedRequests.success);
                this._loading.next(false);
            }));
        }
    }
    remove(id) {
        this._loading.next(true);
        from(this.deviceRegService.delete(id))
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(() => {
            this._deviceRegistrationRequests.next({
                data: this.removeDeviceRegistrationRequestById(id)
            });
            this._loading.next(false);
            this.alertService.success(gettext('Device registration cancelled.'));
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    accept(request) {
        this._loading.next(true);
        const payload = pick(request, ['id', 'securityToken']);
        from(this.deviceRegService.accept(payload))
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(() => {
            this._deviceRegistrationRequests.next({
                data: this.updateStatusById(payload.id, DeviceRegistrationStatus.ACCEPTED)
            });
            this.limit();
            this._loading.next(false);
            this.alertService.success(gettext('Device registration accepted.'));
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    acceptAll() {
        const acceptedDeviceRequests = [];
        const failedDeviceRequests = [];
        this._loading.next(true);
        from(this.deviceRegService.acceptAll())
            .pipe(takeUntil(this.endSubscriptions), map(({ data }) => {
            data.map(deviceRegistrationRequest => {
                if (deviceRegistrationRequest.successful) {
                    acceptedDeviceRequests.push(deviceRegistrationRequest);
                    this.updateStatusById(deviceRegistrationRequest.id, DeviceRegistrationStatus.ACCEPTED);
                }
                else {
                    failedDeviceRequests.push(deviceRegistrationRequest);
                }
            });
            return data;
        }), finalize(() => {
            // update rendered list with successful accepted device registrations
            // see: this.updateStatusById(...)
            this.internalListUpdate([]);
            this.limit();
            this._loading.next(false);
            if (failedDeviceRequests.length > 0) {
                this.alertService.warning(gettext('Could not accept all pending registration requests.'), JSON.stringify({
                    failedDeviceRequests,
                    acceptedDeviceRequests
                }, undefined, 2));
            }
            else {
                this.alertService.success(gettext('Accepted all pending registration requests.'));
            }
        }))
            .subscribe(() => {
            // empty by design
        }, err => {
            this._loading.next(false);
            this.alertService.addServerFailure(err);
        });
    }
    limit() {
        from(this.deviceRegService.limit())
            .pipe(takeUntil(this.endSubscriptions))
            .subscribe(res => this._limit.next(res.data), err => this.alertService.addServerFailure(err));
    }
    getRequestByStatus(status) {
        return this._deviceRegistrationRequests.getValue().data.filter(req => req.status === status);
    }
    ngOnDestroy() {
        this.endSubscriptions.next();
        this.endSubscriptions.complete();
    }
    updateStatusById(id, status) {
        const items = this._deviceRegistrationRequests.getValue().data;
        const matchingElementIndex = items.findIndex(element => element.id === id);
        if (matchingElementIndex >= 0) {
            items[matchingElementIndex].status = status;
        }
        return items;
    }
    removeDeviceRegistrationRequestById(id) {
        const items = this._deviceRegistrationRequests.getValue().data;
        const matchingElementIndex = items.findIndex(element => element.id === id);
        if (matchingElementIndex >= 0) {
            items.splice(matchingElementIndex, 1);
        }
        this._loading.next(false);
        return items;
    }
}
RegisterDeviceService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: RegisterDeviceService, deps: [{ token: i1.Router }, { token: i2.DeviceRegistrationService }, { token: i3.AlertService }], target: i0.ɵɵFactoryTarget.Injectable });
RegisterDeviceService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: RegisterDeviceService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: RegisterDeviceService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.Router }, { type: i2.DeviceRegistrationService }, { type: i3.AlertService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXItZGV2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9yZWdpc3Rlci1kZXZpY2UvcmVnaXN0ZXItZGV2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUNMLHlCQUF5QixFQUN6Qix3QkFBd0IsRUFPekIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBNEIsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RixPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUs5RSxNQUFNLE9BQU8scUJBQXFCO0lBb0JoQyxZQUNVLE1BQWMsRUFDZCxnQkFBMkMsRUFDM0MsWUFBMEI7UUFGMUIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBMkI7UUFDM0MsaUJBQVksR0FBWixZQUFZLENBQWM7UUF0QjNCLGFBQVEsR0FBcUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUMzQyxXQUFNLEdBQThDLElBQUksZUFBZSxDQUFDO1lBQy9FLFNBQVMsRUFBRSxLQUFLO1NBQ2pCLENBQUMsQ0FBQztRQUNNLGdDQUEyQixHQUcvQixJQUFJLGVBQWUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzlCLGdDQUEyQixHQUcvQixJ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S0FBSyxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN2QztRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQzs7a0hBaFBVLHFCQUFxQjtzSEFBckIscUJBQXFCLGNBRnBCLE1BQU07MkZBRVAscUJBQXFCO2tCQUhqQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge1xuICBEZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLFxuICBEZXZpY2VSZWdpc3RyYXRpb25TdGF0dXMsXG4gIElEZXZpY2VSZWdpc3RyYXRpb24sXG4gIElEZXZpY2VSZWdpc3RyYXRpb25BY2NlcHQsXG4gIElEZXZpY2VSZWdpc3RyYXRpb25DcmVhdGUsXG4gIElEZXZpY2VSZWdpc3RyYXRpb25MaW1pdCxcbiAgSVJlc3VsdCxcbiAgUGFnaW5nXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldCwgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQsIElSZWFsdGltZURldmljZUJvb3RzdHJhcCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZmluYWxpemUsIG1hcCwgbWVyZ2VNYXAsIHRha2VMYXN0LCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFJlZ2lzdGVyRGV2aWNlU2VydmljZSB7XG4gIHJlYWRvbmx5IF9sb2FkaW5nOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3QoKTtcbiAgcmVhZG9ubHkgX2xpbWl0OiBCZWhhdmlvclN1YmplY3Q8SURldmljZVJlZ2lzdHJhdGlvbkxpbWl0PiA9IG5ldyBCZWhhdmlvclN1YmplY3Qoe1xuICAgIGlzUmVhY2hlZDogZmFsc2VcbiAgfSk7XG4gIHJlYWRvbmx5IF9kZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0czogQmVoYXZpb3JTdWJqZWN0PHtcbiAgICBkYXRhOiBJRGV2aWNlUmVnaXN0cmF0aW9uW107XG4gICAgcGFnaW5nPzogUGFnaW5nPElEZXZpY2VSZWdpc3RyYXRpb24+O1xuICB9PiA9IG5ldyBCZWhhdmlvclN1YmplY3QoeyBkYXRhOiBbXSB9KTtcbiAgcmVhZG9ubHkgZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMkOiBPYnNlcnZhYmxlPHtcbiAgICBkYXRhOiBJRGV2aWNlUmVnaXN0cmF0aW9uW107XG4gICAgcGFnaW5nPzogUGFnaW5nPElEZXZpY2VSZWdpc3RyYXRpb24+O1xuICB9PiA9IHRoaXMuX2RldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzLmFzT2JzZXJ2YWJsZSgpO1xuICByZWFkb25seSBsb2FkaW5nJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuX2xvYWRpbmcuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IGxpbWl0JDogT2JzZXJ2YWJsZTxJRGV2aWNlUmVnaXN0cmF0aW9uTGltaXQ+ID0gdGhpcy5fbGltaXQuYXNPYnNlcnZhYmxlKCk7XG4gIHBhZ2luZzogUGFnaW5nPElEZXZpY2VSZWdpc3RyYXRpb24+O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZGV2aWNlUmVnVXJsID0gJy9kZXZpY2VyZWdpc3RyYXRpb24nO1xuICBwcml2YXRlIGVuZFN1YnNjcmlwdGlvbnM6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBkZXZpY2VSZWdTZXJ2aWNlOiBEZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGlzRGV2aWNlUmVnaXN0cmF0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBnZXQodGhpcy5yb3V0ZXIsICd1cmwnKSA9PT0gdGhpcy5kZXZpY2VSZWdVcmw7XG4gIH1cblxuICBpbnRlcm5hbExpc3RVcGRhdGUoXG4gICAgZGV2aWNlUmVxdWVzdHM6IElEZXZpY2VSZWdpc3RyYXRpb25bXSxcbiAgICBwYWdpbmdPYmplY3Q/OiBQYWdpbmc8SURldmljZVJlZ2lzdHJhdGlvbj5cbiAgKSB7XG4gICAgbGV0IHsgcGFnaW5nLCBkYXRhIH0gPSB0aGlzLl9kZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0cy5nZXRWYWx1ZSgpO1xuICAgIGlmIChwYWdpbmdPYmplY3QpIHtcbiAgICAgIHBhZ2luZyA9IHBhZ2luZ09iamVjdDtcbiAgICB9XG4gICAgZGF0YSA9IFsuLi5kYXRhLCAuLi5kZXZpY2VSZXF1ZXN0c107XG4gICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7IGRhdGEsIHBhZ2luZyB9KTtcbiAgfVxuXG4gIG9uRGV2aWNlQm9vdHN0cmFwKGJzRGF0YTogSVJlYWx0aW1lRGV2aWNlQm9vdHN0cmFwKSB7XG4gICAgY29uc3QgeyBpZCwgc3RhdHVzIH0gPSBic0RhdGE7XG4gICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7XG4gICAgICBkYXRhOiB0aGlzLnVwZGF0ZVN0YXR1c0J5SWQoaWQsIHN0YXR1cylcbiAgICB9KTtcbiAgfVxuXG4gIGxpc3QocGFnZVNpemUgPSAxMDApIHtcbiAgICB0aGlzLl9sb2FkaW5nLm5leHQodHJ1ZSk7XG4gICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7IGRhdGE6IFtdLCBwYWdpbmc6IHVuZGVmaW5lZCB9KTtcblxuICAgIGZyb20odGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmxpc3QoeyBwYWdlU2l6ZSwgd2l0aFRvdGFsUGFnZXM6IHRydWUgfSkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucyksXG4gICAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMubGltaXQoKSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkYXRhLCBwYWdpbmcgfSA9IHJlcztcbiAgICAgICAgICB0aGlzLmludGVybmFsTGlzdFVwZGF0ZShkYXRhLCBwYWdpbmcpO1xuICAgICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBjcmVhdGVNdWx0aXBsZShuZXdEZXZpY2VSZXF1ZXN0czogSURldmljZVJlZ2lzdHJhdGlvbkNyZWF0ZVtdKSB7XG4gICAgaWYgKG5ld0RldmljZVJlcXVlc3RzICYmIG5ld0RldmljZVJlcXVlc3RzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKTtcbiAgICAgIGNvbnN0IG5ld1JlcXVlc3RzJCA9IG5ld0RldmljZVJlcXVlc3RzLm1hcChlbGVtZW50ID0+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgdGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmNyZWF0ZShlbGVtZW50KS5jYXRjaCgoZXJyOiBJUmVzdWx0PElEZXZpY2VSZWdpc3RyYXRpb24+KSA9PiAoe1xuICAgICAgICAgICAgcmVzOiBlcnIucmVzLFxuICAgICAgICAgICAgZGF0YTogeyAuLi5lcnIuZGF0YSwgaWQ6IGVsZW1lbnQuaWQgfVxuICAgICAgICAgIH0pKVxuICAgICAgICApO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGdyb3VwZWRSZXF1ZXN0czoge1xuICAgICAgICBzdWNjZXNzOiBJRGV2aWNlUmVnaXN0cmF0aW9uW107XG4gICAgICAgIGZhaWxlZDogSURldmljZVJlZ2lzdHJhdGlvbltdO1xuICAgICAgfSA9IHtcbiAgICAgICAgc3VjY2VzczogW10sXG4gICAgICAgIGZhaWxlZDogW11cbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBmb3JrSm9pbihuZXdSZXF1ZXN0cyQpLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKHJlc3AgPT5cbiAgICAgICAgICByZXNwLm1hcChlbCA9PiB7XG4gICAgICAgICAgICBlbC5yZXMub2tcbiAgICAgICAgICAgICAgPyBncm91cGVkUmVxdWVzdHMuc3VjY2Vzcy5wdXNoKGVsLmRhdGEpXG4gICAgICAgICAgICAgIDogZ3JvdXBlZFJlcXVlc3RzLmZhaWxlZC5wdXNoKGVsLmRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIGdyb3VwZWRSZXF1ZXN0cztcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgICAgICB0YWtlTGFzdCgxKSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuaW50ZXJuYWxMaXN0VXBkYXRlKGdyb3VwZWRSZXF1ZXN0cy5zdWNjZXNzKTtcbiAgICAgICAgICB0aGlzLl9sb2FkaW5nLm5leHQoZmFsc2UpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmUoaWQ6IHN0cmluZykge1xuICAgIHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKTtcbiAgICBmcm9tKHRoaXMuZGV2aWNlUmVnU2VydmljZS5kZWxldGUoaWQpKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucykpXG4gICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7XG4gICAgICAgICAgICBkYXRhOiB0aGlzLnJlbW92ZURldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RCeUlkKGlkKVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdEZXZpY2UgcmVnaXN0cmF0aW9uIGNhbmNlbGxlZC4nKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBhY2NlcHQocmVxdWVzdDogSURldmljZVJlZ2lzdHJhdGlvbikge1xuICAgIHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKTtcbiAgICBjb25zdCBwYXlsb2FkID0gcGljayhyZXF1ZXN0LCBbJ2lkJywgJ3NlY3VyaXR5VG9rZW4nXSk7XG4gICAgZnJvbSh0aGlzLmRldmljZVJlZ1NlcnZpY2UuYWNjZXB0KHBheWxvYWQpKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucykpXG4gICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMubmV4dCh7XG4gICAgICAgICAgICBkYXRhOiB0aGlzLnVwZGF0ZVN0YXR1c0J5SWQocGF5bG9hZC5pZCwgRGV2aWNlUmVnaXN0cmF0aW9uU3RhdHVzLkFDQ0VQVEVEKVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMubGltaXQoKTtcbiAgICAgICAgICB0aGlzLl9sb2FkaW5nLm5leHQoZmFsc2UpO1xuICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnRGV2aWNlIHJlZ2lzdHJhdGlvbiBhY2NlcHRlZC4nKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBhY2NlcHRBbGwoKSB7XG4gICAgY29uc3QgYWNjZXB0ZWREZXZpY2VSZXF1ZXN0czogSURldmljZVJlZ2lzdHJhdGlvbkFjY2VwdFtdID0gW107XG4gICAgY29uc3QgZmFpbGVkRGV2aWNlUmVxdWVzdHM6IElEZXZpY2VSZWdpc3RyYXRpb25BY2NlcHRbXSA9IFtdO1xuICAgIHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKTtcblxuICAgIGZyb20odGhpcy5kZXZpY2VSZWdTZXJ2aWNlLmFjY2VwdEFsbCgpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmVuZFN1YnNjcmlwdGlvbnMpLFxuICAgICAgICBtYXAoKHsgZGF0YSB9KSA9PiB7XG4gICAgICAgICAgZGF0YS5tYXAoZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdCA9PiB7XG4gICAgICAgICAgICBpZiAoZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdC5zdWNjZXNzZnVsKSB7XG4gICAgICAgICAgICAgIGFjY2VwdGVkRGV2aWNlUmVxdWVzdHMucHVzaChkZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0KTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0dXNCeUlkKFxuICAgICAgICAgICAgICAgIGRldmljZVJlZ2lzdHJhdGlvblJlcXVlc3QuaWQsXG4gICAgICAgICAgICAgICAgRGV2aWNlUmVnaXN0cmF0aW9uU3RhdHVzLkFDQ0VQVEVEXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBmYWlsZWREZXZpY2VSZXF1ZXN0cy5wdXNoKGRldmljZVJlZ2lzdHJhdGlvblJlcXVlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9KSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIC8vIHVwZGF0ZSByZW5kZXJlZCBsaXN0IHdpdGggc3VjY2Vzc2Z1bCBhY2NlcHRlZCBkZXZpY2UgcmVnaXN0cmF0aW9uc1xuICAgICAgICAgIC8vIHNlZTogdGhpcy51cGRhdGVTdGF0dXNCeUlkKC4uLilcbiAgICAgICAgICB0aGlzLmludGVybmFsTGlzdFVwZGF0ZShbXSk7XG4gICAgICAgICAgdGhpcy5saW1pdCgpO1xuICAgICAgICAgIHRoaXMuX2xvYWRpbmcubmV4dChmYWxzZSk7XG4gICAgICAgICAgaWYgKGZhaWxlZERldmljZVJlcXVlc3RzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLndhcm5pbmcoXG4gICAgICAgICAgICAgIGdldHRleHQoJ0NvdWxkIG5vdCBhY2NlcHQgYWxsIHBlbmRpbmcgcmVnaXN0cmF0aW9uIHJlcXVlc3RzLicpLFxuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBmYWlsZWREZXZpY2VSZXF1ZXN0cyxcbiAgICAgICAgICAgICAgICAgIGFjY2VwdGVkRGV2aWNlUmVxdWVzdHNcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAyXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQWNjZXB0ZWQgYWxsIHBlbmRpbmcgcmVnaXN0cmF0aW9uIHJlcXVlc3RzLicpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgLy8gZW1wdHkgYnkgZGVzaWduXG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cblxuICBsaW1pdCgpIHtcbiAgICBmcm9tKHRoaXMuZGV2aWNlUmVnU2VydmljZS5saW1pdCgpKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucykpXG4gICAgICAuc3Vic2NyaWJlKFxuICAgICAgICByZXMgPT4gdGhpcy5fbGltaXQubmV4dChyZXMuZGF0YSksXG4gICAgICAgIGVyciA9PiB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycilcbiAgICAgICk7XG4gIH1cblxuICBnZXRSZXF1ZXN0QnlTdGF0dXMoc3RhdHVzOiBEZXZpY2VSZWdpc3RyYXRpb25TdGF0dXMpOiBJRGV2aWNlUmVnaXN0cmF0aW9uW10ge1xuICAgIHJldHVybiB0aGlzLl9kZXZpY2VSZWdpc3RyYXRpb25SZXF1ZXN0cy5nZXRWYWx1ZSgpLmRhdGEuZmlsdGVyKHJlcSA9PiByZXEuc3RhdHVzID09PSBzdGF0dXMpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5lbmRTdWJzY3JpcHRpb25zLm5leHQoKTtcbiAgICB0aGlzLmVuZFN1YnNjcmlwdGlvbnMuY29tcGxldGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU3RhdHVzQnlJZChpZDogc3RyaW5nLCBzdGF0dXM6IERldmljZVJlZ2lzdHJhdGlvblN0YXR1cykge1xuICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5fZGV2aWNlUmVnaXN0cmF0aW9uUmVxdWVzdHMuZ2V0VmFsdWUoKS5kYXRhO1xuICAgIGNvbnN0IG1hdGNoaW5nRWxlbWVudEluZGV4ID0gaXRlbXMuZmluZEluZGV4KGVsZW1lbnQgPT4gZWxlbWVudC5pZCA9PT0gaWQpO1xuICAgIGlmIChtYXRjaGluZ0VsZW1lbnRJbmRleCA+PSAwKSB7XG4gICAgICBpdGVtc1ttYXRjaGluZ0VsZW1lbnRJbmRleF0uc3RhdHVzID0gc3RhdHVzO1xuICAgIH1cbiAgICByZXR1cm4gaXRlbXM7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZURldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RCeUlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuX2RldmljZVJlZ2lzdHJhdGlvblJlcXVlc3RzLmdldFZhbHVlKCkuZGF0YTtcbiAgICBjb25zdCBtYXRjaGluZ0VsZW1lbnRJbmRleCA9IGl0ZW1zLmZpbmRJbmRleChlbGVtZW50ID0+IGVsZW1lbnQuaWQgPT09IGlkKTtcbiAgICBpZiAobWF0Y2hpbmdFbGVtZW50SW5kZXggPj0gMCkge1xuICAgICAgaXRlbXMuc3BsaWNlKG1hdGNoaW5nRWxlbWVudEluZGV4LCAxKTtcbiAgICB9XG4gICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICByZXR1cm4gaXRlbXM7XG4gIH1cbn1cbiJdfQ==