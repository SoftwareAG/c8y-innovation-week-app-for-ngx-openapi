import { Component, Input, Optional } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, map, shareReplay, switchMap, distinctUntilChanged, startWith } from 'rxjs/operators';
import { MeasurementRealtimeService } from '@c8y/ngx-components';
import { loadBoxModel } from '@c8y/ngx-components/widgets/implementations/three-d-rotation/lazy-box-model';
import { loadPhoneModel } from '@c8y/ngx-components/widgets/implementations/three-d-rotation/lazy-phone-model';
import { ContextDashboardComponent } from '@c8y/ngx-components/context-dashboard';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "@c8y/ngx-components/context-dashboard";
import * as i3 from "../three-d-rotation/three-d-rotation.component";
export class ThreeDRotationWidgetViewComponent {
    constructor(measurementRealtime, dashboard) {
        this.measurementRealtime = measurementRealtime;
        this.dashboard = dashboard;
        this.deviceId$ = new BehaviorSubject(null);
        this.modelName$ = new BehaviorSubject(null);
        this.cameraType$ = new BehaviorSubject('PC');
        this.isWireframe$ = new BehaviorSubject(true);
        this.modelObj$ = this.modelName$.pipe(filter(name => !!name), distinctUntilChanged(), switchMap(name => this.getModelUrl(name)), shareReplay(1));
        this.angles$ = this.deviceId$.pipe(filter(id => !!id), distinctUntilChanged(), switchMap(id => this.getAnglesOfDevice$(id)), startWith({ x: 0, y: 0, z: 0 }));
    }
    ngOnChanges(changes) {
        if (changes.config && this.config) {
            this.onConfigChange();
        }
    }
    onConfigChange() {
        if (this.config.device?.id) {
            this.deviceId$.next(`${this.config.device.id}`);
        }
        else if (this.dashboard?.context?.id) {
            this.deviceId$.next(`${this.dashboard.context?.id}`);
        }
        if (this.config.objectModel) {
            this.modelName$.next(this.config.objectModel);
        }
        if (this.config.cameraType) {
            this.cameraType$.next(this.config.cameraType);
        }
        if (this.config.isWireframe !== undefined) {
            this.isWireframe$.next(this.config.isWireframe);
        }
    }
    async getModelUrl(model) {
        // The name *.min.json still exist for backwards compatibility
        // it might be stored in certain widget configs.
        if (model === 'box.min.json') {
            return await loadBoxModel();
        }
        else {
            return await loadPhoneModel();
        }
    }
    getAnglesOfDevice$(deviceId) {
        const fragment = 'c8y_Acceleration';
        const series = ['accelerationX', 'accelerationY', 'accelerationZ'];
        return this.measurementRealtime
            .latestValueOfSpecificMeasurement$(fragment, series[0], deviceId, 1)
            .pipe(filter(m => !!m && m[fragment] && series.every(axisSeries => m[fragment][axisSeries])), map(measurement => {
            const [xAxisValue, yAxisValue, zAxisValue] = series.map(axisSeries => Math.round(measurement[fragment][axisSeries].value));
            return this.convertValues(xAxisValue, yAxisValue, zAxisValue);
        }));
    }
    convertValues(x, y, z) {
        let rotateX = Math.atan2(y, z);
        let rotateY = Math.atan2(x, Math.sqrt(y * y + z * z));
        rotateX = rotateX ? rotateX % (Math.PI * 2) : 0;
        rotateY = rotateY ? rotateY % (Math.PI * 2) : 0;
        return {
            x: rotateX,
            y: 0,
            z: rotateY
        };
    }
}
ThreeDRotationWidgetViewComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ThreeDRotationWidgetViewComponent, deps: [{ token: i1.MeasurementRealtimeService }, { token: i2.ContextDashboardComponent, optional: true }], target: i0.ɵɵFactoryTarget.Component });
ThreeDRotationWidgetViewComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: ThreeDRotationWidgetViewComponent, selector: "c8y-three-d-rotation-widget-view", inputs: { config: "config" }, providers: [MeasurementRealtimeService], usesOnChanges: true, ngImport: i0, template: "<c8y-three-d-rotation\n  [modelObj$]=\"modelObj$\"\n  [angles$]=\"angles$\"\n  [cameraType$]=\"cameraType$\"\n  [isWireframe$]=\"isWireframe$\"\n></c8y-three-d-rotation>\n", dependencies: [{ kind: "component", type: i3.ThreeDRotationComponent, selector: "c8y-three-d-rotation", inputs: ["angles$", "modelObj$", "cameraType$", "isWireframe$"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ThreeDRotationWidgetViewComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-three-d-rotation-widget-view', providers: [MeasurementRealtimeService], template: "<c8y-three-d-rotation\n  [modelObj$]=\"modelObj$\"\n  [angles$]=\"angles$\"\n  [cameraType$]=\"cameraType$\"\n  [isWireframe$]=\"isWireframe$\"\n></c8y-three-d-rotation>\n" }]
        }], ctorParameters: function () { return [{ type: i1.MeasurementRealtimeService }, { type: i2.ContextDashboardComponent, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { config: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhyZWUtZC1yb3RhdGlvbi13aWRnZXQtdmlldy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi93aWRnZXRzL2ltcGxlbWVudGF0aW9ucy90aHJlZS1kLXJvdGF0aW9uL3RocmVlLWQtcm90YXRpb24td2lkZ2V0LXZpZXcvdGhyZWUtZC1yb3RhdGlvbi13aWRnZXQtdmlldy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi93aWRnZXRzL2ltcGxlbWVudGF0aW9ucy90aHJlZS1kLXJvdGF0aW9uL3RocmVlLWQtcm90YXRpb24td2lkZ2V0LXZpZXcvdGhyZWUtZC1yb3RhdGlvbi13aWRnZXQtdmlldy5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYSxRQUFRLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUNMLE1BQU0sRUFDTixHQUFHLEVBQ0gsV0FBVyxFQUNYLFNBQVMsRUFDVCxvQkFBb0IsRUFDcEIsU0FBUyxFQUNWLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFakUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDZFQUE2RSxDQUFDO0FBQzNHLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwrRUFBK0UsQ0FBQztBQUMvRyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7Ozs7QUFPbEYsTUFBTSxPQUFPLGlDQUFpQztJQVM1QyxZQUNVLG1CQUErQyxFQUNuQyxTQUFvQztRQURoRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTRCO1FBQ25DLGNBQVMsR0FBVCxTQUFTLENBQTJCO1FBUDFELGNBQVMsR0FBRyxJQUFJLGVBQWUsQ0FB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LE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVoRCxPQUFPO1lBQ0wsQ0FBQyxFQUFFLE9BQU87WUFDVixDQUFDLEVBQUUsQ0FBQztZQUNKLENBQUMsRUFBRSxPQUFPO1NBQ1gsQ0FBQztJQUNKLENBQUM7OzhIQTFGVSxpQ0FBaUM7a0hBQWpDLGlDQUFpQyx5RkFGakMsQ0FBQywwQkFBMEIsQ0FBQywrQ0NuQnpDLDZLQU1BOzJGRGVhLGlDQUFpQztrQkFMN0MsU0FBUzsrQkFDRSxrQ0FBa0MsYUFFakMsQ0FBQywwQkFBMEIsQ0FBQzs7MEJBYXBDLFFBQVE7NENBVkYsTUFBTTtzQkFBZCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzLCBPcHRpb25hbCwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBmaWx0ZXIsXG4gIG1hcCxcbiAgc2hhcmVSZXBsYXksXG4gIHN3aXRjaE1hcCxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIHN0YXJ0V2l0aFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBNZWFzdXJlbWVudFJlYWx0aW1lU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgVGhyZWVEUm90YXRpb25XaWRnZXRDb25maWcsIFRocmVlRFJvdGF0aW9uV2lkZ2V0Um90YXRlIH0gZnJvbSAnLi4vdGhyZWUtZC1yb3RhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBsb2FkQm94TW9kZWwgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL3dpZGdldHMvaW1wbGVtZW50YXRpb25zL3RocmVlLWQtcm90YXRpb24vbGF6eS1ib3gtbW9kZWwnO1xuaW1wb3J0IHsgbG9hZFBob25lTW9kZWwgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL3dpZGdldHMvaW1wbGVtZW50YXRpb25zL3RocmVlLWQtcm90YXRpb24vbGF6eS1waG9uZS1tb2RlbCc7XG5pbXBvcnQgeyBDb250ZXh0RGFzaGJvYXJkQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9jb250ZXh0LWRhc2hib2FyZCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS10aHJlZS1kLXJvdGF0aW9uLXdpZGdldC12aWV3JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RocmVlLWQtcm90YXRpb24td2lkZ2V0LXZpZXcuY29tcG9uZW50Lmh0bWwnLFxuICBwcm92aWRlcnM6IFtNZWFzdXJlbWVudFJlYWx0aW1lU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgVGhyZWVEUm90YXRpb25XaWRnZXRWaWV3Q29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgQElucHV0KCkgY29uZmlnOiBUaHJlZURSb3RhdGlvbldpZGdldENvbmZpZztcbiAgYW5nbGVzJDogT2JzZXJ2YWJsZTxUaHJlZURSb3RhdGlvbldpZGdldFJvdGF0ZT47XG4gIG1vZGVsT2JqJDogT2JzZXJ2YWJsZTxhbnk+O1xuICBkZXZpY2VJZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4obnVsbCk7XG4gIG1vZGVsTmFtZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4obnVsbCk7XG4gIGNhbWVyYVR5cGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+KCdQQycpO1xuICBpc1dpcmVmcmFtZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbWVhc3VyZW1lbnRSZWFsdGltZTogTWVhc3VyZW1lbnRSZWFsdGltZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBkYXNoYm9hcmQ6IENvbnRleHREYXNoYm9hcmRDb21wb25lbnRcbiAgKSB7XG4gICAgdGhpcy5tb2RlbE9iaiQgPSB0aGlzLm1vZGVsTmFtZSQucGlwZShcbiAgICAgIGZpbHRlcihuYW1lID0+ICEhbmFtZSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgc3dpdGNoTWFwKG5hbWUgPT4gdGhpcy5nZXRNb2RlbFVybChuYW1lKSksXG4gICAgICBzaGFyZVJlcGxheSgxKVxuICAgICk7XG4gICAgdGhpcy5hbmdsZXMkID0gdGhpcy5kZXZpY2VJZCQucGlwZShcbiAgICAgIGZpbHRlcihpZCA9PiAhIWlkKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAoaWQgPT4gdGhpcy5nZXRBbmdsZXNPZkRldmljZSQoaWQpKSxcbiAgICAgIHN0YXJ0V2l0aCh7IHg6IDAsIHk6IDAsIHo6IDAgfSlcbiAgICApO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZykge1xuICAgICAgdGhpcy5vbkNvbmZpZ0NoYW5nZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Db25maWdDaGFuZ2UoKSB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmRldmljZT8uaWQpIHtcbiAgICAgIHRoaXMuZGV2aWNlSWQkLm5leHQoYCR7dGhpcy5jb25maWcuZGV2aWNlLmlkfWApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXNoYm9hcmQ/LmNvbnRleHQ/LmlkKSB7XG4gICAgICB0aGlzLmRldmljZUlkJC5uZXh0KGAke3RoaXMuZGFzaGJvYXJkLmNvbnRleHQ/LmlkfWApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZy5vYmplY3RNb2RlbCkge1xuICAgICAgdGhpcy5tb2RlbE5hbWUkLm5leHQodGhpcy5jb25maWcub2JqZWN0TW9kZWwpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZy5jYW1lcmFUeXBlKSB7XG4gICAgICB0aGlzLmNhbWVyYVR5cGUkLm5leHQodGhpcy5jb25maWcuY2FtZXJhVHlwZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29uZmlnLmlzV2lyZWZyYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuaXNXaXJlZnJhbWUkLm5leHQodGhpcy5jb25maWcuaXNXaXJlZnJhbWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0TW9kZWxVcmwobW9kZWw6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgLy8gVGhlIG5hbWUgKi5taW4uanNvbiBzdGlsbCBleGlzdCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHlcbiAgICAvLyBpdCBtaWdodCBiZSBzdG9yZWQgaW4gY2VydGFpbiB3aWRnZXQgY29uZmlncy5cbiAgICBpZiAobW9kZWwgPT09ICdib3gubWluLmpzb24nKSB7XG4gICAgICByZXR1cm4gYXdhaXQgbG9hZEJveE1vZGVsKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCBsb2FkUGhvbmVNb2RlbCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0QW5nbGVzT2ZEZXZpY2UkKGRldmljZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRocmVlRFJvdGF0aW9uV2lkZ2V0Um90YXRlPiB7XG4gICAgY29uc3QgZnJhZ21lbnQgPSAnYzh5X0FjY2VsZXJhdGlvbic7XG4gICAgY29uc3Qgc2VyaWVzID0gWydhY2NlbGVyYXRpb25YJywgJ2FjY2VsZXJhdGlvblknLCAnYWNjZWxlcmF0aW9uWiddO1xuICAgIHJldHVybiB0aGlzLm1lYXN1cmVtZW50UmVhbHRpbWVcbiAgICAgIC5sYXRlc3RWYWx1ZU9mU3BlY2lmaWNNZWFzdXJlbWVudCQoZnJhZ21lbnQsIHNlcmllc1swXSwgZGV2aWNlSWQsIDEpXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKG0gPT4gISFtICYmIG1bZnJhZ21lbnRdICYmIHNlcmllcy5ldmVyeShheGlzU2VyaWVzID0+IG1bZnJhZ21lbnRdW2F4aXNTZXJpZXNdKSksXG4gICAgICAgIG1hcChtZWFzdXJlbWVudCA9PiB7XG4gICAgICAgICAgY29uc3QgW3hBeGlzVmFsdWUsIHlBeGlzVmFsdWUsIHpBeGlzVmFsdWVdID0gc2VyaWVzLm1hcChheGlzU2VyaWVzID0+XG4gICAgICAgICAgICBNYXRoLnJvdW5kKG1lYXN1cmVtZW50W2ZyYWdtZW50XVtheGlzU2VyaWVzXS52YWx1ZSlcbiAgICAgICAgICApO1xuICAgICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnRWYWx1ZXMoeEF4aXNWYWx1ZSwgeUF4aXNWYWx1ZSwgekF4aXNWYWx1ZSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VmFsdWVzKHg6IG51bWJlciwgeTogbnVtYmVyLCB6OiBudW1iZXIpOiBUaHJlZURSb3RhdGlvbldpZGdldFJvdGF0ZSB7XG4gICAgbGV0IHJvdGF0ZVggPSBNYXRoLmF0YW4yKHksIHopO1xuICAgIGxldCByb3RhdGVZID0gTWF0aC5hdGFuMih4LCBNYXRoLnNxcnQoeSAqIHkgKyB6ICogeikpO1xuICAgIHJvdGF0ZVggPSByb3RhdGVYID8gcm90YXRlWCAlIChNYXRoLlBJICogMikgOiAwO1xuICAgIHJvdGF0ZVkgPSByb3RhdGVZID8gcm90YXRlWSAlIChNYXRoLlBJICogMikgOiAwO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IHJvdGF0ZVgsXG4gICAgICB5OiAwLFxuICAgICAgejogcm90YXRlWVxuICAgIH07XG4gIH1cbn1cbiIsIjxjOHktdGhyZWUtZC1yb3RhdGlvblxuICBbbW9kZWxPYmokXT1cIm1vZGVsT2JqJFwiXG4gIFthbmdsZXMkXT1cImFuZ2xlcyRcIlxuICBbY2FtZXJhVHlwZSRdPVwiY2FtZXJhVHlwZSRcIlxuICBbaXNXaXJlZnJhbWUkXT1cImlzV2lyZWZyYW1lJFwiXG4+PC9jOHktdGhyZWUtZC1yb3RhdGlvbj5cbiJdfQ==