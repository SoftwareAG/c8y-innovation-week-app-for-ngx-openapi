import { Component, ElementRef, Input, ViewChild } from '@angular/core';
import { combineLatest, from, Observable, of, Subject } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, switchMap } from 'rxjs/operators';
import { loadThree } from '@c8y/ngx-components/lazy/three';
import { loadOrbitControls } from '@c8y/ngx-components/lazy/three-orbit-controls';
import * as i0 from "@angular/core";
export class ThreeDRotationComponent {
    constructor() {
        this.angles$ = of({ x: 0, y: 0, z: 0 });
        this.cameraType$ = of('PC');
        this.isWireframe$ = of(true);
        this.afterViewInit$ = new Subject();
    }
    get canvas() {
        return this.canvasRef?.nativeElement;
    }
    ngOnInit() {
        const three$ = from(loadThree()).pipe(shareReplay(1));
        const model$ = combineLatest([three$, this.modelObj$]).pipe(filter(([, modelObj]) => !!modelObj), switchMap(([three, modelObj]) => this.loadModel(modelObj, three)));
        const modelWithWireframe$ = combineLatest([model$, this.isWireframe$]).pipe(map(([model, isWireframe]) => this.setWireframe(model, isWireframe)));
        const rotatedModel$ = combineLatest([modelWithWireframe$, this.angles$]).pipe(filter(([, angles]) => !!angles), map(([model, angles]) => {
            Object.assign(model.rotation, angles);
            return model;
        }));
        const cameraType$ = this.cameraType$.pipe(filter(type => !!type), distinctUntilChanged());
        let previousCameraType;
        this.renderSubscription = combineLatest([
            three$,
            rotatedModel$,
            cameraType$,
            this.afterViewInit$
        ])
            .pipe(filter(([, model]) => !!model))
            .subscribe(async ([three, model, cameraType]) => {
            if (model !== this.model || previousCameraType !== cameraType) {
                this.model = model;
                previousCameraType = cameraType;
                this.createScene(three, model, cameraType);
            }
            if (!this.renderer) {
                await this.setupRenderer(three);
            }
            this.render();
        });
    }
    ngOnDestroy() {
        this.renderSubscription?.unsubscribe();
        this.controls?.dispose();
    }
    ngAfterViewInit() {
        this.afterViewInit$.next();
    }
    async loadModel(modelObj, three) {
        const loader = new three.ObjectLoader();
        const parsedModel = await loader.parse(modelObj);
        return parsedModel;
    }
    async setupRenderer(three) {
        //* Renderer
        // Use canvas element in template
        this.renderer = new three.WebGLRenderer({ canvas: this.canvas });
        this.renderer.setPixelRatio(devicePixelRatio);
        this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
        const { OrbitControls } = await loadOrbitControls();
        this.controls = new OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.dampingFactor = 0.25;
        this.controls.rotateSpeed = 0.35;
        this.controls.addEventListener('change', () => this.render());
    }
    setWireframe(parsedModel, isWireframe) {
        parsedModel.children.forEach((child) => {
            if (child.material) {
                child.material.wireframe = isWireframe;
            }
        });
        return parsedModel;
    }
    render() {
        this.renderer?.render(this.scene, this.camera);
    }
    createScene(three, model, cameraType) {
        //* Scene
        this.scene = new three.Scene();
        this.scene.background = new three.Color(0xffffff);
        this.scene.add(model);
        const light = new three.AmbientLight(0xffffff, 0.5);
        const lightDirectional = new three.DirectionalLight(0xffffff);
        const lightDirectional2 = new three.DirectionalLight(0xffffff);
        lightDirectional.position.set(20, 25, 30);
        lightDirectional2.position.set(-20, -25, -30);
        this.scene.add(lightDirectional);
        this.scene.add(lightDirectional2);
        this.scene.add(light);
        this.camera = this.createCamera(three, cameraType);
    }
    createCamera(three, cameraType) {
        let camera;
        switch (cameraType) {
            case 'OC':
                camera = new three.OrthographicCamera(30 / -2, 30 / 2, 30 / 2, 30 / -2, 1, 1000);
                break;
            case 'PC':
            default:
                camera = new three.PerspectiveCamera(30, this.getAspectRatio(), 0.1, 1000);
                break;
        }
        camera.rotateX(Math.PI / 2);
        camera.rotateY(Math.PI / 2);
        camera.position.z = 23;
        camera.position.x = 14;
        camera.position.y = 7;
        return camera;
    }
    getAspectRatio() {
        return this.canvas.clientWidth / this.canvas.clientHeight;
    }
}
ThreeDRotationComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ThreeDRotationComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
ThreeDRotationComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: ThreeDRotationComponent, selector: "c8y-three-d-rotation", inputs: { angles$: "angles$", modelObj$: "modelObj$", cameraType$: "cameraType$", isWireframe$: "isWireframe$" }, viewQueries: [{ propertyName: "canvasRef", first: true, predicate: ["canvas"], descendants: true }], ngImport: i0, template: "<canvas #canvas class=\"fit-w fit-h\"></canvas>\n" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ThreeDRotationComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-three-d-rotation', template: "<canvas #canvas class=\"fit-w fit-h\"></canvas>\n" }]
        }], propDecorators: { canvasRef: [{
                type: ViewChild,
                args: ['canvas']
            }], angles$: [{
                type: Input
            }], modelObj$: [{
                type: Input
            }], cameraType$: [{
                type: Input
            }], isWireframe$: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhyZWUtZC1yb3RhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi93aWRnZXRzL2ltcGxlbWVudGF0aW9ucy90aHJlZS1kLXJvdGF0aW9uL3RocmVlLWQtcm90YXRpb24vdGhyZWUtZC1yb3RhdGlvbi5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi93aWRnZXRzL2ltcGxlbWVudGF0aW9ucy90aHJlZS1kLXJvdGF0aW9uL3RocmVlLWQtcm90YXRpb24vdGhyZWUtZC1yb3RhdGlvbi5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBR0wsU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUNsRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0YsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRTNELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLCtDQUErQyxDQUFDOztBQVFsRixNQUFNLE9BQU8sdUJBQXVCO0lBSnBDO1FBUVcsWUFBTyxHQUEyQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFM0UsZ0JBQVcsR0FBdUIsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLGlCQUFZLEdBQXdCLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQVc5QyxtQkFBYyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7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LENBQUM7UUFDdkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV0QixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRU8sY0FBYztRQUNwQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQzVELENBQUM7O29IQXpKVSx1QkFBdUI7d0dBQXZCLHVCQUF1QixtUkNyQnBDLG1EQUNBOzJGRG9CYSx1QkFBdUI7a0JBSm5DLFNBQVM7K0JBQ0Usc0JBQXNCOzhCQUt4QixTQUFTO3NCQURoQixTQUFTO3VCQUFDLFFBQVE7Z0JBR1YsT0FBTztzQkFBZixLQUFLO2dCQUNHLFNBQVM7c0JBQWpCLEtBQUs7Z0JBQ0csV0FBVztzQkFBbkIsS0FBSztnQkFDRyxZQUFZO3NCQUFwQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIGZyb20sIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGxvYWRUaHJlZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvbGF6eS90aHJlZSc7XG5pbXBvcnQgeyBUaHJlZURSb3RhdGlvbldpZGdldFJvdGF0ZSB9IGZyb20gJy4uL3RocmVlLWQtcm90YXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgbG9hZE9yYml0Q29udHJvbHMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2xhenkvdGhyZWUtb3JiaXQtY29udHJvbHMnO1xuaW1wb3J0IHR5cGUgVEhSRUUgZnJvbSAndGhyZWUnO1xuaW1wb3J0IHR5cGUgeyBPcmJpdENvbnRyb2xzIH0gZnJvbSAndGhyZWUvZXhhbXBsZXMvanNtL2NvbnRyb2xzL09yYml0Q29udHJvbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktdGhyZWUtZC1yb3RhdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi90aHJlZS1kLXJvdGF0aW9uLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBUaHJlZURSb3RhdGlvbkNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZCgnY2FudmFzJylcbiAgcHJpdmF0ZSBjYW52YXNSZWY6IEVsZW1lbnRSZWY7XG5cbiAgQElucHV0KCkgYW5nbGVzJDogT2JzZXJ2YWJsZTxUaHJlZURSb3RhdGlvbldpZGdldFJvdGF0ZT4gPSBvZih7IHg6IDAsIHk6IDAsIHo6IDAgfSk7XG4gIEBJbnB1dCgpIG1vZGVsT2JqJDogT2JzZXJ2YWJsZTxhbnk+O1xuICBASW5wdXQoKSBjYW1lcmFUeXBlJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gb2YoJ1BDJyk7XG4gIEBJbnB1dCgpIGlzV2lyZWZyYW1lJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IG9mKHRydWUpO1xuXG4gIGdldCBjYW52YXMoKTogSFRNTENhbnZhc0VsZW1lbnQgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5jYW52YXNSZWY/Lm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBzY2VuZTogVEhSRUUuU2NlbmU7XG4gIGNhbWVyYTogVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEgfCBUSFJFRS5PcnRob2dyYXBoaWNDYW1lcmE7XG4gIG1vZGVsOiBUSFJFRS5PYmplY3QzRDtcbiAgcHJpdmF0ZSByZW5kZXJlcjogVEhSRUUuV2ViR0xSZW5kZXJlcjtcblxuICBwcml2YXRlIGFmdGVyVmlld0luaXQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBwcml2YXRlIHJlbmRlclN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIGNvbnRyb2xzOiBPcmJpdENvbnRyb2xzO1xuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IHRocmVlJCA9IGZyb20obG9hZFRocmVlKCkpLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICAgIGNvbnN0IG1vZGVsJCA9IGNvbWJpbmVMYXRlc3QoW3RocmVlJCwgdGhpcy5tb2RlbE9iaiRdKS5waXBlKFxuICAgICAgZmlsdGVyKChbLCBtb2RlbE9ial0pID0+ICEhbW9kZWxPYmopLFxuICAgICAgc3dpdGNoTWFwKChbdGhyZWUsIG1vZGVsT2JqXSkgPT4gdGhpcy5sb2FkTW9kZWwobW9kZWxPYmosIHRocmVlKSlcbiAgICApO1xuICAgIGNvbnN0IG1vZGVsV2l0aFdpcmVmcmFtZSQgPSBjb21iaW5lTGF0ZXN0KFttb2RlbCQsIHRoaXMuaXNXaXJlZnJhbWUkXSkucGlwZShcbiAgICAgIG1hcCgoW21vZGVsLCBpc1dpcmVmcmFtZV0pID0+IHRoaXMuc2V0V2lyZWZyYW1lKG1vZGVsLCBpc1dpcmVmcmFtZSkpXG4gICAgKTtcblxuICAgIGNvbnN0IHJvdGF0ZWRNb2RlbCQgPSBjb21iaW5lTGF0ZXN0KFttb2RlbFdpdGhXaXJlZnJhbWUkLCB0aGlzLmFuZ2xlcyRdKS5waXBlKFxuICAgICAgZmlsdGVyKChbLCBhbmdsZXNdKSA9PiAhIWFuZ2xlcyksXG4gICAgICBtYXAoKFttb2RlbCwgYW5nbGVzXSkgPT4ge1xuICAgICAgICBPYmplY3QuYXNzaWduKG1vZGVsLnJvdGF0aW9uLCBhbmdsZXMpO1xuICAgICAgICByZXR1cm4gbW9kZWw7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBjYW1lcmFUeXBlJCA9IHRoaXMuY2FtZXJhVHlwZSQucGlwZShcbiAgICAgIGZpbHRlcih0eXBlID0+ICEhdHlwZSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcblxuICAgIGxldCBwcmV2aW91c0NhbWVyYVR5cGU6IHN0cmluZztcbiAgICB0aGlzLnJlbmRlclN1YnNjcmlwdGlvbiA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhyZWUkLFxuICAgICAgcm90YXRlZE1vZGVsJCxcbiAgICAgIGNhbWVyYVR5cGUkLFxuICAgICAgdGhpcy5hZnRlclZpZXdJbml0JFxuICAgIF0pXG4gICAgICAucGlwZShmaWx0ZXIoKFssIG1vZGVsXSkgPT4gISFtb2RlbCkpXG4gICAgICAuc3Vic2NyaWJlKGFzeW5jIChbdGhyZWUsIG1vZGVsLCBjYW1lcmFUeXBlXSkgPT4ge1xuICAgICAgICBpZiAobW9kZWwgIT09IHRoaXMubW9kZWwgfHwgcHJldmlvdXNDYW1lcmFUeXBlICE9PSBjYW1lcmFUeXBlKSB7XG4gICAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xuICAgICAgICAgIHByZXZpb3VzQ2FtZXJhVHlwZSA9IGNhbWVyYVR5cGU7XG4gICAgICAgICAgdGhpcy5jcmVhdGVTY2VuZSh0aHJlZSwgbW9kZWwsIGNhbWVyYVR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5yZW5kZXJlcikge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc2V0dXBSZW5kZXJlcih0aHJlZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5yZW5kZXJTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5jb250cm9scz8uZGlzcG9zZSgpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuYWZ0ZXJWaWV3SW5pdCQubmV4dCgpO1xuICB9XG5cbiAgYXN5bmMgbG9hZE1vZGVsKG1vZGVsT2JqOiBhbnksIHRocmVlOiB0eXBlb2YgVEhSRUUpOiBQcm9taXNlPFRIUkVFLk9iamVjdDNEPFRIUkVFLkV2ZW50Pj4ge1xuICAgIGNvbnN0IGxvYWRlciA9IG5ldyB0aHJlZS5PYmplY3RMb2FkZXIoKTtcbiAgICBjb25zdCBwYXJzZWRNb2RlbCA9IGF3YWl0IGxvYWRlci5wYXJzZShtb2RlbE9iaik7XG4gICAgcmV0dXJuIHBhcnNlZE1vZGVsO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBSZW5kZXJlcih0aHJlZTogdHlwZW9mIFRIUkVFKSB7XG4gICAgLy8qIFJlbmRlcmVyXG4gICAgLy8gVXNlIGNhbnZhcyBlbGVtZW50IGluIHRlbXBsYXRlXG4gICAgdGhpcy5yZW5kZXJlciA9IG5ldyB0aHJlZS5XZWJHTFJlbmRlcmVyKHsgY2FudmFzOiB0aGlzLmNhbnZhcyB9KTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFBpeGVsUmF0aW8oZGV2aWNlUGl4ZWxSYXRpbyk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTaXplKHRoaXMuY2FudmFzLmNsaWVudFdpZHRoLCB0aGlzLmNhbnZhcy5jbGllbnRIZWlnaHQpO1xuXG4gICAgY29uc3QgeyBPcmJpdENvbnRyb2xzIH0gPSBhd2FpdCBsb2FkT3JiaXRDb250cm9scygpO1xuICAgIHRoaXMuY29udHJvbHMgPSBuZXcgT3JiaXRDb250cm9scyh0aGlzLmNhbWVyYSwgdGhpcy5yZW5kZXJlci5kb21FbGVtZW50KTtcbiAgICB0aGlzLmNvbnRyb2xzLmVuYWJsZURhbXBpbmcgPSB0cnVlO1xuICAgIHRoaXMuY29udHJvbHMuZGFtcGluZ0ZhY3RvciA9IDAuMjU7XG4gICAgdGhpcy5jb250cm9scy5yb3RhdGVTcGVlZCA9IDAuMzU7XG4gICAgdGhpcy5jb250cm9scy5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKSA9PiB0aGlzLnJlbmRlcigpKTtcbiAgfVxuXG4gIHNldFdpcmVmcmFtZShwYXJzZWRNb2RlbDogVEhSRUUuT2JqZWN0M0QsIGlzV2lyZWZyYW1lOiBib29sZWFuKSB7XG4gICAgcGFyc2VkTW9kZWwuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQ6IGFueSkgPT4ge1xuICAgICAgaWYgKGNoaWxkLm1hdGVyaWFsKSB7XG4gICAgICAgIGNoaWxkLm1hdGVyaWFsLndpcmVmcmFtZSA9IGlzV2lyZWZyYW1lO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXJzZWRNb2RlbDtcbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyKCk6IHZvaWQge1xuICAgIHRoaXMucmVuZGVyZXI/LnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVNjZW5lKHRocmVlOiB0eXBlb2YgVEhSRUUsIG1vZGVsOiBUSFJFRS5PYmplY3QzRCwgY2FtZXJhVHlwZTogc3RyaW5nKSB7XG4gICAgLy8qIFNjZW5lXG4gICAgdGhpcy5zY2VuZSA9IG5ldyB0aHJlZS5TY2VuZSgpO1xuICAgIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG5ldyB0aHJlZS5Db2xvcigweGZmZmZmZik7XG4gICAgdGhpcy5zY2VuZS5hZGQobW9kZWwpO1xuXG4gICAgY29uc3QgbGlnaHQgPSBuZXcgdGhyZWUuQW1iaWVudExpZ2h0KDB4ZmZmZmZmLCAwLjUpO1xuICAgIGNvbnN0IGxpZ2h0RGlyZWN0aW9uYWwgPSBuZXcgdGhyZWUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZik7XG4gICAgY29uc3QgbGlnaHREaXJlY3Rpb25hbDIgPSBuZXcgdGhyZWUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZik7XG5cbiAgICBsaWdodERpcmVjdGlvbmFsLnBvc2l0aW9uLnNldCgyMCwgMjUsIDMwKTtcbiAgICBsaWdodERpcmVjdGlvbmFsMi5wb3NpdGlvbi5zZXQoLTIwLCAtMjUsIC0zMCk7XG4gICAgdGhpcy5zY2VuZS5hZGQobGlnaHREaXJlY3Rpb25hbCk7XG4gICAgdGhpcy5zY2VuZS5hZGQobGlnaHREaXJlY3Rpb25hbDIpO1xuICAgIHRoaXMuc2NlbmUuYWRkKGxpZ2h0KTtcblxuICAgIHRoaXMuY2FtZXJhID0gdGhpcy5jcmVhdGVDYW1lcmEodGhyZWUsIGNhbWVyYVR5cGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDYW1lcmEodGhyZWU6IHR5cGVvZiBUSFJFRSwgY2FtZXJhVHlwZTogc3RyaW5nKSB7XG4gICAgbGV0IGNhbWVyYTogVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhIHwgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmE7XG4gICAgc3dpdGNoIChjYW1lcmFUeXBlKSB7XG4gICAgICBjYXNlICdPQyc6XG4gICAgICAgIGNhbWVyYSA9IG5ldyB0aHJlZS5PcnRob2dyYXBoaWNDYW1lcmEoMzAgLyAtMiwgMzAgLyAyLCAzMCAvIDIsIDMwIC8gLTIsIDEsIDEwMDApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BDJzpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNhbWVyYSA9IG5ldyB0aHJlZS5QZXJzcGVjdGl2ZUNhbWVyYSgzMCwgdGhpcy5nZXRBc3BlY3RSYXRpbygpLCAwLjEsIDEwMDApO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjYW1lcmEucm90YXRlWChNYXRoLlBJIC8gMik7XG4gICAgY2FtZXJhLnJvdGF0ZVkoTWF0aC5QSSAvIDIpO1xuXG4gICAgY2FtZXJhLnBvc2l0aW9uLnogPSAyMztcbiAgICBjYW1lcmEucG9zaXRpb24ueCA9IDE0O1xuICAgIGNhbWVyYS5wb3NpdGlvbi55ID0gNztcblxuICAgIHJldHVybiBjYW1lcmE7XG4gIH1cblxuICBwcml2YXRlIGdldEFzcGVjdFJhdGlvKCkge1xuICAgIHJldHVybiB0aGlzLmNhbnZhcy5jbGllbnRXaWR0aCAvIHRoaXMuY2FudmFzLmNsaWVudEhlaWdodDtcbiAgfVxufVxuIiwiPGNhbnZhcyAjY2FudmFzIGNsYXNzPVwiZml0LXcgZml0LWhcIj48L2NhbnZhcz5cbiJdfQ==