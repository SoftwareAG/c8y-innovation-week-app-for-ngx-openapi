import { Injectable } from '@angular/core';
import { isUndefined, sortBy } from 'lodash-es';
import { debounceTime, take } from 'rxjs/operators';
import { ApplicationType, ApplicationService, TenantService, TenantOptionsService } from '@c8y/client';
import { HumanizeAppNamePipe } from '@c8y/ngx-components';
import { DefaultSubscriptionsContext as DefaultSubscriptionsContextTenant } from './default-subscriptions.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@c8y/ngx-components";
export class DefaultSubscriptionsService {
    constructor(applicationService, tenantService, tenantOptionsService, humanizeAppNamePipe) {
        this.applicationService = applicationService;
        this.tenantService = tenantService;
        this.tenantOptionsService = tenantOptionsService;
        this.humanizeAppNamePipe = humanizeAppNamePipe;
    }
    /**
     * Gets the list of applications which can be used in default subscriptions, i.e.:
     * - current tenant's all own applications,
     * - inherited applications, which do not have the same names as current tenant's own apps.
     * The list is sorted alphabetically by humanized app name and contains up to 2000 items.
     * @returns The list of applications, which can be used in default subscriptions.
     */
    async getSubscribableTenantApps() {
        const currentTenant = (await this.tenantService.current()).data;
        const allApps = (await this.applicationService.listByTenant(null, { pageSize: 2000 })).data;
        const ownApps = allApps.filter(app => app.owner.tenant.id === currentTenant.name);
        const inheritedApps = allApps.filter(app => app.owner.tenant.id !== currentTenant.name);
        const filteredApps = [...ownApps];
        inheritedApps.forEach(inheritedApp => {
            if (!filteredApps.some(filteredApp => filteredApp.name === inheritedApp.name)) {
                filteredApps.push(inheritedApp);
            }
        });
        const filteredAppsWithHumanizedNames = await Promise.all(filteredApps.map(async (app) => {
            const humanizedName = await this.humanizeAppNamePipe
                .transform(app.name)
                .pipe(debounceTime(250), take(1))
                .toPromise();
            return { app, humanizedName };
        }));
        const sortedAppsWithHumanizedNames = sortBy(filteredAppsWithHumanizedNames, ['humanizedName']);
        const sortedApps = sortedAppsWithHumanizedNames.map(({ app }) => app);
        return sortedApps;
    }
    /**
     * Gets the default subscriptions configuration inherited from parent tenant.
     * @returns The default subscriptions object with settings from parent tenant.
     */
    async getDefaultSubscriptionsEvaluatedFromParentTenant() {
        return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.PARENT_TENANT);
    }
    /**
     * Gets the default subscriptions configuration from the current tenant.
     * @returns The default subscriptions object with settings from the current tenant.
     */
    async getDefaultSubscriptionsFromCurrentTenant() {
        return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.CURRENT_TENANT);
    }
    /**
     * Saves given default subscriptions configuration to the current tenant
     * (either sets, updates, or deletes corresponding tenant options).
     * @param defaultSubscriptions The default subscriptions configuration to be saved.
     */
    async saveDefaultSubscriptionsToCurrentTenant(defaultSubscriptions) {
        await this.saveOnCreationSubscriptions(defaultSubscriptions);
        await this.saveOnUpgradeSubscriptions(defaultSubscriptions);
    }
    /**
     * Gets default subscriptions in the context of current or parent tenant.
     * @param contextTenant Tells whether to use current or parent tenant as context.
     */
    async getDefaultSubscriptions(contextTenant) {
        let tenantOptionsParams;
        let overridable;
        switch (contextTenant) {
            case DefaultSubscriptionsContextTenant.CURRENT_TENANT:
                tenantOptionsParams = { evaluate: 'current' };
                overridable = true;
                break;
            case DefaultSubscriptionsContextTenant.PARENT_TENANT:
                tenantOptionsParams = { evaluate: 'inherited' };
                overridable = false;
                break;
        }
        const { onCreationApps, onCreationMicroservices, onUpgradeAppsEnabled, onUpgradeApps, onUpgradeMicroservicesEnabled, onUpgradeMicroservices } = await this.getTenantOptions(tenantOptionsParams);
        const onCreationSubscriptions = this.namesToPartialApps({
            appsNamesStr: onCreationApps,
            microservicesNamesStr: onCreationMicroservices
        });
        const onUpgradeAppsDefault = overridable ? null : onCreationApps;
        const onUpgradeMicroservicesDefault = overridable ? null : onCreationMicroservices;
        const onUpgradeSubscriptions = this.namesToPartialApps({
            appsNamesStr: onUpgradeAppsEnabled ? onUpgradeApps : onUpgradeAppsDefault,
            microservicesNamesStr: onUpgradeMicroservicesEnabled
                ? onUpgradeMicroservices
                : onUpgradeMicroservicesDefault
        });
        const defaultSubscriptions = {
            onCreationSubscriptions,
            onUpgradeSubscriptions
        };
        if (overridable) {
            defaultSubscriptions.overrideOnCreationSubscriptions =
                onCreationApps !== null || onCreationMicroservices !== null;
            defaultSubscriptions.overrideOnUpgradeSubscriptions =
                onUpgradeAppsEnabled || onUpgradeMicroservicesEnabled;
        }
        return defaultSubscriptions;
    }
    async getTenantOptions(params = {}) {
        return {
            onCreationApps: await this.getTenantOption({
                category: 'configuration',
                key: 'default.tenant.applications'
            }, null, params),
            onCreationMicroservices: await this.getTenantOption({
                category: 'configuration',
                key: 'default.tenant.microservices'
            }, null, params),
            onUpgradeAppsEnabled: await this.getTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications.enabled'
            }, false, params),
            onUpgradeApps: await this.getTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications'
            }, null, params),
            onUpgradeMicroservicesEnabled: await this.getTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices.enabled'
            }, false, params),
            onUpgradeMicroservices: await this.getTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices'
            }, null, params)
        };
    }
    async saveOnCreationSubscriptions(defaultSubscriptions) {
        if (defaultSubscriptions.overrideOnCreationSubscriptions) {
            await this.setTenantOption({
                category: 'configuration',
                key: 'default.tenant.applications',
                value: this.partialAppsListToAppsNames(defaultSubscriptions.onCreationSubscriptions)
            });
            await this.setTenantOption({
                category: 'configuration',
                key: 'default.tenant.microservices',
                value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onCreationSubscriptions)
            });
        }
        else {
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'default.tenant.applications'
            });
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'default.tenant.microservices'
            });
        }
    }
    async saveOnUpgradeSubscriptions(defaultSubscriptions) {
        if (defaultSubscriptions.overrideOnUpgradeSubscriptions) {
            await this.setTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications.enabled',
                value: 'true'
            });
            await this.setTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices.enabled',
                value: 'true'
            });
            await this.setTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications',
                value: this.partialAppsListToAppsNames(defaultSubscriptions.onUpgradeSubscriptions)
            });
            await this.setTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices',
                value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onUpgradeSubscriptions)
            });
        }
        else {
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications.enabled'
            });
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices.enabled'
            });
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.applications'
            });
            await this.unsetTenantOption({
                category: 'configuration',
                key: 'on-update.tenant.microservices'
            });
        }
    }
    async getTenantOption(option, defaultValue = null, params = {}) {
        let value;
        try {
            value = (await this.tenantOptionsService.detail(option, params)).data.value;
            value = JSON.parse(value);
        }
        catch (ex) {
            value = !isUndefined(value) ? value : defaultValue;
        }
        return value;
    }
    async setTenantOption(option) {
        return this.tenantOptionsService.update(option);
    }
    async unsetTenantOption(option) {
        try {
            await this.tenantOptionsService.delete(option);
        }
        catch (ex) {
            if (!ex || !ex.res || ex.res.status !== 404) {
                throw ex;
            }
        }
    }
    namesToPartialApps({ appsNamesStr, microservicesNamesStr }) {
        if (appsNamesStr === null && microservicesNamesStr === null) {
            return null;
        }
        return [
            ...(appsNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({ name: name.trim() })),
            ...(microservicesNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({
                name: name.trim(),
                type: ApplicationType.MICROSERVICE
            }))
        ];
    }
    partialAppsListToAppsNames(apps) {
        return apps
            .filter(app => app.type !== ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
    partialAppsToMicroservicesNames(apps) {
        return apps
            .filter(app => app.type === ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
}
DefaultSubscriptionsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DefaultSubscriptionsService, deps: [{ token: i1.ApplicationService }, { token: i1.TenantService }, { token: i1.TenantOptionsService }, { token: i2.HumanizeAppNamePipe }], target: i0.ɵɵFactoryTarget.Injectable });
DefaultSubscriptionsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DefaultSubscriptionsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DefaultSubscriptionsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ApplicationService }, { type: i1.TenantService }, { type: i1.TenantOptionsService }, { type: i2.HumanizeAppNamePipe }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMvZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXBELE9BQU8sRUFFTCxlQUFlLEVBQ2Ysa0JBQWtCLEVBRWxCLGFBQWEsRUFDYixvQkFBb0IsRUFDckIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFMUQsT0FBTyxFQUdMLDJCQUEyQixJQUFJLGlDQUFpQyxFQUNqRSxNQUFNLCtCQUErQixDQUFDOzs7O0FBR3ZDLE1BQU0sT0FBTywyQkFBMkI7SUFDdEMsWUFDVSxrQkFBc0MsRUFDdEMsYUFBNEIsRUFDNUIsb0JBQTBDLEVBQzFDLG1CQUF3QztRQUh4Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtJQUMvQyxDQUFDO0lBRUo7Ozs7OztPQU1HO0lBQ0gsS0FBSyxDQUFDLHlCQUF5QjtRQUM3QixNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUVoRSxNQUFNLE9BQU8sR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxJQUFJLEVB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QUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDakIsSUFBSSxFQUFFLGVBQWUsQ0FBQyxZQUFZO2FBQ25DLENBQUMsQ0FBQztTQUNOLENBQUM7SUFDSixDQUFDO0lBRU8sMEJBQTBCLENBQUMsSUFBcUI7UUFDdEQsT0FBTyxJQUFJO2FBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxlQUFlLENBQUMsWUFBWSxDQUFDO2FBQ3hELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7YUFDcEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsQ0FBQztJQUVPLCtCQUErQixDQUFDLElBQXFCO1FBQzNELE9BQU8sSUFBSTthQUNSLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLFlBQVksQ0FBQzthQUN4RCxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2FBQ3BCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNmLENBQUM7O3dIQXhUVSwyQkFBMkI7NEhBQTNCLDJCQUEyQjsyRkFBM0IsMkJBQTJCO2tCQUR2QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaXNVbmRlZmluZWQsIHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIElBcHBsaWNhdGlvbixcbiAgQXBwbGljYXRpb25UeXBlLFxuICBBcHBsaWNhdGlvblNlcnZpY2UsXG4gIElTeXN0ZW1PcHRpb24sXG4gIFRlbmFudFNlcnZpY2UsXG4gIFRlbmFudE9wdGlvbnNTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEh1bWFuaXplQXBwTmFtZVBpcGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuaW1wb3J0IHtcbiAgUGFydGlhbEFwcHNMaXN0LFxuICBEZWZhdWx0U3Vic2NyaXB0aW9ucyxcbiAgRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0IGFzIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudFxufSBmcm9tICcuL2RlZmF1bHQtc3Vic2NyaXB0aW9ucy5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50U2VydmljZTogVGVuYW50U2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRPcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIGh1bWFuaXplQXBwTmFtZVBpcGU6IEh1bWFuaXplQXBwTmFtZVBpcGVcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsaXN0IG9mIGFwcGxpY2F0aW9ucyB3aGljaCBjYW4gYmUgdXNlZCBpbiBkZWZhdWx0IHN1YnNjcmlwdGlvbnMsIGkuZS46XG4gICAqIC0gY3VycmVudCB0ZW5hbnQncyBhbGwgb3duIGFwcGxpY2F0aW9ucyxcbiAgICogLSBpbmhlcml0ZWQgYXBwbGljYXRpb25zLCB3aGljaCBkbyBub3QgaGF2ZSB0aGUgc2FtZSBuYW1lcyBhcyBjdXJyZW50IHRlbmFudCdzIG93biBhcHBzLlxuICAgKiBUaGUgbGlzdCBpcyBzb3J0ZWQgYWxwaGFiZXRpY2FsbHkgYnkgaHVtYW5pemVkIGFwcCBuYW1lIGFuZCBjb250YWlucyB1cCB0byAyMDAwIGl0ZW1zLlxuICAgKiBAcmV0dXJucyBUaGUgbGlzdCBvZiBhcHBsaWNhdGlvbnMsIHdoaWNoIGNhbiBiZSB1c2VkIGluIGRlZmF1bHQgc3Vic2NyaXB0aW9ucy5cbiAgICovXG4gIGFzeW5jIGdldFN1YnNjcmliYWJsZVRlbmFudEFwcHMoKTogUHJvbWlzZTxJQXBwbGljYXRpb25bXT4ge1xuICAgIGNvbnN0IGN1cnJlbnRUZW5hbnQgPSAoYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmN1cnJlbnQoKSkuZGF0YTtcblxuICAgIGNvbnN0IGFsbEFwcHMgPSAoYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UubGlzdEJ5VGVuYW50KG51bGwsIHsgcGFnZVNpemU6IDIwMDAgfSkpLmRhdGE7XG4gICAgY29uc3Qgb3duQXBwcyA9IGFsbEFwcHMuZmlsdGVyKGFwcCA9PiBhcHAub3duZXIudGVuYW50LmlkID09PSBjdXJyZW50VGVuYW50Lm5hbWUpO1xuICAgIGNvbnN0IGluaGVyaXRlZEFwcHMgPSBhbGxBcHBzLmZpbHRlcihhcHAgPT4gYXBwLm93bmVyLnRlbmFudC5pZCAhPT0gY3VycmVudFRlbmFudC5uYW1lKTtcblxuICAgIGNvbnN0IGZpbHRlcmVkQXBwczogSUFwcGxpY2F0aW9uW10gPSBbLi4ub3duQXBwc107XG4gICAgaW5oZXJpdGVkQXBwcy5mb3JFYWNoKGluaGVyaXRlZEFwcCA9PiB7XG4gICAgICBpZiAoIWZpbHRlcmVkQXBwcy5zb21lKGZpbHRlcmVkQXBwID0+IGZpbHRlcmVkQXBwLm5hbWUgPT09IGluaGVyaXRlZEFwcC5uYW1lKSkge1xuICAgICAgICBmaWx0ZXJlZEFwcHMucHVzaChpbmhlcml0ZWRBcHApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgZmlsdGVyZWRBcHBzV2l0aEh1bWFuaXplZE5hbWVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBmaWx0ZXJlZEFwcHMubWFwKGFzeW5jIGFwcCA9PiB7XG4gICAgICAgIGNvbnN0IGh1bWFuaXplZE5hbWUgPSBhd2FpdCB0aGlzLmh1bWFuaXplQXBwTmFtZVBpcGVcbiAgICAgICAgICAudHJhbnNmb3JtKGFwcC5uYW1lKVxuICAgICAgICAgIC5waXBlKGRlYm91bmNlVGltZSgyNTApLCB0YWtlKDEpKVxuICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICAgICAgcmV0dXJuIHsgYXBwLCBodW1hbml6ZWROYW1lIH07XG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3Qgc29ydGVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcyA9IHNvcnRCeShmaWx0ZXJlZEFwcHNXaXRoSHVtYW5pemVkTmFtZXMsIFsnaHVtYW5pemVkTmFtZSddKTtcbiAgICBjb25zdCBzb3J0ZWRBcHBzID0gc29ydGVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcy5tYXAoKHsgYXBwIH0pID0+IGFwcCk7XG5cbiAgICByZXR1cm4gc29ydGVkQXBwcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiBpbmhlcml0ZWQgZnJvbSBwYXJlbnQgdGVuYW50LlxuICAgKiBAcmV0dXJucyBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIG9iamVjdCB3aXRoIHNldHRpbmdzIGZyb20gcGFyZW50IHRlbmFudC5cbiAgICovXG4gIGFzeW5jIGdldERlZmF1bHRTdWJzY3JpcHRpb25zRXZhbHVhdGVkRnJvbVBhcmVudFRlbmFudCgpOiBQcm9taXNlPERlZmF1bHRTdWJzY3JpcHRpb25zPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnMoRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LlBBUkVOVF9URU5BTlQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIGZyb20gdGhlIGN1cnJlbnQgdGVuYW50LlxuICAgKiBAcmV0dXJucyBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIG9iamVjdCB3aXRoIHNldHRpbmdzIGZyb20gdGhlIGN1cnJlbnQgdGVuYW50LlxuICAgKi9cbiAgYXN5bmMgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNGcm9tQ3VycmVudFRlbmFudCgpOiBQcm9taXNlPERlZmF1bHRTdWJzY3JpcHRpb25zPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnMoRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LkNVUlJFTlRfVEVOQU5UKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlcyBnaXZlbiBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiB0byB0aGUgY3VycmVudCB0ZW5hbnRcbiAgICogKGVpdGhlciBzZXRzLCB1cGRhdGVzLCBvciBkZWxldGVzIGNvcnJlc3BvbmRpbmcgdGVuYW50IG9wdGlvbnMpLlxuICAgKiBAcGFyYW0gZGVmYXVsdFN1YnNjcmlwdGlvbnMgVGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIHRvIGJlIHNhdmVkLlxuICAgKi9cbiAgYXN5bmMgc2F2ZURlZmF1bHRTdWJzY3JpcHRpb25zVG9DdXJyZW50VGVuYW50KGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucykge1xuICAgIGF3YWl0IHRoaXMuc2F2ZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zKTtcbiAgICBhd2FpdCB0aGlzLnNhdmVPblVwZ3JhZGVTdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBjdXJyZW50IG9yIHBhcmVudCB0ZW5hbnQuXG4gICAqIEBwYXJhbSBjb250ZXh0VGVuYW50IFRlbGxzIHdoZXRoZXIgdG8gdXNlIGN1cnJlbnQgb3IgcGFyZW50IHRlbmFudCBhcyBjb250ZXh0LlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXREZWZhdWx0U3Vic2NyaXB0aW9ucyhcbiAgICBjb250ZXh0VGVuYW50OiBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnRcbiAgKTogUHJvbWlzZTxEZWZhdWx0U3Vic2NyaXB0aW9ucz4ge1xuICAgIGxldCB0ZW5hbnRPcHRpb25zUGFyYW1zOiBvYmplY3Q7XG4gICAgbGV0IG92ZXJyaWRhYmxlOiBib29sZWFuO1xuXG4gICAgc3dpdGNoIChjb250ZXh0VGVuYW50KSB7XG4gICAgICBjYXNlIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5DVVJSRU5UX1RFTkFOVDpcbiAgICAgICAgdGVuYW50T3B0aW9uc1BhcmFtcyA9IHsgZXZhbHVhdGU6ICdjdXJyZW50JyB9O1xuICAgICAgICBvdmVycmlkYWJsZSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5QQVJFTlRfVEVOQU5UOlxuICAgICAgICB0ZW5hbnRPcHRpb25zUGFyYW1zID0geyBldmFsdWF0ZTogJ2luaGVyaXRlZCcgfTtcbiAgICAgICAgb3ZlcnJpZGFibGUgPSBmYWxzZTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgb25DcmVhdGlvbkFwcHMsXG4gICAgICBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlcyxcbiAgICAgIG9uVXBncmFkZUFwcHNFbmFibGVkLFxuICAgICAgb25VcGdyYWRlQXBwcyxcbiAgICAgIG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlc1xuICAgIH0gPSBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbnModGVuYW50T3B0aW9uc1BhcmFtcyk7XG5cbiAgICBjb25zdCBvbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyA9IHRoaXMubmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICAgIGFwcHNOYW1lc1N0cjogb25DcmVhdGlvbkFwcHMsXG4gICAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHI6IG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzXG4gICAgfSk7XG5cbiAgICBjb25zdCBvblVwZ3JhZGVBcHBzRGVmYXVsdCA9IG92ZXJyaWRhYmxlID8gbnVsbCA6IG9uQ3JlYXRpb25BcHBzO1xuICAgIGNvbnN0IG9uVXBncmFkZU1pY3Jvc2VydmljZXNEZWZhdWx0ID0gb3ZlcnJpZGFibGUgPyBudWxsIDogb25DcmVhdGlvbk1pY3Jvc2VydmljZXM7XG4gICAgY29uc3Qgb25VcGdyYWRlU3Vic2NyaXB0aW9ucyA9IHRoaXMubmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICAgIGFwcHNOYW1lc1N0cjogb25VcGdyYWRlQXBwc0VuYWJsZWQgPyBvblVwZ3JhZGVBcHBzIDogb25VcGdyYWRlQXBwc0RlZmF1bHQsXG4gICAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHI6IG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkXG4gICAgICAgID8gb25VcGdyYWRlTWljcm9zZXJ2aWNlc1xuICAgICAgICA6IG9uVXBncmFkZU1pY3Jvc2VydmljZXNEZWZhdWx0XG4gICAgfSk7XG5cbiAgICBjb25zdCBkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMgPSB7XG4gICAgICBvbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyxcbiAgICAgIG9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICB9O1xuXG4gICAgaWYgKG92ZXJyaWRhYmxlKSB7XG4gICAgICBkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zID1cbiAgICAgICAgb25DcmVhdGlvbkFwcHMgIT09IG51bGwgfHwgb25DcmVhdGlvbk1pY3Jvc2VydmljZXMgIT09IG51bGw7XG4gICAgICBkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMgPVxuICAgICAgICBvblVwZ3JhZGVBcHBzRW5hYmxlZCB8fCBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmYXVsdFN1YnNjcmlwdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRlbmFudE9wdGlvbnMocGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4ge1xuICAgICAgb25DcmVhdGlvbkFwcHM6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICAgIH0sXG4gICAgICAgIG51bGwsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlQXBwc0VuYWJsZWQ6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucy5lbmFibGVkJ1xuICAgICAgICB9LFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlQXBwczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zJ1xuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZDogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcy5lbmFibGVkJ1xuICAgICAgICB9LFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2F2ZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucykge1xuICAgIGlmIChkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50LmFwcGxpY2F0aW9ucycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzTGlzdFRvQXBwc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50Lm1pY3Jvc2VydmljZXMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc1RvTWljcm9zZXJ2aWNlc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5taWNyb3NlcnZpY2VzJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYXZlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyhkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMpIHtcbiAgICBpZiAoZGVmYXVsdFN1YnNjcmlwdGlvbnMub3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zLmVuYWJsZWQnLFxuICAgICAgICB2YWx1ZTogJ3RydWUnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzLmVuYWJsZWQnLFxuICAgICAgICB2YWx1ZTogJ3RydWUnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc0xpc3RUb0FwcHNOYW1lcyhkZWZhdWx0U3Vic2NyaXB0aW9ucy5vblVwZ3JhZGVTdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzVG9NaWNyb3NlcnZpY2VzTmFtZXMoZGVmYXVsdFN1YnNjcmlwdGlvbnMub25VcGdyYWRlU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMuZW5hYmxlZCdcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcy5lbmFibGVkJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRlbmFudE9wdGlvbihvcHRpb246IElTeXN0ZW1PcHRpb24sIGRlZmF1bHRWYWx1ZSA9IG51bGwsIHBhcmFtcyA9IHt9KSB7XG4gICAgbGV0IHZhbHVlO1xuICAgIHRyeSB7XG4gICAgICB2YWx1ZSA9IChhd2FpdCB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRldGFpbChvcHRpb24sIHBhcmFtcykpLmRhdGEudmFsdWU7XG4gICAgICB2YWx1ZSA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB2YWx1ZSA9ICFpc1VuZGVmaW5lZCh2YWx1ZSkgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZXRUZW5hbnRPcHRpb24ob3B0aW9uOiBJU3lzdGVtT3B0aW9uKSB7XG4gICAgcmV0dXJuIHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UudXBkYXRlKG9wdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVuc2V0VGVuYW50T3B0aW9uKG9wdGlvbjogSVN5c3RlbU9wdGlvbikge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRlbGV0ZShvcHRpb24pO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBpZiAoIWV4IHx8ICFleC5yZXMgfHwgZXgucmVzLnN0YXR1cyAhPT0gNDA0KSB7XG4gICAgICAgIHRocm93IGV4O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICBhcHBzTmFtZXNTdHIsXG4gICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyXG4gIH06IHtcbiAgICBhcHBzTmFtZXNTdHI/OiBzdHJpbmc7XG4gICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyPzogc3RyaW5nO1xuICB9KTogUGFydGlhbEFwcHNMaXN0IHtcbiAgICBpZiAoYXBwc05hbWVzU3RyID09PSBudWxsICYmIG1pY3Jvc2VydmljZXNOYW1lc1N0ciA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLihhcHBzTmFtZXNTdHIgfHwgJycpXG4gICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgIC5maWx0ZXIobmFtZSA9PiBuYW1lLmxlbmd0aClcbiAgICAgICAgLm1hcChuYW1lID0+ICh7IG5hbWU6IG5hbWUudHJpbSgpIH0pKSxcbiAgICAgIC4uLihtaWNyb3NlcnZpY2VzTmFtZXNTdHIgfHwgJycpXG4gICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgIC5maWx0ZXIobmFtZSA9PiBuYW1lLmxlbmd0aClcbiAgICAgICAgLm1hcChuYW1lID0+ICh7XG4gICAgICAgICAgbmFtZTogbmFtZS50cmltKCksXG4gICAgICAgICAgdHlwZTogQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRVxuICAgICAgICB9KSlcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJ0aWFsQXBwc0xpc3RUb0FwcHNOYW1lcyhhcHBzOiBQYXJ0aWFsQXBwc0xpc3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBhcHBzXG4gICAgICAuZmlsdGVyKGFwcCA9PiBhcHAudHlwZSAhPT0gQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRSlcbiAgICAgIC5tYXAoYXBwID0+IGFwcC5uYW1lKVxuICAgICAgLmpvaW4oJywnKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFydGlhbEFwcHNUb01pY3Jvc2VydmljZXNOYW1lcyhhcHBzOiBQYXJ0aWFsQXBwc0xpc3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBhcHBzXG4gICAgICAuZmlsdGVyKGFwcCA9PiBhcHAudHlwZSA9PT0gQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRSlcbiAgICAgIC5tYXAoYXBwID0+IGFwcC5uYW1lKVxuICAgICAgLmpvaW4oJywnKTtcbiAgfVxufVxuIl19