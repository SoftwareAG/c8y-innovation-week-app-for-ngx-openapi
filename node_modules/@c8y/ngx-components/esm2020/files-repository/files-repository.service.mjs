import { Injectable } from '@angular/core';
import { QueriesUtil } from '@c8y/client';
import { InventoryService } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { transform, has } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
export class FilesRepositoryService {
    constructor(inventoryService) {
        this.inventoryService = inventoryService;
        this.baseQuery = { __has: 'c8y_IsBinary' };
        this.queriesUtil = new QueriesUtil();
    }
    getPagination() {
        return {
            pageSize: 10,
            currentPage: 1
        };
    }
    hasApplicationStorageFragment(file) {
        return has(file, 'c8y_applications_storage');
    }
    getColumns() {
        return [
            {
                name: 'name',
                header: gettext('Name'),
                path: 'name',
                filterable: true,
                sortable: true,
                sortOrder: 'asc'
            },
            {
                name: 'type',
                header: gettext('Type'),
                path: 'type',
                filterable: true,
                sortable: true
            },
            {
                name: 'length',
                header: gettext('Size'),
                path: 'length',
                filterable: false,
                sortable: true
            },
            {
                name: 'owner',
                header: gettext('Owner'),
                path: 'owner',
                filterable: true,
                sortable: true
            },
            {
                name: 'lastUpdated',
                header: gettext('Last update'),
                path: 'lastUpdated',
                filterable: false,
                sortable: true
            }
        ];
    }
    /** Returns array with items id where item has not c8y_applications_storage fragment. */
    getDeletableItemsIds(selectedItemsIds, dataFromDataGrid) {
        const selectedItemsWithoutApplications = [];
        dataFromDataGrid.forEach(item => {
            selectedItemsIds.forEach(selectedItemId => {
                if (selectedItemId === item.id && !this.hasApplicationStorageFragment(item)) {
                    selectedItemsWithoutApplications.push(selectedItemId);
                }
            });
        });
        return selectedItemsWithoutApplications;
    }
    /** Returns the total number of items (with no filters based on columns setup). */
    async getTotal() {
        const filters = {
            query: this.queriesUtil.buildQuery(this.baseQuery),
            pageSize: 1,
            withTotalPages: true
        };
        return (await this.inventoryService.list(filters)).paging.totalPages;
    }
    /** Returns data for current columns and pagination setup. */
    async getData(columns, pagination, searchText = '') {
        // build filters based on columns and pagination
        const filters = {
            text: searchText,
            ...this.getFilters(columns, pagination)
        };
        // execute inventory query for the list of managed objects
        return this.inventoryService.list(filters);
    }
    /** Returns the number of items matching current columns and pagination setup. */
    async getCount(columns, pagination) {
        const filters = {
            // build filters based on columns and pagination
            ...this.getFilters(columns, pagination),
            // but we only need the number of items, not the items themselves
            pageSize: 1,
            currentPage: 1
        };
        return (await this.inventoryService.list(filters)).paging.totalPages;
    }
    /** Returns filters for given columns and pagination setup. */
    getFilters(columns, pagination) {
        return {
            query: this.getQueryString(columns),
            pageSize: pagination.pageSize,
            currentPage: pagination.currentPage,
            withChildren: false,
            withTotalPages: true
        };
    }
    /** Returns a query string based on columns setup. */
    getQueryString(columns) {
        let fullQuery = this.getQueryObj(columns);
        fullQuery = this.queriesUtil.addAndFilter(fullQuery, this.baseQuery);
        return this.queriesUtil.buildQuery(fullQuery);
    }
    /** Returns a query object based on columns setup. */
    getQueryObj(columns) {
        return transform(columns, (query, column) => this.addColumnQuery(query, column), {
            __filter: {},
            __orderby: []
        });
    }
    /** Extends given query with a part based on the setup of given column. */
    addColumnQuery(query, column) {
        // when a column is marked as filterable
        if (column.filterable) {
            // in the case of default filtering form, `filterPredicate` will contain the string entered by a user
            if (column.filterPredicate) {
                // so we use it as the expected value, * allow to search for it anywhere in the property
                query.__filter[column.path] = `*${column.filterPredicate}*`;
            }
            // in the case of custom filtering form, we're storing the query in `externalFilterQuery.query`
            if (column.externalFilterQuery) {
                query = this.queriesUtil.addAndFilter(query, column.externalFilterQuery.query);
            }
        }
        // when a column is sortable and has a specified sorting order
        if (column.sortable && column.sortOrder) {
            // add sorting condition for the configured column `path`
            query.__orderby.push({
                [column.path]: column.sortOrder === 'asc' ? 1 : -1
            });
        }
        return query;
    }
}
FilesRepositoryService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilesRepositoryService, deps: [{ token: i1.InventoryService }], target: i0.ɵɵFactoryTarget.Injectable });
FilesRepositoryService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilesRepositoryService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: FilesRepositoryService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.InventoryService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZXMtcmVwb3NpdG9yeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZmlsZXMtcmVwb3NpdG9yeS9maWxlcy1yZXBvc2l0b3J5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvQyxPQUFPLEVBQUUsT0FBTyxFQUFzQyxNQUFNLHFCQUFxQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7QUFLM0MsTUFBTSxPQUFPLHNCQUFzQjtJQUdqQyxZQUFvQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUR0RCxjQUFTLEdBQUcsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUM7UUFFcEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxhQUFhO1FBQ1gsT0FBTztZQUNMLFFBQVEsRUFBRSxFQUFFO1lBQ1osV0FBVyxFQUFFLENBQUM7U0FDZixDQUFDO0lBQ0osQ0FBQztJQUVELDZCQUE2QixDQUFDLElBQVM7UUFDckMsT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLDBCQUEwQixDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELFVBQVU7UUFDUixPQUFPO1lBQ0w7Z0JBQ0UsSUFBSSxFQUFFLE1BQU07Z0JBQ1osTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZCLElBQUksRUFBRSxNQUFNO2dCQUNaLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixRQUFRLEVBQUUsSUFBSTtnQkFDZCxTQUFTLEVBQUUsS0FBa0I7YUFDOUI7WUFDRDtnQkFD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QUFNLENBQUMsbUJBQW1CLEVBQUU7Z0JBQzlCLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2hGO1NBQ0Y7UUFFRCw4REFBOEQ7UUFDOUQsSUFBSSxNQUFNLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDdkMseURBQXlEO1lBQ3pELEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO2dCQUNuQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDbkQsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O21IQTlKVSxzQkFBc0I7dUhBQXRCLHNCQUFzQixjQUZyQixNQUFNOzJGQUVQLHNCQUFzQjtrQkFIbEMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBRdWVyaWVzVXRpbCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEludmVudG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBnZXR0ZXh0LCBQYWdpbmF0aW9uLCBTb3J0T3JkZXIsIENvbHVtbiwgUm93IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyB0cmFuc2Zvcm0sIGhhcyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEZpbGVzUmVwb3NpdG9yeVNlcnZpY2Uge1xuICBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG4gIGJhc2VRdWVyeSA9IHsgX19oYXM6ICdjOHlfSXNCaW5hcnknIH07XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSkge1xuICAgIHRoaXMucXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgfVxuXG4gIGdldFBhZ2luYXRpb24oKTogUGFnaW5hdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhZ2VTaXplOiAxMCxcbiAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgfTtcbiAgfVxuXG4gIGhhc0FwcGxpY2F0aW9uU3RvcmFnZUZyYWdtZW50KGZpbGU6IFJvdyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBoYXMoZmlsZSwgJ2M4eV9hcHBsaWNhdGlvbnNfc3RvcmFnZScpO1xuICB9XG5cbiAgZ2V0Q29sdW1ucygpOiBDb2x1bW5bXSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ25hbWUnLFxuICAgICAgICBoZWFkZXI6IGdldHRleHQoJ05hbWUnKSxcbiAgICAgICAgcGF0aDogJ25hbWUnLFxuICAgICAgICBmaWx0ZXJhYmxlOiB0cnVlLFxuICAgICAgICBzb3J0YWJsZTogdHJ1ZSxcbiAgICAgICAgc29ydE9yZGVyOiAnYXNjJyBhcyBTb3J0T3JkZXJcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICd0eXBlJyxcbiAgICAgICAgaGVhZGVyOiBnZXR0ZXh0KCdUeXBlJyksXG4gICAgICAgIHBhdGg6ICd0eXBlJyxcbiAgICAgICAgZmlsdGVyYWJsZTogdHJ1ZSxcbiAgICAgICAgc29ydGFibGU6IHRydWVcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdsZW5ndGgnLFxuICAgICAgICBoZWFkZXI6IGdldHRleHQoJ1NpemUnKSxcbiAgICAgICAgcGF0aDogJ2xlbmd0aCcsXG4gICAgICAgIGZpbHRlcmFibGU6IGZhbHNlLFxuICAgICAgICBzb3J0YWJsZTogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ293bmVyJyxcbiAgICAgICAgaGVhZGVyOiBnZXR0ZXh0KCdPd25lcicpLFxuICAgICAgICBwYXRoOiAnb3duZXInLFxuICAgICAgICBmaWx0ZXJhYmxlOiB0cnVlLFxuICAgICAgICBzb3J0YWJsZTogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ2xhc3RVcGRhdGVkJyxcbiAgICAgICAgaGVhZGVyOiBnZXR0ZXh0KCdMYXN0IHVwZGF0ZScpLFxuICAgICAgICBwYXRoOiAnbGFzdFVwZGF0ZWQnLFxuICAgICAgICBmaWx0ZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgc29ydGFibGU6IHRydWVcbiAgICAgIH1cbiAgICBdO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYXJyYXkgd2l0aCBpdGVtcyBpZCB3aGVyZSBpdGVtIGhhcyBub3QgYzh5X2FwcGxpY2F0aW9uc19zdG9yYWdlIGZyYWdtZW50LiAqL1xuICBnZXREZWxldGFibGVJdGVtc0lkcyhzZWxlY3RlZEl0ZW1zSWRzOiBzdHJpbmdbXSwgZGF0YUZyb21EYXRhR3JpZDogQXJyYXk8YW55Pik6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBzZWxlY3RlZEl0ZW1zV2l0aG91dEFwcGxpY2F0aW9ucyA9IFtdO1xuICAgIGRhdGFGcm9tRGF0YUdyaWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIHNlbGVjdGVkSXRlbXNJZHMuZm9yRWFjaChzZWxlY3RlZEl0ZW1JZCA9PiB7XG4gICAgICAgIGlmIChzZWxlY3RlZEl0ZW1JZCA9PT0gaXRlbS5pZCAmJiAhdGhpcy5oYXNBcHBsaWNhdGlvblN0b3JhZ2VGcmFnbWVudChpdGVtKSkge1xuICAgICAgICAgIHNlbGVjdGVkSXRlbXNXaXRob3V0QXBwbGljYXRpb25zLnB1c2goc2VsZWN0ZWRJdGVtSWQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBzZWxlY3RlZEl0ZW1zV2l0aG91dEFwcGxpY2F0aW9ucztcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIHRoZSB0b3RhbCBudW1iZXIgb2YgaXRlbXMgKHdpdGggbm8gZmlsdGVycyBiYXNlZCBvbiBjb2x1bW5zIHNldHVwKS4gKi9cbiAgYXN5bmMgZ2V0VG90YWwoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgcXVlcnk6IHRoaXMucXVlcmllc1V0aWwuYnVpbGRRdWVyeSh0aGlzLmJhc2VRdWVyeSksXG4gICAgICBwYWdlU2l6ZTogMSxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlXG4gICAgfTtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0KGZpbHRlcnMpKS5wYWdpbmcudG90YWxQYWdlcztcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGRhdGEgZm9yIGN1cnJlbnQgY29sdW1ucyBhbmQgcGFnaW5hdGlvbiBzZXR1cC4gKi9cbiAgYXN5bmMgZ2V0RGF0YShjb2x1bW5zOiBDb2x1bW5bXSwgcGFnaW5hdGlvbjogUGFnaW5hdGlvbiwgc2VhcmNoVGV4dCA9ICcnKSB7XG4gICAgLy8gYnVpbGQgZmlsdGVycyBiYXNlZCBvbiBjb2x1bW5zIGFuZCBwYWdpbmF0aW9uXG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIHRleHQ6IHNlYXJjaFRleHQsXG4gICAgICAuLi50aGlzLmdldEZpbHRlcnMoY29sdW1ucywgcGFnaW5hdGlvbilcbiAgICB9O1xuICAgIC8vIGV4ZWN1dGUgaW52ZW50b3J5IHF1ZXJ5IGZvciB0aGUgbGlzdCBvZiBtYW5hZ2VkIG9iamVjdHNcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdChmaWx0ZXJzKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgaXRlbXMgbWF0Y2hpbmcgY3VycmVudCBjb2x1bW5zIGFuZCBwYWdpbmF0aW9uIHNldHVwLiAqL1xuICBhc3luYyBnZXRDb3VudChjb2x1bW5zOiBDb2x1bW5bXSwgcGFnaW5hdGlvbjogUGFnaW5hdGlvbikge1xuICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICAvLyBidWlsZCBmaWx0ZXJzIGJhc2VkIG9uIGNvbHVtbnMgYW5kIHBhZ2luYXRpb25cbiAgICAgIC4uLnRoaXMuZ2V0RmlsdGVycyhjb2x1bW5zLCBwYWdpbmF0aW9uKSxcbiAgICAgIC8vIGJ1dCB3ZSBvbmx5IG5lZWQgdGhlIG51bWJlciBvZiBpdGVtcywgbm90IHRoZSBpdGVtcyB0aGVtc2VsdmVzXG4gICAgICBwYWdlU2l6ZTogMSxcbiAgICAgIGN1cnJlbnRQYWdlOiAxXG4gICAgfTtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0KGZpbHRlcnMpKS5wYWdpbmcudG90YWxQYWdlcztcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGZpbHRlcnMgZm9yIGdpdmVuIGNvbHVtbnMgYW5kIHBhZ2luYXRpb24gc2V0dXAuICovXG4gIHByaXZhdGUgZ2V0RmlsdGVycyhjb2x1bW5zOiBDb2x1bW5bXSwgcGFnaW5hdGlvbjogUGFnaW5hdGlvbikge1xuICAgIHJldHVybiB7XG4gICAgICBxdWVyeTogdGhpcy5nZXRRdWVyeVN0cmluZyhjb2x1bW5zKSxcbiAgICAgIHBhZ2VTaXplOiBwYWdpbmF0aW9uLnBhZ2VTaXplLFxuICAgICAgY3VycmVudFBhZ2U6IHBhZ2luYXRpb24uY3VycmVudFBhZ2UsXG4gICAgICB3aXRoQ2hpbGRyZW46IGZhbHNlLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWVcbiAgICB9O1xuICB9XG5cbiAgLyoqIFJldHVybnMgYSBxdWVyeSBzdHJpbmcgYmFzZWQgb24gY29sdW1ucyBzZXR1cC4gKi9cbiAgcHJpdmF0ZSBnZXRRdWVyeVN0cmluZyhjb2x1bW5zOiBDb2x1bW5bXSk6IHN0cmluZyB7XG4gICAgbGV0IGZ1bGxRdWVyeSA9IHRoaXMuZ2V0UXVlcnlPYmooY29sdW1ucyk7XG4gICAgZnVsbFF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIoZnVsbFF1ZXJ5LCB0aGlzLmJhc2VRdWVyeSk7XG4gICAgcmV0dXJuIHRoaXMucXVlcmllc1V0aWwuYnVpbGRRdWVyeShmdWxsUXVlcnkpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYSBxdWVyeSBvYmplY3QgYmFzZWQgb24gY29sdW1ucyBzZXR1cC4gKi9cbiAgcHJpdmF0ZSBnZXRRdWVyeU9iaihjb2x1bW5zOiBDb2x1bW5bXSkge1xuICAgIHJldHVybiB0cmFuc2Zvcm0oY29sdW1ucywgKHF1ZXJ5LCBjb2x1bW4pID0+IHRoaXMuYWRkQ29sdW1uUXVlcnkocXVlcnksIGNvbHVtbiksIHtcbiAgICAgIF9fZmlsdGVyOiB7fSxcbiAgICAgIF9fb3JkZXJieTogW11cbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBFeHRlbmRzIGdpdmVuIHF1ZXJ5IHdpdGggYSBwYXJ0IGJhc2VkIG9uIHRoZSBzZXR1cCBvZiBnaXZlbiBjb2x1bW4uICovXG4gIHByaXZhdGUgYWRkQ29sdW1uUXVlcnkocXVlcnksIGNvbHVtbjogQ29sdW1uKTogdm9pZCB7XG4gICAgLy8gd2hlbiBhIGNvbHVtbiBpcyBtYXJrZWQgYXMgZmlsdGVyYWJsZVxuICAgIGlmIChjb2x1bW4uZmlsdGVyYWJsZSkge1xuICAgICAgLy8gaW4gdGhlIGNhc2Ugb2YgZGVmYXVsdCBmaWx0ZXJpbmcgZm9ybSwgYGZpbHRlclByZWRpY2F0ZWAgd2lsbCBjb250YWluIHRoZSBzdHJpbmcgZW50ZXJlZCBieSBhIHVzZXJcbiAgICAgIGlmIChjb2x1bW4uZmlsdGVyUHJlZGljYXRlKSB7XG4gICAgICAgIC8vIHNvIHdlIHVzZSBpdCBhcyB0aGUgZXhwZWN0ZWQgdmFsdWUsICogYWxsb3cgdG8gc2VhcmNoIGZvciBpdCBhbnl3aGVyZSBpbiB0aGUgcHJvcGVydHlcbiAgICAgICAgcXVlcnkuX19maWx0ZXJbY29sdW1uLnBhdGhdID0gYCoke2NvbHVtbi5maWx0ZXJQcmVkaWNhdGV9KmA7XG4gICAgICB9XG5cbiAgICAgIC8vIGluIHRoZSBjYXNlIG9mIGN1c3RvbSBmaWx0ZXJpbmcgZm9ybSwgd2UncmUgc3RvcmluZyB0aGUgcXVlcnkgaW4gYGV4dGVybmFsRmlsdGVyUXVlcnkucXVlcnlgXG4gICAgICBpZiAoY29sdW1uLmV4dGVybmFsRmlsdGVyUXVlcnkpIHtcbiAgICAgICAgcXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihxdWVyeSwgY29sdW1uLmV4dGVybmFsRmlsdGVyUXVlcnkucXVlcnkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdoZW4gYSBjb2x1bW4gaXMgc29ydGFibGUgYW5kIGhhcyBhIHNwZWNpZmllZCBzb3J0aW5nIG9yZGVyXG4gICAgaWYgKGNvbHVtbi5zb3J0YWJsZSAmJiBjb2x1bW4uc29ydE9yZGVyKSB7XG4gICAgICAvLyBhZGQgc29ydGluZyBjb25kaXRpb24gZm9yIHRoZSBjb25maWd1cmVkIGNvbHVtbiBgcGF0aGBcbiAgICAgIHF1ZXJ5Ll9fb3JkZXJieS5wdXNoKHtcbiAgICAgICAgW2NvbHVtbi5wYXRoXTogY29sdW1uLnNvcnRPcmRlciA9PT0gJ2FzYycgPyAxIDogLTFcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBxdWVyeTtcbiAgfVxufVxuIl19