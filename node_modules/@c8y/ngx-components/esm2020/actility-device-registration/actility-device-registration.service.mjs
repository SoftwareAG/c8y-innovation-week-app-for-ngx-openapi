import { Injectable } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { FetchClient, ApplicationService, InventoryService } from '@c8y/client';
import { AppStateService, gettext, OptionsService } from '@c8y/ngx-components';
import { some } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@ngx-translate/core";
import * as i3 from "@c8y/ngx-components";
export var ErrorName;
(function (ErrorName) {
    ErrorName["NoConnectivityPlansError"] = "NoConnectivityPlansError";
    ErrorName["NoFreeSlotsInConnectivityPlansError"] = "NoFreeSlotsInConnectivityPlansError";
    ErrorName["NoConnectivitySettingsError"] = "NoConnectivitySettingsError";
    ErrorName["ConnectivitySettingsError"] = "ConnectivitySettingsError";
    ErrorName["NoDeviceProfilesError"] = "NoDeviceProfilesError";
    ErrorName["DeviceProfilesFetchError"] = "DeviceProfilesFetchError";
    ErrorName["NoDeviceProtocolsError"] = "NoDeviceProtocolsError";
    ErrorName["DeviceProtocolsFetchError"] = "DeviceProtocolsFetchError";
    ErrorName["RegistrationError"] = "RegistrationError";
})(ErrorName || (ErrorName = {}));
export class ActilityDeviceRegistrationService {
    constructor(inventoryService, client, translateService, applicationService, optionsService, appState) {
        this.inventoryService = inventoryService;
        this.client = client;
        this.translateService = translateService;
        this.applicationService = applicationService;
        this.optionsService = optionsService;
        this.appState = appState;
        this.baseUrl = '/service/actility';
        this.registrationUrl = `${this.baseUrl}/newDeviceRequest`;
        this.connectivityPlansUrl = `${this.baseUrl}/connectivityPlans`;
        this.deviceProfilesUrl = `${this.baseUrl}/deviceProfiles`;
        this.headers = {
            'Content-Type': 'application/json'
        };
    }
    async getConnections() {
        const options = {
            method: 'GET',
            headers: this.headers
        };
        const res = await this.client.fetch(`${this.baseUrl}/lns-connection`, options);
        const data = await res.json();
        if (res.status === 200) {
            if (data.length === 0) {
                await this.throwNoConnectivitySettingsError();
            }
        }
        else {
            await this.throwConnectivitySettingsError(data);
        }
        return { res, data };
    }
    /**
     * Gets connectivity plans from LoRa platform.
     * @param connectionName The name of connection for which connectivity plans will be retrieved
     * @returns The result list with connectivity plans, or throws an error with exception.
     */
    async getConnectivityPlans(connectionName) {
        const options = {
            method: 'GET',
            headers: this.headers,
            params: {
                actilityConnectionName: connectionName
            }
        };
        const res = await this.client.fetch(this.connectivityPlansUrl, options);
        const data = await res.json();
        if (res.status === 200) {
            if (data.length === 0) {
                this.throwNoConnectivityPlansError();
            }
            else {
                if (!this.hasAvailableConnections(data)) {
                    this.throwNoFreeSlotsInConnectivityPlansError();
                }
            }
        }
        else {
            await this.throwConnectivitySettingsError(data);
        }
        return { res, data };
    }
    /**
     * Gets the device profiles from LoRa platform.
     * @param connectionName The name of connection for which device profiles will be retrieved
     * @returns The result list with device profiles, or throws an error with exception.
     */
    async getDeviceProfiles(connectionName) {
        const options = {
            method: 'GET',
            headers: this.headers,
            params: {
                actilityConnectionName: connectionName
            }
        };
        const res = await this.client.fetch(this.deviceProfilesUrl, options);
        const data = await res.json();
        if (res.status === 200) {
            if (data.length === 0) {
                this.throwNoDeviceProfilesError();
            }
        }
        else {
            this.throwDeviceProfilesFetchError();
        }
        return { res, data };
    }
    /**
     * Gets the device protocols
     */
    async getDeviceProtocols(filter = { withTotalPages: true }) {
        const query = {
            __filter: {
                __and: [
                    { __has: 'c8y_IsDeviceType' },
                    {
                        type: { __in: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType', 'c8y_LpwanDeviceType'] }
                    }
                ]
            },
            __orderby: [{ name: 1 }]
        };
        const deviceProtocolsList = await this.inventoryService.listQuery(query, filter);
        const { res, data } = deviceProtocolsList;
        if (res.status === 200) {
            if (data.length === 0) {
                this.throwNoDeviceProtocolsError();
            }
        }
        else {
            this.throwDeviceProtocolsFetchError();
        }
        return deviceProtocolsList;
    }
    /**
     * Creates device registration
     */
    async register(registration) {
        const options = {
            method: 'POST',
            headers: this.headers,
            body: JSON.stringify(registration)
        };
        const res = await this.client.fetch(this.registrationUrl, options);
        const data = await res.json();
        if (res.status !== 201) {
            this.throwRegistrationError(data);
        }
        return { res, data };
    }
    /**
     * checks if used connections is less then granted connections
     */
    hasAvailableConnections(connectivityPlans) {
        return some(connectivityPlans, plan => parseInt(plan.grantedConnections, 10) > parseInt(plan.usedConnections, 10));
    }
    async throwNoConnectivitySettingsError() {
        const error = new Error();
        error.name = ErrorName.NoConnectivitySettingsError;
        if (await this.appState.isApplicationAvailable('administration')) {
            error.message = this.translateService.instant(gettext(`Could not get connectivity plans from the LoRa platform. Verify the ThingPark credentials in the Administration application under <a href="{{ link }}">Settings</a>.`), {
                link: '/apps/administration/index.html#/connectivitySettings/actility_lora_provider_settings'
            });
        }
        else {
            error.message = gettext('Could not get connectivity plans from the LoRa platform. Please contact the administrator.');
        }
        throw error;
    }
    throwConnectivitySettingsError(data) {
        const error = new Error();
        error.name = ErrorName.ConnectivitySettingsError;
        error.message = data.message;
        throw error;
    }
    throwNoConnectivityPlansError() {
        const error = new Error();
        error.name = ErrorName.NoConnectivityPlansError;
        error.message = gettext('No connectivity plans found. New connectivity plans must be created via the LoRa platform.');
        throw error;
    }
    throwNoFreeSlotsInConnectivityPlansError() {
        const companyName = this.optionsService.get('companyName', 'Cumulocity IoT');
        const error = new Error();
        error.name = ErrorName.NoFreeSlotsInConnectivityPlansError;
        error.message = this.translateService.instant(gettext(`No connectivity plans with free slots available. Please contact ThingPark on the device quota limits for your connectivity plans or remove unused devices from ThingPark and retry registering the device in the {{companyName}} platform.`), {
            companyName
        });
        throw error;
    }
    throwDeviceProfilesFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProfilesFetchError;
        error.message = gettext('Could not load device profiles from the LoRa platform.');
        throw error;
    }
    throwNoDeviceProfilesError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProfilesError;
        error.message = gettext('No device profiles found. Create a new device profile via the LoRa platform.');
        throw error;
    }
    throwDeviceProtocolsFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProtocolsFetchError;
        error.message = gettext('Could not load device protocols.');
        throw error;
    }
    throwNoDeviceProtocolsError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProtocolsError;
        error.message = this.translateService.instant(gettext(`No device protocols configured. Create a LoRa device protocol in <a href="{{ link }}">Device protocols</a>.`), {
            link: '/apps/devicemanagement/#/deviceprotocols'
        });
        throw error;
    }
    throwRegistrationError(data) {
        const error = new Error();
        error.name = ErrorName.RegistrationError;
        error.message = data.message;
        throw error;
    }
}
ActilityDeviceRegistrationService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ActilityDeviceRegistrationService, deps: [{ token: i1.InventoryService }, { token: i1.FetchClient }, { token: i2.TranslateService }, { token: i1.ApplicationService }, { token: i3.OptionsService }, { token: i3.AppStateService }], target: i0.ɵɵFactoryTarget.Injectable });
ActilityDeviceRegistrationService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ActilityDeviceRegistrationService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ActilityDeviceRegistrationService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.InventoryService }, { type: i1.FetchClient }, { type: i2.TranslateService }, { type: i1.ApplicationService }, { type: i3.OptionsService }, { type: i3.AppStateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aWxpdHktZGV2aWNlLXJlZ2lzdHJhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vYWN0aWxpdHktZGV2aWNlLXJlZ2lzdHJhdGlvbi9hY3RpbGl0eS1kZXZpY2UtcmVnaXN0cmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQ0wsV0FBVyxFQUVYLGtCQUFrQixFQUVsQixnQkFBZ0IsRUFFakIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLGVBQWUsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFNL0UsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQzs7Ozs7QUFFakMsTUFBTSxDQUFOLElBQVksU0FVWDtBQVZELFdBQVksU0FBUztJQUNuQixrRUFBcUQsQ0FBQTtJQUNyRCx3RkFBMkUsQ0FBQTtJQUMzRSx3RUFBMkQsQ0FBQTtJQUMzRCxvRUFBdUQsQ0FBQTtJQUN2RCw0REFBK0MsQ0FBQTtJQUMvQyxrRUFBcUQsQ0FBQTtJQUNyRCw4REFBaUQsQ0FBQTtJQUNqRCxvRUFBdUQsQ0FBQTtJQUN2RCxvREFBdUMsQ0FBQTtBQUN6QyxDQUFDLEVBVlcsU0FBUyxLQUFULFNBQVMsUUFVcEI7QUFHRCxNQUFNLE9BQU8saUNBQWlDO0lBUzVDLFlBQ1UsZ0JBQWtDLEVBQ2xDLE1BQW1CLEVBQ25CLGdCQUFrQyxFQUNsQyxrQkFBc0MsRUFDdEMsY0FBOEIsRUFDOUIsUUFBeUI7UUFMekIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdB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SUFDZCxDQUFDOzs4SEEzUFUsaUNBQWlDO2tJQUFqQyxpQ0FBaUMsY0FEcEIsTUFBTTsyRkFDbkIsaUNBQWlDO2tCQUQ3QyxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7XG4gIEZldGNoQ2xpZW50LFxuICBJRmV0Y2hPcHRpb25zLFxuICBBcHBsaWNhdGlvblNlcnZpY2UsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJUmVzdWx0TGlzdFxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UsIGdldHRleHQsIE9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBBY3RpbGl0eURldmljZVJlZ2lzdHJhdGlvbixcbiAgQ29ubmVjdGl2aXR5UGxhbixcbiAgRGV2aWNlUHJvZmlsZVxufSBmcm9tICcuL2FjdGlsaXR5LWRldmljZS1yZWdpc3RyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgc29tZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbmV4cG9ydCBlbnVtIEVycm9yTmFtZSB7XG4gIE5vQ29ubmVjdGl2aXR5UGxhbnNFcnJvciA9ICdOb0Nvbm5lY3Rpdml0eVBsYW5zRXJyb3InLFxuICBOb0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvciA9ICdOb0ZyZWVTbG90c0luQ29ubmVjdGl2aXR5UGxhbnNFcnJvcicsXG4gIE5vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvciA9ICdOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3InLFxuICBDb25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yID0gJ0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3InLFxuICBOb0RldmljZVByb2ZpbGVzRXJyb3IgPSAnTm9EZXZpY2VQcm9maWxlc0Vycm9yJyxcbiAgRGV2aWNlUHJvZmlsZXNGZXRjaEVycm9yID0gJ0RldmljZVByb2ZpbGVzRmV0Y2hFcnJvcicsXG4gIE5vRGV2aWNlUHJvdG9jb2xzRXJyb3IgPSAnTm9EZXZpY2VQcm90b2NvbHNFcnJvcicsXG4gIERldmljZVByb3RvY29sc0ZldGNoRXJyb3IgPSAnRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcicsXG4gIFJlZ2lzdHJhdGlvbkVycm9yID0gJ1JlZ2lzdHJhdGlvbkVycm9yJ1xufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEFjdGlsaXR5RGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgYmFzZVVybCA9ICcvc2VydmljZS9hY3RpbGl0eSc7XG4gIHByaXZhdGUgcmVnaXN0cmF0aW9uVXJsID0gYCR7dGhpcy5iYXNlVXJsfS9uZXdEZXZpY2VSZXF1ZXN0YDtcbiAgcHJpdmF0ZSBjb25uZWN0aXZpdHlQbGFuc1VybCA9IGAke3RoaXMuYmFzZVVybH0vY29ubmVjdGl2aXR5UGxhbnNgO1xuICBwcml2YXRlIGRldmljZVByb2ZpbGVzVXJsID0gYCR7dGhpcy5iYXNlVXJsfS9kZXZpY2VQcm9maWxlc2A7XG4gIHByaXZhdGUgaGVhZGVyczogb2JqZWN0ID0ge1xuICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgb3B0aW9uc1NlcnZpY2U6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgZ2V0Q29ubmVjdGlvbnMoKSB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnNcbiAgICB9O1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKGAke3RoaXMuYmFzZVVybH0vbG5zLWNvbm5lY3Rpb25gLCBvcHRpb25zKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBhd2FpdCB0aGlzLnRocm93Tm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudGhyb3dDb25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKGRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuICAvKipcbiAgICogR2V0cyBjb25uZWN0aXZpdHkgcGxhbnMgZnJvbSBMb1JhIHBsYXRmb3JtLlxuICAgKiBAcGFyYW0gY29ubmVjdGlvbk5hbWUgVGhlIG5hbWUgb2YgY29ubmVjdGlvbiBmb3Igd2hpY2ggY29ubmVjdGl2aXR5IHBsYW5zIHdpbGwgYmUgcmV0cmlldmVkXG4gICAqIEByZXR1cm5zIFRoZSByZXN1bHQgbGlzdCB3aXRoIGNvbm5lY3Rpdml0eSBwbGFucywgb3IgdGhyb3dzIGFuIGVycm9yIHdpdGggZXhjZXB0aW9uLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29ubmVjdGl2aXR5UGxhbnMoY29ubmVjdGlvbk5hbWU6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdExpc3Q8Q29ubmVjdGl2aXR5UGxhbj4+IHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgIHBhcmFtczoge1xuICAgICAgICBhY3RpbGl0eUNvbm5lY3Rpb25OYW1lOiBjb25uZWN0aW9uTmFtZVxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh0aGlzLmNvbm5lY3Rpdml0eVBsYW5zVXJsLCBvcHRpb25zKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnRocm93Tm9Db25uZWN0aXZpdHlQbGFuc0Vycm9yKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXRoaXMuaGFzQXZhaWxhYmxlQ29ubmVjdGlvbnMoZGF0YSkpIHtcbiAgICAgICAgICB0aGlzLnRocm93Tm9GcmVlU2xvdHNJbkNvbm5lY3Rpdml0eVBsYW5zRXJyb3IoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnRocm93Q29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcihkYXRhKTtcbiAgICB9XG5cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkZXZpY2UgcHJvZmlsZXMgZnJvbSBMb1JhIHBsYXRmb3JtLlxuICAgKiBAcGFyYW0gY29ubmVjdGlvbk5hbWUgVGhlIG5hbWUgb2YgY29ubmVjdGlvbiBmb3Igd2hpY2ggZGV2aWNlIHByb2ZpbGVzIHdpbGwgYmUgcmV0cmlldmVkXG4gICAqIEByZXR1cm5zIFRoZSByZXN1bHQgbGlzdCB3aXRoIGRldmljZSBwcm9maWxlcywgb3IgdGhyb3dzIGFuIGVycm9yIHdpdGggZXhjZXB0aW9uLlxuICAgKi9cbiAgYXN5bmMgZ2V0RGV2aWNlUHJvZmlsZXMoY29ubmVjdGlvbk5hbWU6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdExpc3Q8RGV2aWNlUHJvZmlsZT4+IHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgIHBhcmFtczoge1xuICAgICAgICBhY3RpbGl0eUNvbm5lY3Rpb25OYW1lOiBjb25uZWN0aW9uTmFtZVxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh0aGlzLmRldmljZVByb2ZpbGVzVXJsLCBvcHRpb25zKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnRocm93Tm9EZXZpY2VQcm9maWxlc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dEZXZpY2VQcm9maWxlc0ZldGNoRXJyb3IoKTtcbiAgICB9XG5cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkZXZpY2UgcHJvdG9jb2xzXG4gICAqL1xuICBhc3luYyBnZXREZXZpY2VQcm90b2NvbHMoXG4gICAgZmlsdGVyOiBvYmplY3QgPSB7IHdpdGhUb3RhbFBhZ2VzOiB0cnVlIH1cbiAgKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIF9fYW5kOiBbXG4gICAgICAgICAgeyBfX2hhczogJ2M4eV9Jc0RldmljZVR5cGUnIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogeyBfX2luOiBbJ2M4eV9BY3RpbGl0eURldmljZVR5cGUnLCAnYzh5X0xvcmFEZXZpY2VUeXBlJywgJ2M4eV9McHdhbkRldmljZVR5cGUnXSB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyBuYW1lOiAxIH1dXG4gICAgfTtcbiAgICBjb25zdCBkZXZpY2VQcm90b2NvbHNMaXN0ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3RRdWVyeShxdWVyeSwgZmlsdGVyKTtcbiAgICBjb25zdCB7IHJlcywgZGF0YSB9ID0gZGV2aWNlUHJvdG9jb2xzTGlzdDtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnRocm93Tm9EZXZpY2VQcm90b2NvbHNFcnJvcigpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRocm93RGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcigpO1xuICAgIH1cblxuICAgIHJldHVybiBkZXZpY2VQcm90b2NvbHNMaXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgZGV2aWNlIHJlZ2lzdHJhdGlvblxuICAgKi9cbiAgYXN5bmMgcmVnaXN0ZXIocmVnaXN0cmF0aW9uOiBBY3RpbGl0eURldmljZVJlZ2lzdHJhdGlvbikge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlZ2lzdHJhdGlvbilcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godGhpcy5yZWdpc3RyYXRpb25VcmwsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMSkge1xuICAgICAgdGhpcy50aHJvd1JlZ2lzdHJhdGlvbkVycm9yKGRhdGEpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIGNoZWNrcyBpZiB1c2VkIGNvbm5lY3Rpb25zIGlzIGxlc3MgdGhlbiBncmFudGVkIGNvbm5lY3Rpb25zXG4gICAqL1xuICBwcml2YXRlIGhhc0F2YWlsYWJsZUNvbm5lY3Rpb25zKGNvbm5lY3Rpdml0eVBsYW5zKSB7XG4gICAgcmV0dXJuIHNvbWUoXG4gICAgICBjb25uZWN0aXZpdHlQbGFucyxcbiAgICAgIHBsYW4gPT4gcGFyc2VJbnQocGxhbi5ncmFudGVkQ29ubmVjdGlvbnMsIDEwKSA+IHBhcnNlSW50KHBsYW4udXNlZENvbm5lY3Rpb25zLCAxMClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB0aHJvd05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuTm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yO1xuXG4gICAgaWYgKGF3YWl0IHRoaXMuYXBwU3RhdGUuaXNBcHBsaWNhdGlvbkF2YWlsYWJsZSgnYWRtaW5pc3RyYXRpb24nKSkge1xuICAgICAgZXJyb3IubWVzc2FnZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICBnZXR0ZXh0KFxuICAgICAgICAgIGBDb3VsZCBub3QgZ2V0IGNvbm5lY3Rpdml0eSBwbGFucyBmcm9tIHRoZSBMb1JhIHBsYXRmb3JtLiBWZXJpZnkgdGhlIFRoaW5nUGFyayBjcmVkZW50aWFscyBpbiB0aGUgQWRtaW5pc3RyYXRpb24gYXBwbGljYXRpb24gdW5kZXIgPGEgaHJlZj1cInt7IGxpbmsgfX1cIj5TZXR0aW5nczwvYT4uYFxuICAgICAgICApLFxuICAgICAgICB7XG4gICAgICAgICAgbGluazogJy9hcHBzL2FkbWluaXN0cmF0aW9uL2luZGV4Lmh0bWwjL2Nvbm5lY3Rpdml0eVNldHRpbmdzL2FjdGlsaXR5X2xvcmFfcHJvdmlkZXJfc2V0dGluZ3MnXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgICAnQ291bGQgbm90IGdldCBjb25uZWN0aXZpdHkgcGxhbnMgZnJvbSB0aGUgTG9SYSBwbGF0Zm9ybS4gUGxlYXNlIGNvbnRhY3QgdGhlIGFkbWluaXN0cmF0b3IuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dDb25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKGRhdGE6IHsgbWVzc2FnZTogc3RyaW5nIH0pIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZGF0YS5tZXNzYWdlO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vQ29ubmVjdGl2aXR5UGxhbnNFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuTm9Db25uZWN0aXZpdHlQbGFuc0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgJ05vIGNvbm5lY3Rpdml0eSBwbGFucyBmb3VuZC4gTmV3IGNvbm5lY3Rpdml0eSBwbGFucyBtdXN0IGJlIGNyZWF0ZWQgdmlhIHRoZSBMb1JhIHBsYXRmb3JtLidcbiAgICApO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vRnJlZVNsb3RzSW5Db25uZWN0aXZpdHlQbGFuc0Vycm9yKCkge1xuICAgIGNvbnN0IGNvbXBhbnlOYW1lID0gdGhpcy5vcHRpb25zU2VydmljZS5nZXQoJ2NvbXBhbnlOYW1lJywgJ0N1bXVsb2NpdHkgSW9UJyk7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vRnJlZVNsb3RzSW5Db25uZWN0aXZpdHlQbGFuc0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgIGdldHRleHQoXG4gICAgICAgIGBObyBjb25uZWN0aXZpdHkgcGxhbnMgd2l0aCBmcmVlIHNsb3RzIGF2YWlsYWJsZS4gUGxlYXNlIGNvbnRhY3QgVGhpbmdQYXJrIG9uIHRoZSBkZXZpY2UgcXVvdGEgbGltaXRzIGZvciB5b3VyIGNvbm5lY3Rpdml0eSBwbGFucyBvciByZW1vdmUgdW51c2VkIGRldmljZXMgZnJvbSBUaGluZ1BhcmsgYW5kIHJldHJ5IHJlZ2lzdGVyaW5nIHRoZSBkZXZpY2UgaW4gdGhlIHt7Y29tcGFueU5hbWV9fSBwbGF0Zm9ybS5gXG4gICAgICApLFxuICAgICAge1xuICAgICAgICBjb21wYW55TmFtZVxuICAgICAgfVxuICAgICk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93RGV2aWNlUHJvZmlsZXNGZXRjaEVycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5EZXZpY2VQcm9maWxlc0ZldGNoRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGdldHRleHQoJ0NvdWxkIG5vdCBsb2FkIGRldmljZSBwcm9maWxlcyBmcm9tIHRoZSBMb1JhIHBsYXRmb3JtLicpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vRGV2aWNlUHJvZmlsZXNFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuTm9EZXZpY2VQcm9maWxlc0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KFxuICAgICAgJ05vIGRldmljZSBwcm9maWxlcyBmb3VuZC4gQ3JlYXRlIGEgbmV3IGRldmljZSBwcm9maWxlIHZpYSB0aGUgTG9SYSBwbGF0Zm9ybS4nXG4gICAgKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5EZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBnZXR0ZXh0KCdDb3VsZCBub3QgbG9hZCBkZXZpY2UgcHJvdG9jb2xzLicpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd05vRGV2aWNlUHJvdG9jb2xzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vRGV2aWNlUHJvdG9jb2xzRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgZ2V0dGV4dChcbiAgICAgICAgYE5vIGRldmljZSBwcm90b2NvbHMgY29uZmlndXJlZC4gQ3JlYXRlIGEgTG9SYSBkZXZpY2UgcHJvdG9jb2wgaW4gPGEgaHJlZj1cInt7IGxpbmsgfX1cIj5EZXZpY2UgcHJvdG9jb2xzPC9hPi5gXG4gICAgICApLFxuICAgICAge1xuICAgICAgICBsaW5rOiAnL2FwcHMvZGV2aWNlbWFuYWdlbWVudC8jL2RldmljZXByb3RvY29scydcbiAgICAgIH1cbiAgICApO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd1JlZ2lzdHJhdGlvbkVycm9yKGRhdGE6IHsgbWVzc2FnZTogc3RyaW5nIH0pIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuUmVnaXN0cmF0aW9uRXJyb3I7XG4gICAgZXJyb3IubWVzc2FnZSA9IGRhdGEubWVzc2FnZTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuIl19