import { Injectable } from '@angular/core';
import { FetchClient } from '@c8y/client';
import { Subject, pipe } from 'rxjs';
import { filter } from 'rxjs/operators';
import { HttpInterceptHandler, HttpRequestHandler } from './http-handler.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
export class ApiService {
    constructor(client) {
        this.client = client;
        this.callsSubject = new Subject();
        this.interceptors = new Map();
        this.interceptorCounter = 0;
        this.calls = this.callsSubject.asObservable();
        this.hookIntoClientFetch();
    }
    /**
     * Allows to hook into the responses received by the FetchClient.
     * This is meant to be used to react on the responses, not for manipulation of the responses.
     * @param hookFilter A filter function to filter for specific responses.
     * @returns An Observable of the filtered responses.
     */
    hookResponse(hookFilter) {
        return this.callsSubject.pipe(filter(({ phase }) => phase === 'finish'), filter(hookFilter));
    }
    /**
     * Allows to hook into the requests performed by the FetchClient.
     * This is meant to be used to react on the requests, not for manipulation of the requests.
     * @param hookFilter A filter function to filter for specific requests.
     * @returns An Observable of the filtered requests.
     */
    hookRequest(hookFilter) {
        return this.callsSubject.pipe(filter(({ phase }) => phase === 'start'), filter(hookFilter));
    }
    onFinish(call) {
        this.callsSubject.next({ phase: 'finish', ...call });
    }
    onStart(call) {
        this.callsSubject.next({ phase: 'start', ...call });
    }
    resolveData(call) {
        const { response, method, url } = call;
        if ('data' in response) {
            return Promise.resolve({ data: response.data, method, url });
        }
        else {
            // No Content success status, for example DELETE request.
            if (response?.status === 204) {
                return Promise.resolve({ data: null, method, url });
            }
            const cb = data => ({ data, method, url });
            return response.clone().json().then(cb, cb);
        }
    }
    /**
     * Can be added to a pipe to exclude any permission call. Permission calls are PUT
     * request with only an id in it, to verify if the user has access to this managed object.
     * @returns The operator to be added to a pipe.
     */
    excludePermissionCall() {
        return pipe(filter(({ method, options }) => {
            if (method === 'PUT' && options.body && typeof options.body === 'string') {
                const parsedBody = JSON.parse(options.body);
                const bodyKeys = Object.keys(parsedBody);
                return !(bodyKeys.length === 1 && bodyKeys[0] === 'id');
            }
            return true;
        }));
    }
    /**
     * Allows to intercept requests performed via the FetchClient requests.
     * @param interceptor The interceptor to be added.
     * @param id An optional unique identifier for the interceptor. The chain of interceptors is ordered by this id. And it can be used to remove the interceptor later on.
     * @returns The id of the interceptor (same as provided id if one was provided, otherwise an id will be generated).
     */
    addInterceptor(interceptor, id) {
        if (!id) {
            id = `${++this.interceptorCounter}`;
        }
        this.interceptors.set(id, interceptor);
        return id;
    }
    /**
     * Allows to remove a previously added interceptor by it's id.
     * @param id The id of the interceptor that should be removed.
     * @returns true if an interceptor existed and has been removed, or false if id does not exist.
     */
    removeInterceptor(id) {
        return this.interceptors.delete(id);
    }
    /**
     * Checks if an interceptor with a given id exists.
     * @param id The id of the interceptor.
     * @returns - Returns true if an interceptor with the given id exists, otherwise false.
     */
    hasInterceptor(id) {
        return this.interceptors.has(id);
    }
    hookIntoClientFetch() {
        const fetch = this.client.fetch.bind(this.client);
        const requestHandler = new HttpRequestHandler(fetch, this);
        this.client.fetch = async (url, options = { method: 'GET' }) => {
            const { method } = options;
            return this.createInterceptorChain({ url, options, method }, requestHandler).toPromise();
        };
    }
    createInterceptorChain(call, requestHandler) {
        let handler = requestHandler;
        // Do some sorting to always apply the interceptors in the specific order
        const sortedInterceptorIds = Array.from(this.interceptors.keys()).sort((a, b) => b.localeCompare(a));
        for (const interceptorId of sortedInterceptorIds) {
            handler = new HttpInterceptHandler(this.interceptors.get(interceptorId), handler);
        }
        return handler.handle(call);
    }
}
ApiService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ApiService, deps: [{ token: i1.FetchClient }], target: i0.ɵɵFactoryTarget.Injectable });
ApiService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ApiService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ApiService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.FetchClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9hcGkvYXBpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFpQyxNQUFNLGFBQWEsQ0FBQztBQUN6RSxPQUFPLEVBQXdDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhDLE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsa0JBQWtCLEVBRW5CLE1BQU0sc0JBQXNCLENBQUM7OztBQU05QixNQUFNLE9BQU8sVUFBVTtJQU1yQixZQUFvQixNQUFtQjtRQUFuQixXQUFNLEdBQU4sTUFBTSxDQUFhO1FBSi9CLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUN0QyxpQkFBWSxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDO1FBQ2xELHVCQUFrQixHQUFHLENBQUMsQ0FBQztRQUc3QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDOUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsWUFBWSxDQUFDLFVBQXNDO1FBQ2pELE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQzNCLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEtBQUssS0FBSyxRQUFRLENBQUMsRUFDekMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUNuQixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsV0FBVyxDQUFDLFVBQXNDO1FBQ2hELE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQzNCLE1BQU0s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SHRCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRmV0Y2hDbGllbnQsIElGZXRjaE9wdGlvbnMsIElGZXRjaFJlc3BvbnNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uLCBPYnNlcnZhYmxlLCBTdWJqZWN0LCBwaXBlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcGlDYWxsLCBBcGlDYWxsT3B0aW9ucyB9IGZyb20gJy4vYXBpLm1vZGVsJztcbmltcG9ydCB7XG4gIEh0dHBJbnRlcmNlcHRIYW5kbGVyLFxuICBIdHRwUmVxdWVzdEhhbmRsZXIsXG4gIFJlcXVlc3RTdGFydEFuZEZpbmlzaFxufSBmcm9tICcuL2h0dHAtaGFuZGxlci5tb2RlbCc7XG5pbXBvcnQgeyBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yIH0gZnJvbSAnLi9pbnRlcmNlcHRvci5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEFwaVNlcnZpY2UgaW1wbGVtZW50cyBSZXF1ZXN0U3RhcnRBbmRGaW5pc2gge1xuICBjYWxsczogT2JzZXJ2YWJsZTxBcGlDYWxsPjtcbiAgcHJpdmF0ZSBjYWxsc1N1YmplY3QgPSBuZXcgU3ViamVjdDxBcGlDYWxsPigpO1xuICBwcml2YXRlIGludGVyY2VwdG9ycyA9IG5ldyBNYXA8c3RyaW5nLCBIdHRwSW50ZXJjZXB0b3I+KCk7XG4gIHByaXZhdGUgaW50ZXJjZXB0b3JDb3VudGVyID0gMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNsaWVudDogRmV0Y2hDbGllbnQpIHtcbiAgICB0aGlzLmNhbGxzID0gdGhpcy5jYWxsc1N1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5ob29rSW50b0NsaWVudEZldGNoKCk7XG4gIH1cblxuICAvKipcbiAgICogQWxsb3dzIHRvIGhvb2sgaW50byB0aGUgcmVzcG9uc2VzIHJlY2VpdmVkIGJ5IHRoZSBGZXRjaENsaWVudC5cbiAgICogVGhpcyBpcyBtZWFudCB0byBiZSB1c2VkIHRvIHJlYWN0IG9uIHRoZSByZXNwb25zZXMsIG5vdCBmb3IgbWFuaXB1bGF0aW9uIG9mIHRoZSByZXNwb25zZXMuXG4gICAqIEBwYXJhbSBob29rRmlsdGVyIEEgZmlsdGVyIGZ1bmN0aW9uIHRvIGZpbHRlciBmb3Igc3BlY2lmaWMgcmVzcG9uc2VzLlxuICAgKiBAcmV0dXJucyBBbiBPYnNlcnZhYmxlIG9mIHRoZSBmaWx0ZXJlZCByZXNwb25zZXMuXG4gICAqL1xuICBob29rUmVzcG9uc2UoaG9va0ZpbHRlcjogKGNhbGw6IEFwaUNhbGwpID0+IGJvb2xlYW4pIHtcbiAgICByZXR1cm4gdGhpcy5jYWxsc1N1YmplY3QucGlwZShcbiAgICAgIGZpbHRlcigoeyBwaGFzZSB9KSA9PiBwaGFzZSA9PT0gJ2ZpbmlzaCcpLFxuICAgICAgZmlsdGVyKGhvb2tGaWx0ZXIpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gaG9vayBpbnRvIHRoZSByZXF1ZXN0cyBwZXJmb3JtZWQgYnkgdGhlIEZldGNoQ2xpZW50LlxuICAgKiBUaGlzIGlzIG1lYW50IHRvIGJlIHVzZWQgdG8gcmVhY3Qgb24gdGhlIHJlcXVlc3RzLCBub3QgZm9yIG1hbmlwdWxhdGlvbiBvZiB0aGUgcmVxdWVzdHMuXG4gICAqIEBwYXJhbSBob29rRmlsdGVyIEEgZmlsdGVyIGZ1bmN0aW9uIHRvIGZpbHRlciBmb3Igc3BlY2lmaWMgcmVxdWVzdHMuXG4gICAqIEByZXR1cm5zIEFuIE9ic2VydmFibGUgb2YgdGhlIGZpbHRlcmVkIHJlcXVlc3RzLlxuICAgKi9cbiAgaG9va1JlcXVlc3QoaG9va0ZpbHRlcjogKGNhbGw6IEFwaUNhbGwpID0+IGJvb2xlYW4pIHtcbiAgICByZXR1cm4gdGhpcy5jYWxsc1N1YmplY3QucGlwZShcbiAgICAgIGZpbHRlcigoeyBwaGFzZSB9KSA9PiBwaGFzZSA9PT0gJ3N0YXJ0JyksXG4gICAgICBmaWx0ZXIoaG9va0ZpbHRlcilcbiAgICApO1xuICB9XG5cbiAgb25GaW5pc2goY2FsbDogQXBpQ2FsbCkge1xuICAgIHRoaXMuY2FsbHNTdWJqZWN0Lm5leHQoeyBwaGFzZTogJ2ZpbmlzaCcsIC4uLmNhbGwgfSk7XG4gIH1cblxuICBvblN0YXJ0KGNhbGw6IEFwaUNhbGwpIHtcbiAgICB0aGlzLmNhbGxzU3ViamVjdC5uZXh0KHsgcGhhc2U6ICdzdGFydCcsIC4uLmNhbGwgfSk7XG4gIH1cblxuICByZXNvbHZlRGF0YTxUID0gdW5rbm93bj4oY2FsbDogQXBpQ2FsbCk6IFByb21pc2U8eyBkYXRhOiBUOyBtZXRob2Q6IHN0cmluZzsgdXJsOiBzdHJpbmcgfT4ge1xuICAgIGNvbnN0IHsgcmVzcG9uc2UsIG1ldGhvZCwgdXJsIH0gPSBjYWxsO1xuICAgIGlmICgnZGF0YScgaW4gcmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBkYXRhOiByZXNwb25zZS5kYXRhLCBtZXRob2QsIHVybCB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTm8gQ29udGVudCBzdWNjZXNzIHN0YXR1cywgZm9yIGV4YW1wbGUgREVMRVRFIHJlcXVlc3QuXG4gICAgICBpZiAoKHJlc3BvbnNlIGFzIFJlc3BvbnNlKT8uc3RhdHVzID09PSAyMDQpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRhdGE6IG51bGwsIG1ldGhvZCwgdXJsIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgY2IgPSBkYXRhID0+ICh7IGRhdGEsIG1ldGhvZCwgdXJsIH0pO1xuICAgICAgcmV0dXJuIChyZXNwb25zZSBhcyBSZXNwb25zZSkuY2xvbmUoKS5qc29uKCkudGhlbihjYiwgY2IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYW4gYmUgYWRkZWQgdG8gYSBwaXBlIHRvIGV4Y2x1ZGUgYW55IHBlcm1pc3Npb24gY2FsbC4gUGVybWlzc2lvbiBjYWxscyBhcmUgUFVUXG4gICAqIHJlcXVlc3Qgd2l0aCBvbmx5IGFuIGlkIGluIGl0LCB0byB2ZXJpZnkgaWYgdGhlIHVzZXIgaGFzIGFjY2VzcyB0byB0aGlzIG1hbmFnZWQgb2JqZWN0LlxuICAgKiBAcmV0dXJucyBUaGUgb3BlcmF0b3IgdG8gYmUgYWRkZWQgdG8gYSBwaXBlLlxuICAgKi9cbiAgZXhjbHVkZVBlcm1pc3Npb25DYWxsKCk6IE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbjxBcGlDYWxsPiB7XG4gICAgcmV0dXJuIHBpcGUoXG4gICAgICBmaWx0ZXIoKHsgbWV0aG9kLCBvcHRpb25zIH0pID0+IHtcbiAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ1BVVCcgJiYgb3B0aW9ucy5ib2R5ICYmIHR5cGVvZiBvcHRpb25zLmJvZHkgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgY29uc3QgcGFyc2VkQm9keSA9IEpTT04ucGFyc2Uob3B0aW9ucy5ib2R5IGFzIHN0cmluZyk7XG4gICAgICAgICAgY29uc3QgYm9keUtleXMgPSBPYmplY3Qua2V5cyhwYXJzZWRCb2R5KTtcbiAgICAgICAgICByZXR1cm4gIShib2R5S2V5cy5sZW5ndGggPT09IDEgJiYgYm9keUtleXNbMF0gPT09ICdpZCcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byBpbnRlcmNlcHQgcmVxdWVzdHMgcGVyZm9ybWVkIHZpYSB0aGUgRmV0Y2hDbGllbnQgcmVxdWVzdHMuXG4gICAqIEBwYXJhbSBpbnRlcmNlcHRvciBUaGUgaW50ZXJjZXB0b3IgdG8gYmUgYWRkZWQuXG4gICAqIEBwYXJhbSBpZCBBbiBvcHRpb25hbCB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIGludGVyY2VwdG9yLiBUaGUgY2hhaW4gb2YgaW50ZXJjZXB0b3JzIGlzIG9yZGVyZWQgYnkgdGhpcyBpZC4gQW5kIGl0IGNhbiBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgaW50ZXJjZXB0b3IgbGF0ZXIgb24uXG4gICAqIEByZXR1cm5zIFRoZSBpZCBvZiB0aGUgaW50ZXJjZXB0b3IgKHNhbWUgYXMgcHJvdmlkZWQgaWQgaWYgb25lIHdhcyBwcm92aWRlZCwgb3RoZXJ3aXNlIGFuIGlkIHdpbGwgYmUgZ2VuZXJhdGVkKS5cbiAgICovXG4gIGFkZEludGVyY2VwdG9yKGludGVyY2VwdG9yOiBIdHRwSW50ZXJjZXB0b3IsIGlkPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIWlkKSB7XG4gICAgICBpZCA9IGAkeysrdGhpcy5pbnRlcmNlcHRvckNvdW50ZXJ9YDtcbiAgICB9XG4gICAgdGhpcy5pbnRlcmNlcHRvcnMuc2V0KGlkLCBpbnRlcmNlcHRvcik7XG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93cyB0byByZW1vdmUgYSBwcmV2aW91c2x5IGFkZGVkIGludGVyY2VwdG9yIGJ5IGl0J3MgaWQuXG4gICAqIEBwYXJhbSBpZCBUaGUgaWQgb2YgdGhlIGludGVyY2VwdG9yIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuXG4gICAqIEByZXR1cm5zIHRydWUgaWYgYW4gaW50ZXJjZXB0b3IgZXhpc3RlZCBhbmQgaGFzIGJlZW4gcmVtb3ZlZCwgb3IgZmFsc2UgaWYgaWQgZG9lcyBub3QgZXhpc3QuXG4gICAqL1xuICByZW1vdmVJbnRlcmNlcHRvcihpZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJjZXB0b3JzLmRlbGV0ZShpZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGFuIGludGVyY2VwdG9yIHdpdGggYSBnaXZlbiBpZCBleGlzdHMuXG4gICAqIEBwYXJhbSBpZCBUaGUgaWQgb2YgdGhlIGludGVyY2VwdG9yLlxuICAgKiBAcmV0dXJucyAtIFJldHVybnMgdHJ1ZSBpZiBhbiBpbnRlcmNlcHRvciB3aXRoIHRoZSBnaXZlbiBpZCBleGlzdHMsIG90aGVyd2lzZSBmYWxzZS5cbiAgICovXG4gIGhhc0ludGVyY2VwdG9yKGlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pbnRlcmNlcHRvcnMuaGFzKGlkKTtcbiAgfVxuXG4gIHByaXZhdGUgaG9va0ludG9DbGllbnRGZXRjaCgpIHtcbiAgICBjb25zdCBmZXRjaDogRmV0Y2hDbGllbnRbJ2ZldGNoJ10gPSB0aGlzLmNsaWVudC5mZXRjaC5iaW5kKHRoaXMuY2xpZW50KTtcbiAgICBjb25zdCByZXF1ZXN0SGFuZGxlciA9IG5ldyBIdHRwUmVxdWVzdEhhbmRsZXIoZmV0Y2gsIHRoaXMpO1xuICAgIHRoaXMuY2xpZW50LmZldGNoID0gYXN5bmMgKFxuICAgICAgdXJsLFxuICAgICAgb3B0aW9uczogQXBpQ2FsbE9wdGlvbnMgJiBJRmV0Y2hPcHRpb25zID0geyBtZXRob2Q6ICdHRVQnIH1cbiAgICApID0+IHtcbiAgICAgIGNvbnN0IHsgbWV0aG9kIH0gPSBvcHRpb25zO1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW50ZXJjZXB0b3JDaGFpbih7IHVybCwgb3B0aW9ucywgbWV0aG9kIH0sIHJlcXVlc3RIYW5kbGVyKS50b1Byb21pc2UoKTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVJbnRlcmNlcHRvckNoYWluKFxuICAgIGNhbGw6IEFwaUNhbGwsXG4gICAgcmVxdWVzdEhhbmRsZXI6IEh0dHBSZXF1ZXN0SGFuZGxlclxuICApOiBPYnNlcnZhYmxlPElGZXRjaFJlc3BvbnNlPiB7XG4gICAgbGV0IGhhbmRsZXI6IEh0dHBIYW5kbGVyID0gcmVxdWVzdEhhbmRsZXI7XG4gICAgLy8gRG8gc29tZSBzb3J0aW5nIHRvIGFsd2F5cyBhcHBseSB0aGUgaW50ZXJjZXB0b3JzIGluIHRoZSBzcGVjaWZpYyBvcmRlclxuICAgIGNvbnN0IHNvcnRlZEludGVyY2VwdG9ySWRzID0gQXJyYXkuZnJvbSh0aGlzLmludGVyY2VwdG9ycy5rZXlzKCkpLnNvcnQoKGEsIGIpID0+XG4gICAgICBiLmxvY2FsZUNvbXBhcmUoYSlcbiAgICApO1xuICAgIGZvciAoY29uc3QgaW50ZXJjZXB0b3JJZCBvZiBzb3J0ZWRJbnRlcmNlcHRvcklkcykge1xuICAgICAgaGFuZGxlciA9IG5ldyBIdHRwSW50ZXJjZXB0SGFuZGxlcih0aGlzLmludGVyY2VwdG9ycy5nZXQoaW50ZXJjZXB0b3JJZCksIGhhbmRsZXIpO1xuICAgIH1cbiAgICByZXR1cm4gaGFuZGxlci5oYW5kbGUoY2FsbCk7XG4gIH1cbn1cbiJdfQ==