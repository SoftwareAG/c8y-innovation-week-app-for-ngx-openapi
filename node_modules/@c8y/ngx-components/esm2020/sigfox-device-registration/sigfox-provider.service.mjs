import { Injectable } from '@angular/core';
import { FetchClient, InventoryService, TenantOptionsService } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import { AppStateService, gettext } from '@c8y/ngx-components';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@ngx-translate/core";
import * as i3 from "@c8y/ngx-components";
export var ErrorName;
(function (ErrorName) {
    ErrorName["NoDeviceProtocolsError"] = "NoDeviceProtocolsError";
    ErrorName["NoConnectivitySettingsError"] = "NoConnectivitySettingsError";
    ErrorName["ConnectivitySettingsError"] = "ConnectivitySettingsError";
    ErrorName["ContractError"] = "ContractError";
    ErrorName["NoContractsError"] = "NoContractsError";
    ErrorName["RegistrationError"] = "RegistrationError";
    ErrorName["DeviceProtocolsFetchError"] = "DeviceProtocolsFetchError";
})(ErrorName || (ErrorName = {}));
export class SigfoxProviderService {
    constructor(client, inventoryService, tenantOptions, translateService, appState) {
        this.client = client;
        this.inventoryService = inventoryService;
        this.tenantOptions = tenantOptions;
        this.translateService = translateService;
        this.appState = appState;
        this.baseUrl = '/service/sigfox-agent/';
        this.registrationUrl = `${this.baseUrl}newDeviceRequest`;
        this.contractsUrl = `${this.baseUrl}contract`;
        this.header = { 'Content-Type': 'application/json' };
    }
    async getConnections() {
        const options = {
            method: 'GET',
            headers: this.header
        };
        const res = await this.client.fetch(`${this.baseUrl}lns-connection`, options);
        const data = await res.json();
        if (res.status === 200) {
            if (data.length === 0) {
                await this.throwNoConnectivitySettingsError();
            }
        }
        else {
            await this.throwConnectivitySettingsError(data);
        }
        return { res, data };
    }
    /**
     * Gets contracts from Sigfox platform.
     * @param connectionName The name of connection for which contracts will be retrieved
     * @returns The result list with contract, or throws an error with exception.
     */
    async getContracts(connectionName) {
        const options = {
            method: 'GET',
            headers: this.header,
            params: {
                sigfoxConnectionName: connectionName
            }
        };
        const res = await this.client.fetch(this.contractsUrl, options);
        const data = await res.json();
        if (res.status === 200) {
            if (data.length === 0) {
                this.throwNoContractsError();
            }
        }
        else {
            this.throwContractError(data);
        }
        return { res, data };
    }
    async createDevice(device) {
        const options = {
            method: 'POST',
            headers: this.header,
            body: JSON.stringify(device)
        };
        const res = await this.client.fetch(this.registrationUrl, options);
        const data = await res.json();
        if (res.status !== 201) {
            this.throwRegistrationError(data);
        }
        return { res, data };
    }
    async getAvailableProtocols(filter = { withTotalPages: true }) {
        const query = {
            __filter: {
                __and: [
                    { __has: 'c8y_IsDeviceType' },
                    {
                        type: { __in: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'] }
                    }
                ]
            },
            __orderby: [{ name: 1 }]
        };
        const deviceProtocolsList = await this.inventoryService.listQuery(query, filter);
        const { res, data } = deviceProtocolsList;
        if (res.status === 200) {
            if (data.length === 0) {
                this.throwNoDeviceProtocolsError();
            }
        }
        else {
            this.throwDeviceProtocolsFetchError();
        }
        return deviceProtocolsList;
    }
    async hasConnectivitySettings() {
        const option = {
            category: 'sigfox-agent',
            key: 'provider.token'
        };
        try {
            await this.tenantOptions.detail(option);
            return true;
        }
        catch (e) {
            await this.throwNoConnectivitySettingsError();
        }
    }
    async throwNoConnectivitySettingsError() {
        const error = new Error();
        error.name = ErrorName.NoConnectivitySettingsError;
        const hasAdminRight = await this.appState.isApplicationAvailable('administration');
        if (hasAdminRight) {
            error.message = this.translateService.instant(gettext(`Connectivity settings are not configured. Configure them in the Administration application under <a href="{{ link }}">Settings</a>.`), {
                link: '/apps/administration/index.html#/connectivitySettings/sigfox_provider_settings'
            });
        }
        else {
            error.message = gettext('Connectivity settings are not configured. Contact the administrator.');
        }
        throw error;
    }
    throwConnectivitySettingsError(data) {
        const error = new Error();
        error.name = ErrorName.ConnectivitySettingsError;
        error.message = data.message;
        throw error;
    }
    throwRegistrationError(data) {
        const error = new Error();
        error.name = ErrorName.RegistrationError;
        error.message = data.message;
        throw error;
    }
    throwDeviceProtocolsFetchError() {
        const error = new Error();
        error.name = ErrorName.DeviceProtocolsFetchError;
        error.message = gettext('Could not load device protocols.');
        throw error;
    }
    throwNoDeviceProtocolsError() {
        const error = new Error();
        error.name = ErrorName.NoDeviceProtocolsError;
        error.message = this.translateService.instant(gettext(`No device protocols configured. Create a Sigfox device protocol in <a href="{{ link }}">Device protocols</a>.`), {
            link: '/apps/devicemanagement/#/deviceprotocols'
        });
        throw error;
    }
    throwContractError(data) {
        const error = new Error();
        error.name = ErrorName.ContractError;
        error.message = data.message;
        throw error;
    }
    throwNoContractsError() {
        const error = new Error();
        error.name = ErrorName.NoContractsError;
        error.message = gettext('No contracts found. New contracts must be created via the Sigfox platform.');
        throw error;
    }
}
SigfoxProviderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: SigfoxProviderService, deps: [{ token: i1.FetchClient }, { token: i1.InventoryService }, { token: i1.TenantOptionsService }, { token: i2.TranslateService }, { token: i3.AppStateService }], target: i0.ɵɵFactoryTarget.Injectable });
SigfoxProviderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: SigfoxProviderService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: SigfoxProviderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.FetchClient }, { type: i1.InventoryService }, { type: i1.TenantOptionsService }, { type: i2.TranslateService }, { type: i3.AppStateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnZm94LXByb3ZpZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zaWdmb3gtZGV2aWNlLXJlZ2lzdHJhdGlvbi9zaWdmb3gtcHJvdmlkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxXQUFXLEVBR1gsZ0JBQWdCLEVBSWhCLG9CQUFvQixFQUNyQixNQUFNLGFBQWEsQ0FBQztBQUVyQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7OztBQUUvRCxNQUFNLENBQU4sSUFBWSxTQVFYO0FBUkQsV0FBWSxTQUFTO0lBQ25CLDhEQUFpRCxDQUFBO0lBQ2pELHdFQUEyRCxDQUFBO0lBQzNELG9FQUF1RCxDQUFBO0lBQ3ZELDRDQUErQixDQUFBO0lBQy9CLGtEQUFxQyxDQUFBO0lBQ3JDLG9EQUF1QyxDQUFBO0lBQ3ZDLG9FQUF1RCxDQUFBO0FBQ3pELENBQUMsRUFSVyxTQUFTLEtBQVQsU0FBUyxRQVFwQjtBQUtELE1BQU0sT0FBTyxxQkFBcUI7SUFNaEMsWUFDVSxNQUFtQixFQUNuQixnQkFBa0MsRUFDbEMsYUFBbUMsRUFDbkMsZ0JBQWtDLEVBQ2xDLFFBQXlCO1FBSnpCLFdBQU0sR0FBTixNQUFNLENBQWE7UUFDbkIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFDbkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQVZsQixZQUFPLEdBQVcsd0JBQXdCLENBQUM7UUFDM0Msb0JBQWUsR0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLGtCQUFrQixDQUFDO1FBQzVELGlCQUFZ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SUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDM0MsT0FBTyxDQUNMLCtHQUErRyxDQUNoSCxFQUNEO1lBQ0UsSUFBSSxFQUFFLDBDQUEwQztTQUNqRCxDQUNGLENBQUM7UUFDRixNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUF5QjtRQUNsRCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQztRQUNyQyxLQUFLLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDN0IsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0lBRU8scUJBQXFCO1FBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFDMUIsS0FBSyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7UUFDeEMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQ3JCLDRFQUE0RSxDQUM3RSxDQUFDO1FBQ0YsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDOztrSEF2TFUscUJBQXFCO3NIQUFyQixxQkFBcUIsY0FGcEIsTUFBTTsyRkFFUCxxQkFBcUI7a0JBSGpDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgRmV0Y2hDbGllbnQsXG4gIElGZXRjaE9wdGlvbnMsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJUmVzdWx0LFxuICBJUmVzdWx0TGlzdCxcbiAgSVRlbmFudE9wdGlvbixcbiAgVGVuYW50T3B0aW9uc1NlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgU2lnZm94RGV2aWNlIH0gZnJvbSAnLi9zaWdmb3gtZGV2aWNlLXJlZ2lzdHJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuZXhwb3J0IGVudW0gRXJyb3JOYW1lIHtcbiAgTm9EZXZpY2VQcm90b2NvbHNFcnJvciA9ICdOb0RldmljZVByb3RvY29sc0Vycm9yJyxcbiAgTm9Db25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yID0gJ05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcicsXG4gIENvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IgPSAnQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcicsXG4gIENvbnRyYWN0RXJyb3IgPSAnQ29udHJhY3RFcnJvcicsXG4gIE5vQ29udHJhY3RzRXJyb3IgPSAnTm9Db250cmFjdHNFcnJvcicsXG4gIFJlZ2lzdHJhdGlvbkVycm9yID0gJ1JlZ2lzdHJhdGlvbkVycm9yJyxcbiAgRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvciA9ICdEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yJ1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTaWdmb3hQcm92aWRlclNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGJhc2VVcmw6IHN0cmluZyA9ICcvc2VydmljZS9zaWdmb3gtYWdlbnQvJztcbiAgcHJpdmF0ZSByZWFkb25seSByZWdpc3RyYXRpb25Vcmw6IHN0cmluZyA9IGAke3RoaXMuYmFzZVVybH1uZXdEZXZpY2VSZXF1ZXN0YDtcbiAgcHJpdmF0ZSByZWFkb25seSBjb250cmFjdHNVcmw6IHN0cmluZyA9IGAke3RoaXMuYmFzZVVybH1jb250cmFjdGA7XG4gIHByaXZhdGUgcmVhZG9ubHkgaGVhZGVyOiBhbnkgPSB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNsaWVudDogRmV0Y2hDbGllbnQsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50T3B0aW9uczogVGVuYW50T3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZVxuICApIHt9XG4gIGFzeW5jIGdldENvbm5lY3Rpb25zKCkge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJcbiAgICB9O1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmZldGNoKGAke3RoaXMuYmFzZVVybH1sbnMtY29ubmVjdGlvbmAsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy50aHJvd0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiB7IHJlcywgZGF0YSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgY29udHJhY3RzIGZyb20gU2lnZm94IHBsYXRmb3JtLlxuICAgKiBAcGFyYW0gY29ubmVjdGlvbk5hbWUgVGhlIG5hbWUgb2YgY29ubmVjdGlvbiBmb3Igd2hpY2ggY29udHJhY3RzIHdpbGwgYmUgcmV0cmlldmVkXG4gICAqIEByZXR1cm5zIFRoZSByZXN1bHQgbGlzdCB3aXRoIGNvbnRyYWN0LCBvciB0aHJvd3MgYW4gZXJyb3Igd2l0aCBleGNlcHRpb24uXG4gICAqL1xuICBhc3luYyBnZXRDb250cmFjdHMoY29ubmVjdGlvbk5hbWU6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdExpc3Q8YW55Pj4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXIsXG4gICAgICBwYXJhbXM6IHtcbiAgICAgICAgc2lnZm94Q29ubmVjdGlvbk5hbWU6IGNvbm5lY3Rpb25OYW1lXG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh0aGlzLmNvbnRyYWN0c1VybCwgb3B0aW9ucyk7XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcblxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnRocm93Tm9Db250cmFjdHNFcnJvcigpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRocm93Q29udHJhY3RFcnJvcihkYXRhKTtcbiAgICB9XG4gICAgcmV0dXJuIHsgcmVzLCBkYXRhIH07XG4gIH1cblxuICBhc3luYyBjcmVhdGVEZXZpY2UoZGV2aWNlOiBTaWdmb3hEZXZpY2UpOiBQcm9taXNlPElSZXN1bHQ8U2lnZm94RGV2aWNlPj4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZGV2aWNlKVxuICAgIH07XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godGhpcy5yZWdpc3RyYXRpb25VcmwsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMSkge1xuICAgICAgdGhpcy50aHJvd1JlZ2lzdHJhdGlvbkVycm9yKGRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4geyByZXMsIGRhdGEgfTtcbiAgfVxuXG4gIGFzeW5jIGdldEF2YWlsYWJsZVByb3RvY29scyhcbiAgICBmaWx0ZXI6IG9iamVjdCA9IHsgd2l0aFRvdGFsUGFnZXM6IHRydWUgfVxuICApOiBQcm9taXNlPElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pj4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0ge1xuICAgICAgX19maWx0ZXI6IHtcbiAgICAgICAgX19hbmQ6IFtcbiAgICAgICAgICB7IF9faGFzOiAnYzh5X0lzRGV2aWNlVHlwZScgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiB7IF9faW46IFsnYzh5X1NpZ2ZveERldmljZVR5cGUnLCAnYzh5X0xwd2FuRGV2aWNlVHlwZSddIH1cbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgICBfX29yZGVyYnk6IFt7IG5hbWU6IDEgfV1cbiAgICB9O1xuICAgIGNvbnN0IGRldmljZVByb3RvY29sc0xpc3QgPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXIpO1xuICAgIGNvbnN0IHsgcmVzLCBkYXRhIH0gPSBkZXZpY2VQcm90b2NvbHNMaXN0O1xuXG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMudGhyb3dOb0RldmljZVByb3RvY29sc0Vycm9yKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dEZXZpY2VQcm90b2NvbHNGZXRjaEVycm9yKCk7XG4gICAgfVxuICAgIHJldHVybiBkZXZpY2VQcm90b2NvbHNMaXN0O1xuICB9XG5cbiAgYXN5bmMgaGFzQ29ubmVjdGl2aXR5U2V0dGluZ3MoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgb3B0aW9uOiBJVGVuYW50T3B0aW9uID0ge1xuICAgICAgY2F0ZWdvcnk6ICdzaWdmb3gtYWdlbnQnLFxuICAgICAga2V5OiAncHJvdmlkZXIudG9rZW4nXG4gICAgfTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy50ZW5hbnRPcHRpb25zLmRldGFpbChvcHRpb24pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy50aHJvd05vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdGhyb3dOb0Nvbm5lY3Rpdml0eVNldHRpbmdzRXJyb3IoKSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLk5vQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcjtcbiAgICBjb25zdCBoYXNBZG1pblJpZ2h0ID0gYXdhaXQgdGhpcy5hcHBTdGF0ZS5pc0FwcGxpY2F0aW9uQXZhaWxhYmxlKCdhZG1pbmlzdHJhdGlvbicpO1xuICAgIGlmIChoYXNBZG1pblJpZ2h0KSB7XG4gICAgICBlcnJvci5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgIGdldHRleHQoXG4gICAgICAgICAgYENvbm5lY3Rpdml0eSBzZXR0aW5ncyBhcmUgbm90IGNvbmZpZ3VyZWQuIENvbmZpZ3VyZSB0aGVtIGluIHRoZSBBZG1pbmlzdHJhdGlvbiBhcHBsaWNhdGlvbiB1bmRlciA8YSBocmVmPVwie3sgbGluayB9fVwiPlNldHRpbmdzPC9hPi5gXG4gICAgICAgICksXG4gICAgICAgIHtcbiAgICAgICAgICBsaW5rOiAnL2FwcHMvYWRtaW5pc3RyYXRpb24vaW5kZXguaHRtbCMvY29ubmVjdGl2aXR5U2V0dGluZ3Mvc2lnZm94X3Byb3ZpZGVyX3NldHRpbmdzJ1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dChcbiAgICAgICAgJ0Nvbm5lY3Rpdml0eSBzZXR0aW5ncyBhcmUgbm90IGNvbmZpZ3VyZWQuIENvbnRhY3QgdGhlIGFkbWluaXN0cmF0b3IuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dDb25uZWN0aXZpdHlTZXR0aW5nc0Vycm9yKGRhdGE6IHsgbWVzc2FnZTogc3RyaW5nIH0pIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuQ29ubmVjdGl2aXR5U2V0dGluZ3NFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZGF0YS5tZXNzYWdlO1xuICAgIHRocm93IGVycm9yO1xuICB9XG4gIHByaXZhdGUgdGhyb3dSZWdpc3RyYXRpb25FcnJvcihkYXRhOiB7IG1lc3NhZ2U6IHN0cmluZyB9KSB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKTtcbiAgICBlcnJvci5uYW1lID0gRXJyb3JOYW1lLlJlZ2lzdHJhdGlvbkVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBkYXRhLm1lc3NhZ2U7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93RGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuRGV2aWNlUHJvdG9jb2xzRmV0Y2hFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dCgnQ291bGQgbm90IGxvYWQgZGV2aWNlIHByb3RvY29scy4nKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dOb0RldmljZVByb3RvY29sc0Vycm9yKCkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Ob0RldmljZVByb3RvY29sc0Vycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgIGdldHRleHQoXG4gICAgICAgIGBObyBkZXZpY2UgcHJvdG9jb2xzIGNvbmZpZ3VyZWQuIENyZWF0ZSBhIFNpZ2ZveCBkZXZpY2UgcHJvdG9jb2wgaW4gPGEgaHJlZj1cInt7IGxpbmsgfX1cIj5EZXZpY2UgcHJvdG9jb2xzPC9hPi5gXG4gICAgICApLFxuICAgICAge1xuICAgICAgICBsaW5rOiAnL2FwcHMvZGV2aWNlbWFuYWdlbWVudC8jL2RldmljZXByb3RvY29scydcbiAgICAgIH1cbiAgICApO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSB0aHJvd0NvbnRyYWN0RXJyb3IoZGF0YTogeyBtZXNzYWdlOiBzdHJpbmcgfSkge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IubmFtZSA9IEVycm9yTmFtZS5Db250cmFjdEVycm9yO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBkYXRhLm1lc3NhZ2U7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIHRocm93Tm9Db250cmFjdHNFcnJvcigpIHtcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigpO1xuICAgIGVycm9yLm5hbWUgPSBFcnJvck5hbWUuTm9Db250cmFjdHNFcnJvcjtcbiAgICBlcnJvci5tZXNzYWdlID0gZ2V0dGV4dChcbiAgICAgICdObyBjb250cmFjdHMgZm91bmQuIE5ldyBjb250cmFjdHMgbXVzdCBiZSBjcmVhdGVkIHZpYSB0aGUgU2lnZm94IHBsYXRmb3JtLidcbiAgICApO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG4iXX0=