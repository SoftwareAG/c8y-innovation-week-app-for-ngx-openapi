import { DOCUMENT as Document } from '@angular/common';
import { Component, Inject } from '@angular/core';
import { Router } from '@angular/router';
import { AlertService, gettext, HeaderService } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { cloneDeep } from 'lodash-es';
import { BsModalService } from 'ngx-bootstrap/modal';
import { BookmarkService } from './bookmarks.service';
import { EditBookmarksComponent } from './edit-bookmarks/edit-bookmarks.component';
import * as i0 from "@angular/core";
import * as i1 from "@ngx-translate/core";
import * as i2 from "./bookmarks.service";
import * as i3 from "@c8y/ngx-components";
import * as i4 from "ngx-bootstrap/modal";
import * as i5 from "@angular/router";
import * as i6 from "@angular/common";
import * as i7 from "ngx-bootstrap/tooltip";
export class BookmarksComponent {
    constructor(document, translateService, bookmarksService, alertService, bookmarkService, bsModalService, router, headerService) {
        this.document = document;
        this.translateService = translateService;
        this.bookmarksService = bookmarksService;
        this.alertService = alertService;
        this.bookmarkService = bookmarkService;
        this.bsModalService = bsModalService;
        this.router = router;
        this.headerService = headerService;
        this.emptyMessageHeader = this.translateService.instant(gettext('No bookmarks yet'));
        this.emptyMessageBody = this.translateService.instant(gettext('Navigate to the desired page and click the "Add current page" button. Editing, deleting and reordering are possible by clicking on the cog wheel.'));
        this.addButtonText = this.translateService.instant(gettext('Add current page'));
        this.drawerOpen$ = this.headerService.rightDrawerOpen$;
    }
    async ngOnInit() {
        this.bookmarks = await this.bookmarkService.getBookmarks();
    }
    async addBookmark() {
        const currentHref = this.document.location.href;
        if (this.bookmarks.some(bookmark => bookmark.url === currentHref)) {
            this.alertService.warning(gettext('Bookmark with the same URL is already added.'));
            return;
        }
        const linkObject = this.convertBookmarkLinkToObject(currentHref, this.bookmarksService.getCurrentActiveNodeIcon(this.document));
        this.bookmarks.push(linkObject);
        await this.bookmarkService.updateBookmarksInStorage(this.bookmarks);
        this.alertService.success(gettext('Bookmark added.'));
    }
    async editBookmarks() {
        try {
            const initialState = {
                bookmarks: cloneDeep(this.bookmarks)
            };
            const modalRef = this.bsModalService.show(EditBookmarksComponent, {
                class: 'modal-md',
                ariaDescribedby: 'modal-body',
                ariaLabelledBy: 'modal-title',
                initialState: initialState,
                ignoreBackdropClick: true
            }).content;
            this.bookmarks = await modalRef.result;
        }
        catch (err) {
            return;
        }
    }
    openUrl(url) {
        const parsedUrl = new URL(url);
        if (parsedUrl.hostname === location.hostname &&
            parsedUrl.pathname.includes(location.pathname)) {
            this.router.navigateByUrl(parsedUrl.hash.substring(1));
            return;
        }
        // only possible if the external bookmark URL has been saved using the API
        if (parsedUrl.hostname !== location.hostname) {
            return;
        }
        window.open(url, '_self');
    }
    convertBookmarkLinkToObject(url, icon) {
        const title = this.document.title;
        return {
            id: this.bookmarkService.generateRandomID(),
            label: title.includes('Cumulocity') ? title.replace('Cumulocity - ', '') : 'Bookmark',
            url,
            icon
        };
    }
}
BookmarksComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: BookmarksComponent, deps: [{ token: Document }, { token: i1.TranslateService }, { token: i2.BookmarkService }, { token: i3.AlertService }, { token: i2.BookmarkService }, { token: i4.BsModalService }, { token: i5.Router }, { token: i3.HeaderService }], target: i0.ɵɵFactoryTarget.Component });
BookmarksComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: BookmarksComponent, selector: "c8y-bookmarks", ngImport: i0, template: "<div class=\"separator-top p-t-8 m-t-auto c8y-right-drawer__item sticky-top\">\n  <i c8yIcon=\"bookmark\"></i>\n  <span class=\"text-bold\">{{ 'Bookmarks' | translate }}</span>\n  <button\n    class=\"btn-dot m-l-auto\"\n    tooltip=\"{{ 'Edit bookmarks' | translate }}\"\n    [attr.aria-label]=\"'Edit bookmarks' | translate\"\n    container=\"body\"\n    placement=\"left\"\n    [adaptivePosition]=\"false\"\n    [delay]=\"500\"\n    (click)=\"editBookmarks()\"\n    type=\"button\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i c8yIcon=\"cog\" class=\"text-14 m-0\"></i>\n  </button>\n</div>\n<div class=\"c8y-right-drawer__item p-t-0 p-b-8\" *ngIf=\"bookmarks?.length\">\n  <button\n    class=\"btn btn-default btn-sm\"\n    (click)=\"addBookmark()\"\n    type=\"button\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i c8yIcon=\"plus-circle-o\" class=\"m-t-0 m-b-0 text-14\"></i>\n    <span>{{ addButtonText }}</span>\n  </button>\n</div>\n<ng-container *ngFor=\"let bookmark of bookmarks\">\n  <button\n    title=\"{{ bookmark.label }}\"\n    type=\"button\"\n    class=\"c8y-right-drawer__link\"\n    (click)=\"openUrl(bookmark.url)\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i [c8yIcon]=\"bookmark.icon\" *ngIf=\"bookmark.icon\"></i>\n    <span class=\"text-truncate\">{{ bookmark.label }}</span>\n  </button>\n</ng-container>\n<div class=\"p-t-8 p-b-8\">\n  <ng-container *ngIf=\"!bookmarks?.length\">\n    <span class=\"c8y-right-drawer__item text-muted text-bold text-14 p-b-0\">\n      {{ emptyMessageHeader }}\n    </span>\n    <span class=\"c8y-right-drawer__item text-12 p-t-0\">\n      <span class=\"text-muted\">{{ emptyMessageBody }}</span>\n    </span>\n    <div class=\"c8y-right-drawer__item\">\n      <button\n        class=\"btn btn-default btn-sm\"\n        (click)=\"addBookmark()\"\n        type=\"button\"\n        [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n      >\n        <i c8yIcon=\"plus-circle-o\" class=\"m-t-0 m-b-0 text-14\"></i>\n        <span>{{ addButtonText }}</span>\n      </button>\n    </div>\n  </ng-container>\n</div>\n", dependencies: [{ kind: "directive", type: i3.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i6.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i6.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i7.TooltipDirective, selector: "[tooltip], [tooltipHtml]", inputs: ["adaptivePosition", "tooltip", "placement", "triggers", "container", "containerClass", "boundariesElement", "isOpen", "isDisabled", "delay", "tooltipHtml", "tooltipPlacement", "tooltipIsOpen", "tooltipEnable", "tooltipAppendToBody", "tooltipAnimation", "tooltipClass", "tooltipContext", "tooltipPopupDelay", "tooltipFadeDuration", "tooltipTrigger"], outputs: ["tooltipChange", "onShown", "onHidden", "tooltipStateChanged"], exportAs: ["bs-tooltip"] }, { kind: "pipe", type: i3.C8yTranslatePipe, name: "translate" }, { kind: "pipe", type: i6.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: BookmarksComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-bookmarks', template: "<div class=\"separator-top p-t-8 m-t-auto c8y-right-drawer__item sticky-top\">\n  <i c8yIcon=\"bookmark\"></i>\n  <span class=\"text-bold\">{{ 'Bookmarks' | translate }}</span>\n  <button\n    class=\"btn-dot m-l-auto\"\n    tooltip=\"{{ 'Edit bookmarks' | translate }}\"\n    [attr.aria-label]=\"'Edit bookmarks' | translate\"\n    container=\"body\"\n    placement=\"left\"\n    [adaptivePosition]=\"false\"\n    [delay]=\"500\"\n    (click)=\"editBookmarks()\"\n    type=\"button\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i c8yIcon=\"cog\" class=\"text-14 m-0\"></i>\n  </button>\n</div>\n<div class=\"c8y-right-drawer__item p-t-0 p-b-8\" *ngIf=\"bookmarks?.length\">\n  <button\n    class=\"btn btn-default btn-sm\"\n    (click)=\"addBookmark()\"\n    type=\"button\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i c8yIcon=\"plus-circle-o\" class=\"m-t-0 m-b-0 text-14\"></i>\n    <span>{{ addButtonText }}</span>\n  </button>\n</div>\n<ng-container *ngFor=\"let bookmark of bookmarks\">\n  <button\n    title=\"{{ bookmark.label }}\"\n    type=\"button\"\n    class=\"c8y-right-drawer__link\"\n    (click)=\"openUrl(bookmark.url)\"\n    [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n  >\n    <i [c8yIcon]=\"bookmark.icon\" *ngIf=\"bookmark.icon\"></i>\n    <span class=\"text-truncate\">{{ bookmark.label }}</span>\n  </button>\n</ng-container>\n<div class=\"p-t-8 p-b-8\">\n  <ng-container *ngIf=\"!bookmarks?.length\">\n    <span class=\"c8y-right-drawer__item text-muted text-bold text-14 p-b-0\">\n      {{ emptyMessageHeader }}\n    </span>\n    <span class=\"c8y-right-drawer__item text-12 p-t-0\">\n      <span class=\"text-muted\">{{ emptyMessageBody }}</span>\n    </span>\n    <div class=\"c8y-right-drawer__item\">\n      <button\n        class=\"btn btn-default btn-sm\"\n        (click)=\"addBookmark()\"\n        type=\"button\"\n        [tabindex]=\"(drawerOpen$ | async) ? '0' : '-1'\"\n      >\n        <i c8yIcon=\"plus-circle-o\" class=\"m-t-0 m-b-0 text-14\"></i>\n        <span>{{ addButtonText }}</span>\n      </button>\n    </div>\n  </ng-container>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: Document, decorators: [{
                    type: Inject,
                    args: [Document]
                }] }, { type: i1.TranslateService }, { type: i2.BookmarkService }, { type: i3.AlertService }, { type: i2.BookmarkService }, { type: i4.BsModalService }, { type: i5.Router }, { type: i3.HeaderService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9va21hcmtzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2Jvb2ttYXJrcy9ib29rbWFya3MuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vYm9va21hcmtzL2Jvb2ttYXJrcy5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxJQUFJLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7Ozs7Ozs7OztBQU1uRixNQUFNLE9BQU8sa0JBQWtCO0lBVzdCLFlBQzRCLFFBQWtCLEVBQ3BDLGdCQUFrQyxFQUNsQyxnQkFBaUMsRUFDakMsWUFBMEIsRUFDMUIsZUFBZ0MsRUFDaEMsY0FBOEIsRUFDOUIsTUFBYyxFQUNkLGFBQTRCO1FBUFYsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNwQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBaUI7UUFDakMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLG1CQUFj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QyxRQUFRLEVBQUU7WUFDNUMsT0FBTztTQUNSO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVPLDJCQUEyQixDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQzNELE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQzFDLE9BQU87WUFDTCxFQUFFLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRTtZQUMzQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVU7WUFDckYsR0FBRztZQUNILElBQUk7U0FDTCxDQUFDO0lBQ0osQ0FBQzs7K0dBeEZVLGtCQUFrQixrQkFZbkIsUUFBUTttR0FaUCxrQkFBa0IscURDaEIvQiw4bEVBOERBOzJGRDlDYSxrQkFBa0I7a0JBSjlCLFNBQVM7K0JBQ0UsZUFBZTs7MEJBZXRCLE1BQU07MkJBQUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5UIGFzIERvY3VtZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IENvbXBvbmVudCwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBIZWFkZXJTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEJvb2ttYXJrIH0gZnJvbSAnLi9ib29rbWFyay5tb2RlbCc7XG5pbXBvcnQgeyBCb29rbWFya1NlcnZpY2UgfSBmcm9tICcuL2Jvb2ttYXJrcy5zZXJ2aWNlJztcbmltcG9ydCB7IEVkaXRCb29rbWFya3NDb21wb25lbnQgfSBmcm9tICcuL2VkaXQtYm9va21hcmtzL2VkaXQtYm9va21hcmtzLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1ib29rbWFya3MnLFxuICB0ZW1wbGF0ZVVybDogJy4vYm9va21hcmtzLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBCb29rbWFya3NDb21wb25lbnQge1xuICBkcmF3ZXJPcGVuJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgYm9va21hcmtzOiBCb29rbWFya1tdO1xuICBlbXB0eU1lc3NhZ2VIZWFkZXIgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChnZXR0ZXh0KCdObyBib29rbWFya3MgeWV0JykpO1xuICBlbXB0eU1lc3NhZ2VCb2R5ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgZ2V0dGV4dChcbiAgICAgICdOYXZpZ2F0ZSB0byB0aGUgZGVzaXJlZCBwYWdlIGFuZCBjbGljayB0aGUgXCJBZGQgY3VycmVudCBwYWdlXCIgYnV0dG9uLiBFZGl0aW5nLCBkZWxldGluZyBhbmQgcmVvcmRlcmluZyBhcmUgcG9zc2libGUgYnkgY2xpY2tpbmcgb24gdGhlIGNvZyB3aGVlbC4nXG4gICAgKVxuICApO1xuICBhZGRCdXR0b25UZXh0ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoZ2V0dGV4dCgnQWRkIGN1cnJlbnQgcGFnZScpKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KERvY3VtZW50KSBwcml2YXRlIGRvY3VtZW50OiBEb2N1bWVudCxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBib29rbWFya3NTZXJ2aWNlOiBCb29rbWFya1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIGJvb2ttYXJrU2VydmljZTogQm9va21hcmtTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBoZWFkZXJTZXJ2aWNlOiBIZWFkZXJTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZHJhd2VyT3BlbiQgPSB0aGlzLmhlYWRlclNlcnZpY2UucmlnaHREcmF3ZXJPcGVuJDtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuYm9va21hcmtzID0gYXdhaXQgdGhpcy5ib29rbWFya1NlcnZpY2UuZ2V0Qm9va21hcmtzKCk7XG4gIH1cblxuICBhc3luYyBhZGRCb29rbWFyaygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjdXJyZW50SHJlZiA9IHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaHJlZjtcbiAgICBpZiAodGhpcy5ib29rbWFya3Muc29tZShib29rbWFyayA9PiBib29rbWFyay51cmwgPT09IGN1cnJlbnRIcmVmKSkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uud2FybmluZyhnZXR0ZXh0KCdCb29rbWFyayB3aXRoIHRoZSBzYW1lIFVSTCBpcyBhbHJlYWR5IGFkZGVkLicpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbGlua09iamVjdCA9IHRoaXMuY29udmVydEJvb2ttYXJrTGlua1RvT2JqZWN0KFxuICAgICAgY3VycmVudEhyZWYsXG4gICAgICB0aGlzLmJvb2ttYXJrc1NlcnZpY2UuZ2V0Q3VycmVudEFjdGl2ZU5vZGVJY29uKHRoaXMuZG9jdW1lbnQpXG4gICAgKTtcbiAgICB0aGlzLmJvb2ttYXJrcy5wdXNoKGxpbmtPYmplY3QpO1xuICAgIGF3YWl0IHRoaXMuYm9va21hcmtTZXJ2aWNlLnVwZGF0ZUJvb2ttYXJrc0luU3RvcmFnZSh0aGlzLmJvb2ttYXJrcyk7XG4gICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdCb29rbWFyayBhZGRlZC4nKSk7XG4gIH1cblxuICBhc3luYyBlZGl0Qm9va21hcmtzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbml0aWFsU3RhdGU6IFBpY2s8RWRpdEJvb2ttYXJrc0NvbXBvbmVudCwgJ2Jvb2ttYXJrcyc+ID0ge1xuICAgICAgICBib29rbWFya3M6IGNsb25lRGVlcCh0aGlzLmJvb2ttYXJrcylcbiAgICAgIH07XG4gICAgICBjb25zdCBtb2RhbFJlZiA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhFZGl0Qm9va21hcmtzQ29tcG9uZW50LCB7XG4gICAgICAgIGNsYXNzOiAnbW9kYWwtbWQnLFxuICAgICAgICBhcmlhRGVzY3JpYmVkYnk6ICdtb2RhbC1ib2R5JyxcbiAgICAgICAgYXJpYUxhYmVsbGVkQnk6ICdtb2RhbC10aXRsZScsXG4gICAgICAgIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlLFxuICAgICAgICBpZ25vcmVCYWNrZHJvcENsaWNrOiB0cnVlXG4gICAgICB9KS5jb250ZW50IGFzIEVkaXRCb29rbWFya3NDb21wb25lbnQ7XG4gICAgICB0aGlzLmJvb2ttYXJrcyA9IGF3YWl0IG1vZGFsUmVmLnJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICBvcGVuVXJsKHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgcGFyc2VkVXJsID0gbmV3IFVSTCh1cmwpO1xuXG4gICAgaWYgKFxuICAgICAgcGFyc2VkVXJsLmhvc3RuYW1lID09PSBsb2NhdGlvbi5ob3N0bmFtZSAmJlxuICAgICAgcGFyc2VkVXJsLnBhdGhuYW1lLmluY2x1ZGVzKGxvY2F0aW9uLnBhdGhuYW1lKVxuICAgICkge1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChwYXJzZWRVcmwuaGFzaC5zdWJzdHJpbmcoMSkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG9ubHkgcG9zc2libGUgaWYgdGhlIGV4dGVybmFsIGJvb2ttYXJrIFVSTCBoYXMgYmVlbiBzYXZlZCB1c2luZyB0aGUgQVBJXG4gICAgaWYgKHBhcnNlZFVybC5ob3N0bmFtZSAhPT0gbG9jYXRpb24uaG9zdG5hbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB3aW5kb3cub3Blbih1cmwsICdfc2VsZicpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0Qm9va21hcmtMaW5rVG9PYmplY3QodXJsOiBzdHJpbmcsIGljb246IHN0cmluZyk6IEJvb2ttYXJrIHtcbiAgICBjb25zdCB0aXRsZTogc3RyaW5nID0gdGhpcy5kb2N1bWVudC50aXRsZTtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoaXMuYm9va21hcmtTZXJ2aWNlLmdlbmVyYXRlUmFuZG9tSUQoKSxcbiAgICAgIGxhYmVsOiB0aXRsZS5pbmNsdWRlcygnQ3VtdWxvY2l0eScpID8gdGl0bGUucmVwbGFjZSgnQ3VtdWxvY2l0eSAtICcsICcnKSA6ICdCb29rbWFyaycsXG4gICAgICB1cmwsXG4gICAgICBpY29uXG4gICAgfTtcbiAgfVxufVxuIiwiPGRpdiBjbGFzcz1cInNlcGFyYXRvci10b3AgcC10LTggbS10LWF1dG8gYzh5LXJpZ2h0LWRyYXdlcl9faXRlbSBzdGlja3ktdG9wXCI+XG4gIDxpIGM4eUljb249XCJib29rbWFya1wiPjwvaT5cbiAgPHNwYW4gY2xhc3M9XCJ0ZXh0LWJvbGRcIj57eyAnQm9va21hcmtzJyB8IHRyYW5zbGF0ZSB9fTwvc3Bhbj5cbiAgPGJ1dHRvblxuICAgIGNsYXNzPVwiYnRuLWRvdCBtLWwtYXV0b1wiXG4gICAgdG9vbHRpcD1cInt7ICdFZGl0IGJvb2ttYXJrcycgfCB0cmFuc2xhdGUgfX1cIlxuICAgIFthdHRyLmFyaWEtbGFiZWxdPVwiJ0VkaXQgYm9va21hcmtzJyB8IHRyYW5zbGF0ZVwiXG4gICAgY29udGFpbmVyPVwiYm9keVwiXG4gICAgcGxhY2VtZW50PVwibGVmdFwiXG4gICAgW2FkYXB0aXZlUG9zaXRpb25dPVwiZmFsc2VcIlxuICAgIFtkZWxheV09XCI1MDBcIlxuICAgIChjbGljayk9XCJlZGl0Qm9va21hcmtzKClcIlxuICAgIHR5cGU9XCJidXR0b25cIlxuICAgIFt0YWJpbmRleF09XCIoZHJhd2VyT3BlbiQgfCBhc3luYykgPyAnMCcgOiAnLTEnXCJcbiAgPlxuICAgIDxpIGM4eUljb249XCJjb2dcIiBjbGFzcz1cInRleHQtMTQgbS0wXCI+PC9pPlxuICA8L2J1dHRvbj5cbjwvZGl2PlxuPGRpdiBjbGFzcz1cImM4eS1yaWdodC1kcmF3ZXJfX2l0ZW0gcC10LTAgcC1iLThcIiAqbmdJZj1cImJvb2ttYXJrcz8ubGVuZ3RoXCI+XG4gIDxidXR0b25cbiAgICBjbGFzcz1cImJ0biBidG4tZGVmYXVsdCBidG4tc21cIlxuICAgIChjbGljayk9XCJhZGRCb29rbWFyaygpXCJcbiAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICBbdGFiaW5kZXhdPVwiKGRyYXdlck9wZW4kIHwgYXN5bmMpID8gJzAnIDogJy0xJ1wiXG4gID5cbiAgICA8aSBjOHlJY29uPVwicGx1cy1jaXJjbGUtb1wiIGNsYXNzPVwibS10LTAgbS1iLTAgdGV4dC0xNFwiPjwvaT5cbiAgICA8c3Bhbj57eyBhZGRCdXR0b25UZXh0IH19PC9zcGFuPlxuICA8L2J1dHRvbj5cbjwvZGl2PlxuPG5nLWNvbnRhaW5lciAqbmdGb3I9XCJsZXQgYm9va21hcmsgb2YgYm9va21hcmtzXCI+XG4gIDxidXR0b25cbiAgICB0aXRsZT1cInt7IGJvb2ttYXJrLmxhYmVsIH19XCJcbiAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICBjbGFzcz1cImM4eS1yaWdodC1kcmF3ZXJfX2xpbmtcIlxuICAgIChjbGljayk9XCJvcGVuVXJsKGJvb2ttYXJrLnVybClcIlxuICAgIFt0YWJpbmRleF09XCIoZHJhd2VyT3BlbiQgfCBhc3luYykgPyAnMCcgOiAnLTEnXCJcbiAgPlxuICAgIDxpIFtjOHlJY29uXT1cImJvb2ttYXJrLmljb25cIiAqbmdJZj1cImJvb2ttYXJrLmljb25cIj48L2k+XG4gICAgPHNwYW4gY2xhc3M9XCJ0ZXh0LXRydW5jYXRlXCI+e3sgYm9va21hcmsubGFiZWwgfX08L3NwYW4+XG4gIDwvYnV0dG9uPlxuPC9uZy1jb250YWluZXI+XG48ZGl2IGNsYXNzPVwicC10LTggcC1iLThcIj5cbiAgPG5nLWNvbnRhaW5lciAqbmdJZj1cIiFib29rbWFya3M/Lmxlbmd0aFwiPlxuICAgIDxzcGFuIGNsYXNzPVwiYzh5LXJpZ2h0LWRyYXdlcl9faXRlbSB0ZXh0LW11dGVkIHRleHQtYm9sZCB0ZXh0LTE0IHAtYi0wXCI+XG4gICAgICB7eyBlbXB0eU1lc3NhZ2VIZWFkZXIgfX1cbiAgICA8L3NwYW4+XG4gICAgPHNwYW4gY2xhc3M9XCJjOHktcmlnaHQtZHJhd2VyX19pdGVtIHRleHQtMTIgcC10LTBcIj5cbiAgICAgIDxzcGFuIGNsYXNzPVwidGV4dC1tdXRlZFwiPnt7IGVtcHR5TWVzc2FnZUJvZHkgfX08L3NwYW4+XG4gICAgPC9zcGFuPlxuICAgIDxkaXYgY2xhc3M9XCJjOHktcmlnaHQtZHJhd2VyX19pdGVtXCI+XG4gICAgICA8YnV0dG9uXG4gICAgICAgIGNsYXNzPVwiYnRuIGJ0bi1kZWZhdWx0IGJ0bi1zbVwiXG4gICAgICAgIChjbGljayk9XCJhZGRCb29rbWFyaygpXCJcbiAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgIFt0YWJpbmRleF09XCIoZHJhd2VyT3BlbiQgfCBhc3luYykgPyAnMCcgOiAnLTEnXCJcbiAgICAgID5cbiAgICAgICAgPGkgYzh5SWNvbj1cInBsdXMtY2lyY2xlLW9cIiBjbGFzcz1cIm0tdC0wIG0tYi0wIHRleHQtMTRcIj48L2k+XG4gICAgICAgIDxzcGFuPnt7IGFkZEJ1dHRvblRleHQgfX08L3NwYW4+XG4gICAgICA8L2J1dHRvbj5cbiAgICA8L2Rpdj5cbiAgPC9uZy1jb250YWluZXI+XG48L2Rpdj5cbiJdfQ==