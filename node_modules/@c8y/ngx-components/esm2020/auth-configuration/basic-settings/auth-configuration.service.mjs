import { Injectable } from '@angular/core';
import { GrantType, SystemOptionsService, TenantLoginOptionsService, TenantLoginOptionType, TenantOptionsService, UserManagementSource, TenantService } from '@c8y/client';
import { catchError, map } from 'rxjs/operators';
import { forkJoin, from, of } from 'rxjs';
import { defaults } from 'lodash-es';
import { AppStateService, TenantUiService } from '@c8y/ngx-components';
import { TypedOption } from './typed-option';
import { TenantLoginOptionMapper } from './tenant-login-option.mapper';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "./tenant-login-option.mapper";
export class AuthConfigurationService {
    constructor(tenantLoginOptionsService, tenantOptionsService, systemOptionsService, appState, tenantUiService, tenantLoginOptionMapper, tenantService) {
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.tenantOptionsService = tenantOptionsService;
        this.systemOptionsService = systemOptionsService;
        this.appState = appState;
        this.tenantUiService = tenantUiService;
        this.tenantLoginOptionMapper = tenantLoginOptionMapper;
        this.tenantService = tenantService;
        this.systemOptionsWithDefaultValue = [
            new TypedOption('password', 'limit.validity', 'number', null),
            new TypedOption('password', 'enforce.strength', 'boolean', false),
            new TypedOption('two-factor-authentication', 'tenant-scope-settings.enabled', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enabled', 'boolean', false),
            // note: this definition is inconsistent with backend and is overridden in getSystemOptions$
            new TypedOption('two-factor-authentication', 'enforced', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enforced.group', 'string', '')
        ];
        this.tenantOptionsWithDefaultValue = [
            new TypedOption('password', 'limit.validity', 'number', 0),
            new TypedOption('password', 'strength.validity', 'boolean', false),
            new TypedOption('two-factor-authentication', 'enabled', 'boolean', false),
            new TypedOption('two-factor-authentication', 'token.validity', 'number', 43200),
            new TypedOption('two-factor-authentication', 'pin.validity', 'number', 30),
            new TypedOption('two-factor-authentication', 'enforced', 'boolean', false),
            new TypedOption('two-factor-authentication', 'strategy', 'string', 'SMS'),
            new TypedOption('oauth.internal', 'basic-token.lifespan.seconds', 'number', null)
        ];
    }
    getAuthConfiguration$() {
        const loginOptions$ = this.getLoginOptions$();
        return forkJoin({
            loginOptions: this.map(loginOptions$),
            tenantOptions: this.getTenantOptions$(),
            systemOptions: this.getSystemOptions$(),
            smsGatewayAvailable: this.isSmsApplicationAvailable$(),
            preferredLoginOptionType: this.getPreferredLoginOptionType$(loginOptions$)
        });
    }
    save(newAuthConfiguration, previousAuthConfiguration) {
        const tenantOptions = this.prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration);
        const updateTenantOptions = tenantOptions.map(tenantOption => this.tenantOptionsService.create(tenantOption));
        const basicLoginOption = this.prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration);
        const oauthInternalLoginOption = this.prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration);
        return Promise.all([
            this.saveOrUpdateLoginOption(basicLoginOption),
            this.saveOrUpdateLoginOption(oauthInternalLoginOption),
            updateTenantOptions
        ]);
    }
    map(loginOptions$) {
        return loginOptions$.pipe(map(loginOptions => loginOptions.map(loginOption => this.tenantLoginOptionMapper.mapTo(loginOption))));
    }
    saveOrUpdateLoginOption(loginOption) {
        return loginOption.id
            ? this.tenantLoginOptionsService.update(loginOption)
            : this.tenantLoginOptionsService.create(loginOption);
    }
    prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        const basicLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.BASIC);
        return this.tenantLoginOptionMapper.mapFrom(basicLoginOption, this.getLoginOptionFromAuthConfiguration(newAuthConfiguration, TenantLoginOptionType.BASIC));
    }
    prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        const oauthInternalLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        oauthInternalLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        return this.tenantLoginOptionMapper.mapFrom(oauthInternalLoginOption, this.getLoginOptionFromAuthConfiguration(newAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL));
    }
    originalLoginOptionWithDefaults(previousAuthConfiguration, loginOptionType) {
        return defaults({}, this.getLoginOptionFromAuthConfiguration(previousAuthConfiguration, loginOptionType), this.getDefaultLoginOption(loginOptionType));
    }
    getLoginOptionFromAuthConfiguration(authConfiguration, loginOptionType) {
        return authConfiguration.loginOptions.find(loginOption => loginOption.type === loginOptionType);
    }
    visibleOnLoginPage(authConfiguration, loginOptionType) {
        return authConfiguration.preferredLoginOptionType === loginOptionType;
    }
    prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration) {
        const getValue = (authCfg, tenantOption) => authCfg.tenantOptions[tenantOption.category][tenantOption.key];
        const hasChanged = tenantOption => getValue(newAuthConfiguration, tenantOption) !==
            getValue(previousAuthConfiguration, tenantOption);
        return this.tenantOptionsWithDefaultValue
            .filter(tenantOption => getValue(newAuthConfiguration, tenantOption) !== null)
            .filter(tenantOption => hasChanged(tenantOption))
            .map(tenantOption => ({
            category: tenantOption.category,
            key: tenantOption.key,
            value: getValue(newAuthConfiguration, tenantOption).toString()
        }));
    }
    getLoginOptions$() {
        return from(this.tenantLoginOptionsService.listForCurrentTenant()).pipe(map(res => res.data), map(loginOptions => this.addDefaultLoginOptions(loginOptions)));
    }
    getPreferredLoginOptionType$(loginOptions$) {
        return loginOptions$.pipe(map(loginOptions => {
            return this.tenantUiService.getPreferredLoginOption(loginOptions).type;
        }));
    }
    addDefaultLoginOptions(loginOptions) {
        if (!loginOptions.find(this.tenantUiService.isBasic)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.BASIC));
        }
        if (!loginOptions.find(this.tenantUiService.isOauthInternal)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.OAUTH2_INTERNAL));
        }
        return loginOptions;
    }
    getTenantOptions$() {
        return forkJoin(this.tenantOptionsWithDefaultValue.map((option) => from(this.tenantOptionsService.detail(option)).pipe(map(res => {
            option.apply(res.data);
            return option;
        }), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    getSystemOptions$() {
        return forkJoin(this.systemOptionsWithDefaultValue.map((option) => {
            const fixedOption = this.fixTfaEnforcedSystemOption(option);
            if (fixedOption) {
                return fixedOption;
            }
            return from(this.systemOptionsService.detail(option)).pipe(map(res => {
                option.apply(res.data);
                return option;
            }), catchError(() => of(option)));
        })).pipe(map(options => this.getOptionsObject(options)));
    }
    /**
     * Returns an observable with fixed `two-factor-authentication.enforced` system option or null.
     * This method fixes problem with inconsistent value. System option `two-factor-authentication.enforced` is list of tenants when UI using boolean value.
     * This part will be removed after implementing new endpoint in MTM-50490.
     */
    fixTfaEnforcedSystemOption(option) {
        if (option.category === 'two-factor-authentication' && option.key === 'enforced') {
            return from(this.tenantService.getTfaSettings(this.tenantUiService.currentTenant)).pipe(map(tfaSettings => {
                option.value = tfaSettings.enforcedOnSystemLevel.toString();
                return option;
            }));
        }
        return null;
    }
    isSmsApplicationAvailable$() {
        return from(this.appState.isApplicationAvailable('sms-gateway'));
    }
    getOptionsObject(options) {
        return options.reduce((optionsObject, option) => {
            optionsObject[option.category] = optionsObject[option.category] || {};
            optionsObject[option.category][option.key] = option.getValue();
            return optionsObject;
        }, {});
    }
    getDefaultLoginOption(tenantLoginOptionType) {
        return {
            userManagementSource: UserManagementSource.INTERNAL,
            grantType: GrantType.PASSWORD,
            providerName: 'Cumulocity',
            visibleOnLoginPage: false,
            type: tenantLoginOptionType
        };
    }
}
AuthConfigurationService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AuthConfigurationService, deps: [{ token: i1.TenantLoginOptionsService }, { token: i1.TenantOptionsService }, { token: i1.SystemOptionsService }, { token: i2.AppStateService }, { token: i2.TenantUiService }, { token: i3.TenantLoginOptionMapper }, { token: i1.TenantService }], target: i0.ɵɵFactoryTarget.Injectable });
AuthConfigurationService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AuthConfigurationService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AuthConfigurationService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.TenantLoginOptionsService }, { type: i1.TenantOptionsService }, { type: i1.SystemOptionsService }, { type: i2.AppStateService }, { type: i2.TenantUiService }, { type: i3.TenantLoginOptionMapper }, { type: i1.TenantService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9hdXRoLWNvbmZpZ3VyYXRpb24vYmFzaWMtc2V0dGluZ3MvYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsU0FBUyxFQUlULG9CQUFvQixFQUNwQix5QkFBeUIsRUFDekIscUJBQXFCLEVBQ3JCLG9CQUFvQixFQUNwQixvQkFBb0IsRUFDcEIsYUFBYSxFQUNkLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFckMsT0FBTyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0MsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7Ozs7O0FBR3ZFLE1BQU0sT0FBTyx3QkFBd0I7SUFzQm5DLFlBQ1UseUJBQW9ELEVBQ3BELG9CQUEwQyxFQUMxQyxvQkFBMEMsRUFDMUMsUUFBeUIsRUFDekIsZUFBZ0MsRUFDaEMsdUJBQWdELEVBQ2hELGFBQTRCO1FBTjVCLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQ3pCLG9CQUFlLEdBQWYsZUFBZSxD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LENBQUM7SUFDbkUsQ0FBQztJQUVPLGdCQUFnQixDQUFDLE9BQXNCO1FBQzdDLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUM5QyxhQUFhLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3RFLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMvRCxPQUFPLGFBQWEsQ0FBQztRQUN2QixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDO0lBRU8scUJBQXFCLENBQUMscUJBQTRDO1FBQ3hFLE9BQU87WUFDTCxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxRQUFRO1lBQ25ELFNBQVMsRUFBRSxTQUFTLENBQUMsUUFBUTtZQUM3QixZQUFZLEVBQUUsWUFBWTtZQUMxQixrQkFBa0IsRUFBRSxLQUFLO1lBQ3pCLElBQUksRUFBRSxxQkFBcUI7U0FDNUIsQ0FBQztJQUNKLENBQUM7O3FIQXhRVSx3QkFBd0I7eUhBQXhCLHdCQUF3QjsyRkFBeEIsd0JBQXdCO2tCQURwQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgR3JhbnRUeXBlLFxuICBJUmVzdWx0LFxuICBJVGVuYW50TG9naW5PcHRpb24sXG4gIElUZW5hbnRPcHRpb24sXG4gIFN5c3RlbU9wdGlvbnNTZXJ2aWNlLFxuICBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLFxuICBUZW5hbnRMb2dpbk9wdGlvblR5cGUsXG4gIFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICBVc2VyTWFuYWdlbWVudFNvdXJjZSxcbiAgVGVuYW50U2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlZmF1bHRzIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEF1dGhDb25maWd1cmF0aW9uLCBPcHRpb25zIH0gZnJvbSAnLi9hdXRoLWNvbmZpZ3VyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlLCBUZW5hbnRVaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFR5cGVkT3B0aW9uIH0gZnJvbSAnLi90eXBlZC1vcHRpb24nO1xuaW1wb3J0IHsgVGVuYW50TG9naW5PcHRpb24gfSBmcm9tICcuL2Jhc2ljLXNldHRpbmdzLm1vZGVsJztcbmltcG9ydCB7IFRlbmFudExvZ2luT3B0aW9uTWFwcGVyIH0gZnJvbSAnLi90ZW5hbnQtbG9naW4tb3B0aW9uLm1hcHBlcic7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoQ29uZmlndXJhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHN5c3RlbU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlOiBUeXBlZE9wdGlvbltdID0gW1xuICAgIG5ldyBUeXBlZE9wdGlvbigncGFzc3dvcmQnLCAnbGltaXQudmFsaWRpdHknLCAnbnVtYmVyJywgbnVsbCksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdwYXNzd29yZCcsICdlbmZvcmNlLnN0cmVuZ3RoJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ3RlbmFudC1zY29wZS1zZXR0aW5ncy5lbmFibGVkJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ2VuYWJsZWQnLCAnYm9vbGVhbicsIGZhbHNlKSxcbiAgICAvLyBub3RlOiB0aGlzIGRlZmluaXRpb24gaXMgaW5jb25zaXN0ZW50IHdpdGggYmFja2VuZCBhbmQgaXMgb3ZlcnJpZGRlbiBpbiBnZXRTeXN0ZW1PcHRpb25zJFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZCcsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZC5ncm91cCcsICdzdHJpbmcnLCAnJylcbiAgXTtcblxuICBwcml2YXRlIHRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlOiBUeXBlZE9wdGlvbltdID0gW1xuICAgIG5ldyBUeXBlZE9wdGlvbigncGFzc3dvcmQnLCAnbGltaXQudmFsaWRpdHknLCAnbnVtYmVyJywgMCksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdwYXNzd29yZCcsICdzdHJlbmd0aC52YWxpZGl0eScsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmFibGVkJywgJ2Jvb2xlYW4nLCBmYWxzZSksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywgJ3Rva2VuLnZhbGlkaXR5JywgJ251bWJlcicsIDQzMjAwKSwgLy8gMzAgZGF5c1xuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdwaW4udmFsaWRpdHknLCAnbnVtYmVyJywgMzApLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdlbmZvcmNlZCcsICdib29sZWFuJywgZmFsc2UpLFxuICAgIG5ldyBUeXBlZE9wdGlvbigndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsICdzdHJhdGVneScsICdzdHJpbmcnLCAnU01TJyksXG4gICAgbmV3IFR5cGVkT3B0aW9uKCdvYXV0aC5pbnRlcm5hbCcsICdiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJywgJ251bWJlcicsIG51bGwpXG4gIF07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0ZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50T3B0aW9uc1NlcnZpY2U6IFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3lzdGVtT3B0aW9uc1NlcnZpY2U6IFN5c3RlbU9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudFVpU2VydmljZTogVGVuYW50VWlTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50TG9naW5PcHRpb25NYXBwZXI6IFRlbmFudExvZ2luT3B0aW9uTWFwcGVyLFxuICAgIHByaXZhdGUgdGVuYW50U2VydmljZTogVGVuYW50U2VydmljZVxuICApIHt9XG5cbiAgZ2V0QXV0aENvbmZpZ3VyYXRpb24kKCk6IE9ic2VydmFibGU8QXV0aENvbmZpZ3VyYXRpb24+IHtcbiAgICBjb25zdCBsb2dpbk9wdGlvbnMkID0gdGhpcy5nZXRMb2dpbk9wdGlvbnMkKCk7XG4gICAgcmV0dXJuIGZvcmtKb2luKHtcbiAgICAgIGxvZ2luT3B0aW9uczogdGhpcy5tYXAobG9naW5PcHRpb25zJCksXG4gICAgICB0ZW5hbnRPcHRpb25zOiB0aGlzLmdldFRlbmFudE9wdGlvbnMkKCksXG4gICAgICBzeXN0ZW1PcHRpb25zOiB0aGlzLmdldFN5c3RlbU9wdGlvbnMkKCksXG4gICAgICBzbXNHYXRld2F5QXZhaWxhYmxlOiB0aGlzLmlzU21zQXBwbGljYXRpb25BdmFpbGFibGUkKCksXG4gICAgICBwcmVmZXJyZWRMb2dpbk9wdGlvblR5cGU6IHRoaXMuZ2V0UHJlZmVycmVkTG9naW5PcHRpb25UeXBlJChsb2dpbk9wdGlvbnMkKVxuICAgIH0pO1xuICB9XG5cbiAgc2F2ZShuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uKSB7XG4gICAgY29uc3QgdGVuYW50T3B0aW9ucyA9IHRoaXMucHJlcGFyZVRlbmFudE9wdGlvbnMoXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb25cbiAgICApO1xuICAgIGNvbnN0IHVwZGF0ZVRlbmFudE9wdGlvbnMgPSB0ZW5hbnRPcHRpb25zLm1hcCh0ZW5hbnRPcHRpb24gPT5cbiAgICAgIHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UuY3JlYXRlKHRlbmFudE9wdGlvbilcbiAgICApO1xuICAgIGNvbnN0IGJhc2ljTG9naW5PcHRpb24gPSB0aGlzLnByZXBhcmVCYXNpY0xvZ2luT3B0aW9uKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uXG4gICAgKTtcbiAgICBjb25zdCBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLnByZXBhcmVPYXV0aEludGVybmFsTG9naW5PcHRpb24oXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb25cbiAgICApO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMuc2F2ZU9yVXBkYXRlTG9naW5PcHRpb24oYmFzaWNMb2dpbk9wdGlvbiksXG4gICAgICB0aGlzLnNhdmVPclVwZGF0ZUxvZ2luT3B0aW9uKG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbiksXG4gICAgICB1cGRhdGVUZW5hbnRPcHRpb25zXG4gICAgXSk7XG4gIH1cblxuICBwcml2YXRlIG1hcChsb2dpbk9wdGlvbnMkOiBPYnNlcnZhYmxlPElUZW5hbnRMb2dpbk9wdGlvbltdPik6IE9ic2VydmFibGU8VGVuYW50TG9naW5PcHRpb25bXT4ge1xuICAgIHJldHVybiBsb2dpbk9wdGlvbnMkLnBpcGUoXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+XG4gICAgICAgIGxvZ2luT3B0aW9ucy5tYXAobG9naW5PcHRpb24gPT4gdGhpcy50ZW5hbnRMb2dpbk9wdGlvbk1hcHBlci5tYXBUbyhsb2dpbk9wdGlvbikpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZU9yVXBkYXRlTG9naW5PcHRpb24oXG4gICAgbG9naW5PcHRpb246IElUZW5hbnRMb2dpbk9wdGlvblxuICApOiBQcm9taXNlPElSZXN1bHQ8SVRlbmFudExvZ2luT3B0aW9uPj4ge1xuICAgIHJldHVybiBsb2dpbk9wdGlvbi5pZFxuICAgICAgPyB0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UudXBkYXRlKGxvZ2luT3B0aW9uKVxuICAgICAgOiB0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UuY3JlYXRlKGxvZ2luT3B0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZUJhc2ljTG9naW5PcHRpb24oXG4gICAgbmV3QXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLFxuICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uXG4gICk6IElUZW5hbnRMb2dpbk9wdGlvbiB7XG4gICAgY29uc3QgYmFzaWNMb2dpbk9wdGlvbiA9IHRoaXMub3JpZ2luYWxMb2dpbk9wdGlvbldpdGhEZWZhdWx0cyhcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUNcbiAgICApO1xuICAgIGJhc2ljTG9naW5PcHRpb24udmlzaWJsZU9uTG9naW5QYWdlID0gdGhpcy52aXNpYmxlT25Mb2dpblBhZ2UoXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIFRlbmFudExvZ2luT3B0aW9uVHlwZS5CQVNJQ1xuICAgICk7XG4gICAgcmV0dXJuIHRoaXMudGVuYW50TG9naW5PcHRpb25NYXBwZXIubWFwRnJvbShcbiAgICAgIGJhc2ljTG9naW5PcHRpb24sXG4gICAgICB0aGlzLmdldExvZ2luT3B0aW9uRnJvbUF1dGhDb25maWd1cmF0aW9uKG5ld0F1dGhDb25maWd1cmF0aW9uLCBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUMpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZU9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbihcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICBjb25zdCBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLm9yaWdpbmFsTG9naW5PcHRpb25XaXRoRGVmYXVsdHMoXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTFxuICAgICk7XG4gICAgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnZpc2libGVPbkxvZ2luUGFnZSA9IHRoaXMudmlzaWJsZU9uTG9naW5QYWdlKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuT0FVVEgyX0lOVEVSTkFMXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy50ZW5hbnRMb2dpbk9wdGlvbk1hcHBlci5tYXBGcm9tKFxuICAgICAgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLFxuICAgICAgdGhpcy5nZXRMb2dpbk9wdGlvbkZyb21BdXRoQ29uZmlndXJhdGlvbihcbiAgICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICAgIFRlbmFudExvZ2luT3B0aW9uVHlwZS5PQVVUSDJfSU5URVJOQUxcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBvcmlnaW5hbExvZ2luT3B0aW9uV2l0aERlZmF1bHRzKFxuICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLFxuICAgIGxvZ2luT3B0aW9uVHlwZTogVGVuYW50TG9naW5PcHRpb25UeXBlXG4gICk6IFRlbmFudExvZ2luT3B0aW9uIHtcbiAgICByZXR1cm4gZGVmYXVsdHMoXG4gICAgICB7fSxcbiAgICAgIHRoaXMuZ2V0TG9naW5PcHRpb25Gcm9tQXV0aENvbmZpZ3VyYXRpb24ocHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbiwgbG9naW5PcHRpb25UeXBlKSxcbiAgICAgIHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKGxvZ2luT3B0aW9uVHlwZSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMb2dpbk9wdGlvbkZyb21BdXRoQ29uZmlndXJhdGlvbihcbiAgICBhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgbG9naW5PcHRpb25UeXBlOiBUZW5hbnRMb2dpbk9wdGlvblR5cGVcbiAgKSB7XG4gICAgcmV0dXJuIGF1dGhDb25maWd1cmF0aW9uLmxvZ2luT3B0aW9ucy5maW5kKGxvZ2luT3B0aW9uID0+IGxvZ2luT3B0aW9uLnR5cGUgPT09IGxvZ2luT3B0aW9uVHlwZSk7XG4gIH1cblxuICBwcml2YXRlIHZpc2libGVPbkxvZ2luUGFnZShcbiAgICBhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgbG9naW5PcHRpb25UeXBlOiBUZW5hbnRMb2dpbk9wdGlvblR5cGVcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGF1dGhDb25maWd1cmF0aW9uLnByZWZlcnJlZExvZ2luT3B0aW9uVHlwZSA9PT0gbG9naW5PcHRpb25UeXBlO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlVGVuYW50T3B0aW9ucyhcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudE9wdGlvbltdIHtcbiAgICBjb25zdCBnZXRWYWx1ZSA9IChhdXRoQ2ZnLCB0ZW5hbnRPcHRpb24pID0+XG4gICAgICBhdXRoQ2ZnLnRlbmFudE9wdGlvbnNbdGVuYW50T3B0aW9uLmNhdGVnb3J5XVt0ZW5hbnRPcHRpb24ua2V5XTtcbiAgICBjb25zdCBoYXNDaGFuZ2VkID0gdGVuYW50T3B0aW9uID0+XG4gICAgICBnZXRWYWx1ZShuZXdBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKSAhPT1cbiAgICAgIGdldFZhbHVlKHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbik7XG5cbiAgICByZXR1cm4gdGhpcy50ZW5hbnRPcHRpb25zV2l0aERlZmF1bHRWYWx1ZVxuICAgICAgLmZpbHRlcih0ZW5hbnRPcHRpb24gPT4gZ2V0VmFsdWUobmV3QXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbikgIT09IG51bGwpXG4gICAgICAuZmlsdGVyKHRlbmFudE9wdGlvbiA9PiBoYXNDaGFuZ2VkKHRlbmFudE9wdGlvbikpXG4gICAgICAubWFwKHRlbmFudE9wdGlvbiA9PiAoe1xuICAgICAgICBjYXRlZ29yeTogdGVuYW50T3B0aW9uLmNhdGVnb3J5LFxuICAgICAgICBrZXk6IHRlbmFudE9wdGlvbi5rZXksXG4gICAgICAgIHZhbHVlOiBnZXRWYWx1ZShuZXdBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKS50b1N0cmluZygpXG4gICAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGdldExvZ2luT3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS5saXN0Rm9yQ3VycmVudFRlbmFudCgpKS5waXBlKFxuICAgICAgbWFwKHJlcyA9PiByZXMuZGF0YSksXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+IHRoaXMuYWRkRGVmYXVsdExvZ2luT3B0aW9ucyhsb2dpbk9wdGlvbnMpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFByZWZlcnJlZExvZ2luT3B0aW9uVHlwZSQoXG4gICAgbG9naW5PcHRpb25zJDogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT5cbiAgKTogT2JzZXJ2YWJsZTxUZW5hbnRMb2dpbk9wdGlvblR5cGU+IHtcbiAgICByZXR1cm4gbG9naW5PcHRpb25zJC5waXBlKFxuICAgICAgbWFwKGxvZ2luT3B0aW9ucyA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRlbmFudFVpU2VydmljZS5nZXRQcmVmZXJyZWRMb2dpbk9wdGlvbihsb2dpbk9wdGlvbnMpLnR5cGU7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZERlZmF1bHRMb2dpbk9wdGlvbnMobG9naW5PcHRpb25zOiBJVGVuYW50TG9naW5PcHRpb25bXSkge1xuICAgIGlmICghbG9naW5PcHRpb25zLmZpbmQodGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNCYXNpYykpIHtcbiAgICAgIGxvZ2luT3B0aW9ucy5wdXNoKHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKFRlbmFudExvZ2luT3B0aW9uVHlwZS5CQVNJQykpO1xuICAgIH1cbiAgICBpZiAoIWxvZ2luT3B0aW9ucy5maW5kKHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbCkpIHtcbiAgICAgIGxvZ2luT3B0aW9ucy5wdXNoKHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKFRlbmFudExvZ2luT3B0aW9uVHlwZS5PQVVUSDJfSU5URVJOQUwpKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ2luT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VGVuYW50T3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxPcHRpb25zPiB7XG4gICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgdGhpcy50ZW5hbnRPcHRpb25zV2l0aERlZmF1bHRWYWx1ZS5tYXAoKG9wdGlvbjogVHlwZWRPcHRpb24pID0+XG4gICAgICAgIGZyb20odGhpcy50ZW5hbnRPcHRpb25zU2VydmljZS5kZXRhaWwob3B0aW9uKSkucGlwZShcbiAgICAgICAgICBtYXAocmVzID0+IHtcbiAgICAgICAgICAgIG9wdGlvbi5hcHBseShyZXMuZGF0YSk7XG4gICAgICAgICAgICByZXR1cm4gb3B0aW9uO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yob3B0aW9uKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICkucGlwZShtYXAob3B0aW9ucyA9PiB0aGlzLmdldE9wdGlvbnNPYmplY3Qob3B0aW9ucykpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3lzdGVtT3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxPcHRpb25zPiB7XG4gICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgdGhpcy5zeXN0ZW1PcHRpb25zV2l0aERlZmF1bHRWYWx1ZS5tYXAoKG9wdGlvbjogVHlwZWRPcHRpb24pID0+IHtcbiAgICAgICAgY29uc3QgZml4ZWRPcHRpb24gPSB0aGlzLmZpeFRmYUVuZm9yY2VkU3lzdGVtT3B0aW9uKG9wdGlvbik7XG4gICAgICAgIGlmIChmaXhlZE9wdGlvbikge1xuICAgICAgICAgIHJldHVybiBmaXhlZE9wdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc3lzdGVtT3B0aW9uc1NlcnZpY2UuZGV0YWlsKG9wdGlvbikpLnBpcGUoXG4gICAgICAgICAgbWFwKHJlcyA9PiB7XG4gICAgICAgICAgICBvcHRpb24uYXBwbHkocmVzLmRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIG9wdGlvbjtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKG9wdGlvbikpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICkucGlwZShtYXAob3B0aW9ucyA9PiB0aGlzLmdldE9wdGlvbnNPYmplY3Qob3B0aW9ucykpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIG9ic2VydmFibGUgd2l0aCBmaXhlZCBgdHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbi5lbmZvcmNlZGAgc3lzdGVtIG9wdGlvbiBvciBudWxsLlxuICAgKiBUaGlzIG1ldGhvZCBmaXhlcyBwcm9ibGVtIHdpdGggaW5jb25zaXN0ZW50IHZhbHVlLiBTeXN0ZW0gb3B0aW9uIGB0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uLmVuZm9yY2VkYCBpcyBsaXN0IG9mIHRlbmFudHMgd2hlbiBVSSB1c2luZyBib29sZWFuIHZhbHVlLlxuICAgKiBUaGlzIHBhcnQgd2lsbCBiZSByZW1vdmVkIGFmdGVyIGltcGxlbWVudGluZyBuZXcgZW5kcG9pbnQgaW4gTVRNLTUwNDkwLlxuICAgKi9cbiAgcHJpdmF0ZSBmaXhUZmFFbmZvcmNlZFN5c3RlbU9wdGlvbihvcHRpb246IFR5cGVkT3B0aW9uKTogT2JzZXJ2YWJsZTxUeXBlZE9wdGlvbj4ge1xuICAgIGlmIChvcHRpb24uY2F0ZWdvcnkgPT09ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJyAmJiBvcHRpb24ua2V5ID09PSAnZW5mb3JjZWQnKSB7XG4gICAgICByZXR1cm4gZnJvbSh0aGlzLnRlbmFudFNlcnZpY2UuZ2V0VGZhU2V0dGluZ3ModGhpcy50ZW5hbnRVaVNlcnZpY2UuY3VycmVudFRlbmFudCkpLnBpcGUoXG4gICAgICAgIG1hcCh0ZmFTZXR0aW5ncyA9PiB7XG4gICAgICAgICAgb3B0aW9uLnZhbHVlID0gdGZhU2V0dGluZ3MuZW5mb3JjZWRPblN5c3RlbUxldmVsLnRvU3RyaW5nKCk7XG4gICAgICAgICAgcmV0dXJuIG9wdGlvbjtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Ntc0FwcGxpY2F0aW9uQXZhaWxhYmxlJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLmFwcFN0YXRlLmlzQXBwbGljYXRpb25BdmFpbGFibGUoJ3Ntcy1nYXRld2F5JykpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPcHRpb25zT2JqZWN0KG9wdGlvbnM6IFR5cGVkT3B0aW9uW10pIHtcbiAgICByZXR1cm4gb3B0aW9ucy5yZWR1Y2UoKG9wdGlvbnNPYmplY3QsIG9wdGlvbikgPT4ge1xuICAgICAgb3B0aW9uc09iamVjdFtvcHRpb24uY2F0ZWdvcnldID0gb3B0aW9uc09iamVjdFtvcHRpb24uY2F0ZWdvcnldIHx8IHt9O1xuICAgICAgb3B0aW9uc09iamVjdFtvcHRpb24uY2F0ZWdvcnldW29wdGlvbi5rZXldID0gb3B0aW9uLmdldFZhbHVlKCk7XG4gICAgICByZXR1cm4gb3B0aW9uc09iamVjdDtcbiAgICB9LCB7fSk7XG4gIH1cblxuICBwcml2YXRlIGdldERlZmF1bHRMb2dpbk9wdGlvbih0ZW5hbnRMb2dpbk9wdGlvblR5cGU6IFRlbmFudExvZ2luT3B0aW9uVHlwZSk6IElUZW5hbnRMb2dpbk9wdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJNYW5hZ2VtZW50U291cmNlOiBVc2VyTWFuYWdlbWVudFNvdXJjZS5JTlRFUk5BTCxcbiAgICAgIGdyYW50VHlwZTogR3JhbnRUeXBlLlBBU1NXT1JELFxuICAgICAgcHJvdmlkZXJOYW1lOiAnQ3VtdWxvY2l0eScsXG4gICAgICB2aXNpYmxlT25Mb2dpblBhZ2U6IGZhbHNlLFxuICAgICAgdHlwZTogdGVuYW50TG9naW5PcHRpb25UeXBlXG4gICAgfTtcbiAgfVxufVxuIl19