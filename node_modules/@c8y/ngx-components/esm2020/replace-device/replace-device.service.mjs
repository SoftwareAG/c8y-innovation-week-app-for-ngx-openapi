import { Injectable } from '@angular/core';
import { AuditRecordType, AuditService, EventService, IdentityService, InventoryService, QueriesUtil, UserService } from '@c8y/client';
import { AlertService, AppStateService, BreadcrumbService, gettext, toObservable } from '@c8y/ngx-components';
import { cloneDeep, pick } from 'lodash-es';
import { BehaviorSubject, combineLatest, forkJoin, from, of, pipe, Subject } from 'rxjs';
import { catchError, concatMap, distinctUntilChanged, map, scan, share, shareReplay, switchMap, tap, withLatestFrom } from 'rxjs/operators';
import { isValidReplaceDeviceStepState, REPLACE_DEVICE_STEP_STATE } from './replace-device.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@c8y/ngx-components";
export class ReplaceDeviceService {
    get drawerOpen$() {
        return this.drawerOpenedObs$;
    }
    get deviceToReplace$() {
        return this.deviceToReplaceObs$;
    }
    get replacementDeviceId$() {
        return this.replacementDeviceIdObs$;
    }
    constructor(inventory, identity, audit, event, user, appState, breadcrumbService, alert) {
        this.inventory = inventory;
        this.identity = identity;
        this.audit = audit;
        this.event = event;
        this.user = user;
        this.appState = appState;
        this.breadcrumbService = breadcrumbService;
        this.alert = alert;
        this.steps = [];
        this.drawerOpenSubject$ = new BehaviorSubject(false);
        this.drawerOpenedObs$ = this.drawerOpenSubject$
            .asObservable()
            .pipe(shareReplay());
        this.deviceToReplaceSubject$ = new BehaviorSubject(null);
        this.deviceToReplaceObs$ = this.deviceToReplaceSubject$
            .asObservable()
            .pipe(shareReplay());
        this.replacementDeviceIdSubject$ = new Subject();
        this.replacementDeviceIdObs$ = this.replacementDeviceIdSubject$
            .asObservable()
            .pipe(shareReplay());
        this.checkExternalId$ = new Subject();
        this.externalIdsLoadingSubject$ = new BehaviorSubject(false);
        this.triggerDeviceReplacementSubject$ = new Subject();
        this.deviceReplacementInProgressSubject$ = new Subject();
        this.queriesUtil = new QueriesUtil();
        this.externalIdsLoading$ = this.externalIdsLoadingSubject$.asObservable().pipe(shareReplay());
        this.externalIds$ = this.replacementDeviceIdSubject$.pipe(distinctUntilChanged(), tap(() => this.externalIdsLoadingSubject$.next(true)), switchMap(deviceId => this.identity.list(deviceId)), tap(() => this.externalIdsLoadingSubject$.next(false)), tap(() => this.checkExternalId(null, false)), catchError(err => {
            this.alert.addServerFailure(err);
            return of(null);
        }), shareReplay());
        this.externalIdsWithSelection$ = combineLatest([
            this.externalIds$.pipe(map(result => result?.data), map(externalIds => externalIds?.map(id => ({ id, selected: true })))),
            this.checkExternalId$
        ]).pipe(scan((acc, val) => {
            const [selectedIds, lastAction] = acc;
            const [_, checkAction] = val;
            if (!(lastAction?.checked === checkAction?.checked &&
                this.areExtIdsEqual(lastAction?.id, checkAction?.id))) {
                selectedIds.forEach(id => (id.selected = this.areExtIdsEqual(id.id, checkAction.id)
                    ? checkAction.checked
                    : id.selected));
            }
            return val;
        }), map(([externalIds]) => externalIds), shareReplay());
        this.selectedExternalIds$ = this.externalIdsWithSelection$.pipe(map(ids => ids.filter(id => id.selected).map(id => id.id)), shareReplay());
        this.defineSteps();
        const toContext = ([_, deviceToReplace, replacementDeviceId, newExternalIds]) => ({
            deviceToReplace,
            replacementDeviceId,
            newExternalIds
        });
        this.deviceReplaced$ = this.triggerDeviceReplacementSubject$.pipe(tap(() => this.deviceReplacementInProgressSubject$.next(true)), withLatestFrom(this.deviceToReplace$, this.replacementDeviceId$, this.selectedExternalIds$), map(toContext), concatMap(context => this.steps
            .map(step => this.executeStep(step))
            .reduce((ctx, step) => ctx.pipe(step), of(context))), tap(() => this.deviceReplacementInProgressSubject$.next(false)), map(() => !this.steps.some(step => step.state === 'Failed')), share());
        this.deviceReplacementInProgress$ = this.deviceReplacementInProgressSubject$
            .asObservable()
            .pipe(shareReplay());
    }
    openDrawer(deviceToReplace, closeCallback) {
        this.deviceToReplaceSubject$.next(deviceToReplace);
        this.drawerOpenSubject$.next(true);
        this.appendBreadcrumbs();
        this.closeCallback = closeCallback;
    }
    closeDrawer() {
        this.drawerOpenSubject$.next(false);
        this.removeBreadcrumbs();
        if (this.closeCallback && typeof this.closeCallback === 'function') {
            this.closeCallback();
        }
    }
    changeReplacementDeviceId(replacementDeviceId) {
        this.replacementDeviceIdSubject$.next(replacementDeviceId);
    }
    checkExternalId(id, checked) {
        this.checkExternalId$.next({ id, checked });
    }
    replaceDevice() {
        this.triggerDeviceReplacementSubject$.next();
    }
    retryStep(step) {
        this.steps.forEach(s => {
            if ((s.label === step?.label || !step) &&
                !ReplaceDeviceService.NON_REENTRANT_STATES.includes(s.state)) {
                s.skip = false;
                s.seed = s.context;
                s.state = 'Pending';
                delete s.error;
            }
            else {
                s.skip = true;
            }
        });
        this.replaceDevice();
    }
    resetSteps() {
        this.steps.forEach(s => {
            delete s.skip;
            delete s.error;
            delete s.state;
            delete s.context;
            delete s.seed;
        });
    }
    defineSteps() {
        this.steps = [
            {
                label: gettext('Gather required data'),
                overrideContext: true,
                action: (context) => {
                    const { deviceToReplace, replacementDeviceId, newExternalIds } = context;
                    if (deviceToReplace.id === replacementDeviceId) {
                        throw new Error(gettext('The device to replace and the replacement device cannot be one and the same device.'));
                    }
                    return forkJoin([
                        from(this.inventory.list({
                            query: this.queriesUtil.buildQuery({ owner: deviceToReplace.owner })
                        })).pipe(map(result => result?.data?.length === 1)),
                        from(this.inventory.detail(replacementDeviceId)).pipe(map(result => result?.data)),
                        from(this.identity.list(deviceToReplace.id)).pipe(map(result => result?.data))
                    ]).pipe(map(([deleteReplacedDeviceOwner, replacementDevice, oldExternalIds]) => ({
                        deviceToReplace,
                        replacementDevice,
                        newExternalIds,
                        oldExternalIds,
                        deleteReplacedDeviceOwner,
                        time: new Date().toISOString()
                    })));
                }
            },
            {
                label: gettext('Delete external IDs of replacement device'),
                action: (context) => {
                    const { newExternalIds } = context;
                    return forkJoin(newExternalIds.map(id => this.identity.delete(id)));
                }
            },
            {
                label: gettext('Create new external IDs for the original device'),
                action: (context) => {
                    const { newExternalIds, deviceToReplace } = context;
                    return forkJoin(newExternalIds
                        .map(extId => ({
                        ...pick(extId, ['type', 'externalId']),
                        managedObject: { ...pick(deviceToReplace, ['id']) }
                    }))
                        .map(id => this.identity.create(id)));
                }
            },
            {
                label: gettext('Delete old external IDs of original device'),
                action: (context) => {
                    const { oldExternalIds } = context;
                    return oldExternalIds?.length
                        ? forkJoin(oldExternalIds.map(id => this.identity.delete(id)))
                        : of(REPLACE_DEVICE_STEP_STATE.SKIPPED);
                },
                info: {
                    getMessage: (_, step) => step.state === 'Skipped'
                        ? gettext('No existing external IDs were determined.')
                        : undefined
                }
            },
            {
                label: gettext('Change owner of original device'),
                action: (context) => {
                    const { deviceToReplace, replacementDevice, oldExternalIds, time } = context;
                    return this.inventory.update({
                        id: deviceToReplace.id,
                        owner: replacementDevice.owner,
                        c8y_LastReplacement: {
                            time,
                            user: this.appState.currentUser.value.id,
                            previousExternalIds: oldExternalIds.map(id => pick(id, ['externalId', 'type']))
                        }
                    });
                }
            },
            {
                label: gettext('Delete old owner of original device'),
                action: (context) => {
                    const { deleteReplacedDeviceOwner, deviceToReplace } = context;
                    return deleteReplacedDeviceOwner
                        ? this.user.delete(deviceToReplace.owner)
                        : of(REPLACE_DEVICE_STEP_STATE.SKIPPED);
                },
                info: {
                    getMessage: (_, step) => step.state === 'Skipped'
                        ? gettext('User was not deleted because it is assigned as an owner of other devices.')
                        : undefined
                }
            },
            {
                label: gettext('Delete replacement device'),
                action: (context) => {
                    const { replacementDevice } = context;
                    return this.inventory.delete(replacementDevice.id);
                }
            },
            {
                label: gettext('Create event'),
                action: (context) => {
                    const { deviceToReplace, oldExternalIds, newExternalIds, time } = context;
                    return this.event.create({
                        source: { id: deviceToReplace.id },
                        text: `Device with external ID(s) ${this.extIdsToString(oldExternalIds)} was replaced by device with external ID(s) ${this.extIdsToString(newExternalIds)}`,
                        time,
                        type: 'c8y_DeviceReplaced'
                    });
                }
            },
            {
                label: gettext('Create audit log'),
                action: (context) => {
                    const { deviceToReplace, oldExternalIds, newExternalIds, time } = context;
                    return this.audit.create({
                        activity: gettext('Device replaced'),
                        source: { id: deviceToReplace.id },
                        text: `Device with external ID(s) ${this.extIdsToString(oldExternalIds)} was replaced by device with external ID(s) ${this.extIdsToString(newExternalIds)}`,
                        time,
                        type: AuditRecordType.INVENTORY,
                        user: this.appState.currentUser.value.id
                    });
                }
            }
        ];
    }
    executeStep(step) {
        return pipe(tap((ctx) => (step.state = step?.skip || ctx.skip ? step.state : REPLACE_DEVICE_STEP_STATE.EXECUTING)), concatMap((ctx) => {
            if (!step.context && !ctx.skip) {
                step.context = cloneDeep(ctx);
            }
            const context = cloneDeep(step.seed ?? ctx);
            return step?.skip || ctx.skip
                ? of(context)
                : toObservable(this.unwrapStepAction(context, step.action)).pipe(tap(result => (step.state = isValidReplaceDeviceStepState(result)
                    ? result
                    : REPLACE_DEVICE_STEP_STATE.SUCCESSFUL)), catchError(err => {
                    step.state = REPLACE_DEVICE_STEP_STATE.FAILED;
                    step.error = this.toError(err);
                    context.skip = step.overrideContext;
                    return of(context);
                }), tap(() => {
                    if (typeof step.info?.getMessage === 'function') {
                        step.info.msg = step.info.getMessage(context, step);
                    }
                }), map(result => (step.overrideContext ? result : context)));
        }));
    }
    unwrapStepAction(context, action) {
        try {
            return action(context);
        }
        catch (err) {
            // bubble up any runtime errors
            return of({}).pipe(tap(() => {
                throw err;
            }));
        }
    }
    appendBreadcrumbs() {
        this.breadcrumbService.state.forEach(bc => (bc.items = [...bc.items, { label: gettext('Replace device'), path: undefined }]));
        this.breadcrumbService.refresh();
    }
    removeBreadcrumbs() {
        this.breadcrumbService.state.forEach(bc => bc.items?.pop());
        this.breadcrumbService.refresh();
    }
    areExtIdsEqual(idA, idB) {
        return idA?.type === idB?.type && idA?.externalId === idB?.externalId;
    }
    extIdsToString(extnernalIds) {
        return extnernalIds?.map(id => `${id.externalId} [${id.type}]`).join(', ');
    }
    toError(err) {
        const { data, res, message } = err;
        let text = data?.message || message;
        let detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        const hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (res && !hasRelevantMessage) {
            detailedData = pick(res, ['status', 'statusText']);
        }
        return { text, detailedData };
    }
}
ReplaceDeviceService.NON_REENTRANT_STATES = [
    'Executing',
    'Successful'
];
ReplaceDeviceService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReplaceDeviceService, deps: [{ token: i1.InventoryService }, { token: i1.IdentityService }, { token: i1.AuditService }, { token: i1.EventService }, { token: i1.UserService }, { token: i2.AppStateService }, { token: i2.BreadcrumbService }, { token: i2.AlertService }], target: i0.ɵɵFactoryTarget.Injectable });
ReplaceDeviceService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReplaceDeviceService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReplaceDeviceService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.InventoryService }, { type: i1.IdentityService }, { type: i1.AuditService }, { type: i1.EventService }, { type: i1.UserService }, { type: i2.AppStateService }, { type: i2.BreadcrumbService }, { type: i2.AlertService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwbGFjZS1kZXZpY2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3JlcGxhY2UtZGV2aWNlL3JlcGxhY2UtZGV2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsZUFBZSxFQUNmLFlBQVksRUFDWixZQUFZLEVBQ1osZUFBZSxFQUdmLGdCQUFnQixFQUVoQixXQUFXLEVBQ1gsV0FBVyxFQUNaLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFDTCxZQUFZLEVBQ1osZUFBZSxFQUNmLGlCQUFpQixFQUNqQixPQUFPLEVBQ1AsWUFBWSxFQUNiLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDNUMsT0FBTyxFQUNMLGVBQWUsRUFDZixhQUFhLEVBQ2IsUUFBUSxFQUNSLElBQUksRUFFSixFQUFFLEVBQ0YsSUFBSSxFQUNKLE9BQU8sRUFDUixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFDTCxVQUFVLEVBQ1YsU0FBUyxFQUNULG9CQUFvQixFQUNwQixHQUFHLEVBQ0gsSUFBSSxFQUNKLEtBQUssRUFDTCxXQUFXLEVBQ1gsU0FBUyxFQUNULEdBQUcsRUFDSCxjQUFjLEVBQ2YsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBRUwsNkJBQTZCLEVBSTdCLHlCQUF5QixFQUMxQixNQUFNLHdCQUF3QixDQUFDOzs7O0FBRWhDLE1BQU0sT0FBTyxvQkFBb0I7SUFNL0IsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDL0IsQ0FBQztJQUNELElBQUksZ0JBQWdCO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDO0lBQ2xDLENBQUM7SUFDRCxJQUFJLG9CQUFvQjtRQUN0QixPQUFP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SUFDdkUsV0FBVztJQUNYLFlBQVk7Q0FDYixDQUFDO2lIQUpTLG9CQUFvQjtxSEFBcEIsb0JBQW9COzJGQUFwQixvQkFBb0I7a0JBRGhDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBBdWRpdFJlY29yZFR5cGUsXG4gIEF1ZGl0U2VydmljZSxcbiAgRXZlbnRTZXJ2aWNlLFxuICBJZGVudGl0eVNlcnZpY2UsXG4gIElFeHRlcm5hbElkZW50aXR5LFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSVJlc3VsdExpc3QsXG4gIFF1ZXJpZXNVdGlsLFxuICBVc2VyU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBBbGVydFNlcnZpY2UsXG4gIEFwcFN0YXRlU2VydmljZSxcbiAgQnJlYWRjcnVtYlNlcnZpY2UsXG4gIGdldHRleHQsXG4gIHRvT2JzZXJ2YWJsZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGNsb25lRGVlcCwgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQge1xuICBCZWhhdmlvclN1YmplY3QsXG4gIGNvbWJpbmVMYXRlc3QsXG4gIGZvcmtKb2luLFxuICBmcm9tLFxuICBPYnNlcnZhYmxlLFxuICBvZixcbiAgcGlwZSxcbiAgU3ViamVjdFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGNhdGNoRXJyb3IsXG4gIGNvbmNhdE1hcCxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIG1hcCxcbiAgc2NhbixcbiAgc2hhcmUsXG4gIHNoYXJlUmVwbGF5LFxuICBzd2l0Y2hNYXAsXG4gIHRhcCxcbiAgd2l0aExhdGVzdEZyb21cbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgRXJyb3IsXG4gIGlzVmFsaWRSZXBsYWNlRGV2aWNlU3RlcFN0YXRlLFxuICBSZXBsYWNlRGV2aWNlQ29udGV4dCxcbiAgUmVwbGFjZURldmljZVN0ZXAsXG4gIFJlcGxhY2VEZXZpY2VTdGVwU3RhdGUsXG4gIFJFUExBQ0VfREVWSUNFX1NURVBfU1RBVEVcbn0gZnJvbSAnLi9yZXBsYWNlLWRldmljZS5tb2RlbCc7XG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUmVwbGFjZURldmljZVNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBOT05fUkVFTlRSQU5UX1NUQVRFUzogUmVwbGFjZURldmljZVN0ZXBTdGF0ZVtdID0gW1xuICAgICdFeGVjdXRpbmcnLFxuICAgICdTdWNjZXNzZnVsJ1xuICBdO1xuXG4gIGdldCBkcmF3ZXJPcGVuJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5kcmF3ZXJPcGVuZWRPYnMkO1xuICB9XG4gIGdldCBkZXZpY2VUb1JlcGxhY2UkKCk6IE9ic2VydmFibGU8SU1hbmFnZWRPYmplY3Q+IHtcbiAgICByZXR1cm4gdGhpcy5kZXZpY2VUb1JlcGxhY2VPYnMkO1xuICB9XG4gIGdldCByZXBsYWNlbWVudERldmljZUlkJCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLnJlcGxhY2VtZW50RGV2aWNlSWRPYnMkO1xuICB9XG5cbiAgZXh0ZXJuYWxJZHMkOiBPYnNlcnZhYmxlPElSZXN1bHRMaXN0PElFeHRlcm5hbElkZW50aXR5Pj47XG4gIGV4dGVybmFsSWRzTG9hZGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIGV4dGVybmFsSWRzV2l0aFNlbGVjdGlvbiQ6IE9ic2VydmFibGU8QXJyYXk8eyBpZDogSUV4dGVybmFsSWRlbnRpdHk7IHNlbGVjdGVkOiBib29sZWFuIH0+PjtcbiAgc2VsZWN0ZWRFeHRlcm5hbElkcyQ6IE9ic2VydmFibGU8SUV4dGVybmFsSWRlbnRpdHlbXT47XG4gIGRldmljZVJlcGxhY2VkJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgZGV2aWNlUmVwbGFjZW1lbnRJblByb2dyZXNzJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcblxuICBzdGVwczogUmVwbGFjZURldmljZVN0ZXBbXSA9IFtdO1xuXG4gIHByaXZhdGUgZHJhd2VyT3BlblN1YmplY3QkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gIHByaXZhdGUgZHJhd2VyT3BlbmVkT2JzJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuZHJhd2VyT3BlblN1YmplY3QkXG4gICAgLmFzT2JzZXJ2YWJsZSgpXG4gICAgLnBpcGUoc2hhcmVSZXBsYXkoKSk7XG4gIHByaXZhdGUgZGV2aWNlVG9SZXBsYWNlU3ViamVjdCQ6IEJlaGF2aW9yU3ViamVjdDxJTWFuYWdlZE9iamVjdD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBwcml2YXRlIGRldmljZVRvUmVwbGFjZU9icyQ6IE9ic2VydmFibGU8SU1hbmFnZWRPYmplY3Q+ID0gdGhpcy5kZXZpY2VUb1JlcGxhY2VTdWJqZWN0JFxuICAgIC5hc09ic2VydmFibGUoKVxuICAgIC5waXBlKHNoYXJlUmVwbGF5KCkpO1xuICBwcml2YXRlIHJlcGxhY2VtZW50RGV2aWNlSWRTdWJqZWN0JDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSByZXBsYWNlbWVudERldmljZUlkT2JzJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5yZXBsYWNlbWVudERldmljZUlkU3ViamVjdCRcbiAgICAuYXNPYnNlcnZhYmxlKClcbiAgICAucGlwZShzaGFyZVJlcGxheSgpKTtcbiAgcHJpdmF0ZSBjaGVja0V4dGVybmFsSWQkOiBTdWJqZWN0PHsgaWQ6IElFeHRlcm5hbElkZW50aXR5OyBjaGVja2VkOiBib29sZWFuIH0+ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBleHRlcm5hbElkc0xvYWRpbmdTdWJqZWN0JDogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gIHByaXZhdGUgdHJpZ2dlckRldmljZVJlcGxhY2VtZW50U3ViamVjdCQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIGRldmljZVJlcGxhY2VtZW50SW5Qcm9ncmVzc1N1YmplY3QkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3QoKTtcblxuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuXG4gIHByaXZhdGUgY2xvc2VDYWxsYmFjazogKCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGlkZW50aXR5OiBJZGVudGl0eVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhdWRpdDogQXVkaXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXZlbnQ6IEV2ZW50U2VydmljZSxcbiAgICBwcml2YXRlIHVzZXI6IFVzZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZSxcbiAgICBwcml2YXRlIGJyZWFkY3J1bWJTZXJ2aWNlOiBCcmVhZGNydW1iU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5leHRlcm5hbElkc0xvYWRpbmckID0gdGhpcy5leHRlcm5hbElkc0xvYWRpbmdTdWJqZWN0JC5hc09ic2VydmFibGUoKS5waXBlKHNoYXJlUmVwbGF5KCkpO1xuICAgIHRoaXMuZXh0ZXJuYWxJZHMkID0gdGhpcy5yZXBsYWNlbWVudERldmljZUlkU3ViamVjdCQucGlwZShcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5leHRlcm5hbElkc0xvYWRpbmdTdWJqZWN0JC5uZXh0KHRydWUpKSxcbiAgICAgIHN3aXRjaE1hcChkZXZpY2VJZCA9PiB0aGlzLmlkZW50aXR5Lmxpc3QoZGV2aWNlSWQpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmV4dGVybmFsSWRzTG9hZGluZ1N1YmplY3QkLm5leHQoZmFsc2UpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNoZWNrRXh0ZXJuYWxJZChudWxsLCBmYWxzZSkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXJyKTtcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgfSksXG4gICAgICBzaGFyZVJlcGxheSgpXG4gICAgKTtcblxuICAgIHRoaXMuZXh0ZXJuYWxJZHNXaXRoU2VsZWN0aW9uJCA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy5leHRlcm5hbElkcyQucGlwZShcbiAgICAgICAgbWFwKHJlc3VsdCA9PiByZXN1bHQ/LmRhdGEpLFxuICAgICAgICBtYXAoZXh0ZXJuYWxJZHMgPT4gZXh0ZXJuYWxJZHM/Lm1hcChpZCA9PiAoeyBpZCwgc2VsZWN0ZWQ6IHRydWUgfSkpKVxuICAgICAgKSxcbiAgICAgIHRoaXMuY2hlY2tFeHRlcm5hbElkJFxuICAgIF0pLnBpcGUoXG4gICAgICBzY2FuKChhY2MsIHZhbCkgPT4ge1xuICAgICAgICBjb25zdCBbc2VsZWN0ZWRJZHMsIGxhc3RBY3Rpb25dID0gYWNjO1xuICAgICAgICBjb25zdCBbXywgY2hlY2tBY3Rpb25dID0gdmFsO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgIShcbiAgICAgICAgICAgIGxhc3RBY3Rpb24/LmNoZWNrZWQgPT09IGNoZWNrQWN0aW9uPy5jaGVja2VkICYmXG4gICAgICAgICAgICB0aGlzLmFyZUV4dElkc0VxdWFsKGxhc3RBY3Rpb24/LmlkLCBjaGVja0FjdGlvbj8uaWQpXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICBzZWxlY3RlZElkcy5mb3JFYWNoKFxuICAgICAgICAgICAgaWQgPT5cbiAgICAgICAgICAgICAgKGlkLnNlbGVjdGVkID0gdGhpcy5hcmVFeHRJZHNFcXVhbChpZC5pZCwgY2hlY2tBY3Rpb24uaWQpXG4gICAgICAgICAgICAgICAgPyBjaGVja0FjdGlvbi5jaGVja2VkXG4gICAgICAgICAgICAgICAgOiBpZC5zZWxlY3RlZClcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgICB9KSxcbiAgICAgIG1hcCgoW2V4dGVybmFsSWRzXSkgPT4gZXh0ZXJuYWxJZHMpLFxuICAgICAgc2hhcmVSZXBsYXkoKVxuICAgICk7XG5cbiAgICB0aGlzLnNlbGVjdGVkRXh0ZXJuYWxJZHMkID0gdGhpcy5leHRlcm5hbElkc1dpdGhTZWxlY3Rpb24kLnBpcGUoXG4gICAgICBtYXAoaWRzID0+IGlkcy5maWx0ZXIoaWQgPT4gaWQuc2VsZWN0ZWQpLm1hcChpZCA9PiBpZC5pZCkpLFxuICAgICAgc2hhcmVSZXBsYXkoKVxuICAgICk7XG5cbiAgICB0aGlzLmRlZmluZVN0ZXBzKCk7XG5cbiAgICBjb25zdCB0b0NvbnRleHQgPSAoW18sIGRldmljZVRvUmVwbGFjZSwgcmVwbGFjZW1lbnREZXZpY2VJZCwgbmV3RXh0ZXJuYWxJZHNdKSA9PiAoe1xuICAgICAgZGV2aWNlVG9SZXBsYWNlLFxuICAgICAgcmVwbGFjZW1lbnREZXZpY2VJZCxcbiAgICAgIG5ld0V4dGVybmFsSWRzXG4gICAgfSk7XG5cbiAgICB0aGlzLmRldmljZVJlcGxhY2VkJCA9IHRoaXMudHJpZ2dlckRldmljZVJlcGxhY2VtZW50U3ViamVjdCQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmRldmljZVJlcGxhY2VtZW50SW5Qcm9ncmVzc1N1YmplY3QkLm5leHQodHJ1ZSkpLFxuICAgICAgd2l0aExhdGVzdEZyb20odGhpcy5kZXZpY2VUb1JlcGxhY2UkLCB0aGlzLnJlcGxhY2VtZW50RGV2aWNlSWQkLCB0aGlzLnNlbGVjdGVkRXh0ZXJuYWxJZHMkKSxcbiAgICAgIG1hcCh0b0NvbnRleHQpLFxuICAgICAgY29uY2F0TWFwKGNvbnRleHQgPT5cbiAgICAgICAgdGhpcy5zdGVwc1xuICAgICAgICAgIC5tYXAoc3RlcCA9PiB0aGlzLmV4ZWN1dGVTdGVwKHN0ZXApKVxuICAgICAgICAgIC5yZWR1Y2UoKGN0eCwgc3RlcCkgPT4gY3R4LnBpcGUoc3RlcCksIG9mKGNvbnRleHQpKVxuICAgICAgKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmRldmljZVJlcGxhY2VtZW50SW5Qcm9ncmVzc1N1YmplY3QkLm5leHQoZmFsc2UpKSxcbiAgICAgIG1hcCgoKSA9PiAhdGhpcy5zdGVwcy5zb21lKHN0ZXAgPT4gc3RlcC5zdGF0ZSA9PT0gJ0ZhaWxlZCcpKSxcbiAgICAgIHNoYXJlKClcbiAgICApO1xuXG4gICAgdGhpcy5kZXZpY2VSZXBsYWNlbWVudEluUHJvZ3Jlc3MkID0gdGhpcy5kZXZpY2VSZXBsYWNlbWVudEluUHJvZ3Jlc3NTdWJqZWN0JFxuICAgICAgLmFzT2JzZXJ2YWJsZSgpXG4gICAgICAucGlwZShzaGFyZVJlcGxheSgpKTtcbiAgfVxuXG4gIG9wZW5EcmF3ZXIoZGV2aWNlVG9SZXBsYWNlOiBJTWFuYWdlZE9iamVjdCwgY2xvc2VDYWxsYmFjaz86ICgpID0+IHZvaWQpIHtcbiAgICB0aGlzLmRldmljZVRvUmVwbGFjZVN1YmplY3QkLm5leHQoZGV2aWNlVG9SZXBsYWNlKTtcbiAgICB0aGlzLmRyYXdlck9wZW5TdWJqZWN0JC5uZXh0KHRydWUpO1xuICAgIHRoaXMuYXBwZW5kQnJlYWRjcnVtYnMoKTtcbiAgICB0aGlzLmNsb3NlQ2FsbGJhY2sgPSBjbG9zZUNhbGxiYWNrO1xuICB9XG5cbiAgY2xvc2VEcmF3ZXIoKSB7XG4gICAgdGhpcy5kcmF3ZXJPcGVuU3ViamVjdCQubmV4dChmYWxzZSk7XG4gICAgdGhpcy5yZW1vdmVCcmVhZGNydW1icygpO1xuICAgIGlmICh0aGlzLmNsb3NlQ2FsbGJhY2sgJiYgdHlwZW9mIHRoaXMuY2xvc2VDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5jbG9zZUNhbGxiYWNrKCk7XG4gICAgfVxuICB9XG5cbiAgY2hhbmdlUmVwbGFjZW1lbnREZXZpY2VJZChyZXBsYWNlbWVudERldmljZUlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnJlcGxhY2VtZW50RGV2aWNlSWRTdWJqZWN0JC5uZXh0KHJlcGxhY2VtZW50RGV2aWNlSWQpO1xuICB9XG5cbiAgY2hlY2tFeHRlcm5hbElkKGlkOiBJRXh0ZXJuYWxJZGVudGl0eSwgY2hlY2tlZDogYm9vbGVhbikge1xuICAgIHRoaXMuY2hlY2tFeHRlcm5hbElkJC5uZXh0KHsgaWQsIGNoZWNrZWQgfSk7XG4gIH1cblxuICByZXBsYWNlRGV2aWNlKCkge1xuICAgIHRoaXMudHJpZ2dlckRldmljZVJlcGxhY2VtZW50U3ViamVjdCQubmV4dCgpO1xuICB9XG5cbiAgcmV0cnlTdGVwKHN0ZXA/OiBSZXBsYWNlRGV2aWNlU3RlcCkge1xuICAgIHRoaXMuc3RlcHMuZm9yRWFjaChzID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgKHMubGFiZWwgPT09IHN0ZXA/LmxhYmVsIHx8ICFzdGVwKSAmJlxuICAgICAgICAhUmVwbGFjZURldmljZVNlcnZpY2UuTk9OX1JFRU5UUkFOVF9TVEFURVMuaW5jbHVkZXMocy5zdGF0ZSlcbiAgICAgICkge1xuICAgICAgICBzLnNraXAgPSBmYWxzZTtcbiAgICAgICAgcy5zZWVkID0gcy5jb250ZXh0O1xuICAgICAgICBzLnN0YXRlID0gJ1BlbmRpbmcnO1xuICAgICAgICBkZWxldGUgcy5lcnJvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHMuc2tpcCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5yZXBsYWNlRGV2aWNlKCk7XG4gIH1cblxuICByZXNldFN0ZXBzKCkge1xuICAgIHRoaXMuc3RlcHMuZm9yRWFjaChzID0+IHtcbiAgICAgIGRlbGV0ZSBzLnNraXA7XG4gICAgICBkZWxldGUgcy5lcnJvcjtcbiAgICAgIGRlbGV0ZSBzLnN0YXRlO1xuICAgICAgZGVsZXRlIHMuY29udGV4dDtcbiAgICAgIGRlbGV0ZSBzLnNlZWQ7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRlZmluZVN0ZXBzKCkge1xuICAgIHRoaXMuc3RlcHMgPSBbXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdHYXRoZXIgcmVxdWlyZWQgZGF0YScpLFxuICAgICAgICBvdmVycmlkZUNvbnRleHQ6IHRydWUsXG4gICAgICAgIGFjdGlvbjogKGNvbnRleHQ6IFJlcGxhY2VEZXZpY2VDb250ZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkZXZpY2VUb1JlcGxhY2UsIHJlcGxhY2VtZW50RGV2aWNlSWQsIG5ld0V4dGVybmFsSWRzIH0gPSBjb250ZXh0O1xuICAgICAgICAgIGlmIChkZXZpY2VUb1JlcGxhY2UuaWQgPT09IHJlcGxhY2VtZW50RGV2aWNlSWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgZ2V0dGV4dChcbiAgICAgICAgICAgICAgICAnVGhlIGRldmljZSB0byByZXBsYWNlIGFuZCB0aGUgcmVwbGFjZW1lbnQgZGV2aWNlIGNhbm5vdCBiZSBvbmUgYW5kIHRoZSBzYW1lIGRldmljZS4nXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAgICAgICBmcm9tKFxuICAgICAgICAgICAgICB0aGlzLmludmVudG9yeS5saXN0KHtcbiAgICAgICAgICAgICAgICBxdWVyeTogdGhpcy5xdWVyaWVzVXRpbC5idWlsZFF1ZXJ5KHsgb3duZXI6IGRldmljZVRvUmVwbGFjZS5vd25lciB9KVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKS5waXBlKG1hcChyZXN1bHQgPT4gcmVzdWx0Py5kYXRhPy5sZW5ndGggPT09IDEpKSxcbiAgICAgICAgICAgIGZyb20odGhpcy5pbnZlbnRvcnkuZGV0YWlsKHJlcGxhY2VtZW50RGV2aWNlSWQpKS5waXBlKG1hcChyZXN1bHQgPT4gcmVzdWx0Py5kYXRhKSksXG4gICAgICAgICAgICBmcm9tKHRoaXMuaWRlbnRpdHkubGlzdChkZXZpY2VUb1JlcGxhY2UuaWQpKS5waXBlKG1hcChyZXN1bHQgPT4gcmVzdWx0Py5kYXRhKSlcbiAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgbWFwKChbZGVsZXRlUmVwbGFjZWREZXZpY2VPd25lciwgcmVwbGFjZW1lbnREZXZpY2UsIG9sZEV4dGVybmFsSWRzXSkgPT4gKHtcbiAgICAgICAgICAgICAgZGV2aWNlVG9SZXBsYWNlLFxuICAgICAgICAgICAgICByZXBsYWNlbWVudERldmljZSxcbiAgICAgICAgICAgICAgbmV3RXh0ZXJuYWxJZHMsXG4gICAgICAgICAgICAgIG9sZEV4dGVybmFsSWRzLFxuICAgICAgICAgICAgICBkZWxldGVSZXBsYWNlZERldmljZU93bmVyLFxuICAgICAgICAgICAgICB0aW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdEZWxldGUgZXh0ZXJuYWwgSURzIG9mIHJlcGxhY2VtZW50IGRldmljZScpLFxuICAgICAgICBhY3Rpb246IChjb250ZXh0OiBSZXBsYWNlRGV2aWNlQ29udGV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgbmV3RXh0ZXJuYWxJZHMgfSA9IGNvbnRleHQ7XG4gICAgICAgICAgcmV0dXJuIGZvcmtKb2luKG5ld0V4dGVybmFsSWRzLm1hcChpZCA9PiB0aGlzLmlkZW50aXR5LmRlbGV0ZShpZCkpKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0NyZWF0ZSBuZXcgZXh0ZXJuYWwgSURzIGZvciB0aGUgb3JpZ2luYWwgZGV2aWNlJyksXG4gICAgICAgIGFjdGlvbjogKGNvbnRleHQ6IFJlcGxhY2VEZXZpY2VDb250ZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBuZXdFeHRlcm5hbElkcywgZGV2aWNlVG9SZXBsYWNlIH0gPSBjb250ZXh0O1xuICAgICAgICAgIHJldHVybiBmb3JrSm9pbihcbiAgICAgICAgICAgIG5ld0V4dGVybmFsSWRzXG4gICAgICAgICAgICAgIC5tYXAoZXh0SWQgPT4gKHtcbiAgICAgICAgICAgICAgICAuLi5waWNrKGV4dElkLCBbJ3R5cGUnLCAnZXh0ZXJuYWxJZCddKSxcbiAgICAgICAgICAgICAgICBtYW5hZ2VkT2JqZWN0OiB7IC4uLnBpY2soZGV2aWNlVG9SZXBsYWNlLCBbJ2lkJ10pIH1cbiAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgIC5tYXAoaWQgPT4gdGhpcy5pZGVudGl0eS5jcmVhdGUoaWQpKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdEZWxldGUgb2xkIGV4dGVybmFsIElEcyBvZiBvcmlnaW5hbCBkZXZpY2UnKSxcbiAgICAgICAgYWN0aW9uOiAoY29udGV4dDogUmVwbGFjZURldmljZUNvbnRleHQpID0+IHtcbiAgICAgICAgICBjb25zdCB7IG9sZEV4dGVybmFsSWRzIH0gPSBjb250ZXh0O1xuICAgICAgICAgIHJldHVybiBvbGRFeHRlcm5hbElkcz8ubGVuZ3RoXG4gICAgICAgICAgICA/IGZvcmtKb2luKG9sZEV4dGVybmFsSWRzLm1hcChpZCA9PiB0aGlzLmlkZW50aXR5LmRlbGV0ZShpZCkpKVxuICAgICAgICAgICAgOiBvZihSRVBMQUNFX0RFVklDRV9TVEVQX1NUQVRFLlNLSVBQRUQpO1xuICAgICAgICB9LFxuICAgICAgICBpbmZvOiB7XG4gICAgICAgICAgZ2V0TWVzc2FnZTogKF8sIHN0ZXApID0+XG4gICAgICAgICAgICBzdGVwLnN0YXRlID09PSAnU2tpcHBlZCdcbiAgICAgICAgICAgICAgPyBnZXR0ZXh0KCdObyBleGlzdGluZyBleHRlcm5hbCBJRHMgd2VyZSBkZXRlcm1pbmVkLicpXG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdDaGFuZ2Ugb3duZXIgb2Ygb3JpZ2luYWwgZGV2aWNlJyksXG4gICAgICAgIGFjdGlvbjogKGNvbnRleHQ6IFJlcGxhY2VEZXZpY2VDb250ZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkZXZpY2VUb1JlcGxhY2UsIHJlcGxhY2VtZW50RGV2aWNlLCBvbGRFeHRlcm5hbElkcywgdGltZSB9ID0gY29udGV4dDtcbiAgICAgICAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkudXBkYXRlKHtcbiAgICAgICAgICAgIGlkOiBkZXZpY2VUb1JlcGxhY2UuaWQsXG4gICAgICAgICAgICBvd25lcjogcmVwbGFjZW1lbnREZXZpY2Uub3duZXIsXG4gICAgICAgICAgICBjOHlfTGFzdFJlcGxhY2VtZW50OiB7XG4gICAgICAgICAgICAgIHRpbWUsXG4gICAgICAgICAgICAgIHVzZXI6IHRoaXMuYXBwU3RhdGUuY3VycmVudFVzZXIudmFsdWUuaWQsXG4gICAgICAgICAgICAgIHByZXZpb3VzRXh0ZXJuYWxJZHM6IG9sZEV4dGVybmFsSWRzLm1hcChpZCA9PiBwaWNrKGlkLCBbJ2V4dGVybmFsSWQnLCAndHlwZSddKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0RlbGV0ZSBvbGQgb3duZXIgb2Ygb3JpZ2luYWwgZGV2aWNlJyksXG4gICAgICAgIGFjdGlvbjogKGNvbnRleHQ6IFJlcGxhY2VEZXZpY2VDb250ZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkZWxldGVSZXBsYWNlZERldmljZU93bmVyLCBkZXZpY2VUb1JlcGxhY2UgfSA9IGNvbnRleHQ7XG4gICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGxhY2VkRGV2aWNlT3duZXJcbiAgICAgICAgICAgID8gdGhpcy51c2VyLmRlbGV0ZShkZXZpY2VUb1JlcGxhY2Uub3duZXIpXG4gICAgICAgICAgICA6IG9mKFJFUExBQ0VfREVWSUNFX1NURVBfU1RBVEUuU0tJUFBFRCk7XG4gICAgICAgIH0sXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICBnZXRNZXNzYWdlOiAoXywgc3RlcCkgPT5cbiAgICAgICAgICAgIHN0ZXAuc3RhdGUgPT09ICdTa2lwcGVkJ1xuICAgICAgICAgICAgICA/IGdldHRleHQoJ1VzZXIgd2FzIG5vdCBkZWxldGVkIGJlY2F1c2UgaXQgaXMgYXNzaWduZWQgYXMgYW4gb3duZXIgb2Ygb3RoZXIgZGV2aWNlcy4nKVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBsYWJlbDogZ2V0dGV4dCgnRGVsZXRlIHJlcGxhY2VtZW50IGRldmljZScpLFxuICAgICAgICBhY3Rpb246IChjb250ZXh0OiBSZXBsYWNlRGV2aWNlQ29udGV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgcmVwbGFjZW1lbnREZXZpY2UgfSA9IGNvbnRleHQ7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LmRlbGV0ZShyZXBsYWNlbWVudERldmljZS5pZCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdDcmVhdGUgZXZlbnQnKSxcbiAgICAgICAgYWN0aW9uOiAoY29udGV4dDogUmVwbGFjZURldmljZUNvbnRleHQpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGRldmljZVRvUmVwbGFjZSwgb2xkRXh0ZXJuYWxJZHMsIG5ld0V4dGVybmFsSWRzLCB0aW1lIH0gPSBjb250ZXh0O1xuICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50LmNyZWF0ZSh7XG4gICAgICAgICAgICBzb3VyY2U6IHsgaWQ6IGRldmljZVRvUmVwbGFjZS5pZCB9LFxuICAgICAgICAgICAgdGV4dDogYERldmljZSB3aXRoIGV4dGVybmFsIElEKHMpICR7dGhpcy5leHRJZHNUb1N0cmluZyhcbiAgICAgICAgICAgICAgb2xkRXh0ZXJuYWxJZHNcbiAgICAgICAgICAgICl9IHdhcyByZXBsYWNlZCBieSBkZXZpY2Ugd2l0aCBleHRlcm5hbCBJRChzKSAke3RoaXMuZXh0SWRzVG9TdHJpbmcobmV3RXh0ZXJuYWxJZHMpfWAsXG4gICAgICAgICAgICB0aW1lLFxuICAgICAgICAgICAgdHlwZTogJ2M4eV9EZXZpY2VSZXBsYWNlZCdcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0NyZWF0ZSBhdWRpdCBsb2cnKSxcbiAgICAgICAgYWN0aW9uOiAoY29udGV4dDogUmVwbGFjZURldmljZUNvbnRleHQpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGRldmljZVRvUmVwbGFjZSwgb2xkRXh0ZXJuYWxJZHMsIG5ld0V4dGVybmFsSWRzLCB0aW1lIH0gPSBjb250ZXh0O1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1ZGl0LmNyZWF0ZSh7XG4gICAgICAgICAgICBhY3Rpdml0eTogZ2V0dGV4dCgnRGV2aWNlIHJlcGxhY2VkJyksXG4gICAgICAgICAgICBzb3VyY2U6IHsgaWQ6IGRldmljZVRvUmVwbGFjZS5pZCB9LFxuICAgICAgICAgICAgdGV4dDogYERldmljZSB3aXRoIGV4dGVybmFsIElEKHMpICR7dGhpcy5leHRJZHNUb1N0cmluZyhcbiAgICAgICAgICAgICAgb2xkRXh0ZXJuYWxJZHNcbiAgICAgICAgICAgICl9IHdhcyByZXBsYWNlZCBieSBkZXZpY2Ugd2l0aCBleHRlcm5hbCBJRChzKSAke3RoaXMuZXh0SWRzVG9TdHJpbmcobmV3RXh0ZXJuYWxJZHMpfWAsXG4gICAgICAgICAgICB0aW1lLFxuICAgICAgICAgICAgdHlwZTogQXVkaXRSZWNvcmRUeXBlLklOVkVOVE9SWSxcbiAgICAgICAgICAgIHVzZXI6IHRoaXMuYXBwU3RhdGUuY3VycmVudFVzZXIudmFsdWUuaWRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIF07XG4gIH1cblxuICBwcml2YXRlIGV4ZWN1dGVTdGVwKHN0ZXA6IFJlcGxhY2VEZXZpY2VTdGVwKSB7XG4gICAgcmV0dXJuIHBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIChjdHg6IFJlcGxhY2VEZXZpY2VDb250ZXh0KSA9PlxuICAgICAgICAgIChzdGVwLnN0YXRlID0gc3RlcD8uc2tpcCB8fCBjdHguc2tpcCA/IHN0ZXAuc3RhdGUgOiBSRVBMQUNFX0RFVklDRV9TVEVQX1NUQVRFLkVYRUNVVElORylcbiAgICAgICksXG4gICAgICBjb25jYXRNYXAoKGN0eDogUmVwbGFjZURldmljZUNvbnRleHQpID0+IHtcbiAgICAgICAgaWYgKCFzdGVwLmNvbnRleHQgJiYgIWN0eC5za2lwKSB7XG4gICAgICAgICAgc3RlcC5jb250ZXh0ID0gY2xvbmVEZWVwKGN0eCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29udGV4dCA9IGNsb25lRGVlcChzdGVwLnNlZWQgPz8gY3R4KTtcbiAgICAgICAgcmV0dXJuIHN0ZXA/LnNraXAgfHwgY3R4LnNraXBcbiAgICAgICAgICA/IG9mKGNvbnRleHQpXG4gICAgICAgICAgOiB0b09ic2VydmFibGUodGhpcy51bndyYXBTdGVwQWN0aW9uKGNvbnRleHQsIHN0ZXAuYWN0aW9uKSkucGlwZShcbiAgICAgICAgICAgICAgdGFwKFxuICAgICAgICAgICAgICAgIHJlc3VsdCA9PlxuICAgICAgICAgICAgICAgICAgKHN0ZXAuc3RhdGUgPSBpc1ZhbGlkUmVwbGFjZURldmljZVN0ZXBTdGF0ZShyZXN1bHQpXG4gICAgICAgICAgICAgICAgICAgID8gcmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIDogUkVQTEFDRV9ERVZJQ0VfU1RFUF9TVEFURS5TVUNDRVNTRlVMKVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgc3RlcC5zdGF0ZSA9IFJFUExBQ0VfREVWSUNFX1NURVBfU1RBVEUuRkFJTEVEO1xuICAgICAgICAgICAgICAgIHN0ZXAuZXJyb3IgPSB0aGlzLnRvRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICBjb250ZXh0LnNraXAgPSBzdGVwLm92ZXJyaWRlQ29udGV4dDtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoY29udGV4dCk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RlcC5pbmZvPy5nZXRNZXNzYWdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICBzdGVwLmluZm8ubXNnID0gc3RlcC5pbmZvLmdldE1lc3NhZ2UoY29udGV4dCwgc3RlcCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbWFwKHJlc3VsdCA9PiAoc3RlcC5vdmVycmlkZUNvbnRleHQgPyByZXN1bHQgOiBjb250ZXh0KSlcbiAgICAgICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHVud3JhcFN0ZXBBY3Rpb24oXG4gICAgY29udGV4dDogUmVwbGFjZURldmljZUNvbnRleHQsXG4gICAgYWN0aW9uOiAoY29udGV4dDogUmVwbGFjZURldmljZUNvbnRleHQpID0+IE9ic2VydmFibGU8dW5rbm93bj4gfCBQcm9taXNlPHVua25vd24+XG4gICkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYWN0aW9uKGNvbnRleHQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gYnViYmxlIHVwIGFueSBydW50aW1lIGVycm9yc1xuICAgICAgcmV0dXJuIG9mKHt9KS5waXBlKFxuICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhcHBlbmRCcmVhZGNydW1icygpOiB2b2lkIHtcbiAgICB0aGlzLmJyZWFkY3J1bWJTZXJ2aWNlLnN0YXRlLmZvckVhY2goXG4gICAgICBiYyA9PiAoYmMuaXRlbXMgPSBbLi4uYmMuaXRlbXMsIHsgbGFiZWw6IGdldHRleHQoJ1JlcGxhY2UgZGV2aWNlJyksIHBhdGg6IHVuZGVmaW5lZCB9XSlcbiAgICApO1xuICAgIHRoaXMuYnJlYWRjcnVtYlNlcnZpY2UucmVmcmVzaCgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVCcmVhZGNydW1icygpOiB2b2lkIHtcbiAgICB0aGlzLmJyZWFkY3J1bWJTZXJ2aWNlLnN0YXRlLmZvckVhY2goYmMgPT4gYmMuaXRlbXM/LnBvcCgpKTtcbiAgICB0aGlzLmJyZWFkY3J1bWJTZXJ2aWNlLnJlZnJlc2goKTtcbiAgfVxuXG4gIHByaXZhdGUgYXJlRXh0SWRzRXF1YWwoaWRBOiBJRXh0ZXJuYWxJZGVudGl0eSwgaWRCOiBJRXh0ZXJuYWxJZGVudGl0eSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpZEE/LnR5cGUgPT09IGlkQj8udHlwZSAmJiBpZEE/LmV4dGVybmFsSWQgPT09IGlkQj8uZXh0ZXJuYWxJZDtcbiAgfVxuXG4gIHByaXZhdGUgZXh0SWRzVG9TdHJpbmcoZXh0bmVybmFsSWRzOiBJRXh0ZXJuYWxJZGVudGl0eVtdKSB7XG4gICAgcmV0dXJuIGV4dG5lcm5hbElkcz8ubWFwKGlkID0+IGAke2lkLmV4dGVybmFsSWR9IFske2lkLnR5cGV9XWApLmpvaW4oJywgJyk7XG4gIH1cblxuICBwcml2YXRlIHRvRXJyb3IoZXJyKTogRXJyb3Ige1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzLCBtZXNzYWdlIH0gPSBlcnI7XG4gICAgbGV0IHRleHQgPSBkYXRhPy5tZXNzYWdlIHx8IG1lc3NhZ2U7XG4gICAgbGV0IGRldGFpbGVkRGF0YTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhLmV4Y2VwdGlvbk1lc3NhZ2U7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBoYXNSZWxldmFudE1lc3NhZ2UgPSAhISh0ZXh0IHx8IGRldGFpbGVkRGF0YSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gZ2V0dGV4dCgnQSBzZXJ2ZXIgZXJyb3Igb2NjdXJyZWQuJyk7XG4gICAgfVxuICAgIGlmIChyZXMgJiYgIWhhc1JlbGV2YW50TWVzc2FnZSkge1xuICAgICAgZGV0YWlsZWREYXRhID0gcGljayhyZXMsIFsnc3RhdHVzJywgJ3N0YXR1c1RleHQnXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgdGV4dCwgZGV0YWlsZWREYXRhIH07XG4gIH1cbn1cbiJdfQ==