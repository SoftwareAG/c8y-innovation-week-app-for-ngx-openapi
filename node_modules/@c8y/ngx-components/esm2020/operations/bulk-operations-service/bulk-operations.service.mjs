import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { InventoryService, OperationBulkService, OperationService } from '@c8y/client';
import { hookGeneric } from '@c8y/ngx-components';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/client";
import * as i2 from "@angular/common";
export const baseUrl = 'devicecontrol/bulk/creation/';
/**
 * @deprecated Consider using the `hookListBulkType` function instead.
 */
export const HOOK_LIST_BULK_TYPE = new InjectionToken('HOOK_LIST_BULK_TYPE');
/**
 * You can either provide a single `OperationType` as parameter:
 * ```typescript
 *  hookListBulkType(...)
 * ```
 *
 * Or an array to directly register multiple:
 * ```typescript
 *  hookListBulkType([...])
 * ```
 *
 * Or you provide an Service that implements `ExtensionFactory<OperationType>`
 * ```typescript
 *  export class MyListBulkTypeFactory implements ExtensionFactory<OperationType> {...}
 *  ...
 *  hookListBulkType(MyListBulkTypeFactory)
 * ```
 * A typed alternative to `HOOK_LIST_BULK_TYPE`.
 * @param type The `OperationType`'s or `ExtensionFactory` to be provided.
 * @returns An `Provider` to be provided in your module.
 */
export function hookListBulkType(type, options) {
    return hookGeneric(type, HOOK_LIST_BULK_TYPE, options);
}
export class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = {
            withTotalPages: true,
            withDeleted: true,
            pageSize: 50,
            ...customFilter
        };
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    async scheduleBulkOperation(deviceQueryString, details) {
        const dynamicGroup = await this.createGroup(deviceQueryString);
        const bulkOperation = {
            groupId: dynamicGroup.data.id,
            operationPrototype: details.prototype,
            creationRamp: details.schedule.delayInSeconds,
            startDate: details.schedule.scheduledDate.toISOString(),
            note: details.note
        };
        await this.createBulkOperation(bulkOperation);
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
}
BulkOperationsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: BulkOperationsService, deps: [{ token: i1.OperationBulkService }, { token: i1.OperationService }, { token: i1.InventoryService }, { token: i2.Location }, { token: HOOK_LIST_BULK_TYPE, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
BulkOperationsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: BulkOperationsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: BulkOperationsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.OperationBulkService }, { type: i1.OperationService }, { type: i1.InventoryService }, { type: i2.Location }, { type: Array, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [HOOK_LIST_BULK_TYPE]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFHTCxnQkFBZ0IsRUFJaEIsb0JBQW9CLEVBQ3BCLGdCQUFnQixFQUNqQixNQUFNLGFBQWEsQ0FBQztBQUtyQixPQUFPLEVBQW1CLFdBQVcsRUFBZSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBRWhGLE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRyw4QkFBOEIsQ0FBQztBQUV0RDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUNuRCxxQkFBcUIsQ0FDdEIsQ0FBQztBQUVGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUNILE1BQU0sVUFBVSxnQkFBZ0IsQ0FDOUIsSUFBb0MsRUFDcEMsT0FBOEI7SUFFOUIsT0FBTyxXQUFXLENBQWdCLElBQUksRUFBRSxtQkFBbUIsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUN4RSxDQUFDO0FBR0QsTUFBTSxPQUFPLHFCQUFxQjtJQU1oQyxZQUNVLG9CQUEwQyxFQUMxQyxnQkFBa0MsRUFDbEMsZ0JBQWtDLEVBQ2xDLFFBQWtCLEVBRWUsU0FBaUQ7UUFMbEYseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMx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QUFNOzJCQUFDLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmbGF0dGVuLCBoYXMsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtcbiAgSWRSZWZlcmVuY2UsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJT3BlcmF0aW9uQnVsayxcbiAgSVJlc3VsdCxcbiAgT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gIE9wZXJhdGlvblNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzIH0gZnJvbSAnLi9vcGVyYXRpb24tZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9vcGVyYXRpb24tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgR2VuZXJpY0hvb2tUeXBlLCBob29rR2VuZXJpYywgSG9va09wdGlvbnMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuZXhwb3J0IGNvbnN0IGJhc2VVcmwgPSAnZGV2aWNlY29udHJvbC9idWxrL2NyZWF0aW9uLyc7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgQ29uc2lkZXIgdXNpbmcgdGhlIGBob29rTGlzdEJ1bGtUeXBlYCBmdW5jdGlvbiBpbnN0ZWFkLlxuICovXG5leHBvcnQgY29uc3QgSE9PS19MSVNUX0JVTEtfVFlQRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPihcbiAgJ0hPT0tfTElTVF9CVUxLX1RZUEUnXG4pO1xuXG4vKipcbiAqIFlvdSBjYW4gZWl0aGVyIHByb3ZpZGUgYSBzaW5nbGUgYE9wZXJhdGlvblR5cGVgIGFzIHBhcmFtZXRlcjpcbiAqIGBgYHR5cGVzY3JpcHRcbiAqICBob29rTGlzdEJ1bGtUeXBlKC4uLilcbiAqIGBgYFxuICpcbiAqIE9yIGFuIGFycmF5IHRvIGRpcmVjdGx5IHJlZ2lzdGVyIG11bHRpcGxlOlxuICogYGBgdHlwZXNjcmlwdFxuICogIGhvb2tMaXN0QnVsa1R5cGUoWy4uLl0pXG4gKiBgYGBcbiAqXG4gKiBPciB5b3UgcHJvdmlkZSBhbiBTZXJ2aWNlIHRoYXQgaW1wbGVtZW50cyBgRXh0ZW5zaW9uRmFjdG9yeTxPcGVyYXRpb25UeXBlPmBcbiAqIGBgYHR5cGVzY3JpcHRcbiAqICBleHBvcnQgY2xhc3MgTXlMaXN0QnVsa1R5cGVGYWN0b3J5IGltcGxlbWVudHMgRXh0ZW5zaW9uRmFjdG9yeTxPcGVyYXRpb25UeXBlPiB7Li4ufVxuICogIC4uLlxuICogIGhvb2tMaXN0QnVsa1R5cGUoTXlMaXN0QnVsa1R5cGVGYWN0b3J5KVxuICogYGBgXG4gKiBBIHR5cGVkIGFsdGVybmF0aXZlIHRvIGBIT09LX0xJU1RfQlVMS19UWVBFYC5cbiAqIEBwYXJhbSB0eXBlIFRoZSBgT3BlcmF0aW9uVHlwZWAncyBvciBgRXh0ZW5zaW9uRmFjdG9yeWAgdG8gYmUgcHJvdmlkZWQuXG4gKiBAcmV0dXJucyBBbiBgUHJvdmlkZXJgIHRvIGJlIHByb3ZpZGVkIGluIHlvdXIgbW9kdWxlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaG9va0xpc3RCdWxrVHlwZShcbiAgdHlwZTogR2VuZXJpY0hvb2tUeXBlPE9wZXJhdGlvblR5cGU+LFxuICBvcHRpb25zPzogUGFydGlhbDxIb29rT3B0aW9ucz5cbikge1xuICByZXR1cm4gaG9va0dlbmVyaWM8T3BlcmF0aW9uVHlwZT4odHlwZSwgSE9PS19MSVNUX0JVTEtfVFlQRSwgb3B0aW9ucyk7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCdWxrT3BlcmF0aW9uc1NlcnZpY2Uge1xuICByZWFkb25seSBERF9MT1dfQ09VTlQ6IG51bWJlciA9IDEwO1xuICBmaXJtd2FyZUlkOiBTdWJqZWN0PElkUmVmZXJlbmNlPiA9IG5ldyBTdWJqZWN0PElkUmVmZXJlbmNlPigpO1xuXG4gIHByaXZhdGUgYnVsa1R5cGVzOiBPcGVyYXRpb25UeXBlW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25CdWxrU2VydmljZTogT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbixcblxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSE9PS19MSVNUX0JVTEtfVFlQRSkgYnVsa1R5cGVzOiBBcnJheTxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPlxuICApIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGZsYXR0ZW4oYnVsa1R5cGVzKTtcblxuICAgIHRoaXMuYnVsa1R5cGVzID0gdGhpcy5idWxrVHlwZXMubWFwKHR5cGUgPT4ge1xuICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUuc2VsZWN0ZWQpKSB7XG4gICAgICAgIHR5cGUuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0eXBlO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbnMoY3VzdG9tRmlsdGVyID0ge30pIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIHdpdGhEZWxldGVkOiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgLi4uY3VzdG9tRmlsdGVyXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25CeUlkKGJ1bGtPcGVyYXRpb25JZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGV0YWlsKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICBjcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuY3JlYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZGVsZXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZWxldGUoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIHVwZGF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS51cGRhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRPcGVyYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdDxJT3BlcmF0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuZGV0YWlsKGlkKTtcbiAgfVxuXG4gIHJldHVyblRvQnVsa09wZXJhdGlvbk92ZXJ2aWV3KCkge1xuICAgIHRoaXMubG9jYXRpb24uYmFjaygpO1xuICB9XG5cbiAgc2V0QnVsa1R5cGVzKGxpc3Q6IE9wZXJhdGlvblR5cGVbXSkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gbGlzdDtcbiAgfVxuXG4gIGdldEJ1bGtUeXBlcygpOiBPcGVyYXRpb25UeXBlW10ge1xuICAgIHJldHVybiB0aGlzLmJ1bGtUeXBlcztcbiAgfVxuXG4gIHNldEZpcm13YXJlSWQoaWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgdGhpcy5maXJtd2FyZUlkLm5leHQoaWQpO1xuICB9XG5cbiAgY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlEYXRhU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+ID0ge1xuICAgICAgbmFtZTogJ0J1bGsgb3BlcmF0aW9ucyBncm91cCcsXG4gICAgICB0eXBlOiAnYzh5X0R5bmFtaWNHcm91cCcsXG4gICAgICBjOHlfSXNEeW5hbWljR3JvdXA6IHsgaW52aXNpYmxlOiB7fSB9LFxuICAgICAgYzh5X0RldmljZVF1ZXJ5U3RyaW5nOiBkZXZpY2VRdWVyeURhdGFTdHJpbmdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZHluYW1pY0dyb3VwKTtcbiAgfVxuXG4gIGFzeW5jIHNjaGVkdWxlQnVsa09wZXJhdGlvbihkZXZpY2VRdWVyeVN0cmluZzogc3RyaW5nLCBkZXRhaWxzOiBPcGVyYXRpb25EZXRhaWxzKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwID0gYXdhaXQgdGhpcy5jcmVhdGVHcm91cChkZXZpY2VRdWVyeVN0cmluZyk7XG5cbiAgICBjb25zdCBidWxrT3BlcmF0aW9uOiBJT3BlcmF0aW9uQnVsayA9IHtcbiAgICAgIGdyb3VwSWQ6IGR5bmFtaWNHcm91cC5kYXRhLmlkLFxuICAgICAgb3BlcmF0aW9uUHJvdG90eXBlOiBkZXRhaWxzLnByb3RvdHlwZSxcbiAgICAgIGNyZWF0aW9uUmFtcDogZGV0YWlscy5zY2hlZHVsZS5kZWxheUluU2Vjb25kcyxcbiAgICAgIHN0YXJ0RGF0ZTogZGV0YWlscy5zY2hlZHVsZS5zY2hlZHVsZWREYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICBub3RlOiBkZXRhaWxzLm5vdGVcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0U2luZ2xlT3BlcmF0aW9uc0J5U3RhdHVzKHN0YXR1cywgYnVsa09wZXJhdGlvbklkKSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICBidWxrT3BlcmF0aW9uSWQsXG4gICAgICBzdGF0dXM6IChzdGF0dXMgJiYgc3RhdHVzLnRvVXBwZXJDYXNlKCkpIHx8ICcnXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgdXBkYXRlU2luZ2xlT3BlcmF0aW9uKHBhcnRpYWxVcGRhdGVPYmplY3Q6IFBhcnRpYWw8SU9wZXJhdGlvbj4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLnVwZGF0ZShwYXJ0aWFsVXBkYXRlT2JqZWN0KTtcbiAgfVxuXG4gIHJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogQnVsa09wZXJhdGlvblR5cGUge1xuICAgIGxldCB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcblxuICAgIHRoaXMuYnVsa1R5cGVzLnNvbWUodCA9PiB7XG4gICAgICBpZiAodC5mcmFnbWVudHMuc29tZShmcmFnbWVudCA9PiBoYXMob3BlcmF0aW9uLCBmcmFnbWVudCkpKSB7XG4gICAgICAgIHR5cGUgPSB0LnR5cGU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHR5cGU7XG4gIH1cbn1cbiJdfQ==