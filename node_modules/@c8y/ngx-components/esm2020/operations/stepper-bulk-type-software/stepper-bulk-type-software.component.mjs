import { Component, ViewChild } from '@angular/core';
import { gettext, ModalService, Status } from '@c8y/ngx-components';
import { BaseStepperComponent } from '@c8y/ngx-components/operations/bulk-operation-stepper';
import { BulkOperationType } from '@c8y/ngx-components/operations/bulk-operations-service';
import { TranslateService } from '@ngx-translate/core';
import { uniq } from 'lodash-es';
import { SelectSoftwareStepComponent } from './select-software-step.component';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "@ngx-translate/core";
import * as i3 from "@c8y/ngx-components/operations/bulk-operation-stepper";
import * as i4 from "./confirm-software-selection-step.component";
import * as i5 from "./select-software-step.component";
export class StepperBulkTypeSoftwareComponent extends BaseStepperComponent {
    constructor(modal, translate) {
        super();
        this.modal = modal;
        this.translate = translate;
        this.type = BulkOperationType.SOFTWARE;
        this.descriptionTemplateSingle = gettext('Update software to: {{ name }} (version {{ version }})');
        this.descriptionTemplateOneOther = gettext('Update software to: {{ name }} (version {{ version }}) and one other');
        this.descriptionTemplateMultiple = gettext('Update software to: {{ name }} (version {{ version }}) and {{ count }} others');
        this.selectedSoftware = [];
    }
    onSoftwareSelected(selectedItem) {
        this.selectedSoftware = this.selectedSoftware.filter(item => item.software.id !== selectedItem.software.id);
        this.selectedSoftware.push(selectedItem);
    }
    async confirmSoftwareSelection($event) {
        const deviceTypes = this.getUniqueDeviceTypes();
        this.deviceTypes = deviceTypes;
        if (deviceTypes.length > 1) {
            try {
                await this.modal.confirm(gettext('Selected software for various device types'), gettext('Operation may fail due to unsupported software. Do you want to proceed?'), Status.WARNING, { ok: gettext('Confirm'), cancel: gettext('Cancel') });
                $event.stepper.next();
            }
            catch (ex) {
                this.selectedSoftware = [];
                this.selectSoftware.resetSelection();
            }
        }
        else {
            $event.stepper.next();
        }
    }
    retrieveOperationPrototype() {
        const softwareList = this.selectedSoftware.map(item => ({
            name: item.software.name,
            version: item.version.c8y_Software.version,
            url: item.version.c8y_Software.url,
            action: item.action
        }));
        const interpolationParams = {
            name: softwareList[0].name,
            version: softwareList[0].version,
            count: softwareList.length - 1
        };
        let description;
        switch (softwareList.length) {
            case 1:
                description = this.translate.instant(this.descriptionTemplateSingle, interpolationParams);
                break;
            case 2:
                description = this.translate.instant(this.descriptionTemplateOneOther, interpolationParams);
                break;
            default:
                description = this.translate.instant(this.descriptionTemplateMultiple, interpolationParams);
        }
        return {
            name: gettext('Software update'),
            prototype: {
                description,
                c8y_SoftwareUpdate: softwareList
            }
        };
    }
    getUniqueDeviceTypes() {
        return uniq(this.selectedSoftware
            .map(item => item.software.c8y_Filter && item.software.c8y_Filter.type)
            .filter(type => !!type));
    }
}
StepperBulkTypeSoftwareComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: StepperBulkTypeSoftwareComponent, deps: [{ token: i1.ModalService }, { token: i2.TranslateService }], target: i0.ɵɵFactoryTarget.Component });
StepperBulkTypeSoftwareComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: StepperBulkTypeSoftwareComponent, selector: "c8y-stepper-bulk-type-software", viewQueries: [{ propertyName: "selectSoftware", first: true, predicate: SelectSoftwareStepComponent, descendants: true }], usesInheritance: true, ngImport: i0, template: "<c8y-bulk-operation-stepper [type]=\"type\">\n  <ng-container\n    *customStep=\"\n      'Select software' | translate;\n      completed: !!selectedSoftware.length;\n      buttonsDisabled: !selectedSoftware.length;\n      onNext: confirmSoftwareSelection.bind(this)\n    \"\n  >\n    <c8y-select-software-step\n      (software)=\"onSoftwareSelected($event)\"\n      class=\"d-contents\"\n    ></c8y-select-software-step>\n  </ng-container>\n  <ng-container *customStep=\"'Confirm selected software' | translate\">\n    <c8y-confirm-software-selection-step\n      class=\"d-contents\"\n      [selectedItems]=\"selectedSoftware\"\n    ></c8y-confirm-software-selection-step>\n  </ng-container>\n</c8y-bulk-operation-stepper>\n", dependencies: [{ kind: "component", type: i3.BulkOperationStepper, selector: "c8y-bulk-operation-stepper", inputs: ["type"], outputs: ["selectionChange"] }, { kind: "directive", type: i3.CustomStep, selector: "[customStep]", inputs: ["customStep", "customStepCompleted", "customStepButtonsDisabled", "customStepOnNext"] }, { kind: "component", type: i4.ConfirmSoftwareSelectionStepComponent, selector: "c8y-confirm-software-selection-step", inputs: ["selectedItems"] }, { kind: "component", type: i5.SelectSoftwareStepComponent, selector: "c8y-select-software-step", outputs: ["software"] }, { kind: "pipe", type: i1.C8yTranslatePipe, name: "translate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: StepperBulkTypeSoftwareComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-stepper-bulk-type-software', template: "<c8y-bulk-operation-stepper [type]=\"type\">\n  <ng-container\n    *customStep=\"\n      'Select software' | translate;\n      completed: !!selectedSoftware.length;\n      buttonsDisabled: !selectedSoftware.length;\n      onNext: confirmSoftwareSelection.bind(this)\n    \"\n  >\n    <c8y-select-software-step\n      (software)=\"onSoftwareSelected($event)\"\n      class=\"d-contents\"\n    ></c8y-select-software-step>\n  </ng-container>\n  <ng-container *customStep=\"'Confirm selected software' | translate\">\n    <c8y-confirm-software-selection-step\n      class=\"d-contents\"\n      [selectedItems]=\"selectedSoftware\"\n    ></c8y-confirm-software-selection-step>\n  </ng-container>\n</c8y-bulk-operation-stepper>\n" }]
        }], ctorParameters: function () { return [{ type: i1.ModalService }, { type: i2.TranslateService }]; }, propDecorators: { selectSoftware: [{
                type: ViewChild,
                args: [SelectSoftwareStepComponent, { static: false }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci1idWxrLXR5cGUtc29mdHdhcmUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vb3BlcmF0aW9ucy9zdGVwcGVyLWJ1bGstdHlwZS1zb2Z0d2FyZS9zdGVwcGVyLWJ1bGstdHlwZS1zb2Z0d2FyZS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlL3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJELE9BQU8sRUFBYyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVEQUF1RCxDQUFDO0FBQzdGLE9BQU8sRUFDTCxpQkFBaUIsRUFFbEIsTUFBTSx3REFBd0QsQ0FBQztBQUNoRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDOzs7Ozs7O0FBTy9FLE1BQU0sT0FBTyxnQ0FBaUMsU0FBUSxvQkFBb0I7SUFnQnhFLFlBQW9CLEtBQW1CLEVBQVUsU0FBMkI7UUFDMUUsS0FBSyxFQUFFLENBQUM7UUFEVSxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFmbkUsU0FBSSxHQUFzQixpQkFBaUIsQ0FBQyxRQUFRLENBQUM7UUFDckQsOEJBQXlCLEdBQVcsT0FBTyxDQUNsRCx3REFBd0QsQ0FDekQsQ0FBQztRQUNPLGdDQUEyQixHQUFXLE9BQU8sQ0FDcEQsc0VBQXNFLENB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LEVBQUU7Z0JBQ1QsV0FBVztnQkFDWCxrQkFBa0IsRUFBRSxZQUFZO2FBQ1I7U0FDM0IsQ0FBQztJQUNKLENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsT0FBTyxJQUFJLENBQ1QsSUFBSSxDQUFDLGdCQUFnQjthQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7YUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUMxQixDQUFDO0lBQ0osQ0FBQzs7NkhBeEZVLGdDQUFnQztpSEFBaEMsZ0NBQWdDLHNIQWFoQywyQkFBMkIsdUVDL0J4QyxzdEJBcUJBOzJGREhhLGdDQUFnQztrQkFKNUMsU0FBUzsrQkFDRSxnQ0FBZ0M7a0lBaUIxQyxjQUFjO3NCQURiLFNBQVM7dUJBQUMsMkJBQTJCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrU3RlcCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zdGVwcGVyJztcbmltcG9ydCB7IENvbXBvbmVudCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJT3BlcmF0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQzh5U3RlcHBlciwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEJhc2VTdGVwcGVyQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9uLXN0ZXBwZXInO1xuaW1wb3J0IHtcbiAgQnVsa09wZXJhdGlvblR5cGUsXG4gIE9wZXJhdGlvbkRldGFpbHNcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IHVuaXEgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU2VsZWN0U29mdHdhcmVTdGVwQ29tcG9uZW50IH0gZnJvbSAnLi9zZWxlY3Qtc29mdHdhcmUtc3RlcC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSVNlbGVjdGVkU29mdHdhcmUsIElTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvblByb3RvdHlwZSB9IGZyb20gJy4vc2VsZWN0LXNvZnR3YXJlLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXN0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlJyxcbiAgdGVtcGxhdGVVcmw6ICdzdGVwcGVyLWJ1bGstdHlwZS1zb2Z0d2FyZS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgU3RlcHBlckJ1bGtUeXBlU29mdHdhcmVDb21wb25lbnQgZXh0ZW5kcyBCYXNlU3RlcHBlckNvbXBvbmVudCB7XG4gIHJlYWRvbmx5IHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlID0gQnVsa09wZXJhdGlvblR5cGUuU09GVFdBUkU7XG4gIHJlYWRvbmx5IGRlc2NyaXB0aW9uVGVtcGxhdGVTaW5nbGU6IHN0cmluZyA9IGdldHRleHQoXG4gICAgJ1VwZGF0ZSBzb2Z0d2FyZSB0bzoge3sgbmFtZSB9fSAodmVyc2lvbiB7eyB2ZXJzaW9uIH19KSdcbiAgKTtcbiAgcmVhZG9ubHkgZGVzY3JpcHRpb25UZW1wbGF0ZU9uZU90aGVyOiBzdHJpbmcgPSBnZXR0ZXh0KFxuICAgICdVcGRhdGUgc29mdHdhcmUgdG86IHt7IG5hbWUgfX0gKHZlcnNpb24ge3sgdmVyc2lvbiB9fSkgYW5kIG9uZSBvdGhlcidcbiAgKTtcbiAgcmVhZG9ubHkgZGVzY3JpcHRpb25UZW1wbGF0ZU11bHRpcGxlOiBzdHJpbmcgPSBnZXR0ZXh0KFxuICAgICdVcGRhdGUgc29mdHdhcmUgdG86IHt7IG5hbWUgfX0gKHZlcnNpb24ge3sgdmVyc2lvbiB9fSkgYW5kIHt7IGNvdW50IH19IG90aGVycydcbiAgKTtcblxuICBzZWxlY3RlZFNvZnR3YXJlOiBJU2VsZWN0ZWRTb2Z0d2FyZVtdID0gW107XG4gIEBWaWV3Q2hpbGQoU2VsZWN0U29mdHdhcmVTdGVwQ29tcG9uZW50LCB7IHN0YXRpYzogZmFsc2UgfSlcbiAgc2VsZWN0U29mdHdhcmU6IFNlbGVjdFNvZnR3YXJlU3RlcENvbXBvbmVudDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vZGFsOiBNb2RhbFNlcnZpY2UsIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG9uU29mdHdhcmVTZWxlY3RlZChzZWxlY3RlZEl0ZW0pIHtcbiAgICB0aGlzLnNlbGVjdGVkU29mdHdhcmUgPSB0aGlzLnNlbGVjdGVkU29mdHdhcmUuZmlsdGVyKFxuICAgICAgaXRlbSA9PiBpdGVtLnNvZnR3YXJlLmlkICE9PSBzZWxlY3RlZEl0ZW0uc29mdHdhcmUuaWRcbiAgICApO1xuICAgIHRoaXMuc2VsZWN0ZWRTb2Z0d2FyZS5wdXNoKHNlbGVjdGVkSXRlbSk7XG4gIH1cblxuICBhc3luYyBjb25maXJtU29mdHdhcmVTZWxlY3Rpb24oJGV2ZW50OiB7IHN0ZXBwZXI6IEM4eVN0ZXBwZXI7IHN0ZXA6IENka1N0ZXAgfSkge1xuICAgIGNvbnN0IGRldmljZVR5cGVzOiBzdHJpbmdbXSA9IHRoaXMuZ2V0VW5pcXVlRGV2aWNlVHlwZXMoKTtcbiAgICB0aGlzLmRldmljZVR5cGVzID0gZGV2aWNlVHlwZXM7XG4gICAgaWYgKGRldmljZVR5cGVzLmxlbmd0aCA+IDEpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMubW9kYWwuY29uZmlybShcbiAgICAgICAgICBnZXR0ZXh0KCdTZWxlY3RlZCBzb2Z0d2FyZSBmb3IgdmFyaW91cyBkZXZpY2UgdHlwZXMnKSxcbiAgICAgICAgICBnZXR0ZXh0KCdPcGVyYXRpb24gbWF5IGZhaWwgZHVlIHRvIHVuc3VwcG9ydGVkIHNvZnR3YXJlLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkPycpLFxuICAgICAgICAgIFN0YXR1cy5XQVJOSU5HLFxuICAgICAgICAgIHsgb2s6IGdldHRleHQoJ0NvbmZpcm0nKSwgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKSB9XG4gICAgICAgICk7XG4gICAgICAgICRldmVudC5zdGVwcGVyLm5leHQoKTtcbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRTb2Z0d2FyZSA9IFtdO1xuICAgICAgICB0aGlzLnNlbGVjdFNvZnR3YXJlLnJlc2V0U2VsZWN0aW9uKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICRldmVudC5zdGVwcGVyLm5leHQoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcmV0cmlldmVPcGVyYXRpb25Qcm90b3R5cGUoKTogT3BlcmF0aW9uRGV0YWlscyB7XG4gICAgY29uc3Qgc29mdHdhcmVMaXN0OiBJU29mdHdhcmVVcGRhdGVPcGVyYXRpb25Qcm90b3R5cGVbXSA9IHRoaXMuc2VsZWN0ZWRTb2Z0d2FyZS5tYXAoaXRlbSA9PiAoe1xuICAgICAgbmFtZTogaXRlbS5zb2Z0d2FyZS5uYW1lLFxuICAgICAgdmVyc2lvbjogaXRlbS52ZXJzaW9uLmM4eV9Tb2Z0d2FyZS52ZXJzaW9uLFxuICAgICAgdXJsOiBpdGVtLnZlcnNpb24uYzh5X1NvZnR3YXJlLnVybCxcbiAgICAgIGFjdGlvbjogaXRlbS5hY3Rpb25cbiAgICB9KSk7XG5cbiAgICBjb25zdCBpbnRlcnBvbGF0aW9uUGFyYW1zOiBvYmplY3QgPSB7XG4gICAgICBuYW1lOiBzb2Z0d2FyZUxpc3RbMF0ubmFtZSxcbiAgICAgIHZlcnNpb246IHNvZnR3YXJlTGlzdFswXS52ZXJzaW9uLFxuICAgICAgY291bnQ6IHNvZnR3YXJlTGlzdC5sZW5ndGggLSAxXG4gICAgfTtcbiAgICBsZXQgZGVzY3JpcHRpb246IHN0cmluZztcbiAgICBzd2l0Y2ggKHNvZnR3YXJlTGlzdC5sZW5ndGgpIHtcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgZGVzY3JpcHRpb24gPSB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuZGVzY3JpcHRpb25UZW1wbGF0ZVNpbmdsZSwgaW50ZXJwb2xhdGlvblBhcmFtcyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICBkZXNjcmlwdGlvbiA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5kZXNjcmlwdGlvblRlbXBsYXRlT25lT3RoZXIsIGludGVycG9sYXRpb25QYXJhbXMpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGRlc2NyaXB0aW9uID0gdGhpcy50cmFuc2xhdGUuaW5zdGFudCh0aGlzLmRlc2NyaXB0aW9uVGVtcGxhdGVNdWx0aXBsZSwgaW50ZXJwb2xhdGlvblBhcmFtcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGdldHRleHQoJ1NvZnR3YXJlIHVwZGF0ZScpLFxuICAgICAgcHJvdG90eXBlOiB7XG4gICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICBjOHlfU29mdHdhcmVVcGRhdGU6IHNvZnR3YXJlTGlzdFxuICAgICAgfSBhcyB1bmtub3duIGFzIElPcGVyYXRpb25cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRVbmlxdWVEZXZpY2VUeXBlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHVuaXEoXG4gICAgICB0aGlzLnNlbGVjdGVkU29mdHdhcmVcbiAgICAgICAgLm1hcChpdGVtID0+IGl0ZW0uc29mdHdhcmUuYzh5X0ZpbHRlciAmJiBpdGVtLnNvZnR3YXJlLmM4eV9GaWx0ZXIudHlwZSlcbiAgICAgICAgLmZpbHRlcih0eXBlID0+ICEhdHlwZSlcbiAgICApO1xuICB9XG59XG4iLCI8Yzh5LWJ1bGstb3BlcmF0aW9uLXN0ZXBwZXIgW3R5cGVdPVwidHlwZVwiPlxuICA8bmctY29udGFpbmVyXG4gICAgKmN1c3RvbVN0ZXA9XCJcbiAgICAgICdTZWxlY3Qgc29mdHdhcmUnIHwgdHJhbnNsYXRlO1xuICAgICAgY29tcGxldGVkOiAhIXNlbGVjdGVkU29mdHdhcmUubGVuZ3RoO1xuICAgICAgYnV0dG9uc0Rpc2FibGVkOiAhc2VsZWN0ZWRTb2Z0d2FyZS5sZW5ndGg7XG4gICAgICBvbk5leHQ6IGNvbmZpcm1Tb2Z0d2FyZVNlbGVjdGlvbi5iaW5kKHRoaXMpXG4gICAgXCJcbiAgPlxuICAgIDxjOHktc2VsZWN0LXNvZnR3YXJlLXN0ZXBcbiAgICAgIChzb2Z0d2FyZSk9XCJvblNvZnR3YXJlU2VsZWN0ZWQoJGV2ZW50KVwiXG4gICAgICBjbGFzcz1cImQtY29udGVudHNcIlxuICAgID48L2M4eS1zZWxlY3Qtc29mdHdhcmUtc3RlcD5cbiAgPC9uZy1jb250YWluZXI+XG4gIDxuZy1jb250YWluZXIgKmN1c3RvbVN0ZXA9XCInQ29uZmlybSBzZWxlY3RlZCBzb2Z0d2FyZScgfCB0cmFuc2xhdGVcIj5cbiAgICA8Yzh5LWNvbmZpcm0tc29mdHdhcmUtc2VsZWN0aW9uLXN0ZXBcbiAgICAgIGNsYXNzPVwiZC1jb250ZW50c1wiXG4gICAgICBbc2VsZWN0ZWRJdGVtc109XCJzZWxlY3RlZFNvZnR3YXJlXCJcbiAgICA+PC9jOHktY29uZmlybS1zb2Z0d2FyZS1zZWxlY3Rpb24tc3RlcD5cbiAgPC9uZy1jb250YWluZXI+XG48L2M4eS1idWxrLW9wZXJhdGlvbi1zdGVwcGVyPlxuIl19