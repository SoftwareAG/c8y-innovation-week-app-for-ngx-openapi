import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService } from '@c8y/ngx-components/context-dashboard';
import { get } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@c8y/ngx-components/context-dashboard";
export class DashboardBridgeService {
    constructor(ng1Injector, zone, router, contextDashboardService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    get ng1Components() {
        return this.ng1Injector.get('c8yComponents');
    }
    async instantiateComponent(widget, element) {
        const { dashboard, context, child } = widget;
        if (dashboard) {
            const transformedChild = await this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child);
            if (this.dashboardSvc.forcedContext || dashboard.deviceType || dashboard.updateTarget) {
                await this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild.config);
            }
            return this.zone.runOutsideAngular(() => this.loadTemplate(transformedChild, child, element, context));
        }
        else {
            return this.loadConfigTemplate(element, widget);
        }
    }
    instantiateDeviceSelector(element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    }
    loadTemplate(transformedChild, child, element, context) {
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = `<c8y-ui-component component-name="'${child.widgetComponent}'" config="child.config" context="dashboardContext"></c8y-ui-component>`;
        }
        else if (child.templateUrl) {
            element.innerHTML = `<ng-include src="'${child.templateUrl}'"></ng-include>`;
        }
        this.compile(element)(scope);
        return scope;
    }
    getDashboard() {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    }
    loadConfigTemplate(element, widgetConfig, onlyDeviceSelector = false) {
        const { settings } = widgetConfig;
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = { ...settings, ...settings.ng1 };
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.rootId = settings.context.id;
        scope.dashboard = get(widgetConfig, 'settings.dashboardMo');
        let configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = `<c8y-ui-component component-name="'${widgetConfig.settings.configComponent}'" config="config"></c8y-ui-component>`;
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = `<ng-include src="'${widgetConfig.settings.configTemplateUrl}'"></ng-include>`;
            }
        }
        element.innerHTML = `
    <ng-form name="forms.componentForm">
      <div class="form-group m-0"
        ng-if="!settings.noDeviceTarget"
        ng-style="{height: settings.hideTarget && '0', overflow: 'hidden'}"
      >
      </div>
      ${configCmp}
    </ng-form>`;
        scope.$watch('forms.componentForm.$invalid', formStatus => {
            this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    }
}
DashboardBridgeService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DashboardBridgeService, deps: "invalid", target: i0.ɵɵFactoryTarget.Injectable });
DashboardBridgeService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DashboardBridgeService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: DashboardBridgeService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined }, { type: i0.NgZone }, { type: i1.Router }, { type: i2.ContextDashboardService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdXBncmFkZS9kYXNoYm9hcmQvZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsdUJBQXVCLEVBRXhCLE1BQU0sdUNBQXVDLENBQUM7QUFDL0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQzs7OztBQUdoQyxNQUFNLE9BQU8sc0JBQXNCO0lBS2pDLFlBQ1UsV0FBZ0IsRUFDaEIsSUFBWSxFQUNaLE1BQWMsRUFDZCx1QkFBZ0Q7UUFIaEQsZ0JBQVcsR0FBWCxXQUFXLENBQUs7UUFDaEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBRXhELElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQUksYUFBYTtRQUNmLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsT0FBTztRQUN4QyxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLENBQUM7UUFDN0MsSUFBSSxT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LENBQUMsa0JBQWtCLEVBQUU7WUFDdkIsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLGVBQWUsRUFBRTtnQkFDekMsU0FBUyxHQUFHLHNDQUFzQyxZQUFZLENBQUMsUUFBUSxDQUFDLGVBQWUsd0NBQXdDLENBQUM7YUFDakk7aUJBQU0sSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFO2dCQUNsRCxTQUFTLEdBQUcscUJBQXFCLFlBQVksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLGtCQUFrQixDQUFDO2FBQzVGO1NBQ0Y7UUFFRCxPQUFPLENBQUMsU0FBUyxHQUFHOzs7Ozs7O1FBT2hCLFNBQVM7ZUFDRixDQUFDO1FBRVosS0FBSyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsRUFBRSxVQUFVLENBQUMsRUFBRTtZQUN4RCxJQUFJLENBQUMsdUJBQXVCLENBQUMsWUFBWSxHQUFHLFVBQVUsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFFL0UsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzttSEF2R1Usc0JBQXNCO3VIQUF0QixzQkFBc0I7MkZBQXRCLHNCQUFzQjtrQkFEbEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGdldEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBDb250ZXh0RGFzaGJvYXJkU2VydmljZSxcbiAgQ29udGV4dFdpZGdldENvbmZpZ1xufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2NvbnRleHQtZGFzaGJvYXJkJztcbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRCcmlkZ2VTZXJ2aWNlIHtcbiAgZGFzaGJvYXJkU3ZjO1xuICBjb21waWxlO1xuICBkYXNoYm9hcmRDbGlwYm9hcmQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZzFJbmplY3RvcjogYW55LFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBjb250ZXh0RGFzaGJvYXJkU2VydmljZTogQ29udGV4dERhc2hib2FyZFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5kYXNoYm9hcmRTdmMgPSBuZzFJbmplY3Rvci5nZXQoJ2Rhc2hib2FyZFN2YycpO1xuICAgIHRoaXMuY29tcGlsZSA9IG5nMUluamVjdG9yLmdldCgnJGNvbXBpbGUnKTtcbiAgfVxuXG4gIGdldCBuZzFDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLm5nMUluamVjdG9yLmdldCgnYzh5Q29tcG9uZW50cycpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFudGlhdGVDb21wb25lbnQod2lkZ2V0LCBlbGVtZW50KSB7XG4gICAgY29uc3QgeyBkYXNoYm9hcmQsIGNvbnRleHQsIGNoaWxkIH0gPSB3aWRnZXQ7XG4gICAgaWYgKGRhc2hib2FyZCkge1xuICAgICAgY29uc3QgdHJhbnNmb3JtZWRDaGlsZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnRyYW5zZm9ybUNoaWxkV2l0aENvbnRleHQoXG4gICAgICAgIHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgY29udGV4dCxcbiAgICAgICAgZGFzaGJvYXJkLFxuICAgICAgICBjaGlsZFxuICAgICAgKTtcbiAgICAgIGlmICh0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGRhc2hib2FyZC5kZXZpY2VUeXBlIHx8IGRhc2hib2FyZC51cGRhdGVUYXJnZXQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMudXBkYXRlQ29uZmlnVGFyZ2V0c1dpdGhDb250ZXh0KFxuICAgICAgICAgIHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgY29udGV4dCxcbiAgICAgICAgICB0cmFuc2Zvcm1lZENoaWxkLmNvbmZpZ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PlxuICAgICAgICB0aGlzLmxvYWRUZW1wbGF0ZSh0cmFuc2Zvcm1lZENoaWxkLCBjaGlsZCwgZWxlbWVudCwgY29udGV4dClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmxvYWRDb25maWdUZW1wbGF0ZShlbGVtZW50LCB3aWRnZXQpO1xuICAgIH1cbiAgfVxuXG4gIGluc3RhbnRpYXRlRGV2aWNlU2VsZWN0b3IoZWxlbWVudCwgd2lkZ2V0Q29uZmlnOiBDb250ZXh0V2lkZ2V0Q29uZmlnKSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ1RlbXBsYXRlKGVsZW1lbnQsIHdpZGdldENvbmZpZywgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRUZW1wbGF0ZSh0cmFuc2Zvcm1lZENoaWxkLCBjaGlsZCwgZWxlbWVudCwgY29udGV4dCkge1xuICAgIGNvbnN0IHNjb3BlID0gdGhpcy5uZzFJbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKS4kbmV3KHRydWUpO1xuICAgIHNjb3BlLmNoaWxkID0gdHJhbnNmb3JtZWRDaGlsZDtcbiAgICBzY29wZS5kYXNoYm9hcmRDb250ZXh0ID0gY29udGV4dDtcbiAgICBpZiAoY2hpbGQud2lkZ2V0Q29tcG9uZW50KSB7XG4gICAgICBlbGVtZW50LmlubmVySFRNTCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke2NoaWxkLndpZGdldENvbXBvbmVudH0nXCIgY29uZmlnPVwiY2hpbGQuY29uZmlnXCIgY29udGV4dD1cImRhc2hib2FyZENvbnRleHRcIj48L2M4eS11aS1jb21wb25lbnQ+YDtcbiAgICB9IGVsc2UgaWYgKGNoaWxkLnRlbXBsYXRlVXJsKSB7XG4gICAgICBlbGVtZW50LmlubmVySFRNTCA9IGA8bmctaW5jbHVkZSBzcmM9XCInJHtjaGlsZC50ZW1wbGF0ZVVybH0nXCI+PC9uZy1pbmNsdWRlPmA7XG4gICAgfVxuICAgIHRoaXMuY29tcGlsZShlbGVtZW50KShzY29wZSk7XG4gICAgcmV0dXJuIHNjb3BlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmQoKSB7XG4gICAgcmV0dXJuIGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKS5zbmFwc2hvdC5kYXRhLmRhc2hib2FyZDtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZENvbmZpZ1RlbXBsYXRlKFxuICAgIGVsZW1lbnQsXG4gICAgd2lkZ2V0Q29uZmlnOiBDb250ZXh0V2lkZ2V0Q29uZmlnLFxuICAgIG9ubHlEZXZpY2VTZWxlY3RvciA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHsgc2V0dGluZ3MgfSA9IHdpZGdldENvbmZpZztcbiAgICBjb25zdCBzY29wZSA9IHRoaXMubmcxSW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJykuJG5ldyh0cnVlKTtcblxuICAgIHNjb3BlLnNldHRpbmdzID0geyAuLi5zZXR0aW5ncywgLi4uc2V0dGluZ3MubmcxIH07XG4gICAgc2NvcGUub3B0aW9ucyA9IHdpZGdldENvbmZpZy5vcHRpb25zO1xuICAgIHNjb3BlLmNvbmZpZyA9IHdpZGdldENvbmZpZztcbiAgICBzY29wZS5mb3JtcyA9IHt9O1xuICAgIHNjb3BlLnJvb3RJZCA9IHNldHRpbmdzLmNvbnRleHQuaWQ7XG4gICAgc2NvcGUuZGFzaGJvYXJkID0gZ2V0KHdpZGdldENvbmZpZywgJ3NldHRpbmdzLmRhc2hib2FyZE1vJyk7XG5cbiAgICBsZXQgY29uZmlnQ21wID0gJyc7XG4gICAgaWYgKCFvbmx5RGV2aWNlU2VsZWN0b3IpIHtcbiAgICAgIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke3dpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdDb21wb25lbnR9J1wiIGNvbmZpZz1cImNvbmZpZ1wiPjwvYzh5LXVpLWNvbXBvbmVudD5gO1xuICAgICAgfSBlbHNlIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmwpIHtcbiAgICAgICAgY29uZmlnQ21wID0gYDxuZy1pbmNsdWRlIHNyYz1cIicke3dpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdUZW1wbGF0ZVVybH0nXCI+PC9uZy1pbmNsdWRlPmA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZWxlbWVudC5pbm5lckhUTUwgPSBgXG4gICAgPG5nLWZvcm0gbmFtZT1cImZvcm1zLmNvbXBvbmVudEZvcm1cIj5cbiAgICAgIDxkaXYgY2xhc3M9XCJmb3JtLWdyb3VwIG0tMFwiXG4gICAgICAgIG5nLWlmPVwiIXNldHRpbmdzLm5vRGV2aWNlVGFyZ2V0XCJcbiAgICAgICAgbmctc3R5bGU9XCJ7aGVpZ2h0OiBzZXR0aW5ncy5oaWRlVGFyZ2V0ICYmICcwJywgb3ZlcmZsb3c6ICdoaWRkZW4nfVwiXG4gICAgICA+XG4gICAgICA8L2Rpdj5cbiAgICAgICR7Y29uZmlnQ21wfVxuICAgIDwvbmctZm9ybT5gO1xuXG4gICAgc2NvcGUuJHdhdGNoKCdmb3Jtcy5jb21wb25lbnRGb3JtLiRpbnZhbGlkJywgZm9ybVN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IGZvcm1TdGF0dXM7XG4gICAgfSk7XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IHNjb3BlLmZvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQ7XG5cbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cbn1cbiJdfQ==