import { Component, Input, ViewChild } from '@angular/core';
import { ApplicationService } from '@c8y/client';
import { AlertService, DropAreaComponent, WizardComponent } from '@c8y/ngx-components';
import { EcosystemService } from './ecosystem.service';
import { ERROR_MESSAGES } from './ecosystem.constants';
import { TranslateService } from '@ngx-translate/core';
import * as i0 from "@angular/core";
import * as i1 from "./ecosystem.service";
import * as i2 from "@c8y/ngx-components";
import * as i3 from "@c8y/client";
import * as i4 from "@ngx-translate/core";
import * as i5 from "@angular/common";
export class AddApplicationComponent {
    constructor(ecosystemService, alertService, applicationService, wizardComponent, translateService) {
        this.ecosystemService = ecosystemService;
        this.alertService = alertService;
        this.applicationService = applicationService;
        this.wizardComponent = wizardComponent;
        this.translateService = translateService;
        this.canGoBack = false;
        this.canOpenInBrowser = false;
        this.uploadCanceled = false;
    }
    get progress() {
        return this.ecosystemService.progress;
    }
    onFileDroppedEvent(event) {
        if (event && event.length > 0) {
            const file = event[0].file;
            this.onFile(file);
        }
    }
    async onFile(file) {
        this.isLoading = true;
        this.errorMessage = null;
        this.progress.next(0);
        try {
            this.createdApp = await this.createApplicationHandler(file);
            await this.uploadApplicationHandler(file, this.createdApp);
            this.canOpenInBrowser = this.ecosystemService.canOpenAppInBrowser(this.createdApp);
            this.isAppCreated = true;
        }
        catch (ex) {
            this.ecosystemService.cancelAppCreation(this.createdApp);
            this.createdApp = null;
            this.dropAreaComponent.onDelete();
            // prepare translation of static message if it exists
            const staticErrorMessage = ERROR_MESSAGES[ex.message] && this.translateService.instant(ERROR_MESSAGES[ex.message]);
            // if there is no static message, use dynamic one from the exception
            this.errorMessage = staticErrorMessage ?? ex.message;
            if (!this.errorMessage && !this.uploadCanceled) {
                this.alertService.addServerFailure(ex);
            }
        }
        this.progress.next(100);
        this.isLoading = false;
    }
    getHref(app) {
        return this.applicationService.getHref(app);
    }
    cancel() {
        this.cancelFileUpload();
        this.wizardComponent.close();
    }
    done() {
        this.wizardComponent.close();
    }
    back() {
        this.wizardComponent.reset();
    }
    cancelFileUpload() {
        this.uploadCanceled = true;
        this.ecosystemService.cancelAppCreation(this.createdApp);
        this.createdApp = null;
    }
}
AddApplicationComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AddApplicationComponent, deps: [{ token: i1.EcosystemService }, { token: i2.AlertService }, { token: i3.ApplicationService }, { token: i2.WizardComponent }, { token: i4.TranslateService }], target: i0.ɵɵFactoryTarget.Component });
AddApplicationComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.7", type: AddApplicationComponent, selector: "c8y-add-application", inputs: { headerText: "headerText", headerIcon: "headerIcon", successText: "successText", createApplicationHandler: "createApplicationHandler", uploadApplicationHandler: "uploadApplicationHandler", canGoBack: "canGoBack" }, viewQueries: [{ propertyName: "dropAreaComponent", first: true, predicate: DropAreaComponent, descendants: true }], ngImport: i0, template: "<c8y-wizard-header>\n  <i [c8yIcon]=\"headerIcon\"></i>\n  <h4 id=\"modal-title\">{{ headerText | translate }}</h4>\n</c8y-wizard-header>\n\n<c8y-wizard-body>\n  <p class=\"p-16 text-center text-medium separator-bottom sticky-top bg-component\">\n    {{ 'Upload a *.zip file' | translate }}\n  </p>\n  <c8y-form-group\n    *ngIf=\"!isAppCreated; else appCreated\"\n    [hasError]=\"!!errorMessage\"\n    class=\"m-t-16 m-l-auto m-r-auto\"\n    style=\"max-width: 285px\"\n    id=\"modal-body\"\n  >\n    <c8y-drop-area\n      (dropped)=\"onFileDroppedEvent($event)\"\n      [accept]=\"'.zip'\"\n      [loading]=\"isLoading\"\n      [maxAllowedFiles]=\"1\"\n      [progress]=\"progress | async\"\n      class=\"drop-area\"\n    ></c8y-drop-area>\n    <c8y-messages>\n      <c8y-message *ngIf=\"errorMessage\">\n        {{ errorMessage | translate }}\n      </c8y-message>\n    </c8y-messages>\n  </c8y-form-group>\n  <ng-template #appCreated>\n    <div class=\"d-flex a-i-center j-c-center\" style=\"min-height: 285px\">\n      <c8y-operation-result\n        text=\"{{ successText | translate }}\"\n        [vertical]=\"true\"\n        [size]=\"84\"\n        class=\"lead\"\n        type=\"success\"\n      ></c8y-operation-result>\n    </div>\n  </ng-template>\n</c8y-wizard-body>\n\n<c8y-wizard-footer>\n  <button\n    (click)=\"back()\"\n    *ngIf=\"!isAppCreated && canGoBack\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Back' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Back\n  </button>\n  <button\n    (click)=\"cancel()\"\n    *ngIf=\"!isAppCreated\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Cancel' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Cancel\n  </button>\n  <button\n    (click)=\"done()\"\n    *ngIf=\"isAppCreated\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Done' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Done\n  </button>\n  <a\n    (click)=\"$event.stopPropagation()\"\n    *ngIf=\"isAppCreated && canOpenInBrowser\"\n    [href]=\"getHref(createdApp)\"\n    target=\"_blank\"\n    rel=\"noopener noreferrer\"\n    class=\"btn btn-primary\"\n    title=\"{{ 'Open' | translate }}\"\n  >\n    <i c8yIcon=\"external-link\" class=\"m-r-4\"></i>\n    {{ 'Open' | translate }}\n  </a>\n</c8y-wizard-footer>\n", dependencies: [{ kind: "directive", type: i2.IconDirective, selector: "[c8yIcon]", inputs: ["c8yIcon"] }, { kind: "directive", type: i2.C8yTranslateDirective, selector: "[translate],[ngx-translate]" }, { kind: "directive", type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i2.OperationResultComponent, selector: "c8y-operation-result", inputs: ["text", "vertical", "size", "type"] }, { kind: "component", type: i2.DropAreaComponent, selector: "c8y-drop-area", inputs: ["formControl", "title", "message", "icon", "loadingMessage", "forceHideList", "alwaysShow", "clickToOpen", "loading", "progress", "maxAllowedFiles", "files", "maxFileSizeInMegaBytes", "accept"], outputs: ["dropped"] }, { kind: "component", type: i2.FormGroupComponent, selector: "c8y-form-group", inputs: ["hasError", "hasWarning", "hasSuccess", "novalidation", "status"] }, { kind: "directive", type: i2.MessageDirective, selector: "c8y-message", inputs: ["name", "text"] }, { kind: "component", type: i2.MessagesComponent, selector: "c8y-messages", inputs: ["show", "defaults"] }, { kind: "component", type: i2.WizardHeaderComponent, selector: "c8y-wizard-header" }, { kind: "component", type: i2.WizardBodyComponent, selector: "c8y-wizard-body" }, { kind: "component", type: i2.WizardFooterComponent, selector: "c8y-wizard-footer" }, { kind: "pipe", type: i2.C8yTranslatePipe, name: "translate" }, { kind: "pipe", type: i5.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: AddApplicationComponent, decorators: [{
            type: Component,
            args: [{ selector: 'c8y-add-application', template: "<c8y-wizard-header>\n  <i [c8yIcon]=\"headerIcon\"></i>\n  <h4 id=\"modal-title\">{{ headerText | translate }}</h4>\n</c8y-wizard-header>\n\n<c8y-wizard-body>\n  <p class=\"p-16 text-center text-medium separator-bottom sticky-top bg-component\">\n    {{ 'Upload a *.zip file' | translate }}\n  </p>\n  <c8y-form-group\n    *ngIf=\"!isAppCreated; else appCreated\"\n    [hasError]=\"!!errorMessage\"\n    class=\"m-t-16 m-l-auto m-r-auto\"\n    style=\"max-width: 285px\"\n    id=\"modal-body\"\n  >\n    <c8y-drop-area\n      (dropped)=\"onFileDroppedEvent($event)\"\n      [accept]=\"'.zip'\"\n      [loading]=\"isLoading\"\n      [maxAllowedFiles]=\"1\"\n      [progress]=\"progress | async\"\n      class=\"drop-area\"\n    ></c8y-drop-area>\n    <c8y-messages>\n      <c8y-message *ngIf=\"errorMessage\">\n        {{ errorMessage | translate }}\n      </c8y-message>\n    </c8y-messages>\n  </c8y-form-group>\n  <ng-template #appCreated>\n    <div class=\"d-flex a-i-center j-c-center\" style=\"min-height: 285px\">\n      <c8y-operation-result\n        text=\"{{ successText | translate }}\"\n        [vertical]=\"true\"\n        [size]=\"84\"\n        class=\"lead\"\n        type=\"success\"\n      ></c8y-operation-result>\n    </div>\n  </ng-template>\n</c8y-wizard-body>\n\n<c8y-wizard-footer>\n  <button\n    (click)=\"back()\"\n    *ngIf=\"!isAppCreated && canGoBack\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Back' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Back\n  </button>\n  <button\n    (click)=\"cancel()\"\n    *ngIf=\"!isAppCreated\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Cancel' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Cancel\n  </button>\n  <button\n    (click)=\"done()\"\n    *ngIf=\"isAppCreated\"\n    class=\"btn btn-default\"\n    title=\"{{ 'Done' | translate }}\"\n    translate\n    type=\"button\"\n  >\n    Done\n  </button>\n  <a\n    (click)=\"$event.stopPropagation()\"\n    *ngIf=\"isAppCreated && canOpenInBrowser\"\n    [href]=\"getHref(createdApp)\"\n    target=\"_blank\"\n    rel=\"noopener noreferrer\"\n    class=\"btn btn-primary\"\n    title=\"{{ 'Open' | translate }}\"\n  >\n    <i c8yIcon=\"external-link\" class=\"m-r-4\"></i>\n    {{ 'Open' | translate }}\n  </a>\n</c8y-wizard-footer>\n" }]
        }], ctorParameters: function () { return [{ type: i1.EcosystemService }, { type: i2.AlertService }, { type: i3.ApplicationService }, { type: i2.WizardComponent }, { type: i4.TranslateService }]; }, propDecorators: { headerText: [{
                type: Input
            }], headerIcon: [{
                type: Input
            }], successText: [{
                type: Input
            }], createApplicationHandler: [{
                type: Input
            }], uploadApplicationHandler: [{
                type: Input
            }], canGoBack: [{
                type: Input
            }], dropAreaComponent: [{
                type: ViewChild,
                args: [DropAreaComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkLWFwcGxpY2F0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2Vjb3N5c3RlbS9zaGFyZWQvYWRkLWFwcGxpY2F0aW9uLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uL2Vjb3N5c3RlbS9zaGFyZWQvYWRkLWFwcGxpY2F0aW9uLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RCxPQUFPLEVBQUUsa0JBQWtCLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7Ozs7O0FBTXZELE1BQU0sT0FBTyx1QkFBdUI7SUFpQmxDLFlBQ1UsZ0JBQWtDLEVBQ2xDLFlBQTBCLEVBQzFCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxnQkFBa0M7UUFKbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBaEJuQyxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBTzNCLHFCQUFnQixHQUFHLEtBQUssQ0FBQztRQUVqQixtQkFBYyxHQUFHLEtBQUssQ0FBQztJQVE1QixDQUFDO0lBRUosSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENB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UzsrQkFDRSxxQkFBcUI7Z09BSXRCLFVBQVU7c0JBQWxCLEtBQUs7Z0JBQ0csVUFBVTtzQkFBbEIsS0FBSztnQkFDRyxXQUFXO3NCQUFuQixLQUFLO2dCQUNHLHdCQUF3QjtzQkFBaEMsS0FBSztnQkFDRyx3QkFBd0I7c0JBQWhDLEtBQUs7Z0JBQ0csU0FBUztzQkFBakIsS0FBSztnQkFFd0IsaUJBQWlCO3NCQUE5QyxTQUFTO3VCQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25TZXJ2aWNlLCBJQXBwbGljYXRpb24gfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIERyb3BBcmVhQ29tcG9uZW50LCBXaXphcmRDb21wb25lbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRWNvc3lzdGVtU2VydmljZSB9IGZyb20gJy4vZWNvc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgRVJST1JfTUVTU0FHRVMgfSBmcm9tICcuL2Vjb3N5c3RlbS5jb25zdGFudHMnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktYWRkLWFwcGxpY2F0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2FkZC1hcHBsaWNhdGlvbi5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQWRkQXBwbGljYXRpb25Db21wb25lbnQge1xuICBASW5wdXQoKSBoZWFkZXJUZXh0OiBzdHJpbmc7XG4gIEBJbnB1dCgpIGhlYWRlckljb246IHN0cmluZztcbiAgQElucHV0KCkgc3VjY2Vzc1RleHQ6IHN0cmluZztcbiAgQElucHV0KCkgY3JlYXRlQXBwbGljYXRpb25IYW5kbGVyOiBhbnk7XG4gIEBJbnB1dCgpIHVwbG9hZEFwcGxpY2F0aW9uSGFuZGxlcjogYW55O1xuICBASW5wdXQoKSBjYW5Hb0JhY2sgPSBmYWxzZTtcblxuICBAVmlld0NoaWxkKERyb3BBcmVhQ29tcG9uZW50KSBkcm9wQXJlYUNvbXBvbmVudDtcblxuICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gIGlzQXBwQ3JlYXRlZDogYm9vbGVhbjtcbiAgY3JlYXRlZEFwcDogSUFwcGxpY2F0aW9uO1xuICBjYW5PcGVuSW5Ccm93c2VyID0gZmFsc2U7XG4gIGVycm9yTWVzc2FnZTogc3RyaW5nO1xuICBwcml2YXRlIHVwbG9hZENhbmNlbGVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlY29zeXN0ZW1TZXJ2aWNlOiBFY29zeXN0ZW1TZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHdpemFyZENvbXBvbmVudDogV2l6YXJkQ29tcG9uZW50LFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZVxuICApIHt9XG5cbiAgZ2V0IHByb2dyZXNzKCk6IEJlaGF2aW9yU3ViamVjdDxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLnByb2dyZXNzO1xuICB9XG5cbiAgb25GaWxlRHJvcHBlZEV2ZW50KGV2ZW50KSB7XG4gICAgaWYgKGV2ZW50ICYmIGV2ZW50Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGZpbGUgPSBldmVudFswXS5maWxlO1xuICAgICAgdGhpcy5vbkZpbGUoZmlsZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgb25GaWxlKGZpbGU6IEZpbGUpIHtcbiAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XG4gICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBudWxsO1xuICAgIHRoaXMucHJvZ3Jlc3MubmV4dCgwKTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmNyZWF0ZWRBcHAgPSBhd2FpdCB0aGlzLmNyZWF0ZUFwcGxpY2F0aW9uSGFuZGxlcihmaWxlKTtcbiAgICAgIGF3YWl0IHRoaXMudXBsb2FkQXBwbGljYXRpb25IYW5kbGVyKGZpbGUsIHRoaXMuY3JlYXRlZEFwcCk7XG4gICAgICB0aGlzLmNhbk9wZW5JbkJyb3dzZXIgPSB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuY2FuT3BlbkFwcEluQnJvd3Nlcih0aGlzLmNyZWF0ZWRBcHApO1xuICAgICAgdGhpcy5pc0FwcENyZWF0ZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmVjb3N5c3RlbVNlcnZpY2UuY2FuY2VsQXBwQ3JlYXRpb24odGhpcy5jcmVhdGVkQXBwKTtcbiAgICAgIHRoaXMuY3JlYXRlZEFwcCA9IG51bGw7XG4gICAgICB0aGlzLmRyb3BBcmVhQ29tcG9uZW50Lm9uRGVsZXRlKCk7XG4gICAgICAvLyBwcmVwYXJlIHRyYW5zbGF0aW9uIG9mIHN0YXRpYyBtZXNzYWdlIGlmIGl0IGV4aXN0c1xuICAgICAgY29uc3Qgc3RhdGljRXJyb3JNZXNzYWdlID1cbiAgICAgICAgRVJST1JfTUVTU0FHRVNbZXgubWVzc2FnZV0gJiYgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoRVJST1JfTUVTU0FHRVNbZXgubWVzc2FnZV0pO1xuICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gc3RhdGljIG1lc3NhZ2UsIHVzZSBkeW5hbWljIG9uZSBmcm9tIHRoZSBleGNlcHRpb25cbiAgICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gc3RhdGljRXJyb3JNZXNzYWdlID8/IGV4Lm1lc3NhZ2U7XG4gICAgICBpZiAoIXRoaXMuZXJyb3JNZXNzYWdlICYmICF0aGlzLnVwbG9hZENhbmNlbGVkKSB7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnByb2dyZXNzLm5leHQoMTAwKTtcbiAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICB9XG5cbiAgZ2V0SHJlZihhcHA6IElBcHBsaWNhdGlvbik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmdldEhyZWYoYXBwKTtcbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLmNhbmNlbEZpbGVVcGxvYWQoKTtcbiAgICB0aGlzLndpemFyZENvbXBvbmVudC5jbG9zZSgpO1xuICB9XG5cbiAgZG9uZSgpIHtcbiAgICB0aGlzLndpemFyZENvbXBvbmVudC5jbG9zZSgpO1xuICB9XG5cbiAgYmFjaygpIHtcbiAgICB0aGlzLndpemFyZENvbXBvbmVudC5yZXNldCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5jZWxGaWxlVXBsb2FkKCkge1xuICAgIHRoaXMudXBsb2FkQ2FuY2VsZWQgPSB0cnVlO1xuICAgIHRoaXMuZWNvc3lzdGVtU2VydmljZS5jYW5jZWxBcHBDcmVhdGlvbih0aGlzLmNyZWF0ZWRBcHApO1xuICAgIHRoaXMuY3JlYXRlZEFwcCA9IG51bGw7XG4gIH1cbn1cbiIsIjxjOHktd2l6YXJkLWhlYWRlcj5cbiAgPGkgW2M4eUljb25dPVwiaGVhZGVySWNvblwiPjwvaT5cbiAgPGg0IGlkPVwibW9kYWwtdGl0bGVcIj57eyBoZWFkZXJUZXh0IHwgdHJhbnNsYXRlIH19PC9oND5cbjwvYzh5LXdpemFyZC1oZWFkZXI+XG5cbjxjOHktd2l6YXJkLWJvZHk+XG4gIDxwIGNsYXNzPVwicC0xNiB0ZXh0LWNlbnRlciB0ZXh0LW1lZGl1bSBzZXBhcmF0b3ItYm90dG9tIHN0aWNreS10b3AgYmctY29tcG9uZW50XCI+XG4gICAge3sgJ1VwbG9hZCBhICouemlwIGZpbGUnIHwgdHJhbnNsYXRlIH19XG4gIDwvcD5cbiAgPGM4eS1mb3JtLWdyb3VwXG4gICAgKm5nSWY9XCIhaXNBcHBDcmVhdGVkOyBlbHNlIGFwcENyZWF0ZWRcIlxuICAgIFtoYXNFcnJvcl09XCIhIWVycm9yTWVzc2FnZVwiXG4gICAgY2xhc3M9XCJtLXQtMTYgbS1sLWF1dG8gbS1yLWF1dG9cIlxuICAgIHN0eWxlPVwibWF4LXdpZHRoOiAyODVweFwiXG4gICAgaWQ9XCJtb2RhbC1ib2R5XCJcbiAgPlxuICAgIDxjOHktZHJvcC1hcmVhXG4gICAgICAoZHJvcHBlZCk9XCJvbkZpbGVEcm9wcGVkRXZlbnQoJGV2ZW50KVwiXG4gICAgICBbYWNjZXB0XT1cIicuemlwJ1wiXG4gICAgICBbbG9hZGluZ109XCJpc0xvYWRpbmdcIlxuICAgICAgW21heEFsbG93ZWRGaWxlc109XCIxXCJcbiAgICAgIFtwcm9ncmVzc109XCJwcm9ncmVzcyB8IGFzeW5jXCJcbiAgICAgIGNsYXNzPVwiZHJvcC1hcmVhXCJcbiAgICA+PC9jOHktZHJvcC1hcmVhPlxuICAgIDxjOHktbWVzc2FnZXM+XG4gICAgICA8Yzh5LW1lc3NhZ2UgKm5nSWY9XCJlcnJvck1lc3NhZ2VcIj5cbiAgICAgICAge3sgZXJyb3JNZXNzYWdlIHwgdHJhbnNsYXRlIH19XG4gICAgICA8L2M4eS1tZXNzYWdlPlxuICAgIDwvYzh5LW1lc3NhZ2VzPlxuICA8L2M4eS1mb3JtLWdyb3VwPlxuICA8bmctdGVtcGxhdGUgI2FwcENyZWF0ZWQ+XG4gICAgPGRpdiBjbGFzcz1cImQtZmxleCBhLWktY2VudGVyIGotYy1jZW50ZXJcIiBzdHlsZT1cIm1pbi1oZWlnaHQ6IDI4NXB4XCI+XG4gICAgICA8Yzh5LW9wZXJhdGlvbi1yZXN1bHRcbiAgICAgICAgdGV4dD1cInt7IHN1Y2Nlc3NUZXh0IHwgdHJhbnNsYXRlIH19XCJcbiAgICAgICAgW3ZlcnRpY2FsXT1cInRydWVcIlxuICAgICAgICBbc2l6ZV09XCI4NFwiXG4gICAgICAgIGNsYXNzPVwibGVhZFwiXG4gICAgICAgIHR5cGU9XCJzdWNjZXNzXCJcbiAgICAgID48L2M4eS1vcGVyYXRpb24tcmVzdWx0PlxuICAgIDwvZGl2PlxuICA8L25nLXRlbXBsYXRlPlxuPC9jOHktd2l6YXJkLWJvZHk+XG5cbjxjOHktd2l6YXJkLWZvb3Rlcj5cbiAgPGJ1dHRvblxuICAgIChjbGljayk9XCJiYWNrKClcIlxuICAgICpuZ0lmPVwiIWlzQXBwQ3JlYXRlZCAmJiBjYW5Hb0JhY2tcIlxuICAgIGNsYXNzPVwiYnRuIGJ0bi1kZWZhdWx0XCJcbiAgICB0aXRsZT1cInt7ICdCYWNrJyB8IHRyYW5zbGF0ZSB9fVwiXG4gICAgdHJhbnNsYXRlXG4gICAgdHlwZT1cImJ1dHRvblwiXG4gID5cbiAgICBCYWNrXG4gIDwvYnV0dG9uPlxuICA8YnV0dG9uXG4gICAgKGNsaWNrKT1cImNhbmNlbCgpXCJcbiAgICAqbmdJZj1cIiFpc0FwcENyZWF0ZWRcIlxuICAgIGNsYXNzPVwiYnRuIGJ0bi1kZWZhdWx0XCJcbiAgICB0aXRsZT1cInt7ICdDYW5jZWwnIHwgdHJhbnNsYXRlIH19XCJcbiAgICB0cmFuc2xhdGVcbiAgICB0eXBlPVwiYnV0dG9uXCJcbiAgPlxuICAgIENhbmNlbFxuICA8L2J1dHRvbj5cbiAgPGJ1dHRvblxuICAgIChjbGljayk9XCJkb25lKClcIlxuICAgICpuZ0lmPVwiaXNBcHBDcmVhdGVkXCJcbiAgICBjbGFzcz1cImJ0biBidG4tZGVmYXVsdFwiXG4gICAgdGl0bGU9XCJ7eyAnRG9uZScgfCB0cmFuc2xhdGUgfX1cIlxuICAgIHRyYW5zbGF0ZVxuICAgIHR5cGU9XCJidXR0b25cIlxuICA+XG4gICAgRG9uZVxuICA8L2J1dHRvbj5cbiAgPGFcbiAgICAoY2xpY2spPVwiJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpXCJcbiAgICAqbmdJZj1cImlzQXBwQ3JlYXRlZCAmJiBjYW5PcGVuSW5Ccm93c2VyXCJcbiAgICBbaHJlZl09XCJnZXRIcmVmKGNyZWF0ZWRBcHApXCJcbiAgICB0YXJnZXQ9XCJfYmxhbmtcIlxuICAgIHJlbD1cIm5vb3BlbmVyIG5vcmVmZXJyZXJcIlxuICAgIGNsYXNzPVwiYnRuIGJ0bi1wcmltYXJ5XCJcbiAgICB0aXRsZT1cInt7ICdPcGVuJyB8IHRyYW5zbGF0ZSB9fVwiXG4gID5cbiAgICA8aSBjOHlJY29uPVwiZXh0ZXJuYWwtbGlua1wiIGNsYXNzPVwibS1yLTRcIj48L2k+XG4gICAge3sgJ09wZW4nIHwgdHJhbnNsYXRlIH19XG4gIDwvYT5cbjwvYzh5LXdpemFyZC1mb290ZXI+XG4iXX0=