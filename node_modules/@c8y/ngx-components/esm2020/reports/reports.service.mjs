import { Injectable } from '@angular/core';
import { AlertService } from '@c8y/ngx-components';
import { orderBy, isEqual, remove, some } from 'lodash-es';
import { InventoryService, FetchClient } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "@c8y/client";
import * as i3 from "@ngx-translate/core";
export class ReportsService {
    constructor(alertService, inventoryService, client, translateService) {
        this.alertService = alertService;
        this.inventoryService = inventoryService;
        this.client = client;
        this.translateService = translateService;
        this.microserviceUrl = '/service/reporting';
        this.headers = { 'Content-Type': 'application/json' };
        this.isReportAgentSubscribed = true;
        this.REPORT_AGENT_NOT_SUBSCRIBED_EXPECTED_ERROR_LOWER_CASE = 'microservice/not found';
    }
    async getExport(exportId) {
        let exp;
        const exportDetail = await this.inventoryService.detail(exportId);
        const { data, res } = exportDetail;
        if (res.status !== 200) {
            this.alertService.addServerFailure({ data, res });
        }
        else {
            exp = data ? data : {};
        }
        return exp;
    }
    async getScheduleList(exportId) {
        const exp = await this.getExport(exportId);
        return this.extractScheduleListFromExport(exp);
    }
    extractScheduleListFromExport(exp) {
        let scheduleList;
        if (exp) {
            scheduleList = exp.c8y_ScheduleConfiguration ? exp.c8y_ScheduleConfiguration : [];
        }
        return orderBy(scheduleList, ['timestamp'], ['desc']);
    }
    async addSchedule(schedule, exportId) {
        return await this.updateSchedules(exportId, [], [schedule]);
    }
    async updateSchedule(oldSchedule, schedule, exportId) {
        return await this.updateSchedules(exportId, [oldSchedule], [schedule]);
    }
    async updateSchedules(exportId, schedulesToRemove = [], schedulesToAdd = []) {
        let success = false;
        const exp = await this.getExport(exportId);
        const schedules = this.extractScheduleListFromExport(exp);
        remove(schedules, (schedule) => some(schedulesToRemove, (scheduleToRemove) => isEqual(schedule, scheduleToRemove)));
        schedules.push(...schedulesToAdd);
        exp.c8y_ScheduleConfiguration = schedules;
        const { data, res } = await this.inventoryService.update(exp);
        if (res.status === 200) {
            success = await this.reschedule(exportId);
        }
        else {
            this.alertService.addServerFailure({ data, res });
        }
        return success;
    }
    async reschedule(exportId) {
        const options = {
            method: 'PUT',
            headers: this.headers
        };
        const rescheduling = await this.client.fetch(`${this.microserviceUrl}/schedule/${exportId}`, options);
        return rescheduling.status === 200;
    }
    async deleteSchedule(schedule, exportId) {
        return await this.updateSchedules(exportId, [schedule], []);
    }
    /**
     * Removes report configuration.
     *
     * Note: fallback strategy is based on error code returned by backend
     * in case of missing subscription for report-agent microservice.
     * @param config entity of report configuration
     * @returns Response wrapped in [[IFetchResponse]]
     */
    async removeConfiguration(config) {
        let res;
        if (!this.isReportAgentSubscribed) {
            res = await this.fallbackConfigurationRemoval(config);
        }
        else {
            res = await this.normalConfigurationRemoval(config);
            if (res.status === 404) {
                const data = await res.json();
                if (data &&
                    data.error &&
                    data.error.toLowerCase() === this.REPORT_AGENT_NOT_SUBSCRIBED_EXPECTED_ERROR_LOWER_CASE) {
                    res = await this.fallbackConfigurationRemoval(config);
                    this.isReportAgentSubscribed = false;
                }
            }
        }
        return res;
    }
    async normalConfigurationRemoval(config) {
        const url = `${this.microserviceUrl}/config/${config.id}`;
        return await this.client.fetch(url, { method: 'DELETE' });
    }
    async fallbackConfigurationRemoval(config) {
        let res;
        try {
            res = (await this.inventoryService.delete(config)).res;
        }
        catch (e) {
            // this could be an error related to not existing object or anything else which makes request return error status code
            // in case of concurrent removal everything is fine, therefor warning message. But it might not recover from some errors
            this.alertService.addServerFailure(e, 'warning');
        }
        return res;
    }
}
ReportsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReportsService, deps: [{ token: i1.AlertService }, { token: i2.InventoryService }, { token: i2.FetchClient }, { token: i3.TranslateService }], target: i0.ɵɵFactoryTarget.Injectable });
ReportsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReportsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.7", ngImport: i0, type: ReportsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.AlertService }, { type: i2.InventoryService }, { type: i2.FetchClient }, { type: i3.TranslateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcmVwb3J0cy9yZXBvcnRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMzRCxPQUFPLEVBQ0wsZ0JBQWdCLEVBSWhCLFdBQVcsRUFFWixNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7QUFHdkQsTUFBTSxPQUFPLGNBQWM7SUFNekIsWUFDVSxZQUEwQixFQUMxQixnQkFBa0MsRUFDbEMsTUFBbUIsRUFDbkIsZ0JBQWtDO1FBSGxDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUNuQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBRTFDLElBQUksQ0FBQyxlQUFlLEdBQUcsb0JBQW9CLENBQUM7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDO1FBQ3RELElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7UUFDcEMsSUFBSSxDQUFDLHFEQUFxRCxHQUFHLHdCQUF3QixDQUFDO0lBQ3hGLENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQXFCO1FBQ25DLElBQUksR0FBVyxDQUFDO1FBQ2hCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLFlBQVksQ0FBQztRQUNuQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO1lBQ3RCLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUNuRDthQUFNO1lBQ0wsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUUsSUFBMEIsQ0FBQyxDQUFDLENBQUUsRUFBYSxDQUFDO1NBQzNEO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxRQUFxQjtRQUN6QyxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFM0MsT0FBTyxJQUFJLENBQUMsNkJBQTZCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELDZCQUE2QixDQUFDLEdBQVc7UUFDdkMsSUFBSSxZQUF3QixDQUFDO1FBQzdCLElBQUksR0FBRyxFQUFFO1lBQ1AsWUFBWSxHQUFHLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDbkY7UUFDRCxPQUFPLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBa0IsRUFBRSxRQUFxQjtRQUN6RCxPQUFPLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFxQixFQUFFLFFBQWtCLEVBQUUsUUFBcUI7UUFDbkYsT0FBTyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUNuQixRQUFxQixFQUNyQixvQkFBZ0MsRUFBRSxFQUNsQyxpQkFBNkIsRUFBRTtRQUUvQixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUxRCxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsUUFBa0IsRUFBRSxFQUFFLENBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLGdCQUEwQixFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FDN0YsQ0FBQztRQUNGLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQztRQUNsQyxHQUFHLENBQUMseUJBQXlCLEdBQUcsU0FBUyxDQUFDO1FBQzFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMzQzthQUFNO1lBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ25EO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBcUI7UUFDcEMsTUFBTSxPQUFPLEdBQWtCO1lBQzdCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1NBQ3RCLENBQUM7UUFDRixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUMxQyxHQUFHLElBQUksQ0FBQyxlQUFlLGFBQWEsUUFBUSxFQUFFLEVBQzlDLE9BQU8sQ0FDUixDQUFDO1FBQ0YsT0FBTyxZQUFZLENBQUMsTUFBTSxLQUFLLEdBQUcsQ0FBQztJQUNyQyxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxRQUFrQixFQUFFLFFBQXFCO1FBQzVELE9BQU8sTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQW1CO1FBQzNDLElBQUksR0FBbUIsQ0FBQztRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ2pDLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN2RDthQUFNO1lBQ0wsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLDBCQUEwQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7Z0JBQ3RCLE1BQU0sSUFBSSxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUM5QixJQUNFLElBQUk7b0JBQ0osSUFBSSxDQUFDLEtBQUs7b0JBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxJQUFJLENBQUMscURBQXFELEVBQ3ZGO29CQUNBLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDdEQsSUFBSSxDQUFDLHVCQUF1QixHQUFHLEtBQUssQ0FBQztpQkFDdEM7YUFDRjtTQUNGO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsS0FBSyxDQUFDLDBCQUEwQixDQUFDLE1BQW1CO1FBQ2xELE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsV0FBVyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDMUQsT0FBTyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRCxLQUFLLENBQUMsNEJBQTRCLENBQUMsTUFBbUI7UUFDcEQsSUFBSSxHQUFHLENBQUM7UUFDUixJQUFJO1lBQ0YsR0FBRyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1NBQ3hEO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixzSEFBc0g7WUFDdEgsd0hBQXdIO1lBQ3hILElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDOzsyR0F6SVUsY0FBYzsrR0FBZCxjQUFjOzJGQUFkLGNBQWM7a0JBRDFCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFeHBvcnQsIFNjaGVkdWxlIH0gZnJvbSAnLi9leHBvcnQtc2NoZWR1bGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IG9yZGVyQnksIGlzRXF1YWwsIHJlbW92ZSwgc29tZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQge1xuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJZFJlZmVyZW5jZSxcbiAgSUZldGNoUmVzcG9uc2UsXG4gIElJZGVudGlmaWVkLFxuICBGZXRjaENsaWVudCxcbiAgSUZldGNoT3B0aW9uc1xufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXBvcnRzU2VydmljZSB7XG4gIG1pY3Jvc2VydmljZVVybDogc3RyaW5nO1xuICBoZWFkZXJzOiBhbnk7XG4gIGlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkOiBib29sZWFuO1xuICBSRVBPUlRfQUdFTlRfTk9UX1NVQlNDUklCRURfRVhQRUNURURfRVJST1JfTE9XRVJfQ0FTRTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5taWNyb3NlcnZpY2VVcmwgPSAnL3NlcnZpY2UvcmVwb3J0aW5nJztcbiAgICB0aGlzLmhlYWRlcnMgPSB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcbiAgICB0aGlzLmlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkID0gdHJ1ZTtcbiAgICB0aGlzLlJFUE9SVF9BR0VOVF9OT1RfU1VCU0NSSUJFRF9FWFBFQ1RFRF9FUlJPUl9MT1dFUl9DQVNFID0gJ21pY3Jvc2VydmljZS9ub3QgZm91bmQnO1xuICB9XG5cbiAgYXN5bmMgZ2V0RXhwb3J0KGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGxldCBleHA6IEV4cG9ydDtcbiAgICBjb25zdCBleHBvcnREZXRhaWwgPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGV4cG9ydElkKTtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gZXhwb3J0RGV0YWlsO1xuICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGV4cCA9IGRhdGEgPyAoZGF0YSBhcyB1bmtub3duIGFzIEV4cG9ydCkgOiAoe30gYXMgRXhwb3J0KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXhwO1xuICB9XG5cbiAgYXN5bmMgZ2V0U2NoZWR1bGVMaXN0KGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGNvbnN0IGV4cCA9IGF3YWl0IHRoaXMuZ2V0RXhwb3J0KGV4cG9ydElkKTtcblxuICAgIHJldHVybiB0aGlzLmV4dHJhY3RTY2hlZHVsZUxpc3RGcm9tRXhwb3J0KGV4cCk7XG4gIH1cblxuICBleHRyYWN0U2NoZWR1bGVMaXN0RnJvbUV4cG9ydChleHA6IEV4cG9ydCkge1xuICAgIGxldCBzY2hlZHVsZUxpc3Q6IFNjaGVkdWxlW107XG4gICAgaWYgKGV4cCkge1xuICAgICAgc2NoZWR1bGVMaXN0ID0gZXhwLmM4eV9TY2hlZHVsZUNvbmZpZ3VyYXRpb24gPyBleHAuYzh5X1NjaGVkdWxlQ29uZmlndXJhdGlvbiA6IFtdO1xuICAgIH1cbiAgICByZXR1cm4gb3JkZXJCeShzY2hlZHVsZUxpc3QsIFsndGltZXN0YW1wJ10sIFsnZGVzYyddKTtcbiAgfVxuXG4gIGFzeW5jIGFkZFNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlU2NoZWR1bGVzKGV4cG9ydElkLCBbXSwgW3NjaGVkdWxlXSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVTY2hlZHVsZShvbGRTY2hlZHVsZTogU2NoZWR1bGUsIHNjaGVkdWxlOiBTY2hlZHVsZSwgZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlU2NoZWR1bGVzKGV4cG9ydElkLCBbb2xkU2NoZWR1bGVdLCBbc2NoZWR1bGVdKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNjaGVkdWxlcyhcbiAgICBleHBvcnRJZDogSWRSZWZlcmVuY2UsXG4gICAgc2NoZWR1bGVzVG9SZW1vdmU6IFNjaGVkdWxlW10gPSBbXSxcbiAgICBzY2hlZHVsZXNUb0FkZDogU2NoZWR1bGVbXSA9IFtdXG4gICkge1xuICAgIGxldCBzdWNjZXNzID0gZmFsc2U7XG4gICAgY29uc3QgZXhwID0gYXdhaXQgdGhpcy5nZXRFeHBvcnQoZXhwb3J0SWQpO1xuICAgIGNvbnN0IHNjaGVkdWxlcyA9IHRoaXMuZXh0cmFjdFNjaGVkdWxlTGlzdEZyb21FeHBvcnQoZXhwKTtcblxuICAgIHJlbW92ZShzY2hlZHVsZXMsIChzY2hlZHVsZTogU2NoZWR1bGUpID0+XG4gICAgICBzb21lKHNjaGVkdWxlc1RvUmVtb3ZlLCAoc2NoZWR1bGVUb1JlbW92ZTogU2NoZWR1bGUpID0+IGlzRXF1YWwoc2NoZWR1bGUsIHNjaGVkdWxlVG9SZW1vdmUpKVxuICAgICk7XG4gICAgc2NoZWR1bGVzLnB1c2goLi4uc2NoZWR1bGVzVG9BZGQpO1xuICAgIGV4cC5jOHlfU2NoZWR1bGVDb25maWd1cmF0aW9uID0gc2NoZWR1bGVzO1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UudXBkYXRlKGV4cCk7XG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgc3VjY2VzcyA9IGF3YWl0IHRoaXMucmVzY2hlZHVsZShleHBvcnRJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1Y2Nlc3M7XG4gIH1cblxuICBhc3luYyByZXNjaGVkdWxlKGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzXG4gICAgfTtcbiAgICBjb25zdCByZXNjaGVkdWxpbmcgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaChcbiAgICAgIGAke3RoaXMubWljcm9zZXJ2aWNlVXJsfS9zY2hlZHVsZS8ke2V4cG9ydElkfWAsXG4gICAgICBvcHRpb25zXG4gICAgKTtcbiAgICByZXR1cm4gcmVzY2hlZHVsaW5nLnN0YXR1cyA9PT0gMjAwO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2NoZWR1bGUoc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtzY2hlZHVsZV0sIFtdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHJlcG9ydCBjb25maWd1cmF0aW9uLlxuICAgKlxuICAgKiBOb3RlOiBmYWxsYmFjayBzdHJhdGVneSBpcyBiYXNlZCBvbiBlcnJvciBjb2RlIHJldHVybmVkIGJ5IGJhY2tlbmRcbiAgICogaW4gY2FzZSBvZiBtaXNzaW5nIHN1YnNjcmlwdGlvbiBmb3IgcmVwb3J0LWFnZW50IG1pY3Jvc2VydmljZS5cbiAgICogQHBhcmFtIGNvbmZpZyBlbnRpdHkgb2YgcmVwb3J0IGNvbmZpZ3VyYXRpb25cbiAgICogQHJldHVybnMgUmVzcG9uc2Ugd3JhcHBlZCBpbiBbW0lGZXRjaFJlc3BvbnNlXV1cbiAgICovXG4gIGFzeW5jIHJlbW92ZUNvbmZpZ3VyYXRpb24oY29uZmlnOiBJSWRlbnRpZmllZCk6IFByb21pc2U8SUZldGNoUmVzcG9uc2U+IHtcbiAgICBsZXQgcmVzOiBJRmV0Y2hSZXNwb25zZTtcbiAgICBpZiAoIXRoaXMuaXNSZXBvcnRBZ2VudFN1YnNjcmliZWQpIHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMuZmFsbGJhY2tDb25maWd1cmF0aW9uUmVtb3ZhbChjb25maWcpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLm5vcm1hbENvbmZpZ3VyYXRpb25SZW1vdmFsKGNvbmZpZyk7XG4gICAgICBpZiAocmVzLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZGF0YSAmJlxuICAgICAgICAgIGRhdGEuZXJyb3IgJiZcbiAgICAgICAgICBkYXRhLmVycm9yLnRvTG93ZXJDYXNlKCkgPT09IHRoaXMuUkVQT1JUX0FHRU5UX05PVF9TVUJTQ1JJQkVEX0VYUEVDVEVEX0VSUk9SX0xPV0VSX0NBU0VcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmVzID0gYXdhaXQgdGhpcy5mYWxsYmFja0NvbmZpZ3VyYXRpb25SZW1vdmFsKGNvbmZpZyk7XG4gICAgICAgICAgdGhpcy5pc1JlcG9ydEFnZW50U3Vic2NyaWJlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBhc3luYyBub3JtYWxDb25maWd1cmF0aW9uUmVtb3ZhbChjb25maWc6IElJZGVudGlmaWVkKTogUHJvbWlzZTxJRmV0Y2hSZXNwb25zZT4ge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMubWljcm9zZXJ2aWNlVXJsfS9jb25maWcvJHtjb25maWcuaWR9YDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2godXJsLCB7IG1ldGhvZDogJ0RFTEVURScgfSk7XG4gIH1cblxuICBhc3luYyBmYWxsYmFja0NvbmZpZ3VyYXRpb25SZW1vdmFsKGNvbmZpZzogSUlkZW50aWZpZWQpOiBQcm9taXNlPElGZXRjaFJlc3BvbnNlPiB7XG4gICAgbGV0IHJlcztcbiAgICB0cnkge1xuICAgICAgcmVzID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZWxldGUoY29uZmlnKSkucmVzO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIHRoaXMgY291bGQgYmUgYW4gZXJyb3IgcmVsYXRlZCB0byBub3QgZXhpc3Rpbmcgb2JqZWN0IG9yIGFueXRoaW5nIGVsc2Ugd2hpY2ggbWFrZXMgcmVxdWVzdCByZXR1cm4gZXJyb3Igc3RhdHVzIGNvZGVcbiAgICAgIC8vIGluIGNhc2Ugb2YgY29uY3VycmVudCByZW1vdmFsIGV2ZXJ5dGhpbmcgaXMgZmluZSwgdGhlcmVmb3Igd2FybmluZyBtZXNzYWdlLiBCdXQgaXQgbWlnaHQgbm90IHJlY292ZXIgZnJvbSBzb21lIGVycm9yc1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlLCAnd2FybmluZycpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG59XG4iXX0=